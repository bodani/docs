{"config":{"lang":["en"],"separator":"[\\s\\u200b\\-_,:!=\\[\\]()\"`/]+|\\.(?!\\d)|&[lg]t;|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"\ud83c\udfe0 \u6280\u672f\u6587\u6863\u4e2d\u5fc3","text":"\u7efc\u5408\u6280\u672f\u8d44\u6e90\u6587\u6863\u4e2d\u5fc3 <p>\u5f00\u6e90 \u2022 \u4e13\u4e1a \u2022 \u5168\u9762 \u2022 \u5b9e\u7528</p>"},{"location":"#_2","title":"\ud83d\udcda \u5feb\u901f\u5bfc\u822a","text":"\ud83d\udc18 PostgreSQL <p>\u529f\u80fd\u5f3a\u5927\u7684\u5f00\u6e90\u5bf9\u8c61\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u6ce8\u91cd\u53ef\u9760\u6027\u548c\u6807\u51c6\u517c\u5bb9\u6027\u3002</p> \u7acb\u5373\u67e5\u770b \ud83d\udc2c MySQL <p>\u4e16\u754c\u6700\u53d7\u6b22\u8fce\u7684\u5f00\u6e90\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u4ee5\u6027\u80fd\u548c\u6613\u7528\u6027\u8457\u79f0\u3002</p> \u7acb\u5373\u67e5\u770b \ud83e\udde9 \u4e2d\u95f4\u4ef6 <p>\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u5305\u542b\u76d1\u63a7\u3001\u5b58\u50a8\u548c\u5176\u4ed6\u5173\u952e\u4e2d\u95f4\u4ef6\u6280\u672f\u3002</p> \u7acb\u5373\u67e5\u770b \ud83d\udc27 Linux <p>\u4f01\u4e1a\u7ea7\u64cd\u4f5c\u7cfb\u7edf\u5e73\u53f0\u4e0e\u670d\u52a1\u5668\u7ba1\u7406\uff0c\u5305\u542b\u8fd0\u7ef4\u6307\u5357\u548c\u6700\u4f73\u5b9e\u8df5\u3002</p> \u7acb\u5373\u67e5\u770b"},{"location":"#_3","title":"\u6280\u672f\u4e2d\u5fc3\u6982\u89c8","text":"<p>\u672c\u6587\u6863\u4e2d\u5fc3\u63d0\u4f9b\u591a\u79cd\u4e3b\u6d41\u6280\u672f\u6808\u7684\u4e13\u4e1a\u6587\u6863\uff0c\u6db5\u76d6\u4e86\u6570\u636e\u5e93\u3001\u4e2d\u95f4\u4ef6\u53ca\u64cd\u4f5c\u7cfb\u7edf\u7b49\u6838\u5fc3\u6280\u672f\u9886\u57df\uff0c\u81f4\u529b\u4e8e\u4e3a\u5f00\u53d1\u8005\u548c\u8fd0\u7ef4\u4eba\u5458\u63d0\u4f9b\u5168\u65b9\u4f4d\u7684\u6280\u672f\u652f\u6301\u548c\u5b66\u4e60\u8d44\u6e90\u3002</p>"},{"location":"#_4","title":"\u6280\u672f\u5206\u7c7b\u5bfc\u822a","text":"<ul> <li>PostgreSQL\uff1a\u529f\u80fd\u5f3a\u5927\u3001\u7b26\u5408 SQL \u6807\u51c6\u7684\u5bf9\u8c61\u5173\u7cfb\u578b\u6570\u636e\u5e93</li> <li>MySQL\uff1a\u5e7f\u6cdb\u4f7f\u7528\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u6027\u80fd\u5353\u8d8a</li> <li>\u4e2d\u95f4\u4ef6\uff1a\u6784\u5efa\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u5173\u952e\u7ec4\u4ef6\u548c\u670d\u52a1</li> <li>Linux\uff1a\u670d\u52a1\u5668\u64cd\u4f5c\u7cfb\u7edf\u4e0e\u7cfb\u7edf\u7ba1\u7406\u8fd0\u7ef4\u5b9e\u8df5</li> </ul>"},{"location":"#_5","title":"\u77e5\u8bc6\u4f53\u7cfb\u6846\u67b6","text":"<p>\u6587\u6863\u4e2d\u5fc3\u56f4\u7ed5\u4ee5\u4e0b\u6280\u672f\u9886\u57df\u6784\u5efa\uff1a</p> <p>\u6570\u636e\u5e93\u6280\u672f</p> <ul> <li>\u5b89\u88c5\u90e8\u7f72\u4e0e\u521d\u59cb\u5316\u914d\u7f6e</li> <li>\u6027\u80fd\u8c03\u4f18\u4e0e\u67e5\u8be2\u4f18\u5316</li> <li>\u9ad8\u53ef\u7528\u67b6\u6784\u4e0e\u5bb9\u707e\u8bbe\u8ba1</li> <li>\u5b89\u5168\u7ba1\u7406\u4e0e\u6743\u9650\u63a7\u5236</li> <li>\u5907\u4efd\u6062\u590d\u4e0e\u6570\u636e\u8fc1\u79fb</li> </ul> <p>\u4e2d\u95f4\u4ef6\u7cfb\u7edf</p> <ul> <li>\u670d\u52a1\u6cbb\u7406\u4e0e\u6d88\u606f\u961f\u5217</li> <li>\u76d1\u63a7\u544a\u8b66\u4e0e\u65e5\u5fd7\u5206\u6790</li> <li>\u5206\u5e03\u5f0f\u7f13\u5b58\u4e0e\u7f51\u5173\u7ba1\u7406</li> <li>\u5bb9\u5668\u7f16\u6392\u4e0e\u4e91\u539f\u751f\u6280\u672f</li> </ul> <p>\u7cfb\u7edf\u8fd0\u7ef4</p> <ul> <li>Linux \u64cd\u4f5c\u7cfb\u7edf\u4f18\u5316</li> <li>\u865a\u62df\u5316\u4e0e\u4e91\u8ba1\u7b97\u5e73\u53f0\u7ba1\u7406</li> <li>\u7f51\u7edc\u5b89\u5168\u4e0e\u7b56\u7565\u914d\u7f6e</li> <li>\u81ea\u52a8\u5316\u8fd0\u7ef4\u4e0e\u5de5\u5177\u5b9e\u8df5</li> </ul>"},{"location":"#_6","title":"\u8d44\u6e90\u7279\u8272","text":"<p>\u5e73\u53f0\u6574\u5408\u4e86\u591a\u4e2a\u4e3b\u6d41\u5f00\u6e90\u6280\u672f\u7684\u5b9e\u8df5\u7ecf\u9a8c\u548c\u6700\u4f73\u5b9e\u8df5\uff0c\u5e2e\u52a9\u7528\u6237\u5feb\u901f\u89e3\u51b3\u5b9e\u9645\u5de5\u4f5c\u4e2d\u7684\u95ee\u9898\uff0c\u540c\u65f6\u4fc3\u8fdb\u6280\u672f\u56e2\u961f\u7684\u4ea4\u6d41\u4e0e\u53d1\u5c55\u3002\u6bcf\u7c7b\u6280\u672f\u90fd\u63d0\u4f9b\u4e86\u4ece\u5165\u95e8\u5230\u8fdb\u9636\u7684\u5b8c\u6574\u77e5\u8bc6\u8def\u5f84\uff0c\u652f\u6301\u7528\u6237\u7684\u6301\u7eed\u6210\u957f\u3002</p> <p>\u2b50 \u5f00\u59cb\u60a8\u7684\u6280\u672f\u63a2\u7d22\u4e4b\u65c5\uff0c\u4ece\u5de6\u4fa7\u5bfc\u822a\u680f\u6216\u4e0a\u65b9\u5206\u7c7b\u5361\u7247\u9009\u62e9\u611f\u5174\u8da3\u7684\u4e3b\u9898\u6df1\u5165\u4e86\u89e3</p>"},{"location":"test/","title":"Test","text":"<ul> <li>Note</li> </ul> <pre><code>!!! note\n    This is a note.\n</code></pre> <ul> <li>Tip</li> </ul> <pre><code>!!! tip\n    This is a tip.\n</code></pre> <ul> <li>Warning</li> </ul> <pre><code>!!! warning\n    This is a warning.\n</code></pre> <ul> <li>Danger</li> </ul> <pre><code>!!! danger\n    This is a danger.\n</code></pre> <ul> <li>Success</li> </ul> <pre><code>!!! success\n    This is a success.\n</code></pre> <ul> <li>Info</li> </ul> <pre><code>!!! info\n    This is an info.\n</code></pre> <ul> <li>Quote</li> </ul> <pre><code>!!! quote\n    This is a quote.\n</code></pre> <ul> <li>Question</li> </ul> <pre><code>??? question \"What is the meaning of life, the universe, and everything?\"\n    42.\n</code></pre>"},{"location":"clickhouse/","title":"\u4ec0\u4e48\u662f ClickHouse","text":"<p>Click Stream</p> <p>DataWare House</p>"},{"location":"clickhouse/#_1","title":"\u6982\u8ff0","text":"<p>ClickHouse \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5217\u5f0f\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u4e3b\u8981\u7528\u4e8e\u5728\u7ebf\u5206\u6790\u5904\u7406\uff08OLAP\uff09\u67e5\u8be2\u3002\u7531 Yandex \u4e8e 2016 \u5e74\u5f00\u6e90\uff0cClickHouse \u4ee5\u5176\u9ad8\u6027\u80fd\u3001\u9ad8\u5e76\u53d1\u6027\u548c\u5b9e\u65f6\u6570\u636e\u5206\u6790\u80fd\u529b\u800c\u8457\u79f0\uff0c\u5e7f\u6cdb\u5e94\u7528\u4e8e\u5927\u6570\u636e\u5206\u6790\u3001\u5b9e\u65f6\u6570\u636e\u6d41\u5904\u7406\u3001\u76d1\u63a7\u548c\u65e5\u5fd7\u5206\u6790\u7b49\u573a\u666f\u3002</p>"},{"location":"clickhouse/#_2","title":"\u7279\u70b9","text":""},{"location":"clickhouse/#1","title":"1. \u5217\u5f0f\u5b58\u50a8","text":"<p>ClickHouse \u91c7\u7528\u5217\u5f0f\u5b58\u50a8\uff0c\u8fd9\u4f7f\u5f97\u5b83\u5728\u5904\u7406\u5927\u89c4\u6a21\u6570\u636e\u5206\u6790\u67e5\u8be2\u65f6\u975e\u5e38\u9ad8\u6548\u3002\u76f8\u6bd4\u4e8e\u884c\u5b58\u50a8\uff0c\u5217\u5f0f\u5b58\u50a8\u53ef\u4ee5\u66f4\u597d\u5730\u5229\u7528 CPU \u7f13\u5b58\uff0c\u5e76\u4e14\u53ea\u8bfb\u53d6\u67e5\u8be2\u6240\u9700\u7684\u5217\uff0c\u4ece\u800c\u51cf\u5c11\u4e86 I/O \u64cd\u4f5c\u3002</p>"},{"location":"clickhouse/#2","title":"2. \u9ad8\u6027\u80fd","text":"<p>ClickHouse \u80fd\u591f\u5728\u5927\u578b\u6570\u636e\u96c6\u4e0a\u5feb\u901f\u6267\u884c\u590d\u6742\u7684\u67e5\u8be2\uff0c\u5f97\u76ca\u4e8e\u5176\u4ee5\u4e0b\u7279\u6027\uff1a</p> <ul> <li>\u6570\u636e\u538b\u7f29\uff1a\u901a\u8fc7\u9ad8\u6548\u7684\u538b\u7f29\u7b97\u6cd5\uff0c\u51cf\u5c11\u5b58\u50a8\u7a7a\u95f4\u548c I/O \u8d1f\u8f7d\u3002</li> <li>\u5411\u91cf\u5316\u6267\u884c\uff1a\u6279\u91cf\u5904\u7406\u6570\u636e\uff0c\u5145\u5206\u53d1\u6325\u73b0\u4ee3 CPU \u7684\u5411\u91cf\u5316\u8ba1\u7b97\u80fd\u529b\u3002</li> <li>\u5355\u6307\u4ee4\u591a\u6570\u636e\uff08SIMD\uff09\u4f18\u5316\uff1a\u5229\u7528 CPU \u7684 SIMD \u6307\u4ee4\u96c6\uff0c\u52a0\u901f\u6570\u636e\u5904\u7406\u3002</li> </ul>"},{"location":"clickhouse/#3","title":"3. \u5206\u5e03\u5f0f\u67b6\u6784","text":"<p>ClickHouse \u652f\u6301\u5206\u5e03\u5f0f\u90e8\u7f72\uff0c\u53ef\u4ee5\u5c06\u6570\u636e\u5206\u7247\u5b58\u50a8\u5728\u591a\u4e2a\u8282\u70b9\u4e0a\uff0c\u5e76\u884c\u5904\u7406\u67e5\u8be2\uff0c\u4ece\u800c\u63d0\u9ad8\u6570\u636e\u5904\u7406\u80fd\u529b\u548c\u7cfb\u7edf\u541e\u5410\u91cf\u3002</p>"},{"location":"clickhouse/#4","title":"4. \u5b9e\u65f6\u6570\u636e\u63d2\u5165\u548c\u67e5\u8be2","text":"<p>ClickHouse \u652f\u6301\u5b9e\u65f6\u6570\u636e\u63d2\u5165\uff0c\u5e76\u80fd\u591f\u5728\u6570\u636e\u5199\u5165\u7684\u540c\u65f6\u8fdb\u884c\u67e5\u8be2\u3002\u8fd9\u4f7f\u5f97\u5b83\u975e\u5e38\u9002\u5408\u4e8e\u5b9e\u65f6\u6570\u636e\u5206\u6790\u548c\u76d1\u63a7\u3002</p>"},{"location":"clickhouse/#5-sql","title":"5. \u517c\u5bb9 SQL","text":"<p>ClickHouse \u517c\u5bb9 SQL \u6807\u51c6\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u719f\u6089\u7684 SQL \u8bed\u6cd5\u8fdb\u884c\u6570\u636e\u67e5\u8be2\u548c\u7ba1\u7406\u3002\u540c\u65f6\uff0cClickHouse \u4e5f\u6269\u5c55\u4e86\u4e00\u4e9b\u529f\u80fd\uff0c\u4ee5\u652f\u6301\u9ad8\u6548\u7684 OLAP \u67e5\u8be2\u3002</p>"},{"location":"clickhouse/#_3","title":"\u5e94\u7528\u573a\u666f","text":""},{"location":"clickhouse/#1_1","title":"1. \u65e5\u5fd7\u5206\u6790","text":"<p>ClickHouse \u5e38\u7528\u4e8e\u5904\u7406\u548c\u5206\u6790\u65e5\u5fd7\u6570\u636e\uff0c\u4f8b\u5982 Web \u670d\u52a1\u5668\u65e5\u5fd7\u3001\u5e94\u7528\u7a0b\u5e8f\u65e5\u5fd7\u548c\u76d1\u63a7\u65e5\u5fd7\u3002\u901a\u8fc7\u5b9e\u65f6\u63d2\u5165\u548c\u9ad8\u6548\u67e5\u8be2\u529f\u80fd\uff0c\u7528\u6237\u53ef\u4ee5\u5feb\u901f\u83b7\u53d6\u6240\u9700\u7684\u5206\u6790\u7ed3\u679c\u3002</p>"},{"location":"clickhouse/#2_1","title":"2. \u7528\u6237\u884c\u4e3a\u5206\u6790","text":"<p>\u5bf9\u4e8e\u9700\u8981\u5206\u6790\u7528\u6237\u884c\u4e3a\u7684\u5927\u578b\u4e92\u8054\u7f51\u516c\u53f8\uff0cClickHouse \u63d0\u4f9b\u4e86\u9ad8\u6027\u80fd\u7684\u6570\u636e\u5904\u7406\u80fd\u529b\uff0c\u80fd\u591f\u5904\u7406\u6d77\u91cf\u70b9\u51fb\u6d41\u6570\u636e\u3001\u7528\u6237\u884c\u4e3a\u6570\u636e\u7b49\u3002</p>"},{"location":"clickhouse/#3_1","title":"3. \u5b9e\u65f6\u76d1\u63a7","text":"<p>\u5728\u7cfb\u7edf\u76d1\u63a7\u548c\u8fd0\u7ef4\u4e2d\uff0cClickHouse \u53ef\u4ee5\u5904\u7406\u5b9e\u65f6\u91c7\u96c6\u7684\u6570\u636e\uff0c\u5e76\u63d0\u4f9b\u5b9e\u65f6\u67e5\u8be2\u548c\u53ef\u89c6\u5316\u652f\u6301\uff0c\u5e2e\u52a9\u8fd0\u7ef4\u4eba\u5458\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898\u3002</p>"},{"location":"clickhouse/#4_1","title":"4. \u6570\u636e\u4ed3\u5e93","text":"<p>ClickHouse \u4f5c\u4e3a\u6570\u636e\u4ed3\u5e93\uff0c\u53ef\u4ee5\u5b58\u50a8\u548c\u5206\u6790\u4f01\u4e1a\u5927\u6570\u636e\uff0c\u652f\u6301\u590d\u6742\u7684 OLAP \u67e5\u8be2\uff0c\u5e2e\u52a9\u4f01\u4e1a\u505a\u51fa\u6570\u636e\u9a71\u52a8\u7684\u51b3\u7b56\u3002</p>"},{"location":"clickhouse/#_4","title":"\u603b\u7ed3","text":"<p>ClickHouse \u662f\u4e00\u4e2a\u5f3a\u5927\u4e14\u9ad8\u6548\u7684\u5217\u5f0f\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u4e13\u4e3a OLAP \u67e5\u8be2\u8bbe\u8ba1\u3002\u5176\u9ad8\u6027\u80fd\u3001\u5206\u5e03\u5f0f\u67b6\u6784\u548c\u5b9e\u65f6\u6570\u636e\u5904\u7406\u80fd\u529b\uff0c\u4f7f\u5176\u5728\u5927\u6570\u636e\u5206\u6790\u9886\u57df\u5f97\u5230\u4e86\u5e7f\u6cdb\u5e94\u7528\u3002\u65e0\u8bba\u662f\u65e5\u5fd7\u5206\u6790\u3001\u7528\u6237\u884c\u4e3a\u5206\u6790\u3001\u5b9e\u65f6\u76d1\u63a7\u8fd8\u662f\u6570\u636e\u4ed3\u5e93\uff0cClickHou</p> <p>https://xie.infoq.cn/article/37886f3baca09057580bdd5aa</p> <p>\u5185\u5b58\u7684\u9650\u5236\u3002 \u4e00\u4e9b\u53c2\u6570\u9ed8\u8ba4\u662f\u6839\u636e\u7269\u7406\u5185\u5b58\u81ea\u52a8\u8ba1\u7b97\u7684\u3002\u518d\u5bb9\u5668\u4e2d\u5b58\u5728\u95ee\u9898\uff0c \u5bb9\u5668\u4e2d\u67e5\u770b\u7684\u662f\u5b9e\u4f53\u673a\u7684\u5185\u5bb9\uff0c\u4e0d\u662f\u5bb9\u5668\u542f\u52a8\u65f6\u9650\u5236\u7684\u5185\u5b58\u3002\u518d\u8ba1\u7b97\u5185\u5b58\u5206\u914d\u65f6\u4ea7\u751f\u6df7\u6dc6\u95ee\u9898\u3002</p> <p>max_memory_usage_soft_limit max_server_memory_usage merges_mutations_memory_usage_soft_limit</p>"},{"location":"clickhouse/benchmark/","title":"\u538b\u529b\u6d4b\u8bd5","text":""},{"location":"clickhouse/benchmark/#clickhouse-benchmark","title":"clickhouse-benchmark","text":"<pre><code>-- \u67e5\u770b\u96c6\u7fa4\u540d\u79f0\nshow clusters;\n-- \u521b\u5efadb\nCREATE DATABASE dbbenchmark ON CLUSTER cluster\n\nuse dbbenchmark\n-- \u521b\u5efa\u672c\u5730\u8868\nCREATE TABLE dbbenchmark.test_table_local  ON CLUSTER cluster (\n    id UInt64,\n    name String,\n    value Float64,\n    timestamp DateTime\n) ENGINE = ReplicatedMergeTree()\nORDER BY id;\n-- \u521b\u5efa\u5206\u5e03\u8868\nCREATE TABLE test_table_distributed  ON CLUSTER cluster ENGINE = Distributed('cluster', 'dbbenchmark', 'test_table_local', rand());\n-- \u751f\u6210\u6d4b\u8bd5\u6570\u636e\nINSERT INTO dbbenchmark.test_table_distributed SELECT \n    number AS id, \n    concat('name_', toString(number)) AS name, \n    rand() % 100 AS value, \n    now() - INTERVAL rand() % 10000 SECOND AS timestamp \nFROM numbers(1000000);\n\n-- \u7b80\u5355\u538b\u6d4b\n\nclickhouse-benchmark --query \"SELECT count(*) FROM test_table_distributed WHERE value &gt; 50\"\n\n\nclickhouse-benchmark --query \"SELECT avg(value) FROM test_table_distributed WHERE timestamp &gt; now() - INTERVAL 1 HOUR\"\n\nclickhouse-benchmark --query \"SELECT * FROM dbbenchmark.test_table_distributed ORDER BY value DESC LIMIT 100\"\n</code></pre>"},{"location":"clickhouse/benchmark/#_2","title":"\u67e5\u770b\u8868\u5927\u5c0f","text":"<pre><code>SELECT\n    table,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size\nFROM system.parts\nWHERE database = 'mgbench'\nGROUP BY table\nORDER BY total_size DESC;\n</code></pre> <pre><code>SELECT\n    `table`,\n    active,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size,\n    count() AS parts_count\nFROM system.parts\nWHERE database = 'mgbench'\nGROUP BY\n    `table`,\n    active\nORDER BY total_size DESC\n</code></pre> <pre><code>SELECT\n    name AS table,\n    formatReadableSize(total_bytes) AS total_size\nFROM system.tables\nWHERE database = 'mgbench'\nORDER BY total_size DESC;\n</code></pre>"},{"location":"clickhouse/bestpractices/","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"clickhouse/bestpractices/#_2","title":"\u6279\u91cf\u63d2\u5165","text":"<p>\u4e00\u6b21\u63d2\u5165\u591a\u6761\u6570\u636e1W~10W, \u51cf\u5c11\u4e0e\u670d\u52a1\u5668\u4ea4\u4e92\u7684\u9891\u7387\u3002</p>"},{"location":"clickhouse/bestpractices/#_3","title":"\u5f02\u6b65\u63d2\u5165","text":"<ul> <li>async_insert 0\uff0c\u9ed8\u8ba4 \u540c\u6b65\uff0c1 \u5f00\u542f\u5f02\u6b65 </li> <li>async_insert_max_data_size , size \u7ef4\u5ea6</li> <li> <p>async_insert_busy_timeout_ms , \u65f6\u95f4\u7ef4\u5ea6</p> </li> <li> <p>wait_for_async_insert= 0 \u63d2\u5165\u7f13\u5b58\u540e\u8fd4\u56de,1 \u5237\u76d8\u540e\u8fd4\u56de</p> </li> </ul>"},{"location":"clickhouse/bestpractices/#_4","title":"\u5f00\u542f\u5f02\u6b65\u7684\u65b9\u5f0f","text":""},{"location":"clickhouse/bestpractices/#_5","title":"\u7528\u6237\u7ea7\u522b","text":"<pre><code>ALTER USER default SETTINGS async_insert = 1\n</code></pre>"},{"location":"clickhouse/bestpractices/#_6","title":"\u8bed\u53e5\u7ea7\u522b","text":"<pre><code>INSERT INTO YourTable SETTINGS async_insert=1, wait_for_async_insert=1 VALUES (...)\n</code></pre>"},{"location":"clickhouse/bestpractices/#_7","title":"\u8fde\u63a5\u4e32\u65b9\u5f0f","text":"<pre><code>\"jdbc:ch://HOST.clickhouse.cloud:8443/?user=default&amp;password=PASSWORD&amp;ssl=true&amp;custom_http_params=async_insert=1,wait_for_async_insert=1\"\n</code></pre> <p>\u5f3a\u70c8\u5efa\u8bae async_insert=1,wait_for_async_insert=1  \u540c\u65f6\u8bbe\u7f6e\u3002</p>"},{"location":"clickhouse/bestpractices/#buffer-table","title":"Buffer Table","text":"<pre><code>Buffer(database, table, num_layers, min_time, max_time, min_rows, max_rows, min_bytes, max_bytes [,flush_time [,flush_rows [,flush_bytes]]])\n</code></pre> <p>\u793a\u4f8b</p> <pre><code>-- \u76ee\u6807\u8868\nCREATE TABLE target_table\n(\n    id UInt64,\n    value String\n) ENGINE = MergeTree()\nORDER BY id;\n\n-- \u7f13\u51b2\u8868\nCREATE TABLE buffer_table\n(\n    id UInt64,\n    value String\n) ENGINE = Buffer('default', 'target_table', 16, 10, 60, 100000, 1000000, 1048576);\n</code></pre>"},{"location":"clickhouse/bestpractices/#_8","title":"\u66f4\u65b0\u548c\u5220\u9664","text":"<p>\u5c3d\u91cf\u907f\u514d MergeTree \u8868\u5f15\u64ce\u4e2d\u8fdb\u884c\u66f4\u65b0\u4e2a\u5220\u9664\u6570\u636e\u3002\u53ef\u80fd\u5f15\u8d77\u5168\u8868\u91cd\u5199\u98ce\u9669\u3002\u4f7f\u7528 ReplacingMergeTree \u6216 CollapsingMergeTree \u5b9e\u73b0</p>"},{"location":"clickhouse/bestpractices/#nullable","title":"\u907f\u514d Nullable \u5217","text":""},{"location":"clickhouse/bestpractices/#optimize-final","title":"Optimize Final","text":"<p>\u5bfc\u81f4 parts \u91cd\u5199\u5408\u5e76 \uff0c\u5e76\u5ffd\u7565 max_bytes_to_merge_at_max_space_in_pool  \u8bbe\u7f6e\u3002 \u9020\u6210\u5927\u91cfIO\uff0c\u7c7b\u4f3c vacumn full</p>"},{"location":"clickhouse/bestpractices/#_9","title":"\u5206\u533a\u952e\u9009\u62e9","text":""},{"location":"clickhouse/c1/","title":"C1","text":"<p>cat /etc/clickhouse-server/conf.d/00_default_overrides.xml </p> <p>\u4f7f\u7528 system.clusters \u8868\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u7684\u60c5\u51b5\u3002</p> <pre><code>SELECT * FROM system.clusters;\n</code></pre> <p>\u68c0\u67e5\u5206\u5e03\u5f0f\u8868\u7684\u72b6\u6001: \u5982\u679c\u60a8\u6b63\u5728\u4f7f\u7528\u5206\u5e03\u5f0f\u8868\uff0c\u60a8\u53ef\u4ee5\u68c0\u67e5 system.distributed \u8868\u6765\u83b7\u53d6\u5173\u4e8e\u5206\u5e03\u5f0f\u5904\u7406\u7684\u4fe1\u606f\u3002</p> <pre><code>SELECT * FROM system.distributed WHERE cluster = SELECT cluster: FROM system.clusters;\n</code></pre> <p>\u68c0\u67e5\u526f\u672c\u72b6\u6001: \u5982\u679c\u60a8\u7684\u8868\u662f\u590d\u5236\u7684\uff0c\u60a8\u53ef\u4ee5\u67e5\u8be2 system.replicas \u8868\u6765\u68c0\u67e5\u6bcf\u4e2a\u526f\u672c\u7684\u72b6\u6001\u3002</p> <pre><code>SELECT * FROM system.replicas WHERE cluster = 'your_cluster_name';\n</code></pre> <p>\u65f6\u533a\u95ee\u9898</p> <p>SELECT timezone();</p> <p>CREATE TABLE my_new_table_rrm (     <code>rk_date</code> DateTime64(3) DEFAULT now64() ) ENGINE = ReplicatedReplacingMergeTree</p> <p>CREATE TABLE my_new_table_rrm (</p> <pre><code>`rk_date` DateTime64(3) DEFAULT now64() COMMENT 'TT',\n</code></pre> <p>) ENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/defalut/my_new_table_rrm', '{replica}', rk_date) ORDER BY (rk_date)</p> <p>CREATE TABLE my_new_table_rrm  (</p> <p><code>rk_date</code> DateTime64(3) DEFAULT now64() COMMENT 'TT',  ) ENGINE = ReplicatedReplacingMergeTree('/clickhouse/tables/defalut/my_new_table_rrm', '{replica}', rk_date) ORDER BY (rk_date)</p> <p>INSERT INTO my_new_table_rrm values(now64());</p>"},{"location":"clickhouse/ch-keeper/","title":"keeper","text":""},{"location":"clickhouse/ch-keeper/#clickhouse-keeperzookeeper","title":"clickhouse-keeper\u76f8\u6bd4zookeeper\u7684\u4f18\u70b9","text":""},{"location":"clickhouse/ch-keeper/#clickhouse-keeperckzookeeper","title":"\u4e3a\u4ec0\u4e48\u8981\u5f15\u5165clickhouse-keeper\u5462\uff1f\u4e3b\u8981\u662fck\u4f7f\u7528zookeeper\u6709\u7740\u4f17\u591a\u75db\u70b9\uff0c","text":"<ul> <li>\u4f7f\u7528java\u5f00\u53d1</li> <li>\u8fd0\u7ef4\u4e0d\u4fbf</li> <li>\u8981\u6c42\u72ec\u7acb\u90e8\u7f72</li> <li>zxid overflow\u95ee\u9898</li> <li>snapshot\u548clog\u6ca1\u6709\u7ecf\u8fc7\u538b\u7f29</li> <li>\u4e0d\u652f\u6301\u8bfb\u7684\u7ebf\u6027\u4e00\u81f4\u6027 </li> </ul>"},{"location":"clickhouse/ch-keeper/#keeper","title":"\u800ckeeper\u5b58\u5728\u7740\u4ee5\u4e0b\u4f18\u70b9\uff1a","text":"<ul> <li>\u4f7f\u7528c++\u5f00\u53d1\uff0c\u6280\u672f\u6808\u4e0eck\u7edf\u4e00</li> <li>\u5373\u53ef\u72ec\u7acb\u90e8\u7f72\uff0c\u53c8\u53ef\u96c6\u6210\u5230ck\u4e2d</li> <li>\u6ca1\u6709zxid overflow\u95ee\u9898</li> <li>\u8bfb\u6027\u80fd\u66f4\u597d\uff0c\u5199\u6027\u80fd\u76f8\u5f53</li> <li>\u652f\u6301\u5bf9snapshot\u548clog\u7684\u538b\u7f29\u548c\u6821\u9a8c</li> <li>\u652f\u6301\u8bfb\u5199\u7684\u7ebf\u6027\u4e00\u81f4\u6027</li> </ul>"},{"location":"clickhouse/ch-keeper/#_1","title":"\u914d\u7f6e\u53c2\u6570","text":"<pre><code>&lt;keeper_server&gt;\n    &lt;tcp_port&gt;2181&lt;/tcp_port&gt;\n    &lt;server_id&gt;1&lt;/server_id&gt;\n    &lt;log_storage_path&gt;/var/lib/clickhouse/coordination/log&lt;/log_storage_path&gt;\n    &lt;snapshot_storage_path&gt;/var/lib/clickhouse/coordination/snapshots&lt;/snapshot_storage_path&gt;\n\n    &lt;coordination_settings&gt;\n        &lt;operation_timeout_ms&gt;10000&lt;/operation_timeout_ms&gt;\n        &lt;session_timeout_ms&gt;30000&lt;/session_timeout_ms&gt;\n        &lt;async_replication&gt;true&lt;/async_replication&gt;\n        &lt;raft_logs_level&gt;trace&lt;/raft_logs_level&gt;\n    &lt;/coordination_settings&gt;\n\n    &lt;raft_configuration&gt;\n        &lt;server&gt;\n            &lt;id&gt;1&lt;/id&gt;\n            &lt;hostname&gt;zoo1&lt;/hostname&gt;\n            &lt;port&gt;9234&lt;/port&gt;\n        &lt;/server&gt;\n        &lt;server&gt;\n            &lt;id&gt;2&lt;/id&gt;\n            &lt;hostname&gt;zoo2&lt;/hostname&gt;\n            &lt;port&gt;9234&lt;/port&gt;\n        &lt;/server&gt;\n        &lt;server&gt;\n            &lt;id&gt;3&lt;/id&gt;\n            &lt;hostname&gt;zoo3&lt;/hostname&gt;\n            &lt;port&gt;9234&lt;/port&gt;\n        &lt;/server&gt;\n    &lt;/raft_configuration&gt;\n&lt;/keeper_server&gt;\n</code></pre> <p>keeper \u53c2\u6570: https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper#configuration</p> <p>\u591a\u8282\u70b9\u96c6\u7fa4\u901a\u4fe1\u53c2\u6570:</p> <ul> <li>heart_beat_interval_ms </li> <li>election_timeout_lower_bound_ms</li> <li>election_timeout_upper_bound_ms</li> <li>can_become_leader/priority/quorum_reads\uff0c</li> </ul> <p>\u5177\u4f53\u542b\u4e49\u53c2\u8003\uff1ahttps://clickhouse.com/docs/zh/operations/clickhouse-keeper/</p> <ul> <li>async_replication \u542f\u7528\u5f02\u6b65\u590d\u5236\u3002\u6240\u6709\u5199\u5165\u548c\u8bfb\u53d6\u7684\u4fdd\u8bc1\u90fd\u5f97\u4ee5\u4fdd\u7559\uff0c\u540c\u65f6\u5b9e\u73b0\u66f4\u597d\u7684\u6027\u80fd\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8be5\u8bbe\u7f6e\u662f\u7981\u7528\u7684\uff0c\u4ee5\u907f\u514d\u7834\u574f\u5411\u540e\u517c\u5bb9\u6027</li> </ul>"},{"location":"clickhouse/ch-keeper/#_2","title":"\u8f6c\u6362","text":"<p>clickhouse-keeper-converter</p>"},{"location":"clickhouse/compresstion/","title":"\u538b\u7f29","text":"<p>\u5217\u5b58\u538b\u7f29\u662fCH \u9ad8\u6027\u80fd\u7684\u79d8\u8bc0</p>"},{"location":"clickhouse/compresstion/#_2","title":"\u4e00\u4e2a\u793a\u4f8b, \u611f\u5b98\u8ba4\u8bc6","text":"<pre><code>create database compresstiondb on cluster cluster;\n</code></pre>"},{"location":"clickhouse/compresstion/#_3","title":"\u4e0d\u538b\u7f29","text":"<pre><code>CREATE TABLE none_compression_shard ON CLUSTER cluster\n(\n    log_time DateTime CODEC(NONE),\n    machine_name LowCardinality(String) CODEC(NONE),\n    machine_group LowCardinality(String) CODEC(NONE),\n    cpu_idle Nullable(Float32) CODEC(NONE),\n    cpu_nice Nullable(Float32) CODEC(NONE),\n    cpu_system Nullable(Float32) CODEC(NONE),\n    cpu_user Nullable(Float32) CODEC(NONE),\n    cpu_wio Nullable(Float32) CODEC(NONE),\n    disk_free Nullable(Float32) CODEC(NONE),\n    disk_total Nullable(Float32) CODEC(NONE),\n    part_max_used Nullable(Float32) CODEC(NONE),\n    load_fifteen Nullable(Float32) CODEC(NONE),\n    load_five Nullable(Float32) CODEC(NONE),\n    load_one Nullable(Float32) CODEC(NONE),\n    mem_buffers Nullable(Float32) CODEC(NONE),\n    mem_cached Nullable(Float32) CODEC(NONE),\n    mem_free Nullable(Float32) CODEC(NONE),\n    mem_shared Nullable(Float32) CODEC(NONE),\n    swap_free Nullable(Float32) CODEC(NONE),\n    bytes_in Nullable(Float32) CODEC(NONE),\n    bytes_out Nullable(Float32) CODEC(NONE)\n) ENGINE = ReplicatedMergeTree()\nORDER BY log_time;\n\nCREATE TABLE none_compression_distributed ON CLUSTER cluster AS none_compression_shard\nENGINE = Distributed(cluster, 'compresstiondb', 'none_compression_shard', rand());\n</code></pre>"},{"location":"clickhouse/compresstion/#_4","title":"\u9ed8\u8ba4\u538b\u7f29\u683c\u5f0f","text":"<pre><code>\u5206\u7247\u8868\uff08\u9ed8\u8ba4\u538b\u7f29\u683c\u5f0f\uff09\n\nCREATE TABLE default_compression_shard ON CLUSTER cluster\n(\n    log_time DateTime,\n    machine_name LowCardinality(String),\n    machine_group LowCardinality(String),\n    cpu_idle Nullable(Float32),\n    cpu_nice Nullable(Float32),\n    cpu_system Nullable(Float32),\n    cpu_user Nullable(Float32),\n    cpu_wio Nullable(Float32),\n    disk_free Nullable(Float32),\n    disk_total Nullable(Float32),\n    part_max_used Nullable(Float32),\n    load_fifteen Nullable(Float32),\n    load_five Nullable(Float32),\n    load_one Nullable(Float32),\n    mem_buffers Nullable(Float32),\n    mem_cached Nullable(Float32),\n    mem_free Nullable(Float32),\n    mem_shared Nullable(Float32),\n    swap_free Nullable(Float32),\n    bytes_in Nullable(Float32),\n    bytes_out Nullable(Float32)\n) ENGINE = ReplicatedMergeTree()\nORDER BY log_time;\n\nCREATE TABLE default_compression_distributed ON CLUSTER cluster AS default_compression_shard\nENGINE = Distributed(cluster, 'compresstiondb', 'default_compression_shard', rand());\n</code></pre>"},{"location":"clickhouse/compresstion/#zstd","title":"ZSTD \u538b\u7f29\u683c\u5f0f","text":"<pre><code>CREATE TABLE zstd_compression_shard ON CLUSTER cluster\n(\n    log_time DateTime CODEC(ZSTD),\n    machine_name LowCardinality(String) CODEC(ZSTD),\n    machine_group LowCardinality(String) CODEC(ZSTD),\n    cpu_idle Nullable(Float32) CODEC(ZSTD),\n    cpu_nice Nullable(Float32) CODEC(ZSTD),\n    cpu_system Nullable(Float32) CODEC(ZSTD),\n    cpu_user Nullable(Float32) CODEC(ZSTD),\n    cpu_wio Nullable(Float32) CODEC(ZSTD),\n    disk_free Nullable(Float32) CODEC(ZSTD),\n    disk_total Nullable(Float32) CODEC(ZSTD),\n    part_max_used Nullable(Float32) CODEC(ZSTD),\n    load_fifteen Nullable(Float32) CODEC(ZSTD),\n    load_five Nullable(Float32) CODEC(ZSTD),\n    load_one Nullable(Float32) CODEC(ZSTD),\n    mem_buffers Nullable(Float32) CODEC(ZSTD),\n    mem_cached Nullable(Float32) CODEC(ZSTD),\n    mem_free Nullable(Float32) CODEC(ZSTD),\n    mem_shared Nullable(Float32) CODEC(ZSTD),\n    swap_free Nullable(Float32) CODEC(ZSTD),\n    bytes_in Nullable(Float32) CODEC(ZSTD),\n    bytes_out Nullable(Float32) CODEC(ZSTD)\n) ENGINE = ReplicatedMergeTree()\nORDER BY log_time;\n\nCREATE TABLE zstd_compression_distributed ON CLUSTER cluster AS zstd_compression_shard\nENGINE = Distributed(cluster, 'compresstiondb', 'zstd_compression_shard', rand());\n</code></pre>"},{"location":"clickhouse/compresstion/#zl4","title":"ZL4 \u538b\u7f29\u683c\u5f0f","text":"<pre><code>CREATE TABLE lz4_compression_shard ON CLUSTER cluster\n(\n    log_time DateTime,\n    machine_name LowCardinality(String),\n    machine_group LowCardinality(String),\n    cpu_idle Nullable(Float32),\n    cpu_nice Nullable(Float32),\n    cpu_system Nullable(Float32),\n    cpu_user Nullable(Float32),\n    cpu_wio Nullable(Float32),\n    disk_free Nullable(Float32),\n    disk_total Nullable(Float32),\n    part_max_used Nullable(Float32),\n    load_fifteen Nullable(Float32),\n    load_five Nullable(Float32),\n    load_one Nullable(Float32),\n    mem_buffers Nullable(Float32),\n    mem_cached Nullable(Float32),\n    mem_free Nullable(Float32),\n    mem_shared Nullable(Float32),\n    swap_free Nullable(Float32),\n    bytes_in Nullable(Float32),\n    bytes_out Nullable(Float32)\n) ENGINE = ReplicatedMergeTree()\nORDER BY log_time;\n\nCREATE TABLE lz4_compression_distributed ON CLUSTER cluster AS lz4_compression_shard\nENGINE = Distributed(cluster, 'compresstiondb', 'lz4_compression_shard', rand());\n</code></pre>"},{"location":"clickhouse/compresstion/#_5","title":"\u63d2\u5165\u6837\u4f8b\u6570\u636e","text":"<pre><code>INSERT INTO none_compression_distributed\nSELECT now(), \n       'machine_' || toString(number % 10), \n       'group_' || toString(number % 5),\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 1000, rand() % 1000, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100\nFROM numbers(10000000);\n\nINSERT INTO default_compression_distributed\nSELECT now(), \n       'machine_' || toString(number % 10), \n       'group_' || toString(number % 5),\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 1000, rand() % 1000, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100\nFROM numbers(10000000);\n\n\nINSERT INTO lz4_compression_distributed\nSELECT now(), \n       'machine_' || toString(number % 10), \n       'group_' || toString(number % 5),\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 1000, rand() % 1000, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100\nFROM numbers(10000000);\n\nINSERT INTO zstd_compression_distributed\nSELECT now(), \n       'machine_' || toString(number % 10), \n       'group_' || toString(number % 5),\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 1000, rand() % 1000, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100, rand() % 100, rand() % 100, rand() % 100,\n       rand() % 100\nFROM numbers(10000000);\n</code></pre>"},{"location":"clickhouse/compresstion/#_6","title":"\u67e5\u770b\u7ed3\u679c\u96c6","text":"<pre><code>SELECT\n    `table`,\n    formatReadableSize(sum(bytes_on_disk)) AS total_size\nFROM system.parts\nWHERE (database = 'compresstiondb') AND (`table` LIKE '%compression%')\nGROUP BY `table`\nORDER BY total_size DESC\n\nQuery id: 8f315da9-83f5-4fce-a201-9e653341ce48\n\n   \u250c\u2500table\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500total_size\u2500\u2510\n1. \u2502 none_compression_shard    \u2502 745.91 MiB \u2502\n2. \u2502 default_compression_shard \u2502 417.31 MiB \u2502\n3. \u2502 lz4_compression_shard     \u2502 417.24 MiB \u2502\n4. \u2502 zstd_compression_shard    \u2502 197.74 MiB \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n</code></pre>"},{"location":"clickhouse/compresstion/#_7","title":"\u538b\u7f29\u539f\u7406","text":"<p>\u5f71\u54cd\u538b\u7f29\u7684\u56e0\u7d20</p> <ul> <li>ordering key</li> <li>data types</li> <li>codecs </li> </ul>"},{"location":"clickhouse/compresstion/#_8","title":"\u5e38\u89c1\u7f16\u7801","text":""},{"location":"clickhouse/compresstion/#delta","title":"Delta","text":"<p>\u7279\u70b9: \u9002\u7528\u4e8e\u6574\u6570\u548c\u65e5\u671f\u65f6\u95f4\u7c7b\u578b\u7684\u6570\u636e\uff0c\u5c24\u5176\u662f\u8fde\u7eed\u503c\u4e4b\u95f4\u5dee\u5f02\u8f83\u5c0f\u7684\u60c5\u51b5\u3002 \u5e94\u7528\u573a\u666f: \u5355\u8c03\u9012\u589e\u6216\u9012\u51cf\u7684\u5e8f\u5217\uff0c\u5982\u65f6\u95f4\u6233\u3001ID\u3002</p>"},{"location":"clickhouse/compresstion/#doubledelta","title":"DoubleDelta","text":"<p>\u7279\u70b9: \u5728 Delta \u7f16\u7801\u57fa\u7840\u4e0a\u8fdb\u4e00\u6b65\u538b\u7f29\uff0c\u9002\u7528\u4e8e\u8fde\u7eed\u7684\u5dee\u5f02\u672c\u8eab\u8f83\u5c0f\u7684\u6570\u636e\u3002</p> <p>\u5e94\u7528\u573a\u666f: \u4e8c\u9636\u5dee\u5206\u6570\u636e\uff0c\u5982\u80a1\u7968\u4ef7\u683c\u53d8\u5316\u3002</p>"},{"location":"clickhouse/compresstion/#gorilla","title":"Gorilla","text":"<p>\u7279\u70b9: \u9002\u7528\u4e8e\u6d6e\u70b9\u6570\u6570\u636e\uff0c\u7279\u522b\u662f\u5177\u6709\u968f\u673a\u5cf0\u503c\u7684\u5ea6\u91cf\u6570\u636e\u3002</p> <p>\u5e94\u7528\u573a\u666f: \u4f20\u611f\u5668\u6570\u636e\u3001\u6307\u6807\u8bfb\u6570\u3002</p>"},{"location":"clickhouse/compresstion/#64","title":"64","text":"<p>\u7279\u70b9: \u9002\u7528\u4e8e\u7a00\u758f\u6570\u636e\u6216\u5c0f\u8303\u56f4\u6570\u636e\u3002</p> <p>\u5e94\u7528\u573a\u666f: \u7a00\u758f\u77e9\u9635\u3001\u5206\u7c7b\u6570\u636e\u3002</p>"},{"location":"clickhouse/compresstion/#_9","title":"\u538b\u7f29\u7b97\u6cd5","text":"<pre><code>value   name    description\n0x02    None    No compression, only checksums\n0x82    LZ4 Extremely fast, good compression\n0x90    ZSTD    Zstandard, pretty fast, best compression\n</code></pre>"},{"location":"clickhouse/demo/","title":"\u8868\u5f15\u64ce","text":"<p>show clusters;</p> <p>CREATE DATABASE db5 ON CLUSTER cluster</p> <p>CREATE TABLE db5.table1 ON CLUSTER cluster (     <code>id</code> UInt64,     <code>column1</code> String ) ENGINE = ReplicatedMergeTree ORDER BY id</p> <p>CREATE TABLE db5.table1_dist ON CLUSTER cluster (     <code>id</code> UInt64,     <code>column1</code> String ) ENGINE = Distributed('cluster', 'db5', 'table1', rand())</p> <p>INSERT INTO db5.table1 (id, column1) VALUES (1, 'rep1'); INSERT INTO db5.table1 (id, column1) VALUES (2, 'rep2'); INSERT INTO db5.table1 (id, column1) VALUES (3, 'rep3');</p> <p>INSERT INTO db5.table1_dist (id, column1) VALUES (4, 'rep4'); INSERT INTO db5.table1_dist (id, column1) VALUES (5, 'rep5'); INSERT INTO db5.table1_dist (id, column1) VALUES (6, 'rep6');</p> <p>select hostName(), from db5.table1; select hostName(), from db5.table1_dist;</p> <p>echo ruok | nc 10.2.14.13 2181</p> <p>echo mntr | nc localhost 9181</p>"},{"location":"clickhouse/restore/","title":"\u526f\u672c\u8282\u70b9\u6570\u636e\u6062\u590d","text":""},{"location":"clickhouse/restore/#_2","title":"\u80cc\u666f","text":"<p>\u96c6\u7fa4\u6a21\u5f0f\uff0c \u4f7f\u7528\u7684\u590d\u5236\u8868\u3002</p> <p>\u6545\u969c\uff0c\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\u7684\u5b58\u50a8\u76d8\u574f\u6389\u3002\u6570\u636e\u5b8c\u5168\u4e22\u5931\u3002</p>"},{"location":"clickhouse/restore/#_3","title":"\u6062\u590d\u6d41\u7a0b","text":"<ul> <li>\u8282\u70b9\u65b0\u5efaclickhouse\u670d\u52a1</li> <li>\u4ece\u5176\u4ed6\u62f7\u8d1d\u62f7\u8d1d databases \u8fdb\u884c\u6062\u590ddatabases ,  /var/lib/clickhouse/metadata/.</li> <li>\u4ece\u5176\u4ed6\u8282\u70b9\u62f7\u8d1d tables \u96c6\u8fdb\u884c\u6062\u590dtables ,  /var/lib/clickhouse/metadata/.</li> <li>\u4ece\u5176\u4ed6\u8282\u70b9\u62f7\u8d1d user \u8fdb\u884c\u6062\u590d user ,  /var/lib/clickhouse/access/.</li> <li>\u6062\u590dzk \u6570\u636e </li> </ul>"},{"location":"clickhouse/restore/#_4","title":"\u67e5\u770b\u96c6\u7fa4\u8282\u70b9\u62d3\u6251\u4fe1\u606f","text":"<pre><code>SELECT shard_num, host_address,is_local FROM system.clusters;\n\n  \u250c\u2500shard_num\u2500\u252c\u2500host_address\u2500\u252c\u2500is_local\u2500\u2510\n1. \u2502         1 \u2502 10.0.1.174   \u2502        0 \u2502\n2. \u2502         1 \u2502 10.0.0.127   \u2502        0 \u2502\n3. \u2502         1 \u2502 10.0.2.29    \u2502        0 \u2502\n4. \u2502         2 \u2502 10.0.0.54    \u2502        0 \u2502\n5. \u2502         2 \u2502 10.0.2.55    \u2502        0 \u2502\n6. \u2502         2 \u2502 10.0.1.173   \u2502        1 \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u786e\u5b9a\u548c\u6545\u969c\u8282\u70b9\u4f4d\u7f6e\u3002\u5229\u7528\u540c\u526f\u672c\u7684\u5176\u4ed6\u8282\u70b9\u7684\u6570\u636e\u8fdb\u884c\u6062\u590d\u3002</p> <p>\u67e5\u770b\u6570\u636e\u5177\u4f53\u5206\u5e03\u60c5\u51b5\u3002</p> <pre><code>select database,table,replica_is_active from system.replicas;\n</code></pre>"},{"location":"clickhouse/restore/#_5","title":"\u5907\u4efd\u6062\u590d\u6570\u636e","text":"<p>metadata \u76ee\u5f55\u4e2d\u5b58\u653e\u7684\u662f\u8868\u7ed3\u6784\u4fe1\u606f</p> <p>access \u76ee\u5f55\u4e2d\u5b58\u653e\u7684\u662f\u7528\u6237\u6570\u636e</p> <p>\u5c06\u540c\u5206\u7247\u7684\u5176\u4ed6\u6b63\u5e38\u8282\u70b9\u7684 metadata \uff0c access \u6570\u636e\u62f7\u8d1d\u5230\u9700\u8981\u6062\u590d\u8282\u70b9\u7684\u5bf9\u5e94\u76ee\u5f55\u4e2d\u3002</p> <p>\u6ce8\u610f\u4e8b\u9879\uff0cmetadata \u6709\u4e24\u7c7b\u6587\u4ef6\uff0cdatabasename.sql \u6587\u4ef6 \u548c databasename \u76ee\u5f55\u3002 databasename.sql \u4e3a\u521b\u5efadatabase\u7684\u8bed\u53e5\u3002  databasename \u76ee\u5f55 \u4e3a\u521b\u5efa\u8868\u7684\u8bed\u53e5\u3002</p> <p>\u5e76\u4e14 databasename \u76ee\u5f55 \u4e3a\u8f6f\u8fde\u63a5\uff0c\u771f\u5b9e\u6570\u636e\u5b58\u653e\u5728 store \u4e2d\u3002</p> <pre><code>4 lrwxrwxrwx 1 clickhouse clickhouse 67 Aug 17 12:05 clickstream_v2 -&gt; /var/lib/clickhouse/store/8aa/8aa609f0-\n4525-457c-8aa6-09f04525657c/\n4 -rw-r----- 1 clickhouse clickhouse 78 Aug 17 12:05 clickstream_v2.sql\n4 lrwxrwxrwx 1 clickhouse clickhouse 67 Aug 17 12:05 default -&gt; /var/lib/clickhouse/store/76a/76a4bffa-4625-\n46a3-b6a4-bffa4625b6a3/\n4 -rw-r----- 1 clickhouse clickhouse 78 Aug 17 12:05 default.sql\n4 lrwxrwxrwx 1 clickhouse clickhouse 67 Aug 17 12:05 system -&gt; /var/lib/clickhouse/store/246/246ce236-ada4-42db-\na46c-e236ada4f2db/\n4 -rw-r----- 1 clickhouse clickhouse 78 Aug 17 12:05 system.sql\n</code></pre> <p>\u62f7\u8d1d\u6570\u636e\u9700\u6c42\u5206\u4e24\u6b65\u8fdb\u884c\u3002\u7b2c\u4e00\u6b65\u6062\u590d access \u7528\u6237 \u548c metadata \u4e2d\u7684 databasename.sql \u3002 \u6d4b\u8bd5\u9a8c\u8bc1 databasename.sql  \u548c databasename \u4e2d\u7684\u8868\u7ed3\u6784\u4e0d\u80fd\u540c\u65f6\u6062\u590d\u3002</p> <p>\u5148\u6062\u590ddatabase\uff0c\u518d\u6062\u590d tables \u3002  </p> <pre><code>mkdir /tmp/clickhouse  &amp;&amp; cd /tmp/clickhouse\n</code></pre>"},{"location":"clickhouse/restore/#_6","title":"\u5907\u4efd\u6570\u636e","text":"<pre><code>\u6570\u636e\nkubectl exec -n &lt;namespaces&gt; &lt;pod&gt; -- tar cvfh - /var/lib/clickhouse/metadata | tar xf - -C .\n\u7528\u6237\nkubectl exec -n &lt;namespaces&gt; &lt;pod&gt; -- tar cvfh - /var/lib/clickhouse/access | tar xf - -C .\n</code></pre>"},{"location":"clickhouse/restore/#_7","title":"\u6062\u590d\u6570\u636e","text":"<pre><code>\u6570\u636e\u5e93\u4fe1\u606f\ntar cf - var/lib/clickhouse/metadata/*.sql | kubectl exec -i -n &lt;namespaces&gt; &lt;pod&gt; -- tar xkf - -C /\n\u7528\u6237\u4fe1\u606f\ntar cf - var/lib/clickhouse/access | kubectl exec -i -n &lt;namespaces&gt; &lt;pod&gt; -- tar xf - -C /\nzk \u6570\u636e \nkubectl exec -i -n &lt;namespaces&gt; &lt;pod&gt; -- touch /drycc/clickhouse/data/flags/force_restore_data\n</code></pre> <p>\u91cd\u542f clickhouse</p> <pre><code>\u8868\u7ed3\u6784\u4fe1\u606f\ntar cf - --exclude='*.sql' var/lib/clickhouse/metadata/ | kubectl exec -i -n &lt;namespaces&gt; &lt;pod&gt; -- tar xkvf - -C /\n</code></pre> <p>\u91cd\u542f clickhouse</p>"},{"location":"clickhouse/restore/#_8","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5728\u6062\u590d\u7684\u65f6\u5019\u5ffd\u7565 default,system \u8fd9\u4e24\u4e2adatabase . \u56e0\u4e3a\u5728\u521b\u5efadatabase \u7684\u65f6\u5019\u9700\u8981 \u5229\u7528on cluster \u521b\u5efa\u5206\u5e03\u5f0f database\u3002\u591a\u526f\u672c\u7684\u4e1a\u52a1 database \u4e0d\u5728default.\u548csystem \u4e2d\uff0c \u6240\u4ee5\u5728\u6062\u590d\u7684\u65f6\u5019\u4e0d\u9700\u8981\u8003\u8651\uff0cdefault,\u548csystem\u3002\u907f\u514d\u5e26\u6765\u4e0d\u5fc5\u8981\u7684\u9ebb\u70e6\u3002</p>"},{"location":"clickhouse/restore/#_9","title":"\u9a8c\u8bc1","text":"<p>\u5b98\u7f51\u6062\u590d\u624b\u518c</p> <p>\u5176\u5b83\u53c2\u80031</p> <p>\u5176\u5b83\u53c2\u80032</p> <p>\u5176\u4ed6</p>"},{"location":"clickhouse/user/","title":"User","text":"<p>CREATE USER [IF NOT EXISTS | OR REPLACE] name1 [, name2 [,...]] [ON CLUSTER cluster_name]     [NOT IDENTIFIED | IDENTIFIED {[WITH {plaintext_password | sha256_password | sha256_hash | double_sha1_password | double_sha1_hash}] BY {'password' | 'hash'}} | WITH NO_PASSWORD | {WITH ldap SERVER 'server_name'} | {WITH kerberos [REALM 'realm']} | {WITH ssl_certificate CN 'common_name' | SAN 'TYPE:subject_alt_name'} | {WITH ssh_key BY KEY 'public_key' TYPE 'ssh-rsa|...'} | {WITH http SERVER 'server_name' [SCHEME 'Basic']} [VALID UNTIL datetime]      [, {[{plaintext_password | sha256_password | sha256_hash | ...}] BY {'password' | 'hash'}} | {ldap SERVER 'server_name'} | {...} | ... [,...]]]     [HOST {LOCAL | NAME 'name' | REGEXP 'name_regexp' | IP 'address' | LIKE 'pattern'} [,...] | ANY | NONE]     [VALID UNTIL datetime]     [IN access_storage_type]     [DEFAULT ROLE role [,...]]     [DEFAULT DATABASE database | NONE]     [GRANTEES {user | role | ANY | NONE} [,...] [EXCEPT {user | role} [,...]]]     [SETTINGS variable [= value] [MIN [=] min_value] [MAX [=] max_value] [READONLY | WRITABLE] | PROFILE 'profile_name'] [,...]</p> <p>GRANT SELECT(x,y) ON db.table TO john WITH GRANT OPTION</p> <p>CREATE USER test1 ON CLUSTER cluster IDENTIFIED  WITH  sha256_password BY password '123456';</p> <p>GRANT ON CLUSTER cluster SELECT ON . TO test1 WITH GRANT OPTION </p> <p>\u67e5\u770b\u7528\u6237\u53ca\u6743\u9650</p> <p>show users; show grants;</p> <p>select * from system.users; select * from system.grants;</p>"},{"location":"clickhouse/install/","title":"\u5b89\u88c5","text":""},{"location":"clickhouse/install/install_cluster/","title":"ClickHouse \u96c6\u7fa4\u7248\u5b89\u88c5","text":""},{"location":"clickhouse/install/install_cluster/#_1","title":"\u6982\u8ff0","text":"<p>ClickHouse \u96c6\u7fa4\u7248\u63d0\u4f9b\u9ad8\u53ef\u7528\u6027\u548c\u6c34\u5e73\u6269\u5c55\u80fd\u529b\uff0c\u9002\u7528\u4e8e\u5927\u89c4\u6a21\u6570\u636e\u5206\u6790\u573a\u666f\u3002\u672c\u6307\u5357\u4ecb\u7ecd\u5982\u4f55\u642d\u5efa\u4e00\u4e2a\u591a\u8282\u70b9 ClickHouse \u96c6\u7fa4\u3002</p>"},{"location":"clickhouse/install/install_cluster/#_2","title":"\u96c6\u7fa4\u67b6\u6784","text":""},{"location":"clickhouse/install/install_cluster/#_3","title":"\u7ec4\u4ef6\u6784\u6210","text":"<ul> <li>ClickHouse Server\uff1a\u5b58\u50a8\u6570\u636e\u5e76\u6267\u884c\u67e5\u8be2</li> <li>ZooKeeper\uff1a\u63d0\u4f9b\u5206\u5e03\u5f0f\u534f\u8c03\u670d\u52a1\uff0c\u7ef4\u62a4\u96c6\u7fa4\u72b6\u6001\u4e00\u81f4\u6027</li> <li>\u8d1f\u8f7d\u5747\u8861\u5668\uff1a\u5982 Nginx \u6216 HAProxy\uff0c\u5904\u7406\u5199\u5165\u8bf7\u6c42\u5206\u53d1</li> </ul>"},{"location":"clickhouse/install/install_cluster/#_4","title":"\u5206\u7247\u548c\u526f\u672c","text":"<ul> <li>\u5206\u7247(Sharding)\uff1a\u5c06\u6570\u636e\u5206\u5e03\u5230\u591a\u4e2a\u8282\u70b9\uff0c\u63d0\u9ad8\u5b58\u50a8\u548c\u67e5\u8be2\u80fd\u529b</li> <li>\u526f\u672c(Replication)\uff1a\u5728\u540c\u4e00\u5206\u7247\u4e2d\u521b\u5efa\u591a\u4e2a\u526f\u672c\uff0c\u4fdd\u8bc1\u9ad8\u53ef\u7528\u6027</li> </ul>"},{"location":"clickhouse/install/install_cluster/#_5","title":"\u73af\u5883\u51c6\u5907","text":""},{"location":"clickhouse/install/install_cluster/#1","title":"1. \u670d\u52a1\u5668\u8981\u6c42","text":"<p>\u51c6\u5907 3-6 \u53f0\u670d\u52a1\u5668\uff08\u53ef\u6839\u636e\u9700\u6c42\u8c03\u6574\uff09:</p> <pre><code>ch-node1 : 192.168.1.10 (shard1, replica1)\nch-node2 : 192.168.1.11 (shard1, replica2)\nch-node3 : 192.168.1.12 (shard2, replica1)\nch-node4 : 192.168.1.13 (shard2, replica2)\nzk-node1 : 192.168.1.20\nzk-node2 : 192.168.1.21\nzk-node3 : 192.168.1.22\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#2","title":"2. \u7f51\u7edc\u548c\u9632\u706b\u5899\u914d\u7f6e","text":"<pre><code># \u6240\u6709\u8282\u70b9\u5f00\u542f\u5fc5\u8981\u7aef\u53e3\nsudo ufw allow 9000    # TCP client interface\nsudo ufw allow 8123    # HTTP interface\nsudo ufw allow 9009    # Inter-server communication\nsudo ufw allow 2181    # ZooKeeper client port\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#zookeeper","title":"ZooKeeper \u5b89\u88c5\u4e0e\u914d\u7f6e","text":""},{"location":"clickhouse/install/install_cluster/#1-zookeeper","title":"1. \u5728\u6bcf\u53f0 ZooKeeper \u670d\u52a1\u5668\u4e0a\u5b89\u88c5","text":"<pre><code># \u5728\u6bcf\u4e2a zk \u8282\u70b9\u4e0a\u5b89\u88c5 ZooKeeper\nsudo apt-get install -y zookeeperd\n\n# \u6216\u8005\u624b\u52a8\u5b89\u88c5 ZooKeeper\nwget https://archive.apache.org/dist/zookeeper/zookeeper-3.8.1/apache-zookeeper-3.8.1-bin.tar.gz\ntar -xzvf apache-zookeeper-3.8.1-bin.tar.gz\nmv apache-zookeeper-3.8.1-bin /opt/zookeeper\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#2-zookeeper","title":"2. \u914d\u7f6e ZooKeeper \u96c6\u7fa4","text":"<p>\u4fee\u6539 <code>/etc/zookeeper/conf/zoo.cfg</code>:</p> <pre><code>tickTime=2000\ninitLimit=5\nsyncLimit=2\nclientPort=2181\n\nserver.1=zk-node1:2888:3888\nserver.2=zk-node2:2888:3888\nserver.3=zk-node3:2888:3888\n</code></pre> <p>\u6bcf\u4e2a\u670d\u52a1\u5668\u4e0a\u5206\u522b\u521b\u5efa <code>myid</code> \u6587\u4ef6:</p> <pre><code># zk-node1: echo 1 &gt; /etc/zookeeper/conf/myid\n# zk-node2: echo 2 &gt; /etc/zookeeper/conf/myid\n# zk-node3: echo 3 &gt; /etc/zookeeper/conf/myid\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#3-zookeeper","title":"3. \u542f\u52a8 ZooKeeper","text":"<pre><code>sudo systemctl restart zookeeper\nsudo systemctl enable zookeeper\n\n# \u9a8c\u8bc1\u96c6\u7fa4\u72b6\u6001\necho stat | nc zk-node1 2181 | grep Mode\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#clickhouse_1","title":"ClickHouse \u96c6\u7fa4\u914d\u7f6e","text":""},{"location":"clickhouse/install/install_cluster/#1-clickhouse","title":"1. \u5728\u6240\u6709\u8282\u70b9\u5b89\u88c5 ClickHouse","text":"<pre><code># \u6240\u6709\u8282\u70b9\u6267\u884c\u76f8\u540c\u5b89\u88c5\u547d\u4ee4\ncurl -s https://packagecloud.io/install/repositories/altinity/clickhouse/script.deb.sh | sudo bash\nsudo apt-get install -y clickhouse-server clickhouse-client\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#2-zookeeper_1","title":"2. \u914d\u7f6e ZooKeeper \u96c6\u6210","text":"<p>\u4fee\u6539\u6240\u6709 ClickHouse \u8282\u70b9\u7684 <code>/etc/clickhouse-server/config.xml</code>:</p> <pre><code>&lt;zookeeper&gt;\n    &lt;node index=\"1\"&gt;\n        &lt;host&gt;zk-node1&lt;/host&gt;\n        &lt;port&gt;2181&lt;/port&gt;\n    &lt;/node&gt;\n    &lt;node index=\"2\"&gt;\n        &lt;host&gt;zk-node2&lt;/host&gt;\n        &lt;port&gt;2181&lt;/port&gt;\n    &lt;/node&gt;\n    &lt;node index=\"3\"&gt;\n        &lt;host&gt;zk-node3&lt;/host&gt;\n        &lt;port&gt;2181&lt;/port&gt;\n    &lt;/node&gt;\n&lt;/zookeeper&gt;\n\n&lt;distributed_ddl&gt;\n    &lt;!-- \u914d\u7f6e\u5206\u5e03\u5f0f DDL \u6267\u884c\u7b56\u7565 --&gt;\n    &lt;path&gt;/clickhouse/task_queue/ddl&lt;/path&gt;\n&lt;/distributed_ddl&gt;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#3","title":"3. \u914d\u7f6e\u96c6\u7fa4\u5b8f\u53d8\u91cf","text":"<p>\u5728\u6bcf\u53f0\u670d\u52a1\u5668\u4e0a\u7684 <code>/etc/clickhouse-server/config.d/macros.xml</code>:</p> <pre><code>&lt;!-- ch-node1: --&gt;\n&lt;yandex&gt;\n    &lt;macros&gt;\n        &lt;shard&gt;01&lt;/shard&gt;\n        &lt;replica&gt;ch-node1&lt;/replica&gt;\n    &lt;/macros&gt;\n&lt;/yandex&gt;\n</code></pre> <pre><code>&lt;!-- ch-node2: --&gt;\n&lt;yandex&gt;\n    &lt;macros&gt;\n        &lt;shard&gt;01&lt;/shard&gt;\n        &lt;replica&gt;ch-node2&lt;/replica&gt;\n    &lt;/macros&gt;\n&lt;/yandex&gt;\n</code></pre> <pre><code>&lt;!-- ch-node3: --&gt;\n&lt;yandex&gt;\n    &lt;macros&gt;\n        &lt;shard&gt;02&lt;/shard&gt;\n        &lt;replica&gt;ch-node3&lt;/replica&gt;\n    &lt;/macros&gt;\n&lt;/yandex&gt;\n</code></pre> <pre><code>&lt;!-- ch-node4: --&gt;\n&lt;yandex&gt;\n    &lt;macros&gt;\n        &lt;shard&gt;02&lt;/shard&gt;\n        &lt;replica&gt;ch-node4&lt;/replica&gt;\n    &lt;/macros&gt;\n&lt;/yandex&gt;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#4","title":"4. \u914d\u7f6e\u96c6\u7fa4\u4fe1\u606f","text":"<p>\u5728\u6240\u6709\u8282\u70b9\u7684 <code>/etc/clickhouse-server/config.d/cluster.xml</code>:</p> <pre><code>&lt;yandex&gt;\n    &lt;remote_servers&gt;\n        &lt;production_cluster&gt;\n            &lt;shard&gt;\n                &lt;internal_replication&gt;true&lt;/internal_replication&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;ch-node1&lt;/host&gt;\n                    &lt;port&gt;9000&lt;/port&gt;\n                    &lt;user&gt;default&lt;/user&gt;\n                    &lt;password&gt;&lt;/password&gt;\n                &lt;/replica&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;ch-node2&lt;/host&gt;\n                    &lt;port&gt;9000&lt;/port&gt;\n                    &lt;user&gt;default&lt;/user&gt;\n                    &lt;password&gt;&lt;/password&gt;\n                &lt;/replica&gt;\n            &lt;/shard&gt;\n            &lt;shard&gt;\n                &lt;internal_replication&gt;true&lt;/internal_replication&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;ch-node3&lt;/host&gt;\n                    &lt;port&gt;9000&lt;/port&gt;\n                    &lt;user&gt;default&lt;/user&gt;\n                    &lt;password&gt;&lt;/password&gt;\n                &lt;/replica&gt;\n                &lt;replica&gt;\n                    &lt;host&gt;ch-node4&lt;/host&gt;\n                    &lt;port&gt;9000&lt;/port&gt;\n                    &lt;user&gt;default&lt;/user&gt;\n                    &lt;password&gt;&lt;/password&gt;\n                &lt;/replica&gt;\n            &lt;/shard&gt;\n        &lt;/production_cluster&gt;\n    &lt;/remote_servers&gt;\n&lt;/yandex&gt;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#_6","title":"\u90e8\u7f72\u4e0e\u542f\u52a8","text":""},{"location":"clickhouse/install/install_cluster/#1-clickhouse_1","title":"1. \u542f\u52a8 ClickHouse \u670d\u52a1","text":"<p>\u5728\u6240\u6709 ClickHouse \u8282\u70b9\u6267\u884c:</p> <pre><code>sudo systemctl start clickhouse-server\nsudo systemctl enable clickhouse-server\n\n# \u9a8c\u8bc1\u542f\u52a8\u72b6\u6001\nsudo systemctl status clickhouse-server\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#2_1","title":"2. \u9a8c\u8bc1\u96c6\u7fa4\u914d\u7f6e","text":"<pre><code>-- \u5728\u4efb\u610f\u8282\u70b9\u8fde\u63a5\u6d4b\u8bd5\nclickhouse-client\n\n-- \u68c0\u67e5\u96c6\u7fa4\u914d\u7f6e\nSELECT * FROM system.clusters;\n\n-- \u68c0\u67e5\u590d\u5236\u72b6\u6001\nSELECT * FROM system.replicas;\n\n-- \u67e5\u770b\u526f\u672c\u540c\u6b65\u72b6\u6001\nSELECT database, table, is_leader, is_readonly, future_parts, parts_to_check\nFROM system.replicas;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#_7","title":"\u521b\u5efa\u96c6\u7fa4\u8868","text":""},{"location":"clickhouse/install/install_cluster/#1_1","title":"1. \u521b\u5efa\u590d\u5236\u8868","text":"<p>\u5728\u6bcf\u4e2a\u5206\u7247\u8282\u70b9\u4e0a\u6267\u884c\u76f8\u540c\u7684\u5efa\u8868\u8bed\u53e5:</p> <pre><code>-- \u521b\u5efa\u672c\u5730\u590d\u5236\u8868\nCREATE TABLE events_local ON CLUSTER production_cluster\n(\n    event_date Date,\n    event_time DateTime,\n    user_id UInt64,\n    event_type String,\n    duration UInt32\n) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/events_local', '{replica}')\nPARTITION BY toYYYYMM(event_date)\nORDER BY (event_date, event_time, user_id);\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#2_2","title":"2. \u521b\u5efa\u5206\u5e03\u5f0f\u8868","text":"<pre><code>-- \u521b\u5efa\u5206\u5e03\u5f0f\u8868\uff0c\u7528\u4e8e\u8de8\u5206\u7247\u67e5\u8be2\nCREATE TABLE events_all ON CLUSTER production_cluster\nAS events_local\nENGINE = Distributed('production_cluster', default, events_local, rand());\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#3_1","title":"3. \u63d2\u5165\u548c\u67e5\u8be2\u6d4b\u8bd5","text":"<pre><code>-- \u5199\u5165\u6d4b\u8bd5\u6570\u636e\uff08\u53ef\u4efb\u9009\u8282\u70b9\u6267\u884c\uff0c\u4f1a\u81ea\u52a8\u5206\u53d1\uff09\nINSERT INTO events_all VALUES ('2023-01-01', '2023-01-01 10:00:00', 101, 'click', 50);\n\n-- \u67e5\u8be2\u6d4b\u8bd5\uff08\u53ef\u5728\u4efb\u610f\u8282\u70b9\u6267\u884c\uff09\nSELECT count() FROM events_all WHERE event_date = '2023-01-01';\n\n-- \u68c0\u67e5\u5404\u5206\u7247\u6570\u636e\u5206\u5e03\nSELECT shard_num, host_name, database, table, total_rows\nFROM cluster('production_cluster', system, tables)\nWHERE name = 'events_local'\nSETTINGS skip_unavailable_shards=1;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#_8","title":"\u76d1\u63a7\u4e0e\u7ef4\u62a4","text":""},{"location":"clickhouse/install/install_cluster/#1_2","title":"1. \u68c0\u67e5\u96c6\u7fa4\u5065\u5eb7\u72b6\u51b5","text":"<pre><code># \u4f7f\u7528 clickhouse \u5de5\u5177\nclickhouse client --host ch-node1 --query \"SELECT cluster, shard_num, replica_num, host_name, is_leader, is_readonly FROM system.clusters JOIN system.replicas USING(database, table);\"\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#2_3","title":"2. \u6545\u969c\u6062\u590d","text":"<p>\u5982\u679c\u67d0\u4e2a\u526f\u672c\u53d1\u751f\u6545\u969c:</p> <pre><code>-- \u68c0\u67e5\u526f\u672c\u72b6\u6001\nSELECT * FROM system.replication_queue;\n\n-- \u542f\u52a8\u526f\u672c\u6062\u590d\nSYSTEM SYNC REPLICA default.events_local;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#3_2","title":"3. \u6dfb\u52a0\u65b0\u7684\u526f\u672c\u6216\u5206\u7247","text":"<p>\u53ef\u901a\u8fc7\u6dfb\u52a0\u914d\u7f6e\u5e76\u6267\u884c:</p> <pre><code>-- \u5237\u65b0\u5206\u5e03\u5f0f DDL \u961f\u5217\nSYSTEM RELOAD CONFIG;\n\n-- \u91cd\u65b0\u5206\u5e03\u5df2\u6709\u6570\u636e\uff08\u5982\u9700\uff09\nINSERT INTO events_all SELECT * FROM events_local AS OF 1;\n</code></pre>"},{"location":"clickhouse/install/install_cluster/#_9","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"clickhouse/install/install_cluster/#_10","title":"\u90e8\u7f72\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li>\u4fdd\u6301 ZooKeeper \u5947\u6570\u8282\u70b9\uff0c\u6700\u5c11 3 \u4e2a</li> <li>\u5408\u7406\u5206\u914d\u5206\u7247\u6570\uff0c\u901a\u5e38\u4e3a\u526f\u672c\u6570\u7684\u500d\u6570</li> <li>\u542f\u7528 internal_replication=true \u4ee5\u5229\u7528\u8868\u7ea7\u526f\u672c</li> <li>\u5b9a\u671f\u76d1\u63a7\u78c1\u76d8\u7a7a\u95f4\u548c\u5185\u5b58\u4f7f\u7528\u60c5\u51b5</li> </ol>"},{"location":"clickhouse/install/install_cluster/#_11","title":"\u6027\u80fd\u4f18\u5316","text":"<ol> <li>\u4f7f\u7528\u9002\u5408\u7684\u5206\u533a\u7b56\u7565</li> <li>\u8c03\u6574\u5185\u5b58\u548c\u78c1\u76d8\u7f13\u5b58\u8bbe\u7f6e</li> <li>\u9002\u5f53\u589e\u52a0\u540c\u6b65\u526f\u672c\u7ebf\u7a0b\u6570</li> <li>\u914d\u7f6e\u5907\u4efd\u548c\u5feb\u7167\u7b56\u7565</li> </ol>"},{"location":"clickhouse/install/install_cluster/#_12","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ol> <li>\u96c6\u7fa4\u521d\u59cb\u5316\u5b8c\u6210\u540e\u5c3d\u91cf\u907f\u514d\u6539\u53d8\u62d3\u6251</li> <li>\u4fee\u6539\u96c6\u7fa4\u914d\u7f6e\u65f6\u8981\u9010\u6b65\u5e94\u7528\uff0c\u9010\u4e2a\u91cd\u542f\u670d\u52a1</li> <li>\u5b9a\u671f\u5907\u4efd ZooKeeper \u4e2d\u7684\u5173\u952e\u5143\u6570\u636e</li> <li>\u914d\u7f6e\u76d1\u63a7\u544a\u8b66\u673a\u5236\u786e\u4fdd\u53ca\u65f6\u53d1\u73b0\u5f02\u5e38</li> </ol> <p>\u96c6\u7fa4\u7248\u63d0\u4f9b\u66f4\u9ad8\u7684\u53ef\u9760\u6027\u548c\u6269\u5c55\u6027\uff0c\u4f46\u76f8\u6bd4\u5355\u673a\u7248\u4e5f\u6709\u66f4\u591a\u7684\u8fd0\u7ef4\u590d\u6742\u6027\u3002\u8bf7\u6839\u636e\u5b9e\u9645\u4e1a\u52a1\u9700\u6c42\u5408\u7406\u9009\u62e9\u90e8\u7f72\u65b9\u6848\u3002</p>"},{"location":"clickhouse/install/install_single/","title":"ClickHouse \u5355\u673a\u7248\u5b89\u88c5","text":""},{"location":"clickhouse/install/install_single/#_1","title":"\u7b80\u4ecb","text":"<p>ClickHouse \u662f\u4e00\u4e2a\u7528\u4e8e\u8054\u673a\u5206\u6790(OLAP)\u7684\u5217\u5f0f\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf(DBMS)\u3002\u672c\u6307\u5357\u4ecb\u7ecd\u5982\u4f55\u5b89\u88c5\u548c\u914d\u7f6e\u5355\u673a\u7248 ClickHouse\u3002</p>"},{"location":"clickhouse/install/install_single/#_2","title":"\u4e00\u952e\u5b89\u88c5\u65b9\u5f0f","text":""},{"location":"clickhouse/install/install_single/#1","title":"1. \u4f7f\u7528\u5b98\u65b9\u5b89\u88c5\u811a\u672c","text":"<pre><code># \u4e00\u952e\u5b89\u88c5\u811a\u672c\ncurl -s https://clickhouse.com/ | sh\n\n# \u6216\u4f7f\u7528\u539f\u59cb\u65b9\u5f0f\ncurl -s https://packagecloud.io/install/repositories/altinity/clickhouse/script.deb.sh | sudo bash\nsudo apt-get install -y clickhouse-server clickhouse-client\n</code></pre>"},{"location":"clickhouse/install/install_single/#2","title":"2. \u624b\u52a8\u5b89\u88c5","text":""},{"location":"clickhouse/install/install_single/#debianubuntu","title":"Debian/Ubuntu:","text":"<pre><code>sudo apt-get install -y apt-transport-https ca-certificates dirmngr\nsudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754\n\necho \"deb https://packages.clickhouse.com/deb stable main\" | sudo tee /etc/apt/sources.list.d/clickhouse.list\nsudo apt-get update\nsudo apt-get install -y clickhouse-server clickhouse-client\n</code></pre>"},{"location":"clickhouse/install/install_single/#centosrhel","title":"CentOS/RHEL:","text":"<pre><code>sudo yum install -y epel-release\nsudo rpm --import https://repo.clickhouse.com/RPM-GPG-KEY-clickhouse\nsudo yum-config-manager --add-repo https://repo.clickhouse.com/rpm/stable/x86_64\nsudo yum install -y clickhouse-server clickhouse-client\n</code></pre>"},{"location":"clickhouse/install/install_single/#_3","title":"\u914d\u7f6e\u5355\u673a\u7248","text":""},{"location":"clickhouse/install/install_single/#1_1","title":"1. \u57fa\u7840\u914d\u7f6e","text":"<p>\u4fee\u6539\u4e3b\u914d\u7f6e\u6587\u4ef6 <code>/etc/clickhouse-server/config.xml</code>:</p> <pre><code>&lt;!-- \u670d\u52a1\u7aef\u53e3 --&gt;\n&lt;tcp_port&gt;9000&lt;/tcp_port&gt;\n&lt;http_port&gt;8123&lt;/http_port&gt;\n\n&lt;!-- \u76d1\u542c\u5730\u5740 --&gt;\n&lt;listen_host&gt;::&lt;/listen_host&gt;\n\n&lt;!-- \u65e5\u5fd7\u914d\u7f6e --&gt;\n&lt;logger&gt;\n    &lt;level&gt;warning&lt;/level&gt;\n    &lt;console&gt;1&lt;/console&gt;\n&lt;/logger&gt;\n\n&lt;!-- \u8d44\u6e90\u914d\u7f6e --&gt;\n&lt;max_memory_usage&gt;10000000000&lt;/max_memory_usage&gt;\n&lt;max_threads&gt;16&lt;/max_threads&gt;\n</code></pre>"},{"location":"clickhouse/install/install_single/#2_1","title":"2. \u7528\u6237\u914d\u7f6e","text":"<p>\u5728 <code>/etc/clickhouse-server/users.xml</code> \u4e2d\u914d\u7f6e\u7528\u6237:</p> <pre><code>&lt;users&gt;\n    &lt;default&gt;\n        &lt;!-- \u9ed8\u8ba4\u7528\u6237\u6743\u9650 --&gt;\n        &lt;profile&gt;default&lt;/profile&gt;\n        &lt;quota&gt;default&lt;/quota&gt;\n        &lt;networks incl=\"networks\" replace=\"replace\"&gt;\n            &lt;ip&gt;::/0&lt;/ip&gt;\n        &lt;/networks&gt;\n    &lt;/default&gt;\n\n    &lt;app_user&gt;\n        &lt;!-- \u5e94\u7528\u7528\u6237 --&gt;\n        &lt;password&gt;SecurePassword123&lt;/password&gt;\n        &lt;profile&gt;web&lt;/profile&gt;\n        &lt;quota&gt;default&lt;/quota&gt;\n        &lt;networks&gt;\n            &lt;ip&gt;127.0.0.1&lt;/ip&gt;\n        &lt;/networks&gt;\n    &lt;/app_user&gt;\n&lt;/users&gt;\n</code></pre>"},{"location":"clickhouse/install/install_single/#_4","title":"\u542f\u52a8\u548c\u9a8c\u8bc1","text":""},{"location":"clickhouse/install/install_single/#1_2","title":"1. \u542f\u52a8\u670d\u52a1","text":"<pre><code># \u542f\u52a8\u670d\u52a1\nsudo systemctl start clickhouse-server\n\n# \u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsudo systemctl enable clickhouse-server\n\n# \u68c0\u67e5\u670d\u52a1\u72b6\u6001\nsudo systemctl status clickhouse-server\n</code></pre>"},{"location":"clickhouse/install/install_single/#2_2","title":"2. \u9a8c\u8bc1\u5b89\u88c5","text":"<pre><code># \u4f7f\u7528clickhouse-client\u8fde\u63a5\nclickhouse-client\n\n# \u6216\u4f7f\u7528HTTP\u63a5\u53e3\u6d4b\u8bd5\ncurl 'http://localhost:8123/'\n</code></pre> <p>\u5728 ClickHouse \u7ec8\u7aef\u4e2d\u6267\u884c\u6d4b\u8bd5\u547d\u4ee4:</p> <pre><code>-- \u68c0\u67e5\u670d\u52a1\u5668\u7248\u672c\nSELECT version();\n\n-- \u521b\u5efa\u6d4b\u8bd5\u8868\nCREATE TABLE test_table\n(\n    id UInt32,\n    name String,\n    date Date\n) ENGINE = MergeTree()\nORDER BY (id);\n\n-- \u63d2\u5165\u6d4b\u8bd5\u6570\u636e\nINSERT INTO test_table VALUES (1, 'John Doe', '2023-01-01');\n\n-- \u67e5\u8be2\u6d4b\u8bd5\u6570\u636e\nSELECT * FROM test_table;\n</code></pre>"},{"location":"clickhouse/install/install_single/#_5","title":"\u6027\u80fd\u4f18\u5316\u5efa\u8bae","text":""},{"location":"clickhouse/install/install_single/#1_3","title":"1. \u5185\u5b58\u8bbe\u7f6e","text":"<pre><code>&lt;!-- \u9650\u5236\u5185\u5b58\u4f7f\u7528\uff0c\u9632\u6b62OOM --&gt;\n&lt;max_memory_usage&gt;8000000000&lt;/max_memory_usage&gt;\n&lt;!-- \u5728\u5185\u5b58\u4e0d\u8db3\u65f6\u4f7f\u7528\u78c1\u76d8 --&gt;\n&lt;max_bytes_before_external_group_by&gt;5000000000&lt;/max_bytes_before_external_group_by&gt;\n</code></pre>"},{"location":"clickhouse/install/install_single/#2_3","title":"2. \u5e76\u53d1\u8bbe\u7f6e","text":"<pre><code>&lt;!-- \u8c03\u6574\u6700\u5927\u7ebf\u7a0b\u6570 --&gt;\n&lt;max_threads&gt;8&lt;/max_threads&gt;\n&lt;!-- \u6700\u5927\u5e76\u53d1\u67e5\u8be2\u6570 --&gt;\n&lt;max_concurrent_queries&gt;100&lt;/max_concurrent_queries&gt;\n</code></pre>"},{"location":"clickhouse/install/install_single/#_6","title":"\u5b89\u5168\u914d\u7f6e","text":""},{"location":"clickhouse/install/install_single/#1_4","title":"1. \u7f51\u7edc\u8bbf\u95ee\u63a7\u5236","text":"<pre><code>&lt;!-- \u9650\u5236IP\u8bbf\u95ee --&gt;\n&lt;networks incl=\"networks\" replace=\"replace\"&gt;\n    &lt;ip&gt;::1&lt;/ip&gt;\n    &lt;ip&gt;127.0.0.1&lt;/ip&gt;\n    &lt;ip&gt;192.168.1.0/24&lt;/ip&gt;\n&lt;/networks&gt;\n</code></pre>"},{"location":"clickhouse/install/install_single/#2_4","title":"2. \u7528\u6237\u8ba4\u8bc1","text":"<p>\u8bbe\u7f6e\u5f3a\u5bc6\u7801\u5e76\u9650\u5236\u7528\u6237\u6743\u9650\uff0c\u4f7f\u7528\u5355\u72ec\u7684\u7528\u6237\u8fdb\u884c\u4e0d\u540c\u64cd\u4f5c\uff1a</p> <pre><code>&lt;!-- \u8bfb\u5199\u7528\u6237 --&gt;\n&lt;rw_user&gt;\n    &lt;password_sha256_hex&gt;...&lt;/password_sha256_hex&gt;\n    &lt;profile&gt;readwrite&lt;/profile&gt;\n&lt;/rw_user&gt;\n\n&lt;!-- \u53ea\u8bfb\u7528\u6237 --&gt;\n&lt;ro_user&gt;\n    &lt;password_sha256_hex&gt;...&lt;/password_sha256_hex&gt;\n    &lt;profile&gt;readonly&lt;/profile&gt;\n&lt;/ro_user&gt;\n</code></pre>"},{"location":"clickhouse/install/install_single/#_7","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"clickhouse/install/install_single/#_8","title":"\u542f\u52a8\u5931\u8d25","text":"<p>\u68c0\u67e5\u65e5\u5fd7: <code>tail -f /var/log/clickhouse-server/clickhouse-server.log</code></p>"},{"location":"clickhouse/install/install_single/#_9","title":"\u7aef\u53e3\u51b2\u7a81","text":"<p>\u4fee\u6539 <code>/etc/clickhouse-server/config.xml</code> \u4e2d\u7684 <code>&lt;tcp_port&gt;</code> \u548c <code>&lt;http_port&gt;</code> \u503c</p>"},{"location":"clickhouse/install/install_single/#_10","title":"\u9644\u5f55","text":"<p>\u5355\u673a\u7248\u9002\u7528\u4e8e\u6570\u636e\u5206\u6790\u9700\u6c42\u8f83\u5c0f\u6216\u6982\u5ff5\u9a8c\u8bc1\u7684\u573a\u666f\u3002\u5f53\u9700\u8981\u66f4\u9ad8\u541e\u5410\u91cf\u6216\u66f4\u5927\u6570\u636e\u5bb9\u91cf\u65f6\uff0c\u8bf7\u8003\u8651\u90e8\u7f72\u96c6\u7fa4\u7248\u3002</p>"},{"location":"datalake/iceberg/","title":"Iceberg","text":"<p>https://cloud.tencent.com/developer/article/2003982</p>"},{"location":"datalake/iceberg/#_1","title":"Iceberg","text":""},{"location":"datalake/nessie/","title":"Nessie","text":""},{"location":"datalake/nessie/#_1","title":"\u7ec4\u4ef6\u534f\u4f5c\u67b6\u6784","text":""},{"location":"datalake/nessie/#_2","title":"\u5404\u7ec4\u4ef6\u89d2\u8272","text":"<p>\u7ec4\u4ef6  \u804c\u8d23 Nessie  \u5b58\u50a8 Iceberg \u8868\u7684\u5143\u6570\u636e\u7248\u672c\uff08\u5982\u5206\u652f\u3001\u63d0\u4ea4\u8bb0\u5f55\uff09\uff0c\u63d0\u4f9b REST API \u63a5\u53e3 MinIO   \u5b58\u50a8 Iceberg \u8868\u7684\u6570\u636e\u6587\u4ef6\uff08Parquet/ORC\uff09\u548c\u5143\u6570\u636e\u6587\u4ef6\uff08metadata.json\uff09 Spark   \u8bbf\u95ee Nessie  REST API \u63a5\u53e3 \u901a\u8fc7 Nessie Catalog \u7ba1\u7406\u5143\u6570\u636e\u7248\u672c Keycloak \u5bf9nessie \u63d0\u4f9b OpenID \u8ba4\u8bc1 Postgres \u7528\u4e8e nessie , keycloak \u6570\u636e\u5b58\u50a8</p> <p>\u901a\u8fc7 Nessie \u7684 \u7248\u672c\u5316 Catalog \u80fd\u529b\uff0cSpark \u53ef\u4ee5\u5728 Iceberg \u8868\u4e0a\u5b9e\u73b0\u7c7b\u4f3c Git \u7684\u5206\u652f\u7ba1\u7406\uff0c\u540c\u65f6 MinIO \u63d0\u4f9b\u4f4e\u6210\u672c\u5b58\u50a8\u652f\u6301\u3002\u8fd9\u79cd\u67b6\u6784\u9002\u5408\u9700\u8981\u591a\u73af\u5883\u9694\u79bb\uff08\u5982\u5f00\u53d1/\u751f\u4ea7\u5206\u652f\uff09\u548c\u534f\u4f5c\u5f0f\u6570\u636e\u6e56\u573a\u666f\u3002</p> <p>\u53c2\u89c1 https://blog.csdn.net/biyeshejizhishi/article/details/142349823</p> <p>\u4e00\u3001Nessie \u6838\u5fc3\u4f5c\u7528</p> <p>Nessie \u662f\u7c7b\u4f3c Git \u7684 \u5206\u5e03\u5f0f\u6570\u636e\u6e56\u5143\u6570\u636e\u670d\u52a1\uff0c\u4e3a Iceberg \u63d0\u4f9b\u4ee5\u4e0b\u6838\u5fc3\u80fd\u529b\uff1a</p> <pre><code>\u7248\u672c\u63a7\u5236\uff1a\u652f\u6301\u5206\u652f\uff08Branch\uff09\u3001\u6807\u7b7e\uff08Tag\uff09\u3001\u5408\u5e76\uff08Merge\uff09\u7b49 Git \u5f0f\u64cd\u4f5c\uff0c\u8bb0\u5f55\u8868\u7ed3\u6784\uff08Schema\uff09\u3001\u5206\u533a\u7b49\u5143\u6570\u636e\u53d8\u66f4\u5386\u53f2\u3002\n\u539f\u5b50\u6027\u63d0\u4ea4\uff1a\u4fdd\u8bc1\u8de8\u591a\u8868\u7684\u5143\u6570\u636e\u53d8\u66f4\u539f\u5b50\u6027\uff0c\u907f\u514d\u90e8\u5206\u66f4\u65b0\u5bfc\u81f4\u6570\u636e\u4e0d\u4e00\u81f4\u3002\n\u5168\u5c40\u76ee\u5f55\u670d\u52a1\uff1a\u4f5c\u4e3a Iceberg Catalog \u7684\u7edf\u4e00\u5165\u53e3\uff0c\u534f\u8c03 Spark\u3001Flink\u3001Dremio \u7b49\u5de5\u5177\u8bbf\u95ee\u540c\u4e00\u7248\u672c\u5143\u6570\u636e\u3002\n</code></pre>"},{"location":"datalake/nessie/#_3","title":"\u90e8\u7f72","text":""},{"location":"datalake/nessie/#postgresql-minio","title":"postgresql, minio \u7565","text":""},{"location":"datalake/nessie/#keycloak","title":"\u90e8\u7f72Keycloak","text":"<p>docker-compose.yaml</p> <pre><code>version: '3'\nservices:\n  keycloak:\n    image: quay.io/keycloak/keycloak:26.1.2\n    ports:\n      - \"8080:8080\"\n      - \"9001:9000\"\n    environment:\n      KC_BOOTSTRAP_ADMIN_USERNAME: admin\n      KC_BOOTSTRAP_ADMIN_PASSWORD: admin\n      KC_DB: postgres\n      KC_DB_URL: jdbc:postgresql://10.0.60.28:15432/keylocak\n      KC_DB_USERNAME: keycocak\n      KC_DB_PASSWORD: 123456\n    command: [\n      \"start\",\n      \"--features=token-exchange\",\n      \"--spi-connections-jpa-quarkus-migration-strategy=update\",\n      \"--health-enabled=true\",\n      \"--http-enabled=true\",\n      \"--hostname-strict=false\"\n    ]\n    healthcheck:\n      test: \"exec 3&lt;&gt;/dev/tcp/localhost/9000 &amp;&amp; echo -e 'GET /health/ready HTTP/1.1\\\\r\\\\nHost: localhost\\\\r\\\\nConnection: close\\\\r\\\\n\\\\r\\\\n' &gt;&amp;3 &amp;&amp; cat &lt;&amp;3 | grep -q '200 OK'\"\n      interval: 5s\n      timeout: 2s\n      retries: 15\n</code></pre> <p>\u8bbf\u95eehttp://localhost:8080\u521b\u5efa\u7ba1\u7406\u5458\u8d26\u53f7\u3002</p>"},{"location":"datalake/nessie/#realm","title":"\u521b\u5efaRealm\u4e0e\u5ba2\u6237\u7aef\uff1a","text":"<pre><code>\u65b0\u5efaRealm\uff08\u5982data-lake\uff09\uff0c\u7528\u4e8e\u9694\u79bb\u6570\u636e\u6e56\u76f8\u5173\u914d\u7f6e\u3002\n\u521b\u5efa\u5ba2\u6237\u7aef\uff08Client\uff09\uff1a\n    Client ID\uff1anessie-client\n    Valid Redirect URIs\uff1ahttp://nessie-server:19120/*\uff08Nessie\u670d\u52a1\u5730\u5740\uff09\n    Access Type\uff1aconfidential\uff08\u9700\u5ba2\u6237\u7aef\u5bc6\u94a5\u8ba4\u8bc1\uff09\n    \u751f\u6210client-secret\u5e76\u4fdd\u5b58\u3002 \n\u914d\u7f6e Client scopes\n catalog\n</code></pre>"},{"location":"datalake/nessie/#_4","title":"\u914d\u7f6e\u7528\u6237\u4e0e\u89d2\u8272\uff1a","text":"<pre><code>\u6dfb\u52a0\u7528\u6237\uff08\u5982spark-user\uff09\uff0c\u8bbe\u7f6e\u5bc6\u7801\u3002\n\u521b\u5efa\u89d2\u8272\uff08\u5982data_engineer\u3001admin\uff09\uff0c\u5e76\u5206\u914d\u6743\u9650\uff08\u5982BRANCH_CREATE\uff09\u3002\n\u4e3a\u7528\u6237\u5206\u914d\u89d2\u8272\u3002\n</code></pre>"},{"location":"datalake/nessie/#keycloak_1","title":"\u8bbe\u7f6ekeycloak","text":"<p>https://projectnessie.org/guides/keycloak/?h=keycloak#setting-up-keycloak</p>"},{"location":"datalake/nessie/#_5","title":"\u9a8c\u8bc1","text":"<p>curl http://keycloak:8080/realms/data-lake/protocol/openid-connect/token --resolve keycloak:8080:127.0.0.1 --user nessie-client:KdAo5WeQRrSOMyjJgPQcpUyU6c6cOikq -d 'grant_type=client_credentials' -d 'scope=catalog' </p> <p>token=$(curl http://keycloak:8080/realms/data-lake/protocol/openid-connect/token --resolve keycloak:8080:127.0.0.1 --user nessie-client:QIFul6x1H0jTxInEozVyukGYsHel61B1 -d 'grant_type=client_credentials' -d 'scope=catalog' | jq -r .access_token)</p> <p>curl -v http://127.0.0.1:19120/api/v2/config -H \"Authorization: Bearer $token\" curl -v http://127.0.0.1:19120/iceberg/v1/config -H \"Authorization: Bearer $token\"</p>"},{"location":"datalake/nessie/#nessis","title":"\u914d\u7f6enessis","text":"<p>\u4f9d\u8d56 postgres minio keycloak</p> <pre><code>version: '3'\n\nservices:\n\n  nessie:\n    # IMPORTANT: when upgrading Nessie images, make sure to update the spark-sql packages as well\n    image: ghcr.io/projectnessie/nessie:0.103.0\n    ports:\n      # API port\n      - \"19120:19120\"\n      # Management port (metrics and health checks)\n      - \"9000:9000\"\n    environment:\n      # Version store settings.\n      # This example uses Postgres as the version store.\n      - nessie.version.store.type=JDBC\n      - nessie.version.store.persist.jdbc.datasource=postgresql\n      - quarkus.datasource.postgresql.jdbc.url=jdbc:postgresql://10.0.60.28:15432/catalog\n      - quarkus.datasource.postgresql.username=catalog\n      - quarkus.datasource.postgresql.password=catalog\n      # AuthN settings.\n      # This examples uses Keycloak for authentication.\n      - nessie.server.authentication.enabled=true\n      - quarkus.oidc.auth-server-url=http://keycloak:8080/realms/data-lake\n      - quarkus.oidc.client-id=nessie-client\n      - quarkus.oidc.token.issuer=http://keycloak:8080/realms/data-lake\n      # Object store settings.\n      # This example uses MinIO as the object store.\n      - nessie.catalog.default-warehouse=warehouse\n      - nessie.catalog.warehouses.warehouse.location=s3://demobucket/\n      - nessie.catalog.service.s3.default-options.region=us-east-1\n      - nessie.catalog.service.s3.default-options.path-style-access=true\n      - nessie.catalog.service.s3.default-options.access-key=urn:nessie-secret:quarkus:nessie.catalog.secrets.access-key\n      - nessie.catalog.secrets.access-key.name=minioadmin\n      - nessie.catalog.secrets.access-key.secret=minioadmin\n      # MinIO endpoint\n      - nessie.catalog.service.s3.default-options.endpoint=http://10.0.60.28:9002/\n    healthcheck:\n      test: \"exec 3&lt;&gt;/dev/tcp/localhost/9000 &amp;&amp; echo -e 'GET /q/health HTTP/1.1\\\\r\\\\nHost: localhost\\\\r\\\\nConnection: close\\\\r\\\\n\\\\r\\\\n' &gt;&amp;3 &amp;&amp; cat &lt;&amp;3 | grep -q '200 OK'\"\n      interval: 5s\n      timeout: 2s\n      retries: 15\n    extra_hosts:\n      - \"keycloak:10.0.60.28\"\n</code></pre> <p>\u5907\u6ce8\uff1a nessie \u5bf9minio\u8fdb\u884c\u7edf\u4e00\u7ba1\u7406, \u800c\u4e0d\u518dspark \u7b49client \u4e2d\u6307\u5b9a</p> <p>\u5b98\u7f51\u7684\u4e24\u5904\u8bf4\u660e: </p> <p>https://projectnessie.org/guides/try-nessie/ NOTE </p> <p>https://projectnessie.org/guides/iceberg-rest/#migrate-an-iceberg-client-configuration</p> <p>\u9000\u51fa http://keycloak:8080/realms/data-lake/account</p>"},{"location":"datalake/nessie/#spark-sql","title":"spark-sql","text":"<pre><code>version: '3'\nservices:\n  spark-sql:\n    image: apache/spark:3.5.4-java17-python3\n    depends_on:\n      nessie:\n        condition: service_healthy\n    stdin_open: true\n    tty: true\n    ports:\n      - \"4040-4045:4040-4045\"\n    healthcheck:\n      test: \"curl localhost:4040\"\n      interval: 5s\n      retries: 15\n    command: [\n      /opt/spark/bin/spark-sql,\n      --packages, \"org.projectnessie.nessie-integrations:nessie-spark-extensions-3.5_2.12:0.99.0,org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.6.0,software.amazon.awssdk:bundle:2.28.17,software.amazon.awssdk:url-connection-client:2.28.17\",\n      --conf, \"spark.sql.extensions=org.projectnessie.spark.extensions.NessieSparkSessionExtensions,org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions\",\n      --conf, \"spark.sql.catalog.nessie=org.apache.iceberg.spark.SparkCatalog\",\n      --conf, \"spark.sql.catalog.nessie.type=rest\",\n      --conf, \"spark.sql.catalog.nessie.uri=http://nessie:19120/iceberg/main\",\n      --conf, \"spark.sql.catalog.nessie.oauth2-server-uri=http://keycloak:8080/realms/data-lake/protocol/openid-connect/token\",\n      --conf, \"spark.sql.catalog.nessie.credential=nessie-client:KdAo5WeQRrSOMyjJgPQcpUyU6c6cOikq\",\n      --conf, \"spark.sql.catalog.nessie.scope=catalog\",\n      --conf, \"spark.sql.catalogImplementation=in-memory\",\n      --conf, \"spark.jars.ivy=/tmp/.ivy2\",\n    ]\n    volumes:\n      - ./tmp/:/tmp/.ivy2\n    extra_hosts:\n      - \"nessie:10.0.60.28\"\n      - \"keycloak:10.0.60.28\"\n</code></pre>"},{"location":"datalake/nessie/#nessie-cli","title":"nessie-cli","text":"<pre><code>version: '3'\nservices:\n  nessie-cli:\n      image: ghcr.io/projectnessie/nessie-cli:0.103.0\n      tty: true\n      command: [\n        --uri, \"http://nessie:19120/api/v2\",\n        --client-option, \"nessie.enable-api-compatibility-check=false\",\n        # Options for the internal Nessie client\n        --client-option, \"nessie.authentication.type=OAUTH2\",\n        --client-option, \"nessie.authentication.oauth2.issuer-url=http://keycloak:8080/realms/data-lake\",\n        --client-option, \"nessie.authentication.oauth2.client-id=nessie-client\",\n        --client-option, \"nessie.authentication.oauth2.client-secret=KdAo5WeQRrSOMyjJgPQcpUyU6c6cOikq\",\n        --client-option, \"nessie.authentication.oauth2.client-scopes=catalog sign\",\n        # Options for the internal Iceberg REST client\n        #--client-option, \"uri=http://nessie:19120/iceberg/main\",\n        #--client-option, \"oauth2-server-uri=http://keycloak:8080/realms/iceberg/protocol/openid-connect/token\",\n        #--client-option, \"credential=nessie-client:KdAo5WeQRrSOMyjJgPQcpUyU6c6cOikq\",\n        #--client-option, \"scope=catalog\",\n      ]\n      extra_hosts:\n       - \"nessie:10.0.60.28\"\n       - \"keycloak:10.0.60.28\"\n</code></pre> <p>\u914d\u7f6e\u53ef\u4ee5\u6210\u529f\u521b\u5efa\u8fde\u63a5\uff0c\u4f46\u662f\u6267\u884c\u547d\u4ee4\u4e00\u76f4\u5361\u3001 \u7528\u4e0b\u9762\u7684\u65b9\u5f0f</p> <p>CONNECT TO 'http://nessie:19120/iceberg/main' USING    nessie.ref = 'main' AND    nessie.authentication.type = 'OAUTH2' AND    nessie.authentication.oauth2.client-id = 'nessie-client' AND    nessie.authentication.oauth2.client-secret = 'KdAo5WeQRrSOMyjJgPQcpUyU6c6cOikq' AND    nessie.authentication.oauth2.token-endpoint = 'http://keycloak:8080/realms/data-lake/protocol/openid-connect/token';</p> <p>CONNECT TO 'http://10.1.50.200:19120/api/v2' USING    nessie.ref = 'main' AND    nessie.authentication.type = 'OAUTH2' AND    nessie.authentication.oauth2.client-id = 'nessie-client' AND    nessie.authentication.oauth2.client-secret = 'KdAo5WeQRrSOMyjJgPQcpUyU6c6cOikq' AND    nessie.authentication.oauth2.token-endpoint = 'http://10.1.50.201:8080/realms/data-lake/protocol/openid-connect/token';</p>"},{"location":"datalake/nessie/#nessie","title":"nessie \u914d\u7f6e \u9644\u5f55","text":"<p>```properties</p>"},{"location":"datalake/nessie/#_6","title":"Nessie","text":""},{"location":"datalake/nessie/#copyright-c-2020-dremio","title":"Copyright (C) 2020 Dremio","text":""},{"location":"datalake/nessie/#_7","title":"Nessie","text":""},{"location":"datalake/nessie/#licensed-under-the-apache-license-version-20-the-license","title":"Licensed under the Apache License, Version 2.0 (the \"License\");","text":""},{"location":"datalake/nessie/#you-may-not-use-this-file-except-in-compliance-with-the-license","title":"you may not use this file except in compliance with the License.","text":""},{"location":"datalake/nessie/#you-may-obtain-a-copy-of-the-license-at","title":"You may obtain a copy of the License at","text":""},{"location":"datalake/nessie/#_8","title":"Nessie","text":""},{"location":"datalake/nessie/#httpwwwapacheorglicenseslicense-20","title":"http://www.apache.org/licenses/LICENSE-2.0","text":""},{"location":"datalake/nessie/#_9","title":"Nessie","text":""},{"location":"datalake/nessie/#unless-required-by-applicable-law-or-agreed-to-in-writing-software","title":"Unless required by applicable law or agreed to in writing, software","text":""},{"location":"datalake/nessie/#distributed-under-the-license-is-distributed-on-an-as-is-basis","title":"distributed under the License is distributed on an \"AS IS\" BASIS,","text":""},{"location":"datalake/nessie/#without-warranties-or-conditions-of-any-kind-either-express-or-implied","title":"WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.","text":""},{"location":"datalake/nessie/#see-the-license-for-the-specific-language-governing-permissions-and","title":"See the License for the specific language governing permissions and","text":""},{"location":"datalake/nessie/#limitations-under-the-license","title":"limitations under the License.","text":""},{"location":"datalake/nessie/#_10","title":"Nessie","text":""},{"location":"datalake/nessie/#nessie-settings","title":"Nessie settings","text":""},{"location":"datalake/nessie/#default-base-branch-name","title":"default base branch name","text":"<p>nessie.server.default-branch=main  # \u8bbe\u7f6e\u9ed8\u8ba4\u7684\u57fa\u7840\u5206\u652f\u540d\u79f0\u4e3a\u201cmain\u201d nessie.server.send-stacktrace-to-client=false  # \u662f\u5426\u5c06\u5806\u6808\u8ddf\u8e2a\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\uff0c\u9ed8\u8ba4\u4e3afalse</p>"},{"location":"datalake/nessie/#to-provide-secrets-via-a-keystore-via-quarkus-the-following-configuration","title":"To provide secrets via a keystore via Quarkus, the following configuration","text":""},{"location":"datalake/nessie/#options-need-to-be-configured-accordingly","title":"options need to be configured accordingly.","text":""},{"location":"datalake/nessie/#for-details-see-httpsquarkusioguidesconfig-secretsstore-secrets-in-a-keystore","title":"For details see https://quarkus.io/guides/config-secrets#store-secrets-in-a-keystore","text":""},{"location":"datalake/nessie/#smallryeconfigsourcekeystorepropertiespathproperties-keystore","title":"smallrye.config.source.keystore.\"properties\".path=properties  # keystore\u7684\u8def\u5f84","text":""},{"location":"datalake/nessie/#smallryeconfigsourcekeystorepropertiespasswordarealpassword-keystore","title":"smallrye.config.source.keystore.\"properties\".password=arealpassword  # keystore\u7684\u5bc6\u7801","text":""},{"location":"datalake/nessie/#smallryeconfigsourcekeystorepropertieshandleraes-gcm-nopadding-keystore","title":"smallrye.config.source.keystore.\"properties\".handler=aes-gcm-nopadding  # keystore\u7684\u5904\u7406\u65b9\u5f0f","text":""},{"location":"datalake/nessie/#smallryeconfigsourcekeystorekeypathkey","title":"smallrye.config.source.keystore.\"key\".path=key  # \u5bc6\u94a5\u7684\u8def\u5f84","text":""},{"location":"datalake/nessie/#smallryeconfigsourcekeystorekeypasswordanotherpassword","title":"smallrye.config.source.keystore.\"key\".password=anotherpassword  # \u5bc6\u94a5\u7684\u5bc6\u7801","text":""},{"location":"datalake/nessie/#reverse-proxy-settings","title":"Reverse Proxy Settings","text":""},{"location":"datalake/nessie/#_11","title":"Nessie","text":""},{"location":"datalake/nessie/#these-config-options-are-mentioned-only-for-documentation-purposes-consult-the","title":"These config options are mentioned only for documentation purposes. Consult the","text":""},{"location":"datalake/nessie/#quarkus-documentation-for-running-behind-a-reverse-proxy-and-configure-those","title":"Quarkus documentation for \"Running behind a reverse proxy\" and configure those","text":""},{"location":"datalake/nessie/#depending-on-your-actual-needs","title":"depending on your actual needs.","text":""},{"location":"datalake/nessie/#_12","title":"Nessie","text":""},{"location":"datalake/nessie/#see-httpsquarkusioguideshttp-referencereverse-proxy","title":"See https://quarkus.io/guides/http-reference#reverse-proxy","text":""},{"location":"datalake/nessie/#_13","title":"Nessie","text":""},{"location":"datalake/nessie/#do-not-enable-these-option-unless-your-reverse-proxy-for-example-istio-or-nginx","title":"Do NOT enable these option unless your reverse proxy (for example istio or nginx)","text":""},{"location":"datalake/nessie/#is-properly-setup-to-set-these-headers-but-also-filter-those-from-incoming-requests","title":"is properly setup to set these headers but also filter those from incoming requests.","text":""},{"location":"datalake/nessie/#_14","title":"Nessie","text":""},{"location":"datalake/nessie/#quarkushttpproxyproxy-address-forwardingtrue","title":"quarkus.http.proxy.proxy-address-forwarding=true  # \u4ee3\u7406\u5730\u5740\u8f6c\u53d1","text":""},{"location":"datalake/nessie/#quarkushttpproxyallow-x-forwardedtrue-x-forwarded","title":"quarkus.http.proxy.allow-x-forwarded=true  # \u5141\u8bb8X-Forwarded\u5934","text":""},{"location":"datalake/nessie/#quarkushttpproxyenable-forwarded-hosttrue-forwarded-host","title":"quarkus.http.proxy.enable-forwarded-host=true  # \u542f\u7528Forwarded-Host\u5934","text":""},{"location":"datalake/nessie/#quarkushttpproxyenable-forwarded-prefixtrue-forwarded-prefix","title":"quarkus.http.proxy.enable-forwarded-prefix=true  # \u542f\u7528Forwarded-Prefix\u5934","text":""},{"location":"datalake/nessie/#quarkushttpproxytrusted-proxies127001","title":"quarkus.http.proxy.trusted-proxies=127.0.0.1  # \u4fe1\u4efb\u7684\u4ee3\u7406\u5217\u8868","text":""},{"location":"datalake/nessie/#support-for-external-secrets-managers-see-http1270018000nessie-latestconfigurationsecrets-manager-settings","title":"Support for external secrets managers - see http://127.0.0.1:8000/nessie-latest/configuration/#secrets-manager-settings","text":""},{"location":"datalake/nessie/#_15","title":"Nessie","text":""},{"location":"datalake/nessie/#nessiesecretstype","title":"nessie.secrets.type=  # \u5916\u90e8\u5bc6\u94a5\u7ba1\u7406\u5668\u7c7b\u578b","text":""},{"location":"datalake/nessie/#vault-hashicorp-vault-see-httpsdocsquarkiverseioquarkus-vaultdevindexhtmlconfiguration-reference","title":"VAULT:  Hashicorp Vault. See https://docs.quarkiverse.io/quarkus-vault/dev/index.html#configuration-reference","text":""},{"location":"datalake/nessie/#for-the-quarkus-docs-for-hashicorp-vault-for-specific-information","title":"for the Quarkus docs for Hashicorp Vault for specific information.","text":""},{"location":"datalake/nessie/#amazon-aws-secrets-manager-see-httpsdocsquarkiverseioquarkus-amazon-servicesdevamazon-secretsmanagerhtml_configuration_reference","title":"AMAZON: AWS Secrets Manager. See https://docs.quarkiverse.io/quarkus-amazon-services/dev/amazon-secretsmanager.html#_configuration_reference","text":""},{"location":"datalake/nessie/#for-the-quarkus-docs-for-amazon-services-secrets-manager-for-specific-information","title":"for the Quarkus docs for Amazon Services / Secrets Manager for specific information.","text":""},{"location":"datalake/nessie/#azure-aws-secrets-manager-not-supported-yet","title":"AZURE:  AWS Secrets Manager. NOT SUPPORTED YET!","text":""},{"location":"datalake/nessie/#see-httpsdocsquarkiverseioquarkus-azure-servicesdevquarkus-azure-key-vaulthtml_extension_configuration_reference","title":"See https://docs.quarkiverse.io/quarkus-azure-services/dev/quarkus-azure-key-vault.html#_extension_configuration_reference","text":""},{"location":"datalake/nessie/#for-the-quarkus-docs-for-azure-key-vault","title":"for the Quarkus docs for Azure Key Vault","text":""},{"location":"datalake/nessie/#google-google-cloud-secrets-manager-not-supported-yet","title":"GOOGLE: Google Cloud Secrets Manager. NOT SUPPORTED YET!","text":""},{"location":"datalake/nessie/#nessiesecretscachemax-elements1000","title":"nessie.secrets.cache.max-elements=1000  # \u5bc6\u94a5\u7f13\u5b58\u7684\u6700\u5927\u5143\u7d20\u6570\u91cf","text":""},{"location":"datalake/nessie/#nessiesecretscachettlpt15m-ttl","title":"nessie.secrets.cache.ttl=PT15M  # \u5bc6\u94a5\u7f13\u5b58\u7684TTL\uff08\u5b58\u6d3b\u65f6\u95f4\uff09","text":""},{"location":"datalake/nessie/#_16","title":"Nessie","text":""},{"location":"datalake/nessie/#when-using-google-cloud-secret-manager-you-may-have-to-configure-this-to-true","title":"When using Google Cloud Secret Manager you may have to configure this to 'true'","text":"<p>quarkus.google.cloud.enable-metadata-server=false  # \u662f\u5426\u542f\u7528Google Cloud\u5143\u6570\u636e\u670d\u52a1\u5668</p>"},{"location":"datalake/nessie/#to-enable-a-specific-secrets-manager-consult-the-documentations-for-those-more","title":"To enable a specific secrets manager consult the documentations for those, more","text":""},{"location":"datalake/nessie/#information-here-httpsprojectnessieorgnessie-latestconfigurationsecrets-manager-settings","title":"information here: https://projectnessie.org/nessie-latest/configuration/#secrets-manager-settings","text":""},{"location":"datalake/nessie/#nessie-catalog","title":"Nessie Catalog","text":""},{"location":"datalake/nessie/#optional-validate-that-referenced-secrets-exist-default-is-false","title":"Optional: validate that referenced secrets exist (default is false)","text":""},{"location":"datalake/nessie/#nessiecatalogvalidate-secretstrue","title":"nessie.catalog.validate-secrets=true  # \u9a8c\u8bc1\u5f15\u7528\u7684\u79d8\u5bc6\u662f\u5426\u5b58\u5728","text":""},{"location":"datalake/nessie/#optional-disable-health-check-for-object-stores-default-is-true","title":"Optional: disable health check for object stores (default is true)","text":""},{"location":"datalake/nessie/#nessiecatalogobject-storeshealth-checkenabledfalse","title":"nessie.catalog.object-stores.health-check.enabled=false  # \u7981\u7528\u5bf9\u8c61\u5b58\u50a8\u7684\u5065\u5eb7\u68c0\u67e5","text":""},{"location":"datalake/nessie/#iceberg-default-config-can-be-overridden-per-warehouse","title":"Iceberg default config (can be overridden per warehouse)","text":""},{"location":"datalake/nessie/#nessiecatalogiceberg-config-defaultspropvalue-iceberg","title":"nessie.catalog.iceberg-config-defaults.prop=value  # Iceberg\u9ed8\u8ba4\u914d\u7f6e","text":""},{"location":"datalake/nessie/#nessiecatalogiceberg-config-overridespropvalue-iceberg","title":"nessie.catalog.iceberg-config-overrides.prop=value  # Iceberg\u914d\u7f6e\u8986\u76d6","text":""},{"location":"datalake/nessie/#warehouses","title":"Warehouses","text":""},{"location":"datalake/nessie/#default-warehouse","title":"default warehouse","text":""},{"location":"datalake/nessie/#nessiecatalogdefault-warehousewarehouse","title":"nessie.catalog.default-warehouse=warehouse  # \u9ed8\u8ba4\u4ed3\u5e93","text":""},{"location":"datalake/nessie/#nessiecatalogwarehouseswarehouselocation","title":"nessie.catalog.warehouses.warehouse.location=  # \u4ed3\u5e93\u4f4d\u7f6e","text":""},{"location":"datalake/nessie/#nessiecatalogwarehouseswarehouseiceberg-config-defaultsprop-nameprop-value-iceberg","title":"nessie.catalog.warehouses.warehouse.iceberg-config-defaults.prop-name=prop-value  # \u4ed3\u5e93\u7684Iceberg\u9ed8\u8ba4\u914d\u7f6e","text":""},{"location":"datalake/nessie/#nessiecatalogwarehouseswarehouseiceberg-config-overridesprop-nameprop-value-iceberg","title":"nessie.catalog.warehouses.warehouse.iceberg-config-overrides.prop-name=prop-value  # \u4ed3\u5e93\u7684Iceberg\u914d\u7f6e\u8986\u76d6","text":""},{"location":"datalake/nessie/#additional-warehouses","title":"additional warehouses","text":""},{"location":"datalake/nessie/#nessiecatalogwarehousesanother-warehouselocation","title":"nessie.catalog.warehouses.another-warehouse.location=  # \u989d\u5916\u4ed3\u5e93\u7684\u4f4d\u7f6e","text":""},{"location":"datalake/nessie/#s3-settings","title":"S3 settings","text":""},{"location":"datalake/nessie/#default-s3-settings","title":"default S3 settings","text":""},{"location":"datalake/nessie/#nessiecatalogservices3default-optionsendpointhttplocalhost9000-s3","title":"nessie.catalog.service.s3.default-options.endpoint=http://localhost:9000  # \u9ed8\u8ba4S3\u8bbe\u7f6e\u7684\u7aef\u70b9","text":""},{"location":"datalake/nessie/#nessiecatalogservices3default-optionspath-style-accessfalse","title":"nessie.catalog.service.s3.default-options.path-style-access=false  # \u8def\u5f84\u6837\u5f0f\u8bbf\u95ee","text":""},{"location":"datalake/nessie/#nessiecatalogservices3default-optionsregionus-west-2","title":"nessie.catalog.service.s3.default-options.region=us-west-2  # \u533a\u57df\u8bbe\u7f6e","text":""},{"location":"datalake/nessie/#nessiecatalogservices3default-optionsaccess-keyurnnessie-secretquarkusmy-secretss3-default","title":"nessie.catalog.service.s3.default-options.access-key=urn:nessie-secret:quarkus:my-secrets.s3-default  # \u8bbf\u95ee\u5bc6\u94a5","text":""},{"location":"datalake/nessie/#my-secretss3-defaultnameawsaccesskeyid","title":"my-secrets.s3-default.name=awsAccessKeyId  # \u5bc6\u94a5\u540d\u79f0","text":""},{"location":"datalake/nessie/#my-secretss3-defaultsecretawssecretaccesskey","title":"my-secrets.s3-default.secret=awsSecretAccessKey  # \u5bc6\u94a5\u5185\u5bb9","text":""},{"location":"datalake/nessie/#per-bucket-s3-settings","title":"per-bucket S3 settings","text":""},{"location":"datalake/nessie/#nessiecatalogservices3bucketsbucket1endpoints3abucket1","title":"nessie.catalog.service.s3.buckets.bucket1.endpoint=s3a://bucket1  # \u6bcf\u4e2a\u6876\u7684\u8bbe\u7f6e","text":""},{"location":"datalake/nessie/#nessiecatalogservices3bucketsbucket1access-keyurnnessie-secretquarkusmy-secretss3-bucket","title":"nessie.catalog.service.s3.buckets.bucket1.access-key=urn:nessie-secret:quarkus:my-secrets.s3-bucket  # \u6876\u7684\u8bbf\u95ee\u5bc6\u94a5","text":""},{"location":"datalake/nessie/#nessiecatalogservices3bucketsbucket1regionus-east-1","title":"nessie.catalog.service.s3.buckets.bucket1.region=us-east-1  # \u6876\u7684\u533a\u57df","text":""},{"location":"datalake/nessie/#my-secretss3-bucketnameawsaccesskeyid1","title":"my-secrets.s3-bucket.name=awsAccessKeyId1  # \u6876\u7684\u5bc6\u94a5\u540d\u79f0","text":""},{"location":"datalake/nessie/#my-secretss3-bucketsecretawssecretaccesskey1","title":"my-secrets.s3-bucket.secret=awsSecretAccessKey1  # \u6876\u7684\u5bc6\u94a5\u5185\u5bb9","text":""},{"location":"datalake/nessie/#gcs-settings","title":"GCS settings","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsdefault-optionshosthttplocalhost4443-gcs","title":"nessie.catalog.service.gcs.default-options.host=http://localhost:4443  # GCS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u4e3b\u673a","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsdefault-optionsproject-idnessie-gcsid","title":"nessie.catalog.service.gcs.default-options.project-id=nessie  # GCS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u9879\u76eeID","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsdefault-optionsauth-typeaccess_token-gcs","title":"nessie.catalog.service.gcs.default-options.auth-type=access_token  # GCS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u6388\u6743\u7c7b\u578b","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsdefault-optionsoauth2-tokenurnnessie-secretquarkusmy-secretsgcs-default-gcsoauth2","title":"nessie.catalog.service.gcs.default-options.oauth2-token=urn:nessie-secret:quarkus:my-secrets.gcs-default  # GCS\u9ed8\u8ba4\u8bbe\u7f6e\u7684OAuth2\u4ee4\u724c","text":""},{"location":"datalake/nessie/#my-secretsgcs-defaulttokentokenref-gcs","title":"my-secrets.gcs-default.token=tokenRef  # GCS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u4ee4\u724c\u5f15\u7528","text":""},{"location":"datalake/nessie/#per-bucket-gcs-settings","title":"per-bucket GCS settings","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsbucketsbucket1hosthttplocalhost4443","title":"nessie.catalog.service.gcs.buckets.bucket1.host=http://localhost:4443  # \u6bcf\u4e2a\u6876\u7684\u4e3b\u673a","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsbucketsbucket1project-idnessie-id","title":"nessie.catalog.service.gcs.buckets.bucket1.project-id=nessie  # \u6bcf\u4e2a\u6876\u7684\u9879\u76eeID","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsbucketsbucket1auth-typeaccess_token","title":"nessie.catalog.service.gcs.buckets.bucket1.auth-type=access_token  # \u6bcf\u4e2a\u6876\u7684\u6388\u6743\u7c7b\u578b","text":""},{"location":"datalake/nessie/#nessiecatalogservicegcsbucketsbucket1oauth2-tokenurnnessie-secretquarkusmy-secretsgcs-bucket-oauth2","title":"nessie.catalog.service.gcs.buckets.bucket1.oauth2-token=urn:nessie-secret:quarkus:my-secrets.gcs-bucket  # \u6bcf\u4e2a\u6876\u7684OAuth2\u4ee4\u724c","text":""},{"location":"datalake/nessie/#my-secretsgcs-buckettokentokenref","title":"my-secrets.gcs-bucket.token=tokenRef  # \u6bcf\u4e2a\u6876\u7684\u4ee4\u724c\u5f15\u7528","text":""},{"location":"datalake/nessie/#adls-settings","title":"ADLS settings","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsdefault-optionsendpointhttplocalhostadlsgen2bucket-adls","title":"nessie.catalog.service.adls.default-options.endpoint=http://localhost/adlsgen2/bucket  # ADLS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u7aef\u70b9","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsdefault-optionsauth-typenone-adls","title":"nessie.catalog.service.adls.default-options.auth-type=none  # ADLS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u6388\u6743\u7c7b\u578b","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsdefault-optionsaccounturnnessie-secretquarkusmy-secretsadls-default-adls","title":"nessie.catalog.service.adls.default-options.account=urn:nessie-secret:quarkus:my-secrets.adls-default  # ADLS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u8d26\u6237","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsdefault-optionsconfigurationpropnamepropvalue-adls","title":"nessie.catalog.service.adls.default-options.configuration.propname=propvalue  # ADLS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u914d\u7f6e","text":""},{"location":"datalake/nessie/#my-secretsadls-defaultnameaccount-adls","title":"my-secrets.adls-default.name=account  # ADLS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u8d26\u6237\u540d\u79f0","text":""},{"location":"datalake/nessie/#my-secretsadls-defaultsecretsecret-adls","title":"my-secrets.adls-default.secret=secret  # ADLS\u9ed8\u8ba4\u8bbe\u7f6e\u7684\u5bc6\u94a5","text":""},{"location":"datalake/nessie/#per-file-system-adls-settings","title":"per-file-system ADLS settings","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsfile-systemsbucket1endpointhttplocalhostadlsgen2bucket","title":"nessie.catalog.service.adls.file-systems.bucket1.endpoint=http://localhost/adlsgen2/bucket  # \u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u7aef\u70b9","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsfile-systemsbucket1auth-typenone","title":"nessie.catalog.service.adls.file-systems.bucket1.auth-type=none  # \u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u6388\u6743\u7c7b\u578b","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsfile-systemsbucket1accounturnnessie-secretquarkusmy-secretsadls-fs","title":"nessie.catalog.service.adls.file-systems.bucket1.account=urn:nessie-secret:quarkus:my-secrets.adls-fs  # \u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u8d26\u6237","text":""},{"location":"datalake/nessie/#nessiecatalogserviceadlsfile-systemsbucket1configurationpropnamepropvalue","title":"nessie.catalog.service.adls.file-systems.bucket1.configuration.propname=propvalue  # \u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u914d\u7f6e","text":""},{"location":"datalake/nessie/#my-secretsadls-fsnameaccount","title":"my-secrets.adls-fs.name=account  # \u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u8d26\u6237\u540d\u79f0","text":""},{"location":"datalake/nessie/#my-secretsadls-fssecretsecret","title":"my-secrets.adls-fs.secret=secret  # \u6bcf\u4e2a\u6587\u4ef6\u7cfb\u7edf\u7684\u5bc6\u94a5","text":""},{"location":"datalake/nessie/#nessie-authorization-settings","title":"Nessie authorization settings","text":""},{"location":"datalake/nessie/#this-will-perform-authorization-on-branchestags-and-content-where-rule-definitions-are","title":"This will perform authorization on branches/tags and content where rule definitions are","text":""},{"location":"datalake/nessie/#using-a-common-expression-language-cel-expression-an-intro-to-cel-can-be-found-at-httpsgithubcomgooglecel-specblobmasterdocintromd","title":"using a Common Expression Language (CEL) expression (an intro to CEL can be found at https://github.com/google/cel-spec/blob/master/doc/intro.md).","text":""},{"location":"datalake/nessie/#rule-definitions-are-of-the-form-nessieserverauthorizationrules","title":"Rule definitions are of the form nessie.server.authorization.rules.=","text":""},{"location":"datalake/nessie/#available-variables-within-the-are-op-role-ref-path","title":"Available variables within the  are: 'op' / 'role' / 'ref' / 'path'","text":""},{"location":"datalake/nessie/#the-op-variable-in-the-can-be-any-of","title":"The 'op' variable in the  can be any of:","text":""},{"location":"datalake/nessie/#view_reference-create_reference-delete_reference-read_entries-read_content_key-list_commit_log","title":"'VIEW_REFERENCE', 'CREATE_REFERENCE', 'DELETE_REFERENCE', 'READ_ENTRIES', 'READ_CONTENT_KEY', 'LIST_COMMIT_LOG',","text":""},{"location":"datalake/nessie/#commit_change_against_reference-assign_reference_to_hash-update_entity-read_entity_value-delete_entity-view_reflog","title":"'COMMIT_CHANGE_AGAINST_REFERENCE', 'ASSIGN_REFERENCE_TO_HASH', 'UPDATE_ENTITY', 'READ_ENTITY_VALUE', 'DELETE_ENTITY', 'VIEW_REFLOG'","text":""},{"location":"datalake/nessie/#the-role-refers-to-the-users-role-and-can-be-any-string","title":"The 'role' refers to the user's role and can be any string","text":""},{"location":"datalake/nessie/#the-ref-refers-to-a-string-representing-a-branchtag-name","title":"The 'ref' refers to a string representing a branch/tag name","text":""},{"location":"datalake/nessie/#the-path-refers-to-the-key-for-the-content-of-an-object-and-can-be-any-string","title":"The 'path' refers to the Key for the content of an object and can be any string","text":""},{"location":"datalake/nessie/#some-use-case-based-example-rules-are-shown-below-in-practice-you-might-rather-create-a-single-rule-that-allows-eg-branch-creationdeletioncommits","title":"Some \"use-case-based\" example rules are shown below (in practice you might rather create a single rule that allows e.g. branch creation/deletion/commits/...):","text":""},{"location":"datalake/nessie/#nessieserverauthorizationenabledfalse","title":"nessie.server.authorization.enabled=false  # \u662f\u5426\u542f\u7528\u6388\u6743","text":""},{"location":"datalake/nessie/#nessieserverauthorizationtypecel-cel","title":"nessie.server.authorization.type=CEL  # \u6388\u6743\u7c7b\u578b\u4e3aCEL <p># nessie.server.authorization.rules.allow_branch_listing=\\</p>","text":""},{"location":"datalake/nessie/#opview_reference-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='VIEW_REFERENCE' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u5206\u652f\u5217\u8868\u67e5\u770b\u89c4\u5219 <p># nessie.server.authorization.rules.allow_branch_creation=\\</p>","text":""},{"location":"datalake/nessie/#opcreate_reference-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='CREATE_REFERENCE' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u5206\u652f\u521b\u5efa\u89c4\u5219 <p># nessie.server.authorization.rules.allow_branch_deletion=\\</p>","text":""},{"location":"datalake/nessie/#opdelete_reference-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='DELETE_REFERENCE' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u5206\u652f\u5220\u9664\u89c4\u5219 <p># nessie.server.authorization.rules.allow_listing_commitlog=\\</p>","text":""},{"location":"datalake/nessie/#oplist_commit_log-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='LIST_COMMIT_LOG' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u63d0\u4ea4\u65e5\u5fd7\u5217\u8868\u89c4\u5219 <p># nessie.server.authorization.rules.allow_entries_reading=\\</p>","text":""},{"location":"datalake/nessie/#opread_entries-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='READ_ENTRIES' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u6761\u76ee\u8bfb\u53d6\u89c4\u5219 <p># nessie.server.authorization.rules.allow_assigning_ref_to_hash=\\</p>","text":""},{"location":"datalake/nessie/#opassign_reference_to_hash-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='ASSIGN_REFERENCE_TO_HASH' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u5206\u914d\u5f15\u7528\u5230\u54c8\u5e0c\u89c4\u5219 <p># nessie.server.authorization.rules.allow_commits=\\</p>","text":""},{"location":"datalake/nessie/#opcommit_change_against_reference-rolestartswithtest_user-refstartswithallowedbranch","title":"op=='COMMIT_CHANGE_AGAINST_REFERENCE' &amp;&amp; role.startsWith('test_user') &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u63d0\u4ea4\u89c4\u5219 <p># nessie.server.authorization.rules.allow_reading_entity_value=\\</p>","text":""},{"location":"datalake/nessie/#opread_entity_value-roletest_user-pathstartswithallowed","title":"op=='READ_ENTITY_VALUE' &amp;&amp; role=='test_user' &amp;&amp; path.startsWith('allowed.')  # \u5141\u8bb8\u8bfb\u53d6\u5b9e\u4f53\u503c\u89c4\u5219 <p># nessie.server.authorization.rules.allow_updating_entity=\\</p>","text":""},{"location":"datalake/nessie/#opupdate_entity-roletest_user-pathstartswithallowed","title":"op=='UPDATE_ENTITY' &amp;&amp; role=='test_user' &amp;&amp; path.startsWith('allowed.')  # \u5141\u8bb8\u66f4\u65b0\u5b9e\u4f53\u89c4\u5219 <p># nessie.server.authorization.rules.allow_deleting_entity=\\</p>","text":""},{"location":"datalake/nessie/#opdelete_entity-roletest_user-pathstartswithallowed","title":"op=='DELETE_ENTITY' &amp;&amp; role=='test_user' &amp;&amp; path.startsWith('allowed.')  # \u5141\u8bb8\u5220\u9664\u5b9e\u4f53\u89c4\u5219 <p># nessie.server.authorization.rules.allow_commits_without_entity_changes=\\</p>","text":""},{"location":"datalake/nessie/#opcommit_change_against_reference-roletest_user2-refstartswithallowedbranch","title":"op=='COMMIT_CHANGE_AGAINST_REFERENCE' &amp;&amp; role=='test_user2' &amp;&amp; ref.startsWith('allowedBranch')  # \u5141\u8bb8\u6ca1\u6709\u5b9e\u4f53\u66f4\u6539\u7684\u63d0\u4ea4\u89c4\u5219 <p># nessie.server.authorization.rules.allow_all=\\ #   op in ['VIEW_REFERENCE','CREATE_REFERENCE','DELETE_REFERENCE','LIST_COMMITLOG','READ_ENTRIES','LIST_COMMIT_LOG',\\ #   'COMMIT_CHANGE_AGAINST_REFERENCE','ASSIGN_REFERENCE_TO_HASH','UPDATE_ENTITY','READ_ENTITY_VALUE','DELETE_ENTITY'] \\</p>","text":""},{"location":"datalake/nessie/#roleadmin_user","title":"&amp;&amp; role=='admin_user'  # \u5141\u8bb8\u6240\u6709\u64cd\u4f5c\u89c4\u5219 <p># nessie.server.authorization.rules.allow_listing_reflog=\\</p>","text":""},{"location":"datalake/nessie/#opview_reflog-roleadmin_user","title":"op=='VIEW_REFLOG' &amp;&amp; role=='admin_user'  # \u5141\u8bb8\u67e5\u770b\u5f15\u7528\u65e5\u5fd7\u89c4\u5219","text":""},{"location":"datalake/nessie/#which-type-of-version-store-to-use-in_memory-rocksdb-dynamodb2-mongodb2-cassandra2-jdbc2-bigtable","title":"which type of version store to use: IN_MEMORY, ROCKSDB, DYNAMODB2, MONGODB2, CASSANDRA2, JDBC2, BIGTABLE.","text":""},{"location":"datalake/nessie/#note-the-version-store-type-jdbc-is-deprecated-please-use-the-nessie-server-admin-tool-to-migrate-to-jdbc2","title":"Note: the version store type JDBC is deprecated, please use the Nessie Server Admin Tool to migrate to JDBC2.","text":""},{"location":"datalake/nessie/#note-the-version-store-type-cassandra-is-deprecated-please-use-the-nessie-server-admin-tool-to-migrate-to-cassandra2","title":"Note: the version store type CASSANDRA is deprecated, please use the Nessie Server Admin Tool to migrate to CASSANDRA2.","text":""},{"location":"datalake/nessie/#note-the-version-store-type-dynamodb-is-deprecated-please-use-the-nessie-server-admin-tool-to-migrate-to-dynamodb2","title":"Note: the version store type DYNAMODB is deprecated, please use the Nessie Server Admin Tool to migrate to DYNAMODB2.","text":""},{"location":"datalake/nessie/#note-the-version-store-type-mongodb-is-deprecated-please-use-the-nessie-server-admin-tool-to-migrate-to-mongodb2","title":"Note: the version store type MONGODB is deprecated, please use the Nessie Server Admin Tool to migrate to MONGODB2. <p>nessie.version.store.type=IN_MEMORY  # \u4f7f\u7528\u7684\u7248\u672c\u5b58\u50a8\u7c7b\u578b</p>","text":""},{"location":"datalake/nessie/#object-cache-size-as-a-value-relative-to-the-jvms-max-heap-size-the-cache-capacity-fraction-adjust-mb","title":"Object cache size as a value relative to the JVM's max heap size. The <code>cache-capacity-fraction-adjust-mb</code>","text":""},{"location":"datalake/nessie/#value-will-be-kept-free-when-calculating-the-effective-cache-size-set-cache-capacity-fraction-of-heap","title":"value will be \"kept free\" when calculating the effective cache size. Set <code>cache-capacity-fraction-of-heap</code>","text":""},{"location":"datalake/nessie/#to-0-to-use-a-fixed-size","title":"to 0 to use a fixed size.","text":""},{"location":"datalake/nessie/#entirely-disabling-the-cache-is-not-recommended-and-will-negatively-affect-performance","title":"Entirely disabling the cache is not recommended and will negatively affect performance.","text":""},{"location":"datalake/nessie/#nessieversionstorepersistcache-capacity-fraction-of-heap07","title":"nessie.version.store.persist.cache-capacity-fraction-of-heap=0.7  # \u7f13\u5b58\u5bb9\u91cf\u76f8\u5bf9\u4e8e\u5806\u7684\u6bd4\u4f8b","text":""},{"location":"datalake/nessie/#nessieversionstorepersistcache-capacity-fraction-adjust-mb256-mb","title":"nessie.version.store.persist.cache-capacity-fraction-adjust-mb=256  # \u7f13\u5b58\u5bb9\u91cf\u8c03\u6574MB","text":""},{"location":"datalake/nessie/#when-having-very-small-heaps-use-the-cache-capacity-fraction-min-size-mb-value-set-to-0-to-disable","title":"When having very small heaps, use the <code>cache-capacity-fraction-min-size-mb</code> value. Set to <code>0</code> to disable","text":""},{"location":"datalake/nessie/#the-min-cache-capacity","title":"the min cache capacity.","text":""},{"location":"datalake/nessie/#nessieversionstorepersistcache-capacity-fraction-min-size-mb64-mb","title":"nessie.version.store.persist.cache-capacity-fraction-min-size-mb=64  # \u7f13\u5b58\u6700\u5c0f\u5bb9\u91cfMB","text":""},{"location":"datalake/nessie/#fixed-size-of-nessies-object-cache-in-mb","title":"Fixed size of Nessie's object cache in MB.","text":""},{"location":"datalake/nessie/#settings-this-value-to-0-disables-the-fixed-size-object-cache","title":"Settings this value to 0 disables the fixed size object cache.","text":""},{"location":"datalake/nessie/#entirely-disabling-the-cache-is-not-recommended-and-will-negatively-affect-performance_1","title":"Entirely disabling the cache is not recommended and will negatively affect performance.","text":""},{"location":"datalake/nessie/#nessieversionstorepersistcache-capacity-mb0-mb","title":"nessie.version.store.persist.cache-capacity-mb=0  # \u56fa\u5b9a\u5927\u5c0f\u7684\u7f13\u5b58\u5bb9\u91cfMB","text":""},{"location":"datalake/nessie/#transactional-database-configuration","title":"Transactional database configuration","text":""},{"location":"datalake/nessie/#note-nessie-quarkus-server-comes-with-built-in-support-for-postgres-and-mariadb-or-any-database","title":"Note: Nessie Quarkus Server comes with built-in support for Postgres and MariaDB, or any database","text":""},{"location":"datalake/nessie/#compatible-with-these","title":"compatible with these.","text":""},{"location":"datalake/nessie/#select-the-datasource-to-use-with-the-nessieversionstorepersistjdbcdatasource-property","title":"Select the datasource to use with the <code>nessie.version.store.persist.jdbc.datasource</code> property;","text":""},{"location":"datalake/nessie/#the-possible-built-in-values-are-default-deprecated-postgresql-mariadb-mysql-and-h2","title":"The possible built-in values are: \"default\" (deprecated), \"postgresql\", \"mariadb\", \"mysql\" and \"h2\".","text":""},{"location":"datalake/nessie/#nessieversionstorepersistjdbcdatasourcedefault","title":"nessie.version.store.persist.jdbc.datasource=default  # \u6570\u636e\u6e90\u9009\u62e9","text":""},{"location":"datalake/nessie/#default-datasource-configuration-deprecated-use-quarkusdatasourcepostgresql-instead","title":"Default datasource configuration (deprecated; use quarkus.datasource.postgresql.* instead): <p>quarkus.datasource.db-kind=postgresql  # \u6570\u636e\u5e93\u7c7b\u578b\u4e3aPostgreSQL quarkus.datasource.active=false  # \u6570\u636e\u6e90\u662f\u5426\u6fc0\u6d3b quarkus.datasource.devservices.enabled=false  # \u662f\u5426\u542f\u7528\u5f00\u53d1\u670d\u52a1</p>","text":""},{"location":"datalake/nessie/#quarkusdatasourcejdbcurljdbcpostgresqllocalhost5432my_database-url","title":"quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/my_database  # \u6570\u636e\u5e93URL","text":""},{"location":"datalake/nessie/#quarkusdatasourceusername","title":"quarkus.datasource.username=  # \u6570\u636e\u5e93\u7528\u6237\u540d","text":""},{"location":"datalake/nessie/#quarkusdatasourcepassword","title":"quarkus.datasource.password=  # \u6570\u636e\u5e93\u5bc6\u7801","text":""},{"location":"datalake/nessie/#postgres-datasource-configuration","title":"Postgres datasource configuration: <p>quarkus.datasource.postgresql.db-kind=postgresql  # PostgreSQL\u6570\u636e\u6e90\u7684\u6570\u636e\u5e93\u7c7b\u578b quarkus.datasource.postgresql.active=false  # PostgreSQL\u6570\u636e\u6e90\u662f\u5426\u6fc0\u6d3b quarkus.datasource.postgresql.devservices.enabled=false  # \u662f\u5426\u542f\u7528PostgreSQL\u5f00\u53d1\u670d\u52a1</p>","text":""},{"location":"datalake/nessie/#quarkusdatasourcepostgresqljdbcurljdbcpostgresqllocalhost5432my_database-postgresqlurl","title":"quarkus.datasource.postgresql.jdbc.url=jdbc:postgresql://localhost:5432/my_database  # PostgreSQL\u6570\u636e\u5e93URL","text":""},{"location":"datalake/nessie/#quarkusdatasourcepostgresqlusername-postgresql","title":"quarkus.datasource.postgresql.username=  # PostgreSQL\u6570\u636e\u5e93\u7528\u6237\u540d","text":""},{"location":"datalake/nessie/#quarkusdatasourcepostgresqlpassword-postgresql","title":"quarkus.datasource.postgresql.password=  # PostgreSQL\u6570\u636e\u5e93\u5bc6\u7801","text":""},{"location":"datalake/nessie/#mariadb-datasource-configuration","title":"MariaDB datasource configuration: <p>quarkus.datasource.mariadb.db-kind=mariadb  # MariaDB\u6570\u636e\u6e90\u7684\u6570\u636e\u5e93\u7c7b\u578b quarkus.datasource.mariadb.active=false  # MariaDB\u6570\u636e\u6e90\u662f\u5426\u6fc0\u6d3b quarkus.datasource.mariadb.devservices.enabled=false  # \u662f\u5426\u542f\u7528MariaDB\u5f00\u53d1\u670d\u52a1</p>","text":""},{"location":"datalake/nessie/#quarkusdatasourcemariadbusername-mariadb","title":"quarkus.datasource.mariadb.username=  # MariaDB\u6570\u636e\u5e93\u7528\u6237\u540d","text":""},{"location":"datalake/nessie/#quarkusdatasourcemariadbpassword-mariadb","title":"quarkus.datasource.mariadb.password=  # MariaDB\u6570\u636e\u5e93\u5bc6\u7801","text":""},{"location":"datalake/nessie/#quarkusdatasourcemariadbjdbcurljdbcmariadblocalhost3306my_database-mariadburl","title":"quarkus.datasource.mariadb.jdbc.url=jdbc:mariadb://localhost:3306/my_database  # MariaDB\u6570\u636e\u5e93URL","text":""},{"location":"datalake/nessie/#do-not-remove-or-modify-the-following-as-these-optimization-flags-are-incompatible-with-nessie","title":"Do not remove or modify the following, as these optimization flags are incompatible with Nessie;","text":""},{"location":"datalake/nessie/#see-httpsmariadbcomdocsserverconnectprogramming-languagesjavabatch","title":"see https://mariadb.com/docs/server/connect/programming-languages/java/batch. <p>quarkus.datasource.mariadb.jdbc.additional-jdbc-properties.useBulkStmts=false  # \u7981\u7528\u6279\u91cf\u8bed\u53e5 quarkus.datasource.mariadb.jdbc.additional-jdbc-properties.useBulkStmtsForInserts=false  # \u7981\u7528\u6279\u91cf\u63d2\u5165</p>","text":""},{"location":"datalake/nessie/#mysql-datasource-configuration","title":"MySQL datasource configuration: <p>quarkus.datasource.mysql.db-kind=mariadb  # MySQL\u6570\u636e\u6e90\u7684\u6570\u636e\u5e93\u7c7b\u578b quarkus.datasource.mysql.active=false  # MySQL\u6570\u636e\u6e90\u662f\u5426\u6fc0\u6d3b quarkus.datasource.mysql.devservices.enabled=false  #</p>","text":""},{"location":"db/dm/","title":"\u8fbe\u68a6 v8 \u6570\u636e\u5e93\u5b89\u88c5 (Centos7)","text":""},{"location":"db/dm/#_1","title":"\u524d\u671f\u51c6\u5907","text":""},{"location":"db/dm/#_2","title":"\u66f4\u6362\u6e90","text":"<pre><code>curl http://mirrors.aliyun.com/repo/Centos-7.repo &gt; /etc/yum.repos.d/CentOS-Base.repo\n\n# \u66f4\u65b0yum\u7f13\u5b58\nyum clean all\nyum makecache\n</code></pre>"},{"location":"db/dm/#_3","title":"\u5b89\u88c5\u5fc5\u8981\u7684\u4f9d\u8d56\u5305","text":"<pre><code>yum install -y wget unzip gzip tar net-tools vim lrzsz ntp\n</code></pre>"},{"location":"db/dm/#ntp","title":"\u542f\u52a8 ntp \u670d\u52a1","text":"<pre><code>systemctl start ntpd\nsystemctl enable ntpd\n</code></pre>"},{"location":"db/dm/#_4","title":"\u4e0b\u8f7d\u8fbe\u68a6\u6570\u636e\u5e93\u5b89\u88c5\u5305\uff08\u8bf7\u6839\u636e\u5b9e\u9645\u7248\u672c\u8c03\u6574\u4e0b\u8f7d\u94fe\u63a5\uff09","text":""},{"location":"db/dm/#_5","title":"\u7cfb\u7edf\u7528\u6237","text":"<pre><code>groupadd dinstall -g 2001\nuseradd  -G dinstall -m -d /home/dmdba -s /bin/bash -u 2001 dmdba\npasswd dmdba\n</code></pre>"},{"location":"db/dm/#_6","title":"\u6587\u4ef6\u53e5\u67c4","text":"<p>vi /etc/security/limits.conf</p> <pre><code>dmdba  soft      nice       0\ndmdba  hard      nice       0\ndmdba  soft      as         unlimited\ndmdba  hard      as         unlimited\ndmdba  soft      fsize      unlimited\ndmdba  hard      fsize      unlimited\ndmdba  soft      nproc      65536\ndmdba  hard      nproc      65536\ndmdba  soft      nofile     65536\ndmdba  hard      nofile     65536\ndmdba  soft      core       unlimited\ndmdba  hard      core       unlimited\ndmdba  soft      data       unlimited\ndmdba  hard      data       unlimited\n</code></pre> <p>\u9a8c\u8bc1</p> <pre><code>su - dmdba\nulimit -a\n</code></pre>"},{"location":"db/dm/#_7","title":"\u6570\u636e\u76ee\u5f55\u51c6\u5907","text":"<p><code>\u6ce8\u610f\uff1a \u5982\u679c\u662f\u72ec\u7acb\u6570\u636e\u76d8\u60c5\u666f\uff0c\u9700\u5148\u6302\u7740\u6570\u636e\u76d8</code></p> <pre><code>mkdir -p /dmdata/data ##\u5f52\u6863\u4fdd\u5b58\u76ee\u5f55\nmkdir -p /dmdata/arch ##\u5907\u4efd\u4fdd\u5b58\u76ee\u5f55\nmkdir -p /dmdata/dmbak\n\nchown -R dmdba:dinstall /dmdata/data\nchown -R dmdba:dinstall /dmdata/arch\nchown -R dmdba:dinstall /dmdata/dmbak\n\nchmod -R 755 /dmdata/data\nchmod -R 755 /dmdata/arch\nchmod -R 755 /dmdata/dmbak\n</code></pre>"},{"location":"db/dm/#_8","title":"\u5b89\u88c5\u6570\u636e\u5e93","text":""},{"location":"db/dm/#_9","title":"\u6302\u8f7d\u955c\u50cf","text":"<pre><code>cd  /opt\nunzip dm8_20250506_x86_rh7_64.zip\nmount -o loop dm8_20250506_x86_rh7_64.iso /mnt\n</code></pre>"},{"location":"db/dm/#_10","title":"\u5b89\u88c5\u6570\u636e\u5e93","text":"<pre><code>su - dmdba\ncd /mnt\n./DMInstall.bin -i\n</code></pre> <p>\u5207\u6362\u5230 root \u7528\u6237, \u521b\u5efa DmAPService</p> <pre><code>/home/dmdba/dmdbms/script/root/root_installer.sh\n</code></pre>"},{"location":"db/dm/#_11","title":"\u914d\u7f6e\u6570\u636e\u5e93\u670d\u52a1","text":""},{"location":"db/dm/#_12","title":"\u521d\u59cb\u5316\u5b9e\u4f8b","text":"<pre><code>su - dmdba\ncd /home/dmdba/dmdbms/bin\n\n./dminit path=/dmdata/data SYSDBA_PWD=MMdba123 SYSAUDITOR_PWD=DMdba123 CHARSET=1 CASE_SENSITIVE=Y\n</code></pre>"},{"location":"db/dm/#mysql","title":"mysql \u5b9e\u4f8b","text":"<pre><code>vi /dmdata/data/DAMENG/dm.ini\n</code></pre> <pre><code>COMPATIBLE_MODE=4\n</code></pre> <p>\u6ce8\u518c\u5b9e\u4f8b\u670d\u52a1\uff0croot \u7528\u6237 . \u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>cd /home/dmdba/dmdbms/script/root/\n./dm_service_installer.sh -t dmserver -dm_ini /dmdata/data/DAMENG/dm.ini -p DAMENG\n</code></pre>"},{"location":"db/dm/#_13","title":"\u542f\u52a8\u505c\u6b62","text":"<pre><code>sudo su - dmdba\ncd /home/dmdba/dmdbms/bin\n\n./DmServiceDAMENG start\n</code></pre>"},{"location":"db/dm/#_14","title":"\u5173\u95ed\u9632\u706b\u5899","text":"<pre><code>systemctl stop firewalld\nsystemctl disable firewalld\n</code></pre>"},{"location":"db/dm/#selinux","title":"selinux \u5173\u95ed","text":""},{"location":"en/newconcept/","title":"Newconcept","text":"<p>15 The secretary told me that Mr. Harmsworth would see me. I felt very nervous when I went into his office. He did not look up from his desk when I entered. After I had sat down, he said that business was very bad. He told me that the firm could not afford to pay such large salaries. Twenty people had already left. I knew that my turn had come. 'Mr.Harmsworth,' I said in a weak voice. 'Don't interrupt,' he said. Then he smiled and told me I would receive an extra thousand pounds a year!</p> <p>16 If you park your car in the wrong place, a traffic policeman will soon find it. You will be very lucky if he lets you go without a ticket. However, this does not always happen. Traffic police are sometimes very polite. During a holiday in Sweden, I found this note on my car: 'sir, we welcome you to our city. This is a \"No Parking\" area. You will enjoy your stay here if you pay attention to our street signs. This note is only a reminder.' If you receive a request like this, you cannot fail to obey it!</p> <p>17 My aunt Jennifer is an actress. She must be at least thirty-five years old. In spite of this, she often appears on the stage as a young girl. Jennifer will have to take part in a new play soon. This time, she will be a girl of seventeen. In the play, she must appear in a bright red dress and long black stockings. Last year in another play, she had to wear short socks and a bright, orange-coloured dress. If anyone ever asks her how old she is, she always answers, 'Darling, it must be terrible to be grown up!'</p> <p>18 After I had had lunch at a village pub, I looked for my bag. I had left it on a chair beside the door and now it wasn't there! As I was looking for it, the landlord came in. 'Did you have a good meal?\" he asked. 'Yes, thank you,' I answered, 'but I can't pay the bill. I haven't got my bag.' The landlord smiled and immediately went out. In a few minutes he returned with my bag and gave it back to me. 'I'm very sorry,' he said. 'My dog had taken in into the garden. He often does this!'</p> <p>19 'The play may begin at any moment,' I said. 'It may have begun already,' Susan answered. I hurried to the ticket office. 'May I have two tickets please?' I asked. 'I'm sorry, we've sold out,' the girl said. 'What a pity!' Susan exclaimed. Just then, a man hurried to the ticket office. 'Can I return these two tickets?' he asked. 'Certainly,' the girl said. I went back to the ticket office at once. 'Could I have those two tickets please?' I asked. 'Certainly,' the girl said, 'but they're for next Wednesday's performance. Do you still want them?' 'I might as well have them,' I said sadly. 21 Aeroplanes are slowly driving me mad. I live near an airport and passing planes can be heard night and day. The airport was built years ago, but for some reason it could not be used then. Last year, however, it came into use. Over a hundred people must have been driven away from their homes by the noise. I am one of the few people left. Sometimes I think this house will be knocked down by a passing plane. I have been offered alarge sum of money to go away, but I am determined to stay here. Everybody says I must be mad and they are probably right. 22 My daughter, Jane, never dreamed of receiving a letter from a girl of her own age in Holland. Last year, we were travelling across the Channel and Jane put a piece of paper with her name and address on it into a bottle. She threw the bottle into the sea. She never thought of it again, but ten months later, she received a letter from a girl in Holland. Both girls write to each other regularly now. However, they have decided to use the post office. Letters will cost a little more, but they will certainly travel faster.</p>"},{"location":"en/words/","title":"\u5355\u8bcd\u7b14\u8bb0","text":""},{"location":"en/words/#simulator-","title":"simulator - \u6a21\u62df\u5668","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8s\u026amjule\u026at\u0259(r)] \u7f8e [\u02c8s\u026amj\u0259le\u026at\u0259r] n. \u6a21\u62df\u5668; \u6a21\u4eff\u8005; \u6a21\u62df\u88c5\u7f6e; \u4f8b\u53e5 Flight simulators are essential for training pilots.</p> <p>\u98de\u884c\u6a21\u62df\u5668\u5bf9\u4e8e\u98de\u884c\u5458\u7684\u57f9\u8bad\u81f3\u5173\u91cd\u8981\u3002</p>"},{"location":"en/words/#ultimately-","title":"ultimately - \u6700\u7ec8","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u028clt\u026am\u0259tli] \u7f8e [\u02c8\u028clt\u026am\u0259tli] adv. \u6700\u7ec8; \u6700\u540e; \u6839\u672c\u4e0a; \u7ec8\u5f52; \u6700\u57fa\u672c\u5730; \u4f8b\u53e5 Ultimately, you'll have to make the decision yourself.</p> <p>\u6700\u7ec8\u4f60\u8fd8\u662f\u5f97\u81ea\u5df1\u62ff\u4e3b\u610f\u3002</p>"},{"location":"en/words/#seamlessly-","title":"seamlessly - \u65e0\u7f1d\u5730","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8si\u02d0ml\u0259sli] \u7f8e [\u02c8si\u02d0ml\u0259sli] adv. \u65e0\u7f1d\u5730; \u6d41\u7545\u5730; \u4f8b\u53e5 The two systems were integrated seamlessly.</p> <p>\u8fd9\u4e24\u4e2a\u7cfb\u7edf\u88ab\u65e0\u7f1d\u96c6\u6210\u3002</p>"},{"location":"en/words/#transparent-","title":"transparent - \u900f\u660e\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [tr\u00e6ns\u02c8p\u00e6r\u0259nt] \u7f8e [tr\u00e6ns\u02c8p\u00e6r\u0259nt] adj. \u900f\u660e\u7684; \u660e\u4e86\u7684; \u6613\u61c2\u7684; \u5766\u7387\u7684; \u4f8b\u53e5 Her intentions were completely transparent.</p> <p>\u5979\u7684\u610f\u56fe\u5b8c\u5168\u900f\u660e\u3002</p>"},{"location":"en/words/#illustration-","title":"illustration - \u63d2\u56fe","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02cc\u026al\u0259\u02c8stre\u026a\u0283n] \u7f8e [\u02cc\u026al\u0259\u02c8stre\u026a\u0283n] n. \u56fe\u89e3; \u8bf4\u660e; \u63d2\u56fe; \u5b9e\u4f8b; \u4f8b\u53e5 The book had plenty of illustrations to explain the text.</p> <p>\u8fd9\u672c\u4e66\u6709\u5f88\u591a\u63d2\u56fe\u6765\u89e3\u91ca\u6587\u672c\u3002</p>"},{"location":"en/words/#deterministic-","title":"deterministic - \u51b3\u5b9a\u8bba\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [d\u026a\u02cct\u025c\u02d0m\u026a\u02c8n\u026ast\u026ak] \u7f8e [d\u026a\u02cct\u025c\u02d0rm\u026a\u02c8n\u026ast\u026ak] adj. \u51b3\u5b9a\u8bba\u7684; \u5bbf\u547d\u8bba\u7684; \u4f8b\u53e5 In a deterministic universe, every event is caused by previous events.</p> <p>\u5728\u4e00\u4e2a\u51b3\u5b9a\u8bba\u7684\u5b87\u5b99\u4e2d\uff0c\u6bcf\u4e00\u4e2a\u4e8b\u4ef6\u90fd\u662f\u7531\u4e4b\u524d\u7684\u4e8b\u4ef6\u6240\u5f15\u8d77\u7684\u3002</p>"},{"location":"en/words/#collaborate-","title":"collaborate - \u5408\u4f5c","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259\u02c8l\u00e6b\u0259re\u026at] \u7f8e [k\u0259\u02c8l\u00e6b\u0259re\u026at] v. \u5408\u4f5c\uff1b\u534f\u4f5c\uff1b \u4f8b\u53e5 Researchers from different countries collaborated on this project.</p> <p>\u6765\u81ea\u4e0d\u540c\u56fd\u5bb6\u7684\u7814\u7a76\u4eba\u5458\u5728\u8fd9\u4e2a\u9879\u76ee\u4e0a\u8fdb\u884c\u4e86\u5408\u4f5c\u3002</p>"},{"location":"en/words/#centralized-","title":"centralized - \u96c6\u4e2d\u5f0f\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8sentr\u0259la\u026azd] \u7f8e [\u02c8sentr\u0259la\u026azd] adj. \u96c6\u4e2d\u5316\u7684\uff1b\u4e2d\u592e\u96c6\u6743\u7684\uff1b \u4f8b\u53e5 The company uses a centralized system to manage all data.</p> <p>\u8be5\u516c\u53f8\u4f7f\u7528\u96c6\u4e2d\u5f0f\u7cfb\u7edf\u7ba1\u7406\u6240\u6709\u6570\u636e\u3002</p>"},{"location":"en/words/#compatibility-","title":"compatibility - \u517c\u5bb9\u6027","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259m\u02ccp\u00e6t\u0259\u02c8b\u026al\u0259ti] \u7f8e [k\u0259m\u02ccp\u00e6t\u0259\u02c8b\u026al\u0259ti] n. \u517c\u5bb9\u6027\uff1b\u534f\u8c03\u6027\uff1b \u4f8b\u53e5 Check the software's compatibility with your operating system.</p> <p>\u8bf7\u68c0\u67e5\u8f6f\u4ef6\u4e0e\u60a8\u64cd\u4f5c\u7cfb\u7edf\u7684\u517c\u5bb9\u6027\u3002</p>"},{"location":"en/words/#explicit-","title":"explicit - \u660e\u786e\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u026ak\u02c8spl\u026as\u026at] \u7f8e [\u026ak\u02c8spl\u026as\u026at] adj. \u660e\u786e\u7684\uff1b\u76f4\u8a00\u7684\uff1b \u4f8b\u53e5 The instructions must be explicit to avoid confusion.</p> <p>\u4e3a\u907f\u514d\u6df7\u6dc6\uff0c\u8bf4\u660e\u5fc5\u987b\u660e\u786e\u3002</p>"},{"location":"en/words/#rapid-","title":"rapid - \u8fc5\u901f\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8r\u00e6p\u026ad] \u7f8e [\u02c8r\u00e6p\u026ad] adj. \u5feb\u901f\u7684\uff1b\u8fc5\u901f\u7684\uff1b \u4f8b\u53e5 The rapid growth of technology has changed our lives.</p> <p>\u6280\u672f\u7684\u5feb\u901f\u53d1\u5c55\u6539\u53d8\u4e86\u6211\u4eec\u7684\u751f\u6d3b\u3002</p>"},{"location":"en/words/#vice-versa-","title":"vice versa - \u53cd\u4e4b\u4ea6\u7136","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02ccva\u026as \u02c8v\u025c\u02d0s\u0259] \u7f8e [\u02ccva\u026as \u02c8v\u025c\u02d0rs\u0259] adv. \u53cd\u4e4b\u4ea6\u7136\uff1b\u53cd\u8fc7\u6765\u4e5f\u4e00\u6837\uff1b \u4f8b\u53e5 Cats dislike dogs and vice versa.</p> <p>\u732b\u4e0d\u559c\u6b22\u72d7\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002</p>"},{"location":"en/words/#potentially-","title":"potentially - \u6f5c\u5728\u5730","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [p\u0259\u02c8ten\u0283\u0259li] \u7f8e [p\u0259\u02c8ten\u0283\u0259li] adv. \u53ef\u80fd\u5730\uff1b\u6f5c\u5728\u5730\uff1b \u4f8b\u53e5 This decision could potentially affect millions of people.</p> <p>\u8fd9\u4e00\u51b3\u5b9a\u53ef\u80fd\u5f71\u54cd\u6570\u767e\u4e07\u4eba\u3002</p>"},{"location":"en/words/#hypothetical-","title":"hypothetical - \u5047\u8bbe\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02ccha\u026ap\u0259\u02c8\u03b8et\u026akl] \u7f8e [\u02ccha\u026ap\u0259\u02c8\u03b8et\u026akl] adj. \u5047\u8bbe\u7684\uff1b\u5047\u60f3\u7684\uff1b \u4f8b\u53e5 Let's discuss this hypothetical scenario first.</p> <p>\u6211\u4eec\u5148\u8ba8\u8bba\u8fd9\u4e2a\u5047\u8bbe\u6027\u573a\u666f\u3002</p>"},{"location":"en/words/#drawbacks-","title":"drawbacks - \u7f3a\u70b9","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8dr\u0254\u02d0b\u00e6ks] \u7f8e [\u02c8dr\u0254\u02d0b\u00e6ks] n. \u7f3a\u70b9\uff1b\u4e0d\u5229\u6761\u4ef6\uff1b \u4f8b\u53e5 One of the main drawbacks is the high cost.</p> <p>\u4e3b\u8981\u7f3a\u70b9\u4e4b\u4e00\u662f\u9ad8\u6602\u7684\u6210\u672c\u3002</p>"},{"location":"en/words/#throughput-","title":"throughput - \u541e\u5410\u91cf","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u03b8ru\u02d0p\u028at] \u7f8e [\u02c8\u03b8ru\u02d0p\u028at] n. \u541e\u5410\u91cf\uff1b\u5904\u7406\u80fd\u529b\uff1b \u4f8b\u53e5 The network's throughput determines data transfer speed.</p> <p>\u7f51\u7edc\u541e\u5410\u91cf\u51b3\u5b9a\u6570\u636e\u4f20\u8f93\u901f\u5ea6\u3002</p>"},{"location":"en/words/#manipulate-","title":"manipulate - \u64cd\u7eb5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [m\u0259\u02c8n\u026apjule\u026at] \u7f8e [m\u0259\u02c8n\u026apjule\u026at] v. \u64cd\u63a7\uff1b\u5de7\u5999\u5904\u7406\uff1b \u4f8b\u53e5 He tried to manipulate the results of the experiment.</p> <p>\u4ed6\u8bd5\u56fe\u64cd\u7eb5\u5b9e\u9a8c\u7ed3\u679c\u3002</p>"},{"location":"en/words/#suspect-","title":"suspect - \u6000\u7591","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [s\u0259\u02c8spekt] \u7f8e [s\u0259\u02c8spekt] v. \u6000\u7591\uff1b\u731c\u60f3\uff1b \u4f8b\u53e5 I suspect she knows more than she admits.</p> <p>\u6211\u6000\u7591\u5979\u77e5\u9053\u7684\u6bd4\u5979\u627f\u8ba4\u7684\u66f4\u591a\u3002</p>"},{"location":"en/words/#mitigate-","title":"mitigate - \u51cf\u8f7b","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8m\u026at\u026a\u0261e\u026at] \u7f8e [\u02c8m\u026at\u026a\u0261e\u026at] v. \u7f13\u89e3\uff1b\u51cf\u8f7b\uff1b \u4f8b\u53e5 Planting trees helps mitigate climate change.</p> <p>\u690d\u6811\u6709\u52a9\u4e8e\u7f13\u89e3\u6c14\u5019\u53d8\u5316\u3002</p>"},{"location":"en/words/#significant-","title":"significant - \u91cd\u8981\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [s\u026a\u0261\u02c8n\u026af\u026ak\u0259nt] \u7f8e [s\u026a\u0261\u02c8n\u026af\u026ak\u0259nt] adj. \u91cd\u8981\u7684\uff1b\u663e\u8457\u7684\uff1b \u4f8b\u53e5 This discovery has significant implications for medicine.</p> <p>\u8fd9\u4e00\u53d1\u73b0\u5bf9\u533b\u5b66\u5177\u6709\u91cd\u8981\u610f\u4e49\u3002</p>"},{"location":"en/words/#definitely-","title":"definitely - \u80af\u5b9a","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8def\u026an\u0259tli] \u7f8e [\u02c8def\u026an\u0259tli] adv. \u660e\u786e\u5730\uff1b\u80af\u5b9a\u5730\uff1b \u4f8b\u53e5 I will definitely attend the meeting tomorrow.</p> <p>\u6211\u660e\u5929\u4e00\u5b9a\u4f1a\u53c2\u52a0\u4f1a\u8bae\u3002</p>"},{"location":"en/words/#inspecting-","title":"inspecting - \u68c0\u67e5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u026an\u02c8spekt\u026a\u014b] \u7f8e [\u026an\u02c8spekt\u026a\u014b] v. \u68c0\u67e5\uff1b\u5ba1\u67e5\uff08inspect \u7684\u73b0\u5728\u5206\u8bcd\uff09\uff1b \u4f8b\u53e5 They are inspecting the building for safety issues.</p> <p>\u4ed6\u4eec\u6b63\u5728\u68c0\u67e5\u5927\u697c\u7684\u5b89\u5168\u95ee\u9898\u3002</p>"},{"location":"en/words/#portion-","title":"portion - \u90e8\u5206","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8p\u0254\u02d0\u0283n] \u7f8e [\u02c8p\u0254\u02d0r\u0283n] n. \u90e8\u5206\uff1b\u4e00\u4efd\uff1b \u4f8b\u53e5 A large portion of the budget was allocated to research.</p> <p>\u5927\u90e8\u5206\u9884\u7b97\u88ab\u5206\u914d\u7ed9\u4e86\u7814\u7a76\u3002</p>"},{"location":"en/words/#regularly-","title":"regularly - \u6709\u89c4\u5f8b\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8re\u0261j\u0259l\u0259li] \u7f8e [\u02c8re\u0261j\u0259l\u0259rli] adv. \u5b9a\u671f\u5730\uff1b\u6709\u89c4\u5f8b\u5730\uff1b \u4f8b\u53e5 She exercises regularly to stay healthy.</p> <p>\u5979\u5b9a\u671f\u953b\u70bc\u4ee5\u4fdd\u6301\u5065\u5eb7\u3002</p>"},{"location":"en/words/#downsides-","title":"downsides - \u8d1f\u9762\u5f71\u54cd","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8da\u028ansa\u026adz] \u7f8e [\u02c8da\u028ansa\u026adz] n. \u7f3a\u70b9\uff1b\u8d1f\u9762\u5f71\u54cd\uff1b \u4f8b\u53e5 The downsides of the plan were discussed in detail.</p> <p>\u8be5\u8ba1\u5212\u7684\u8d1f\u9762\u5f71\u54cd\u88ab\u8be6\u7ec6\u8ba8\u8bba\u3002</p>"},{"location":"en/words/#negative-","title":"negative - \u6d88\u6781\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8ne\u0261\u0259t\u026av] \u7f8e [\u02c8ne\u0261\u0259t\u026av] adj. \u6d88\u6781\u7684\uff1b\u8d1f\u9762\u7684\uff1b \u4f8b\u53e5 The negative feedback discouraged him.</p> <p>\u8d1f\u9762\u53cd\u9988\u8ba9\u4ed6\u611f\u5230\u6c14\u9981\u3002</p>"},{"location":"en/words/#cumulative-","title":"cumulative - \u7d2f\u79ef\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8kju\u02d0mj\u0259l\u0259t\u026av] \u7f8e [\u02c8kju\u02d0mj\u0259le\u026at\u026av] adj. \u7d2f\u79ef\u7684\uff1b\u6e10\u589e\u7684\uff1b \u4f8b\u53e5 The cumulative effect of stress can harm your health.</p> <p>\u538b\u529b\u7684\u7d2f\u79ef\u6548\u5e94\u53ef\u80fd\u635f\u5bb3\u5065\u5eb7\u3002</p>"},{"location":"en/words/#dedicated-","title":"dedicated - \u4e13\u6ce8\u4e8e","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8ded\u026ake\u026at\u026ad] \u7f8e [\u02c8ded\u026ake\u026at\u026ad] adj. \u4e13\u6ce8\u7684\uff1b\u732e\u8eab\u7684\uff1b \u4f8b\u53e5 She is dedicated to her work as a teacher.</p> <p>\u5979\u5168\u8eab\u5fc3\u6295\u5165\u6559\u5e08\u5de5\u4f5c\u3002</p>"},{"location":"en/words/#dramatically-","title":"dramatically - \u663e\u8457\u5730","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [dr\u0259\u02c8m\u00e6t\u026akli] \u7f8e [dr\u0259\u02c8m\u00e6t\u026akli] adv. \u620f\u5267\u6027\u5730\uff1b\u663e\u8457\u5730\uff1b \u4f8b\u53e5 Sales increased dramatically after the new campaign.</p> <p>\u65b0\u8425\u9500\u6d3b\u52a8\u540e\u9500\u552e\u989d\u663e\u8457\u589e\u957f\u3002</p>"},{"location":"en/words/#affecting-","title":"affecting - \u5f71\u54cd","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u0259\u02c8fekt\u026a\u014b] \u7f8e [\u0259\u02c8fekt\u026a\u014b] v. \u5f71\u54cd\uff1b\u611f\u52a8\uff08affect \u7684\u73b0\u5728\u5206\u8bcd\uff09\uff1b \u4f8b\u53e5 The policy is affecting small businesses negatively.</p> <p>\u8be5\u653f\u7b56\u5bf9\u5c0f\u4f01\u4e1a\u4ea7\u751f\u4e86\u8d1f\u9762\u5f71\u54cd\u3002</p>"},{"location":"en/words/#contrast-","title":"contrast - \u5bf9\u6bd4","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8k\u0252ntr\u0251\u02d0st] \u7f8e [\u02c8k\u0251\u02d0ntr\u00e6st] n. \u5bf9\u6bd4\uff1b\u5dee\u5f02\uff1b \u4f8b\u53e5 In contrast to last year, profits have doubled.</p> <p>\u4e0e\u53bb\u5e74\u76f8\u6bd4\uff0c\u5229\u6da6\u7ffb\u4e86\u4e00\u756a\u3002</p>"},{"location":"en/words/#outperforms-","title":"outperforms - \u4f18\u4e8e","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02cca\u028atp\u0259\u02c8f\u0254\u02d0mz] \u7f8e [\u02cca\u028atp\u0259r\u02c8f\u0254\u02d0rmz] v. \u8868\u73b0\u4f18\u4e8e\uff1b\u8d85\u8fc7\uff1b \u4f8b\u53e5 The new model outperforms its competitors in speed.</p> <p>\u65b0\u673a\u578b\u5728\u901f\u5ea6\u4e0a\u4f18\u4e8e\u7ade\u4e89\u5bf9\u624b\u3002</p>"},{"location":"en/words/#consider-","title":"consider - \u8003\u8651","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259n\u02c8s\u026ad\u0259(r)] \u7f8e [k\u0259n\u02c8s\u026ad\u0259r] v. \u8003\u8651\uff1b\u8ba4\u4e3a\uff1b \u4f8b\u53e5 We need to consider all possible solutions.</p> <p>\u6211\u4eec\u9700\u8981\u8003\u8651\u6240\u6709\u53ef\u80fd\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"en/words/#leveraging-","title":"leveraging - \u5229\u7528","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8lev\u0259r\u026ad\u0292\u026a\u014b] \u7f8e [\u02c8lev\u0259r\u026ad\u0292\u026a\u014b] v. \u5229\u7528\uff1b\u6760\u6746\u4f5c\u7528\uff08leverage \u7684\u73b0\u5728\u5206\u8bcd\uff09\uff1b \u4f8b\u53e5 Leveraging technology can improve efficiency.</p> <p>\u5229\u7528\u6280\u672f\u53ef\u4ee5\u63d0\u9ad8\u6548\u7387\u3002</p>"},{"location":"en/words/#sophisticated-","title":"sophisticated - \u590d\u6742\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [s\u0259\u02c8f\u026ast\u026ake\u026at\u026ad] \u7f8e [s\u0259\u02c8f\u026ast\u026ake\u026at\u026ad] adj. \u590d\u6742\u7684\uff1b\u7cbe\u5bc6\u7684\uff1b \u4f8b\u53e5 The device uses sophisticated algorithms.</p> <p>\u8be5\u8bbe\u5907\u4f7f\u7528\u590d\u6742\u7684\u7b97\u6cd5\u3002</p>"},{"location":"en/words/#retention-","title":"retention - \u4fdd\u7559","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [r\u026a\u02c8ten\u0283n] \u7f8e [r\u026a\u02c8ten\u0283n] n. \u4fdd\u7559\uff1b\u8bb0\u5fc6\u529b\uff1b \u4f8b\u53e5 Employee retention is crucial for company stability.</p> <p>\u5458\u5de5\u4fdd\u7559\u5bf9\u516c\u53f8\u7a33\u5b9a\u81f3\u5173\u91cd\u8981\u3002</p>"},{"location":"en/words/#leverages-","title":"leverages - \u5229\u7528","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8lev\u0259r\u026ad\u0292\u026az] \u7f8e [\u02c8lev\u0259r\u026ad\u0292\u026az] v. \u5229\u7528\uff1b\u53d1\u6325\u2026\u4f5c\u7528\uff08leverage \u7684\u7b2c\u4e09\u4eba\u79f0\u5355\u6570\uff09\uff1b \u4f8b\u53e5 The tool leverages AI to improve accuracy.</p> <p>\u8be5\u5de5\u5177\u5229\u7528\u4eba\u5de5\u667a\u80fd\u63d0\u9ad8\u51c6\u786e\u6027\u3002</p>"},{"location":"en/words/#solely-","title":"solely - \u4ec5\u4ec5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8s\u0259\u028alli] \u7f8e [\u02c8so\u028alli] adv. \u4ec5\u4ec5\uff1b\u552f\u4e00\u5730\uff1b \u4f8b\u53e5 The decision was based solely on financial factors.</p> <p>\u8fd9\u4e00\u51b3\u5b9a\u4ec5\u57fa\u4e8e\u8d22\u52a1\u56e0\u7d20\u3002</p>"},{"location":"en/words/#alternative-","title":"alternative - \u66ff\u4ee3\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u0254\u02d0l\u02c8t\u025c\u02d0n\u0259t\u026av] \u7f8e [\u0254\u02d0l\u02c8t\u025c\u02d0rn\u0259t\u026av] adj. \u66ff\u4ee3\u7684\uff1b\u5907\u9009\u7684\uff1b \u4f8b\u53e5 We need an alternative plan in case this fails.</p> <p>\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u5907\u7528\u8ba1\u5212\u4ee5\u9632\u5931\u8d25\u3002</p>"},{"location":"en/words/#adjacent-","title":"adjacent - \u90bb\u8fd1\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u0259\u02c8d\u0292e\u026asnt] \u7f8e [\u0259\u02c8d\u0292e\u026asnt] adj. \u90bb\u8fd1\u7684\uff1b\u6bd7\u8fde\u7684\uff1b \u4f8b\u53e5 The park is adjacent to the school.</p> <p>\u516c\u56ed\u6bd7\u90bb\u5b66\u6821\u3002</p>"},{"location":"en/words/#exploit-","title":"exploit - \u5229\u7528","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u026ak\u02c8spl\u0254\u026at] \u7f8e [\u026ak\u02c8spl\u0254\u026at] v. \u5f00\u53d1\uff1b\u5229\u7528\uff1b \u4f8b\u53e5 Companies should not exploit natural resources irresponsibly.</p> <p>\u516c\u53f8\u4e0d\u5e94\u4e0d\u8d1f\u8d23\u4efb\u5730\u5f00\u53d1\u81ea\u7136\u8d44\u6e90\u3002</p>"},{"location":"en/words/#cumulative-_1","title":"cumulative - \u7d2f\u79ef\u7684","text":"<p>\uff08\u5df2\u5305\u542b\uff0c\u89c1\u4e0a\u6587\uff09</p>"},{"location":"en/words/#exact-method-","title":"exact method - \u7cbe\u786e\u65b9\u6cd5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u81ea\u5b9a\u4e49\u77ed\u8bed n. \u7cbe\u786e\u65b9\u6cd5\uff1b\u5177\u4f53\u65b9\u6848\uff1b \u4f8b\u53e5 The exact method of implementation is still under discussion.</p> <p>\u5177\u4f53\u7684\u5b9e\u65bd\u65b9\u6848\u4ecd\u5728\u8ba8\u8bba\u4e2d\u3002</p>"},{"location":"en/words/#entire-contents-","title":"entire contents - \u5168\u90e8\u5185\u5bb9","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u81ea\u5b9a\u4e49\u77ed\u8bed n. \u5168\u90e8\u5185\u5bb9\uff1b\u5b8c\u6574\u76ee\u5f55\uff1b \u4f8b\u53e5 The entire contents of the report were leaked.</p> <p>\u62a5\u544a\u7684\u5168\u90e8\u5185\u5bb9\u88ab\u6cc4\u9732\u4e86\u3002</p>"},{"location":"en/words/#permits-","title":"permits - \u5141\u8bb8","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [p\u0259\u02c8m\u026ats] \u7f8e [p\u0259r\u02c8m\u026ats] v. \u5141\u8bb8\uff1b\u8bb8\u53ef\uff08permit \u7684\u7b2c\u4e09\u4eba\u79f0\u5355\u6570\uff09\uff1b \u4f8b\u53e5 The license permits commercial use of the software.</p> <p>\u8be5\u8bb8\u53ef\u8bc1\u5141\u8bb8\u8f6f\u4ef6\u7684\u5546\u4e1a\u7528\u9014\u3002</p>"},{"location":"en/words/#comprises-","title":"comprises - \u5305\u542b","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259m\u02c8pra\u026az\u026az] \u7f8e [k\u0259m\u02c8pra\u026az\u026az] v. \u5305\u542b\uff1b\u7531\u2026\u7ec4\u6210\uff08comprise \u7684\u7b2c\u4e09\u4eba\u79f0\u5355\u6570\uff09\uff1b \u4f8b\u53e5 The team comprises experts from five countries.</p> <p>\u56e2\u961f\u7531\u6765\u81ea\u4e94\u4e2a\u56fd\u5bb6\u7684\u4e13\u5bb6\u7ec4\u6210\u3002</p>"},{"location":"en/words/#investigate-","title":"investigate - \u8c03\u67e5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u026an\u02c8vest\u026a\u0261e\u026at] \u7f8e [\u026an\u02c8vest\u026a\u0261e\u026at] v. \u8c03\u67e5\uff1b\u7814\u7a76\uff1b \u4f8b\u53e5 Police are investigating the cause of the accident.</p> <p>\u8b66\u65b9\u6b63\u5728\u8c03\u67e5\u4e8b\u6545\u539f\u56e0\u3002</p>"},{"location":"en/words/#decoupled-","title":"decoupled - \u89e3\u8026","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [d\u026a\u02c8k\u028cpld] \u7f8e [d\u026a\u02c8k\u028cpld] adj./v. \u89e3\u8026\u7684\uff1b\u5206\u79bb\u7684\uff1b \u4f8b\u53e5 Modern software architectures use decoupled components for better scalability.</p> <p>\u73b0\u4ee3\u8f6f\u4ef6\u67b6\u6784\u4f7f\u7528\u89e3\u8026\u7ec4\u4ef6\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u53ef\u6269\u5c55\u6027\u3002</p>"},{"location":"en/words/#essential-","title":"essential - \u81f3\u5173\u91cd\u8981","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u026a\u02c8sen\u0283l] \u7f8e [\u026a\u02c8sen\u0283l] adj. \u5fc5\u8981\u7684\uff1b\u81f3\u5173\u91cd\u8981\u7684\uff1b \u4f8b\u53e5 Regular backups are essential for data protection.</p> <p>\u5b9a\u671f\u5907\u4efd\u5bf9\u6570\u636e\u4fdd\u62a4\u81f3\u5173\u91cd\u8981\u3002</p>"},{"location":"en/words/#simultaneously-","title":"simultaneously - \u5e76\u884c\uff0c\u540c\u65f6","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02ccs\u026aml\u02c8te\u026ani\u0259sli] \u7f8e [\u02ccsa\u026aml\u02c8te\u026ani\u0259sli] adv. \u540c\u65f6\u5730\uff1b\u5e76\u884c\u5730\uff1b \u4f8b\u53e5 The system processes multiple requests simultaneously.</p> <p>\u8be5\u7cfb\u7edf\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8bf7\u6c42\u3002</p>"},{"location":"en/words/#fluctuate-","title":"fluctuate - \u6ce2\u52a8","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8fl\u028ckt\u0283ue\u026at] \u7f8e [\u02c8fl\u028ckt\u0283ue\u026at] v. \u6ce2\u52a8\uff1b\u8d77\u4f0f\uff1b \u4f8b\u53e5 Network latency may fluctuate during peak hours.</p> <p>\u7f51\u7edc\u5ef6\u8fdf\u5728\u9ad8\u5cf0\u65f6\u6bb5\u53ef\u80fd\u51fa\u73b0\u6ce2\u52a8\u3002</p>"},{"location":"en/words/#mandatory-","title":"mandatory - \u5f3a\u5236\u6027\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8m\u00e6nd\u0259t\u0259ri] \u7f8e [\u02c8m\u00e6nd\u0259t\u0254\u02d0ri] adj. \u5f3a\u5236\u6027\u7684\uff1b\u4e49\u52a1\u7684\uff1b \u4f8b\u53e5 Two-factor authentication is mandatory for system access.</p> <p>\u53cc\u56e0\u7d20\u8ba4\u8bc1\u662f\u7cfb\u7edf\u8bbf\u95ee\u7684\u5f3a\u5236\u6027\u8981\u6c42\u3002</p>"},{"location":"en/words/#provisioned-","title":"provisioned - \u88ab\u63d0\u4f9b\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [pr\u0259\u02c8v\u026a\u0292nd] \u7f8e [pr\u0259\u02c8v\u026a\u0292nd] adj. \u5df2\u914d\u7f6e\u7684\uff1b\u88ab\u4f9b\u5e94\u7684\uff1b \u4f8b\u53e5 The virtual machines were provisioned with 16GB RAM.</p> <p>\u865a\u62df\u673a\u88ab\u63d0\u4f9b\u4e86 16GB \u5185\u5b58\u3002</p>"},{"location":"en/words/#data-at-rest-","title":"data-at-rest - \u9759\u6001\u6570\u636e","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8de\u026at\u0259 \u00e6t rest] \u7f8e [\u02c8d\u00e6t\u0259 \u00e6t rest] n. \u9759\u6001\u6570\u636e\uff1b \u4f8b\u53e5 Encryption of data-at-rest prevents physical theft risks.</p> <p>\u9759\u6001\u6570\u636e\u52a0\u5bc6\u53ef\u9632\u6b62\u7269\u7406\u76d7\u7a83\u98ce\u9669\u3002</p>"},{"location":"en/words/#transparently-","title":"transparently - \u900f\u660e\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [tr\u00e6ns\u02c8p\u00e6r\u0259ntli] \u7f8e [tr\u00e6ns\u02c8p\u00e6r\u0259ntli] adv. \u900f\u660e\u5730\uff1b\u660e\u663e\u5730\uff1b \u4f8b\u53e5 The cache operates transparently without user intervention.</p> <p>\u7f13\u5b58\u900f\u660e\u5730\u8fd0\u884c\uff0c\u65e0\u9700\u7528\u6237\u5e72\u9884\u3002</p>"},{"location":"en/words/#identical-","title":"identical - \u5b8c\u5168\u76f8\u540c\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [a\u026a\u02c8dent\u026akl] \u7f8e [a\u026a\u02c8dent\u026akl] adj. \u5b8c\u5168\u76f8\u540c\u7684\uff1b\u4e00\u6a21\u4e00\u6837\u7684\uff1b \u4f8b\u53e5 The replicas maintain identical copies of the database.</p> <p>\u526f\u672c\u4fdd\u6301\u6570\u636e\u5e93\u7684\u5b8c\u5168\u76f8\u540c\u7684\u526f\u672c\u3002</p>"},{"location":"en/words/#occupied-","title":"occupied - \u5360\u7528","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u0252kjupa\u026ad] \u7f8e [\u02c8\u0251\u02d0kjupa\u026ad] adj. \u88ab\u5360\u7528\u7684\uff1b\u5fd9\u788c\u7684\uff1b \u4f8b\u53e5 The CPU was fully occupied during the stress test.</p> <p>\u5728\u538b\u529b\u6d4b\u8bd5\u671f\u95f4 CPU \u88ab\u5b8c\u5168\u5360\u7528\u3002</p>"},{"location":"en/words/#under-performing-","title":"under performing - \u8868\u73b0\u4e0d\u4f73","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02cc\u028cnd\u0259 p\u0259\u02c8f\u0254\u02d0m\u026a\u014b] \u7f8e [\u02cc\u028cnd\u0259r p\u0259r\u02c8f\u0254\u02d0rm\u026a\u014b] adj. \u8868\u73b0\u4e0d\u4f73\u7684\uff1b \u4f8b\u53e5 Replacing the under performing disk resolved the bottleneck.</p> <p>\u66f4\u6362\u8868\u73b0\u4e0d\u4f73\u7684\u78c1\u76d8\u89e3\u51b3\u4e86\u74f6\u9888\u95ee\u9898\u3002</p>"},{"location":"en/words/#profiling-","title":"profiling - \u6536\u96c6\u8d44\u6599","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8pr\u0259\u028afa\u026al\u026a\u014b] \u7f8e [\u02c8pro\u028afa\u026al\u026a\u014b] n. \u5206\u6790\uff1b\u6536\u96c6\u8d44\u6599\uff1b \u4f8b\u53e5 CPU profiling helps identify optimization opportunities.</p> <p>CPU \u8d44\u6599\u6536\u96c6\u6709\u52a9\u4e8e\u8bc6\u522b\u4f18\u5316\u673a\u4f1a\u3002</p>"},{"location":"en/words/#prominent-","title":"prominent - \u6770\u51fa","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8pr\u0252m\u026an\u0259nt] \u7f8e [\u02c8pr\u0251\u02d0m\u026an\u0259nt] adj. \u6770\u51fa\u7684\uff1b\u663e\u8457\u7684\uff1b \u4f8b\u53e5 He is a prominent contributor to the open-source project.</p> <p>\u4ed6\u662f\u8be5\u5f00\u6e90\u9879\u76ee\u7684\u6770\u51fa\u8d21\u732e\u8005\u3002</p>"},{"location":"en/words/#urgently-","title":"urgently - \u7d27\u6025","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u025c\u02d0d\u0292\u0259ntli] \u7f8e [\u02c8\u025c\u02d0rd\u0292\u0259ntli] adv. \u7d27\u6025\u5730\uff1b\u8feb\u5207\u5730\uff1b \u4f8b\u53e5 The security patch needs to be applied urgently.</p> <p>\u5b89\u5168\u8865\u4e01\u9700\u8981\u7d27\u6025\u5e94\u7528\u3002</p>"},{"location":"en/words/#occupy-","title":"occupy - \u5360\u7528","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u0252kjupa\u026a] \u7f8e [\u02c8\u0251\u02d0kjupa\u026a] v. \u5360\u7528\uff1b\u5360\u636e\uff1b \u4f8b\u53e5 Temporary files occupy significant disk space.</p> <p>\u4e34\u65f6\u6587\u4ef6\u5360\u7528\u5927\u91cf\u78c1\u76d8\u7a7a\u95f4\u3002</p>"},{"location":"en/words/#outage-","title":"outage - \u4e2d\u65ad","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8a\u028at\u026ad\u0292] \u7f8e [\u02c8a\u028at\u026ad\u0292] n. \u4e2d\u65ad\uff1b\u505c\u8fd0\uff1b \u4f8b\u53e5 The power outage caused unexpected system downtime.</p> <p>\u7535\u529b\u4e2d\u65ad\u5bfc\u81f4\u610f\u5916\u7cfb\u7edf\u505c\u673a\u3002</p>"},{"location":"en/words/#arbitration-","title":"arbitration - \u4ef2\u88c1","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02cc\u0251\u02d0b\u026a\u02c8tre\u026a\u0283n] \u7f8e [\u02cc\u0251\u02d0rb\u026a\u02c8tre\u026a\u0283n] n. \u4ef2\u88c1\uff1b\u516c\u65ad\uff1b \u4f8b\u53e5 Disk arbitration prevents concurrent access conflicts.</p> <p>\u78c1\u76d8\u4ef2\u88c1\u9632\u6b62\u5e76\u53d1\u8bbf\u95ee\u51b2\u7a81\u3002</p>"},{"location":"en/words/#arbitrary-","title":"arbitrary - \u4efb\u610f","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u0251\u02d0b\u026atr\u0259ri] \u7f8e [\u02c8\u0251\u02d0rb\u026atreri] adj. \u4efb\u610f\u7684\uff1b\u6b66\u65ad\u7684\uff1b \u4f8b\u53e5 Avoid using arbitrary values in configuration files.</p> <p>\u907f\u514d\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528\u4efb\u610f\u503c\u3002</p>"},{"location":"en/words/#definer-","title":"definer - \u5b9a\u4e49\u8005","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [d\u026a\u02c8fa\u026an\u0259] \u7f8e [d\u026a\u02c8fa\u026an\u0259r] n. \u5b9a\u4e49\u8005\uff1b \u4f8b\u53e5 The database definer must specify access permissions.</p> <p>\u6570\u636e\u5e93\u5b9a\u4e49\u8005\u5fc5\u987b\u6307\u5b9a\u8bbf\u95ee\u6743\u9650\u3002</p>"},{"location":"en/words/#perimeter-","title":"perimeter - \u5468\u8fb9","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [p\u0259\u02c8r\u026am\u026at\u0259] \u7f8e [p\u0259\u02c8r\u026am\u026at\u0259r] n. \u5468\u8fb9\uff1b\u8fb9\u754c\uff1b \u4f8b\u53e5 Firewalls protect the network perimeter from intrusions.</p> <p>\u9632\u706b\u5899\u4fdd\u62a4\u7f51\u7edc\u5468\u8fb9\u514d\u53d7\u5165\u4fb5\u3002</p>"},{"location":"en/words/#resilient-","title":"resilient - \u5f39\u6027","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [r\u026a\u02c8z\u026ali\u0259nt] \u7f8e [r\u026a\u02c8z\u026ali\u0259nt] adj. \u6709\u5f39\u6027\u7684\uff1b\u80fd\u590d\u539f\u7684\uff1b \u4f8b\u53e5 The distributed system is resilient to node failures.</p> <p>\u8be5\u5206\u5e03\u5f0f\u7cfb\u7edf\u5bf9\u8282\u70b9\u6545\u969c\u5177\u6709\u5f39\u6027\u3002</p>"},{"location":"en/words/#compatible-","title":"compatible - \u517c\u5bb9","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259m\u02c8p\u00e6t\u0259bl] \u7f8e [k\u0259m\u02c8p\u00e6t\u0259bl] adj. \u517c\u5bb9\u7684\uff1b\u76f8\u5bb9\u7684\uff1b \u4f8b\u53e5 Ensure the driver is compatible with your OS version.</p> <p>\u786e\u4fdd\u9a71\u52a8\u7a0b\u5e8f\u4e0e\u60a8\u7684\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u517c\u5bb9\u3002</p>"},{"location":"en/words/#heterogeneous-","title":"heterogeneous - \u5f02\u6784","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02cchet\u0259r\u0259\u02c8d\u0292i\u02d0ni\u0259s] \u7f8e [\u02cchet\u0259r\u0259\u02c8d\u0292i\u02d0ni\u0259s] adj. \u5f02\u6784\u7684\uff1b\u591a\u6837\u7684\uff1b \u4f8b\u53e5 The platform supports heterogeneous hardware configurations.</p> <p>\u8be5\u5e73\u53f0\u652f\u6301\u5f02\u6784\u786c\u4ef6\u914d\u7f6e\u3002</p>"},{"location":"en/words/#significantly-","title":"significantly - \u663e\u8457\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [s\u026a\u0261\u02c8n\u026af\u026ak\u0259ntli] \u7f8e [s\u026a\u0261\u02c8n\u026af\u026ak\u0259ntli] adv. \u663e\u8457\u5730\uff1b\u91cd\u8981\u5730\uff1b \u4f8b\u53e5 Compression algorithms can significantly reduce storage needs.</p> <p>\u538b\u7f29\u7b97\u6cd5\u80fd\u663e\u8457\u51cf\u5c11\u5b58\u50a8\u9700\u6c42\u3002</p>"},{"location":"en/words/#facilitate-","title":"facilitate - \u534f\u52a9","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [f\u0259\u02c8s\u026al\u026ate\u026at] \u7f8e [f\u0259\u02c8s\u026al\u026ate\u026at] v. \u4fc3\u8fdb\uff1b\u534f\u52a9\uff1b \u4f8b\u53e5 Automation tools facilitate deployment processes.</p> <p>\u81ea\u52a8\u5316\u5de5\u5177\u534f\u52a9\u90e8\u7f72\u6d41\u7a0b\u3002</p>"},{"location":"en/words/#relatively-","title":"relatively - \u76f8\u5bf9\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8rel\u0259t\u026avli] \u7f8e [\u02c8rel\u0259t\u026avli] adv. \u76f8\u5bf9\u5730\uff1b\u6bd4\u8f83\u5730\uff1b \u4f8b\u53e5 SSD storage offers relatively faster access speeds.</p> <p>SSD \u5b58\u50a8\u63d0\u4f9b\u76f8\u5bf9\u66f4\u5feb\u7684\u8bbf\u95ee\u901f\u5ea6\u3002</p>"},{"location":"en/words/#most-up-to-date-","title":"most up-to-date - \u6700\u65b0\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [m\u0259\u028ast \u028cp tu de\u026at] \u7f8e [mo\u028ast \u028cp tu de\u026at] adj. \u6700\u65b0\u7684\uff1b\u6700\u73b0\u4ee3\u7684\uff1b \u4f8b\u53e5 Always reference the most up-to-date documentation.</p> <p>\u59cb\u7ec8\u53c2\u8003\u6700\u65b0\u7684\u6587\u6863\u3002</p>"},{"location":"en/words/#perspective-","title":"perspective - \u770b\u6cd5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [p\u0259\u02c8spekt\u026av] \u7f8e [p\u0259r\u02c8spekt\u026av] n. \u770b\u6cd5\uff1b\u89c2\u70b9\uff1b \u4f8b\u53e5 From a technical perspective, the solution is sound.</p> <p>\u4ece\u6280\u672f\u89d2\u5ea6\u770b\uff0c\u8be5\u89e3\u51b3\u65b9\u6848\u662f\u53ef\u9760\u7684\u3002</p>"},{"location":"en/words/#characteristics-","title":"characteristics - \u7279\u5f81","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02cck\u00e6r\u0259kt\u0259\u02c8r\u026ast\u026aks] \u7f8e [\u02cck\u00e6r\u0259kt\u0259\u02c8r\u026ast\u026aks] n. \u7279\u5f81\uff1b\u7279\u6027\uff1b \u4f8b\u53e5 The performance characteristics are listed in the report.</p> <p>\u6027\u80fd\u7279\u5f81\u5728\u62a5\u544a\u4e2d\u5217\u51fa\u3002</p>"},{"location":"en/words/#consulting-","title":"Consulting - \u54a8\u8be2","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259n\u02c8s\u028clt\u026a\u014b] \u7f8e [k\u0259n\u02c8s\u028clt\u026a\u014b] n. \u54a8\u8be2\uff1b\u987e\u95ee\uff1b \u4f8b\u53e5 She specializes in cloud infrastructure consulting.</p> <p>\u5979\u4e13\u6ce8\u4e8e\u4e91\u57fa\u7840\u8bbe\u65bd\u54a8\u8be2\u3002</p>"},{"location":"en/words/#strengths-","title":"strengths - \u4f18\u52bf","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [stre\u014b\u03b8s] \u7f8e [stre\u014b\u03b8s] n. \u4f18\u52bf\uff1b\u957f\u5904\uff1b \u4f8b\u53e5 Understanding your product's strengths is key to marketing.</p> <p>\u4e86\u89e3\u4ea7\u54c1\u7684\u4f18\u52bf\u662f\u8425\u9500\u7684\u5173\u952e\u3002</p>"},{"location":"en/words/#autonomous-","title":"autonomous - \u81ea\u4e3b\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u0254\u02d0\u02c8t\u0252n\u0259m\u0259s] \u7f8e [\u0254\u02d0\u02c8t\u0251\u02d0n\u0259m\u0259s] adj. \u81ea\u4e3b\u7684\uff1b\u81ea\u6cbb\u7684\uff1b \u4f8b\u53e5 Autonomous vehicles are expected to transform urban transportation.</p> <p>\u81ea\u52a8\u9a7e\u9a76\u6c7d\u8f66\u6709\u671b\u6539\u53d8\u57ce\u5e02\u4ea4\u901a\u3002</p>"},{"location":"en/words/#molecule-","title":"molecule - \u5206\u5b50","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8m\u0252l\u026akju\u02d0l] \u7f8e [\u02c8m\u0251\u02d0l\u026akju\u02d0l] n. \u5206\u5b50\uff1b \u4f8b\u53e5 A water molecule consists of two hydrogen atoms bonded to one oxygen atom.</p> <p>\u6c34\u5206\u5b50\u7531\u4e24\u4e2a\u6c22\u539f\u5b50\u548c\u4e00\u4e2a\u6c27\u539f\u5b50\u7ec4\u6210\u3002</p>"},{"location":"en/words/#present-","title":"present - \u5448\u73b0\uff1b\u63d0\u51fa","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [pr\u026a\u02c8zent] \u7f8e [pr\u026a\u02c8zent] v. \u5448\u73b0\uff1b\u63d0\u51fa\uff1b \u4f8b\u53e5 You'll have twenty minutes to present your research findings.</p> <p>\u4f60\u5c06\u6709\u4e8c\u5341\u5206\u949f\u65f6\u95f4\u5448\u73b0\u4f60\u7684\u7814\u7a76\u53d1\u73b0\u3002</p>"},{"location":"en/words/#arguably-","title":"arguably - \u53ef\u8bba\u8bc1\u7684\uff0c\u53ef\u4ee5\u8bf4","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8\u0251\u02d0\u0261ju\u0259bli] \u7f8e [\u02c8\u0251\u02d0r\u0261ju\u0259bli] adv. \u53ef\u8bba\u8bc1\u5730\uff1b\u53ef\u4ee5\u8bf4\uff1b \u4f8b\u53e5 This is arguably the most efficient algorithm for data compression.</p> <p>\u8fd9\u53ef\u4ee5\u8bf4\u662f\u6700\u9ad8\u6548\u7684\u6570\u636e\u538b\u7f29\u7b97\u6cd5\u3002</p>"},{"location":"en/words/#dramatic-","title":"dramatic - \u620f\u5267\u6027\u7684\uff1b\u5de8\u5927\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [dr\u0259\u02c8m\u00e6t\u026ak] \u7f8e [dr\u0259\u02c8m\u00e6t\u026ak] adj. \u620f\u5267\u6027\u7684\uff1b\u5de8\u5927\u7684\uff1b \u4f8b\u53e5 The new policy brought dramatic improvements in air quality.</p> <p>\u65b0\u653f\u7b56\u4f7f\u7a7a\u6c14\u8d28\u91cf\u5f97\u5230\u4e86\u5de8\u5927\u6539\u5584\u3002</p>"},{"location":"en/words/#reckon-","title":"reckon - \u4f30\u8ba1\uff0c\u8ba4\u4e3a","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8rek\u0259n] \u7f8e [\u02c8rek\u0259n] v. \u4f30\u8ba1\uff1b\u8ba4\u4e3a\uff1b \u4f8b\u53e5 I reckon it'll take three weeks to complete the software migration.</p> <p>\u6211\u4f30\u8ba1\u5b8c\u6210\u8f6f\u4ef6\u8fc1\u79fb\u9700\u8981\u4e09\u5468\u65f6\u95f4\u3002</p>"},{"location":"en/words/#forensic-","title":"forensic - \u6cd5\u533b\u7684\uff1b\u6cd5\u5ead\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [f\u0259\u02c8rens\u026ak] \u7f8e [f\u0259\u02c8rens\u026ak] adj. \u6cd5\u533b\u7684\uff1b\u6cd5\u5ead\u7684\uff1b \u4f8b\u53e5 Forensic investigators found DNA evidence at the crime scene.</p> <p>\u6cd5\u533b\u8c03\u67e5\u4eba\u5458\u5728\u72af\u7f6a\u73b0\u573a\u53d1\u73b0\u4e86 DNA \u8bc1\u636e\u3002</p>"},{"location":"en/words/#solely-_1","title":"solely - \u4ec5\u4ec5","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8s\u0259\u028alli] \u7f8e [\u02c8so\u028alli] adv. \u4ec5\u4ec5\uff1b\u552f\u4e00\u5730\uff1b \u4f8b\u53e5 The decision was based solely on statistical analysis.</p> <p>\u8be5\u51b3\u5b9a\u4ec5\u4ec5\u57fa\u4e8e\u7edf\u8ba1\u5206\u6790\u3002</p>"},{"location":"en/words/#identical-_1","title":"identical - \u5b8c\u5168\u76f8\u540c","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [a\u026a\u02c8dent\u026akl] \u7f8e [a\u026a\u02c8dent\u026akl] adj. \u5b8c\u5168\u76f8\u540c\u7684\uff1b\u4e00\u6a21\u4e00\u6837\u7684\uff1b \u4f8b\u53e5 The two security keys generated were identical in every aspect.</p> <p>\u751f\u6210\u7684\u4e24\u4e2a\u5b89\u5168\u5bc6\u94a5\u5728\u5404\u65b9\u9762\u90fd\u5b8c\u5168\u76f8\u540c\u3002</p>"},{"location":"en/words/#drastically-","title":"drastically - \u6025\u5267\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [\u02c8dr\u00e6st\u026akli] \u7f8e [\u02c8dr\u00e6st\u026akli] adv. \u6025\u5267\u5730\uff1b\u5927\u5e45\u5ea6\u5730\uff1b \u4f8b\u53e5 Fuel efficiency improved drastically after the engine redesign.</p> <p>\u53d1\u52a8\u673a\u91cd\u65b0\u8bbe\u8ba1\u540e\uff0c\u71c3\u6cb9\u6548\u7387\u5927\u5e45\u63d0\u9ad8\u3002</p>"},{"location":"en/words/#consecutive-","title":"consecutive - \u8fde\u7eed\u7684","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259n\u02c8sekj\u0259t\u026av] \u7f8e [k\u0259n\u02c8sekj\u0259t\u026av] adj. \u8fde\u7eed\u7684\uff1b\u4e0d\u95f4\u65ad\u7684\uff1b \u4f8b\u53e5 They've achieved record profits for six consecutive quarters.</p> <p>\u4ed6\u4eec\u5df2\u7ecf\u8fde\u7eed\u516d\u4e2a\u5b63\u5ea6\u521b\u4e0b\u5229\u6da6\u7eaa\u5f55\u3002</p>"},{"location":"en/words/#corruption-","title":"corruption - \u8150\u8d25\uff1b\u8d2a\u6c61","text":"<p>\u5e38\u89c1\u91ca\u4e49 \u82f1 [k\u0259\u02c8r\u028cp\u0283n] \u7f8e [k\u0259\u02c8r\u028cp\u0283n] n. \u8150\u8d25\uff1b\u8d2a\u6c61\uff1b \u4f8b\u53e5 The commission was formed to investigate political corruption.</p> <p>\u8be5\u59d4\u5458\u4f1a\u662f\u4e3a\u8c03\u67e5\u653f\u6cbb\u8150\u8d25\u800c\u6210\u7acb\u7684\u3002</p> <p>divergent## divergent - \u5206\u6b67\u7684\uff1b\u53d1\u6563\u7684 fraction arguably dramatic reckon forensic desirable apparent solely confers desire assumptions \u5047\u8bbe service: type: LoadBalancer</p>"},{"location":"fluentbit/intro/","title":"Fluent Bit \u4ecb\u7ecd","text":""},{"location":"fluentbit/intro/#_1","title":"\u6982\u8ff0","text":"<p>Fluent Bit \u662f\u4e00\u4e2a\u5feb\u901f\u3001\u8f7b\u91cf\u7ea7\u7684\u65e5\u5fd7\u5904\u7406\u5668\u548c\u8f6c\u53d1\u5668\uff0c\u4e13\u95e8\u4e3a\u5d4c\u5165\u5f0f\u8bbe\u5907\u548c\u8fb9\u7f18\u8ba1\u7b97\u8bbe\u8ba1\u3002\u5b83\u7531 Fluentd \u751f\u6001\u7cfb\u7edf\u63d0\u4f9b\u652f\u6301\uff0c\u80fd\u591f\u9ad8\u6548\u6536\u96c6\u3001\u8fc7\u6ee4\u548c\u8f6c\u53d1\u65e5\u5fd7\u548c\u6307\u6807\u6570\u636e\u3002Fluent Bit \u4e3b\u8981\u9762\u5411\u6027\u80fd\u654f\u611f\u73af\u5883\uff0c\u5982\u5bb9\u5668\u5316\u73af\u5883\uff08Kubernetes\uff09\u548c\u7269\u8054\u7f51\u8bbe\u5907\u3002</p>"},{"location":"fluentbit/intro/#_2","title":"\u6838\u5fc3\u7279\u6027","text":""},{"location":"fluentbit/intro/#1","title":"1. \u8f7b\u91cf\u7ea7\u67b6\u6784","text":"<ul> <li>\u5185\u5b58\u5360\u7528\u5c0f\uff08~500KB \u5e38\u9a7b\u5185\u5b58\uff09</li> <li>\u9ad8\u6027\u80fd\u5904\u7406</li> <li>\u652f\u6301\u591a\u64cd\u4f5c\u7cfb\u7edf\uff08Linux, BSD, macOS, Windows, Tizen\uff09</li> <li>\u652f\u6301\u591a\u79cd\u67b6\u6784\uff08x86_64, ARM, MIPS \u7b49\uff09</li> </ul>"},{"location":"fluentbit/intro/#2","title":"2. \u7edf\u4e00\u65e5\u5fd7\u5904\u7406","text":"<ul> <li>\u6536\u96c6 (Input)\uff1a\u4ece\u5404\u79cd\u6570\u636e\u6e90\u83b7\u53d6\u65e5\u5fd7</li> <li>\u5904\u7406 (Parser)\uff1a\u89e3\u6790\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u5fd7\u6570\u636e</li> <li>\u8fc7\u6ee4 (Filter)\uff1a\u5bf9\u65e5\u5fd7\u6570\u636e\u8fdb\u884c\u5904\u7406</li> <li>\u8f93\u51fa (Output)\uff1a\u53d1\u9001\u5230\u6307\u5b9a\u76ee\u7684\u5730</li> </ul>"},{"location":"fluentbit/intro/#3","title":"3. \u5b9e\u65f6\u6570\u636e\u5904\u7406","text":"<ul> <li>\u5b9e\u65f6\u6570\u636e\u6536\u96c6\u548c\u5904\u7406</li> <li>\u9ad8\u541e\u5410\u91cf\u80fd\u529b\uff08&gt; 5K events/\u79d2\uff09</li> <li>\u4f4e\u5ef6\u8fdf\u5904\u7406</li> </ul>"},{"location":"fluentbit/intro/#_3","title":"\u6838\u5fc3\u7ec4\u4ef6","text":""},{"location":"fluentbit/intro/#1-input","title":"1. \u8f93\u5165 (Input)","text":"<ul> <li>Tail: \u8bfb\u53d6\u6587\u4ef6\u53d8\u5316\uff08\u5982\u65e5\u5fd7\u6587\u4ef6\uff09</li> <li>Systemd: \u4ece systemd journal \u8bfb\u53d6\u65e5\u5fd7</li> <li>Forward: \u901a\u8fc7 Fluent \u534f\u8bae\u63a5\u6536\u6570\u636e</li> <li>CPU, Mem, Disk, Network: \u7cfb\u7edf\u6307\u6807\u6536\u96c6</li> <li>Docker, Kubernetes: \u5bb9\u5668\u5316\u73af\u5883\u96c6\u6210</li> </ul>"},{"location":"fluentbit/intro/#2-parser","title":"2. \u89e3\u6790\u5668 (Parser)","text":"<ul> <li>\u9884\u5b9a\u4e49\u89e3\u6790\u5668\uff1aJSON, CSV, Logfmt \u7b49</li> <li>\u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\u89e3\u6790</li> <li>\u81ea\u5b9a\u4e49\u89e3\u6790\u5668\u914d\u7f6e</li> </ul>"},{"location":"fluentbit/intro/#3-filter","title":"3. \u8fc7\u6ee4\u5668 (Filter)","text":"<ul> <li>\u91cd\u547d\u540d/\u5220\u9664\u6807\u7b7e\u6216\u5b57\u6bb5</li> <li>\u8bb0\u5f55\u4e30\u5bcc\uff1a\u6dfb\u52a0\u65b0\u5b57\u6bb5</li> <li>\u65e5\u671f/\u65f6\u95f4\u5904\u7406</li> <li>\u6bd4\u8f83\u8fc7\u6ee4</li> </ul>"},{"location":"fluentbit/intro/#4-output","title":"4. \u8f93\u51fa (Output)","text":"<ul> <li>Forward: \u53d1\u9001\u5230 Fluentd \u6216\u5176\u4ed6 Fluent Bit \u5b9e\u4f8b</li> <li>ES: \u53d1\u9001\u5230 Elasticsearch</li> <li>InfluxDB: \u53d1\u9001\u5230 InfluxDB</li> <li>S3: \u4e0a\u4f20\u5230 Amazon S3</li> <li>Stdout: \u6807\u51c6\u8f93\u51fa</li> <li>Kafka: \u53d1\u9001\u5230 Apache Kafka</li> </ul>"},{"location":"fluentbit/intro/#_4","title":"\u67b6\u6784\u7ec4\u4ef6","text":""},{"location":"fluentbit/intro/#1_1","title":"1. \u5904\u7406\u5f15\u64ce","text":"<ul> <li>\u57fa\u4e8e\u4e8b\u4ef6\u9a71\u52a8\u6a21\u578b</li> <li>\u96c6\u6210 I/O \u670d\u52a1</li> <li>\u591a\u7ebf\u7a0b\u67b6\u6784</li> <li>\u5185\u5b58\u7f13\u5b58\u673a\u5236</li> </ul>"},{"location":"fluentbit/intro/#2_1","title":"2. \u6838\u5fc3\u670d\u52a1","text":"<ul> <li>Lib: C \u5e93\u5b9e\u73b0\uff0c\u6838\u5fc3\u5f15\u64ce</li> <li>Daemon: \u5b88\u62a4\u8fdb\u7a0b</li> <li>Binary: \u53ef\u6267\u884c\u6587\u4ef6</li> </ul>"},{"location":"fluentbit/intro/#_5","title":"\u4f7f\u7528\u573a\u666f","text":""},{"location":"fluentbit/intro/#1_2","title":"1. \u5bb9\u5668\u73af\u5883","text":"<ul> <li>Kubernetes \u96c6\u7fa4\u65e5\u5fd7\u805a\u5408</li> <li>Docker \u65e5\u5fd7\u6536\u96c6</li> <li>\u5bb9\u5668\u6307\u6807\u76d1\u63a7</li> </ul>"},{"location":"fluentbit/intro/#2_2","title":"2. \u8fb9\u7f18\u8ba1\u7b97","text":"<ul> <li>IoT \u8bbe\u5907\u6570\u636e\u6536\u96c6</li> <li>\u8d44\u6e90\u53d7\u9650\u73af\u5883\u65e5\u5fd7\u5904\u7406</li> <li>\u79bb\u7ebf\u6570\u636e\u7f13\u5b58</li> </ul>"},{"location":"fluentbit/intro/#3_1","title":"3. \u65e5\u5fd7\u4e2d\u5fc3\u5316","text":"<ul> <li>\u96c6\u4e2d\u5f0f\u65e5\u5fd7\u7ba1\u7406</li> <li>\u65e5\u5fd7\u5f52\u6863\u548c\u5206\u6790</li> <li>\u5e94\u7528\u6027\u80fd\u76d1\u63a7</li> </ul>"},{"location":"fluentbit/intro/#_6","title":"\u4e0e\u5176\u4ed6\u4ea7\u54c1\u5bf9\u6bd4","text":"\u7279\u6027 Fluent Bit Fluentd Logstash \u5185\u5b58\u5360\u7528 &lt; 1MB ~250MB ~500MB CPU \u4f7f\u7528 \u6781\u4f4e \u4f4e \u9ad8 \u5b89\u88c5\u590d\u6742\u5ea6 \u7b80\u5355 \u4e2d\u7b49 \u590d\u6742 \u5904\u7406\u6027\u80fd \u9ad8 (5K+ events/s) \u4e2d\u7b49 \u4f4e \u914d\u7f6e\u7075\u6d3b\u6027 \u6709\u9650 \u9ad8 \u9ad8 \u63d2\u4ef6\u751f\u6001 \u826f\u597d \u4f18\u79c0 \u4f18\u79c0"},{"location":"fluentbit/intro/#fluentd","title":"\u4e0e Fluentd \u7684\u5173\u7cfb","text":"<p>Fluent Bit \u53ef\u4f5c\u4e3a Fluentd \u7684\u524d\u7aef\u4ee3\u7406\uff0c\u5f62\u6210\u5206\u5c42\u67b6\u6784\uff1a</p> <ul> <li>Fluent Bit \u5728\u8fb9\u7f18\u7aef\u6536\u96c6\u548c\u9884\u5904\u7406</li> <li>Fluentd \u5728\u4e2d\u5fc3\u7aef\u805a\u5408\u548c\u9ad8\u7ea7\u5904\u7406</li> <li>\u8fd9\u79cd\u67b6\u6784\u4f18\u5316\u4e86\u7f51\u7edc\u4f7f\u7528\u5e76\u63d0\u9ad8\u4e86\u53ef\u9760\u6027</li> </ul>"},{"location":"fluentbit/intro/#_7","title":"\u4f18\u52bf\u548c\u52a3\u52bf","text":""},{"location":"fluentbit/intro/#_8","title":"\u4f18\u52bf","text":"<ol> <li>\u5185\u5b58\u548c CPU \u4f7f\u7528\u6548\u7387\u6781\u9ad8</li> <li>\u542f\u52a8\u901f\u5ea6\u5feb</li> <li>\u914d\u7f6e\u76f8\u5bf9\u7b80\u5355</li> <li>\u4e0e\u4e91\u539f\u751f\u751f\u6001\u7cfb\u7edf\u7d27\u5bc6\u96c6\u6210</li> </ol>"},{"location":"fluentbit/intro/#_9","title":"\u52a3\u52bf","text":"<ol> <li>\u529f\u80fd\u96c6\u76f8\u5bf9\u8f83\u6709\u9650</li> <li>\u63d2\u4ef6\u6570\u91cf\u4e0d\u53ca Fluentd</li> <li>\u5bf9\u590d\u6742\u5904\u7406\u7684\u9700\u6c42\u4e0d\u5982 Fluentd</li> </ol> <p>Fluent Bit \u975e\u5e38\u9002\u5408\u9700\u8981\u5728\u8d44\u6e90\u53d7\u9650\u73af\u5883\u4e2d\u8fdb\u884c\u9ad8\u6548\u65e5\u5fd7\u548c\u6307\u6807\u5904\u7406\u7684\u573a\u666f\uff0c\u662f\u6784\u5efa\u53ef\u6269\u5c55\u65e5\u5fd7\u805a\u5408\u89e3\u51b3\u65b9\u6848\u7684\u91cd\u8981\u7ec4\u4ef6\u3002</p>"},{"location":"fluentbit/problems/","title":"Problems","text":""},{"location":"fluentbit/problems/#_1","title":"\u5e38\u89c1\u95ee\u9898\u96c6\u5408","text":""},{"location":"fluentbit/problems/#_2","title":"\u95ee\u9898\u63cf\u8ff0","text":"<p>\u5f53fluentbit \u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u5982\u4f55\u53d1\u751f\u9519\u8bef\uff0c\u4f1a\u5bfc\u81f4cpu\u6301\u7eed\u5347\u9ad8\uff0c\u76f4\u5230\u8d44\u6e90\u8017\u5c3d\u4e0d\u53ef\u7528\u3002</p>"},{"location":"fluentbit/problems/#_3","title":"\u95ee\u9898\u63cf\u8ff0","text":"<p>output \u5230minio \u9519\u8bef\u4fe1\u606f</p> <pre><code>[2024/08/20 01:49:40] [error] [/root/go/src/fluent-bit/src/flb_http_client.c:1201 errno=32] Broken pipe\n[2024/08/20 01:49:41] [error] [/root/go/src/fluent-bit/src/flb_http_client.c:1201 errno=32] Broken pipe\n[2024/08/20 01:49:41] [error] [output:s3:s3.0] PutObject request failed\n.....\n[2024/08/20 02:09:45] [error] [output:s3:s3.0] PutObject request failed\n[2024/08/20 02:10:05] [error] [output:s3:s3.0] PutObject API responded with error='SignatureDoesNotMatch', message='The request signature we calculated does not match the signature you provided. Check your key and signing method.'\n[2024/08/20 02:10:05] [error] [output:s3:s3.0] Raw PutObject response: HTTP/1.1 403 Forbidden\nAccept-Ranges: bytes\n</code></pre> <p>\u89e3\u51b3, minio \u6587\u4ef6\u540d\u8fc7\u957f</p> <pre><code>- s3_key_format   /$TAG/%Y/%m/%d/.log \n+ s3_key_format   /$TAG[4]/%Y/%m/%d/%H/%M/%S.log\n</code></pre>"},{"location":"fluentbit/problems/#_4","title":"\u95ee\u9898\u63cf\u8ff0","text":"<p>\u4e0a\u4f20\u5230 minio \u65f6 MultipartUpload \u6a21\u5f0f\u9519\u8bef</p> <pre><code>[2024/08/15 02:52:11] [error] [output:s3:s3.2] CreateMultipartUpload: Could not parse response\n[2024/08/15 02:52:11] [error] [output:s3:s3.2] CreateMultipartUpload request failed\n[2024/08/15 02:52:11] [error] [output:s3:s3.2] Could not initiate multipart upload\n[2024/08/15 02:52:19] [error] [output:s3:s3.2] CreateMultipartUpload: Could not parse response\n[2024/08/15 02:52:19] [error] [output:s3:s3.2] CreateMultipartUpload request failed\n</code></pre> <p>\u89e3\u51b3 \uff0c\u5173\u95edMultipartUpload\uff0c\u91c7\u7528\u5355\u5b9e\u4f8b\u4e0a\u4f20\u3002 \u5206\u6279\u4e0a\u4f20\u4f1a\u4ea7\u751f\u591a\u4e2aworker \u8fdb\u7a0b\u6765\u8fdb\u884c\u4e0a\u4f20\u3002</p> <pre><code>use_put_object  On\n</code></pre> <p>^[(?P[^]])] \"(?P\\S+) (?P[^\\\"]?) (?P\\S+)\" ^[(?[^]])] \"(?\\S+)(?: +(?[^\\\"]?)(?: +\\S)?)? (?\\S+)\" (?<code>[^ ]) <p>[2016-04-15T20:17:00.310Z] \"POST /api/v1/locations HTTP/2\" 204 - 154 0 226 100 \"10.0.35.28\" \"nsq2http\" \"cc21d9b0-cf5c-432b-8c7e-98aeb7988cd2\" \"locations\" \"tcp://10.0.2.1:80\"</p> <p>[2024-08-21T01:14:56.707Z] \"HEAD / HTTP/1.1\" 404 NR route_not_found - \"-\" 0 0 0 - \"10.0.0.15\" \"curl/7.81.0\" \"a01beb57-4024-4302-b96a-019c2de2c5e6\" \"10.2.14.4\" \"-\" - - 10.0.2.42:80 10.0.0.15:38970 - -</p>"},{"location":"grafana/alert/","title":"Alert","text":"<p>\u8c03\u7528webhook</p>"},{"location":"grafana/alert/#binbash","title":"!/bin/bash","text":"<p>curl -H \"Content-Type: application/json\" \\ -X POST \\ -d '{\"msg_type\": \"text\",      \"content\": {          \"text\": \"\u6d4b\u8bd5\u4fe1\u606f\"      }     }' \\ https://webhook\u5730\u5740</p> <p>curl -H \"Content-Type: application/json\" \\ -X POST \\ -d '{     \"timestamp\": \"1723776159\",        \"sign\": \"gwg2H/c79MK7BJF8A3uQl0+duKnAbuKxMUXz8ms9BQM=\",      \"msg_type\": \"text\",     \"content\": { \"text\": \"request example\"}   }' \\ https://open.feishu.cn/open-apis/bot/v2/hook/c76b4167-ee86-48eb-a616-2fc7d640bfba</p> <p>{\"msg_type\":\"text\",\"content\":{\"text\":\"request example\"}}</p> <p>[ var='B0' metric='\u767e\u79d1A\u533a_bka54' labels={device=/dev/md127, fstype=xfs, idc=\u767e\u79d1A\u533a, instance=bka54, job=system, mountpoint=/data} value=83.18487280678053 ], [ var='B1' metric='\u767e\u79d1B\u533a_bkb55' labels={device=/dev/md127, fstype=xfs, idc=\u767e\u79d1B\u533a, instance=bkb55, job=system, mountpoint=/data} value=80.64210742368793 ]</p> <p>\u8c03\u7528alertmanager  \u914d\u7f6e\u62a5\u8b66\u89c4\u5219 https://help.aliyun.com/zh/grafana/user-guide/configure-grafana-native-alarm</p> <p>https://www.feishu.cn/flow/api/trigger-webhook/66f1e8fc523fecd5e8886c9b12c14c16</p>"},{"location":"grafana/alert/#usrbinenv-bash","title":"!/usr/bin/env bash","text":"<p>alerts_message='[   {     \"labels\": {        \"alertname\": \"\u78c1\u76d8\u5df2\u6ee1\",        \"dev\": \"sda1\",        \"instance\": \"\u5b9e\u4f8b1\",        \"msgtype\": \"testing\"      },      \"annotations\": {         \"info\": \"\u7a0b\u5e8f\u5458\u5c0f\u738b\u63d0\u793a\u60a8\uff1a\u8fd9\u4e2a\u78c1\u76d8sda1\u5df2\u7ecf\u6ee1\u4e86\uff0c\u5feb\u5904\u7406\uff01\",         \"summary\": \"\u8bf7\u68c0\u67e5\u5b9e\u4f8b\u793a\u4f8b1\"       }   },   {     \"labels\": {        \"alertname\": \"\u78c1\u76d8\u5df2\u6ee1\",        \"dev\": \"sda2\",        \"instance\": \"\u5b9e\u4f8b1\",        \"msgtype\": \"testing\"      },      \"annotations\": {         \"info\": \"\u7a0b\u5e8f\u5458\u5c0f\u738b\u63d0\u793a\u60a8\uff1a\u8fd9\u4e2a\u78c1\u76d8sda2\u5df2\u7ecf\u6ee1\u4e86\uff0c\u5feb\u5904\u7406\uff01\",         \"summary\": \"\u8bf7\u68c0\u67e5\u5b9e\u4f8b\u793a\u4f8b1\",         \"runbook\": \"\u4ee5\u4e0b\u94fe\u63a5http://test-url\u5e94\u8be5\u662f\u53ef\u70b9\u51fb\u7684\"       }   } ]'</p> <p>curl -XPOST -d\"$alerts_message\" http://127.0.0.1:9093/api/v1/alerts</p> <p>curl -H \"Authorization: Bearer B235f8A2565346e4A7fC253D810983b0TCWCUDaxirfvuMLHdwlzQLqeIYbgZvpzsrQsgFSITYDQrzegKYIIdKnNdrNQFeFdCmIdXgwWbqLtlDVUdroeslcBfUvIvgJG\" \"drycc-controller-api.drycc.svc.cluster.local/v2/apps/ehp/metrics\"</p>"},{"location":"istio/quikstart/","title":"Quikstart","text":"<p>echo $token eyJhbGciOiJSUzI1NiIsImtpZCI6InpFeDU5ampNdnI1aTVQZVFqMVhXNnFyZ2s1YUxneXg0Vl9SY0kwUmtwUGsifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzU2ODg5NzU1LCJpYXQiOjE3NTY4ODYxNTUsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiYTA1NTBiMjctODZjMy00ZDhlLThlZmQtOWIzMzZjNTI3N2ZmIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiZTU3NTZkMDQtN2EzMS00M2IzLWFmMjYtMWQxMTRjYWQ5ODAyIn19LCJuYmYiOjE3NTY4ODYxNTUsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDphZG1pbi11c2VyIn0.EpbvXXFrelNgaQU7T5IpeAIYERQP384kqhU_E6NovghHc-YSQvD9nJlae63qw4aZp192uKIhfMn-3jNMf5KIkASjswq6FAMA8VMJvHV8jZNbDyV9XKbSYNoYB1vGl-j9gK21KbWCgSTrwNaROMNJm6pFbhFZGWy7WOmGr2LsjCTJi_imzsjMlZmA9vkoGuQUGcgGMkMOC4qXD3Mppz5gwxNPZu9MStNjkQhALs5fi_sbaDs60u9sFYqM6e53rhXgY2gSJITKsswWSf8tk8ZMU4so4TSAmuSsy06dbHgffy_yKSTVQGsibuVDTXE0lUT6giJb3WGhdD5M--h2Ld06JA</p> <p>\u542f\u52a8 \u754c\u9762\u7a0b\u5e8f  <code>kubectl proxy</code></p> <p>\u914d\u7f6eistio \u73af\u5883\u53d8\u91cf</p> <pre><code> export PATH=\"$PATH:/opt/istio-1.27.0/bin\"\n</code></pre> <p>\u5b89\u88c5 istio <code>istioctl install --set profile=ambient --skip-confirmation</code>bash</p>"},{"location":"kubernetes/sts_update/","title":"Sts update","text":"<p>updateStrategy:   type: RollingUpdate   rollingUpdate:     partition: 3</p> <p>3 \u4e2a\u526f\u672c\u7684 \u5c06 partition \u4ece3 \u4f9d\u6b21\u6539\u6210 2 -&gt;1 -&gt; 0 .\u5b9e\u73b0\u5206\u90e8\u91cd\u542f</p> <p>shell.options['dba.restartWaitTimeout']=300;</p> <p>\u91cd\u542f\u540e\u91cd\u65b0\u52a0\u5165\u96c6\u7fa4 dba.getCluster().rejoinInstance('root@helmbroker-mysql-01-1:3306');</p> <p>\u96c6\u7fa4\u4e3b\u8282\u70b9\u5207\u6362 dba.getCluster().setPrimaryInstance('helmbroker-mysql-01-1:3306')</p>"},{"location":"linux/","title":"\ud83d\udc27 Linux \u4e13\u4e1a\u6587\u6863\u4e2d\u5fc3","text":"\u5f00\u6e90\u64cd\u4f5c\u7cfb\u7edf\u7684\u57fa\u77f3\u4e0e\u6838\u5fc3 <p>\u7a33\u5b9a \u2022 \u5b89\u5168 \u2022 \u9ad8\u6548 \u2022 \u81ea\u7531</p>"},{"location":"linux/#_1","title":"\ud83d\udcda \u5feb\u901f\u5bfc\u822a","text":"\ud83d\udd27 \u7cfb\u7edf\u7ba1\u7406\u5de5\u5177 <p>\u5e38\u7528\u7684 Linux \u7cfb\u7edf\u7ba1\u7406\u5de5\u5177\u4e0e\u5b9e\u7528\u7a0b\u5e8f\u3002</p> \u8be6\u60c5 \ud83d\udcbb KVM \u865a\u62df\u5316 <p>KVM \u865a\u62df\u5316\u5e73\u53f0\u914d\u7f6e\u4e0e\u7ba1\u7406\u6307\u5357\u3002</p> \u8be6\u60c5 \ud83d\udce6 \u6570\u636e\u6062\u590d <p>\u4f7f\u7528 ddrescue \u8fdb\u884c\u6570\u636e\u6062\u590d\u7684\u6280\u672f\u8bf4\u660e\u3002</p> \u8be6\u60c5 \ud83d\udd10 \u5b89\u5168\u7ba1\u7406 <p>Linux \u7cfb\u7edf\u5b89\u5168\u7ba1\u7406\u4e0e\u9632\u62a4\u5b9e\u8df5\u3002</p> \u8be6\u60c5 \ud83d\udd0d \u786c\u4ef6\u76d1\u63a7 <p>\u5229\u7528 smartctl \u548c ipmitool \u76d1\u63a7\u786c\u4ef6\u5065\u5eb7\u72b6\u6001\u3002</p> \u8be6\u60c5 \ud83e\udde9 ELF \u5de5\u5177 <p>elfutil \u7b49\u4e8c\u8fdb\u5236\u6587\u4ef6\u5904\u7406\u5de5\u5177\u8be6\u89e3\u3002</p> \u8be6\u60c5 \ud83d\udd27 \u8865\u4e01\u7ba1\u7406 <p>Linux \u7cfb\u7edf\u8865\u4e01\u7ba1\u7406\u4e0e\u66f4\u65b0\u6d41\u7a0b\u3002</p> \u8be6\u60c5 ernetes K8s \u5de5\u5177 <p>kuberctl \u7b49 Kubernetes \u7ba1\u7406\u5de5\u5177\u4f7f\u7528\u6307\u5357\u3002</p> \u8be6\u60c5"},{"location":"linux/#linux_1","title":"Linux \u7cfb\u7edf\u6982\u8ff0","text":"<p>Linux \u662f\u4e00\u5957\u514d\u8d39\u4f7f\u7528\u548c\u81ea\u7531\u4f20\u64ad\u7684\u7c7b UNIX \u64cd\u4f5c\u7cfb\u7edf\uff0c\u662f\u4e00\u4e2a\u57fa\u4e8e POSIX \u7684\u591a\u7528\u6237\u3001\u591a\u4efb\u52a1\u3001\u652f\u6301\u591a\u7ebf\u7a0b\u548c\u591a CPU \u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u5b83\u80fd\u8fd0\u884c\u4e3b\u8981\u7684 UNIX \u5de5\u5177\u8f6f\u4ef6\u3001\u5e94\u7528\u7a0b\u5e8f\u548c\u7f51\u7edc\u534f\u8bae\uff0c\u5e76\u652f\u6301 32 \u4f4d\u548c 64 \u4f4d\u786c\u4ef6\u3002Linux \u7ee7\u627f\u4e86 Unix \u4ee5\u7f51\u7edc\u4e3a\u6838\u5fc3\u7684\u8bbe\u8ba1\u601d\u60f3\uff0c\u662f\u4e00\u4e2a\u6027\u80fd\u7a33\u5b9a\u7684\u591a\u7528\u6237\u8ba1\u7b97\u673a\u64cd\u4f5c\u7cfb\u7edf\u3002</p> <p>\u672c\u6587\u6863\u96c6\u5408\u6db5\u76d6\u4e86 Linux \u7cfb\u7edf\u7684\u5404\u4e2a\u65b9\u9762\uff0c\u4ece\u57fa\u7840\u7684\u7cfb\u7edf\u7ba1\u7406\u5230\u9ad8\u7ea7\u7cfb\u7edf\u914d\u7f6e\uff0c\u4ee5\u53ca\u7279\u5b9a\u7684\u8fd0\u7ef4\u5b9e\u8df5\u3002</p>"},{"location":"linux/#_2","title":"\u6838\u5fc3\u7ec4\u6210\u90e8\u5206","text":"<ul> <li>\u7cfb\u7edf\u7ba1\u7406: \u7cfb\u7edf\u76d1\u63a7\u3001\u8fdb\u7a0b\u7ba1\u7406\u3001\u670d\u52a1\u914d\u7f6e\u7b49\u57fa\u7840\u77e5\u8bc6</li> <li>\u865a\u62df\u5316\u6280\u672f: KVM \u7b49\u865a\u62df\u5316\u5e73\u53f0\u7684\u5e94\u7528</li> <li>\u786c\u4ef6\u7ba1\u7406: \u5229\u7528\u4e13\u7528\u5de5\u5177\u8fdb\u884c\u786c\u4ef6\u76d1\u63a7\u548c\u7ef4\u62a4</li> <li>\u5b89\u5168\u7ba1\u63a7: \u6743\u9650\u7ba1\u7406\u3001\u8bbf\u95ee\u63a7\u5236\u548c\u5b89\u5168\u52a0\u56fa</li> <li>\u96c6\u7fa4\u7ba1\u7406: Kubernetes \u7b49\u5bb9\u5668\u7f16\u6392\u6280\u672f</li> <li>\u5e94\u6025\u7ef4\u62a4: \u6570\u636e\u6062\u590d\u3001\u7cfb\u7edf\u8865\u4e01\u7b49\u7ef4\u62a4\u4efb\u52a1</li> </ul>"},{"location":"linux/#_3","title":"\u7cfb\u7edf\u8d44\u6e90","text":""},{"location":"linux/#linux_2","title":"Linux \u5de5\u5177\u4e0e\u5b9e\u7528\u7a0b\u5e8f\u603b\u89c8","text":"<p>\u6db5\u76d6\u5e38\u7528\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u4ee5\u53ca\u5728\u8fd0\u7ef4\u573a\u666f\u4e2d\u4f7f\u7528\u7684\u91cd\u8981\u5de5\u5177\u5982 ddrescue \u7528\u4e8e\u6570\u636e\u6062\u590d\uff0celfutil \u8fdb\u884c ELF \u6587\u4ef6\u5206\u6790\u7b49\u3002</p>"},{"location":"linux/#_4","title":"\u7cfb\u7edf\u7ef4\u62a4","text":"<ul> <li>KVM \u865a\u62df\u5316\u6280\u672f\u7684\u5b89\u88c5\u548c\u914d\u7f6e</li> <li>\u7cfb\u7edf\u8865\u4e01\u7ba1\u7406\u7684\u6b63\u786e\u6d41\u7a0b\u548c\u6ce8\u610f\u4e8b\u9879</li> <li>\u5229\u7528 smartctl \u548c ipmitool \u8fdb\u884c\u786c\u4ef6\u76d1\u63a7</li> </ul>"},{"location":"linux/#_5","title":"\u76f8\u5173\u4e3b\u9898\u6587\u7ae0","text":"<ul> <li>Web \u7ba1\u7406\u4e0e\u7cfb\u7edf\u5b89\u5168\u8bbe\u7f6e</li> <li>kuberctl \u4e0e\u5bb9\u5668\u7f16\u6392\u5b9e\u8df5</li> <li>\u786c\u4ef6\u7ea7\u7ba1\u7406\u548c IPMI \u5de5\u5177\u7684\u5e94\u7528</li> </ul> <p>\u2b50 \u6df1\u5165\u638c\u63e1 Linux \u8fd0\u7ef4\u6280\u80fd\uff0c\u4ece\u57fa\u7840\u914d\u7f6e\u5230\u4f01\u4e1a\u7ea7\u5b9e\u8df5\uff0c\u53ef\u53c2\u9605\u4ee5\u4e0a\u5404\u4e2a\u4e13\u9898\u7ae0\u8282</p>"},{"location":"linux/ddrescue/","title":"ddrescue \u6570\u636e\u6062\u590d","text":""},{"location":"linux/ddrescue/#ddrescue","title":"\u5229\u7528 ddrescue \u8fdb\u884c\u78c1\u76d8\u514b\u9686\u548c\u6570\u636e\u6062\u590d","text":"<p>\u6838\u5fc3\u547d\u4ee4</p> <pre><code>sudo ddrescue -d -J -r 3 -b 4096 -c 256k --timeout=300s --force /dev/sdb /dev/sdc mapfile.ddrescue\n</code></pre> <p>-r 3 \u6807\u51c6\u91cd\u8bd5\u6b21\u6570\u63a7\u5236\uff08\u66ff\u6362\u4e0d\u652f\u6301\u7684 --max-retries\uff09 -b 4096 \u5f3a\u5236 4K \u5bf9\u9f50\uff08\u66ff\u4ee3 --sector-size=4096\uff09 -c 1M \u8bbe\u7f6e 1MB \u62f7\u8d1d\u5757\u5927\u5c0f\uff08\u63d0\u5347\u514b\u9686\u6548\u7387\uff09 --timeout=300s \u5355 I/O \u8d85\u65f6 300 \u79d2\uff08\u4ecd\u53ef\u7528\uff09</p> <p>\u9519\u8bef sudo ddrescue -d -J -r 3 -b 4096 -c 1M --timeout=300s --force /dev/sdb /dev/sdc mapfile.ddrescue terminate called after throwing an instance of 'std::bad_alloc' what(): std::bad_alloc</p> <p>\u8fd9\u4e2a <code>std::bad_alloc</code> \u9519\u8bef\u8868\u793a ddrescue \u5728\u5c1d\u8bd5\u5206\u914d\u5185\u5b58\u65f6\u5931\u8d25\u4e86\uff0c\u901a\u5e38\u662f\u7531\u4e8e <code>-c 1M</code> \u53c2\u6570\u8bbe\u7f6e\u7684\u7f13\u51b2\u533a\u8fc7\u5927\u5bfc\u81f4\u7684\u3002</p>"},{"location":"linux/ddrescue/#_1","title":"\u793a\u4f8b","text":"<pre><code>sudo ddrescue -d -J -r 3 -b 4096 -c 256k --timeout=300s --force /dev/sdb /dev/sdc mapfile.ddrescue\nGNU ddrescue 1.27\nPress Ctrl-C to interrupt\n     ipos:    7340 MB, non-trimmed:        0 B,  current rate:    174 MB/s\n     opos:    7340 MB, non-scraped:        0 B,  average rate:    262 MB/s\n     ipos:   19922 MB, non-trimmed:        0 B,  current rate:  95325 kB/s\n     opos:   19922 MB, non-scraped:        0 B,  average rate:  88546 kB/s\n     ipos:   25165 MB, non-trimmed:        0 B,  current rate:    116 MB/s\n     opos:   25165 MB, non-scraped:        0 B,  average rate:  80401 kB/s\n     ipos:  193986 MB, non-trimmed:        0 B,  current rate:    116 MB/s\n     opos:  193986 MB, non-scraped:        0 B,  average rate:  81954 kB/s\n     ipos:  255852 MB, non-trimmed:        0 B,  current rate:       0 B/s\n     opos:  255852 MB, non-scraped:        0 B,  average rate:  90640 kB/s\nnon-tried:        0 B,  bad-sector:        0 B,    error rate:       0 B/s\n  rescued:  256060 MB,   bad areas:        0,        run time:     47m  4s\npct rescued:  100.00%, read errors:        0,  remaining time:         n/a\n                              time since last successful read:          0s\nCopying non-tried blocks... Pass 1 (forwards)\nFinished\n</code></pre>"},{"location":"linux/elfutil/","title":"ELF \u5de5\u5177","text":"<p>strace ptree </p>"},{"location":"linux/ipmitool/","title":"\u8fdc\u7a0b\u7ba1\u7406","text":""},{"location":"linux/ipmitool/#ipmi","title":"IPMI","text":"<p>IPMI\uff0c\u5373\u667a\u80fd\u5e73\u53f0\u7ba1\u7406\u63a5\u53e3\uff08Intelligent Platform Management Interface\uff09\uff0cIPMI\u7684\u6838\u5fc3\u662f\u4e00\u4e2a\u4e13\u7528\u82af\u7247/\u63a7\u5236\u5668(BMC)\uff0c\u72ec\u7acb\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u3001BIOS\u548c\u5904\u7406\u5668\uff0c\u56e0\u6b64\u5c5e\u4e8e\u5e26\u5916\u7ba1\u7406\u8bbe\u5907\u3002\u6b63\u662f\u56e0\u4e3a\u5982\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7BMC\u6765\u63a7\u5236\u6216\u8005\u83b7\u53d6\u7cfb\u7edf\u7684\u5404\u79cd\u4fe1\u606f\uff0c\u800c\u4e0d\u9700\u8981\u5173\u6ce8\u7cfb\u7edf\u662f\u5426\u6b63\u5e38\u3002\u6bd4\u5982\uff0c\u7cfb\u7edf\u5361\u4f4f\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7ipmi reset\u7cfb\u7edf\uff0c\u800c\u4e0d\u9700\u8981\u8dd1\u5230\u673a\u623f\u65ad\u7535\uff1b\u7cfb\u7edf\u65e0\u6cd5\u767b\u5f55\u4e5f\u53ef\u4ee5\u8fdc\u7a0b\u5c4f\u5e55\u67e5\u770b\u662f\u4ec0\u4e48\u95ee\u9898\u3002</p>"},{"location":"linux/ipmitool/#ipmi_1","title":"\u4f7f\u7528ipmi \u914d\u7f6e\u8fdc\u7a0b\u7ba1\u7406","text":"<p>\u8fdc\u7a0b\u7ba1\u7406\u5361\u7684\u57fa\u672c\u4fe1\u606f\u901a\u5e38\u901a\u8fc7BIOS\u8fdb\u884c\u914d\u7f6e</p> <p>\u7f3a\u70b9\uff1a \u9700\u8981\u91cd\u542f\u673a\u5668\u3002\u4e0d\u7075\u6d3b\u3002</p> <p>\u4e0b\u9762\u901a\u8fc7Linux \u7cfb\u7edf\u547d\u4ee4\u884c\u5de5\u5177\u5b9e\u73b0\u5bf9\u7ba1\u7406\u5361\u7684\u914d\u7f6e</p>"},{"location":"linux/ipmitool/#_1","title":"\u5b89\u88c5","text":"<pre><code>yum install OpenIPMI ipmitool\n</code></pre>"},{"location":"linux/ipmitool/#_2","title":"\u7f51\u7edc\u4fe1\u606f\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"linux/ipmitool/#_3","title":"\u67e5\u770b\u73b0\u6709\u7ba1\u7406\u5361\u914d\u7f6e\u4fe1\u606f","text":"<pre><code>ipmitool lan print 1\n</code></pre>"},{"location":"linux/ipmitool/#_4","title":"\u8bbe\u7f6e\u7f51\u7edc\u4fe1\u606f","text":"<pre><code>ipmitool -I open lan set 1 ipsrc static\nipmitool -I open lan set 1 ipaddr x.x.x.x\nipmitool -I open lan set 1 netmask x.x.x.x\nipmitool -I open lan set 1 defgw ipaddr x.x.x.x\nipmitool -I open lan set 1 access on\n</code></pre>"},{"location":"linux/ipmitool/#_5","title":"\u901a\u4fe1\u5b89\u5168\u589e\u5f3a","text":"<pre><code>ipmitool -I open lan set 1 snmp COMUNIATION\n</code></pre>"},{"location":"linux/ipmitool/#_6","title":"\u7528\u6237\u4fe1\u606f\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"linux/ipmitool/#_7","title":"\u67e5\u770b\u73b0\u6709\u7528\u6237\u914d\u7f6e","text":"<pre><code># ipmitool -I open user list 1\nID  Name             Callin  Link Auth  IPMI Msg   Channel Priv Limit\n1                    false   false      true       ADMINISTRATOR\n2   admin            false   false      true       ADMINISTRATOR\n</code></pre>"},{"location":"linux/ipmitool/#2","title":"\u8bbe\u7f6e\u7528\u6237 2 \u5bc6\u7801","text":"<pre><code>ipmitool -I open user set password 2\n</code></pre>"},{"location":"linux/ipmitool/#2_1","title":"\u8bbe\u7f6e\u7528\u6237 2 \u53ef\u7528(\u9ed8\u8ba4\u5373\u53ef\u7528)","text":"<pre><code>ipmitool -I open user enable 2\n</code></pre> <pre><code>ipmitool -I open user list 1\nID  Name             Callin  Link Auth  IPMI Msg   Channel Priv Limit\n1                    true    false      false      Unknown (0x00)\n2   ADMIN            false   false      true       ADMINISTRATOR\n3                    true    false      false      Unknown (0x00)\n4                    true    false      false      Unknown (0x00)\n5                    true    false      false      Unknown (0x00)\n6                    true    false      false      Unknown (0x00)\n7                    true    false      false      Unknown (0x00)\n8                    true    false      false      Unknown (0x00)\n9                    true    false      false      Unknown (0x00)\n10                   true    false      false      Unknown (0x00)\n# ipmitool -I open user enable 2\nipmitool -I open user list 1\nID  Name             Callin  Link Auth  IPMI Msg   Channel Priv Limit\n1                    true    false      false      Unknown (0x00)\n2   ADMIN            false   false      true       ADMINISTRATOR\n3                    true    false      false      Unknown (0x00)\n4                    true    false      false      Unknown (0x00)\n5                    true    false      false      Unknown (0x00)\n6                    true    false      false      Unknown (0x00)\n7                    true    false      false      Unknown (0x00)\n8                    true    false      false      Unknown (0x00)\n9                    true    false      false      Unknown (0x00)\n10                   true    false      false      Unknown (0x00)\n# \u786e\u4fdd\u7528\u62372\u5728\u901a\u90531\uff08\u901a\u5e38\u4e3a\u9ed8\u8ba4\u7ba1\u7406\u901a\u9053\uff09\u62e5\u6709\u8bbf\u95ee\u6743\u9650\uff1a\n# ipmitool -I open channel setaccess 1 2 link=on ipmi=on callin=on privilege=4\nSet User Access (channel 1 id 2) successful.\n# ipmitool -I open user list 1\nID  Name             Callin  Link Auth  IPMI Msg   Channel Priv Limit\n1                    true    false      false      Unknown (0x00)\n2   ADMIN            true    true       true       ADMINISTRATOR\n3                    true    false      false      Unknown (0x00)\n4                    true    false      false      Unknown (0x00)\n5                    true    false      false      Unknown (0x00)\n6                    true    false      false      Unknown (0x00)\n7                    true    false      false      Unknown (0x00)\n8                    true    false      false      Unknown (0x00)\n9                    true    false      false      Unknown (0x00)\n10                   true    false      false      Unknown (0x00)\n</code></pre>"},{"location":"linux/ipmitool/#_8","title":"\u9a8c\u8bc1\u6d4b\u8bd5","text":""},{"location":"linux/ipmitool/#_9","title":"\u83b7\u53d6\u672c\u673a\u72b6\u6001\u4fe1\u606f","text":"<pre><code>ipmitool -H \u7ba1\u7406\u5361IP\u5730\u5740 -U \u7528\u6237\u540d -P \u5bc6\u7801 sensor \n</code></pre>"},{"location":"linux/ipmitool/#_10","title":"\u83b7\u53d6\u8fdc\u7a0b\u673a\u5668\u72b6\u6001\u4fe1\u606f","text":"<pre><code>ipmitool -I lan -H \u8fdc\u7a0b\u673a\u5668\u7ba1\u7406\u5361IP\u5730\u5740 -U \u7528\u6237\u540d -P \u5bc6\u7801 sensor \n</code></pre>"},{"location":"linux/ipmitool/#_11","title":"\u8fdc\u7a0b\u673a\u5668\u7535\u6e90\u7ba1\u7406","text":"<pre><code>ipmitool -I lan -H \u8fdc\u7a0b\u673a\u5668\u7ba1\u7406\u5361IP\u5730\u5740 -U \u7528\u6237\u540d -P \u5bc6\u7801 chassis power off/reset/on/status\n</code></pre> <p>\u5176\u4ed6\u7ba1\u7406\u6269\u5c55</p> <pre><code>#ipmitool chassis status\n\nSystem Power         : on\nPower Overload       : false\nPower Interlock      : inactive\nMain Power Fault     : false\nPower Control Fault  : false\nPower Restore Policy : always-off\nLast Power Event     : ac-failed\nChassis Intrusion    : inactive\nFront-Panel Lockout  : inactive\nDrive Fault          : false\nCooling/Fan Fault    : false\nFront Panel Control  : none\n</code></pre>"},{"location":"linux/ipmitool/#_12","title":"\u547d\u4ee4\u7b80\u5355\u8bf4\u660e","text":"<ul> <li> <p>channel \u6982\u5ff5\u7406\u89e3\uff0c\u6240\u6709\u7684\u914d\u7f6e\u90fd\u5bf9\u5e94\u7740\u76f8\u5e94channel\u3002 </p> </li> <li> <p>-I \u53c2\u6570\uff0c open(\u672c\u673a) lan(\u8fdc\u7aef)</p> </li> </ul>"},{"location":"linux/ipmitool/#_13","title":"\u5e38\u7528\u547d\u4ee4","text":"<pre><code>1. \u67e5\u770b\u673a\u7bb1\u7535\u6e90\u72b6\u6001\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) power status\n2. \u5f00\u673a\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) power on\n3. \u5173\u673a\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) power off\n4. \u91cd\u542f\u673a\u5668\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) power reset\n5. pxe\u5b89\u88c5\u7cfb\u7edf\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) chassis bootdev pxe\n6. \u8fdc\u7a0b\u67e5\u770b\u5c4f\u5e55\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) sol activate\n7. \u5173\u95ed\u5f53\u524d\u8fdc\u7a0b\u67e5\u770b\u5c4f\u5e55\u7684\u4f1a\u8bdd\uff1a\nipmitool -I lanplus -H (IP) -U (\u7528\u6237\u540d) -P (\u5bc6\u7801) sol deactivate\n8. \u67e5\u770b\u673a\u5668\u91cd\u542f\u539f\u56e0\uff1a\nipmitool -I open chassis restart_cause\n\n\n</code></pre>"},{"location":"linux/ipmitool/#bmc","title":"BMC \u91cd\u542f","text":"<pre><code>ipmitool mc reset [warm/cold]\n</code></pre>"},{"location":"linux/ipmitool/#bmc_1","title":"BMC \u6062\u590d\u9ed8\u8ba4\u51fa\u5382\u8bbe\u7f6e","text":"<pre><code>TODO \u5f85\u9a8c\u8bc1\nipmitool raw ** **\n</code></pre>"},{"location":"linux/ipmitool/#_14","title":"\u6269\u5c55\u529f\u80fd \u8bbe\u7f6e\u6765\u7535\u81ea\u542f\u52a8","text":"<p>\u5f53\u53d1\u751f\u610f\u5916\u65ad\u7535\u65f6\uff0c\u5728\u6765\u7535\u540e\u81ea\u542f\u52a8\uff0c\u901a\u5e38\u5728bios\u4e2d\u7535\u6e90\u7ba1\u7406\u9879\u4e2d\u53ef\u914d\u7f6e\u3002\u4f46\u662f\u6bcf\u5929\u673a\u5668\u90fd\u91cd\u542f\u8fdb\u5165bios\u914d\u7f6e\u592a\u9ebb\u70e6\u4e86\u3002</p> <p>\u67e5\u770b\u73b0\u6709\u7b56\u7565</p> <pre><code>#ipmitool  chassis status\nSystem Power         : on\nPower Overload       : false\nPower Interlock      : inactive\nMain Power Fault     : false\nPower Control Fault  : false\nPower Restore Policy : always-on\n</code></pre> <p>\u4fee\u6539\u7b56\u7565</p> <pre><code>\u652f\u6301\u7b56\u7565\u7c7b\u578b\n#ipmitool  chassis policy list\nSupported chassis power policy:  always-off always-on previous\n</code></pre> <pre><code>\u8bbe\u7f6e\u7b56\u7565\n# ipmitool  chassis policy always-on\nSet chassis power restore policy to always-on\n</code></pre>"},{"location":"linux/ipmitool/#_15","title":"\u8fdc\u7a0b\u5c4f\u5e55","text":"<p>Supermicro IPMI</p> <p>\u8fdb\u5165 Remote Control \u2192 Launch Console\u3002 \u4e0b\u8f7d\u5e76\u8fd0\u884c Java KVM Viewer \u6216 HTML5 KVM\uff08\u8f83\u65b0\u56fa\u4ef6\u652f\u6301\uff09\u3002</p>"},{"location":"linux/ipmitool/#_16","title":"\u8865\u5145 \u8fdc\u7a0b\u5c4f\u5e55\u7ba1\u7406","text":"<p>\u5229\u7528\u81ea\u5e26\u7684\u8fdc\u7a0b\u7ba1\u7406\u5361\u529f\u80fd</p> <p>1 \u767b\u9646\u5230\u8fdc\u7a0b\u7ba1\u7406\u5361\u754c\u9762</p> <p>2 Launch \u4e0b\u8f7djveiwer.jnlp \u6587\u4ef6\u5230\u672c\u5730</p> <p>3 \u672c\u5730\u8fd0\u884c</p> <pre><code>javaws --config jviewer.jnlp\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879 \u26a0\ufe0f \uff1a <code>\u8bf7\u4e00\u5b9a\u5b89\u88c5\u4f7f\u7528jdk \u5220\u9664\u672c\u5730openjdk !!! openjdk \u662fjdk \u7684\u9609\u5272\u7248</code></p> <p>\u53ef\u80fd\u9047\u89c1\u95ee\u9898 1</p> <pre><code>cannot grant permissions to unsigned JARs\n</code></pre> <p>\u5f53\u524d\u73af\u5883</p> <ul> <li> <p>Unbutu Desktop</p> </li> <li> <p>jdk 1.8</p> </li> <li> <p>javaws IcedTea</p> </li> </ul> <p>IcedTea \u662fopenjdk \u7684\u4e00\u4e2a\u8865\u5145,\u5c01\u88c5\uff0c\u5305\u542b\u4e86javaws\uff08java Web Start\uff09\u3002 \u4fee\u6539javaws \u7684\u5b89\u5168\u7b56\u7565\u6ca1\u7528</p> <p>\u5220\u9664\u672c\u5730openjdk \u5305\u62ec javaws, openjdk \u662fjdk \u7684\u9609\u5272\u7248\u3002</p> <p>\u539f\u56e0\uff1a java \u5b89\u5168\u914d\u7f6e\u95ee\u9898\uff0cjdk 8 \u540e\u9ed8\u8ba4\u5b89\u5168\u7b49\u7ea7\u53d1\u751f\u53d8\u66f4\uff0c \u89e3\u51b3\u65b9\u6cd5</p> <p>vi ../jre/lib/security/java.security</p> <p>\u5220\u9664 DM5</p> <pre><code>jdk.jar.disabledAlgorithms=MD2,MD5,RSA keySize &lt; 1024\njdk.jar.disabledAlgorithms=MD2,RSA keySize &lt; 1024\n</code></pre> <p>\u53ef\u80fd\u95ee\u9898 2 </p> <p>\u5b89\u5168\u9a8c\u8bc1</p> <pre><code>\u8fd0\u884c jcontrol \u52a0\u5165ip \u767d\u540d\u5355\n</code></pre>"},{"location":"linux/kuberctl/","title":"Kubernetes \u5de5\u5177","text":""},{"location":"linux/kuberctl/#kubernetes-configmap","title":"\u89e3\u51b3 kubernetes \u7f16\u8f91 configmap \u683c\u5f0f\u95ee\u9898","text":""},{"location":"linux/kuberctl/#step-1","title":"Step 1: \u63d0\u53d6\u5e76\u7f16\u8f91\u914d\u7f6e\u6570\u636e","text":"<pre><code>kubectl get cm helmbroker-ch01 -o jsonpath='{.data.00_default_overrides\\.xml}' &gt; overrides.xml\nvim overrides.xml\n</code></pre>"},{"location":"linux/kuberctl/#step-2","title":"Step 2: \u5c06\u6587\u4ef6\u5185\u5bb9\u8f6c\u6362\u4e3a\u5355\u884c\u5b57\u7b26\u4e32","text":"<pre><code>xml_content=$(&lt;overrides.xml)\njson_data=$(jq -n --arg v \"$xml_content\" '{ \"data\": { \"00_default_overrides.xml\": $v } }')\n</code></pre>"},{"location":"linux/kuberctl/#step-3","title":"Step 3: \u5e94\u7528\u8865\u4e01","text":"<pre><code>kubectl patch cm helmbroker-ch01 -p \"$json_data\"\n</code></pre>"},{"location":"linux/kvm01/","title":"kvm","text":""},{"location":"linux/kvm01/#_1","title":"\u5b89\u88c5","text":""},{"location":"linux/kvm01/#ubuntu-2404","title":"ubuntu 24.04","text":"<p>\u5b89\u88c5kvm</p> <pre><code>apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virtinst\n</code></pre> <p>\u914d\u7f6e\u5b9e\u4f53\u673a\u7f51\u7edc</p> <p>cat /etc/network/interfaces</p> <pre><code>auto lo\niface lo inet loopback\nauto br0\niface br0 inet static\naddress 10.0.*.*\nnetmask 255.255.0.0\ngateway 10.1.0.1\ntype bridge\nbridge_ports eth0\ndns-nameservers 114.114.114.114\n</code></pre> <pre><code>network:\n  version: 2\n  renderer: networkd\n  ethernets:\n    enp4s0:\n      dhcp4: no\n  bridges:\n    br0:\n      addresses:\n        - 10.1.40.84/24 \n      routes:\n        - to: default\n          via: 10.1.40.1\n      nameservers:\n        addresses:\n          - 114.114.114.114\n      interfaces:\n        - enp4s0\n</code></pre> <p>.\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u673a</p> <pre><code>virt-install --virt-type kvm --name vm-001 --ram 8192 --vcpus 4 --cdrom=/data/ubuntu-24.04.1-live-server-amd64.iso --disk path=/data/kvm/vm-001.qcow2,size=100,format=qcow2 --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=ubuntu24.04\n</code></pre> <pre><code>virt-viewer --connect qemu+ssh://username@IP/system vm-001\n</code></pre>"},{"location":"linux/kvm01/#centos7","title":"centos7","text":"<p>yum install qemu-kvm libvirt virt-install bridge-utils</p> <p>.\u914d\u7f6e\u5b9e\u4f53\u673a\u7f51\u7edc</p> <p>cat ifcfg-enp7s0</p> <pre><code>DEVICE=\"enp7s0\"\nONBOOT=yes\nBOOTPROTO=static\nUUID=96a09db3-9b06-4a50-8d0c-9868cf531b84\n#HWADDR=\"08:60:6E:06:C7:1A\"\nTYPE=Ethernet\nBRIDGE=br0\nIPADDR=0.0.0.0\n</code></pre> <p>cat ifcfg-br0</p> <pre><code>DEVICE=br0\nONBOOT=yes\nBOOTPROTO=static\nTYPE=Bridge\nIPADDR=10.1.*.*\nPREFIX=16\nGATEWAY=10.1.0.1\nDNS1=223.5.5.5\n</code></pre> <p>\u67e5\u770b brctl show</p> <p>.\u542f\u52a8 libvirt</p> <p>systemctl start libvirtd</p> <p>systemctl enable libvirtd</p> <p>.\u521b\u5efa\u865a\u62df\u673a</p> <pre><code>virt-install --virt-type kvm --name test01 --ram 1024 --vcpus 1 --cdrom=/home/kvm/CentOS-7.0-1406-x86_64-DVD.iso --disk path=/home/kvm/test01.qcow2,size=10,format=qcow2 --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole --os-type=linux --os-variant=rhel7 \n</code></pre> <p>.\u8fde\u63a5\u9053virth</p> <p>virsh --connect qemu:///system .virt-viewer     \u8fde\u63a5\u672c\u673a\u7684\u865a\u62df\u673a:virt-viewer -c qemu:///system \u865a\u62df\u673a\u540d      \u8fde\u63a5\u8fdc\u7a0b\u7684\u865a\u62df\u673a:virt-viewer -c qemu+ssh://ip/system \u865a\u62df\u673a\u540d  </p> <p>\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\u52a8 virsh autostart server01</p>"},{"location":"linux/kvm01/#_2","title":"\u514b\u9686","text":"<pre><code>virt-clone --connect=qemu:///system -o server-02 -n server-clone -f /var/lib/libvirt/images/server-clone.img\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e -o --original \u539f\u59cb\u88ab\u514b\u9686\u955c\u50cf  -n --name \u65b0\u955c\u50cf\u540d\u79f0  -f --file \u955c\u50cf\u6587\u4ef6\u5b58\u653e\u7684\u7269\u7406\u5730\u5740 </p> <p>\u6ce8\u610f\u4e8b\u9879  \u88ab\u514b\u9686\u955c\u50cf\u4e3a\u5173\u95ed\u6216\u505c\u6b62\u72b6\u6001 virsh destroy server-02 </p> <p>\u5176\u4ed6\u8bf4\u660e </p> <p>cat /etc/libvirt/qemu/server-02.xml | grep \"source\"  cat /etc/libvirt/qemu/server-02.xml | grep \"mac\" </p> <p>\u5728 vi /etc/sysconfig/network-scripts/ifcfg-eth0 \u4e2d\u4fee\u6539\u76f8\u5e94\u7684mac </p>"},{"location":"linux/kvm01/#_3","title":"\u4fee\u6539\u78c1\u76d8\u5927\u5c0f","text":"<p>qemu-img resize [-q] filename [+ | -]size </p> <p>1.\u4fee\u6539\u524d\u67e5\u770b </p> <pre><code>qemu-img info test01.qcow2\nimage: test01.qcow2\nfile format: qcow2\nvirtual size: 10G (10737418240 bytes)\ndisk size: 9.0G\ncluster_size: 65536\nFormat specific information:\n    compat: 1.1\n    lazy refcounts: true\n</code></pre> <p>2.\u5173\u95ed\u865a\u62df\u673a</p> <pre><code>virsh shutdown test01\n</code></pre> <p>3.\u4fee\u6539\u78c1\u76d8\u6587\u4ef6\u5927\u5c0f</p> <pre><code>qemu-img resize test01.qcow2 +10G\nImage resized.\n</code></pre> <p>4.\u67e5\u770b \u7ed3\u679c</p> <pre><code>qemu-img info test01.qcow2\nimage: test01.qcow2\nfile format: qcow2\nvirtual size: 20G (21474836480 bytes)\ndisk size: 9.0G\ncluster_size: 65536\nFormat specific information:\n    compat: 1.1\n    lazy refcounts: true\n</code></pre> <p>5.\u91cd\u65b0\u542f\u52a8\u865a\u62df\u673a \u8fdb\u5165\u865a\u62df\u673a\u67e5\u770b virsh start test01</p> <pre><code>fdisk -l\n\n\u78c1\u76d8 /dev/vda\uff1a42.9 GB, 42949672960 \u5b57\u8282\uff0c83886080 \u4e2a\u6247\u533a\nUnits = \u6247\u533a of 1 * 512 = 512 bytes\n\u6247\u533a\u5927\u5c0f(\u903b\u8f91/\u7269\u7406)\uff1a512 \u5b57\u8282 / 512 \u5b57\u8282\nI/O \u5927\u5c0f(\u6700\u5c0f/\u6700\u4f73)\uff1a512 \u5b57\u8282 / 512 \u5b57\u8282\n\u78c1\u76d8\u6807\u7b7e\u7c7b\u578b\uff1ados\n\u78c1\u76d8\u6807\u8bc6\u7b26\uff1a0x000a4b0b\n\n   \u8bbe\u5907 Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048     1026047      512000   83  Linux\n/dev/vda2         1026048     3123199     1048576   82  Linux swap / Solaris\n/dev/vda3         3123200    20971519     8924160   83  Linux\n</code></pre> <p>\u78c1\u76d8\u7a7a\u95f4\u53d8\u5927</p> <p>6.\u6269\u5bb9\u5206\u533a </p> <p>fdisk \u4fee\u6539\u5206\u533a\u8868\uff0c\u5220\u9664\u6700\u540e\u4e00\u4e2a\u5206\u533a\uff0c\u65b0\u5efa\u5206\u533a\uff0c\u4fdd\u6301\u9000\u51fa</p> <pre><code>echo d; echo n; echo ; echo ; echo ; echo ; echo w;) | fdisk $rootdevicepath\n</code></pre> <p>\u91cd\u542f</p> <p>resize2fs $partedpath\u3000\u6269\u78c1\u76d8\u7a7a\u95f4</p>"},{"location":"linux/kvm01/#cup","title":"\u4fee\u6539\u5185\u5b58\u548cCUP","text":"<p>1 \u67e5\u770b virsh dominfo test01  </p> <p>2 \u6539\u5185\u5b58 virsh setmem [domain-id or domain-name] [count]  </p> <p>3 \u6539CUP virsh setvcpus test01 2 </p> <p>\u539f\u6587 </p>"},{"location":"linux/kvm01/#_4","title":"\u7ba1\u7406\u754c\u9762","text":"<p>webvirtcloud</p>"},{"location":"linux/patch/","title":"\u8865\u4e01\u7ba1\u7406","text":"<p>diff -Naur dir1/ dir2/ &gt; dir_patch.patch patch -p1 -d dir1/ &lt; dir_patch.patch</p>"},{"location":"linux/smartctl/","title":"\u5229\u7528 smartctl + prometheus \u76d1\u63a7\u786c\u76d8\u5065\u5eb7\u72b6\u6001","text":""},{"location":"linux/smartctl/#exporter","title":"\u5b89\u88c5 exporter","text":""},{"location":"linux/smartctl/#_1","title":"\u4f9d\u8d56","text":"<pre><code>smartmontools &gt;= 7.0\n</code></pre>"},{"location":"linux/smartctl/#_2","title":"\u5b89\u88c5\u5305","text":"<p>\u6839\u636e\u81ea\u8eab\u7cfb\u7edf\u4e0b\u8f7d\u76f8\u5e94\u7684\u8f6f\u4ef6\u5305</p> <pre><code>wget https://github.com/prometheus-community/smartctl_exporter/releases/download/v0.14.0/smartctl_exporter-0.14.0.linux-amd64.tar.gz\n</code></pre> <p>\u89e3\u538b\u53ef\u8fd0\u884c\u6587\u4ef6\u5230 <code>/usr/local/bin/</code></p> <p>\u521b\u5efa\u670d\u52a1</p> <pre><code>sudo tee /etc/systemd/system/smartctl_exporter.service &gt; /dev/null &lt;&lt;EOF\n[Unit]\nDescription=Prometheus Smartctl Exporter\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nExecStart=/usr/local/bin/smartctl_exporter \\\n --smartctl.interval=60s \\\n --smartctl.rescan=10m \\\n --web.listen-address=:9633 \\\n --log.level=info\nRestart=on-failure\nRestartSec=5s\nTimeoutStopSec=10s\nEnvironment=\"SMARTCTL_EXPORTER_ENABLE_INTERVAL=15s\"\nStandardOutput=syslog\nStandardError=syslog\nSyslogIdentifier=smartctl_exporter\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>"},{"location":"linux/smartctl/#_3","title":"\u542f\u52a8\u670d\u52a1","text":"<pre><code>sudo systemctl daemon-reload\nsudo systemctl enable smartctl_exporter\nsudo systemctl start smartctl_exporter\n</code></pre>"},{"location":"linux/smartctl/#_4","title":"\u9a8c\u8bc1\u670d\u52a1\u72b6\u6001","text":"<pre><code>sudo systemctl status smartctl_exporter\n</code></pre>"},{"location":"linux/smartctl/#prometheus","title":"\u914d\u7f6e Prometheus","text":"<pre><code>- job_name: \"smartctl_exporter\"\n  static_configs:\n    - targets: [\"localhost:9633\"]\n</code></pre> <p>\u5c06\u4e0a\u8ff0\u914d\u7f6e\u6dfb\u52a0\u5230 Prometheus \u7684\u914d\u7f6e\u6587\u4ef6 <code>prometheus.yml</code> \u4e2d\uff0c\u7136\u540e\u91cd\u542f Prometheus \u670d\u52a1\u4ee5\u5e94\u7528\u66f4\u6539\u3002</p>"},{"location":"linux/smartctl/#_5","title":"\u91cd\u70b9\u6307\u6807","text":""},{"location":"linux/smartctl/#prometheusgrafana","title":"\ud83d\udea8 \u786c\u76d8\u5065\u5eb7\u76d1\u63a7\u5173\u952e\u6307\u6807\uff08Prometheus/Grafana \u544a\u8b66\u89c4\u5219\uff09","text":"\u89c4\u5219\u7c7b\u578b \u89c4\u5219\u8868\u8fbe\u5f0f \u76d1\u63a7\u5bf9\u8c61 \u9608\u503c\u8bbe\u5b9a \u7269\u7406\u542b\u4e49 \u98ce\u9669\u7b49\u7ea7 \u76d1\u63a7\u5efa\u8bae \u574f\u9053\u68c0\u6d4b <code>smartctl_device_attribute{attribute_id=\"5\", attribute_value_type=\"raw\"} &gt; 0</code> \u91cd\u5206\u914d\u6247\u533a\u8ba1\u6570(Reallocated_Sector_Ct) &gt;0 \u89e6\u53d1\u544a\u8b66 \u6bcf\u589e\u52a0 1=1 \u4e2a\u7269\u7406\u574f\u6247\u533a\u88ab\u66ff\u6362\u673a\u68b0\u76d8\u81f4\u547d\u9690\u60a3 \u26a0\ufe0f\u26a0\ufe0f\u26a0\ufe0f \u81f4\u547d \u7acb\u5373\u66f4\u6362\u786c\u76d8\u5373\u4f7f 1 \u4e5f\u9700\u91cd\u70b9\u5173\u6ce8 SSD \u5bff\u547d <code>smartctl_device_attribute{attribute_id=\"173\", attribute_value_type=\"value\"} &lt; 80</code> \u78e8\u635f\u5e73\u8861\u5065\u5eb7\u5ea6(\u5382\u5546\u81ea\u5b9a\u4e49, SSD \u5e38\u89c1) &lt;80 \u89e6\u53d1\u544a\u8b66 \u503c\u4e0b\u964d\u901f\u5ea6\u53cd\u6620 SSD \u78e8\u635f\uff1a- 80\u2248 \u5269\u4f59 20%\u5bff\u547d- \u9700\u7ed3\u5408\u5907\u7528\u5757\u6570\u7efc\u5408\u5224\u65ad \u26a0\ufe0f\u26a0\ufe0f \u9ad8\u5371 \u4f01\u4e1a\u76d8: &lt;70 \u6362\u76d8\u6d88\u8d39\u76d8: &lt;50 \u6362\u76d8 SSD \u5bff\u547d <code>smartctl_device_attribute{attribute_id=\"233\", attribute_value_type=\"value\"} &lt; 50</code> \u5269\u4f59\u5bff\u547d\u767e\u5206\u6bd4(Media_Wearout_Indicator) &lt;50 \u89e6\u53d1\u544a\u8b66 \u4f01\u4e1a\u7ea7 SSD: \u76f4\u63a5\u663e\u793a\u767e\u5206\u6bd4\u5bff\u547d0 \u65f6\u5199\u5165\u9501\u5b9a\u98ce\u9669 \u26a0\ufe0f \u4e2d\u5371 \u8fdb\u5165 50 \u533a\u95f4\u5373\u5907\u76d8 \u8001\u5316\u98ce\u9669 <code>smartctl_device_attribute{attribute_id=\"9\", attribute_value_type=\"raw\"} / (24 * 365) &gt; 5</code> \u901a\u7535\u65f6\u95f4(Power_On_Hours) &gt;5 \u5e74 \u89e6\u53d1\u544a\u8b66 \u673a\u68b0\u76d8:- 5 \u5e74\u6545\u969c\u7387\u9661\u589e- \u8f74\u627f/\u7535\u673a\u8001\u5316SSD: \u7535\u5b50\u5143\u4ef6\u5bff\u547d\u8870\u51cf \u26a0\ufe0f\u26a0\ufe0f \u9ad8\u5371 \u751f\u4ea7\u73af\u5883: &gt;4 \u5e74\u5373\u6807\u8bb0\u4e3a\u9ad8\u5371\u5efa\u8bae\u5faa\u73af\u4f7f\u7528\u5e74\u9650\uff1a- \u4f01\u4e1a\u76d8: 5 \u5e74- \u6d88\u8d39\u76d8: 3 \u5e74 \u7269\u7406\u51b2\u51fb <code>smartctl_device_attribute{attribute_id=\"12\", attribute_value_type=\"raw\"} &gt; 100</code> \u542f\u505c\u6b21\u6570(Power_Cycle_Count) &gt;100 \u89e6\u53d1\u8b66\u544a \u9891\u7e41\u542f\u505c\u52a0\u901f\u78c1\u5934\u78e8\u635f\u7279\u522b\u8b66\u60d5\uff1a- \u5355\u65e5&gt;3 \u6b21\u5f02\u5e38\u91cd\u542f- \u4e0e\u6e29\u5ea6\u9aa4\u53d8\u5173\u8054 \u26a0\ufe0f \u4e2d\u4f4e\u5371 \u7ed3\u5408<code>ID 190</code>(\u6e29\u5ea6)\u76d1\u63a7\u7a81\u53d1\u589e\u9ad8\u9700\u6392\u67e5\u4f9b\u7535/\u632f\u52a8\u95ee\u9898 \u6570\u636e\u5b8c\u6574\u6027 <code>smartctl_device_attribute{attribute_id=\"187\", attribute_value_type=\"raw\"} &gt; 0</code> \u4e0d\u53ef\u7ea0\u6b63\u9519\u8bef(Reported_Uncorrect) &gt;0 \u89e6\u53d1\u544a\u8b66 \u6570\u636e\u5b8c\u6574\u6027\u98ce\u9669\u7269\u7406\u635f\u574f\u6216\u4f20\u8f93\u9519\u8bef \u26a0\ufe0f\u26a0\ufe0f\u26a0\ufe0f \u81f4\u547d \u51fa\u73b0\u5373\u7acb\u5373\u68c0\u67e5\u6587\u4ef6\u7cfb\u7edf \u6e29\u5ea6\u76d1\u63a7 <code>smartctl_device_attribute{attribute_id=\"194\", attribute_value_type=\"value\"} &gt; 55</code> \u5de5\u4f5c\u6e29\u5ea6(Temperature_Celsius) &gt;55\u2103 \u89e6\u53d1\u544a\u8b66 \u5173\u952e\u534f\u540c\u6307\u6807\uff1a- \u9ad8\u6e29\u52a0\u901f\u8001\u5316- SSD&gt;60\u2103 \u6027\u80fd\u964d\u7ea7- \u673a\u68b0\u76d8&gt;70\u2103 \u78c1\u5934\u6545\u969c\u98ce\u9669 \u26a0\ufe0f \u4e2d\u5371 \u544a\u8b66\u9608\u503c\u5efa\u8bae\uff1a- HDD: 50\u2103- SSD: 60\u2103 \u6570\u636e\u4f20\u8f93\u5f02\u5e38 <code>smartctl_device_attribute{attribute_id=\"184\", attribute_value_type=\"value\"} &gt; 0</code> \u6570\u636e\u4f20\u8f93\u5f02\u5e38(End-to-End_Error) &gt;0 \u89e6\u53d1\u544a\u8b66 \u5173\u952e\u534f\u540c\u6307\u6807\uff1a- \u4f20\u8f93\u9519\u8bef \u26a0\ufe0f \u4e2d\u5371 \u51fa\u73b0\u5373\u7acb\u5373\u68c0\u67e5\u6587\u4ef6\u7cfb\u7edf\uff0c\u6570\u636e\u5b58\u5728\u4e22\u5931\u98ce\u9669"},{"location":"linux/smartctl/#prom","title":"\u5728 Prom \u4e2d\u67e5\u8be2\uff0c\u5e26\u786c\u76d8\u5e8f\u5217\u53f7","text":"<pre><code>(smartctl_device_attribute{attribute_id=\"5\",attribute_value_type=\"raw\"} *\non(instance,device) group_left(serial_number,model_name,job) smartctl_device) &gt; 0\n</code></pre> <pre><code>(smartctl_device_attribute{attribute_id=\"173\",attribute_value_type=\"value\"} *\non(instance,device) group_left(serial_number,model_name,job) smartctl_device) &lt; 80\n</code></pre> <pre><code>(smartctl_device_attribute{attribute_id=\"233\",attribute_value_type=\"value\"} *\non(instance,device) group_left(serial_number,model_name,job) smartctl_device) &lt; 80\n</code></pre> <pre><code>(smartctl_device_attribute{attribute_id=\"184\",attribute_value_type=\"raw\"} *\non(instance,device) group_left(serial_number,model_name,job) smartctl_device) &gt; 0\n</code></pre>"},{"location":"linux/smartctl/#smartctl","title":"smartctl \u547d\u4ee4\u67e5\u770b","text":"<pre><code>smartctl -A /dev/sda | awk '$1 ~ /^(5|9|173|233|9|187|ID)/ {print}'\n</code></pre> <ul> <li>Pre-fail \u8868\u793a\u6f5c\u5728\u6545\u969c\u98ce\u9669</li> <li>Old_age \u8868\u793a\u6b63\u5e38\u8001\u5316\u6307\u6807</li> </ul>"},{"location":"linux/smartctl/#_6","title":"\u544a\u8b66\u4fe1\u606f","text":"<pre><code>groups:\n- name: smartctl_disk_failure_alert\n  rules:\n\n  # 1. \u574f\u9053\u68c0\u6d4b - \u91cd\u5206\u914d\u6247\u533a\u8ba1\u6570\n  - alert: HDD_Reallocated_Sectors_Critical\n    expr: smartctl_device_attribute{attribute_id=\"5\", attribute_value_type=\"raw\"} &gt; 0\n    for: 5m\n    labels:\n      severity: critical\n      category: storage\n    annotations:\n      summary: \"\u786c\u76d8\u7269\u7406\u574f\u9053\u544a\u8b66 (ID 5)\"\n      description: \"{{ $labels.instance }} \u7684\u786c\u76d8 {{ $labels.device }} \u68c0\u6d4b\u5230\u7269\u7406\u574f\u6247\u533a!\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u5f53\u524d\u503c: {{ $value }} (\u5927\u4e8e0\u8868\u793a\u5df2\u89e6\u53d1\u5907\u7528\u6247\u533a\u66ff\u6362)\\n\u5904\u7406\u5efa\u8bae: \u7acb\u5373\u5907\u4efd\u6570\u636e\u5e76\u66f4\u6362\u786c\u76d8\"\n\n  # 2. SSD\u5065\u5eb7\u5ea6 (\u78e8\u635f\u5e73\u8861)\n  - alert: SSD_Wear_Leveling_Warning\n    expr: smartctl_device_attribute{attribute_id=\"173\", attribute_value_type=\"value\"} &lt; 80\n    for: 30m\n    labels:\n      severity: warning\n      category: storage\n    annotations:\n      summary: \"SSD\u78e8\u635f\u5065\u5eb7\u5ea6\u4e0b\u964d (ID 173)\"\n      description: \"{{ $labels.instance }} \u7684SSD {{ $labels.device }} \u5bff\u547d\u4f4e\u4e8e80%\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u5f53\u524d\u503c: {{ $value }}\\n\u5904\u7406\u5efa\u8bae: \u68c0\u67e5\u5907\u7528\u5757\u8ba1\u6570\uff0c\u51c6\u5907\u66f4\u6362\u786c\u76d8\"\n\n  # 3. SSD\u5269\u4f59\u5bff\u547d\n  - alert: SSD_Remaining_Life_Warning\n    expr: smartctl_device_attribute{attribute_id=\"233\", attribute_value_type=\"value\"} &lt; 50\n    for: 15m\n    labels:\n      severity: warning\n      category: storage\n    annotations:\n      summary: \"SSD\u5269\u4f59\u5bff\u547d\u4e0d\u8db3 (ID 233)\"\n      description: \"{{ $labels.instance }} \u7684SSD {{ $labels.device }} \u5269\u4f59\u5bff\u547d\u4f4e\u4e8e50%\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u5f53\u524d\u503c: {{ $value }}%\\n\u5904\u7406\u5efa\u8bae: \u4f01\u4e1a\u7ea7SSD\u5e94\u7acb\u5373\u66f4\u6362\uff0c\u6d88\u8d39\u7ea7\u5efa\u8bae\u66f4\u6362\"\n\n  # 4. \u8001\u5316\u98ce\u9669\u68c0\u6d4b (\u4fee\u590d\u6a21\u677f\u8bed\u6cd5)\n  - alert: Disk_Aging_Risk\n    expr: smartctl_device_attribute{attribute_id=\"9\", attribute_value_type=\"raw\"} / (24 * 365) &gt; 4\n    for: 1h\n    labels:\n      severity: warning\n      category: storage\n    annotations:\n      summary: \"\u786c\u76d8\u8001\u5316\u98ce\u9669 (ID 9)\"\n      description: \"{{ $labels.instance }} \u7684\u786c\u76d8\u5df2\u8fde\u7eed\u5de5\u4f5c\u8d85\u8fc74\u5e74!\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u5f53\u524d\u901a\u7535\u5c0f\u65f6\u6570: {{ $value | humanizeDuration | printf \\\"%.0f\\\" }}\\n\u5904\u7406\u5efa\u8bae: \u6807\u8bb0\u4e3a\u9ad8\u5371\u8bbe\u5907\uff0c\u4f18\u5148\u8003\u8651\u66ff\u6362\"\n\n  # 5. \u7269\u7406\u51b2\u51fb\u8b66\u544a (\u79fb\u9664\u65e0\u6548\u51fd\u6570)\n  - alert: Disk_Physical_Shock\n    expr: smartctl_device_attribute{attribute_id=\"12\", attribute_value_type=\"raw\"} &gt; 100\n    for: 10m\n    labels:\n      severity: warning\n      category: storage\n    annotations:\n      summary: \"\u5f02\u5e38\u7269\u7406\u51b2\u51fb (ID 12)\"\n      description: \"{{ $labels.instance }} \u7684\u786c\u76d8 {{ $labels.device }} \u68c0\u6d4b\u5230\u5f02\u5e38\u542f\u505c!\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u603b\u542f\u505c\u6b21\u6570: {{ $value }}\\n\u5904\u7406\u5efa\u8bae: \u68c0\u67e5\u7535\u6e90\u7a33\u5b9a\u6027\u548c\u7269\u7406\u632f\u52a8\u6e90\"\n\n  # 6. \u6570\u636e\u5b8c\u6574\u6027\u98ce\u9669\n  - alert: Data_Integrity_Failure\n    expr: smartctl_device_attribute{attribute_id=\"187\", attribute_value_type=\"raw\"} &gt; 0\n    for: 2m\n    labels:\n      severity: critical\n      category: storage\n    annotations:\n      summary: \"\u4e0d\u53ef\u7ea0\u6b63\u6570\u636e\u9519\u8bef (ID 187)\"\n      description: \"{{ $labels.instance }} \u7684\u786c\u76d8 {{ $labels.device }} \u68c0\u6d4b\u5230\u6570\u636e\u5b8c\u6574\u6027\u635f\u574f!\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u9519\u8bef\u8ba1\u6570: {{ $value }}\\n\u5904\u7406\u5efa\u8bae: \u7acb\u5373\u8fd0\u884c\u6587\u4ef6\u7cfb\u7edf\u68c0\u67e5\uff0c\u8003\u8651\u66f4\u6362\u786c\u76d8\"\n\n  # 7. \u6e29\u5ea6\u8fc7\u9ad8\u544a\u8b66 (\u4fee\u590d\u6b63\u5219\u8bed\u6cd5)\n  - alert: Disk_Overtemperature\n    expr: &gt;-\n      (smartctl_device_attribute{attribute_id=\"194\", attribute_value_type=\"value\"} &gt; 55 and\n       smartctl_device_attribute{attribute_id=\"194\", model_name=~\".*HDD.*\"})\n      or\n      (smartctl_device_attribute{attribute_id=\"194\", attribute_value_type=\"value\"} &gt; 60 and\n       smartctl_device_attribute{attribute_id=\"194\", model_name=~\".*SSD.*\"})\n    for: 10m\n    labels:\n      severity: warning\n      category: storage\n    annotations:\n      summary: \"\u786c\u76d8\u6e29\u5ea6\u5f02\u5e38 (ID 194)\"\n      description: \"{{ $labels.instance }} \u7684\u786c\u76d8 {{ $labels.device }} \u6e29\u5ea6\u8fc7\u9ad8!\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u5f53\u524d\u6e29\u5ea6: {{ $value }}\u00b0C\\n\u5904\u7406\u5efa\u8bae: \u68c0\u67e5\u6563\u70ed\u7cfb\u7edf\uff0c\u6539\u5584\u673a\u67dc\u901a\u98ce\"\n\n  # 8. \u6570\u636e\u4f20\u8f93\u5f02\u5e38\n  - alert: Data_Transfer_Error\n    expr: smartctl_device_attribute{attribute_id=\"184\", attribute_value_type=\"raw\"} &gt; 0\n    for: 5m\n    labels:\n      severity: critical\n      category: storage\n    annotations:\n      summary: \"\u7aef\u5230\u7aef\u6570\u636e\u6821\u9a8c\u5931\u8d25 (ID 184)\"\n      description: \"{{ $labels.instance }} \u7684\u786c\u76d8 {{ $labels.device }} \u6570\u636e\u4f20\u8f93\u5b8c\u6574\u6027\u9519\u8bef!\\n\u5e8f\u5217\u53f7: {{ $labels.serial_number }}\\n\u578b\u53f7: {{ $labels.model_name }}\\n\u9519\u8bef\u8ba1\u6570: {{ $value }}\\n\u5904\u7406\u5efa\u8bae: \u68c0\u67e5\u6570\u636e\u7ebf/\u80cc\u677f\u8fde\u63a5\uff0c\u66f4\u6362SATA\u7ebf\u7f06\"\n</code></pre>"},{"location":"linux/tools/","title":"\u7cfb\u7edf\u5de5\u5177","text":"<p>Webmin \u662f\u4e00\u4e2a\u57fa\u4e8eWeb\u7684\u7cfb\u7edf\u914d\u7f6e\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u7528\u6765\u7ba1\u7406Unix\u7cfb\u7edf  http://www.webmin.com/</p> <p>Filebrowser \u63d0\u4f9b\u4e86\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u6587\u4ef6\u7ba1\u7406\u5668\uff0c\u53ef\u901a\u8fc7Web\u8bbf\u95ee\u3002\u5b83\u5141\u8bb8\u4f60\u6d4f\u89c8\u3001\u7f16\u8f91\u3001\u4e0a\u4f20\u3001\u4e0b\u8f7d\u548c\u5220\u9664\u670d\u52a1\u5668\u4e0a\u7684\u6587\u4ef6</p> <p>https://filebrowser.org/</p> <p>pv -p -a -L1k \u548c cat \u7c7b\u4f3c\u3002 \u4f46\u662f\u53ef\u9650\u901f\uff0c\u5e94\u7528\u573a\u666f\u3002\u6570\u636e\u5bfc\u5165</p>"},{"location":"linux/webmanage/","title":"Web \u5b89\u5168\u7ba1\u7406","text":"<p>https://github.com/cockpit-project/cockpit</p>"},{"location":"middleware/","title":"\ud83e\udde9 \u4e2d\u95f4\u4ef6\u4e13\u4e1a\u6587\u6863\u4e2d\u5fc3","text":"\u73b0\u4ee3\u8f6f\u4ef6\u67b6\u6784\u7684\u6838\u5fc3\u652f\u6491\u4f53\u7cfb <p>\u9ad8\u53ef\u7528 \u2022 \u9ad8\u6027\u80fd \u2022 \u5206\u5e03\u5f0f \u2022 \u6613\u6269\u5c55</p>"},{"location":"middleware/#_2","title":"\ud83d\udcda \u5feb\u901f\u5bfc\u822a","text":"\ud83d\udd11 etcd <p>\u9ad8\u53ef\u7528\u7684\u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\u7cfb\u7edf\uff0c\u7528\u4e8e\u5171\u4eab\u914d\u7f6e\u548c\u670d\u52a1\u53d1\u73b0\u3002</p> \u8be6\u60c5 \u26a1 ClickHouse <p>\u9762\u5411\u8054\u673a\u5206\u6790\u5904\u7406(OLAP)\u7684\u5217\u5f0f\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u3002</p> \u8be6\u60c5 \ud83c\udf43 MongoDB <p>\u57fa\u4e8e\u5206\u5e03\u5f0f\u6587\u4ef6\u5b58\u50a8\u7684\u5f00\u6e90\u6587\u6863\u6570\u636e\u5e93\uff0c\u652f\u6301\u7075\u6d3b\u7684\u6570\u636e\u6a21\u578b\u3002</p> \u8be6\u60c5 \ud83d\udcca \u76d1\u63a7\u7cfb\u7edf <p>Prometheus\u3001Grafana \u7b49\u76d1\u63a7\u4e0e\u53ef\u89c6\u5316\u5de5\u5177\u96c6\u3002</p> \u8be6\u60c5 \ud83d\udd04 fluentbit <p>\u8f7b\u91cf\u7ea7\u7684\u65e5\u5fd7\u5904\u7406\u5668\u548c\u8f6c\u53d1\u5668\uff0c\u7528\u4e8e\u7edf\u4e00\u65e5\u5fd7\u5904\u7406\u94fe\u8def\u3002</p> \u8be6\u60c5"},{"location":"middleware/#_3","title":"\u4e2d\u95f4\u4ef6\u7b80\u4ecb","text":"<p>\u4e2d\u95f4\u4ef6\u662f\u4f4d\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u7684\u8f6f\u4ef6\u5c42\uff0c\u5b83\u63d0\u4f9b\u901a\u7528\u670d\u52a1\u548c\u529f\u80fd\uff0c\u4f7f\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u4e13\u6ce8\u4e8e\u5176\u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\u3002\u4e2d\u95f4\u4ef6\u5728\u73b0\u4ee3\u8f6f\u4ef6\u67b6\u6784\u4e2d\u53d1\u6325\u7740\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528\uff0c\u5b83\u80fd\u591f\u7b80\u5316\u5f00\u53d1\u8fc7\u7a0b\u3001\u589e\u5f3a\u7cfb\u7edf\u7684\u53ef\u4f38\u7f29\u6027\u3001\u53ef\u9760\u6027\u548c\u4e92\u64cd\u4f5c\u6027\u3002</p>"},{"location":"middleware/#_4","title":"\u6838\u5fc3\u4ef7\u503c","text":"<ul> <li>\u670d\u52a1\u89e3\u8026\uff1a\u964d\u4f4e\u5e94\u7528\u95f4\u7684\u8026\u5408\u5ea6\uff0c\u63d0\u9ad8\u7075\u6d3b\u6027</li> <li>\u8d44\u6e90\u5171\u4eab\uff1a\u63d0\u4f9b\u901a\u7528\u529f\u80fd\u7684\u96c6\u4e2d\u7ba1\u7406</li> <li>\u901a\u4fe1\u534f\u8c03\uff1a\u7ba1\u7406\u5206\u5e03\u5f0f\u73af\u5883\u4e2d\u7684\u6570\u636e\u6d41</li> <li>\u4e8b\u52a1\u5904\u7406\uff1a\u4fdd\u8bc1\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u6570\u636e\u4e00\u81f4\u6027</li> <li>\u8d1f\u8f7d\u5747\u8861\uff1a\u5408\u7406\u5206\u914d\u8ba1\u7b97\u8d44\u6e90</li> <li>\u5b89\u5168\u670d\u52a1\uff1a\u63d0\u4f9b\u7edf\u4e00\u7684\u5b89\u5168\u673a\u5236</li> </ul>"},{"location":"middleware/#_5","title":"\u4f01\u4e1a\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u2705 \u5206\u5e03\u5f0f\u7cfb\u7edf\u7ba1\u7406</li> <li>\u2705 \u5fae\u670d\u52a1\u67b6\u6784\u96c6\u6210</li> <li>\u2705 \u6570\u636e\u540c\u6b65\u4e0e\u5904\u7406</li> <li>\u2705 \u65e5\u5fd7\u805a\u5408\u5206\u6790</li> <li>\u2705 \u5e94\u7528\u6027\u80fd\u76d1\u63a7</li> <li>\u2705 \u5b9e\u65f6\u6570\u636e\u5206\u6790</li> </ul>"},{"location":"middleware/#_6","title":"\u6280\u672f\u6808\u6982\u89c8","text":"\u7c7b\u522b \u5de5\u5177/\u6280\u672f \u7279\u70b9 \u9002\u7528\u573a\u666f \u6ce8\u518c\u53d1\u73b0 etcd \u9ad8\u53ef\u7528\u3001\u5f3a\u4e00\u81f4\u6027 \u670d\u52a1\u6ce8\u518c\u3001\u914d\u7f6e\u5171\u4eab \u6570\u636e\u5206\u6790 ClickHouse \u5217\u5f0f\u5b58\u50a8\u3001\u5b9e\u65f6\u67e5\u8be2 OLAP \u573a\u666f\u3001\u65e5\u5fd7\u5206\u6790 \u6587\u6863\u5b58\u50a8 MongoDB \u52a8\u6001 Schema\u3001\u9ad8\u53ef\u7528 \u975e\u7ed3\u6784\u5316\u6570\u636e\u5b58\u50a8 \u6570\u636e\u91c7\u96c6 fluentbit \u8f7b\u91cf\u7ea7\u3001\u9ad8\u5e76\u53d1 \u65e5\u5fd7\u6536\u96c6\u4e0e\u8f6c\u53d1 \u7cfb\u7edf\u76d1\u63a7 Prometheus \u65f6\u5e8f\u6570\u636e\u3001\u67e5\u8be2\u8bed\u8a00 \u7cfb\u7edf\u4e0e\u5e94\u7528\u6307\u6807\u76d1\u63a7"},{"location":"middleware/#_7","title":"\u4e2d\u95f4\u4ef6\u67b6\u6784\u6a21\u5f0f","text":""},{"location":"middleware/#_8","title":"\u5206\u5e03\u5f0f\u534f\u8c03","text":"<p>\u4f7f\u7528 etcd \u8fdb\u884c\u670d\u52a1\u53d1\u73b0\u4e0e\u914d\u7f6e\u7ba1\u7406\uff0c\u4fdd\u8bc1\u5206\u5e03\u5f0f\u73af\u5883\u4e2d\u591a\u4e2a\u670d\u52a1\u5b9e\u4f8b\u95f4\u7684\u6570\u636e\u4e00\u81f4\u6027\u3002</p>"},{"location":"middleware/#_9","title":"\u6570\u636e\u6d41\u6c34\u7ebf","text":"<p>\u901a\u8fc7 fluentbit \u7b49\u7ec4\u4ef6\u6784\u5efa\u9ad8\u6548\u7684\u65e5\u5fd7\u6536\u96c6\u4e0e\u5904\u7406\u7ba1\u9053\uff0c\u6ee1\u8db3\u5927\u89c4\u6a21\u7cfb\u7edf\u7684\u6570\u636e\u91c7\u96c6\u9700\u6c42\u3002</p>"},{"location":"middleware/#_10","title":"\u5fae\u670d\u52a1\u6cbb\u7406","text":"<p>\u501f\u52a9\u76d1\u63a7\u7cfb\u7edf\u5982 Prometheus \u548c Grafana\uff0c\u5b9e\u73b0\u670d\u52a1\u72b6\u6001\u53ef\u89c6\u5316\u3001\u6027\u80fd\u74f6\u9888\u5206\u6790\u7b49\u529f\u80fd\u3002</p>"},{"location":"middleware/#_11","title":"\u90e8\u7f72\u6a21\u5f0f","text":""},{"location":"middleware/#_12","title":"\u5355\u673a\u90e8\u7f72","text":"<ul> <li>\u7279\u70b9\uff1a\u5b89\u88c5\u4fbf\u6377\uff0c\u9002\u5408\u5f00\u53d1\u6d4b\u8bd5\u73af\u5883</li> <li>\u573a\u666f\uff1a\u5c0f\u578b\u5e94\u7528\u3001\u6982\u5ff5\u9a8c\u8bc1</li> <li>\u63a8\u8350\uff1a\u5355\u70b9 MongoDB\u3001\u5355\u8282\u70b9 ClickHouse</li> </ul>"},{"location":"middleware/#_13","title":"\u96c6\u7fa4\u90e8\u7f72","text":"<ul> <li>\u7279\u70b9\uff1a\u9ad8\u53ef\u7528\uff0c\u9ad8\u6027\u80fd\uff0c\u652f\u6301\u6c34\u5e73\u6269\u5c55</li> <li>\u573a\u666f\uff1a\u751f\u4ea7\u73af\u5883\u3001\u5927\u6570\u636e\u5904\u7406</li> <li>\u63a8\u8350\uff1aMongoDB \u5206\u7247\u96c6\u7fa4\u3001ClickHouse \u5206\u5e03\u5f0f\u96c6\u7fa4</li> </ul>"},{"location":"middleware/#_14","title":"\u4e91\u539f\u751f\u90e8\u7f72","text":"<ul> <li>\u7279\u70b9\uff1a\u52a8\u6001\u4f38\u7f29\u3001\u5f39\u6027\u6269\u5bb9</li> <li>\u573a\u666f\uff1a\u5bb9\u5668\u5316\u73af\u5883\u3001Kubernetes \u5e73\u53f0</li> <li>\u63a8\u8350\uff1aStatefulSet \u65b9\u5f0f\u90e8\u7f72\u6709\u72b6\u6001\u670d\u52a1</li> </ul>"},{"location":"middleware/#_15","title":"\u9009\u578b\u6307\u5357","text":""},{"location":"middleware/#_16","title":"\u6570\u636e\u5b58\u50a8\u578b\u4e2d\u95f4\u4ef6","text":"<p>\u6839\u636e\u4e0d\u540c\u7684\u4e1a\u52a1\u573a\u666f\u9700\u6c42\uff0c\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u65b9\u9762\uff1a</p> <ol> <li>\u6570\u636e\u6a21\u578b\u5339\u914d\u6027\uff1a\u6839\u636e\u5e94\u7528\u6570\u636e\u7ed3\u6784\u7279\u5f81\u9009\u62e9\u5408\u9002\u7684\u6570\u636e\u6a21\u578b</li> <li>\u6027\u80fd\u8981\u6c42\uff1a\u8bfb\u5199\u9891\u7387\u3001\u54cd\u5e94\u65f6\u95f4\u3001\u541e\u5410\u91cf\u8981\u6c42</li> <li>\u4e00\u81f4\u6027\u9700\u6c42\uff1a\u662f\u5426\u8981\u6c42\u5f3a\u4e00\u81f4\u6027</li> <li>\u53ef\u6269\u5c55\u6027\uff1a\u6570\u636e\u589e\u957f\u9884\u671f\u548c\u5bb9\u91cf\u89c4\u5212</li> </ol>"},{"location":"middleware/#_17","title":"\u5206\u6790\u5904\u7406\u578b\u4e2d\u95f4\u4ef6","text":"<p>\u9488\u5bf9\u4e0d\u540c\u5206\u6790\u573a\u666f\uff1a</p> <ol> <li>\u5b9e\u65f6\u5206\u6790\uff1a\u9009\u62e9\u652f\u6301\u5feb\u901f\u54cd\u5e94\u7684\u6d41\u5f0f\u5904\u7406\u5de5\u5177</li> <li>\u79bb\u7ebf\u6279\u5904\u7406\uff1a\u4fa7\u91cd\u4e8e\u6279\u91cf\u5904\u7406\u80fd\u529b\u7684\u7cfb\u7edf</li> <li>\u6570\u636e\u6316\u6398\uff1a\u9700\u5177\u5907\u590d\u6742\u67e5\u8be2\u548c\u5206\u6790\u529f\u80fd</li> </ol>"},{"location":"middleware/#_18","title":"\u76d1\u63a7\u4e0e\u7ba1\u7406\u4e2d\u95f4\u4ef6","text":"<ul> <li>\u670d\u52a1\u53d1\u73b0\u4e0e\u6ce8\u518c</li> <li>\u65e5\u5fd7\u6536\u96c6\u4e0e\u5206\u6790</li> <li>\u6027\u80fd\u76d1\u63a7\u548c\u544a\u8b66</li> </ul> <p>\u2b50 \u9884\u77e5\u66f4\u591a\u5b9e\u8df5\u7ec6\u8282\uff0c\u53ef\u53c2\u8003\u5de6\u4fa7\u83dc\u5355\u4e2d\u5bf9\u5e94\u4e13\u9898\u7ae0\u8282</p>"},{"location":"middleware/etcd/","title":"Etcd","text":""},{"location":"middleware/etcd/#_1","title":"\u7ef4\u62a4","text":"<p>etcd \u96c6\u7fa4\u9700\u8981\u5b9a\u671f\u7ef4\u62a4\u624d\u80fd\u4fdd\u6301\u53ef\u9760\u6027\u3002etcd \u5e94\u7528\u7a0b\u5e8f\u901a\u5e38\u53ef\u4ee5\u81ea\u52a8\u8fdb\u884c\u7ef4\u62a4\uff0c\u5e76\u4e14\u4e0d\u4f1a\u9020\u6210\u505c\u673a\u6216\u6027\u80fd\u5927\u5e45\u4e0b\u964d\u3002</p> <p>\u4e3b\u8981\u901a\u8fc7\u538b\u7f29\uff0c\u7a7a\u95f4\u6574\u7406\u907f\u514d\u7a7a\u95f4\u5230\u8fbe\u9650\u989d etcd\u96c6\u7fa4\u8fdb\u5165\u7ef4\u62a4\u6a21\u5f0f\u5f71\u54cd\u96c6\u7fa4\u7684\u4f7f\u7528\u3002</p>"},{"location":"middleware/etcd/#_2","title":"\u65e5\u5fd7\u4fdd\u7559","text":"<p>etcd --snapshot-count \u914d\u7f6e\u538b\u7f29\u524d\u5185\u5b58\u4e2d\u4fdd\u7559\u7684\u5e94\u7528 Raft \u6761\u76ee\u7684\u6570\u91cf\uff0c \u9ed8\u8ba4100,1000. \u7c7b\u4f3ccheckpoint</p> <p>\u9ad8 --snapshot-count \u4f1a\u5728\u5feb\u7167\u524d\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u66f4\u591a\u7684 Raft \u6761\u76ee\uff0c\u5360\u7528\u5185\u5b58\u591a\uff0c gc \u6162\u3002\u4ece\u5e93\u540c\u6b65\u5feb\u7167\u6162</p> <p>\u4f4e --snapshot-count \u78c1\u76d8\u5237\u65b0\u9891\u7e41\uff0c\u5f71\u54cd\u5e76\u53d1</p>"},{"location":"middleware/etcd/#_3","title":"\u7a7a\u95f4\u9650\u989d","text":""},{"location":"middleware/etcd/#_4","title":"\u9650\u989d\u8bf4\u660e","text":"<p>\u9ed8\u8ba4\u7a7a\u95f4\u4e0d\u662f\u5f88\u59272G\uff0c\u53ef\u6ee1\u8db3\u5927\u90e8\u5206\u5e94\u7528\u573a\u666f\u3002 \u5f53\u4f7f\u7528\u7a7a\u95f4\u8fc7\u5927\u4f1a\u9020\u6210\u6027\u80fd\u4e0b\u964d\uff0c\u5f53\u8fbe\u5230\u9600\u503c\u65f6etcd \u5c31\u4f1a\u53d1\u51fa\u5168\u96c6\u7fa4\u8b66\u62a5\uff0c\u4f7f\u96c6\u7fa4\u8fdb\u5165\u7ef4\u62a4\u6a21\u5f0f\uff0c\u53ea\u63a5\u53d7\u8bfb\u53d6\u548c\u5220\u9664\u3002 \u53ea\u6709\u5728\u91ca\u653e\u4e86\u5bc6\u94a5\u7a7a\u95f4\u4e2d\u7684\u8db3\u591f\u7a7a\u95f4\u5e76\u5bf9\u540e\u7aef\u6570\u636e\u5e93\u8fdb\u884c\u4e86\u788e\u7247\u6574\u7406\uff0c\u540c\u65f6\u6e05\u9664\u4e86\u7a7a\u95f4\u914d\u989d\u8b66\u62a5\u540e\uff0c\u96c6\u7fa4\u624d\u80fd\u6062\u590d\u6b63\u5e38\u8fd0\u884c\u3002</p>"},{"location":"middleware/etcd/#_5","title":"\u788e\u7247\u6574\u7406","text":"<p>\u538b\u7f29\u7a7a\u95f4\u540e\uff0c\u540e\u7aef\u6570\u636e\u5e93\u53ef\u80fd\u4f1a\u51fa\u73b0\u5185\u90e8\u788e\u7247\u3002\u538b\u7f29\u65e7\u7248\u672c\u4f1a\u5728\u540e\u7aef\u6570\u636e\u5e93\u4e2d\u7559\u4e0b\u7a7a\u9699\uff0c\u4ece\u800c\u5728\u5185\u90e8\u9020\u6210 etcd \u788e\u7247\u3002\u788e\u7247\u7a7a\u95f4\u53ef\u4f9b etcd \u4f7f\u7528\uff0c\u4f46\u4e3b\u673a\u6587\u4ef6\u7cfb\u7edf\u65e0\u6cd5\u4f7f\u7528\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u5220\u9664\u5e94\u7528\u7a0b\u5e8f\u6570\u636e\u5e76\u4e0d\u80fd\u56de\u6536\u78c1\u76d8\u7a7a\u95f4\u3002</p> <p>\u788e\u7247\u6574\u7406\u8fc7\u7a0b\u4f1a\u5c06\u8fd9\u4e9b\u5b58\u50a8\u7a7a\u95f4\u91ca\u653e\u56de\u6587\u4ef6\u7cfb\u7edf\u3002\u788e\u7247\u6574\u7406\u4ee5\u6bcf\u4e2a\u6210\u5458\u4e3a\u5355\u4f4d\u8fdb\u884c\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u6574\u4e2a\u96c6\u7fa4\u7684\u5ef6\u8fdf\u9ad8\u5cf0\u3002</p>"},{"location":"middleware/etcd/#_6","title":"\u6a21\u62df\u6d4b\u8bd5","text":"<ul> <li>\u914d\u7f6e\u9650\u989d</li> </ul> <pre><code># set a very small 16 MiB quota\n$ etcd --quota-backend-bytes=$((16*1024*1024))\n</code></pre> <ul> <li>\u5199\u5165\u6570\u636e</li> </ul> <pre><code># fill keyspace\n$ while [ 1 ]; do dd if=/dev/urandom bs=1024 count=1024  | ETCDCTL_API=3 etcdctl put key  || break; done\n...\nError:  rpc error: code = 8 desc = etcdserver: mvcc: database space exceeded\n# confirm quota space is exceeded\n$ ETCDCTL_API=3 etcdctl --write-out=table endpoint status\n+----------------+------------------+-----------+---------+-----------+-----------+------------+\n|    ENDPOINT    |        ID        |  VERSION  | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX |\n+----------------+------------------+-----------+---------+-----------+-----------+------------+\n| 127.0.0.1:2379 | bf9071f4639c75cc | 2.3.0+git | 18 MB   | true      |         2 |       3332 |\n+----------------+------------------+-----------+---------+-----------+-----------+------------+\n# confirm alarm is raised\n$ ETCDCTL_API=3 etcdctl alarm list\nmemberID:13803658152347727308 alarm:NOSPACE\n</code></pre> <ul> <li>\u91ca\u653e\u7a7a\u95f4</li> </ul> <pre><code># get current revision\n$ rev=$(ETCDCTL_API=3 etcdctl --endpoints=:2379 endpoint status --write-out=\"json\" | egrep -o '\"revision\":[0-9]*' | egrep -o '[0-9].*')\n# compact away all old revisions\n$ ETCDCTL_API=3 etcdctl compact $rev\ncompacted revision 1516\n# defragment away excessive space\n$ ETCDCTL_API=3 etcdctl defrag\nFinished defragmenting etcd member[127.0.0.1:2379]\n# disarm alarm\n$ ETCDCTL_API=3 etcdctl alarm disarm\nmemberID:13803658152347727308 alarm:NOSPACE\n# test puts are allowed again\n$ ETCDCTL_API=3 etcdctl put newkey 123\nOK\n</code></pre> <ul> <li>\u589e\u52a0\u7a7a\u95f4\u9650\u989d</li> </ul> <pre><code>- --auto-compaction-mode=revision\n- --auto-compaction-retention=1000\n- --quota-backend-bytes=8589934592\n\nauto-compaction-mode=revision \u6309\u7248\u672c\u53f7\u538b\u7f29\nauto-compaction-retention=24 \u5c0f\u65f6\nquota-backend-bytes \u8bbe\u7f6eetcd\u6700\u5927\u5bb9\u91cf\u4e3a8G\n</code></pre> <p>\u4fee\u6539\u540e\u91cd\u542f</p>"},{"location":"middleware/etcd/#k3s-etcd","title":"k3s \u5185\u7f6eetcd \u7ef4\u62a4","text":"<p>\u6570\u636e\u5b58\u50a8\u4f4d\u7f6e <code>/var/lib/rancher/k3s/server/db/etcd</code></p> <pre><code># alias k3s_etcdctl=\"ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379   --cert=/var/lib/rancher/k3s/server/tls/etcd/server-client.crt   --key=/var/lib/rancher/k3s/server/tls/etcd/server-client.key   --cacert=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt\"\n\n# k3s_etcdctl endpoint status --write-out=table\n+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|        ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| https://127.0.0.1:2379 | c02555d2c59f97bf |  3.5.13 |   32 MB |     false |      false |        11 |   30427186 |           30427186 |        |\n+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n\n# k3s_etcdctl endpoint status --write-out=json | egrep -o '\"revision\":[0-9]*' | egrep -o '[0-9].*'\n27951671\n\n# k3s_etcdctl compact 27951671\ncompacted revision 27951671\n\n# k3s_etcdctl  endpoint status --write-out=table\n+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n|        ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |\n+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n| https://127.0.0.1:2379 | c02555d2c59f97bf |  3.5.13 |   18 MB |     false |      false |        11 |   30431611 |           30431611 |        |\n+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+\n\u6570\u636e\u5907\u4efd\n# k3s etcd-snapshot save\n\n/var/lib/rancher/k3s/server/db/etcd/snapshot\n</code></pre>"},{"location":"middleware/etcd/#_7","title":"\u7a7a\u95f4\u76d1\u63a7","text":"<ul> <li>etcd_mvcc_db_total_size_in_use_in_bytes \u5b9e\u9645\u4f7f\u7528\uff0c\u538b\u7f29\u540e\u7684\u4f7f\u7528\u91cf</li> <li>etcd_mvcc_db_total_size_in_bytes \u5b9e\u9645\u78c1\u76d8\u5360\u7528\u7a7a\u95f4</li> </ul>"},{"location":"middleware/etcd/#_8","title":"\u6570\u636e\u5907\u4efd","text":"<pre><code>$ etcdctl snapshot save backup.db\n$ etcdutl --write-out=table snapshot status backup.db\n+----------+----------+------------+------------+\n|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |\n+----------+----------+------------+------------+\n| fe01cf57 |       10 |          7 | 2.1 MB     |\n+----------+----------+------------+------------+\n</code></pre>"},{"location":"middleware/nginx/","title":"nginx","text":""},{"location":"mongodb/","title":"Index","text":""},{"location":"mongodb/#_1","title":"\u767b\u5f55","text":"<pre><code>mongosh -u root -p 1bg8NTU9k8 --host 127.0.0.1\n</code></pre>"},{"location":"mongodb/#rs","title":"rs \u526f\u672c\u96c6\u67e5\u770b","text":"<pre><code>rs.conf()\nrs.status()\n// \u67e5\u770b\u590d\u5236\u5ef6\u8fdf\ndb.printSecondaryReplicationInfo();\n\n// \u68c0\u67e5 Oplog \u7a97\u53e3\nrs.printReplicationInfo();\n\n// \u76d1\u63a7\u8282\u70b9\u8d1f\u8f7d\ndb.serverStatus().locks;\ndb.serverStatus().globalLock;\n</code></pre>"},{"location":"mongodb/#_2","title":"\u7528\u6237\u7ba1\u7406","text":"<pre><code>use admin\ndb.system.users.find()\n\u521b\u5efa\u7528\u6237\ndb.createUser({user: test, pwd: 123456Aa, roles:[{role: read, db: admin}]})\n\u66f4\u65b0\u7528\u6237\ndb.updateUser('test', {\n  roles: [{ role: 'readWrite', db: 'db002' }]  // \u76f4\u63a5\u8986\u76d6\u539f\u6709\u89d2\u8272\n});\n\u67e5\u770b\u7528\u6237\ndb.getUser('test');\n</code></pre>"},{"location":"mongodb/#oplog","title":"oplog","text":"<pre><code>// \u67e5\u770boplog\n// \u6267\u884c\u5728\u4efb\u610f\u526f\u672c\u96c6\u6210\u5458\nrs.printReplicationInfo()\n// \u9a8c\u8bc1\n// \u5207\u6362\u5230 local \u6570\u636e\u5e93\nuse local\n\n// \u67e5\u770b oplog.rs \u96c6\u5408\u7684\u7269\u7406\u5927\u5c0f\uff08\u5355\u4f4d\uff1a\u5b57\u8282\uff09\ndb.oplog.rs.stats().maxSize\n// \u8bbe\u7f6e oplog\ndb.adminCommand({ replSetResizeOplog: 1, size: 8192 });  // \u8bbe\u7f6e\u4e3a 8GB\n</code></pre> <p>INSERT INTO s_parking_exit_record VALUES('c9c267b8232f11f0b5c3bafceaf8868f','b830260af38711eca94aae2504c624f7','{210504, 210500}','1','tmp','\u8fbdENF189','2025-04-27 16:21:35.983150+08:00','2025-04-27 16:50:14.762448+08:00')</p>"},{"location":"mongodb/config/","title":"MongoDB \u914d\u7f6e","text":""},{"location":"mongodb/config/#_1","title":"\u914d\u7f6e\u6587\u4ef6\u7ed3\u6784","text":"<p>MongoDB \u7684\u914d\u7f6e\u4e3b\u8981\u901a\u8fc7 <code>mongod.conf</code> \u6587\u4ef6\u8fdb\u884c\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u4f4d\u7f6e\u901a\u5e38\u5728 <code>/etc/mongod.conf</code>\u3002</p>"},{"location":"mongodb/config/#_2","title":"\u4e3b\u8981\u914d\u7f6e\u9009\u9879","text":""},{"location":"mongodb/config/#1","title":"1. \u7f51\u7edc\u914d\u7f6e","text":"<pre><code>net:\n  port: 27017\n  bindIp: 127.0.0.1\n  bindIpAll: true # \u7ed1\u5b9a\u5230\u6240\u6709IP\u5730\u5740\uff08\u751f\u4ea7\u73af\u5883\u9700\u8981\u8c28\u614e\u8003\u8651\uff09\n</code></pre>"},{"location":"mongodb/config/#2","title":"2. \u5b58\u50a8\u914d\u7f6e","text":"<pre><code>storage:\n  dbPath: /var/lib/mongo\n  journal:\n    enabled: true\n\n  # \u5b58\u50a8\u5f15\u64ce\u914d\u7f6e\n  engine: wiredTiger\n  wiredTiger:\n    engineConfig:\n      cacheSizeGB: 1\n    collectionConfig:\n      blockCompressor: snappy\n</code></pre>"},{"location":"mongodb/config/#3","title":"3. \u7cfb\u7edf\u65e5\u5fd7\u914d\u7f6e","text":"<pre><code>systemLog:\n  destination: file\n  logAppend: true\n  path: /var/log/mongodb/mongod.log\n</code></pre>"},{"location":"mongodb/config/#4","title":"4. \u8fdb\u7a0b\u7ba1\u7406\u914d\u7f6e","text":"<pre><code>processManagement:\n  fork: true\n  pidFilePath: /var/run/mongodb/mongod.pid\n  timeZoneInfo: /usr/share/zoneinfo\n</code></pre>"},{"location":"mongodb/config/#5","title":"5. \u5b89\u5168\u914d\u7f6e","text":"<pre><code>security:\n  authorization: enabled # \u542f\u7528\u8ba4\u8bc1\n  keyFile: /etc/mongo-security/keyfile\n  clusterAuthMode: keyFile\n\n  # TLS/SSL \u914d\u7f6e\n  ssl:\n    mode: requireSSL\n    PEMKeyFile: /etc/ssl/mongodb.pem\n</code></pre>"},{"location":"mongodb/config/#_3","title":"\u914d\u7f6e\u53c2\u6570\u8bf4\u660e","text":""},{"location":"mongodb/config/#_4","title":"\u6027\u80fd\u4f18\u5316\u914d\u7f6e","text":"<ul> <li>cacheSizeGB: WiredTiger \u5b58\u50a8\u5f15\u64ce\u7684\u7f13\u5b58\u5927\u5c0f\uff0c\u901a\u5e38\u8bbe\u7f6e\u4e3a\u4e3b\u673a\u5185\u5b58\u7684\u4e00\u534a</li> <li>journal: \u7528\u4e8e\u6570\u636e\u6301\u4e45\u5316\u7684\u65e5\u8bb0\u529f\u80fd\uff0c\u63a8\u8350\u542f\u7528</li> <li>syncdelay: \u7cfb\u7edf\u6570\u636e\u5237\u65b0\u95f4\u9694\uff08\u79d2\uff09\uff0c\u9ed8\u8ba4 60 \u79d2</li> </ul>"},{"location":"mongodb/config/#_5","title":"\u96c6\u7fa4\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>replication:\n  replSetName: rs0\n\nsharding:\n  clusterRole: shardsvr # \u5728\u5206\u7247\u4e2d\u4e3a shardsvr\uff0c\u914d\u7f6e\u670d\u52a1\u5668\u4e3a configsvr\n</code></pre>"},{"location":"mongodb/config/#_6","title":"\u914d\u7f6e\u9a8c\u8bc1","text":"<p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u9a8c\u8bc1\u914d\u7f6e\uff1a</p> <pre><code># \u9a8c\u8bc1\u914d\u7f6e\u6587\u4ef6\u683c\u5f0f\nmongod --config /etc/mongod.conf --configtest\n\n# \u91cd\u542fMongoDB\u670d\u52a1\u4f7f\u914d\u7f6e\u751f\u6548\nsudo systemctl restart mongod\n</code></pre>"},{"location":"mongodb/config/#_7","title":"\u751f\u4ea7\u73af\u5883\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li>\u7981\u7528 bindIpAll \u5e76\u6307\u5b9a\u5177\u4f53\u7684\u76d1\u542c IP</li> <li>\u542f\u7528\u8eab\u4efd\u9a8c\u8bc1\u548c\u8bbf\u95ee\u63a7\u5236</li> <li>\u5b9a\u671f\u8f6e\u6362\u5bc6\u94a5\u6587\u4ef6</li> <li>\u914d\u7f6e\u9002\u5f53\u7684\u65e5\u5fd7\u7ea7\u522b\u548c\u5f52\u6863\u7b56\u7565</li> </ol>"},{"location":"mongodb/install/","title":"MongoDB \u5b89\u88c5","text":""},{"location":"mongodb/install/#_1","title":"\u7b80\u4ecb","text":"<p>MongoDB \u662f\u4e00\u4e2a\u57fa\u4e8e\u5206\u5e03\u5f0f\u6587\u4ef6\u5b58\u50a8\u7684\u5f00\u6e90\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u5c5e\u4e8e NoSQL \u6570\u636e\u5e93\uff0c\u4f7f\u7528 JSON \u98ce\u683c\u7684\u6570\u636e\u7ed3\u6784\u3002</p>"},{"location":"mongodb/install/#_2","title":"\u5b89\u88c5\u65b9\u5f0f","text":""},{"location":"mongodb/install/#1","title":"1. \u5305\u7ba1\u7406\u5668\u5b89\u88c5","text":""},{"location":"mongodb/install/#ubuntudebian","title":"Ubuntu/Debian","text":"<pre><code># \u5bfc\u5165\u516c\u94a5\nwget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -\n\n# \u6dfb\u52a0MongoDB APT\u6e90\necho \"deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse\" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list\n\n# \u66f4\u65b0\u5305\u5217\u8868\u5e76\u5b89\u88c5MongoDB\nsudo apt-get update\nsudo apt-get install -y mongodb-org\n</code></pre>"},{"location":"mongodb/install/#centosrhel","title":"CentOS/RHEL","text":"<pre><code># \u521b\u5efaMongoDB.repo\u6587\u4ef6\ncat &lt;&lt; EOF | sudo tee /etc/yum.repos.d/mongodb-org-6.0.repo\n[mongodb-org-6.0]\nname=MongoDB Repository\nbaseurl=https://repo.mongodb.org/yum/redhat/8/mongodb-org/6.0/x86_64/\ngpgcheck=1\nenabled=1\ngpgkey=https://www.mongodb.org/static/pgp/server-6.0.asc\nEOF\n\n# \u5b89\u88c5MongoDB\nsudo dnf install -y mongodb-org\n</code></pre>"},{"location":"mongodb/install/#2-docker","title":"2. Docker \u5b89\u88c5","text":"<pre><code># \u62c9\u53d6MongoDB\u955c\u50cf\ndocker pull mongo:latest\n\n# \u542f\u52a8MongoDB\u5bb9\u5668\ndocker run -d -p 27017:27017 -v mongo-data:/data/db --name mongodb mongo:latest\n</code></pre>"},{"location":"mongodb/install/#_3","title":"\u9a8c\u8bc1\u5b89\u88c5","text":"<pre><code># \u542f\u52a8MongoDB\u670d\u52a1\nsudo systemctl start mongod\n\n# \u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\u52a8\nsudo systemctl enable mongod\n\n# \u8fde\u63a5MongoDB\nmongo\n</code></pre>"},{"location":"mongodb/privilege/","title":"MongoDB \u6743\u9650\u7ba1\u7406","text":""},{"location":"mongodb/privilege/#_1","title":"\u6743\u9650\u6a21\u578b","text":"<p>MongoDB \u91c7\u7528\u57fa\u4e8e\u89d2\u8272\u7684\u6743\u9650\u7ba1\u7406 (RBAC - Role-Based Access Control) \u6a21\u578b\uff0c\u7528\u6237\u5fc5\u987b\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u624d\u80fd\u6267\u884c\u64cd\u4f5c\u3002</p>"},{"location":"mongodb/privilege/#_2","title":"\u5185\u7f6e\u89d2\u8272","text":""},{"location":"mongodb/privilege/#_3","title":"\u6570\u636e\u5e93\u7528\u6237\u89d2\u8272","text":"<ul> <li>read: \u8bfb\u53d6\u6743\u9650\uff0c\u53ef\u4ee5\u67e5\u770b\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e</li> <li>readWrite: \u8bfb\u5199\u6743\u9650\uff0c\u53ef\u4ee5\u8bfb\u5199\u6570\u636e</li> </ul>"},{"location":"mongodb/privilege/#_4","title":"\u6570\u636e\u5e93\u7ba1\u7406\u89d2\u8272","text":"<ul> <li>dbAdmin: \u6570\u636e\u5e93\u7ba1\u7406\u5458\u6743\u9650\uff0c\u6267\u884c\u7ba1\u7406\u4efb\u52a1</li> <li>dbOwner: \u6570\u636e\u5e93\u6240\u6709\u8005\u6743\u9650\uff0c\u7ed3\u5408 readWrite\u3001dbAdmin \u548c userAdmin \u89d2\u8272</li> <li>userAdmin: \u7528\u6237\u7ba1\u7406\u5458\u6743\u9650\uff0c\u8d1f\u8d23\u7ba1\u7406\u7528\u6237\u548c\u89d2\u8272</li> </ul>"},{"location":"mongodb/privilege/#_5","title":"\u96c6\u7fa4\u7ba1\u7406\u89d2\u8272","text":"<ul> <li>clusterAdmin: \u96c6\u7fa4\u7ba1\u7406\u5458\uff0c\u62e5\u6709\u6700\u9ad8\u7ea7\u522b\u7684\u7ba1\u7406\u6743\u9650</li> <li>clusterManager: \u96c6\u7fa4\u7ba1\u7406\u6743\u9650</li> <li>clusterMonitor: \u96c6\u7fa4\u76d1\u63a7\u6743\u9650</li> <li>hostManager: \u4e3b\u673a\u7ba1\u7406\u6743\u9650</li> </ul>"},{"location":"mongodb/privilege/#_6","title":"\u5907\u4efd\u4e0e\u6062\u590d\u89d2\u8272","text":"<ul> <li>backup: \u5907\u4efd\u6743\u9650</li> <li>restore: \u6062\u590d\u6743\u9650</li> </ul>"},{"location":"mongodb/privilege/#_7","title":"\u5168\u5c40\u89d2\u8272","text":"<ul> <li>root: \u8d85\u7ea7\u7ba1\u7406\u5458\u89d2\u8272\uff0c\u62e5\u6709\u6240\u6709\u6570\u636e\u5e93\u6240\u6709\u6743\u9650</li> </ul>"},{"location":"mongodb/privilege/#_8","title":"\u7528\u6237\u7ba1\u7406","text":""},{"location":"mongodb/privilege/#_9","title":"\u521b\u5efa\u7ba1\u7406\u5458\u8d26\u6237","text":"<pre><code>// \u5207\u6362\u5230 admin \u6570\u636e\u5e93\nuse admin\n\n// \u521b\u5efa\u8d85\u7ea7\u7528\u6237\ndb.createUser({\n    user: \"admin\",\n    pwd: \"securePassword\",\n    roles: [{ role: \"userAdminAnyDatabase\", db: \"admin\" }]\n})\n</code></pre>"},{"location":"mongodb/privilege/#_10","title":"\u4e3a\u7279\u5b9a\u6570\u636e\u5e93\u521b\u5efa\u7528\u6237","text":"<pre><code>// \u5207\u6362\u5230\u76ee\u6807\u6570\u636e\u5e93\nuse myDatabase\n\n// \u521b\u5efa\u6570\u636e\u5e93\u7528\u6237\ndb.createUser({\n    user: \"myUser\",\n    pwd: \"password\",\n    roles: [\n        { role: \"readWrite\", db: \"myDatabase\" },\n        { role: \"read\", db: \"otherDatabase\" }\n    ]\n})\n</code></pre>"},{"location":"mongodb/privilege/#_11","title":"\u8eab\u4efd\u9a8c\u8bc1","text":"<pre><code># \u8fde\u63a5\u65f6\u8ba4\u8bc1\nmongo -u username -p --authenticationDatabase databaseName\n\n# \u6216\u8005\u5728\u6570\u636e\u5e93\u5185\u90e8\u8fdb\u884c\u8ba4\u8bc1\ndb.auth(\"username\", \"password\")\n</code></pre>"},{"location":"mongodb/privilege/#_12","title":"\u81ea\u5b9a\u4e49\u89d2\u8272","text":""},{"location":"mongodb/privilege/#_13","title":"\u521b\u5efa\u81ea\u5b9a\u4e49\u89d2\u8272","text":"<pre><code>// \u5728\u7279\u5b9a\u6570\u636e\u5e93\u4e2d\u521b\u5efa\u89d2\u8272\nuse myDatabase\n\ndb.createRole({\n    role: \"customRole\",\n    privileges: [\n        {\n            resource: { db: \"myDatabase\", collection: \"employees\" },\n            actions: [\n                \"find\",\n                \"insert\",\n                \"remove\",\n                \"update\"\n            ]\n        },\n        {\n            resource: { db: \"myDatabase\", collection: \"\" }, // \u6240\u6709\u96c6\u5408\n            actions: [\n                \"listCollections\",\n                \"collStats\"\n            ]\n        }\n    ],\n    roles: []  // \u53ef\u4ee5\u7ee7\u627f\u5176\u4ed6\u89d2\u8272\n})\n</code></pre>"},{"location":"mongodb/privilege/#_14","title":"\u89d2\u8272\u8d44\u6e90\u9650\u5b9a","text":"<pre><code>// \u53ef\u4ee5\u5728\u4e0d\u540c\u7ea7\u522b\u6307\u5b9a\u6743\u9650\u8d44\u6e90\n{\n    resource: {\n        db: \"databaseName\",         // \u6570\u636e\u5e93\u540d\n        collection: \"collectionName\" // \u96c6\u5408\u540d\uff0c\u7a7a\u5b57\u7b26\u4e32\u8868\u793a\u6574\u4e2a\u6570\u636e\u5e93\n    },\n    actions: [\"action1\", \"action2\"] // \u5141\u8bb8\u7684\u64cd\u4f5c\u5217\u8868\n}\n</code></pre>"},{"location":"mongodb/privilege/#_15","title":"\u6388\u6743\u64cd\u4f5c\u793a\u4f8b","text":""},{"location":"mongodb/privilege/#_16","title":"\u6388\u4e88\u89d2\u8272","text":"<pre><code>// \u4e3a\u7528\u6237\u6dfb\u52a0\u89d2\u8272\ndb.grantRolesToUser(\"userName\", [\n  { role: \"readWrite\", db: \"applicationDB\" },\n  { role: \"read\", db: \"reportingDB\" },\n]);\n</code></pre>"},{"location":"mongodb/privilege/#_17","title":"\u56de\u6536\u89d2\u8272","text":"<pre><code>// \u4ece\u7528\u6237\u79fb\u9664\u89d2\u8272\ndb.revokeRolesFromUser(\"userName\", [{ role: \"readWrite\", db: \"oldDB\" }]);\n</code></pre>"},{"location":"mongodb/privilege/#_18","title":"\u67e5\u770b\u7528\u6237\u6743\u9650","text":"<pre><code>// \u67e5\u770b\u5f53\u524d\u7528\u6237\u7684\u6743\u9650\ndb.runCommand({ connectionStatus: 1 });\n\n// \u67e5\u770b\u6307\u5b9a\u7528\u6237\u4fe1\u606f\ndb.getUser(\"userName\");\n\n// \u67e5\u770b\u6240\u6709\u7528\u6237\ndb.getUsers();\n\n// \u67e5\u770b\u6240\u6709\u89d2\u8272\ndb.getRoles({ rolesInfo: 1 });\n</code></pre>"},{"location":"mongodb/privilege/#_19","title":"\u5b89\u5168\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mongodb/privilege/#_20","title":"\u7f51\u7edc\u5b89\u5168","text":"<ol> <li>\u542f\u7528\u8ba4\u8bc1</li> <li>\u4f7f\u7528 TLS/SSL \u52a0\u5bc6\u8fde\u63a5</li> <li>\u914d\u7f6e\u9632\u706b\u5899\u89c4\u5219</li> <li>\u9650\u5236 bindIP \u53ea\u63a5\u53d7\u5fc5\u8981\u6765\u6e90</li> </ol>"},{"location":"mongodb/privilege/#_21","title":"\u8d26\u6237\u5b89\u5168","text":"<ol> <li>\u521b\u5efa\u6700\u5c0f\u6743\u9650\u539f\u5219\u7684\u7528\u6237\u8d26\u6237</li> <li>\u5b9a\u671f\u8f6e\u6362\u5bc6\u7801</li> <li>\u5ba1\u8ba1\u7528\u6237\u6d3b\u52a8</li> <li>\u4f7f\u7528\u4e13\u7528\u7ba1\u7406\u8d26\u6237</li> </ol>"},{"location":"mongodb/privilege/#_22","title":"\u64cd\u4f5c\u5b89\u5168","text":"<ol> <li>\u5b9a\u671f\u5ba1\u8ba1\u6388\u6743\u53d8\u66f4</li> <li>\u76d1\u63a7\u672a\u6388\u6743\u8bbf\u95ee\u5c1d\u8bd5</li> <li>\u4f7f\u7528\u53ea\u8bfb\u7528\u6237\u8fdb\u884c\u67e5\u8be2\u64cd\u4f5c</li> <li>\u5b9a\u671f\u5ba1\u6838\u8d26\u6237\u548c\u89d2\u8272\u5206\u914d</li> </ol>"},{"location":"mongodb/privilege/#_23","title":"\u5e38\u7528\u7ba1\u7406\u547d\u4ee4","text":""},{"location":"mongodb/privilege/#_24","title":"\u5217\u51fa\u6240\u6709\u5185\u7f6e\u89d2\u8272","text":"<pre><code>db.runCommand({ rolesInfo: 1, showBuiltinRoles: true });\n</code></pre>"},{"location":"mongodb/privilege/#_25","title":"\u67e5\u770b\u89d2\u8272\u8be6\u60c5","text":"<pre><code>db.getRole({ role: \"roleName\", db: \"databaseName\" }, { showPrivileges: true });\n</code></pre>"},{"location":"mongodb/privilege/#_26","title":"\u4f1a\u8bdd\u5b89\u5168\u914d\u7f6e","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5f3a\u70c8\u5efa\u8bae\uff1a</p> <ul> <li>\u542f\u7528\u8ba4\u8bc1\u5e76\u4f7f\u7528\u5f3a\u5bc6\u7801\u7b56\u7565</li> <li>\u4f7f\u7528\u89d2\u8272\u800c\u975e\u7279\u6743\u7528\u6237\u8fdb\u884c\u65e5\u5e38\u64cd\u4f5c</li> <li>\u5b9a\u671f\u8fdb\u884c\u6743\u9650\u5ba1\u67e5</li> <li>\u5ba1\u6838\u548c\u8bb0\u5f55\u6240\u6709\u7684\u6388\u6743\u66f4\u6539</li> </ul>"},{"location":"mongodb/replication/","title":"MongoDB \u590d\u5236\u96c6","text":""},{"location":"mongodb/replication/#_1","title":"\u6982\u8ff0","text":"<p>MongoDB \u590d\u5236\u96c6 (Replica Set) \u662f\u4e00\u7ec4\u7ef4\u62a4\u76f8\u540c\u6570\u636e\u96c6\u5408\u7684 mongod \u5b9e\u4f8b\u3002\u590d\u5236\u96c6\u63d0\u4f9b\u4e86\u5197\u4f59\u548c\u9ad8\u53ef\u7528\u6027\uff0c\u662f\u751f\u4ea7\u73af\u5883\u4e2d\u63a8\u8350\u7684\u6570\u636e\u5b58\u50a8\u65b9\u5f0f\u3002</p>"},{"location":"mongodb/replication/#_2","title":"\u590d\u5236\u96c6\u67b6\u6784","text":""},{"location":"mongodb/replication/#_3","title":"\u8282\u70b9\u89d2\u8272","text":"<ul> <li>Primary\uff08\u4e3b\u8282\u70b9\uff09\uff1a\u63a5\u6536\u6240\u6709\u5199\u64cd\u4f5c</li> <li>Secondary\uff08\u4ece\u8282\u70b9\uff09\uff1a\u4ece Primary \u8282\u70b9\u590d\u5236\u6570\u636e</li> <li>Arbiter\uff08\u4ef2\u88c1\u8282\u70b9\uff09\uff1a\u53c2\u4e0e\u9009\u4e3e\u4f46\u4e0d\u4fdd\u5b58\u6570\u636e</li> </ul>"},{"location":"mongodb/replication/#_4","title":"\u521b\u5efa\u590d\u5236\u96c6","text":""},{"location":"mongodb/replication/#1","title":"1. \u914d\u7f6e\u6587\u4ef6\u51c6\u5907","text":"<p>\u6bcf\u4e2a\u8282\u70b9\u90fd\u9700\u8981\u76f8\u5e94\u914d\u7f6e\uff1a</p> <pre><code># mongod.conf\nnet:\n  port: 27017\n  bindIp: 0.0.0.0\n\nreplication:\n  replSetName: rs0\n</code></pre>"},{"location":"mongodb/replication/#2","title":"2. \u521d\u59cb\u5316\u590d\u5236\u96c6","text":"<pre><code># \u8fde\u63a5\u5230\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\nmongo --port 27017\n\n# \u521d\u59cb\u5316\u590d\u5236\u96c6\nrs.initiate()\n</code></pre>"},{"location":"mongodb/replication/#3","title":"3. \u6dfb\u52a0\u6210\u5458","text":"<pre><code># \u6dfb\u52a0\u590d\u5236\u96c6\u6210\u5458\nrs.add(\"hostname2:27017\")\nrs.add(\"hostname3:27017\")\n\n# \u6216\u6dfb\u52a0\u4ef2\u88c1\u8282\u70b9\nrs.addArb(\"arbiter-hostname:27017\")\n</code></pre>"},{"location":"mongodb/replication/#_5","title":"\u6210\u5458\u914d\u7f6e","text":""},{"location":"mongodb/replication/#_6","title":"\u914d\u7f6e\u6a21\u677f","text":"<pre><code>cfg = rs.conf();\ncfg.members[0].priority = 2; // \u8bbe\u7f6e\u4f18\u5148\u7ea7\ncfg.members[1].priority = 1; // \u8bbe\u7f6e\u4f18\u5148\u7ea7\ncfg.members[2].priority = 0; // \u975e\u9009\u4e3e\u6210\u5458\nrs.reconfig(cfg);\n</code></pre>"},{"location":"mongodb/replication/#_7","title":"\u6210\u5458\u5c5e\u6027","text":"<ul> <li><code>priority</code>: 0-1000\uff0c\u5f71\u54cd\u9009\u4e3e\uff0c0 \u8868\u793a\u4e0d\u53ef\u9009\u4e3e</li> <li><code>votes</code>: 0 \u6216 1\uff0c\u5f71\u54cd\u6295\u7968\u6743</li> <li><code>hidden</code>: true \u4e3a\u9690\u85cf\u8282\u70b9\uff0c\u5bf9\u5ba2\u6237\u7aef\u4e0d\u53ef\u89c1</li> <li><code>slaveDelay</code>: \u5ef6\u8fdf\u590d\u5236\uff08\u79d2\uff09</li> </ul>"},{"location":"mongodb/replication/#_8","title":"\u7ba1\u7406\u64cd\u4f5c","text":""},{"location":"mongodb/replication/#_9","title":"\u67e5\u770b\u590d\u5236\u96c6\u72b6\u6001","text":"<pre><code># \u67e5\u770b\u590d\u5236\u96c6\u72b6\u6001\nrs.status()\n\n# \u67e5\u770b\u590d\u5236\u96c6\u914d\u7f6e\nrs.conf()\n\n# \u67e5\u770b\u590d\u5236\u5ef6\u8fdf\ndb.printSlaveReplicationInfo()\n</code></pre>"},{"location":"mongodb/replication/#_10","title":"\u6545\u969c\u8f6c\u79fb","text":"<p>MongoDB \u4f1a\u5728 Primary \u8282\u70b9\u5931\u6548\u65f6\u81ea\u52a8\u8fdb\u884c\u6545\u969c\u8f6c\u79fb\uff1a</p> <ul> <li>\u81f3\u5c11\u9700\u8981\u4e24\u4e2a\u8282\u70b9\u80fd\u76f8\u4e92\u901a\u4fe1</li> <li>\u9009\u4e3e\u8fc7\u7a0b\u901a\u5e38\u5728 10-30 \u79d2\u5185\u5b8c\u6210</li> <li>\u65e7\u7684 Primary \u8282\u70b9\u5728\u6062\u590d\u540e\u4f1a\u6210\u4e3a Secondary \u8282\u70b9</li> </ul>"},{"location":"mongodb/replication/#_11","title":"\u8bfb\u5199\u5173\u6ce8\u7ea7\u522b","text":""},{"location":"mongodb/replication/#write-concern","title":"\u5199\u5173\u6ce8 (Write Concern)","text":"<pre><code>// \u9ed8\u8ba4\u5199\u5165\uff0c\u8fd4\u56deacknowledged\ndb.collection.insertOne({ x: 1 }, { writeConcern: { w: 1 } });\n\n// \u7b49\u5f85\u591a\u6570\u8282\u70b9\u786e\u8ba4\ndb.collection.insertOne({ x: 1 }, { writeConcern: { w: \"majority\" } });\n\n// \u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\ndb.collection.insertOne(\n  { x: 1 },\n  { writeConcern: { w: \"majority\", wtimeout: 5000 } }\n);\n</code></pre>"},{"location":"mongodb/replication/#read-concern","title":"\u8bfb\u5173\u6ce8 (Read Concern)","text":"<pre><code>// \u6700\u8fd1\u6570\u636e\ndb.collection.find().readConcern(\"local\");\n\n// \u5df2\u63d0\u4ea4\u6570\u636e\ndb.collection.find().readConcern(\"available\");\n\n// \u7ebf\u6027\u4e00\u81f4\u8bfb\ndb.collection.find().readConcern(\"linearizable\");\n</code></pre>"},{"location":"mongodb/replication/#_12","title":"\u590d\u5236\u5ef6\u8fdf","text":""},{"location":"mongodb/replication/#_13","title":"\u76d1\u63a7\u5ef6\u8fdf","text":"<pre><code># \u67e5\u770b\u5ef6\u8fdf\ndb.printSlaveReplicationInfo()\n\n# \u83b7\u53d6\u5ef6\u8fdf\u7edf\u8ba1\ndb.adminCommand(\"replSetGetStatus\")\n</code></pre>"},{"location":"mongodb/replication/#_14","title":"\u4f18\u5316\u590d\u5236","text":"<ul> <li>\u542f\u7528 WiredTiger \u5b58\u50a8\u5f15\u64ce</li> <li>\u8c03\u6574 oplog \u5927\u5c0f</li> <li>\u907f\u514d\u5927\u4f53\u79ef\u66f4\u65b0</li> </ul>"},{"location":"mongodb/replication/#_15","title":"\u8fd0\u7ef4\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mongodb/replication/#_16","title":"\u76d1\u63a7\u6307\u6807","text":"<ul> <li>\u590d\u5236\u5ef6\u8fdf</li> <li>oplog \u4f7f\u7528\u60c5\u51b5</li> <li>\u8282\u70b9\u5065\u5eb7\u72b6\u6001</li> <li>\u5199\u64cd\u4f5c\u6027\u80fd</li> </ul>"},{"location":"mongodb/replication/#_17","title":"\u90e8\u7f72\u7b56\u7565","text":"<ul> <li>\u5c06\u590d\u5236\u96c6\u8282\u70b9\u90e8\u7f72\u5728\u4e0d\u540c\u7684\u53ef\u7528\u533a</li> <li>\u4f7f\u7528\u4e13\u7528\u7f51\u7edc\u8fdb\u884c\u590d\u5236\u901a\u4fe1</li> <li>\u6b63\u786e\u8bbe\u7f6e\u8282\u70b9\u4f18\u5148\u7ea7\u4ee5\u786e\u4fdd\u5408\u9002\u7684\u8282\u70b9\u6210\u4e3a Primary</li> <li>\u5b9a\u671f\u6d4b\u8bd5\u6545\u969c\u8f6c\u79fb\u8fc7\u7a0b</li> </ul>"},{"location":"mongodb/sharding/","title":"MongoDB \u5206\u7247\u96c6\u7fa4","text":""},{"location":"mongodb/sharding/#_1","title":"\u6982\u8ff0","text":"<p>MongoDB \u5206\u7247 (Sharding) \u662f\u4e00\u79cd\u8de8\u591a\u53f0\u673a\u5668\u5206\u5e03\u6570\u636e\u7684\u65b9\u6cd5\u3002 MongoDB \u4f7f\u7528\u5206\u7247\u5c06\u5927\u578b\u6570\u636e\u96c6\u5206\u5e03\u5728\u591a\u4e2a\u670d\u52a1\u5668\u6216\u670d\u52a1\u5668\u7fa4\u96c6\u4e0a\uff0c\u4ee5\u63d0\u9ad8\u6570\u636e\u5904\u7406\u80fd\u529b\u548c\u5b58\u50a8\u5bb9\u91cf\u3002</p>"},{"location":"mongodb/sharding/#_2","title":"\u67b6\u6784\u7ec4\u4ef6","text":""},{"location":"mongodb/sharding/#1-shards","title":"1. \u5206\u7247 (Shards)","text":"<p>\u5206\u7247\u5305\u542b\u6570\u636e\u5b50\u96c6\uff0cMongoDB \u4f1a\u5728\u8fd9\u4e9b\u5206\u7247\u4e4b\u95f4\u5747\u8861\u5206\u914d\u6570\u636e\u3002</p>"},{"location":"mongodb/sharding/#2-mongos","title":"2. mongos \u67e5\u8be2\u8def\u7531\u5668","text":"<p>\u5e94\u7528\u8fde\u63a5\u5230 <code>mongos</code> \u8fdb\u7a0b\u800c\u4e0d\u662f\u76f4\u63a5\u8fde\u63a5\u5230\u5206\u7247\uff0c\u5b83\u5145\u5f53\u4e2d\u95f4\u5c42\uff0c\u4ee3\u8868\u5e94\u7528\u7a0b\u5e8f\u5904\u7406\u67e5\u8be2\u548c\u5206\u53d1\u64cd\u4f5c\u3002</p>"},{"location":"mongodb/sharding/#3","title":"3. \u914d\u7f6e\u670d\u52a1\u5668","text":"<p>\u914d\u7f6e\u670d\u52a1\u5668\u5b58\u50a8\u96c6\u7fa4\u5143\u6570\u636e\uff08\u5982\u7247\u952e\u503c\u548c\u5757\u6620\u5c04\uff09\uff0c\u4ee5\u53ca\u9501\u4ee5\u540c\u6b65\u5143\u6570\u636e\u66f4\u6539\u3002</p>"},{"location":"mongodb/sharding/#_3","title":"\u5206\u7247\u7b56\u7565","text":""},{"location":"mongodb/sharding/#1","title":"1. \u5757\u8303\u56f4\u5206\u7247","text":"<ul> <li>\u6570\u636e\u6839\u636e\u5206\u7247\u952e\u503c\u7684\u8303\u56f4\u5206\u5272</li> <li>\u4f7f\u7528 <code>_id</code>\u3001\u6570\u5b57\u6216\u65f6\u95f4\u6233\u5b57\u6bb5\u65f6\u5e38\u7528</li> <li>\u5206\u5e03\u4e0d\u5747\u53ef\u80fd\u5bfc\u81f4\u70ed\u70b9\u95ee\u9898</li> </ul>"},{"location":"mongodb/sharding/#2-hash","title":"2. Hash \u5206\u7247","text":"<ul> <li>\u5bf9\u7247\u952e\u8fdb\u884c Hash \u8fd0\u7b97\uff0c\u5b9e\u73b0\u66f4\u5747\u5300\u5206\u5e03</li> <li>\u66f4\u9002\u5408\u968f\u673a\u5206\u53d1\u6570\u636e</li> <li>\u4e0d\u652f\u6301\u8303\u56f4\u67e5\u8be2\u4f18\u5316</li> </ul>"},{"location":"mongodb/sharding/#3-zone","title":"3. Zone \u5206\u7247","text":"<ul> <li>\u5c06\u6570\u636e\u5206\u53d1\u5230\u5b9a\u4e49\u7684\u533a\u57df(zone)</li> <li>\u6bcf\u4e2a zone \u5305\u542b\u4e00\u6216\u591a\u4e00\u5206\u7247</li> <li>\u63d0\u9ad8\u8bfb\u5199\u64cd\u4f5c\u6027\u80fd</li> </ul>"},{"location":"mongodb/sharding/#_4","title":"\u542f\u7528\u5206\u7247","text":""},{"location":"mongodb/sharding/#1_1","title":"1. \u5f00\u542f\u96c6\u7fa4","text":"<pre><code># \u542f\u52a8\u914d\u7f6e\u670d\u52a1\u5668\nmongod --configsvr --replSet configs --port 27019 --dbpath /data/configdb\n\n# \u542f\u52a8\u8def\u7531\u670d\u52a1\u5668\nmongos --configdb configs/&lt;config_srv1&gt;:27019,&lt;config_srv2&gt;:27019,&lt;config_srv3&gt;:27019 --port 27017\n\n# \u542f\u52a8\u5206\u7247\u670d\u52a1\u5668\nmongod --shardsvr --replSet shard1 --port 27018 --dbpath /data/shard1\n</code></pre>"},{"location":"mongodb/sharding/#2","title":"2. \u6dfb\u52a0\u5206\u7247","text":"<pre><code># \u8fde\u63a5\u5230\u8def\u7531\u670d\u52a1\u5668\nmongo localhost:27017\n\n# \u6dfb\u52a0\u5206\u7247\nsh.addShard(\"shard1/host1:27018,host2:27018\")\nsh.addShard(\"shard2/host3:27018,host4:27018\")\n</code></pre>"},{"location":"mongodb/sharding/#3_1","title":"3. \u542f\u7528\u6570\u636e\u5e93\u5206\u7247","text":"<pre><code>// \u542f\u7528\u6570\u636e\u5e93\u5206\u7247\nsh.enableSharding(\"databaseName\");\n\n// \u8bbe\u7f6e\u5206\u7247\u952e\nsh.shardCollection(\"databaseName.collectionName\", { fieldName: 1 });\n</code></pre>"},{"location":"mongodb/sharding/#_5","title":"\u5206\u7247\u952e\u9009\u62e9","text":""},{"location":"mongodb/sharding/#_6","title":"\u597d\u7684\u5206\u7247\u952e\u7279\u5f81","text":"<ul> <li>\u8db3\u591f\u57fa\u6570\u4ee5\u652f\u6301\u6570\u636e\u5206\u53d1</li> <li>\u6392\u9664\u4f4e\u57fa\u6570\u5b57\u6bb5\uff08\u5982\u6027\u522b\uff09</li> <li>\u907f\u514d\u5355\u8c03\u5b57\u6bb5\uff08\u65f6\u95f4\u6233\uff09\u9632\u6b62\u70ed\u70b9</li> <li>\u67e5\u8be2\u6a21\u5f0f\u5339\u914d</li> </ul>"},{"location":"mongodb/sharding/#_7","title":"\u590d\u5408\u5206\u7247\u952e","text":"<pre><code>// \u521b\u5efa\u590d\u5408\u5206\u7247\u952e\nsh.shardCollection(\"users\", { userId: 1, region: 1 });\n\n// \u987a\u5e8f\u5f88\u91cd\u8981\uff0c\u7b2c\u4e00\u4e2a\u952e\u51b3\u5b9a\u5757\u8fb9\u754c\n</code></pre>"},{"location":"mongodb/sharding/#_8","title":"\u7ba1\u7406\u5206\u7247\u96c6\u7fa4","text":""},{"location":"mongodb/sharding/#1_2","title":"1. \u68c0\u67e5\u5206\u7247\u72b6\u6001","text":"<pre><code>// \u663e\u793a\u96c6\u7fa4\u72b6\u6001\nsh.status();\n\n// \u663e\u793a\u5206\u7247\u4fe1\u606f\ndb.printShardingStatus();\n\n// \u67e5\u770b\u96c6\u5408\u5206\u7247\u7edf\u8ba1\ndb.collection.stats();\n</code></pre>"},{"location":"mongodb/sharding/#2_1","title":"2. \u8fc1\u79fb\u5757\u6570\u636e","text":"<pre><code>// \u68c0\u67e5\u5757\u4fe1\u606f\ndb.getSiblingDB(\"config\").chunks.findOne();\n\n// \u5e73\u8861\u5668\u72b6\u6001\nsh.setBalancerState(false); // \u5173\u95ed\u5e73\u8861\u5668\nsh.setBalancerState(true); // \u542f\u7528\u5e73\u8861\u5668\n</code></pre>"},{"location":"mongodb/sharding/#3_2","title":"3. \u589e\u52a0\u5bb9\u91cf","text":"<pre><code># \u6dfb\u52a0\u65b0\u5206\u7247\nsh.addShard(\"new-shard-host:27018\")\n\n# \u68c0\u67e5\u5206\u7247\u5217\u8868\nsh.getShardList()\n</code></pre>"},{"location":"mongodb/sharding/#_9","title":"\u76d1\u63a7\u4e0e\u8c03\u4f18","text":""},{"location":"mongodb/sharding/#1_3","title":"1. \u5173\u952e\u6307\u6807","text":"<ul> <li>\u96c6\u7fa4 CPU \u4f7f\u7528\u7387</li> <li>\u5185\u5b58\u4f7f\u7528\u60c5\u51b5</li> <li>\u78c1\u76d8 I/O</li> <li>\u7f51\u7edc\u5ef6\u8fdf</li> <li>\u5e73\u8861\u72b6\u6001</li> </ul>"},{"location":"mongodb/sharding/#2_2","title":"2. \u5206\u7247\u64cd\u4f5c\u67e5\u8be2","text":"<pre><code>// \u67e5\u8be2\u547d\u4e2d\u5355\u4e00\u5206\u7247\uff08\u6700\u4f18\uff09\ndb.orders.find({ userId: ObjectId(\"...\") });\n\n// \u67e5\u8be2\u9700\u8981\u8def\u7531\u5230\u591a\u4e2a\u5206\u7247\ndb.orders.find({ category: \"Electronics\" });\n</code></pre>"},{"location":"mongodb/sharding/#_10","title":"\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"mongodb/sharding/#_11","title":"\u5206\u533a\u503e\u659c\u89e3\u51b3\u65b9\u6cd5","text":"<ol> <li>\u68c0\u67e5\u5206\u7247\u952e\u5206\u5e03</li> <li>\u8003\u8651\u91cd\u65b0\u5206\u7247\u7b56\u7565</li> <li>\u4f7f\u7528 Zone Sharding</li> </ol>"},{"location":"mongodb/sharding/#_12","title":"\u9650\u5236\u8bf4\u660e","text":"<ul> <li>\u5206\u7247\u952e\u4e00\u65e6\u8bbe\u7f6e\u65e0\u6cd5\u4fee\u6539</li> <li>\u4e0d\u80fd\u5728\u5df2\u5206\u7247\u7684\u96c6\u5408\u4e0a\u8bbe\u7f6e\u5206\u7247\u952e</li> <li>\u5206\u7247\u4ec5\u652f\u6301\u5355\u4e2a\u96c6\u5408\u7684\u552f\u4e00\u7d22\u5f15</li> </ul>"},{"location":"mongodb/sharding/#_13","title":"\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li>\u542f\u52a8\u5206\u7247\u524d\u8fdb\u884c\u538b\u529b\u6d4b\u8bd5</li> <li>\u76d1\u63a7\u5757\u5206\u914d\u60c5\u51b5</li> <li>\u8ba1\u5212\u505c\u673a\u7a97\u53e3\u7ef4\u62a4\u5e73\u8861</li> <li>\u6b63\u786e\u9009\u62e9\u5206\u7247\u952e\u51cf\u5c11\u6570\u636e\u8fc1\u79fb</li> <li>\u4f7f\u7528\u590d\u5236\u96c6\u4f5c\u4e3a\u5206\u7247\u786e\u4fdd\u9ad8\u53ef\u7528</li> </ol>"},{"location":"monitor/exporter/","title":"\u76d1\u63a7 Exporter","text":""},{"location":"monitor/exporter/#_1","title":"\u6982\u8ff0","text":"<p>Exporter \u662f\u7528\u4e8e\u5c06\u5176\u4ed6\u7cfb\u7edf\u7684\u6307\u6807\u8f6c\u6362\u4e3a Prometheus \u683c\u5f0f\u7684\u670d\u52a1\u6216\u811a\u672c\u3002\u5b83\u4eec\u63d0\u4f9b\u4e00\u4e2a HTTP \u7aef\u70b9\uff08\u901a\u5e38\u662f <code>/metrics</code>\uff09\uff0cPrometheus \u53ef\u4ee5\u4ece\u8be5\u7aef\u70b9\u6293\u53d6\u6307\u6807\u6570\u636e\u3002Exporters \u4f7f Prometheus \u80fd\u591f\u76d1\u63a7\u539f\u672c\u4e0d\u652f\u6301 Prometheus \u534f\u8bae\u7684\u7cfb\u7edf\u3002</p>"},{"location":"monitor/exporter/#exporter_1","title":"\u5e38\u7528 Exporter","text":""},{"location":"monitor/exporter/#1-node-exporter","title":"1. Node Exporter","text":"<p>Node Exporter \u63d0\u4f9b\u4e86\u57fa\u672c\u7684\u786c\u4ef6\u548c\u64cd\u4f5c\u7cfb\u7edf\u6307\u6807\u3002</p>"},{"location":"monitor/exporter/#_2","title":"\u90e8\u7f72","text":"<p>\u4e8c\u8fdb\u5236\u65b9\u5f0f\uff1a</p> <pre><code># \u4e0b\u8f7d\u5e76\u89e3\u538b\nwget https://github.com/prometheus/node_exporter/releases/download/v1.6.1/node_exporter-1.6.1.linux-amd64.tar.gz\ntar -xzf node_exporter-1.6.1.linux-amd64.tar.gz\ncd node_exporter-1.6.1.linux-amd64\n\n# \u8fd0\u884c\n./node_exporter\n</code></pre> <p>Docker \u65b9\u5f0f\uff1a</p> <pre><code>docker run -d \\\n  --name=node-exporter \\\n  --net=\"host\" \\\n  --pid=\"host\" \\\n  -v \"/:/host:ro,rslave\" \\\n  quay.io/prometheus/node-exporter:latest \\\n  --path.rootfs=/host\n</code></pre> <p>Systemd \u670d\u52a1\u6587\u4ef6:</p> <pre><code>[Unit]\nDescription=Node Exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=node_exporter\nGroup=node_exporter\nType=simple\nExecStart=/usr/local/bin/node_exporter \\\n    --collector.systemd \\\n    --collector.processes \\\n    --collector.filesystem.ignored-mount-points=\"^(/(sys|proc|dev|run)($|/))|^(.+\\\\.(txt|log|pid|sock|socket)$)\"\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"monitor/exporter/#_3","title":"\u6838\u5fc3\u6307\u6807","text":"<ul> <li><code>node_cpu_seconds_total</code>\uff1aCPU \u4f7f\u7528\u65f6\u95f4</li> <li><code>node_memory_MemTotal_bytes</code>\uff1a\u603b\u5185\u5b58</li> <li><code>node_memory_MemFree_bytes</code>\uff1a\u7a7a\u95f2\u5185\u5b58</li> <li><code>node_disk_reads_completed_total</code>\uff1a\u78c1\u76d8\u8bfb\u53d6\u6b21\u6570</li> <li><code>node_filesystem_size_bytes</code>\uff1a\u6587\u4ef6\u7cfb\u7edf\u5927\u5c0f</li> </ul>"},{"location":"monitor/exporter/#2-mysql-exporter","title":"2. MySQL Exporter","text":"<p>MySQL Exporter \u6536\u96c6 MySQL \u6570\u636e\u5e93\u670d\u52a1\u5668\u7684\u6307\u6807\u3002</p>"},{"location":"monitor/exporter/#_4","title":"\u914d\u7f6e","text":"<p>\u5b89\u88c5\u548c\u542f\u52a8\uff1a</p> <pre><code># \u4e8c\u8fdb\u5236\u5b89\u88c5\nwget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.0/mysqld_exporter-0.15.0.linux-amd64.tar.gz\ntar -xzf mysqld_exporter-0.15.0.linux-amd64.tar.gz\ncd mysqld_exporter-0.15.0.linux-amd64\n./mysqld_exporter --config.my-cnf=/etc/.my.cnf\n</code></pre> <p>\u6570\u636e\u5e93\u914d\u7f6e (<code>.my.cnf</code>):</p> <pre><code>[client]\nuser = prometheus\npassword = prometheus_password\nhost = localhost\n</code></pre> <p>Docker \u65b9\u5f0f:</p> <pre><code>docker run -d \\\n  --name mysqld-exporter \\\n  -p 9104:9104 \\\n  -e DATA_SOURCE_NAME=\"user:password@(localhost:3306)/\" \\\n  prom/mysqld-exporter\n</code></pre>"},{"location":"monitor/exporter/#_5","title":"\u91cd\u8981\u6307\u6807","text":"<ul> <li><code>mysql_global_status_queries</code>\uff1a\u603b\u67e5\u8be2\u6b21\u6570</li> <li><code>mysql_global_status_connections</code>\uff1a\u8fde\u63a5\u6570</li> <li><code>mysql_global_status_threads_connected</code>\uff1a\u5f53\u524d\u8fde\u63a5\u6570</li> <li><code>mysql_global_variables_innodb_buffer_pool_size</code>\uff1aInnoDB \u7f13\u51b2\u6c60\u5927\u5c0f</li> </ul>"},{"location":"monitor/exporter/#3-redis-exporter","title":"3. Redis Exporter","text":"<p>Redis Exporter \u6536\u96c6 Redis \u670d\u52a1\u5668\u6307\u6807\u3002</p>"},{"location":"monitor/exporter/#_6","title":"\u90e8\u7f72","text":"<p>\u76f4\u63a5\u8fd0\u884c:</p> <pre><code># \u5b89\u88c5\u548c\u542f\u52a8\ndocker run -d \\\n  --name redis-exporter \\\n  -p 9121:9121 \\\n  --env REDIS_ADDR=redis://redis_host:6379 \\\n  oliver006/redis_exporter:latest\n</code></pre> <p>\u7cfb\u7edf\u670d\u52a1:</p> <pre><code># \u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\nwget https://github.com/oliver006/redis_exporter/releases/download/v1.52.0/redis_exporter-v1.52.0.linux-amd64.tar.gz\ntar -xzf redis_exporter-v1.52.0.linux-amd64.tar.gz\n./redis_exporter --redis.addr=redis://redis_host:6379\n</code></pre>"},{"location":"monitor/exporter/#4-blackbox-exporter","title":"4. Blackbox Exporter","text":"<p>\u7528\u4e8e\u9ed1\u76d2\u63a2\u6d4b\uff0c\u53ef\u4ee5\u68c0\u67e5 HTTP\u3001HTTPS\u3001DNS\u3001TCP\u3001ICMP \u7b49\u670d\u52a1\u7684\u53ef\u7528\u6027\u3002</p>"},{"location":"monitor/exporter/#_7","title":"\u914d\u7f6e","text":"<p>\u57fa\u672c\u914d\u7f6e (<code>blackbox.yml</code>):</p> <pre><code>modules:\n  http_2xx:\n    prober: http\n    timeout: 5s\n    http:\n      method: GET\n      no_follow_redirects: false\n      fail_if_ssl: false\n      fail_if_not_ssl: false\n\n  http_post_2xx:\n    prober: http\n    http:\n      method: POST\n      headers:\n        Content-Type: application/json\n      body: {}\n\n  tcp_connect:\n    prober: tcp\n    timeout: 5s\n</code></pre> <p>\u542f\u52a8\u547d\u4ee4:</p> <pre><code>docker run -d \\\n  --name blackbox-exporter \\\n  -p 9115:9115 \\\n  -v $(pwd)/blackbox.yml:/config/blackbox.yml \\\n  prom/blackbox-exporter:latest \\\n  --config.file=/config/blackbox.yml\n</code></pre>"},{"location":"monitor/exporter/#5-jmx-exporter","title":"5. JMX Exporter","text":"<p>\u7528\u4e8e\u6536\u96c6 Java \u5e94\u7528\u7684 JMX \u6307\u6807\uff0c\u9700\u8981\u4f5c\u4e3a Java agent \u5d4c\u5165\u5e94\u7528\u4e2d\u3002</p> <p>Java \u542f\u52a8\u53c2\u6570:</p> <pre><code>java -javaagent:/path/to/jmx_prometheus_httpserver.jar=9404:/path/to/config.yaml YourJavaApp\n</code></pre>"},{"location":"monitor/exporter/#_8","title":"\u9ad8\u7ea7\u914d\u7f6e","text":""},{"location":"monitor/exporter/#_9","title":"\u8ba4\u8bc1\u548c\u5b89\u5168","text":"<pre><code># \u7528\u4e8e\u914d\u7f6e exporter \u7684\u8ba4\u8bc1\u4fe1\u606f\nscrape_configs:\n  - job_name: \"mysql\"\n    static_configs:\n      - targets: [\"localhost:9104\"]\n    basic_auth:\n      username: \"prometheus\"\n      password: \"secret_password\"\n</code></pre>"},{"location":"monitor/exporter/#_10","title":"\u6307\u6807\u91cd\u547d\u540d\u548c\u6807\u7b7e\u5904\u7406","text":"<pre><code>scrape_configs:\n  - job_name: \"node\"\n    static_configs:\n      - targets: [\"localhost:9100\"]\n    metric_relabel_configs:\n      # \u91cd\u547d\u540d\u6307\u6807\n      - source_labels: [__name__]\n        regex: \"node_disk_(.+)\"\n        target_label: job\n        replacement: \"node:disk\"\n      # \u8fc7\u6ee4\u7279\u5b9a\u6807\u7b7e\u503c\n      - source_labels: [mountpoint]\n        regex: \"/(sys|proc|dev|run)\"\n        action: drop\n</code></pre>"},{"location":"monitor/exporter/#exporter_2","title":"\u5f00\u53d1\u81ea\u5b9a\u4e49 Exporter","text":""},{"location":"monitor/exporter/#python-exporter","title":"Python Exporter \u793a\u4f8b","text":"<pre><code>from prometheus_client import start_http_server, Counter\nfrom prometheus_client.core import GaugeMetricFamily, REGISTRY\nimport time\nimport random\n\nclass CustomCollector(object):\n    def collect(self):\n        gauge = GaugeMetricFamily(\"custom_temperature_celsius\", 'Temperature in Celsius', labels=['location'])\n        gauge.add_metric(['server_room'], random.uniform(15, 30))\n        gauge.add_metric(['outside'], random.uniform(0, 40))\n        yield gauge\n\nif __name__ == '__main__':\n    REGISTRY.register(CustomCollector())\n    start_http_server(8000)\n    while True:\n        time.sleep(1)\n</code></pre>"},{"location":"monitor/exporter/#_11","title":"\u5173\u952e\u5f00\u53d1\u8981\u70b9","text":"<ol> <li>\u9075\u5faa Prometheus \u6307\u6807\u547d\u540d\u89c4\u8303 (snake_case)</li> <li>\u6dfb\u52a0\u9002\u5f53\u7684\u63cf\u8ff0\u6027\u6807\u7b7e</li> <li>\u63d0\u4f9b\u6709\u610f\u4e49\u7684\u6307\u6807\u63cf\u8ff0</li> <li>\u4e3a\u6307\u6807\u63d0\u4f9b\u5408\u9002\u7684\u7c7b\u578b (Counter, Gauge, Histogram, Summary)</li> <li>\u6b63\u786e\u5b9e\u73b0\u6307\u6807\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406</li> </ol>"},{"location":"monitor/exporter/#_12","title":"\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li>\u5b89\u5168\u6027: \u914d\u7f6e\u9002\u5f53\u7684\u8ba4\u8bc1\u548c\u6388\u6743</li> <li>\u6027\u80fd: \u5408\u7406\u8bbe\u7f6e\u6293\u53d6\u95f4\u9694\uff0c\u907f\u514d\u8fc7\u5ea6\u76d1\u63a7</li> <li>\u53ef\u6269\u5c55\u6027: \u5728\u9ad8\u8d1f\u8f7d\u60c5\u51b5\u4e0b\u4f7f\u7528\u670d\u52a1\u53d1\u73b0</li> <li>\u7a33\u5b9a\u6027: \u5b9e\u65bd\u5065\u5eb7\u68c0\u67e5\u548c\u544a\u8b66</li> <li>\u6587\u6863: \u7ef4\u62a4\u8be6\u7ec6\u7684\u6307\u6807\u5b57\u5178\u548c\u7528\u9014\u8bf4\u660e</li> </ol> <p>Exporter \u662f\u6574\u4e2a\u76d1\u63a7\u751f\u6001\u7684\u91cd\u8981\u4e00\u73af\uff0c\u5b83\u4eec\u4f7f Prometheus \u80fd\u591f\u76d1\u63a7\u5e7f\u6cdb\u7684\u7cfb\u7edf\u3002\u6b63\u786e\u90e8\u7f72\u548c\u914d\u7f6e Exporter \u662f\u6784\u5efa\u5168\u9762\u53ef\u89c2\u6d4b\u6027\u89e3\u51b3\u65b9\u6848\u7684\u5173\u952e\u6b65\u9aa4\u3002</p>"},{"location":"monitor/grafana/","title":"Grafana \u76d1\u63a7\u53ef\u89c6\u5316","text":""},{"location":"monitor/grafana/#_1","title":"\u6982\u8ff0","text":"<p>Grafana \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5ea6\u91cf\u5206\u6790\u548c\u53ef\u89c6\u5316\u5957\u4ef6\uff0c\u53ef\u4ee5\u5c06\u5404\u79cd\u65f6\u5e8f\u6570\u636e\u5e93\uff08\u5982 Prometheus\u3001InfluxDB\u3001Elasticsearch \u7b49\uff09\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u56fe\u5f62\u5316\u5c55\u793a\u3002\u5176\u5f3a\u5927\u7684\u4eea\u8868\u677f\u529f\u80fd\u4f7f\u5f97\u6307\u6807\u76d1\u63a7\u53d8\u5f97\u76f4\u89c2\u6613\u61c2\u3002</p>"},{"location":"monitor/grafana/#_2","title":"\u5b89\u88c5\u548c\u914d\u7f6e","text":""},{"location":"monitor/grafana/#1-grafana","title":"1. \u5b89\u88c5 Grafana","text":""},{"location":"monitor/grafana/#ubuntudebian","title":"Ubuntu/Debian \u7cfb\u7edf\uff1a","text":"<pre><code># \u4f7f\u7528APT\u4ed3\u5e93\u5b89\u88c5\uff08\u63a8\u8350\u65b9\u5f0f\uff09\nsudo apt-get install -y software-properties-common\nsudo add-apt-repository \"deb https://packages.grafana.com/oss/deb stable main\"\nwget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -\nsudo apt-get update\nsudo apt-get install grafana\n\n# \u542f\u52a8 Grafana \u670d\u52a1\nsudo systemctl daemon-reload\nsudo systemctl start grafana-server\nsudo systemctl enable grafana-server\n</code></pre>"},{"location":"monitor/grafana/#centosrhel","title":"CentOS/RHEL \u7cfb\u7edf\uff1a","text":"<pre><code># \u6dfb\u52a0 YUM repository\nsudo tee -a /etc/yum.repos.d/grafana.repo &lt;&lt;EOF\n[grafana]\nname=grafana\nbaseurl=https://packages.grafana.com/oss/rpm\nrepo_gpgcheck=1\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.grafana.com/gpg.key\nsslverify=1\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt\nEOF\n\n# \u5b89\u88c5\u5e76\u542f\u52a8\nsudo dnf install grafana\nsudo systemctl daemon-reload\nsudo systemctl start grafana-server\nsudo systemctl enable grafana-server\n</code></pre>"},{"location":"monitor/grafana/#docker","title":"Docker \u5b89\u88c5\u65b9\u5f0f\uff1a","text":"<pre><code># \u8fd0\u884c\u6700\u65b0\u7248 Grafana\ndocker run -d -p 3000:3000 --name=grafana grafana/grafana-enterprise\n\n# \u6301\u4e45\u5316\u6570\u636e\u7684\u8fd0\u884c\u65b9\u5f0f\ndocker run -d \\\n  -p 3000:3000 \\\n  --name=grafana \\\n  -v grafana-storage:/var/lib/grafana \\\n  grafana/grafana-enterprise\n</code></pre>"},{"location":"monitor/grafana/#2","title":"2. \u57fa\u7840\u914d\u7f6e","text":""},{"location":"monitor/grafana/#grafana-web","title":"\u8bbf\u95ee Grafana Web \u754c\u9762","text":"<p>\u9ed8\u8ba4\u8bbf\u95ee\u5730\u5740: <code>http://localhost:3000</code> \u9ed8\u8ba4\u7528\u6237\u540d/\u5bc6\u7801: <code>admin/admin</code></p> <p>\u9996\u6b21\u767b\u5f55\u4f1a\u88ab\u5f3a\u5236\u4fee\u6539\u5bc6\u7801\u3002</p>"},{"location":"monitor/grafana/#_3","title":"\u5e38\u7528\u914d\u7f6e\u9009\u9879","text":"<p>\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e <code>/etc/grafana/grafana.ini</code>\uff1a</p> <pre><code>[server]\n# \u57fa\u7840\u914d\u7f6e\nhttp_addr = 0.0.0.0\nhttp_port = 3000\ndomain = localhost\n\n[security]\n# \u7ba1\u7406\u5458\u5bc6\u7801 (\u9996\u6b21\u8fd0\u884c\u65f6)\nadmin_user = admin\nadmin_password = your_secure_password\n\n[database]\n# Grafana \u81ea\u8eab\u6570\u636e\u5e93 (\u652f\u6301 SQLite3, MySQL, PostgreSQL)\ntype = sqlite3\npath = grafana.db\n\n[auth.anonymous]\n# \u542f\u7528\u533f\u540d\u8bbf\u95ee\nenabled = false\n\n[users]\n# \u65b0\u7528\u6237\u6ce8\u518c\nallow_sign_up = false\nauto_assign_org_role = Viewer\n</code></pre>"},{"location":"monitor/grafana/#_4","title":"\u6570\u636e\u6e90\u914d\u7f6e","text":""},{"location":"monitor/grafana/#1-prometheus","title":"1. \u914d\u7f6e Prometheus \u6570\u636e\u6e90","text":"<p>\u8bbf\u95ee\u8def\u5f84\uff1aConfiguration \u2192 Data Sources \u2192 Add data source \u2192 Prometheus</p> <p>\u57fa\u672c\u914d\u7f6e\u9879\uff1a</p> <pre><code>{\n  \"name\": \"Prometheus\",\n  \"type\": \"prometheus\",\n  \"url\": \"http://localhost:9090\",\n  \"access\": \"proxy\",\n  \"basicAuth\": false,\n  \"isDefault\": true\n}\n</code></pre> <p>\u9ad8\u7ea7\u914d\u7f6e\uff1a</p> <ul> <li>HTTP Access: proxy\uff08\u4ee3\u7406\u6a21\u5f0f\uff0c\u66f4\u5b89\u5168\uff09</li> <li>Scrape interval: \u6570\u636e\u91c7\u96c6\u95f4\u9694</li> <li>Custom query params: \u81ea\u5b9a\u4e49\u67e5\u8be2\u53c2\u6570</li> </ul>"},{"location":"monitor/grafana/#2_1","title":"2. \u5176\u4ed6\u6570\u636e\u6e90","text":"<p>Grafana \u8fd8\u652f\u6301\u8bb8\u591a\u5176\u4ed6\u6570\u636e\u6e90\uff1a</p> <ul> <li>InfluxDB</li> <li>Elasticsearch</li> <li>Graphite</li> <li>MySQL / PostgreSQL</li> <li>AWS CloudWatch</li> <li>Azure Monitor</li> </ul>"},{"location":"monitor/grafana/#_5","title":"\u4eea\u8868\u677f\u521b\u5efa\u4e0e\u7ba1\u7406","text":""},{"location":"monitor/grafana/#1","title":"1. \u4eea\u8868\u677f\u521b\u5efa","text":"<p>\u521b\u5efa\u65b0\u4eea\u8868\u677f\u7684\u65b9\u5f0f\uff1a</p> <ol> <li>\u70b9\u51fb\u4fa7\u8fb9\u680f + \u56fe\u6807 \u2192 Dashboard</li> <li>\u901a\u8fc7\u5bfc\u5165\u9884\u8bbe\u9762\u677f\uff1aDashboard \u2192 Import</li> <li>\u4f7f\u7528 Grafana \u793e\u533a\u9762\u677f ID \u6216 JSON \u914d\u7f6e</li> </ol>"},{"location":"monitor/grafana/#2_2","title":"2. \u9762\u677f\u914d\u7f6e","text":"<p>\u6bcf\u4e2a\u9762\u677f\u7684\u57fa\u672c\u7ec4\u6210\uff1a</p> <ul> <li>Query Editor: \u5b9a\u4e49\u4ece\u6570\u636e\u6e90\u83b7\u53d6\u6570\u636e\u7684\u65b9\u5f0f</li> <li>Visualization: \u9762\u677f\u663e\u793a\u6837\u5f0f\uff08\u56fe\u8868\u3001\u6570\u503c\u3001\u6587\u672c\u7b49\uff09</li> <li>Panel Options: \u6837\u5f0f\u548c\u4ea4\u4e92\u914d\u7f6e</li> </ul>"},{"location":"monitor/grafana/#_6","title":"\u57fa\u7840\u9762\u677f\u7c7b\u578b\uff1a","text":"<p>Graph Panel (\u56fe\u8868\u9762\u677f)</p> <ul> <li>\u65f6\u5e8f\u66f2\u7ebf\u56fe</li> <li>\u5305\u542b\u591a\u7cfb\u5217\u6570\u636e\u5bf9\u6bd4</li> <li>\u652f\u6301\u5404\u79cd\u7edf\u8ba1\u51fd\u6570</li> </ul> <p>SingleStat Panel (\u6570\u503c\u9762\u677f)</p> <ul> <li>\u663e\u793a\u5355\u4e2a\u805a\u5408\u6570\u503c</li> <li>\u53ef\u914d\u7f6e\u9608\u503c\u548c\u989c\u8272</li> <li>\u5c55\u793a\u5f53\u524d\u72b6\u6001</li> </ul> <p>Table Panel (\u8868\u683c\u9762\u677f)</p> <ul> <li>\u4ee5\u8868\u683c\u5f62\u5f0f\u5c55\u793a\u6570\u636e</li> <li>\u53ef\u6392\u5e8f\u548c\u7b5b\u9009</li> <li>\u652f\u6301\u591a\u79cd\u5217\u683c\u5f0f</li> </ul>"},{"location":"monitor/grafana/#3","title":"3. \u67e5\u8be2\u7f16\u8f91","text":"<p>\u4f7f\u7528 Prometheus \u67e5\u8be2\u8bed\u6cd5\u8fdb\u884c\u6570\u636e\u63d0\u53d6\uff1a</p> <pre><code># \u7b80\u5355\u8ba1\u6570\u67e5\u8be2\nprometheus_http_requests_total\n\n# \u4f7f\u7528\u805a\u5408\u51fd\u6570\nsum by (method) (prometheus_http_requests_total)\n\n# \u8ba1\u7b97\u589e\u957f\u7387\nincrease(prometheus_http_requests_total[5m])\n\n# 5\u5206\u949f\u79fb\u52a8\u5e73\u5747\nrate(prometheus_http_requests_total[5m])\n</code></pre>"},{"location":"monitor/grafana/#_7","title":"\u53d8\u91cf\u548c\u6a21\u677f\u5316","text":""},{"location":"monitor/grafana/#1_1","title":"1. \u5b9a\u4e49\u6a21\u677f\u53d8\u91cf","text":"<p>\u8def\u5f84\uff1aDashboard Settings \u2192 Variables</p> <p>\u5e38\u7528\u53d8\u91cf\u7c7b\u578b\uff1a</p> <pre><code># \u67e5\u8be2\u53d8\u91cf\uff08Query\uff09: \u4ece\u6570\u636e\u6e90\u52a8\u6001\u83b7\u53d6\u9009\u9879\nLabel names\nLabel values\n\n# \u81ea\u5b9a\u4e49\u53d8\u91cf (Custom): \u624b\u52a8\u8f93\u5165\u56fa\u5b9a\u9009\u9879\nus-east-1, us-west-1, us-west-2\n\n# \u6587\u672c\u6846 (Text box): \u624b\u52a8\u8f93\u5165\u503c\n</code></pre>"},{"location":"monitor/grafana/#2_3","title":"2. \u4f7f\u7528\u53d8\u91cf","text":"<p>\u5728\u67e5\u8be2\u4e2d\u4f7f\u7528\u53d8\u91cf\uff1a</p> <pre><code># \u4f7f\u7528\u53d8\u91cf\u66ff\u6362\nnode_cpu_seconds_total{job=\"$job\", instance=\"$instance\"}\n</code></pre>"},{"location":"monitor/grafana/#3_1","title":"3. \u53d8\u91cf\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>Name: \"job\"\nType: Query\nData Source: Prometheus\nQuery: label_values(job)\nRegex: (?!node_exporter_service_discovery)()\nRefresh: On Dashboard Load\n</code></pre>"},{"location":"monitor/grafana/#_8","title":"\u544a\u8b66\u914d\u7f6e","text":""},{"location":"monitor/grafana/#1_2","title":"1. \u521b\u5efa\u544a\u8b66\u89c4\u5219","text":"<p>\u5728 Grafana 8.0+ \u4e2d\uff0c\u544a\u8b66\u901a\u8fc7 Alerting \u83dc\u5355\u914d\u7f6e\u3002</p> <p>\u544a\u8b66\u67e5\u8be2\u914d\u7f6e\uff1a</p> <pre><code># CPU \u4f7f\u7528\u7387 &gt; 80%\n100 - (avg by(instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100) &gt; 80\n</code></pre> <p>\u544a\u8b66\u6761\u4ef6\uff1a</p> <ul> <li>Evaluate every: \u8bc4\u4f30\u9891\u7387</li> <li>For: \u6301\u7eed\u65f6\u95f4\u9608\u503c</li> <li>Condition: \u67e5\u8be2\u6761\u4ef6\u8868\u8fbe\u5f0f</li> </ul>"},{"location":"monitor/grafana/#2_4","title":"2. \u901a\u77e5\u6e20\u9053","text":"<p>\u901a\u77e5\u6e20\u9053\u7c7b\u578b\uff1a</p> <ul> <li>Email</li> <li>Slack</li> <li>PagerDuty</li> <li>Webhook</li> <li>Discord</li> </ul> <p>\u901a\u77e5\u6a21\u677f\u5305\u542b\uff1a</p> <ul> <li>Alert name</li> <li>Firing alerts</li> <li>Rule info</li> <li>Dashboard &amp; panel links</li> </ul>"},{"location":"monitor/grafana/#_9","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"monitor/grafana/#1_3","title":"1. \u9762\u677f\u8bbe\u8ba1\u6700\u4f73\u5b9e\u8df5","text":"<p>\u5c42\u6b21\u7ed3\u6784</p> <ul> <li>\u9ad8\u5ea6\u6982\u62ec\u5728\u4e0a\u65b9\uff08\u7cfb\u7edf\u72b6\u6001\uff09</li> <li>\u8be6\u7ec6\u6307\u6807\u5728\u4e0b\u65b9\uff08\u7ec4\u4ef6\u7ec6\u8282\uff09</li> <li>\u544a\u8b66\u4fe1\u606f\u663e\u773c\u4f4d\u7f6e</li> </ul> <p>\u989c\u8272\u4f7f\u7528</p> <ul> <li>\u544a\u8b66\u8272\uff1a\u7ea2\u8272 (\u9519\u8bef)\u3001\u9ec4\u8272 (\u8b66\u544a)\u3001\u7eff\u8272 (\u6b63\u5e38)</li> <li>\u4fdd\u6301\u989c\u8272\u542b\u4e49\u4e00\u81f4</li> </ul>"},{"location":"monitor/grafana/#2_5","title":"2. \u6027\u80fd\u4f18\u5316","text":"<ul> <li>\u9650\u5236\u65f6\u95f4\u8303\u56f4\u907f\u514d\u52a0\u8f7d\u8fc7\u591a\u6570\u636e</li> <li>\u4f7f\u7528\u9002\u5f53\u7684\u91c7\u6837\u9891\u7387</li> <li>\u63a7\u5236\u9762\u677f\u6570\u91cf (\u63a8\u8350\u5355\u9875\u5c11\u4e8e 12 \u4e2a\u9762\u677f)</li> <li>\u542f\u7528\u7f13\u5b58\u529f\u80fd</li> </ul>"},{"location":"monitor/grafana/#3_2","title":"3. \u544a\u8b66\u7b56\u7565","text":"<ul> <li>\u907f\u514d\u8fc7\u5ea6\u544a\u8b66\uff0c\u5173\u6ce8\u771f\u6b63\u91cd\u8981\u7684\u6307\u6807</li> <li>\u4f7f\u7528\u5408\u9002\u7684\u8bc4\u4f30\u95f4\u9694\uff0c\u907f\u514d\u9891\u7e41\u6296\u52a8</li> <li>\u5b9e\u73b0\u6709\u6548\u7684\u544a\u8b66\u5206\u7ea7 (Warning/Critical)</li> <li>\u5b9a\u4e49\u6e05\u6670\u7684\u544a\u8b66\u63a5\u6536\u6d41\u7a0b</li> </ul>"},{"location":"monitor/grafana/#_10","title":"\u9ad8\u7ea7\u529f\u80fd","text":""},{"location":"monitor/grafana/#1_4","title":"1. \u7ba1\u7406\u548c\u7528\u6237\u6743\u9650","text":"<p>Grafana \u652f\u6301\u89d2\u8272\u57fa\u7840\u8bbf\u95ee\u63a7\u5236 (RBAC)\uff1a</p> <ul> <li>Admin: \u5b8c\u5168\u6743\u9650</li> <li>Editor: \u7f16\u8f91\u6743\u9650</li> <li>Viewer: \u53ea\u8bfb\u6743\u9650</li> </ul>"},{"location":"monitor/grafana/#2_6","title":"2. \u5feb\u7167\u529f\u80fd","text":"<ul> <li>\u5171\u4eab\u5b9e\u65f6\u6570\u636e\u72b6\u6001</li> <li>\u8bbe\u7f6e\u5230\u671f\u65f6\u95f4</li> <li>\u9650\u5236\u8bbf\u95ee\uff08\u53d7\u4fdd\u62a4\u7684\u5feb\u7167\uff09</li> </ul>"},{"location":"monitor/grafana/#3_3","title":"3. \u62a5\u544a\u529f\u80fd","text":"<p>\u5b9a\u65f6\u53d1\u9001 PNG \u6216 PDF \u683c\u5f0f\u7684\u4eea\u8868\u677f\u62a5\u544a</p> <ul> <li>\u8bbe\u7f6e\u62a5\u544a\u95f4\u9694</li> <li>\u9009\u62e9\u4eea\u8868\u677f\u548c\u65f6\u95f4\u8303\u56f4</li> <li>\u81ea\u5b9a\u4e49\u6536\u4ef6\u4eba</li> </ul> <p>Grafana \u662f\u76ee\u524d\u4e3b\u6d41\u7684\u76d1\u63a7\u53ef\u89c6\u5316\u89e3\u51b3\u65b9\u6848\u4e4b\u4e00\uff0c\u4e0e\u5176\u4ed6\u76d1\u63a7\u7cfb\u7edf\u7ec4\u5408\u4f7f\u7528\u53ef\u4ee5\u5b9e\u73b0\u5b8c\u5584\u7684\u53ef\u89c2\u6d4b\u6027\u4f53\u7cfb\u3002\u5728\u4f01\u4e1a\u90e8\u7f72\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u5b89\u5168\u914d\u7f6e\uff0c\u5305\u62ec\u8ba4\u8bc1\u3001\u6743\u9650\u63a7\u5236\u548c\u7f51\u7edc\u8bbf\u95ee\u9650\u5236\u7b49\u3002</p>"},{"location":"monitor/metrics/","title":"\u76d1\u63a7\u6307\u6807","text":""},{"location":"monitor/metrics/#_2","title":"\u6982\u8ff0","text":"<p>\u76d1\u63a7\u6307\u6807 (Metrics) \u662f\u5bf9\u7cfb\u7edf\u6027\u80fd\u3001\u8fd0\u884c\u72b6\u6001\u3001\u4e1a\u52a1\u6d3b\u52a8\u7b49\u65b9\u9762\u7684\u91cf\u5316\u5ea6\u91cf\u3002\u901a\u8fc7\u6536\u96c6\u3001\u5206\u6790\u548c\u5c55\u793a\u8fd9\u4e9b\u6307\u6807\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u7cfb\u7edf\u7684\u53ef\u89c2\u6d4b\u6027\uff0c\u5e2e\u52a9\u5feb\u901f\u53d1\u73b0\u548c\u89e3\u51b3\u95ee\u9898\u3002</p>"},{"location":"monitor/metrics/#_3","title":"\u6307\u6807\u7c7b\u578b","text":""},{"location":"monitor/metrics/#1-counter","title":"1. Counter\uff08\u8ba1\u6570\u5668\uff09","text":"<p>Counter \u662f\u5355\u8c03\u9012\u589e\u7684\u6307\u6807\uff0c\u5176\u503c\u53ea\u80fd\u9012\u589e\u6216\u91cd\u7f6e\u4e3a\u96f6\uff0c\u4e0d\u80fd\u51cf\u5c11\u3002</p> <p>\u9002\u7528\u573a\u666f:</p> <ul> <li>\u8bf7\u6c42\u603b\u6570</li> <li>\u9519\u8bef\u6570</li> <li>\u5df2\u5904\u7406\u7684\u4efb\u52a1\u6570</li> </ul> <p>Prometheus \u793a\u4f8b:</p> <pre><code># \u7d2f\u8ba1\u8bf7\u6c42\u603b\u6570\nhttp_requests_total{method=\"GET\", path=\"/users\", status=\"200\"} 500\nhttp_requests_total{method=\"GET\", path=\"/users\", status=\"404\"} 12\nhttp_requests_total{method=\"POST\", path=\"/users\", status=\"201\"} 55\n\n# \u7d2f\u8ba1\u5904\u7406\u7684\u4e8b\u4ef6\u6570\nprocessed_events_total 834213\n</code></pre> <p>\u4f7f\u7528\u5efa\u8bae:</p> <ul> <li>\u8bb0\u5f55\u7d2f\u79ef\u503c\u800c\u4e0d\u662f\u5f53\u524d\u503c</li> <li>\u4e0d\u9002\u7528\u4e8e\u53ef\u80fd\u51cf\u5c0f\u7684\u6570\u503c\uff08\u5982\u5f53\u524d\u6d3b\u8dc3\u7528\u6237\u6570\uff09</li> </ul>"},{"location":"monitor/metrics/#2-gauge","title":"2. Gauge\uff08\u4eea\u8868\u76d8\uff09","text":"<p>Gauge \u662f\u53ef\u4ee5\u4efb\u610f\u589e\u51cf\u7684\u6307\u6807\uff0c\u53cd\u6620\u5f53\u524d\u77ac\u65f6\u72b6\u6001\u3002</p> <p>\u9002\u7528\u573a\u666f:</p> <ul> <li>\u5185\u5b58\u4f7f\u7528\u91cf</li> <li>\u5f53\u524d\u8fde\u63a5\u6570</li> <li>\u6e29\u5ea6\u503c</li> <li>\u7cfb\u7edf\u8d1f\u8f7d</li> </ul> <p>Prometheus \u793a\u4f8b:</p> <pre><code># \u5f53\u524d\u5185\u5b58\u4f7f\u7528\u91cf\uff08\u5b57\u8282\uff09\nprocess_memory_rss_bytes 52428800\n\n# \u5f53\u524d\u5e76\u53d1\u8fde\u63a5\u6570\nhttp_connections_current{direction=\"in\"} 23\n\n# \u4e3b\u673a\u8d1f\u8f7d\nnode_load1 1.54\n\n# \u78c1\u76d8\u4f7f\u7528\u7387\uff08\u767e\u5206\u6bd4\uff09\ndisk_usage_percent{device=\"/dev/sda1\", mountpoint=\"/\"} 64.3\n</code></pre>"},{"location":"monitor/metrics/#3-histogram","title":"3. Histogram\uff08\u76f4\u65b9\u56fe\uff09","text":"<p>Histogram \u8bb0\u5f55\u89c2\u6d4b\u503c\u7684\u5206\u5e03\u60c5\u51b5\uff0c\u5305\u542b\u591a\u4e2a buckets \u6765\u7edf\u8ba1\u4e0d\u540c\u8303\u56f4\u5185\u7684\u89c2\u6d4b\u6b21\u6570\u3002</p> <p>\u9002\u7528\u573a\u666f:</p> <ul> <li>\u8bf7\u6c42\u5ef6\u8fdf\u5206\u5e03</li> <li>\u54cd\u5e94\u65f6\u95f4</li> <li>\u67e5\u8be2\u5904\u7406\u65f6\u95f4</li> </ul> <p>Prometheus \u793a\u4f8b:</p> <pre><code># API \u8bf7\u6c42\u5ef6\u8fdf\u5206\u5e03\uff08\u79d2\uff09\napi_request_duration_seconds_bucket{le=\"0.005\", method=\"GET\", path=\"/users\"} 0\napi_request_duration_seconds_bucket{le=\"0.01\", method=\"GET\", path=\"/users\"} 3\napi_request_duration_seconds_bucket{le=\"0.025\", method=\"GET\", path=\"/users\"} 7\napi_request_duration_seconds_bucket{le=\"0.05\", method=\"GET\", path=\"/users\"} 9\napi_request_duration_seconds_bucket{le=\"0.1\", method=\"GET\", path=\"/users\"} 10\napi_request_duration_seconds_bucket{le=\"0.25\", method=\"GET\", path=\"/users\"} 10\napi_request_duration_seconds_bucket{le=\"0.5\", method=\"GET\", path=\"/users\"} 10\napi_request_duration_seconds_bucket{le=\"1.0\", method=\"GET\", path=\"/users\"} 10\napi_request_duration_seconds_bucket{le=\"+Inf\", method=\"GET\", path=\"/users\"} 10\napi_request_duration_seconds_sum{method=\"GET\", path=\"/users\"} 0.158\napi_request_duration_seconds_count{method=\"GET\", path=\"/users\"} 10\n</code></pre>"},{"location":"monitor/metrics/#4-summary","title":"4. Summary\uff08\u6458\u8981\uff09","text":"<p>Summary \u7c7b\u4f3c Histogram\uff0c\u63d0\u4f9b\u89c2\u6d4b\u503c\u7684\u7edf\u8ba1\u6458\u8981\uff0c\u5982\u5206\u4f4d\u6570\u3002</p> <p>\u9002\u7528\u573a\u666f:</p> <ul> <li>\u8ba1\u7b97 P95/P99 \u5ef6\u8fdf</li> <li>\u4e1a\u52a1\u6307\u6807\u7edf\u8ba1</li> <li>\u9608\u503c\u544a\u8b66</li> </ul>"},{"location":"monitor/metrics/#_4","title":"\u7cfb\u7edf\u6307\u6807","text":""},{"location":"monitor/metrics/#cpu","title":"CPU \u6307\u6807","text":"<pre><code># CPU \u4f7f\u7528\u7387\nnode_cpu_usage_percent 73.4\nnode_cpu_user_seconds_total 23450.32\nnode_cpu_system_seconds_total 4531.12\n\n# CPU \u9891\u7387\nnode_cpu_frequency_hertz 2.4e+09\n</code></pre>"},{"location":"monitor/metrics/#_5","title":"\u5185\u5b58\u6307\u6807","text":"<pre><code># \u5185\u5b58\u4f7f\u7528\u60c5\u51b5\nnode_memory_MemTotal_bytes 8.589934592e+09\nnode_memory_MemFree_bytes 1.23865088e+09\nnode_memory_MemAvailable_bytes 2.567430144e+09\nnode_memory_MemUsed_percent 70.1\n</code></pre>"},{"location":"monitor/metrics/#_6","title":"\u78c1\u76d8\u6307\u6807","text":"<pre><code># \u78c1\u76d8 I/O\nnode_disk_read_bytes_total{device=\"sda\"} 1.23e+10\nnode_disk_written_bytes_total{device=\"sda\"} 2.45e+09\nnode_disk_io_time_seconds_total{device=\"sda\"} 345.6\n\n# \u78c1\u76d8\u7a7a\u95f4\nnode_filesystem_size_bytes{mountpoint=\"/\"} 5.36870912e+10\nnode_filesystem_avail_bytes{mountpoint=\"/\"} 1.073741824e+10\nnode_filesystem_usage_percent{mountpoint=\"/\"} 80.0\n</code></pre>"},{"location":"monitor/metrics/#_7","title":"\u7f51\u7edc\u6307\u6807","text":"<pre><code># \u7f51\u7edc\u6d41\u91cf\nnode_network_receive_bytes_total{device=\"eth0\"} 1.844674407370955e+19\nnode_network_transmit_bytes_total{device=\"eth0\"} 1.844674407370955e+19\n\n# \u7f51\u7edc\u8fde\u63a5\nnode_network_tcp_connections 42\nnode_network_tcp_listen{port=\"8080\"} 1\n</code></pre>"},{"location":"monitor/metrics/#_8","title":"\u5e94\u7528\u6307\u6807","text":""},{"location":"monitor/metrics/#http","title":"HTTP \u670d\u52a1\u6307\u6807","text":"<p>\u8bf7\u6c42\u8ba1\u6570\u5668:</p> <pre><code># \u8bf7\u6c42\u603b\u6570\uff0c\u5e26\u6807\u7b7e\u533a\u5206\u65b9\u6cd5\u3001\u8def\u5f84\u548c\u72b6\u6001\nhttp_requests_total{method=\"GET\", path=\"/api/v1/users\", status=\"200\"} 4500\nhttp_requests_total{method=\"POST\", path=\"/api/v1/users\", status=\"201\"} 23\nhttp_requests_total{method=\"PUT\", path=\"/api/v1/users/123\", status=\"404\"} 5\nhttp_requests_total{method=\"GET\", path=\"/api/v1/users\", status=\"500\"} 3\n</code></pre> <p>\u8bf7\u6c42\u65f6\u5ef6:</p> <pre><code># \u5ef6\u8fdf\u76f4\u65b9\u56fe\nhttp_request_duration_seconds_bucket{method=\"GET\", le=\"0.1\"} 845\nhttp_request_duration_seconds_bucket{method=\"GET\", le=\"0.5\"} 945\nhttp_request_duration_seconds_bucket{method=\"GET\", le=\"1.0\"} 985\nhttp_request_duration_seconds_sum{method=\"GET\"} 345.67\nhttp_request_duration_seconds_count{method=\"GET\"} 995\n</code></pre>"},{"location":"monitor/metrics/#_9","title":"\u4e1a\u52a1\u6307\u6807","text":"<p>\u8ba2\u5355\u5904\u7406:</p> <pre><code># \u8ba2\u5355\u76f8\u5173\u8ba1\u6570\u5668\norders_processed_total 2345\norders_canceled_total 45\norders_failed_total 12\n\n# \u8ba2\u5355\u5904\u7406\u65f6\u95f4\norder_processing_duration_seconds_sum 3456.78\norder_processing_duration_seconds_count 2345\n</code></pre> <p>\u652f\u4ed8\u6307\u6807:</p> <pre><code># \u652f\u4ed8\u6210\u529f\u7387\npayments_successful_total 1234\npayments_failed_total 8\npayments_success_rate 0.9936\n\n# \u91d1\u989d\u76f8\u5173\npayment_amount_total_usd 123456.78\n</code></pre>"},{"location":"monitor/metrics/#_10","title":"\u6570\u636e\u5e93\u6307\u6807","text":""},{"location":"monitor/metrics/#mysql","title":"MySQL","text":"<pre><code># \u8fde\u63a5\u6307\u6807\nmysql_global_status_threads_connected 15\nmysql_global_status_threads_running 3\n\n# \u67e5\u8be2\u6307\u6807\nmysql_global_status_queries 2857142\nmysql_global_status_com_select 157890\nmysql_global_status_com_insert 108234\nmysql_global_status_com_update 15678\nmysql_global_status_com_delete 4231\n\n# \u7f13\u51b2\u6c60\nmysql_global_status_innodb_buffer_pool_pages_total 8192\nmysql_global_status_innodb_buffer_pool_pages_free 123\nmysql_global_status_innodb_buffer_pool_read_requests 543210\nmysql_global_status_innodb_buffer_pool_reads 1234\n</code></pre>"},{"location":"monitor/metrics/#redis","title":"Redis","text":"<pre><code># \u8fde\u63a5\u6307\u6807\nredis_connected_clients 23\nredis_connected_slaves 2\n\n# \u547d\u4ee4\u6267\u884c\nredis_commands_processed_total 1234567\nredis_commands_total_by_command{command=\"get\"} 789012\nredis_commands_total_by_command{command=\"set\"} 345678\n\n# \u5185\u5b58\u4f7f\u7528\nredis_memory_used_bytes 1.2e+07\nredis_memory_used_rss_bytes 1.8e+07\nredis_memory_peak_bytes 2.1e+07\n\n# \u6301\u4e45\u5316\nredis_rdb_changes_since_last_save 1234\nredis_rdb_last_save_timestamp_seconds 1633008000\n</code></pre>"},{"location":"monitor/metrics/#_11","title":"\u6307\u6807\u547d\u540d\u89c4\u8303","text":""},{"location":"monitor/metrics/#prometheus","title":"Prometheus \u547d\u540d\u7ea6\u5b9a","text":"<ol> <li>\u547d\u540d\u6a21\u5f0f: <code>namespace_subsystem_name_unit</code></li> <li>\u4f7f\u7528\u4e0b\u5212\u7ebf\u5206\u9694: <code>http_request_duration_seconds</code></li> <li>\u660e\u786e\u5355\u4f4d: <code>_seconds</code>, <code>_bytes</code>, <code>_total</code></li> <li>\u4f7f\u7528\u82f1\u6587: <code>request_duration_seconds</code> \u800c\u4e0d\u662f <code>\u8bf7\u6c42\u8017\u65f6</code></li> </ol>"},{"location":"monitor/metrics/#_12","title":"\u5e38\u7528\u540e\u7f00","text":"<pre><code># \u8ba1\u6570\u5668\u5e38\u7528\u540e\u7f00\n_requests_total\n_errors_total\n_processed_total\n_processed_seconds_total  # \u5bf9\u4e8e\u7d2f\u79ef\u8017\u65f6\n\n# \u6c47\u603b\u6307\u6807\n_duration_seconds_sum\n_duration_seconds_count\n_duration_seconds_bucket\n\n# \u4eea\u8868\u76d8\u5e38\u7528\u540e\u7f00\n_current\n_in_progress\n_usage_percent\n_available_bytes\n</code></pre>"},{"location":"monitor/metrics/#_13","title":"\u6307\u6807\u6536\u96c6\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"monitor/metrics/#1","title":"1. \u9009\u62e9\u5408\u9002\u7684\u6307\u6807\u7c7b\u578b","text":"<ul> <li>\u4f7f\u7528 <code>Counter</code> \u8bb0\u5f55\u7d2f\u79ef\u503c\uff08\u5982\u8bf7\u6c42\u603b\u6570\u3001\u9519\u8bef\u6570\uff09</li> <li>\u4f7f\u7528 <code>Gauge</code> \u8bb0\u5f55\u5f53\u524d\u503c\uff08\u5982\u5185\u5b58\u4f7f\u7528\u3001\u8fde\u63a5\u6570\uff09</li> <li>\u4f7f\u7528 <code>Histogram</code> \u6216 <code>Summary</code> \u8bb0\u5f55\u5206\u5e03\uff08\u5982\u54cd\u5e94\u65f6\u95f4\uff09</li> </ul>"},{"location":"monitor/metrics/#2","title":"2. \u5408\u7406\u8bbe\u7f6e\u6807\u7b7e","text":"<p>\u597d\u7684\u6807\u7b7e\u8bbe\u8ba1:</p> <pre><code># \u53ef\u4ee5\u7528\u4e8e\u5206\u7ec4\u548c\u805a\u5408\u7684\u6709\u7528\u6807\u7b7e\nhttp_requests_total{method=\"GET\", status=\"200\", handler=\"/api/users\"} 123\n</code></pre> <p>\u9700\u8981\u8c28\u614e\u4f7f\u7528\u7684\u6807\u7b7e:</p> <pre><code># \u53ef\u80fd\u5bfc\u81f4\u65f6\u95f4\u5e8f\u5217\u7206\u70b8\u7684\u9ad8\u57fa\u6570\u6807\u7b7e\nhttp_requests_total{request_id=\"uuid123\"} # \u907f\u514d\u4f7f\u7528\nhttp_requests_total{user_id=\"123456\"} # \u53ef\u80fd\u4e0d\u5fc5\u8981\n</code></pre>"},{"location":"monitor/metrics/#3","title":"3. \u6307\u6807\u7c92\u5ea6\u63a7\u5236","text":"<ul> <li>\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u7ec6\u8282\u5c42\u7ea7</li> <li>\u5e73\u8861\u76d1\u63a7\u7ec6\u8282\u548c\u6027\u80fd\u5f71\u54cd</li> <li>\u5b9a\u671f\u8bc4\u5ba1\u4e0d\u518d\u4f7f\u7528\u7684\u6307\u6807</li> </ul>"},{"location":"monitor/metrics/#_14","title":"\u5e38\u7528\u76d1\u63a7\u6307\u6807\u5b57\u5178","text":"\u6307\u6807\u540d\u79f0 \u7c7b\u578b \u8bf4\u660e \u5355\u4f4d <code>http_requests_total</code> Counter HTTP \u8bf7\u6c42\u603b\u6570 \u65e0 <code>http_request_duration_seconds</code> Histogram HTTP \u8bf7\u6c42\u8017\u65f6 seconds <code>process_cpu_seconds_total</code> Counter \u8fdb\u7a0b CPU \u65f6\u95f4 seconds <code>process_resident_memory_bytes</code> Gauge \u8fdb\u7a0b\u5e38\u9a7b\u5185\u5b58 bytes <code>process_start_time_seconds</code> Gauge \u8fdb\u7a0b\u542f\u52a8\u65f6\u95f4 seconds since epoch <code>go_goroutines</code> Gauge Goroutine \u6570\u91cf \u65e0 <code>go_gc_duration_seconds</code> Summary GC \u505c\u987f\u65f6\u95f4 seconds <p>\u5408\u7406\u7684\u6307\u6807\u4f53\u7cfb\u53ef\u4ee5\u5e2e\u52a9\u5feb\u901f\u5b9a\u4f4d\u95ee\u9898\uff0c\u63d0\u9ad8\u7cfb\u7edf\u53ef\u89c2\u6d4b\u6027\u6c34\u5e73\u3002\u5728\u8bbe\u8ba1\u76d1\u63a7\u6307\u6807\u65f6\uff0c\u5e94\u6839\u636e\u5177\u4f53\u573a\u666f\u9009\u62e9\u9002\u5f53\u7684\u6307\u6807\u7c7b\u578b\uff0c\u5e76\u9075\u5faa\u7edf\u4e00\u7684\u547d\u540d\u89c4\u8303\u3002</p>"},{"location":"monitor/prometheus/","title":"Prometheus \u76d1\u63a7\u7cfb\u7edf","text":""},{"location":"monitor/prometheus/#_1","title":"\u6982\u8ff0","text":"<p>Prometheus \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u7cfb\u7edf\u76d1\u63a7\u548c\u62a5\u8b66\u5de5\u5177\u5305\uff0c\u6700\u521d\u7531 SoundCloud \u5f00\u53d1\uff0c\u73b0\u7531 Cloud Native Computing Foundation(CNCF) \u7ef4\u62a4\u3002\u5b83\u901a\u8fc7\u62c9\u53d6\uff08Pull\uff09\u6a21\u578b\u548c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5e93\uff08TSDB\uff09\u6765\u6536\u96c6\u548c\u5b58\u50a8\u6307\u6807\u6570\u636e\u3002</p>"},{"location":"monitor/prometheus/#_2","title":"\u6838\u5fc3\u7ec4\u4ef6","text":""},{"location":"monitor/prometheus/#1-prometheus-server","title":"1. Prometheus Server","text":"<ul> <li>Retrieval\uff1a\u4ece\u5404\u4e2a\u76ee\u6807\u6536\u96c6\u6307\u6807</li> <li>Storage\uff1a\u5b58\u50a8\u65f6\u95f4\u5e8f\u5217\u6570\u636e</li> <li>Query Language\uff1aPromQL \u67e5\u8be2\u8bed\u8a00</li> <li>Rule evaluation\uff1a\u8bc4\u4f30\u8b66\u62a5\u89c4\u5219</li> </ul>"},{"location":"monitor/prometheus/#2-exporters","title":"2. Exporters","text":"<p>\u5c06\u73b0\u6709\u7a0b\u5e8f\u5305\u88c5\u6210\u652f\u6301 Prometheus \u6307\u6807\u7684\u683c\u5f0f\uff0c\u5982\uff1a</p> <ul> <li>node_exporter\uff1a\u670d\u52a1\u5668\u6307\u6807</li> <li>mysqld_exporter\uff1aMySQL \u6307\u6807</li> <li>redis_exporter\uff1aRedis \u6307\u6807</li> </ul>"},{"location":"monitor/prometheus/#3-alertmanager","title":"3. Alertmanager","text":"<p>\u5904\u7406\u8b66\u62a5\u7684\u5206\u7ec4\u3001\u53bb\u91cd\u3001\u9759\u9ed8\u548c\u6291\u5236\uff0c\u652f\u6301\u591a\u79cd\u901a\u77e5\u6e20\u9053\u3002</p>"},{"location":"monitor/prometheus/#4-pushgateway","title":"4. Pushgateway","text":"<p>\u5141\u8bb8\u4e34\u65f6\u4efb\u52a1\u63a8\u9001\u5176\u6307\u6807\uff0c\u8fd9\u4e9b\u4efb\u52a1\u901a\u5e38\u4e0d\u4f1a\u6301\u7eed\u66b4\u9732\u7ed9 Prometheus \u62c9\u53d6\u3002</p>"},{"location":"monitor/prometheus/#_3","title":"\u5b89\u88c5\u548c\u914d\u7f6e","text":""},{"location":"monitor/prometheus/#1-prometheus","title":"1. \u5b89\u88c5 Prometheus","text":"<pre><code># \u521b\u5efa prometheus \u7528\u6237\nsudo useradd --no-create-home --shell /bin/false prometheus\n\n# \u521b\u5efa\u5fc5\u8981\u76ee\u5f55\nsudo mkdir -p /etc/prometheus\nsudo mkdir -p /var/lib/prometheus\n\n# \u8bbe\u7f6e\u6240\u6709\u6743\nsudo chown prometheus:prometheus /etc/prometheus\nsudo chown prometheus:prometheus /var/lib/prometheus\n\n# \u4e0b\u8f7d\u5e76\u89e3\u538b Prometheus\ncd /tmp\nwget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz\ntar -xvf prometheus-2.40.0.linux-amd64.tar.gz\n\n# \u8fdb\u5165\u89e3\u538b\u540e\u7684\u76ee\u5f55\ncd prometheus-2.40.0.linux-amd64\n\n# \u79fb\u52a8\u4e8c\u8fdb\u5236\u6587\u4ef6\nsudo cp prometheus /usr/local/bin/\nsudo cp promtool /usr/local/bin/\n\n# \u8bbe\u7f6e\u6240\u6709\u8005\u4e3a prometheus \u7528\u6237\nsudo chown prometheus:prometheus /usr/local/bin/prometheus\nsudo chown prometheus:prometheus /usr/local/bin/promtool\n\n# \u590d\u5236\u914d\u7f6e\u6587\u4ef6\u548c\u914d\u7f6e\u76ee\u5f55\nsudo cp -r consoles /etc/prometheus\nsudo cp -r console_libraries /etc/prometheus\nsudo chown -R prometheus:prometheus /etc/prometheus/consoles\nsudo chown -R prometheus:prometheus /etc/prometheus/console_libraries\n</code></pre>"},{"location":"monitor/prometheus/#2-prometheus","title":"2. Prometheus \u914d\u7f6e\u6587\u4ef6","text":"<p>\u521b\u5efa\u4e3b\u914d\u7f6e\u6587\u4ef6 <code>/etc/prometheus/prometheus.yml</code>:</p> <pre><code>global:\n  scrape_interval: 15s # \u8bbe\u7f6e\u5168\u5c40\u9ed8\u8ba4\u6293\u53d6\u95f4\u9694\n  evaluation_interval: 15s # \u89c4\u5219\u8bc4\u4f30\u95f4\u9694\n\n# \u89c4\u5219\u6587\u4ef6\u8def\u5f84\nrule_files:\n  # - \"first_rules.yml\"\n  # - \"second_rules.yml\"\n\n# \u76ee\u6807\u5217\u8868\nscrape_configs:\n  # \u76d1\u63a7 prometheus \u672c\u8eab\n  - job_name: \"prometheus\"\n    static_configs:\n      - targets: [\"localhost:9090\"]\n\n  # \u76d1\u63a7\u8282\u70b9\n  - job_name: \"node\"\n    static_configs:\n      - targets: [\"localhost:9100\"]\n\n  # \u76d1\u63a7\u670d\u52a1\n  - job_name: \"service\"\n    static_configs:\n      - targets: [\"localhost:8080\", \"localhost:8081\"]\n\n  # \u52a8\u6001\u670d\u52a1\u53d1\u73b0\n  - job_name: \"services-kubernetes\"\n    kubernetes_sd_configs:\n      - api_server: null\n        role: pod\n        kubeconfig_file: \"\"\n        tls_config:\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n          insecure_skip_verify: true\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]\n        action: keep\n        regex: true\n      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]\n        action: replace\n        target_label: __metrics_path__\n        regex: (.+)\n      - source_labels:\n          [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\n        action: replace\n        regex: ([^:]+)(?::\\d+)?;(\\d+)\n        replacement: $1:$2\n        target_label: __address__\n\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets:\n          # - \"alertmanager:9093\"\n</code></pre>"},{"location":"monitor/prometheus/#3-systemd","title":"3. \u521b\u5efa Systemd \u670d\u52a1","text":"<p>\u521b\u5efa\u6587\u4ef6 <code>/etc/systemd/system/prometheus.service</code>:</p> <pre><code>[Unit]\nDescription=Prometheus\nWants=network-online.target\nAfter=network-online.target\n\nStartLimitIntervalSec=500\nStartLimitBurst=5\n\n[Service]\nType=simple\nRestart=on-failure\nRestartSec=5s\n\nUser=prometheus\nGroup=prometheus\nExecStart=/usr/local/bin/prometheus \\\n    --config.file=/etc/prometheus/prometheus.yml \\\n    --storage.tsdb.path=/var/lib/prometheus/ \\\n    --web.console.templates=/etc/prometheus/consoles \\\n    --web.console.libraries=/etc/prometheus/console_libraries \\\n    --web.listen-address=0.0.0.0:9090 \\\n    --storage.tsdb.retention.time=200h \\\n    --web.enable-lifecycle\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"monitor/prometheus/#4-prometheus","title":"4. \u542f\u52a8 Prometheus","text":"<pre><code># \u91cd\u65b0\u52a0\u8f7d systemd \u914d\u7f6e\nsudo systemctl daemon-reload\n\n# \u542f\u52a8 Prometheus \u670d\u52a1\nsudo systemctl start prometheus\n\n# \u9a8c\u8bc1 Prometheus \u662f\u5426\u6b63\u5728\u8fd0\u884c\nsudo systemctl status prometheus\n\n# \u8bbe\u7f6e Prometheus \u5728\u542f\u52a8\u65f6\u81ea\u52a8\u8fd0\u884c\nsudo systemctl enable prometheus\n</code></pre>"},{"location":"monitor/prometheus/#exporters","title":"\u5e38\u7528 Exporters","text":""},{"location":"monitor/prometheus/#node-exporter","title":"Node Exporter\uff08\u670d\u52a1\u5668\u6307\u6807\uff09","text":"<pre><code># \u521b\u5efa\u7528\u6237\nsudo useradd --no-create-home --shell /bin/false node_exporter\n\n# \u4e0b\u8f7d node_exporter\ncd /tmp\nwget https://github.com/prometheus/node_exporter/releases/download/v1.4.0/node_exporter-1.4.0.linux-amd64.tar.gz\ntar -xzf node_exporter-1.40.0.linux-amd64.tar.gz\n\n# \u590d\u5236\u4e8c\u8fdb\u5236\u6587\u4ef6\nsudo cp node_exporter-1.4.0.linux-amd64/node_exporter /usr/local/bin\nsudo chown node_exporter:node_exporter /usr/local/bin/node_exporter\n\n# \u521b\u5efa systemd \u670d\u52a1\u6587\u4ef6\nsudo nano /etc/systemd/system/node_exporter.service\n</code></pre> <pre><code>[Unit]\nDescription=Node Exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=node_exporter\nGroup=node_exporter\nType=simple\nExecStart=/usr/local/bin/node_exporter\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u542f\u52a8\u670d\u52a1\uff1a</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl start node_exporter\nsudo systemctl enable node_exporter\n</code></pre>"},{"location":"monitor/prometheus/#_4","title":"\u544a\u8b66\u89c4\u5219\u914d\u7f6e","text":""},{"location":"monitor/prometheus/#rulesyml","title":"\u793a\u4f8b\u544a\u8b66\u89c4\u5219\uff08<code>rules.yml</code>\uff09","text":"<pre><code>groups:\n  - name: example\n    rules:\n      # \u6307\u6807\u8d85\u8fc7\u9608\u503c\n      - alert: HighCpuUsage\n        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100) &gt; 80\n        for: 2m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High CPU usage detected on {{ $labels.instance }}\"\n          description: \"{{ $labels.instance }} has had high CPU usage (&gt; 80%) for the last 2 minutes.\"\n\n      # \u670d\u52a1\u5b95\u673a\n      - alert: ServiceDown\n        expr: up == 0\n        for: 1m\n        labels:\n          severity: critical\n        annotations:\n          summary: \"Service {{ $labels.instance }} is down\"\n          description: \"{{ $labels.job }} job {{ $labels.instance }} has been down for more than 1 minute.\"\n\n      # \u5185\u5b58\u4f7f\u7528\u7387\u8fc7\u9ad8\n      - alert: HighMemoryUsage\n        expr: (node_memory_MemTotal_bytes - node_memory_MemFree_bytes) / node_memory_MemTotal_bytes * 100 &gt; 90\n        for: 2m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High memory usage on {{ $labels.instance }}\"\n          description: \"{{ $labels.instance }} has had high memory usage (&gt; 90%) for the last 2 minutes.\"\n</code></pre>"},{"location":"monitor/prometheus/#prometheus-promql","title":"Prometheus \u67e5\u8be2\u8bed\u8a00\uff08PromQL\uff09","text":""},{"location":"monitor/prometheus/#_5","title":"\u57fa\u672c\u67e5\u8be2\u793a\u4f8b","text":"<pre><code># \u77ac\u65f6\u5411\u91cf\u9009\u62e9\u5668\nup                           # \u68c0\u67e5\u6240\u6709\u88ab\u76d1\u63a7\u7684\u76ee\u6807\u7684up\u72b6\u6001\n\n# \u533a\u95f4\u5411\u91cf\u9009\u62e9\u5668\nrate(http_requests_total[5m]) # \u8ba1\u7b97\u8fc7\u53bb5\u5206\u949f\u5185\u7684\u8bf7\u6c42\u901f\u7387\n\n# \u805a\u5408\u64cd\u4f5c\nsum(cpu_usage_percent)        # \u6240\u6709CPU\u4f7f\u7528\u767e\u5206\u6bd4\u7684\u603b\u548c\navg(cpu_usage_percent)        # \u6240\u6709CPU\u4f7f\u7528\u767e\u5206\u6bd4\u7684\u5e73\u5747\u503c\nmax_over_time(up[1h])         # \u8fc7\u53bb1\u5c0f\u65f6\u5185UP\u7684\u6700\u5927\u503c\n</code></pre>"},{"location":"monitor/prometheus/#_6","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"monitor/prometheus/#_7","title":"\u914d\u7f6e\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li>\u5408\u7406\u8bbe\u7f6e\u6293\u53d6\u95f4\u9694\u4ee5\u51cf\u5c11\u670d\u52a1\u5668\u538b\u529b</li> <li>\u6b63\u786e\u8bbe\u7f6e\u6807\u7b7e\u6765\u6807\u8bc6\u5b9e\u4f8b\u548c\u4f5c\u4e1a</li> <li>\u5bf9\u4e8e\u77ed\u6682\u4efb\u52a1\u4f7f\u7528 Pushgateway</li> <li>\u9002\u5f53\u5730\u914d\u7f6e\u89c4\u5219\u548c\u544a\u8b66</li> <li>\u4f7f\u7528 relabeling \u529f\u80fd\u8fc7\u6ee4\u6216\u8f6c\u6362\u6807\u7b7e</li> </ol>"},{"location":"monitor/prometheus/#_8","title":"\u6027\u80fd\u4f18\u5316\u5efa\u8bae","text":"<ol> <li>\u5408\u7406\u914d\u7f6e\u4fdd\u7559\u7b56\u7565\u907f\u514d\u5b58\u50a8\u8fc7\u5ea6\u589e\u957f</li> <li>\u4f7f\u7528\u9ad8\u6548\u7684\u6807\u7b7e\u6a21\u5f0f\u907f\u514d\u6807\u7b7e\u7206\u70b8</li> <li>\u5728\u544a\u8b66\u89c4\u5219\u4e2d\u4f7f\u7528 <code>for</code> \u5b50\u53e5\u51cf\u5c11\u6296\u52a8</li> <li>\u8c28\u614e\u8bbe\u7f6e\u805a\u5408\u51fd\u6570\u7684\u4f7f\u7528\uff0c\u7279\u522b\u662f\u5728\u9ad8\u57fa\u6570\u6570\u636e\u4e0a</li> </ol>"},{"location":"monitor/prometheus/#_9","title":"\u76d1\u63a7\u53ef\u89c6\u5316","text":"<p>Prometheus \u901a\u5e38\u4e0e\u5176\u4ed6\u5de5\u5177\u914d\u5408\u4f7f\u7528\u8fdb\u884c\u53ef\u89c6\u5316\uff0c\u5982 Grafana\uff0c\u53ef\u4ee5\u7528\u6765\u5c55\u793a\u6536\u96c6\u7684\u6307\u6807\u3002Prometheus \u8fd8\u81ea\u5e26\u4e00\u4e2a\u7b80\u5355\u7684\u5185\u7f6e\u8868\u8fbe\u5f0f\u6d4f\u89c8\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7 http://YOUR_SERVER_IP:9090/graph \u8bbf\u95ee\u3002</p>"},{"location":"monitor/vm/","title":"victoriametrics","text":"<pre><code># VictoriaMetrics\n\nVictoriaMetrics is a high-performance, cost-effective monitoring solution and time series database. It is designed to collect, store, and visualize metrics from various sources such as Prometheus exporters, logs, and traces. Here are some key features of VictoriaMetrics:\n\n## \u7ec4\u4ef6\n\nvmagent - lightweight agent for receiving metrics via pull-based and push-based protocols, transforming and sending them to the configured Prometheus-compatible remote storage systems such as VictoriaMetrics.\nvmalert - a service for processing Prometheus-compatible alerting and recording rules.\nvmalert-tool - a tool for validating alerting and recording rules.\nvmauth - authorization proxy and load balancer optimized for VictoriaMetrics products.\nvmgateway - authorization proxy with per-tenant rate limiting capabilities.\nvmctl - a tool for migrating and copying data between different storage systems for metrics.\nvmbackup, vmrestore and vmbackupmanager - tools for creating backups and restoring from backups for VictoriaMetrics data.\nvminsert, vmselect and vmstorage - components of VictoriaMetrics cluster.\nVictoriaLogs - user-friendly cost-efficient database for logs.\n\n## \u7ed3\u5408 prometheus\nprometheus \u7248\u672c v2.12.0+ \u5185\u5b58\u589e\u52a0 ~25%\n\n</code></pre> <p>remote_write:   - url: http://:8428/api/v1/write     queue_config:       max_samples_per_send: 10000       capacity: 20000       max_shards: 30 ```yaml"},{"location":"monitor/vm/#_1","title":"\u90e8\u7f72\u96c6\u7fa4","text":"<p>insert replicationFactor=2</p> <p>select -dedup.minScrapeInterval</p> <p>storage -dedup.minScrapeInterval</p> <p>storage --promscrape.config=/etc/victoriametrics-promscrape.yml         --retentionPeriod=30d         --storageDataPath=/srv/victoriametrics/data         --httpListenAddr=127.0.0.1:9090         --search.disableCache=true         --search.maxQueryLen=1MB         --search.latencyOffset=5s         --search.maxUniqueTimeseries=100000000         --search.maxSamplesPerQuery=1500000000         --search.maxQueueDuration=30s         --search.logSlowQueryDuration=30s         --search.maxQueryDuration=90s         --promscrape.streamParse=true         --prometheusDataPath=/srv/prometheus/data         --http.pathPrefix=/prometheus         --envflag.enable         --envflag.prefix=VM_</p> <p>vmagent </p> <p>-remoteWrite.tmpDataPath \u96c6\u7fa4 http://10.1.72:8429/insert/0/prometheus/api/v1/write \u5355\u673a http://10.1.72:8429/api/v1/write</p>"},{"location":"monitor/vm/#_2","title":"\u6743\u9650\u9a8c\u8bc1","text":""},{"location":"monitor/vm/#_3","title":"\u9a8c\u8bc1\u96c6\u7fa4","text":""},{"location":"monitor/vm/#_4","title":"\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\uff0c\u76d1\u63a7","text":"<p>http://10.1.40.72:8429/select/0/vmui</p>"},{"location":"monitor/vm/#_5","title":"\u7aef\u53e3","text":"<p>vmstorage   8482    HTTP    \u7ba1\u7406API\u7aef\u53e3\uff08/health\u3001/metrics\uff09 8400    TCP \u63a5\u6536\u6765\u81eavminsert\u7684\u5199\u5165\u6570\u636e 8401    UDP \u63a5\u6536\u6765\u81eavminsert\u7684\u5199\u5165\u6570\u636e\uff08\u53ef\u9009\uff09 8480    TCP \u96c6\u7fa4\u8282\u70b9\u95f4\u901a\u4fe1\u7aef\u53e3 vminsert    8480    HTTP    \u7ba1\u7406API\u7aef\u53e3 8400    TCP \u63a5\u6536\u5199\u5165\u8bf7\u6c42\uff08Prometheus remote_write\uff09 vmselect    8481    HTTP    \u7ba1\u7406API\u7aef\u53e3 8401    TCP \u63a5\u6536\u67e5\u8be2\u8bf7\u6c42\uff08Prometheus query\uff09 vmagent 8429    HTTP    \u9ed8\u8ba4\u6293\u53d6/metrics\u7aef\u53e3 \u5355\u673a\u7248 8428    HTTP    \u9ed8\u8ba4\u6570\u636e\u63a5\u6536/\u67e5\u8be2\u7aef\u53e3</p>"},{"location":"monitor/vm/#vmagent-prometheus","title":"vmagent \u662f\u5426\u66ff\u4ee3 Prometheus \u8fdb\u884c\u6293\u53d6\u548c\u5199\u5165","text":""},{"location":"monitor/vm/#vmauth","title":"vmauth","text":"<p>\u8fdb\u884c\u8bbf\u95ee\u9a8c\u8bc1\uff0c\u8d1f\u8f7d\u5747\u8861. \u66ff\u4ee3\u524d\u9762\u7684nginx  port 8427</p> <p>openssl rand -hex 32</p> <p>-httpAuth.username -httpAuth.password ```markdown</p>"},{"location":"monitor/vm/#vmcluster-architecture-overview","title":"VMCluster Architecture Overview","text":"<p>The provided configuration and details describe the setup of a VictoriaMetrics (VM) cluster, which is a high-performance, cost-effective monitoring solution. Below is an organized breakdown of the key components, configurations, and functionalities.</p>"},{"location":"monitor/vm/#1-configuration-parametersmarkdown","title":"1. Configuration Parameters```markdown","text":""},{"location":"mysql/","title":"\ud83d\udc2c MySQL \u4e13\u4e1a\u6587\u6863\u4e2d\u5fc3","text":"\u4e16\u754c\u6700\u53d7\u6b22\u8fce\u7684\u5f00\u6e90\u5173\u7cfb\u578b\u6570\u636e\u5e93 <p>\u9ad8\u6027\u80fd \u2022 \u6613\u7528\u6027 \u2022 \u9ad8\u5e76\u53d1 \u2022 \u5e7f\u6cdb\u652f\u6301</p>"},{"location":"mysql/#_1","title":"\ud83d\udcda \u5feb\u901f\u5bfc\u822a","text":"\ud83d\ude80 \u5b89\u88c5 <p>\u8be6\u7ec6\u4e86\u89e3 MySQL \u7684\u5b89\u88c5\u90e8\u7f72\u65b9\u6cd5\u3002</p> \u8be6\u60c5 \u2699\ufe0f \u914d\u7f6e <p>\u638c\u63e1 MySQL \u7684\u6027\u80fd\u914d\u7f6e\u548c\u53c2\u6570\u4f18\u5316\u3002</p> \u8be6\u60c5 \ud83d\udd10 \u6743\u9650\u7ba1\u7406 <p>\u6df1\u5165\u7406\u89e3 MySQL \u4e2d\u7684\u7528\u6237\u6743\u9650\u548c\u8ba4\u8bc1\u7b56\u7565\u3002</p> \u8be6\u60c5 \ud83d\udc65 \u7528\u6237\u7ba1\u7406 <p>\u5b66\u4e60\u5982\u4f55\u9ad8\u6548\u5730\u7ba1\u7406\u6570\u636e\u5e93\u7528\u6237\u8d26\u6237\u3002</p> \u8be6\u60c5 \ud83d\udd04 \u4e3b\u4ece\u590d\u5236 <p>\u6df1\u5165\u7406\u89e3\u4e3b\u4ece\u590d\u5236\u3001\u534a\u540c\u6b65\u590d\u5236\u7b49\u6570\u636e\u540c\u6b65\u673a\u5236\u3002</p> \u8be6\u60c5 \ud83d\udee1\ufe0f \u9ad8\u53ef\u7528 <p>\u63a2\u7d22 MySQL Group Replication\u3001MGR \u7b49 HA \u65b9\u6848\u3002</p> \u8be6\u60c5 \ud83d\udcca \u76d1\u63a7 <p>\u4f7f\u7528 exporter \u7b49\u5de5\u5177\u8fdb\u884c\u6570\u636e\u5e93\u6027\u80fd\u76d1\u63a7\u3002</p> \u8be6\u60c5 \ud83d\udd0d \u538b\u6d4b <p>\u5229\u7528 mysqlslap \u7b49\u5de5\u5177\u8fdb\u884c\u6027\u80fd\u538b\u529b\u6d4b\u8bd5\u3002</p> \u8be6\u60c5"},{"location":"mysql/#mysql_1","title":"MySQL \u7b80\u4ecb","text":"<p>MySQL \u662f\u4e16\u754c\u4e0a\u6700\u53d7\u6b22\u8fce\u7684\u5f00\u6e90\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u4e4b\u4e00\uff0c\u5177\u6709\u9ad8\u6027\u80fd\u3001\u6613\u7528\u6027\u548c\u5e7f\u6cdb\u7684\u652f\u6301\u7b49\u7279\u70b9\u3002\u81ea 1995 \u5e74\u9996\u6b21\u53d1\u5e03\u4ee5\u6765\uff0cMySQL \u5df2\u7ecf\u53d1\u5c55\u6210\u4e3a\u4e00\u4e2a\u5f3a\u5927\u800c\u7a33\u5b9a\u7684\u6570\u636e\u5e93\u89e3\u51b3\u65b9\u6848\uff0c\u88ab\u5e7f\u6cdb\u7528\u4e8e\u5404\u79cd\u89c4\u6a21\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4ece\u5c0f\u578b\u7f51\u7ad9\u5230\u5927\u578b\u4f01\u4e1a\u7ea7\u5e94\u7528\u90fd\u6709\u5176\u8eab\u5f71\u3002</p>"},{"location":"mysql/#_2","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u5f00\u6e90\u514d\u8d39\uff1aGPL \u8bb8\u53ef\u534f\u8bae\uff0c\u793e\u533a\u7248\u514d\u8d39\u4f7f\u7528</li> <li>\u9ad8\u6027\u80fd\u5f15\u64ce\uff1a\u652f\u6301\u591a\u79cd\u5b58\u50a8\u5f15\u64ce\uff0c\u5305\u62ec InnoDB\u3001MyISAM \u7b49</li> <li>\u9ad8\u5e76\u53d1\u5904\u7406\uff1a\u5353\u8d8a\u7684\u8bfb\u5199\u6027\u80fd\uff0c\u9002\u7528\u4e8e\u9ad8\u5e76\u53d1\u573a\u666f</li> <li>\u6570\u636e\u4e00\u81f4\u6027\uff1aACID \u7279\u6027\u4fdd\u8bc1\u4e8b\u52a1\u5b8c\u6574\u6027</li> <li>\u6613\u4e8e\u6269\u5c55\uff1a\u652f\u6301\u6c34\u5e73\u62c6\u5206\u548c\u5782\u76f4\u6269\u5c55</li> <li>\u8de8\u5e73\u53f0\u652f\u6301\uff1a\u652f\u6301\u6240\u6709\u4e3b\u6d41\u64cd\u4f5c\u7cfb\u7edf\u5e73\u53f0</li> </ul>"},{"location":"mysql/#_3","title":"\u4f01\u4e1a\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u2705 Web \u5e94\u7528\u5f00\u53d1</li> <li>\u2705 \u7535\u5546\u5e73\u53f0\u6570\u636e\u7ba1\u7406</li> <li>\u2705 \u6570\u636e\u5206\u6790\u4e0e\u62a5\u544a</li> <li>\u2705 \u5185\u5bb9\u7ba1\u7406\u7cfb\u7edf(CMS)</li> <li>\u2705 \u65e5\u5fd7\u6570\u636e\u5b58\u50a8</li> <li>\u2705 API \u6570\u636e\u5c42\u670d\u52a1</li> </ul>"},{"location":"mysql/#_4","title":"\u6280\u672f\u89c4\u683c\u5bf9\u6bd4","text":"\u529f\u80fd PostgreSQL MySQL Oracle SQL Server \u793e\u533a\u6d3b\u8dc3\u5ea6 \ud83c\udf1f \u2705 \u26a0\ufe0f \u2705 \u6613\u7528\u6027 \u26a0\ufe0f \ud83c\udf1f \u26a0\ufe0f \u2705 \u4f01\u4e1a\u652f\u6301 \u26a0\ufe0f \u2705 \u2705 \u2705 SQL \u6807\u51c6\u517c\u5bb9 \u2705 \u26a0\ufe0f \u26a0\ufe0f \u26a0\ufe0f NoSQL \u6269\u5c55\u652f\u6301 \u26a0\ufe0f \u2705 \ud83c\udf1f \u2705 \u5f00\u6e90\u81ea\u7531\u5ea6 \u2705 \u2705 \u274c \u274c <p>\ud83c\udf1f \u5353\u8d8a\u7ea7 \u00a0\u00a0 \u2705 \u4f18\u79c0\u7ea7 \u00a0\u00a0 \u26a0\ufe0f \u4e2d\u7b49\u7ea7 \u00a0\u00a0 \u274c \u8f83\u5f31\u7ea7</p>"},{"location":"mysql/#mysql_2","title":"\u4f55\u65f6\u4f7f\u7528 MySQL\uff1f","text":""},{"location":"mysql/#_5","title":"\u63a8\u8350\u9009\u7528\u573a\u666f","text":""},{"location":"mysql/#1-web","title":"1. Web \u5e94\u7528\u5f00\u53d1","text":"<ul> <li>\u5927\u591a\u6570 Web \u5e94\u7528\u7684\u9996\u9009\u6570\u636e\u5e93</li> <li>\u9ad8\u6548\u5904\u7406\u5728\u7ebf\u4e8b\u52a1\u5904\u7406(OLTP)</li> <li>\u7f51\u7ad9\u8bbf\u95ee\u91cf\u5927\u3001\u8bfb\u53d6\u9891\u7387\u9ad8\u7684\u573a\u666f</li> </ul>"},{"location":"mysql/#2","title":"2. \u5feb\u901f\u539f\u578b\u5f00\u53d1","text":"<ul> <li>\u4e30\u5bcc\u7684\u9a71\u52a8\u548c\u8fde\u63a5\u5668\u652f\u6301</li> <li>\u4e0e PHP\u3001Python\u3001Java \u7b49\u8bed\u8a00\u6df1\u5ea6\u96c6\u6210</li> <li>\u7b80\u5355\u76f4\u89c2\u7684\u7ba1\u7406\u5de5\u5177</li> </ul>"},{"location":"mysql/#3","title":"3. \u9ad8\u8bfb\u53d6\u5e76\u53d1\u9700\u6c42","text":"<ul> <li>\u4f18\u79c0\u7684\u8bfb\u6027\u80fd\uff0c\u7279\u522b\u9002\u5408\u8bfb\u591a\u5199\u5c11\u7684\u573a\u666f</li> <li>\u652f\u6301\u591a\u79cd\u590d\u5236\u65b9\u5f0f\u4f18\u5316\u8bfb\u53d6\u8d1f\u8f7d</li> <li>\u9ad8\u6548\u7684\u7f13\u5b58\u673a\u5236</li> </ul>"},{"location":"mysql/#4","title":"4. \u6210\u672c\u6548\u76ca\u8003\u8651","text":"<ul> <li>\u793e\u533a\u7248\u5b8c\u5168\u514d\u8d39\u5546\u7528</li> <li>\u5e7f\u6cdb\u7684\u6280\u672f\u8d44\u6599\u548c\u793e\u533a\u652f\u6301</li> <li>\u4f4e\u8fd0\u8425\u548c\u7ef4\u62a4\u6210\u672c</li> </ul>"},{"location":"mysql/#_6","title":"\u53ef\u8003\u8651\u66ff\u4ee3\u7684\u60c5\u51b5","text":"<ul> <li>\u8981\u6c42\u5f3a ACID \u5408\u89c4\u6027\u7684\u91d1\u878d\u4ea4\u6613\u7cfb\u7edf</li> <li>\u590d\u6742\u7684\u5173\u7cfb\u5efa\u6a21\u548c\u6570\u636e\u7c7b\u578b\u5904\u7406\u9700\u6c42</li> <li>\u9700\u8981\u5927\u91cf\u81ea\u5b9a\u4e49\u6269\u5c55\u529f\u80fd\u7684\u573a\u666f</li> </ul>"},{"location":"mysql/#_7","title":"\u53d1\u5c55\u8d8b\u52bf","text":"<pre><code>graph LR\n    A[\u73b0\u4ee3\u6570\u636e\u5e93] --&gt; B{\u53d1\u5c55\u65b9\u5411}\n    B --&gt; C[\u4e91\u539f\u751f\u96c6\u6210]\n    B --&gt; D[NoSQL\u6df7\u5408\u80fd\u529b]\n    B --&gt; E[\u5206\u6790\u80fd\u529b\u589e\u5f3a]\n    B --&gt; F[AI\u589e\u5f3a\u529f\u80fd]\n\n    C --&gt; G[MySQL]\n    D --&gt; G\n    E --&gt; G\n    F --&gt; G\n\n    G --&gt; H[\u5b58\u50a8\u5f15\u64ce\u8fdb\u5316]\n    H --&gt; I[Document Store]\n    H --&gt; J[InnoDB Cluster]\n    H --&gt; K[HeatWave\u5206\u6790\u5f15\u64ce]\n    H --&gt; L[Router for InnoDB]\n</code></pre>"},{"location":"mysql/#mysql_3","title":"MySQL \u7684\u6700\u65b0\u6f14\u8fdb\u65b9\u5411\uff1a","text":"<ul> <li>\u4e91\u539f\u751f\u4f18\u5316 - \u4e13\u95e8\u9488\u5bf9\u4e91\u73af\u5883\u8fdb\u884c\u6027\u80fd\u548c\u53ef\u6269\u5c55\u6027\u6539\u8fdb</li> <li>\u5206\u6790\u529f\u80fd\u589e\u5f3a - MySQL HeatWave \u7b49\u5185\u7f6e\u6570\u636e\u5206\u6790\u5f15\u64ce</li> <li>\u5411\u91cf\u5316\u5904\u7406 - \u652f\u6301\u5217\u5f0f\u5b58\u50a8\uff0c\u4f18\u5316\u5206\u6790\u5de5\u4f5c\u8d1f\u8f7d</li> <li>\u6587\u6863\u6570\u636e\u5e93\u517c\u5bb9 - \u539f\u751f JSON \u6570\u636e\u7c7b\u578b\u7684\u8fdb\u4e00\u6b65\u589e\u5f3a</li> <li>\u5206\u5e03\u5f0f\u67b6\u6784 - MySQL Group Replication \u548c InnoDB Cluster</li> </ul>"},{"location":"mysql/#_8","title":"\u7248\u672c\u89c4\u5212","text":"\u7248\u672c \u53d1\u5e03\u65f6\u95f4 \u652f\u6301\u671f\u9650 \u4e3b\u8981\u7279\u6027 MySQL 5.7 2013 2023 \u5e74\u7ed3\u675f JSON \u652f\u6301\u3001\u865a\u62df\u5217\u3001\u6027\u80fd\u6539\u8fdb MySQL 8.0 2018 \u81f3\u5c11\u81f3 2026 \u6587\u6863\u5b58\u50a8\u3001\u7a97\u53e3\u51fd\u6570\u3001\u5b89\u5168\u6539\u8fdb MySQL 8.4 2024 \u9884\u8ba1 2029 \u5e74 AI \u96c6\u6210\u3001\u4e91\u4f18\u5316\u3001\u5b89\u5168\u589e\u5f3a <p>\u6700\u65b0\u63a8\u8350\u7248\u672c\uff1a<code>MySQL 8.4</code>, <code>MySQL 8.0 LTS</code></p>"},{"location":"mysql/#_9","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mysql/#_10","title":"\u6027\u80fd\u4f18\u5316\u9ec4\u91d1\u6cd5\u5219","text":"<ol> <li> <p>\u5408\u7406\u9009\u62e9\u5b58\u50a8\u5f15\u64ce</p> </li> <li> <p>\u4f7f\u7528 InnoDB \u5904\u7406\u4e8b\u52a1\u548c\u5916\u952e\u76f8\u5173\u7684\u5e94\u7528</p> </li> <li>\u5728\u7eaf\u8bfb\u53d6\u6216\u4e34\u65f6\u8868\u573a\u666f\u4e0b\u8003\u8651 MyISAM</li> <li> <p>\u4e86\u89e3\u4e0d\u540c\u5b58\u50a8\u5f15\u64ce\u7684\u7279\u70b9\u548c\u4f7f\u7528\u573a\u666f</p> </li> <li> <p>\u4f18\u5316\u67e5\u8be2\u7b56\u7565</p> </li> <li> <p>\u5408\u7406\u521b\u5efa\u7d22\u5f15\uff0c\u5173\u6ce8\u590d\u5408\u7d22\u5f15\u987a\u5e8f</p> </li> <li>\u907f\u514d\u5168\u8868\u626b\u63cf\u548c\u8fc7\u591a\u7684 JOIN</li> <li> <p>\u5408\u7406\u4f7f\u7528\u7f13\u5b58\u673a\u5236\u63d0\u5347\u6027\u80fd</p> </li> <li> <p>\u914d\u7f6e\u53c2\u6570\u8c03\u4f18</p> </li> <li>\u8c03\u6574\u7f13\u51b2\u6c60\u5927\u5c0f(buffer pool size)</li> <li>\u4f18\u5316\u8fde\u63a5\u6570\u548c\u7ebf\u7a0b\u914d\u7f6e</li> <li>\u5408\u7406\u8bbe\u7f6e\u65e5\u5fd7\u53c2\u6570\u5e73\u8861\u6027\u80fd\u4e0e\u5b89\u5168</li> </ol>"},{"location":"mysql/#_11","title":"\u5b89\u5168\u914d\u7f6e\u8981\u70b9","text":"<ol> <li> <p>\u6743\u9650\u8bbf\u95ee\u63a7\u5236</p> </li> <li> <p>\u9075\u5faa\u6700\u5c0f\u6743\u9650\u539f\u5219\u5206\u914d\u7528\u6237\u6743\u9650</p> </li> <li>\u5b9a\u671f\u5ba1\u67e5\u548c\u6e05\u7406\u4e0d\u5fc5\u8981\u7684\u7528\u6237\u8d26\u53f7</li> <li> <p>\u5408\u7406\u8bbe\u7f6e IP \u9650\u5236\u548c\u7f51\u7edc\u8bbf\u95ee\u7b56\u7565</p> </li> <li> <p>\u6570\u636e\u4fdd\u62a4\u7b56\u7565</p> </li> <li>\u542f\u7528\u5ba1\u8ba1\u65e5\u5fd7\u76d1\u63a7\u91cd\u8981\u64cd\u4f5c</li> <li>\u914d\u7f6e SSL/TLS \u52a0\u5bc6\u4f20\u8f93\u6570\u636e</li> <li>\u8003\u8651\u900f\u660e\u6570\u636e\u52a0\u5bc6\u4fdd\u62a4\u9759\u6001\u6570\u636e</li> </ol> <p>\u2b50 \u9884\u77e5\u66f4\u591a\u5b9e\u8df5\u7ec6\u8282\uff0c\u53ef\u53c2\u8003\u5de6\u4fa7\u83dc\u5355\u4e2d\u5bf9\u5e94\u4e13\u9898\u7ae0\u8282</p>"},{"location":"mysql/MGR/","title":"\u7ec4\u590d\u5236","text":"<p>mysql 8.0 MGR</p>"},{"location":"mysql/MGR/#_2","title":"\u8282\u70b9\u89c4\u5212","text":"<ul> <li>10.1.2.11</li> <li>10.1.2.12</li> <li>10.1.2.14</li> </ul>"},{"location":"mysql/MGR/#_3","title":"\u5b89\u88c5","text":"<pre><code>apt-get install mysql-client-8.0 mysql-server-8.0\n</code></pre>"},{"location":"mysql/MGR/#_4","title":"\u7528\u6237\u7ba1\u7406","text":"<pre><code># \u672c\u5730\u8bbf\u95ee\nalter user 'root'@'localhost' identified with mysql_native_password by 'mysql_4U';\n# \u8fdc\u7aef\u8bbf\u95ee\ncreate user 'root'@'%' identified with mysql_native_password by 'mysql_4U';\ngrant all privileges on *.* to 'root'@'%' with grant option;\nflush privileges;\n# \u590d\u5236\u7528\u6237\nset sql_log_bin=0;\ncreate user 'repl'@'%' identified by 'repl@12345';\ngrant replication slave on *.* to 'repl'@'%';\nflush privileges;\nset sql_log_bin=1;\n</code></pre>"},{"location":"mysql/MGR/#_5","title":"\u914d\u7f6e\u6570\u636e\u5e93","text":"<p><code>vi /etc/mysql/conf.d/mysql.cnf</code></p> <pre><code>[mysqld]\nbasedir=/usr\ndatadir=/var/lib/mysql\n#\u4fee\u6539\nserver_id=3\nsocket=/var/lib/mysql/mysql.sock\nlog-error=/var/lib/mysql/mysqld.log\npid-file=/var/lib/mysql/mysqld.pid\n\nbinlog_checksum=NONE\ngtid_mode=ON\nenforce_gtid_consistency=ON\ndefault_authentication_plugin=mysql_native_password\n#loose-group_replication_recovery_get_public_key=on\nloose-group_replication_recovery_use_ssl=on\nloose-group_replication_group_name=\"80d51c50-3c11-11ee-bd0f-080027fc0450\"\nloose-group_replication_start_on_boot=OFF\n#\u4fee\u6539\nloose-group_replication_local_address=\"10.10.2.11:33061\"\nloose-group_replication_group_seeds=\"10.10.2.12:33061,10.10.2.12\uff1a33061,10.10.2.13:33061\"\nloose-group_replication_bootstrap_group=OFF\ntransaction_write_set_extraction=XXHASH64\n\n[mysql]\nprompt=\"Slave02[\\\\d]&gt; \"\n</code></pre> <p>\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code>systemctl restart mysql\n</code></pre>"},{"location":"mysql/MGR/#_6","title":"\u5b89\u88c5\u63d2\u4ef6","text":"<pre><code> INSTALL PLUGIN group_replication SONAME 'group_replication.so';\n INSTALL PLUGIN clone SONAME 'mysql_clone.so';\n</code></pre> <p>\u67e5\u770b\u63d2\u4ef6</p> <pre><code> show plugins;\n</code></pre>"},{"location":"mysql/MGR/#_7","title":"\u4e3b\u8282\u70b9\u5f00\u542f\u7ec4\u590d\u5236","text":"<pre><code> set global group_replication_bootstrap_group=on;\n start group_replication;\n\n select * from performance_schema.replication_group_members;\n set global group_replication_bootstrap_group=off;\n</code></pre>"},{"location":"mysql/MGR/#_8","title":"\u4ece\u8282\u70b9\u5f00\u542f\u7ec4\u590d\u5236","text":"<pre><code>reset master;\nchange master to master_user=\"repl\",master_password=\"repl@12345\" for channel 'group_replication_recovery';\nstart group_replication;\n</code></pre>"},{"location":"mysql/MGR/#_9","title":"\u67e5\u770b\u7ec4\u590d\u5236","text":"<pre><code> select * from performance_schema.replication_group_members;\n</code></pre>"},{"location":"mysql/MGR/#_10","title":"\u624b\u52a8\u91cd\u542f","text":"<p>\u67e5\u770bgtid</p> <pre><code>select RECEIVED_TRANSACTION_SET from performance_schema.replication_connection_status where  channel_name = 'group_replication_applier' union all  select variable_value from performance_schema.global_variables where  variable_name = 'gtid_executed';\n</code></pre> <p>\u5728\u5e8f\u53f7\u6700\u5927\u7684\u8282\u70b9\u4e0a\u542f\u52a8\u5f15\u5bfc\u7a0b\u5e8f</p> <pre><code> set global group_replication_bootstrap_group=on;\n start group_replication;\n set global group_replication_bootstrap_group=off;\n\n select * from performance_schema.replication_group_members;\n</code></pre> <p>\u5176\u4ed6\u8282\u70b9</p> <pre><code>start group_replication;\n</code></pre>"},{"location":"mysql/MGR/#_11","title":"\u9519\u8bef\u96c6","text":"<p>\u65ad\u7535\u540e\u4e8c\u8fdb\u5236\u65e5\u5fd7\u635f\u574f,\u53d1\u751f\u5728\u4ece\u5e93</p> <pre><code>start group_replication\n[ERROR] [MY-010596] [Repl] Error reading relay log event for channel 'group_replication_applier': corrupted data in log event\n2024-01-10T02:58:16.082182Z 94 [ERROR] [MY-013121] [Repl] Replica SQL for channel 'group_replication_applier': Relay log read failure: Could not parse relay log event entry. The possible reasons are: the source's binary log is corrupted (you can check this by running 'mysqlbinlog' on the binary log), the replica's relay log is corrupted (you can check this by running 'mysqlbinlog' on the relay log), a network problem, the server was unable to fetch a keyring key required to open an encrypted relay log file, or a bug in the source's or replica's MySQL code. If you want to check the source's binary log or replica's relay log, you will be able to know their names by issuing 'SHOW REPLICA STATUS' on this replica. Error_code: MY-013121\n</code></pre> <p>\u89e3\u51b3</p> <pre><code>reset master \nsystemctl restart mysql\nstart group_replication\n</code></pre> <p>\u9519\u8bef</p> <pre><code>[ERROR] [MY-010605] [Repl] Failed in open_index_file() called from Relay_log_info::rli_init_info().\n</code></pre> <p>\u89e3\u51b3</p> <pre><code>/var/lib/mysql# mkdir relaylog\nchown mysql:mysql relaylog/\n</code></pre> <p>group_replication_message_cache_size</p> <p>group_replication_member_expel_timeout</p> <p>group_replication_consistency</p>"},{"location":"mysql/MGR/#_12","title":"\u7ec4\u590d\u5236\u9650\u5236\u3002 \u4e3b\u952e","text":"<pre><code>SELECT \n  COUNT(1) AS count \nFROM \n  information_schema.TABLES t1 \n  LEFT OUTER JOIN information_schema.columns t2 ON t1.table_schema = t2.TABLE_SCHEMA \n  AND t1.table_name = t2.TABLE_NAME \n  AND t2.COLUMN_KEY = 'PRI' \nWHERE \n  t2.table_name IS NULL \n  AND t1.table_type = 'BASE TABLE' \n  AND t1.TABLE_SCHEMA NOT IN(\n    'information_schema', 'performance_schema', \n    'mysql', 'sys'\n  );\n</code></pre>"},{"location":"mysql/PrivilegeManagement/","title":"\u6743\u9650\u7ba1\u7406","text":""},{"location":"mysql/PrivilegeManagement/#mysql","title":"mysql \u6570\u636e\u5e93\u7ba1\u7406","text":""},{"location":"mysql/PrivilegeManagement/#_1","title":"\u5b89\u5168\u53ca\u6743\u9650","text":""},{"location":"mysql/PrivilegeManagement/#_2","title":"\u6743\u9650\u5c42\u7ea7","text":"<pre><code>\u5728MySQL\u4e2d\uff0c\u6743\u9650\u53ef\u4ee5\u5206\u4e3a\u591a\u4e2a\u5c42\u7ea7\uff0c\u5305\u62ec\u5168\u5c40\u6743\u9650\u3001\u6570\u636e\u5e93\u7ea7\u6743\u9650\u3001\u8868\u7ea7\u6743\u9650\u3001\u5217\u7ea7\u6743\u9650\u548c\u4f8b\u7a0b\u7ea7\u6743\u9650\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_3","title":"\u5206\u914d\u7684\u539f\u5219","text":"<ul> <li>\u6700\u5c0f\u6743\u9650\u539f\u5219\uff1a\u6bcf\u4e2a\u7528\u6237\u53ea\u6709\u5b8c\u6210\u5176\u5de5\u4f5c\u6240\u5fc5\u9700\u7684\u6700\u5c0f\u6743\u9650\u96c6\u5408\u3002</li> <li>\u6309\u9700\u5206\u914d\uff1a\u6839\u636e\u7528\u6237\u7684\u89d2\u8272\u548c\u804c\u8d23\u5206\u914d\u6743\u9650</li> <li>\u5b9a\u671f\u5ba1\u8ba1\uff1a\u5b9a\u671f\u68c0\u67e5\u7528\u6237\u6743\u9650\uff0c\u786e\u4fdd\u6ca1\u6709\u4e0d\u5fc5\u8981\u7684\u6743\u9650\u9057\u7559\u3002</li> </ul>"},{"location":"mysql/PrivilegeManagement/#_4","title":"\u4e3e\u4f8b","text":"<pre><code>-- \u53ea\u8bfb\u6743\u9650\nGRANT SELECT ON mydb.* TO 'data_analyst'@'localhost';\n\n-- \u8bfb\u5199\u6743\u9650\nGRANT SELECT, INSERT, UPDATE ON mydb.* TO 'app_developer'@'localhost';\n\n-- \u6570\u636e\u5e93\u7ba1\u7406\u5458\u9700\u8981\u6240\u6709\u6743\u9650\nGRANT ALL PRIVILEGES ON mydb.* TO 'db_admin'@'localhost';\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_5","title":"\u5b9a\u671f\u5ba1\u8ba1","text":"<pre><code>-- \u67e5\u770b\u5f53\u524d\u6240\u6709\u7528\u6237\u7684\u6743\u9650\nSELECT * FROM mysql.user\\G;\n\n-- \u67e5\u770b\u7279\u5b9a\u7528\u6237\u7684\u6743\u9650\nSHOW GRANTS FOR 'data_analyst'@'localhost';\n</code></pre> <pre><code>-- \u56de\u6536\u67d0\u4e2a\u7528\u6237\u7684\u67d0\u9879\u6743\u9650\nREVOKE INSERT ON mydb.* FROM 'app_developer'@'localhost';\n\n-- \u5220\u9664\u4e0d\u518d\u9700\u8981\u7684\u7528\u6237\u8d26\u53f7\nDROP USER 'ex_employee'@'localhost';\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_6","title":"\u6570\u636e\u52a0\u5bc6","text":"<ul> <li>\u5bf9\u4e8e\u654f\u611f\u5b57\u6bb5\uff0c\u5982\u5bc6\u7801\u3001\u4e2a\u4eba\u4fe1\u606f\u7b49\uff0c\u59cb\u7ec8\u4f7f\u7528\u52a0\u5bc6\u5b58\u50a8\u3002</li> <li>\u4f7f\u7528\u5f3a\u52a0\u5bc6\u7b97\u6cd5\uff0c\u5982AES\u3002</li> <li>\u4fdd\u62a4\u597d\u5bc6\u94a5\uff0c\u4e0d\u8981\u5728\u4ee3\u7801\u6216\u914d\u7f6e\u6587\u4ef6\u4e2d\u786c\u7f16\u7801\u3002</li> </ul> <p>\u5728MySQL\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5185\u7f6e\u7684\u52a0\u5bc6\u51fd\u6570\u6765\u52a0\u5bc6\u6570\u636e\u3002</p> <pre><code>-- \u5047\u8bbe\u6211\u4eec\u9700\u8981\u5b58\u50a8\u7528\u6237\u5bc6\u7801\nALTER TABLE user_info ADD COLUMN encrypted_password VARCHAR(255);\n\n-- \u4f7f\u7528AES\u52a0\u5bc6\u7528\u6237\u5bc6\u7801\nUPDATE user_info SET encrypted_password = AES_ENCRYPT('password123', 'my_secret_key');\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#tips","title":"\u5b89\u5168\u4f18\u5316Tips","text":"<ul> <li>\u4f7f\u7528\u590d\u6742\u7684\u5bc6\u7801\uff0c\u5e76\u5b9a\u671f\u66f4\u6362\u3002</li> <li>\u4e0d\u8981\u4f7f\u7528root\u8d26\u6237\u8fdb\u884c\u65e5\u5e38\u64cd\u4f5c\u3002</li> <li>\u5b9a\u671f\u5907\u4efd\u6570\u636e\u5e93\uff0c\u4ee5\u9632\u4e07\u4e00\u3002</li> </ul>"},{"location":"mysql/PrivilegeManagement/#_7","title":"\u6027\u80fd\u914d\u7f6e","text":"<pre><code>mysqld --verbose --help | grep \"Default options\" -A 1\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_8","title":"\u5173\u952e\u914d\u7f6e\u9879","text":"<pre><code>\u300cinnodb_buffer_pool_size\u300d\uff1a InnoDB\u5b58\u50a8\u5f15\u64ce\u7684\u7f13\u51b2\u6c60\u5927\u5c0f\uff0c\u4e00\u822c\u5efa\u8bae\u8bbe\u7f6e\u4e3a\u7cfb\u7edf\u5185\u5b58\u768460%-80%\n\u300cinnodb_log_file_size\u300d\uff1a InnoDB\u7684\u65e5\u5fd7\u6587\u4ef6\u5927\u5c0f\uff0c\u5bf9\u4e8e\u4e8b\u52a1\u7684\u5199\u5165\u6709\u5f88\u5927\u5f71\u54cd\u3002\u5982\u679c\u8bbe\u7f6e\u5f97\u8fc7\u5c0f\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u9891\u7e41\u7684I/O\u5199\u5165\u64cd\u4f5c\n\u300cinnodb_flush_log_at_trx_commit\u300d\uff1a \u63a7\u5236\u65e5\u5fd7\u5237\u65b0\u5230\u78c1\u76d8\u7684\u7b56\u7565\u3002\u503c\u4e3a1\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u90fd\u4f1a\u5199\u5165\u65e5\u5fd7\uff0c\u786e\u4fdd\u6570\u636e\u7684\u5b89\u5168\u6027\uff0c\u4f46\u53ef\u80fd\u5f71\u54cd\u6027\u80fd\uff1b\u503c\u4e3a2\u62160\u53ef\u4ee5\u63d0\u5347\u6027\u80fd\uff0c\u4f46\u5728\u5d29\u6e83\u65f6\u53ef\u80fd\u4e22\u5931\u6570\u636e\u3002\n\u300cmax_connections\u300d\uff1a \u5141\u8bb8\u7684\u6700\u5927\u8fde\u63a5\u6570\n\u300cquery_cache_size\u300d\uff1a \u67e5\u8be2\u7f13\u5b58\u7684\u5927\u5c0f \u63d0\u5347\u8bfb\u64cd\u4f5c\u7684\u6027\u80fd\u3002\u4f46\u5728\u9ad8\u5e76\u53d1\u5199\u5165\u7684\u573a\u666f\u4e2d\uff0c\u67e5\u8be2\u7f13\u5b58\u53ef\u80fd\u53cd\u800c\u964d\u4f4e\u6027\u80fd\n\u300ctmp_table_size\u300d \u548c \u300cmax_heap_table_size\u300d\uff1a \u51b3\u5b9a\u4e86\u4e34\u65f6\u8868\u7684\u6700\u5927\u5927\u5c0f\uff0c\u5982\u679c\u4e34\u65f6\u8868\u8d85\u8fc7\u8fd9\u4e2a\u5927\u5c0f\uff0c\u5b83\u4f1a\u8f6c\u6362\u4e3a\u78c1\u76d8\u4e0a\u7684MyISAM\u8868\uff0c\u5f71\u54cd\u6027\u80fd\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_9","title":"\u5907\u4efd","text":"<p>\u903b\u8f91\u5907\u4efd\uff0c\u7269\u7406\u5907\u4efd\uff0c\u70ed\u5907\u4efd\uff0c\u51b7\u5907\u4efd\u3002clone</p> <p>\u8fd9\u91cc\u9009\u7528 xtrabackup</p> <pre><code>wget https://downloads.percona.com/downloads/Percona-XtraBackup-8.0/Percona-XtraBackup-8.0.35-30/binary/debian/jammy/x86_64/percona-xtrabackup-80_8.0.35-30-1.jammy_amd64.deb\n</code></pre> <p>\u5907\u4efd\u8bbe\u8ba1\uff1a on-deman \u624b\u52a8\u4e00\u6b21\u89e6\u53d1 sechulder \u5468\u671f\u5907\u4efd\u3002 \u5907\u4efd\u4fdd\u7559\u7b56\u7565</p> <pre><code># \u4e00\u6b21\u5168\u5907\nxtrabackup --backup --parallel=10 --host=10.10.2.13 --user=root --target-dir=/tmp/full -p\nxtrabackup --prepare --use-memory=2G --target-dir=/tmp/full\n\n# \u589e\u91cf\u5907\u4efd\nxtrabackup --backup --host=10.10.2.13 --user=root --target-dir=/tmp/a/inc1 --incremental-basedir=/tmp/a/ -p\n\nxtrabackup --prepare --apply-log-only --target-dir=/tmp/a  \n\nxtrabackup --prepare --apply-log-only --target-dir=/tmp/a --incremental-dir=/tmp/a/inc1/  \n\n# \u538b\u7f29\u5907\u4efd\nxtrabackup --backup  --compress --compress-threads=8 --host=10.10.2.13 --user=root --target-dir=/tmp/c -p\n\n# \u6d41\u5907\u4efd\nxtrabackup --backup --stream=xbstream --host=10.10.2.13 --user=root --target-dir=/tmp/a -p 2&gt;/data/backup/xtrabackup.log &gt; /tmp/backup0625.xbstream\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_10","title":"\u6570\u636e\u5bfc\u51fa\u5bfc\u5165","text":"<pre><code>--\u5bfc\u51fa\u8868\u7ed3\u6784\nmysqldump -uroot -proot -h192.168.6.10 -P3306 --databases XXX \\\n--tables XXX --single-transaction \\\n--hex-blob --no-data --routines --events --triggers --master-data=2 --set-gtid-purged=OFF \\\n--default-character-set=utf8 | sed -e 's/DEFINER[ ]*=[ ]*[^*]*\\*/\\*/' \\\n-e 's/DEFINER[ ]*=.*FUNCTION/FUNCTION/' \\\n-e 's/DEFINER[ ]*=.*PROCEDURE/PROCEDURE/' \\\n-e 's/DEFINER[ ]*=.*TRIGGER/TRIGGER/' \\\n-e 's/DEFINER[ ]*=.*EVENT/EVENT/' \\\n-e 's/DEFINER[ ]*=.*SQL SECURITY DEFINER/SQL SECURITY DEFINER/' \\\n&gt; /home/mysql/backup/XXX_ddl.sql\n\n--\u5bfc\u51fa\u6570\u636e,\u53ef\u4ee5\u5e26\u6761\u4ef6  --where=\"column1=1\"\nmysqldump -uroot -proot -h192.168.6.10 -P3306 --databases XXX \\\n--tables XXX \\\n--single-transaction --hex-blob --no-create-info \\\n--skip-triggers --master-data=2 \\\n--default-character-set=utf8 &gt; /home/mysql/backup/XXX_data.sql\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_11","title":"\u914d\u7f6e","text":"<p>\u6162\u67e5\u8be2</p> <p>``` \u4e5f\u53ef\u4ee5\u5728MySQL\u547d\u4ee4\u884c\u4e2d\u4fee\u6539\u53c2\u6570\u5f00\u542f\u6162\u67e5\u8be2\u65e5\u5fd7 mysql&gt; SET GLOBAL slow_query_log = 1; mysql&gt; SET GLOBAL slow_query_log_file = '/data/mysql/log/query_log/slow_statement.log'; mysql&gt; SET GLOBAL long_query_time = 10; mysql&gt; SET GLOBAL log_output = 'FILE'; \u8fde\u63a5\u6570 --Connections</p>"},{"location":"mysql/PrivilegeManagement/#_12","title":"\u4fdd\u6301\u5728\u7f13\u5b58\u4e2d\u7684\u53ef\u7528\u8fde\u63a5\u7ebf\u7a0b","text":""},{"location":"mysql/PrivilegeManagement/#default-1","title":"default = -1\uff08\u65e0\uff09","text":"<p>thread_cache_size = 16</p>"},{"location":"mysql/PrivilegeManagement/#_13","title":"\u6700\u5927\u7684\u8fde\u63a5\u7ebf\u7a0b\u6570(\u5173\u7cfb\u578b\u6570\u636e\u5e93)","text":""},{"location":"mysql/PrivilegeManagement/#default-151","title":"default = 151","text":"<p>max_connections = 1000</p>"},{"location":"mysql/PrivilegeManagement/#kv","title":"\u6700\u5927\u7684\u8fde\u63a5\u7ebf\u7a0b\u6570(\u6587\u6863\u578b/KV\u578b)","text":""},{"location":"mysql/PrivilegeManagement/#default-100","title":"default = 100","text":""},{"location":"mysql/PrivilegeManagement/#mysqlx_max_connections-700","title":"mysqlx_max_connections = 700","text":"<p>--\u7f13\u51b2\u533a Buffer</p>"},{"location":"mysql/PrivilegeManagement/#default-128m","title":"\u7f13\u51b2\u533a\u5355\u4f4d\u5927\u5c0f\uff1bdefault = 128M","text":"<p>innodb_buffer_pool_size = 128M</p>"},{"location":"mysql/PrivilegeManagement/#70","title":"\u7f13\u51b2\u533a\u603b\u5927\u5c0f\uff0c\u5185\u5b58\u768470%\uff0c\u5355\u4f4d\u5927\u5c0f\u7684\u500d\u6570","text":""},{"location":"mysql/PrivilegeManagement/#default-128m_1","title":"default = 128M","text":"<p>innodb_buffer_pool_size = 6G</p>"},{"location":"mysql/PrivilegeManagement/#mysql-innodb_buffer_pool_instances","title":"\u4ee5\u4e0a\u4e24\u4e2a\u53c2\u6570\u7684\u8bbe\u5b9a\uff0cMySQL\u4f1a\u81ea\u52a8\u6539\u53d8 innodb_buffer_pool_instances \u7684\u503c","text":"<p>--I/O \u7ebf\u7a0b\u6570</p>"},{"location":"mysql/PrivilegeManagement/#io","title":"\u5f02\u6b65I/O\u5b50\u7cfb\u7edf","text":""},{"location":"mysql/PrivilegeManagement/#default-no","title":"default = NO","text":"<p>innodb_use_native_aio = NO</p>"},{"location":"mysql/PrivilegeManagement/#_14","title":"\u8bfb\u6570\u636e\u7ebf\u7a0b\u6570","text":""},{"location":"mysql/PrivilegeManagement/#default-4","title":"default = 4","text":"<p>innodb_read_io_threads = 32</p>"},{"location":"mysql/PrivilegeManagement/#_15","title":"\u5199\u5165\u6570\u636e\u7ebf\u7a0b\u6570","text":""},{"location":"mysql/PrivilegeManagement/#default-4_1","title":"default = 4","text":"<p>innodb_write_io_threads = 32</p> <p>--Open cache</p>"},{"location":"mysql/PrivilegeManagement/#default-5000","title":"default = 5000","text":"<p>open_files_limit = 10000</p>"},{"location":"mysql/PrivilegeManagement/#maxopen_files_limit-10-max_connections2400","title":"\u8ba1\u7b97\u516c\u5f0f\uff1aMAX((open_files_limit-10-max_connections)/2,400)","text":""},{"location":"mysql/PrivilegeManagement/#default-4000","title":"default = 4000","text":"<p>table_open_cache = 4495</p>"},{"location":"mysql/PrivilegeManagement/#16","title":"\u8d85\u8fc716\u6838\u7684\u786c\u4ef6\uff0c\u80af\u5b9a\u8981\u589e\u52a0\uff0c\u4ee5\u53d1\u6325\u51fa\u6700\u5927\u6027\u80fd","text":""},{"location":"mysql/PrivilegeManagement/#default-16","title":"default = 16","text":"<p>table_open_cache_instances = 32  ```</p> <p>binlog \u6e05\u7406</p> <pre><code>## \u81ea\u52a8\u6e05\u7406\nshow variables like '%binlog_expire_logs_seconds%'  \n\nmysql8.0\nmysql 8\u5f00\u59cb expire_logs_days \u5e9f\u5f03 ,\n\u542f\u7528binlog_expire_logs_seconds\u8bbe\u7f6ebinlog\n\u81ea\u52a8\u6e05\u9664\u65e5\u5fd7\u65f6\u95f4,\u4fdd\u5b58\u65f6\u95f4 \n\u4ee5\u79d2\u4e3a\u5355\u4f4d\uff1b\u9ed8\u8ba42592000 30\u5929\n14400   4\u5c0f\u65f6\uff1b86400  1\u5929\uff1b259200  3\u5929\uff1b\nmysql&gt; set global binlog_expire_logs_seconds=86400;\n\n## \u624b\u52a8\u6e05\u7406\n\u67e5\u770b\u65e5\u5fd7\u6587\u4ef6\u3002\nmysql&gt;show binary logs;\n\u7b2c\u4e8c\u6b65\uff1a\u67e5\u770b\u6b63\u5728\u4f7f\u7528\u7684\u65e5\u5fd7\u6587\u4ef6\uff1ashow master status;\nmysql&gt;show master status;\n\u5f53\u524d\u6b63\u5728\u4f7f\u7528\u7684\u65e5\u5fd7\u6587\u4ef6\u662fmysqlhost01-bin.000010\uff0c\n\u90a3\u4e48\u5220\u9664\u65e5\u5fd7\u6587\u4ef6\u7684\u65f6\u5019\u5e94\u8be5\u6392\u9664\u6389\u8be5\u6587\u4ef6\u3002\n\u5220\u9664\u65e5\u5fd7\u6587\u4ef6\u7684\u547d\u4ee4\uff1apurge binary logs to 'mysqlhost01-bin.000010';\nmysql&gt;purge binary logs to 'mysqlhost01-bin.000010';\n\n## \u5207\u6362\u65e5\u5fd7\nflush logs;\n</code></pre> <p>\u65e5\u5fd7</p> <pre><code>    \u91cd\u505a\u65e5\u5fd7\uff08redo log\uff09\n    \u56de\u6eda\u65e5\u5fd7\uff08undo log\uff09\n    \u5f52\u6863\u65e5\u5fd7\uff08binlog\uff09\n    \u9519\u8bef\u65e5\u5fd7\uff08errorlog\uff09\n    \u6162\u67e5\u8be2\u65e5\u5fd7\uff08slow query log\uff09\n    \u4e00\u822c\u67e5\u8be2\u65e5\u5fd7\uff08general log\uff09\n    \u4e2d\u7ee7\u65e5\u5fd7\uff08relay log\uff09\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_16","title":"\u76d1\u63a7","text":""},{"location":"mysql/PrivilegeManagement/#pmm","title":"pmm","text":"<pre><code>mysql \u76d1\u63a7\u7ba1\u7406\u7528\u6237\nCREATE USER 'pmm'@'127.0.0.1' IDENTIFIED BY 'pass' WITH MAX_USER_CONNECTIONS 10;\nGRANT SELECT, PROCESS, REPLICATION CLIENT, RELOAD, BACKUP_ADMIN ON *.* TO 'pmm'@'127.0.0.1';\n</code></pre> <pre><code>server \u7aef \u5b89\u88c5\ncurl -fsSL https://www.percona.com/get/pmm | /bin/bash\n</code></pre> <pre><code>agent \u7aef \u5b89\u88c5\nwget https://repo.percona.com/apt/percona-release_latest.generic_all.deb\ndpkg -i percona-release_latest.generic_all.deb\napt-get update\napt install -y pmm2-client\napt-get install -y qpress\n\n\u914d\u7f6e \u6ce8\u518c server\npmm-admin config --server-insecure-tls --server-url=https://admin:admin@10.10.2.14:443\ncat /usr/local/percona/pmm2/config/pmm-agent.yaml\npmm-admin  add mysql --query-source=perfschema --host=10.10.2.12 --username=pmm --password=123456789\n\npmm-admin  add mysql --query-source=slowlog --host=10.10.2.12 --username=pmm --password=123456789\n\n\u67e5\u770b\npmm-admin status \npmm-admin list \n\n</code></pre>"},{"location":"mysql/PrivilegeManagement/#_17","title":"\u5e38\u7528\u547d\u4ee4","text":"<p>\u67e5\u770b\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684SQL</p> <pre><code>SHOW FULL PROCESSLIST\n</code></pre> <pre><code>show engine innodb status\\G\n</code></pre>"},{"location":"mysql/active/","title":"Active","text":"<p>\u67e5\u770b\u5f53\u524d\u6d3b\u8dc3\u7684\u4e8b\u52a1 SELECT * FROM information_schema.innodb_trx;</p> <p>KILL [transaction_thread_id];</p>"},{"location":"mysql/admin/","title":"mysql \u65e5\u5e38\u7ba1\u7406","text":""},{"location":"mysql/admin/#innodb","title":"\u67e5\u770bInnodb\u5f15\u64ce\u72b6\u6001\uff0c\u67e5\u770b\u4e0a\u6b21\u6b7b\u9501\u8be6\u60c5","text":"<p>SHOW ENGINE INNODB STATUS;</p>"},{"location":"mysql/admin/#mysql_1","title":"\u67e5\u770b\u5f53\u524d MySQL \u6267\u884c\u8fdb\u7a0b\u5217\u8868","text":"<p>SHOW FULL PROCESSLIST;</p>"},{"location":"mysql/admin/#mysql-8","title":"\u5982\u679c\u662fMysql 8\u4e4b\u524d\u7684\u7248\u672c\uff0c\u67e5\u770b\u9501\u4fe1\u606f","text":"<p>SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS; SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;</p>"},{"location":"mysql/admin/#mysql-8_1","title":"\u5982\u679c\u662fMysql 8\u4e4b\u540e\u7684\u7248\u672c\uff0c\u67e5\u770b\u9501\u4fe1\u606f","text":"<p>select * from performance_schema.data_locks;  select * from performance_schema.data_lock_waits;</p>"},{"location":"mysql/admin/#mysql-8-sql","title":"\u5982\u679c\u662fMysql 8 \u7248\u672c\u4e4b\u540e\uff0c\u4e00\u53e5SQL\u6392\u67e5\u51fa\u76f8\u5173\u963b\u585e\u539f\u56e0\uff1b","text":"<p>select c.SQL_TEXT  from performance_schema.events_statements_current c  inner join  performance_schema.data_lock_waits w ON c.THREAD_ID  = w.BLOCKING_THREAD_ID or c.THREAD_ID  = w.REQUESTING_THREAD_ID </p>"},{"location":"mysql/admin/#sql","title":"\u4f7f\u7528SQL\u5224\u65ad\uff0c\u6700\u5927\u8fde\u63a5\u6570","text":"<p>show variables like \"max_connections\";</p>"},{"location":"mysql/admin/#mysql_2","title":"\u663e\u793a mysql\u7684\u5f53\u524d\u8fde\u63a5\u6570","text":"<p>SHOW STATUS LIKE 'Threads_connected';</p>"},{"location":"mysql/admin/#mysql_3","title":"\u4e34\u65f6\u4fee\u6539mysql\u914d\u7f6e\uff0c\u91cd\u542f\u6570\u636e\u5e93\u5931\u6548","text":"<p>set GLOBAL max_connections=1000;</p>"},{"location":"mysql/admin/#_1","title":"\u6c38\u4e45\u6027\u8bbe\u7f6e\u65b9\u6848","text":"<p>\u5728[mysqld]\u4e0b\u9762\u6dfb\u52a0\uff1a max_connections=1000</p>"},{"location":"mysql/binary/","title":"mysql binlog \u7ba1\u7406","text":""},{"location":"mysql/binary/#_1","title":"\u914d\u7f6e","text":"<pre><code>[mysqld]\nlog-bin=mysql-bin          # \u542f\u7528 Binlog \u5e76\u5b9a\u4e49\u6587\u4ef6\u540d\u524d\u7f00\nserver-id=1                # \u96c6\u7fa4\u4e2d\u552f\u4e00\u6807\u8bc6\nbinlog_format=ROW          # \u63a8\u8350 ROW \u6a21\u5f0f\uff08\u6570\u636e\u4e00\u81f4\u6027\u9ad8\uff09\nexpire_logs_days=7         # \u81ea\u52a8\u6e05\u7406 7 \u5929\u524d\u7684 Binlog\uff08MySQL 5.x\uff09\nbinlog_expire_logs_seconds=604800  # MySQL 8.x \u7b49\u6548\u914d\u7f6e\uff087\u5929=604800\u79d2\uff09\nmax_binlog_size=1G         # \u5355\u4e2a Binlog \u6587\u4ef6\u6700\u5927 1GB\nsync_binlog=1\n</code></pre>"},{"location":"mysql/binary/#_2","title":"\u4fdd\u7559\u7b56\u7565","text":"<pre><code>-- \u67e5\u770b\u5f53\u524d\u914d\u7f6e\nSHOW VARIABLES LIKE 'log_bin%';\nSHOW VARIABLES LIKE 'expire_logs_days';\n\n-- \u52a8\u6001\u4fee\u6539\u4fdd\u7559\u5929\u6570\uff08MySQL 5.x\uff09\nSET GLOBAL expire_logs_days = 14;\n\n-- \u52a8\u6001\u4fee\u6539\u6587\u4ef6\u5927\u5c0f\u9650\u5236\uff08MySQL 8.x\uff09\nSET GLOBAL max_binlog_size = 2 * 1024 * 1024 * 1024;  -- 2GB\n</code></pre> <pre><code>-- \u5217\u51fa\u6240\u6709 Binlog \u6587\u4ef6\nSHOW BINARY LOGS;\n\n-- \u67e5\u770b\u5f53\u524d\u5199\u5165\u7684 Binlog \u6587\u4ef6\u53ca\u4f4d\u7f6e\nSHOW MASTER STATUS;\n</code></pre>"},{"location":"mysql/binary/#binlog","title":"\u200b\u200b\u624b\u52a8\u7ba1\u7406 Binlog\u200b\u200b","text":"<pre><code>\u200b\u200b\u5237\u65b0\u65e5\u5fd7\u200b\u200b\uff08\u5f3a\u5236\u751f\u6210\u65b0\u6587\u4ef6\uff09\n\nFLUSH BINARY LOGS;  -- \u7b49\u540c\u4e8e FLUSH LOGS\n\n\u200b\u200b\u5207\u6362\u65e5\u5fd7\u6587\u4ef6\u200b\u200b\n\nPURGE BINARY LOGS TO 'mysql-bin.000010';  -- \u5220\u9664\u6307\u5b9a\u6587\u4ef6\u524d\u7684\u6240\u6709 Binlog\nPURGE BINARY LOGS BEFORE '2024-01-01 00:00:00';  -- \u5220\u9664\u6307\u5b9a\u65f6\u95f4\u524d\u7684\u65e5\u5fd7\n\n\u200b\u200b\u91cd\u7f6e\u6240\u6709 Binlog\uff08\u614e\u7528\uff09\u200b\u200b\n\nRESET MASTER; \n</code></pre>"},{"location":"mysql/clone/","title":"Clone Plugin","text":"<p>introduced in MySQL 8.0.17</p> <ul> <li>donor \u4e0a\u6e38\u6570\u636e\u6e90 </li> <li>recipient \u4e0b\u6e38\u63a5\u6536\u7aef</li> </ul>"},{"location":"mysql/clone/#_1","title":"\u5b89\u88c5","text":"<pre><code>mysql&gt; show variables like 'plugin_dir';\n+---------------+------------------------+\n| Variable_name | Value                  |\n+---------------+------------------------+\n| plugin_dir    | /usr/lib/mysql/plugin/ |\n+---------------+------------------------+\n1 row in set (0.00 sec)\n\n</code></pre>"},{"location":"mysql/clone/#_2","title":"\u542f\u52a8\u65f6\u5b89\u88c5","text":"<pre><code>[mysqld]\nplugin-load-add=mysql_clone.so\n</code></pre>"},{"location":"mysql/clone/#_3","title":"\u8fd0\u884c\u65f6\u5b89\u88c5","text":"<pre><code>mysql&gt; INSTALL PLUGIN clone SONAME 'mysql_clone.so';\n</code></pre> <p>\u9a8c\u8bc1</p> <pre><code>mysql&gt;  SELECT PLUGIN_NAME, PLUGIN_STATUS\n    -&gt;        FROM INFORMATION_SCHEMA.PLUGINS\n    -&gt;        WHERE PLUGIN_NAME = 'clone';\n+-------------+---------------+\n| PLUGIN_NAME | PLUGIN_STATUS |\n+-------------+---------------+\n| clone       | ACTIVE        |\n+-------------+---------------+\n</code></pre> <p>\u7528\u6237\u6743\u9650</p> <pre><code>GRANT BACKUP_ADMIN ON *.* TO 'clone_user';\n</code></pre>"},{"location":"mysql/clone/#local-clone","title":"Local clone","text":""},{"location":"mysql/clone/#_4","title":"\u6a21\u62df\u6570\u636e","text":"<pre><code>CREATE DATABASE example_db;\nUSE example_db;\n\nCREATE TABLE employees (\n    id INT AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(100),\n    position VARCHAR(100),\n    salary DECIMAL(10, 2)\n);\n\nINSERT INTO employees (name, position, salary) VALUES\n('Alice', 'Developer', 90000.00),\n('Bob', 'Manager', 120000.00),\n('Charlie', 'Analyst', 70000.00);\n</code></pre>"},{"location":"mysql/clone/#clone","title":"clone","text":"<pre><code>sudo mkdir /path/to/clone_directory\nsudo chown mysql:mysql /path/to/clone_directory\n</code></pre> <pre><code>CLONE LOCAL DATA DIRECTORY = '/path/to/clone_directory/mysql';\n</code></pre>"},{"location":"mysql/clone/#_5","title":"\u9a8c\u8bc1\u514b\u9686\u64cd\u4f5c","text":"<p>\u514b\u9686\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u514b\u9686\u72b6\u6001\u548c\u8fdb\u5ea6\uff1a</p> <pre><code>sql\n-- \u68c0\u67e5\u514b\u9686\u72b6\u6001\nSELECT * FROM performance_schema.clone_status;\n\n-- \u68c0\u67e5\u514b\u9686\u8fdb\u5ea6\nSELECT * FROM performance_schema.clone_progress;\n</code></pre>"},{"location":"mysql/clone/#_6","title":"\u4f7f\u7528\u514b\u9686\u7684\u6570\u636e","text":"<p>\u5047\u8bbe\u9700\u8981\u4f7f\u7528\u514b\u9686\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u505c\u6b62 MySQL \u670d\u52a1\u5668\u5e76\u5c06\u514b\u9686\u7684\u6570\u636e\u76ee\u5f55\u66ff\u6362\u4e3a\u5f53\u524d\u6570\u636e\u76ee\u5f55\uff1a</p> <pre><code>$&gt; mysqld_safe --datadir=clone_dir\n</code></pre>"},{"location":"mysql/clone/#remote-clone","title":"Remote clone","text":""},{"location":"mysql/clone/#donor","title":"donor","text":"<p>\u7528\u6237\u9700\u8981 <code>BACKUP_ADMIN</code> \u6743\u9650</p> <pre><code>mysql&gt; CREATE USER 'donor_clone_user'@'example.donor.host.com' IDENTIFIED BY 'password';\nmysql&gt; GRANT BACKUP_ADMIN on *.* to 'donor_clone_user'@'example.donor.host.com';\n</code></pre> <p>\u5b89\u88c5clone\u63d2\u4ef6</p> <pre><code>INSTALL PLUGIN clone SONAME 'mysql_clone.so';\n</code></pre>"},{"location":"mysql/clone/#recipient","title":"recipient","text":"<p>\u7528\u6237\u9700\u8981 <code>CLONE_ADMIN</code> \u6743\u9650 , <code>CLONE_ADMIN</code> \u6743\u9650\u5305\u62ec <code>BACKUP_ADMIN</code> \u548c <code>SHUTDOWN</code></p> <pre><code>mysql&gt; CREATE USER 'recipient_clone_user'@'example.recipient.host.com' IDENTIFIED BY 'password';\nmysql&gt; GRANT CLONE_ADMIN on *.* to 'recipient_clone_user'@'example.recipient.host.com';\n</code></pre> <p>\u5728clone\u5b8c\u6210\u540e\uff0c\u63a5\u53d7\u7aef\u4f1a\u6267\u884cshutdown</p> <p>\u5b89\u88c5clone\u63d2\u4ef6</p> <pre><code>mysql&gt; INSTALL PLUGIN clone SONAME 'mysql_clone.so';\n</code></pre> <p>\u914d\u7f6edonor \u5730\u5740</p> <pre><code>mysql&gt; SET GLOBAL clone_valid_donor_list = 'example.donor.host.com:3306';\n</code></pre>"},{"location":"mysql/clone/#clone_1","title":"clone\u8bed\u6cd5","text":"<pre><code>CLONE INSTANCE FROM 'user'@'host':port\nIDENTIFIED BY 'password'\n[DATA DIRECTORY [=] 'clone_dir']\n[REQUIRE [NO] SSL];\n</code></pre> <p>clone\u64cd\u4f5c\u4f1a\u9996\u5148\u6e05\u7406\u672c\u5730\u6570\u636e\uff0c\u5305\u62ec(schemas, tables, tablespaces) \u548c binary logs\u3002</p> <pre><code>CLONE INSTANCE FROM 'myuser'@'10.1.40.84':3306 IDENTIFIED BY 'mypassword';\n</code></pre>"},{"location":"mysql/clone/#_7","title":"\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"mysql/clone/#ddl","title":"DDL","text":"<p>MySQL 8.0.27 \u7248\u672c\u4e4b\u524d\u4f1a\u5835\u585e\u3002 <code>clone_ddl_timeout=300</code> \u79d2</p> <p>MySQL 8.0.27 \u7248\u672c\u4e4b\u540e\u652f\u6301\u5e76\u884c\u6267\u884c\uff0c<code>clone_block_ddl=OFF</code> </p>"},{"location":"mysql/clone/#_8","title":"\u6570\u636e\u5e93\u7248\u672c","text":"<p>8.0.17 \u7248\u672c\u5f00\u59cb\u652f\u6301 clone ,8.0.37 \u524d\u7248\u672c\u5fc5\u987b\u4e00\u81f4\u3002</p> <pre><code>mysql&gt; SHOW VARIABLES LIKE 'version';\n</code></pre>"},{"location":"mysql/clone/#system-block-sizes","title":"system block sizes","text":"<p>\u4fdd\u6301\u4e00\u81f4</p> <pre><code>stat -f -c '%s' /\n\u6216\nsudo blockdev --getbsz /dev/sda1\n</code></pre>"},{"location":"mysql/clone/#_9","title":"\u72b6\u6001\u67e5\u770b","text":"<pre><code>mysql&gt; SELECT STATE FROM performance_schema.clone_status;\n</code></pre> <pre><code>SELECT *  FROM performance_schema.clone_progress;\n</code></pre> <pre><code>SELECT NAME,ENABLED FROM performance_schema.setup_instruments\n       WHERE NAME LIKE '%clone%';\n</code></pre>"},{"location":"mysql/config/","title":"\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"mysql/config/#_2","title":"\u67e5\u770b\u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e","text":"<pre><code>mysql --verbose --help | grep -A 1 'Default options'\n</code></pre>"},{"location":"mysql/config/#_3","title":"\u7cfb\u7edf\u8fd0\u884c\u53d8\u91cf","text":"<pre><code>mysql&gt; SHOW VARIABLES;\nmysql&gt; SHOW STATUS;\n</code></pre>"},{"location":"mysql/config/#_4","title":"\u7cfb\u7edf\u8fd0\u884c\u53d8\u91cf","text":"<pre><code>mysqladmin variables\nmysqladmin extended-status\n</code></pre>"},{"location":"mysql/config/#_5","title":"\u53c2\u6570\u9a8c\u8bc1","text":"<pre><code>mysqld --validate-config --log_error_verbosity=2\n</code></pre>"},{"location":"mysql/config/#_6","title":"\u6b63\u5728\u6267\u884c\u8bed\u53e5\u67e5\u770b","text":"<pre><code> show processlist;\n</code></pre>"},{"location":"mysql/config/#_7","title":"\u67e5\u770b\u8fd0\u884c\u72b6\u6001","text":"<pre><code>mysqladmin status -h 10.10.2.11 -pmysql_4U\n</code></pre>"},{"location":"mysql/config/#_8","title":"\u65e5\u5fd7\u76f8\u5173","text":""},{"location":"mysql/config/#_9","title":"\u6162\u67e5\u8be2","text":"<pre><code>long_query_time # \u65e5\u5fd7\u9600\u503c\uff08\u79d2\uff09\nlog_queries_not_using_indexes # \u8bb0\u5f55\u6ca1\u8d70\u7d22\u5f15\u7684sql\nlog_throttle_queries_not_using_indexes # \u6bcf\u79d2\u4e2d\u8bb0\u5f55\u6ca1\u8d70\u7d22\u5f15\u7684sql\u6570\u91cf\uff0c\u9632\u6b62\u8fc7\u591a\u3002\u9ed8\u8ba40\n</code></pre> <p>https://ma.ttias.be/mysql-slow-query-log-without-restart/</p> <pre><code>slow_query_log=ON\nslow_query_log_file='/var/lib/mysql/node1-slow.log'\nlog_output='FLIE'\n</code></pre> <p>mysqldumpslow \u6162\u67e5\u8be2\u663e\u793a\u683c\u5f0f\u5de5\u5177</p>"},{"location":"mysql/config/#table-file-none","title":"\u65e5\u5fd7\u8f93\u51fa\u4f4d\u7f6e table file none","text":"<p>log_output='TABLE' # \u5c06\u6162\u65e5\u5fd7\u8f93\u5165\u5230Table\u4e2d\u3002</p> <pre><code>SELECT \n    start_time,\n    user_host,\n    query_time,\n    lock_time,\n    rows_sent,\n    rows_examined,\n    db,\n    last_insert_id,\n    insert_id,\n    server_id,\n    CONVERT(sql_text USING utf8mb4) AS sql_text,\n    thread_id\nFROM \n    mysql.slow_log\\G\n</code></pre>"},{"location":"mysql/config/#_10","title":"\u901a\u7528\u65e5\u5fd7","text":"<pre><code>general_log=OFF\ngeneral_log_file\n</code></pre> <p>session \u4e2d\u5173\u95ed\u64cd\u4f5c\u8bb0\u5f55</p>"},{"location":"mysql/config/#_11","title":"\u9519\u8bef\u65e5\u5fd7","text":"<pre><code>log_error=/var/log/mysql/error.log\nlog_error_verbosity=2 \nlog-warnings\uff1a\u662f\u5426\u5c06\u8b66\u544a\u4fe1\u606f\u8f93\u51fa\u5230\u9519\u8bef\u65e5\u5fd7\u4e2d\u3002\nlog_warnings \u4e3a0\uff0c \u8868\u793a\u4e0d\u8bb0\u5f55\u544a\u8b66\u4fe1\u606f\u3002\nlog_warnings \u4e3a1\uff0c \u8868\u793a\u544a\u8b66\u4fe1\u606f\u5199\u5165\u9519\u8bef\u65e5\u5fd7\u3002log_warnings \u5927\u4e8e1\uff0c \u8868\u793a\u5404\u7c7b\u544a\u8b66\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a\u6709\u5173\u7f51\u7edc\u6545\u969c\u7684\u4fe1\u606f\u548c\u91cd\u65b0\u8fde\u63a5\u4fe1\u606f\u5199\u5165\n\u9519\u8bef\u65e5\u5fd7\n</code></pre>"},{"location":"mysql/config/#_12","title":"\u4e8c\u8fdb\u5236\u65e5\u5fd7","text":"<pre><code>\u52a0\u5bc6\nbinlog_encryption=OFF\n\nmax_binlog_size=1073741824 # \u8bbe\u7f6e\u5355\u4e2abinlog\u6587\u4ef6\u7684\u6700\u5927\u5927\u5c0f\u4e3a1GB\n# \u65e5\u5fd7\u5b58\u50a8\u4f4d\u7f6e mkdir binlog chmod 700 binlog  chown mysql:mysql -R binlog\nlog_bin=ON\nlog_bin_basename=/var/lib/mysql/binlog/mysql-bin.log\nlog_bin_index=/var/lib/mysql/binlog/mysql-bin.index\nsql_log_bin=ON # \u5f53sql_log_bin\u5173\u95ed\u540e,\u4e3b\u5e93\u670d\u52a1\u5668\u4e0a\u7684\u6539\u52a8\u4e0d\u8bb0\u5f55bin log,\u4e0d\u4f1a\u590d\u5236\u5230\u4ece\u5e93\n</code></pre> <pre><code>binlog_format= ROW #ROW, STATEMENT ,MIXED \n</code></pre> <p>\u65e5\u5fd7\u4fdd\u7559\u65f6\u95f4\u9ed8\u8ba4 30d</p> <pre><code>binlog_expire_logs_auto_purge = ON\nbinlog_expire_logs_seconds = 2592000 \nexpire_logs_days=0 # \u53c2\u6570\u5df2\u5931\u6548\n</code></pre> <p>\u67e5\u770b\u65e5\u5fd7\u6587\u4ef6 show binary logs; show master logs;</p>"},{"location":"mysql/config/#_13","title":"\u9700\u8981\u4fee\u6539\u7684\u53c2\u6570","text":"<pre><code># \u5e76\u53d1\u67e5\u8be2\u6570\ninnodb_thread_concurrency = 0\n\n# redolog size \u9ed8\u8ba4128MB \u8fc7\u5c0f\n</code></pre> <p>innodb_max_dirty_pages_pct     | 90.000000 | innodb_max_dirty_pages_pct_lwm | 10.000000 |</p>"},{"location":"mysql/config/#_14","title":"\u5b89\u5168","text":"<p>\u53c2\u6570 sql_safe_updates \u5de5\u5177 flashback mysqlbinlog</p>"},{"location":"mysql/config/#innodb","title":"innodb \u53c2\u6570","text":""},{"location":"mysql/config/#innodb_dedicated_server","title":"innodb_dedicated_server","text":"<p>\u6839\u636e\u63a2\u6d4b\u670d\u52a1\u5668\u5185\u5b58\u81ea\u52a8\u914d\u7f6e \u901a\u5e38\u4f1a\u5360\u752850%~75%\u7684\u5185\u5b58. 25% \u5185\u5b58\u53ef\u7528\u4e8e\u6bcf\u4e2a\u8fde\u63a5\u3002</p> <pre><code>innodb_dedicated_server # \u81ea\u52a8\u9002\u914d\u5982\u4e0b\u53c2\u6570\n\ninnodb_buffer_pool_size=134217728 (128MB)\ninnodb_log_file_size=50331648 (48MB)\ninnodb_log_files_in_group=2 \ninnodb_redo_log_capacity=104857600\ninnodb_flush_method=fsync\n</code></pre> <p>\u5b98\u65b9\u7ed9\u51fa\u7684\u89c4\u5219\u5982\u4e0b\uff1a</p> \u670d\u52a1\u5668\u5185\u5b58\u5927\u5c0f buffer_pool_size\u5927\u5c0f \u4e00\u6863 Less than 1GB \u4e8c\u6863 1GB to 4GB \u4e09\u6321 Greater than 4GB <p>\u6bd4\u8f83\u6fc0\u8fdb</p>"},{"location":"mysql/config/#innodb_buffer_pool_size","title":"innodb_buffer_pool_size","text":"<p>\u603b\u5185\u5b58\u768450%-60%</p> <p>\u5173\u8054\u53c2\u6570</p> <ul> <li>innodb_buffer_pool_instances= cpu\u6838\u6570*N</li> <li>innodb_buffer_pool_chunk_size=128MB</li> <li>innodb_buffer_pool_size=innodb_buffer_pool_instances * innodb_buffer_pool_chunk_size * N</li> </ul> <pre><code>SELECT @@innodb_buffer_pool_size as pool_size,\n    -&gt; @@innodb_buffer_pool_instances as pool_instances,\n    -&gt; @@innodb_buffer_pool_chunk_size as chunk_size;\n</code></pre>"},{"location":"mysql/config/#innodb_flush_method","title":"innodb_flush_method","text":"<ul> <li>fsync</li> <li>O_DSYNC</li> <li>O_DIRECT</li> </ul>"},{"location":"mysql/config/#innodb_file_per_table","title":"innodb_file_per_table","text":"<p>\u72ec\u7acb\u8868\u7a7a\u95f4 </p> <p>\u5982\u679c\u542f\u7528\u4e86innodb_file_per_talbe\u53c2\u6570\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u6bcf\u5f20\u8868\u7684\u8868\u7a7a\u95f4\u5185\u5b58\u653e\u7684\u53ea\u662f\u6570\u636e\u3001\u7d22\u5f15\u548c\u63d2\u5165\u7f13\u51b2Bitmap\u9875\uff0c\u5176\u4ed6\u6570\u636e\u5982\uff1a\u56de\u6eda\u4fe1\u606f\u3001\u63d2\u5165\u7f13\u51b2\u7d22\u5f15\u9875\u3001\u7cfb\u7edf\u4e8b\u7269\u4fe1\u606f\u3001\u4e8c\u6b21\u5199\u7f13\u51b2\uff08Double write buffer\uff09\u7b49\u8fd8\u662f\u653e\u5728\u539f\u6765\u7684\u5171\u4eab\u8868\u7a7a\u95f4\u5185\u3002\u540c\u65f6\u8bf4\u660e\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a\u5373\u4f7f\u542f\u7528\u4e86innodb_file_per_table\u53c2\u6570\u5171\u4eab\u8868\u7a7a\u95f4\u8fd8\u662f\u4f1a\u4e0d\u65ad\u7684\u589e\u52a0\u5176\u5927\u5c0f\u7684\u3002</p>"},{"location":"mysql/config/#innodb_flush_log_at_trx_commit","title":"innodb_flush_log_at_trx_commit","text":"<p>\u901a\u5e38\u6211\u4eec\u8bf4MySQL\u7684\u201c\u53cc1\u201d\u914d\u7f6e\uff0c\u6307\u7684\u5c31\u662fsync_binlog\u548c innodb_flush_log_at_trx_commit\u90fd\u8bbe\u7f6e\u6210 1</p> <pre><code>sync_binlog=1\ninnodb_flush_log_at_trx_commit=1\n</code></pre>"},{"location":"mysql/config/#innodb_redo_log_capacity","title":"innodb_redo_log_capacity","text":"<p>redo log \u5927\u5c0f</p> <pre><code>innodb_log_file_size=50331648 (48MB)  # \u65e7\u7248\u53c2\u6570\u5df2\u5931\u6548\ninnodb_log_files_in_group=2       # \u65e7\u7248\u53c2\u6570\u5df2\u5931\u6548\ninnodb_redo_log_capacity # 8.0.30 \u65b0\u53c2\u6570\u3002 \u8bbe\u7f6e\u8fd9\u4e2a\u53c2\u6570\u540e\u524d\u9762\u7684\u4e24\u4e2a\u5931\u6548\n</code></pre> <p>\u5f53\u524d\u6240\u6709\u6d3b\u8dc3redo log\u7684\u72b6\u6001</p> <pre><code>SELECT * FROM performance_schema.innodb_redo_log_files;\nshow global status like '%innodb%redo%';\n</code></pre> <p>https://www.cnblogs.com/greatsql/p/16883835.html</p> <p>redo log\u5b58\u50a8\u5728 datadir/#innodb_redo\u4e0b\uff0c\u753132\u4e2a\u6587\u4ef6\u7ec4\u6210\u3002\u6587\u4ef6\u547d\u540d\u4e3a #ib_redoN**\uff0c\u6bcf\u4e2a\u6587\u4ef6\u5927\u5c0f\u662f innodb_redo_log_capacity/32</p> <p>\u6709\u4e24\u79cd\u7c7b\u578b\u7684redo log\u6587\u4ef6\uff0c\u4e00\u79cd\u662f\u5f53\u524d\u6b63\u5728\u4f7f\u7528\u7684\uff08ordinary\uff09\uff0c\u6587\u4ef6\u540d\u662f\u6b63\u5e38\u7684 #ib_redoN\uff1b\u53e6\u4e00\u79cd\u662f\u7a7a\u95f2\u7684\uff08spare\uff09\uff0c\u6587\u4ef6\u540d\u4e3a #ib_redoN_tmp\uff0c\u591a\u52a0\u4e86\u4e2a _tmp \u540e\u7f00\u3002</p> <pre><code>#innodb_redo$ ls -l\ntotal 102400\n-rw-r----- 1 1001 1001 3276800 Nov 11 03:30 '#ib_redo199'\n-rw-r----- 1 1001 1001 3276800 Nov 11 07:32 '#ib_redo200'\n-rw-r----- 1 1001 1001 3276800 Nov 11 11:35 '#ib_redo201'\n-rw-r----- 1 1001 1001 3276800 Nov 11 15:38 '#ib_redo202'\n-rw-r----- 1 1001 1001 3276800 Nov 11 19:38 '#ib_redo203'\n-rw-r----- 1 1001 1001 3276800 Nov 11 23:38 '#ib_redo204'\n-rw-r----- 1 1001 1001 3276800 Nov 12 03:40 '#ib_redo205'\n-rw-r----- 1 1001 1001 3276800 Nov 12 07:39 '#ib_redo206'\n-rw-r----- 1 1001 1001 3276800 Nov 12 08:00 '#ib_redo207'\n-rw-r----- 1 1001 1001 3276800 Nov 11 01:40 '#ib_redo208_tmp'\n-rw-r----- 1 1001 1001 3276800 Nov 11 01:40 '#ib_redo209_tmp'\n-rw-r----- 1 1001 1001 3276800 Nov 11 01:40 '#ib_redo210_tmp'\n</code></pre>"},{"location":"mysql/doublewrite/","title":"Doublewrite","text":"<p>show variables like '%double%'; +-------------------------------+-------+ | Variable_name                 | Value | +-------------------------------+-------+ | innodb_doublewrite            | ON    | | innodb_doublewrite_batch_size | 0     | | innodb_doublewrite_dir        |       | | innodb_doublewrite_files      | 2     | | innodb_doublewrite_pages      | 4     | +-------------------------------+-------</p> <p>show status like '%lwr%'; +----------------------------+---------+ | Variable_name              | Value   | +----------------------------+---------+ | Innodb_dblwr_pages_written | 6339188 | | Innodb_dblwr_writes        | 1991962 | +----------------------------+---------+</p>"},{"location":"mysql/exporter/","title":"exporter \u76d1\u63a7","text":""},{"location":"mysql/exporter/#_1","title":"\u7528\u6237\u53ca\u6743\u9650","text":"<pre><code>CREATE USER 'exporter'@'%' IDENTIFIED BY 'f72affe6577a5b6334ae79adf2936f27' WITH MAX_USER_CONNECTIONS 3;\nGRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'%';\n</code></pre>"},{"location":"mysql/exporter/#multi-target-support","title":"Multi-target support","text":"<pre><code>mysql1\nmysql2  -&gt; exporter -&gt; prometheus   \nmysql3 \n</code></pre>"},{"location":"mysql/exporter/#mysqld_exporter","title":"\u914d\u7f6e mysqld_exporter","text":"<p>my.cnf</p> <pre><code>[client]\n  user = exporter\n  password = f72affe6577a5b6334ae79adf2936f27\n[client.servers1]\n    user = bar1\n    password = bar1123\n[client.servers2]\n    user = bar2\n    password = bar1223\n</code></pre> <pre><code>./mysqld_exporter --config.my-cnf=my.cnf \n</code></pre>"},{"location":"mysql/exporter/#prometheus","title":"prometheus \u914d\u7f6e","text":"<pre><code> - job_name: mysql # To get metrics about the mysql exporter\u2019s targets\n      params:\n        # Not required. Will match value to child in config file. Default value is `client`.\n        auth_module: [client.servers]\n      static_configs:\n        - targets:\n          # All mysql hostnames or unix sockets to monitor.\n          - server1:3306\n          - server2:3306\n      relabel_configs:\n        - source_labels: [__address__]\n          target_label: __param_target\n        - source_labels: [__param_target]\n          target_label: instance\n        - target_label: __address__\n          # The mysqld_exporter host:port\n          replacement: localhost:9104\n</code></pre> <p>helmbroker-m002-0.helmbroker-m002.zhangjint.svc.cluster.local</p> <p>hb-mysql-cluster-standard-10-0.hb-mysql-cluster-standard-10.drycc-addons-test.svc.cluster.local</p> <p>IYZGaU5Wdw</p>"},{"location":"mysql/install/","title":"mysql \u5b89\u88c5","text":""},{"location":"mysql/install/#ubuntu","title":"ubuntu","text":"<p>\u57fa\u7840\u4f9d\u8d56\u8f6f\u4ef6\u5b89\u88c5</p> <pre><code>sudo apt-get install libmecab2 \\\n                     libjson-perl \\ \n                     mecab-ipadic-utf8 \\\n                     mecab-utils \\ \n                     mecab-ipadic\n</code></pre>"},{"location":"mysql/install/#apt","title":"apt \u6e90\u5b89\u88c5","text":"<p>\u5b89\u88c5\u5f53\u524d\u6700\u65b0\u7248\u672c,\u6709apt\u6e90\u7ef4\u62a4</p> <p>https://dev.mysql.com/downloads/</p> <p><code>MySQL APT Repository -&gt;</code></p> <p><code>Ubuntu / Debian (Architecture Independent), DEB Package        17.6K   Download</code></p> <pre><code>wget mysql-apt-config_0.8.33-1_all.deb\ndpkg -i ./mysql-apt-config_0.8.33-1_all.deb\n</code></pre> <p>\u751f\u6210\u6e90\u6587\u4ef6 <code>/etc/apt/sources.list.d/mysql.list</code></p> <pre><code># apt-get update -y \n\n# apt list -a mysql-server\nListing... Done\nmysql-server/unknown 8.0.40-1ubuntu22.04 amd64 [upgradable from: 8.0.36-1ubuntu22.04]\nmysql-server/jammy-updates,jammy-security 8.0.40-0ubuntu0.22.04.1 amd64\nmysql-server/now 8.0.36-1ubuntu22.04 amd64 [installed,upgradable to: 8.0.40-1ubuntu22.04]\nmysql-server/jammy 8.0.28-0ubuntu4 amd64\n</code></pre> <p>\u9009\u62e9\u7248\u672c\u8fdb\u884c\u5b89\u88c5</p> <pre><code>apt-get install mysql-server='8.0.40-1ubuntu22.04'\n</code></pre> <p>\u5927\u7248\u672c\u9009\u62e9</p> <pre><code>sudo dpkg-reconfigure mysql-apt-config\n</code></pre>"},{"location":"mysql/install/#_1","title":"\u5b89\u88c5\u5305\u6307\u5b9a\u7248\u672c\u5b89\u88c5","text":"<p>\u4e0b\u8f7d\u6307\u7684\u7248\u672c https://downloads.mysql.com/archives/community/</p> <p><code>Ubuntu Linux 23.10 (x86, 64-bit), DEB Bundle   Dec 14, 2023    415.2M  Download</code></p> <p>\u89e3\u538b\u5e76\u5b89\u88c5</p> <pre><code>tar xf ./mysql-server_8.0.36-1ubuntu22.04_amd64.deb-bundle.tar\ndpkg -i  ./*.deb\n</code></pre>"},{"location":"mysql/install/#mysqlshell","title":"mysqlshell","text":"<p>\u4e0b\u8f7d\u5730\u5740 https://dev.mysql.com/downloads/shell/</p> <pre><code>DEB Package     8.0.40  36.5M   Download\n(mysql-shell_8.0.40-1ubuntu22.04_amd64.deb)     MD5: d965889b156b3db9451bfd367ea8d51a | Signature\n</code></pre> <p>\u4e0b\u8f7d\u5e76\u5b89\u88c5</p> <pre><code>wget https://dev.mysql.com/get/Downloads/MySQL-Shell/mysql-shell_8.0.40-1ubuntu22.04_amd64.deb\ndpkg -i ./mysql-shell_8.0.40-1ubuntu22.04_amd64.deb\n</code></pre>"},{"location":"mysql/install/#mysql-router","title":"mysql-router","text":"<p>\u4e0b\u8f7d\u5730\u5740 https://dev.mysql.com/downloads/router/</p> <pre><code>DEB Package     8.0.40  9.0M    Download\n(mysql-router-community_8.0.40-1ubuntu22.04_amd64.deb)  MD5: 9e207810588fad642c93306c483e76b8 | Signature\n</code></pre> <p>\u4e0b\u8f7d\u5e76\u5b89\u88c5</p> <pre><code>wget https://dev.mysql.com/get/Downloads/MySQL-Router/mysql-router-community_8.0.40-1ubuntu22.04_amd64.deb\ndpkg -i ./mysql-router-community_8.0.40-1ubuntu22.04_amd64.deb\n</code></pre>"},{"location":"mysql/install/#_2","title":"\u6e90\u7801\u5b89\u88c5","text":""},{"location":"mysql/install/#_3","title":"\u57fa\u7840\u8f6f\u4ef6\u5b89\u88c5","text":"<pre><code>apt-get install libaio-dev \\\n    libsasl2-modules-gssapi-mit \\\n    libkrb5-dev \\\n    libsasl2-dev \\\n    libldap2-dev \\\n    bison \\\n    autoconf \\\n    automake \\\n    libtool\n</code></pre>"},{"location":"mysql/install/#_4","title":"\u4e0b\u8f7d\u6e90\u7801","text":"<pre><code>MYSQL_MAJOR=8.0\nMYSQL_VERSION=8.0.40\ncurl https://cdn.mysql.com/Downloads/MySQL-${MYSQL_MAJOR}/mysql-${MYSQL_VERSION}.tar.gz --output mysql-${MYSQL_VERSION}.tar.gz\ntar --no-same-owner -xf mysql-${MYSQL_VERSION}.tar.gz\ncd mysql-${MYSQL_VERSION}\n</code></pre>"},{"location":"mysql/install/#_5","title":"\u7f16\u8bd1\u5b89\u88c5","text":"<pre><code>cmake  -DDOWNLOAD_BOOST=1 -DWITH_BOOST=/tmp/boost/ -DBUILD_CONFIG=mysql_release -DWITH_AUTHENTICATION_LDAP=1 -DCMAKE_INSTALL_PREFIX=/usr/local/mysql -DSYSCONFDIR=/usr/local/mysql/conf -DDEFAULT_SYSCONFDIR=/usr/local/mysql/conf -DFORCE_INSOURCE_BUILD=1\nmake  --jobs=2\nmake  install --jobs=2\nmake  clean\nstrip  /usr/local/mysql/bin/comp_err\nstrip  /usr/local/mysql/bin/ibd2sdi\nstrip  /usr/local/mysql/bin/innochecksum\nstrip  /usr/local/mysql/bin/lz4_decompress\nstrip  /usr/local/mysql/bin/my_print_defaults\nstrip  /usr/local/mysql/bin/myisam_ftdump\nstrip  /usr/local/mysql/bin/myisamchk\nstrip  /usr/local/mysql/bin/myisamlog\nstrip  /usr/local/mysql/bin/myisampack\nstrip  /usr/local/mysql/bin/mysql\nstrip  /usr/local/mysql/bin/mysql_config_editor\nstrip  /usr/local/mysql/bin/mysql_migrate_keyring\nstrip  /usr/local/mysql/bin/mysql_secure_installation\nstrip  /usr/local/mysql/bin/mysql_ssl_rsa_setup\nstrip  /usr/local/mysql/bin/mysql_tzinfo_to_sql\nstrip  /usr/local/mysql/bin/mysql_upgrade\nstrip  /usr/local/mysql/bin/mysqladmin\nstrip  /usr/local/mysql/bin/mysqlbinlog\nstrip  /usr/local/mysql/bin/mysqlcheck\nstrip  /usr/local/mysql/bin/mysqld\nstrip  /usr/local/mysql/bin/mysqldump\nstrip  /usr/local/mysql/bin/mysqlimport\nstrip  /usr/local/mysql/bin/mysqlpump\nstrip  /usr/local/mysql/bin/mysqlrouter\nstrip  /usr/local/mysql/bin/mysqlrouter_keyring\nstrip  /usr/local/mysql/bin/mysqlrouter_passwd\nstrip  /usr/local/mysql/bin/mysqlrouter_plugin_info\nstrip  /usr/local/mysql/bin/mysqlshow\nstrip  /usr/local/mysql/bin/mysqlslap\nstrip  /usr/local/mysql/bin/perror\nstrip  /usr/local/mysql/bin/zlib_decompress\n\n# remove mysql test dir\nrm -rf /usr/local/mysql/mysql-test\nrm -rf /usr/local/mysql/mysql-8.0/mysql-test\n\n# copy mysql build files to data dir\ncp -r /usr/local/mysql/ ${DATA_DIR}/\n\n# clean tmp data\ncd .. &amp;&amp; rm -rf mysql-${MYSQL_VERSION} mysql-${MYSQL_VERSION}.tar.gz \n</code></pre>"},{"location":"mysql/install/#_6","title":"\u521d\u59cb\u5316\u6570\u636e","text":"<pre><code>1\u3001\u67e5\u770b apparmor \u7684\u5f00\u542f\u548c\u4fdd\u62a4\u60c5\u51b5\uff1a\n\uff081\uff09sudo apparmor_status\n\n2\u3001\u5217\u51faAppArmor\u6240\u6709\u53ef\u7528\u914d\u7f6e\u6587\u4ef6\uff1a\n\uff081\uff09ls /etc/apparmor.d/\n\n3\u3001\u5047\u8bbe\u6211\u4eec\u8981\u7981\u7528Apparmor for MySQL Server\uff1a\n\uff081\uff09sudo ln -s /etc/apparmor.d/usr.sbin.mysqld /etc/apparmor.d/disable/\n\uff082\uff09apparmor_parser -R /etc/apparmor.d/disable/usr.sbin.mysqld\n\uff083\uff09\u8fd9\u662f\u518d\u6b21\u6267\u884capparmor_status\uff0c\u5e94\u8be5\u770b\u4e0d\u5230/usr/sbin/mysqld \u4e86\n\n4\u3001\u8981\u5b8c\u5168\u7981\u7528AppArmor\uff1a\n\uff081\uff09sudo systemctl disable apparmor\n</code></pre> <pre><code>sudo mysqld --initialize --user=mysql --datadir=/var/lib/rancher/mysql/\n</code></pre>"},{"location":"mysql/lock/","title":"Lock","text":""},{"location":"mysql/lock/#mdl","title":"\u5f53\u524d\u6240\u6709MDL\u9501\u7b49\u5f85\u72b6\u6001","text":"<pre><code>SELECT \n  ml.OBJECT_SCHEMA, \n  ml.OBJECT_NAME, \n  ml.LOCK_TYPE, \n  ml.LOCK_STATUS,\n  t.PROCESSLIST_ID AS 'ClientID',\n  t.PROCESSLIST_USER AS 'User',\n  t.PROCESSLIST_HOST AS 'Host',\n  t.THREAD_ID AS 'InternalThreadID'  \nFROM performance_schema.metadata_locks ml\nJOIN performance_schema.threads t \n  ON ml.OWNER_THREAD_ID = t.THREAD_ID\nWHERE ml.LOCK_STATUS = 'PENDING';\n</code></pre>"},{"location":"mysql/lock/#_1","title":"\u963b\u585e\u5173\u7cfb\u7684\u5b8c\u6574\u94fe\u6761","text":"<pre><code>SELECT \n  CONCAT('\u8fde\u63a5', blocked.PROCESSLIST_ID) AS '\u88ab\u963b\u585e\u8fde\u63a5',\n  CONCAT(blocked.PROCESSLIST_USER, '@', blocked.PROCESSLIST_HOST) AS '\u7528\u6237',\n  blocked.PROCESSLIST_DB AS '\u6570\u636e\u5e93',\n  blocked.PROCESSLIST_INFO AS '\u88ab\u963b\u585eSQL',\n  CONCAT('\u963b\u585e\u8005', blocking.PROCESSLIST_ID) AS '\u963b\u585e\u8fde\u63a5',\n  blocking.PROCESSLIST_INFO AS '\u963b\u585eSQL',\n  TIMEDIFF(NOW(), FROM_UNIXTIME(blocked.PROCESSLIST_TIME)) AS '\u963b\u585e\u65f6\u957f'\nFROM performance_schema.metadata_locks blocked_ml\nJOIN performance_schema.threads blocked \n  ON blocked_ml.OWNER_THREAD_ID = blocked.THREAD_ID\nJOIN performance_schema.metadata_locks blocking_ml \n  ON blocked_ml.OBJECT_SCHEMA = blocking_ml.OBJECT_SCHEMA\n  AND blocked_ml.OBJECT_NAME = blocking_ml.OBJECT_NAME\n  AND blocking_ml.LOCK_STATUS = 'GRANTED'\nJOIN performance_schema.threads blocking \n  ON blocking_ml.OWNER_THREAD_ID = blocking.THREAD_ID\nWHERE blocked_ml.LOCK_STATUS = 'PENDING';\n</code></pre>"},{"location":"mysql/lock/#_2","title":"\u5feb\u901f\u5904\u7406","text":"<pre><code>SELECT \n  t.PROCESSLIST_ID AS '\u8fde\u63a5ID',\n  CONCAT(t.PROCESSLIST_USER, '@', t.PROCESSLIST_HOST) AS '\u7528\u6237',\n  ml.OBJECT_SCHEMA AS '\u6570\u636e\u5e93',\n  ml.OBJECT_NAME AS '\u8868\u540d',\n  ml.LOCK_TYPE AS '\u9501\u7c7b\u578b',\n  TIMEDIFF(NOW(), FROM_UNIXTIME(t.PROCESSLIST_TIME)) AS '\u7b49\u5f85\u65f6\u95f4',\n  t.PROCESSLIST_INFO AS '\u88ab\u963b\u585eSQL',\n  CONCAT('KILL ', t.PROCESSLIST_ID, ';') AS '\u7ec8\u6b62\u547d\u4ee4'\nFROM performance_schema.metadata_locks ml\nJOIN performance_schema.threads t \n  ON ml.OWNER_THREAD_ID = t.THREAD_ID\nWHERE ml.LOCK_STATUS = 'PENDING'\nORDER BY t.PROCESSLIST_TIME DESC;\n</code></pre>"},{"location":"mysql/memory/","title":"Memory","text":"<p>mysql\u5185\u5b58\u8ba1\u7b97 https://www.mysqlcalculator.com/</p> <pre><code>SHOW FULL PROCESSLIST\n\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u67e5\u770b\u54ea\u4e9b\u4e8b\u52a1\u6b63\u5728\u7b49\u5f85\uff0c\u54ea\u4e9b\u4e8b\u52a1\u6b63\u5728\u963b\u585e\u5b83\u4eec</p> <pre><code>SELECT \n  r.trx_id waiting_trx_id, \n  r.trx_mysql_thread_id waiting_thread, \n  r.trx_query waiting_query, \n  b.trx_id blocking_trx_id, \n  b.trx_mysql_thread_id blocking_thread, \n  b.trx_query blocking_query \nFROM \n  performance_schema.data_lock_waits w \n  INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_engine_transaction_id \n  INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_engine_transaction_id;\n</code></pre> <p>\u6216\u8005\uff0c\u66f4\u7b80\u5355\u7684\u65b9\u5f0f\uff0c\u76f4\u63a5\u770bsys\u6570\u636e\u5e93\u4e2d\u7684 innodb_lock_waits \u89c6\u56fe</p> <pre><code>SELECT \n    waiting_trx_id,\n    waiting_pid,\n    waiting_query,\n    blocking_trx_id,\n    blocking_pid,\n    blocking_query\nFROM\n    sys.innodb_lock_waits;\n</code></pre> <p>\u67e5\u770b\u6bcf\u4e2a\u7ebf\u7a0b\u5360\u7528\u591a\u5c11\u5185\u5b58\uff0c\u7136\u540e\u4e58\u4ee5\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b\uff08\u4e5f\u5c31\u662f\u6392\u67e5sleep\u7684\uff09\u3002</p> <pre><code>SELECT ( (  @@read_buffer_size \n+@@read_rnd_buffer_size \n+@@sort_buffer_size \n+@@join_buffer_size \n+@@binlog_cache_size \n+@@thread_stack \n+@@max_allowed_packet \n+@@net_buffer_length  )\n) / ( 1024  *1024 ) AS MEMORY_MB;\n</code></pre> <p>\u67e5\u770bMySQL\u5168\u5c40\u5360\u7528\u591a\u5c11\u5185\u5b58</p> <pre><code>select (@@innodb_buffer_pool_size\n+@@innodb_log_buffer_size\n+@@key_buffer_size) / 1024/1024 AS MEMORY_MB;\n</code></pre> <p>\u67e5\u770bperformance_schema\u5360\u7528\u591a\u5c11\u5185\u5b58</p> <pre><code>SELECT SUBSTRING_INDEX(event_name,'/', 2 ) AS\n       code_area, sys.format_bytes(SUM(current_alloc))\n       AS current_alloc\n       FROM sys.x$memory_global_by_current_bytes\n       GROUP BY SUBSTRING_INDEX(event_name,'/', 2 )\n       ORDER BY SUM(current_alloc) DESC;\n</code></pre> <p>\u5185\u5b58\u76f8\u5173\u53c2\u6570 </p> <p>\u5171\u4eab\u5185\u5b58</p> <pre><code>show variables where variable_name in ('innodb_buffer_pool_size','innodb_log_buffer_size','innodb_additional_mem_pool_size','key_buffer_size');\n</code></pre> <p>innodb_buffer_pool_size \u8be5\u90e8\u5206\u7f13\u5b58\u662f InnoDB \u5f15\u64ce\u6700\u91cd\u8981\u7684\u7f13\u5b58\u533a\u57df\uff0c\u662f\u901a\u8fc7\u5185\u5b58\u6765\u5f25\u8865\u7269\u7406\u6570\u636e\u6587\u4ef6\u7684\u91cd\u8981\u624b\u6bb5\uff0c\u5728\u4e91\u6570\u636e\u5e93 MySQL \u4e0a\u4f1a\u91c7\u7528\u5b9e\u4f8b\u89c4\u683c\u914d\u7f6e\u768450% - 80%\u4f5c\u4e3a\u8be5\u90e8\u5206\u5927\u5c0f\uff08\u4e0a\u56fe\u4e3a1000MB * 0.5 = 500MB\uff09\u3002\u5176\u4e2d\u4e3b\u8981\u5305\u542b\u6570\u636e\u9875\u3001\u7d22\u5f15\u9875\u3001undo \u9875\u3001insert buffer\u3001\u81ea\u9002\u5e94\u54c8\u5e0c\u7d22\u5f15\u3001\u9501\u4fe1\u606f\u4ee5\u53ca\u6570\u636e\u5b57\u5178\u7b49\u4fe1\u606f\u3002\u5728\u8fdb\u884c SQL \u8bfb\u548c\u5199\u7684\u64cd\u4f5c\u65f6\uff0c\u9996\u5148\u5e76\u4e0d\u662f\u5bf9\u7269\u7406\u6570\u636e\u6587\u4ef6\u64cd\u4f5c\uff0c\u800c\u662f\u5148\u5bf9 buffer_pool \u8fdb\u884c\u64cd\u4f5c\uff0c\u518d\u901a\u8fc7 checkpoint \u7b49\u673a\u5236\u5199\u56de\u6570\u636e\u6587\u4ef6\u3002\u8be5\u7a7a\u95f4\u7684\u4f18\u70b9\u662f\u53ef\u4ee5\u63d0\u5347\u6570\u636e\u5e93\u7684\u6027\u80fd\u3001\u52a0\u5feb SQL \u8fd0\u884c\u901f\u5ea6\uff0c\u7f3a\u70b9\u662f\u6545\u969c\u6062\u590d\u901f\u5ea6\u8f83\u6162\u3002</p> <p>innodb_log_buffer_size \u8be5\u90e8\u5206\u4e3b\u8981\u5b58\u653e redo log \u7684\u4fe1\u606f\uff0c\u5728\u4e91\u6570\u636e\u5e93 MySQL \u4e0a\u4f1a\u8bbe\u7f6e64MB\u7684\u5927\u5c0f\u3002InnoDB \u4f1a\u9996\u5148\u5c06 redo log \u5199\u5728\u8fd9\u91cc\uff0c\u7136\u540e\u6309\u7167\u4e00\u5b9a\u9891\u7387\u5c06\u5176\u5237\u65b0\u56de\u91cd\u505a\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\u8be5\u7a7a\u95f4\u4e0d\u9700\u8981\u592a\u5927\uff0c\u56e0\u4e3a\u4e00\u822c\u60c5\u51b5\u4e0b\u8be5\u90e8\u5206\u7f13\u5b58\u4f1a\u4ee5\u8f83\u5feb\u9891\u7387\u5237\u65b0\u81f3 redo log\uff08Master Thread \u4f1a\u6bcf\u79d2\u5237\u65b0\u3001\u4e8b\u52a1\u63d0\u4ea4\u65f6\u4f1a\u5237\u65b0\u3001\u5176\u7a7a\u95f4\u5c11\u4e8e1/2\u65f6\u540c\u6837\u4f1a\u5237\u65b0\uff09\u3002</p> <p>innodb_additional_mem_pool_size \u8be5\u90e8\u5206\u4e3b\u8981\u5b58\u653e InnoDB \u5185\u7684\u4e00\u4e9b\u6570\u636e\u7ed3\u6784\uff0c\u5728\u4e91\u6570\u636e\u5e93 MySQL \u4e2d\u7edf\u4e00\u8bbe\u7f6e\u4e3a8MB\u3002\u901a\u5e38\u662f\u5728 buffer_pool \u4e2d\u7533\u8bf7\u5185\u5b58\u7684\u65f6\u5019\u8fd8\u9700\u8981\u5728\u989d\u5916\u5185\u5b58\u4e2d\u7533\u8bf7\u7a7a\u95f4\u5b58\u50a8\u8be5\u5bf9\u8c61\u7684\u7ed3\u6784\u4fe1\u606f\u3002\u8be5\u5927\u5c0f\u4e3b\u8981\u4e0e\u8868\u6570\u91cf\u6709\u5173\uff0c\u8868\u6570\u91cf\u8d8a\u5927\u9700\u8981\u66f4\u5927\u7684\u7a7a\u95f4\u3002</p> <p>\u79c1\u6709\u5185\u5b58</p> <pre><code>show variables where variable_name in ('read_buffer_size','read_rnd_buffer_size','sort_buffer_size','join_buffer_size','binlog_cache_size','tmp_table_size');\n\n</code></pre> <p>read_buffer_size  \u5206\u522b\u5b58\u653e\u4e86\u5bf9\u987a\u5e8f\u626b\u63cf\u7684\u7f13\u5b58\uff0c\u5f53 thread \u8fdb\u884c\u987a\u5e8f\u626b\u63cf\u6570\u636e\u65f6\u4f1a\u9996\u5148\u626b\u63cf\u8be5 buffer \u7a7a\u95f4\u4ee5\u907f\u514d\u66f4\u591a\u7684\u7269\u7406\u8bfb\u3002</p> <p>read_rnd_buffer_size  \u5206\u522b\u5b58\u653e\u4e86\u5bf9\u968f\u673a\u626b\u63cf\u7684\u7f13\u5b58\uff0c\u5f53 thread \u8fdb\u884c\u968f\u673a\u626b\u63cf\u6570\u636e\u65f6\u4f1a\u9996\u5148\u626b\u63cf\u8be5 buffer \u7a7a\u95f4\u4ee5\u907f\u514d\u66f4\u591a\u7684\u7269\u7406\u8bfb\u3002</p> <p>sort_buffer_size  \u9700\u8981\u6267\u884c order by \u548c group by \u7684 SQL \u90fd\u4f1a\u5206\u914d sort_buffer\uff0c\u7528\u4e8e\u5b58\u50a8\u6392\u5e8f\u7684\u4e2d\u95f4\u7ed3\u679c\u3002\u5728\u6392\u5e8f\u8fc7\u7a0b\u4e2d\uff0c\u82e5\u5b58\u50a8\u91cf\u5927\u4e8e sort_buffer_size\uff0c\u5219\u4f1a\u5728\u78c1\u76d8\u751f\u6210\u4e34\u65f6\u8868\u4ee5\u5b8c\u6210\u64cd\u4f5c\u3002</p> <p>join_buffer_size  MySQL \u4ec5\u652f\u6301 nest loop \u7684 join \u7b97\u6cd5\uff0c\u5904\u7406\u903b\u8f91\u662f\u9a71\u52a8\u8868\u7684\u4e00\u884c\u548c\u975e\u9a71\u52a8\u8868\u8054\u5408\u67e5\u627e\uff0c\u8fd9\u65f6\u5c31\u53ef\u4ee5\u5c06\u975e\u9a71\u52a8\u8868\u653e\u5165 join_buffer\uff0c\u4e0d\u9700\u8981\u8bbf\u95ee\u62e5\u6709\u5e76\u53d1\u4fdd\u62a4\u673a\u5236\u7684 buffer_pool\u3002</p> <p>binlog_cache_size  \u8be5\u533a\u57df\u7528\u6765\u7f13\u5b58\u8be5 thread \u7684 binlog \u65e5\u5fd7\uff0c\u5728\u4e00\u4e2a\u4e8b\u52a1\u8fd8\u6ca1\u6709 commit \u4e4b\u524d\u4f1a\u5148\u5c06\u5176\u65e5\u5fd7\u5b58\u50a8\u4e8e binlog_cache \u4e2d\uff0c\u7b49\u5230\u4e8b\u52a1 commit \u540e\u4f1a\u5c06\u5176 binlog \u5237\u56de\u78c1\u76d8\u4e0a\u7684 binlog \u6587\u4ef6\u4ee5\u6301\u4e45\u5316\u3002</p> <p>tmp_table_size  \u4e0d\u540c\u4e8e\u4e0a\u9762\u5404\u4e2a session \u7ea7\u7684 buffer\uff0c\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u5728\u63a7\u5236\u53f0\u4e0a\u4fee\u6539\u3002\u8be5\u53c2\u6570\u662f\u6307\u7528\u6237\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\uff0c\u5982\u679c\u8be5 thread \u521b\u5efa\u7684\u4e34\u65f6\u8868\u8d85\u8fc7\u5b83\u8bbe\u7f6e\u7684\u5927\u5c0f\u4f1a\u628a\u4e34\u65f6\u8868\u8f6c\u6362\u4e3a\u78c1\u76d8\u4e0a\u7684\u4e00\u5f20 MyISAM \u4e34\u65f6\u8868\u3002</p> <pre><code>set persist global_connection_memory_tracking = 1 ;\nshow global status like 'Global_connection_memory';\n\ntable_open_cache\n</code></pre> <p>performance_schema \u672c\u8eab\u5360\u7528\u7684\u5185\u5b58</p> <pre><code>show engine performance_schema status;\n</code></pre> <p>https://www.modb.pro/db/86827</p> <p>\u788e\u7247\u8868</p> <pre><code>\u5b58\u5728\u788e\u7247\u7684\u8868\nselect concat('optimize table ',table_schema,'.',table_name,';'), data_free, engine from information_schema.tables \nwhere data_free&gt;0 and engine !='MEMORY';\n\n\u6392\u5e8f\nSELECT table_schema, TABLE_NAME, concat(data_free/1024/1024, 'M') as data_free FROM `information_schema`.tables\nWHERE data_free &gt; 3 * 1024 * 1024 AND ENGINE = 'innodb' ORDER BY data_free DESC;\n\u5904\u7406\noptimize table xxxx_TABLES;\n\ngdb -q -batch -ex 'call malloc_stats()' -p  121357\n\ngdb --batch --pid 121357 --ex 'call malloc_trim(0)'\n\npmap  -x 121357 | sort -nrk3\n    Address\uff1a\u8868\u793a\u6b64\u5185\u5b58\u6bb5\u7684\u8d77\u59cb\u5730\u5740\n    Kbytes\uff1a\u8868\u793a\u6b64\u5185\u5b58\u6bb5\u7684\u5927\u5c0f(ps\uff1a\u8fd9\u662f\u865a\u62df\u5185\u5b58)\n    RSS\uff1a\u8868\u793a\u6b64\u5185\u5b58\u6bb5\u5b9e\u9645\u5206\u914d\u7684\u7269\u7406\u5185\u5b58\uff0c\u8fd9\u662f\u7531\u4e8eLinux\u662f\u5ef6\u8fdf\u5206\u914d\u5185\u5b58\u7684\uff0c\u8fdb\u7a0b\u8c03\u7528malloc\u65f6Linux\u53ea\u662f\u5206\u914d\u4e86\u4e00\u6bb5\u865a\u62df\u5185\u5b58\u5757\uff0c\u76f4\u5230\u8fdb\u7a0b\u5b9e\u9645\u8bfb\u5199\u6b64\u5185\u5b58\u5757\u4e2d\u90e8\u5206\u65f6\uff0cLinux\u4f1a\u901a\u8fc7\u7f3a\u9875\u4e2d\u65ad\u771f\u6b63\u5206\u914d\u7269\u7406\u5185\u5b58\u3002\n    Dirty\uff1a\u6b64\u5185\u5b58\u6bb5\u4e2d\u88ab\u4fee\u6539\u8fc7\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u4f7f\u7528mmap\u7cfb\u7edf\u8c03\u7528\u7533\u8bf7\u865a\u62df\u5185\u5b58\u65f6\uff0c\u53ef\u4ee5\u5173\u8054\u5230\u67d0\u4e2a\u6587\u4ef6\uff0c\u4e5f\u53ef\u4e0d\u5173\u8054\uff0c\u5f53\u5173\u8054\u4e86\u6587\u4ef6\u7684\u5185\u5b58\u6bb5\u88ab\u8bbf\u95ee\u65f6\uff0c\u4f1a\u81ea\u52a8\u8bfb\u53d6\u6b64\u6587\u4ef6\u7684\u6570\u636e\u5230\u5185\u5b58\u4e2d\uff0c\u82e5\u6b64\u6bb5\u67d0\u4e00\u9875\u5185\u5b58\u6570\u636e\u540e\u88ab\u66f4\u6539\uff0c\u5373\u4e3aDirty\uff0c\u800c\u5bf9\u4e8e\u975e\u6587\u4ef6\u6620\u5c04\u7684\u533f\u540d\u5185\u5b58\u6bb5(anon)\uff0c\u6b64\u5217\u4e0eRSS\u76f8\u7b49\u3002\n    Mode\uff1a\u5185\u5b58\u6bb5\u662f\u5426\u53ef\u8bfb(r)\u53ef\u5199(w)\u53ef\u6267\u884c(x)\n    Mapping\uff1a\u5185\u5b58\u6bb5\u6620\u5c04\u7684\u6587\u4ef6\uff0c\u533f\u540d\u5185\u5b58\u6bb5\u663e\u793a\u4e3aanon\uff0c\u975e\u533f\u540d\u5185\u5b58\u6bb5\u663e\u793a\u6587\u4ef6\u540d(\u52a0-p\u53ef\u663e\u793a\u5168\u8def\u5f84)\u3002\n\n    \u68c0\u67e5\u4e00\u6bb5\u65f6\u95f4\u540e\u65b0\u589e\u4e86\u54ea\u4e9b\u5185\u5b58\u6bb5\uff0c\u6216\u54ea\u4e9b\u53d8\u5927\n\n    pmap -x 1 &gt; pmap-`date +%F-%H-%M-%S`.log\n\n    icdiff pmap-2023-07-27-09-46-36.log pmap-2023-07-28-09-29-55.log | less -SR\n</code></pre>"},{"location":"mysql/monitor/","title":"\u76d1\u63a7","text":""},{"location":"mysql/monitor/#mysql_exporter","title":"mysql_exporter","text":"<ul> <li>global_status</li> </ul> <pre><code>SHOW GLOBAL STATUS;\n</code></pre> <ul> <li>global_variables</li> </ul> <pre><code>SHOW GLOBAL VARIABLES;\n</code></pre> <ul> <li>info_schema.processlist</li> </ul> <p><code>--collect.info_schema.processlist</code></p> <pre><code>SELECT\n    user,\n    SUBSTRING_INDEX(host, ':', 1) AS host,\n    COALESCE(command, '') AS command,\n    COALESCE(state, '') AS state,\n    COUNT(*) AS processes,\n    SUM(time) AS seconds\nFROM information_schema.processlist\n    WHERE ID != connection_id()\n    AND TIME &gt;= 0\nGROUP BY user, host, command, state;\n</code></pre> <ul> <li>perf_schema.replication_group_members</li> </ul> <p><code>--collect.perf_schema.replication_group_members</code></p> <pre><code>SELECT * FROM performance_schema.replication_group_members;\n</code></pre> <ul> <li>perf_schema.replication_group_member_stats</li> </ul> <p><code>--collect.perf_schema.replication_group_member_stats</code></p> <pre><code>SELECT * FROM performance_schema.replication_group_member_stats\\G;\n</code></pre> <p>view_id:\u7ec4\u6210\u5458\u6240\u5728\u7ec4\u7684\u89c6\u56fe\u552f\u4e00\u6807\u8bc6\u7b26</p> <p>member_id:\u7ec4\u6210\u5458\u7684server uuid,mysql\u5b9e\u4f8b\u542f\u52a8\u540e\u751f\u6210\u7684\u552f\u4e00\u6807\u8bc6</p> <p>COUNT_TRANSACTIONS_IN_QUEUE \uff1a\u7b49\u5f85\u51b2\u7a81\u9a8c\u8bc1\u7684\u961f\u5217\u6570\u91cf\uff0c\u5b9e\u9645\u4e0a\u662f\u8fdb\u884cpipeline\u5904\u7406\u7684\u961f\u5217\u6570\u91cf\uff08\u5185\u90e8\u8868\u793am_transactions_waiting_certification\uff09\uff0c\u5355\u4f4d\u4e3a\u4e8b\u52a1\u6570\u91cf\u3002</p> <p>COUNT_TRANSACTIONS_REMOTE_IN_APPLIER_QUEUE\uff1a\u7b49\u5f85\u5e94\u7528\u7684\u961f\u5217\u6570\u91cf\uff08\u5185\u90e8\u8868\u793am_transactions_waiting_apply\uff09\uff0c\u5355\u4f4d\u4e3a\u4e8b\u52a1\u6570\u91cf\u3002</p> <pre><code>- informationSchema.processlist\n- performanceSchema.replication_group_members\n- performanceSchema.replication_group_member_stats\n- performanceSchema.replication_applier_status_by_worker\n- auto_increment.columns\n- binlog_size\n</code></pre>"},{"location":"mysql/monitor/#pmm","title":"PMM","text":"<p>CREATE USER 'pmm'@'127.0.0.1' IDENTIFIED BY 'pass' WITH MAX_USER_CONNECTIONS 10; GRANT SELECT, PROCESS, REPLICATION CLIENT, RELOAD, BACKUP_ADMIN ON . TO 'pmm'@'127.0.0.1';</p>"},{"location":"mysql/monitor/#_2","title":"\u6162\u67e5\u8be2\u65e5\u5fd7","text":"<p>\u67e5\u8be2\u5206\u6790 8.0+ \u5efa\u8bae\u67e5\u8be2\u5206\u6790\u901a\u8fc7\u8fd9\u4e24\u4e2a\u8868\u4e2d\u83b7\u53d6</p> <pre><code>performance_schema.events_statements_history\nperformance_schema.events_statements_summary_by_digest\n</code></pre>"},{"location":"mysql/myshellMGR/","title":"mysql-shell \u7ba1\u7406\u7ec4\u590d\u5236","text":""},{"location":"mysql/myshellMGR/#_1","title":"\u5b89\u88c5","text":"<pre><code>sudo apt-get install mysql-shell\n</code></pre> <p>\u521b\u5efa\u8d85\u7ea7\u7528\u6237</p> <pre><code>create user administrator@'%' identified with 'caching_sha2_password'  by 'password';\ngrant all PRIVILEGES on *.* to administrator@'%' WITH GRANT OPTION;\nflush privileges;\nshow grants for administrator@'%';\n</code></pre>"},{"location":"mysql/myshellMGR/#_2","title":"\u521b\u5efa\u96c6\u7fa4","text":"<pre><code>\u521b\u5efa\u96c6\u7fa4\uff0c\u7b2c\u4e00\u4e2a\u8282\u70b9\nmysqlsh -uadministrator -ppassword -h 10.10.2.11 \n\nshell.options['dba.restartWaitTimeout']=300;\nvar cluster=dba.createCluster('YOURMGR',{disableClone:false});\n\u52a0\u5165\u8282\u70b9 1 \ndba.getCluster().addInstance('administrator:cluster_password@10.10.2.12:3306',{recoveryMethod:'clone'})\n\u52a0\u5165\u8282\u70b9 2\ndba.getCluster().addInstance('administrator:cluster_password@10.10.2.12:3306',{recoveryMethod:'clone'})\n</code></pre> <p>\u67e5\u770b\u72b6\u6001</p> <pre><code>dba.getCluster().status();\n</code></pre> <pre><code>mysql router \n# \u521b\u5efa\u914d\u7f6e\u6587\u4ef6\nmysqlrouter --bootstrap mysql_user@host:port  -d /etc/mysql/conf/router --name myrouter --force --user=mysql\n</code></pre> <pre><code># \u542f\u52a8router\ncd /etc/mysql/conf/router &amp;&amp; sh start.sh\n</code></pre> <pre><code>https://github.com/rluisr/mysqlrouter_exporter\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879apparmor aa-teardown</p> <pre><code># \u9a8c\u8bc1\nmysql -h xxx -P 6446 -pmysql_4U\n\nmysql -h xxx -P 6447 -pmysql_4U\n</code></pre> <pre><code>#mysqlsh \u914d\u7f6e\u9a8c\u8bc1\uff0c\u4fee\u590d\ndba.checkInstanceConfiguration();\ndba.configureInstance();\n</code></pre>"},{"location":"mysql/myshellMGR/#_3","title":"\u6269\u5bb9\u8282\u70b9","text":"<p>\u67e5\u770b\u72b6\u6001</p> <pre><code>dba.getCluster().status();\n</code></pre> <p>\u52a0\u5165\u524d\u9a8c\u8bc1\u96c6\u7fa4</p> <pre><code>dba.checkInstanceConfiguration('user@10.10.2.13:3306');\n</code></pre> <p>\u52a0\u5165\u524d\u914d\u7f6e\u96c6\u7fa4</p> <pre><code>dba.configureInstance('user@10.10.2.13:3306');\n</code></pre> <p>\u52a0\u5165\u96c6\u7fa4</p> <pre><code>dba.getCluster().addInstance('user@10.10.2.13:3306');\n</code></pre> <p>\u91cd\u65b0\u52a0\u5165\u96c6\u7fa4 </p> <pre><code>cluster.rejoinInstance() \n</code></pre>"},{"location":"mysql/myshellMGR/#_4","title":"\u7f29\u5bb9","text":"<pre><code>cluster.removeInstance(\"root@instanceWithOldUUID:3306\", {force: true})\ncluster.rescan()\n</code></pre>"},{"location":"mysql/myshellMGR/#_5","title":"\u6307\u5b9a\u4e3b\u8282\u70b9","text":"<pre><code>cluster.setPrimaryInstance()\n</code></pre>"},{"location":"mysql/myshellMGR/#_6","title":"\u91cd\u542f\u96c6\u7fa4","text":"<p>\u5f53\u6240\u6709\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\u90fd\u5904\u4e8e\u5173\u95ed\u72b6\u6001\u65f6</p> <pre><code>dba.rebootClusterFromCompleteOutage();\n</code></pre> <p>API</p> <pre><code>https://dev.mysql.com/doc/dev/mysqlsh-api-python/8.0/\n</code></pre>"},{"location":"mysql/myshellMGR/#_7","title":"\u8111\u88c2\u573a\u666f","text":"<p>\u5f53\u96c6\u7fa4\u4e2d\u591a\u6570\u8282\u70b9\uff08\u534a\u6570\u6216\u4ee5\u4e0a\uff09\u5931\u6548\u65f6\u3002</p> <p>\u5f53\u96c6\u7fa4\u4e2d\u6709\u90e8\u5206\u8282\u70b9\u51fa\u73b0UNREACHABLE\u72b6\u6001\uff0c\u6b64\u65f6\u96c6\u7fa4\u65e0\u6cd5\u505a\u51fa\u51b3\u7b56\uff0c\uff0c\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u5c40\u9762\uff0c\u6b64\u65f6\u53ea\u5269\u4e0b\u4e00\u4e2a\u6d3b\u8dc3\u8282\u70b9\uff0c\u6b64\u8282\u70b9\u53ea\u80fd\u63d0\u4f9b\u67e5\u8be2\uff0c\u65e0\u6cd5\u5199\u5165\uff0c\u6267\u884c\u5199\u5165\u64cd\u4f5c\u4f1ahang\u4f4f\u3002 <code>\"status\": \"NO_QUORUM\"</code></p> <pre><code>js&gt; cluster.status()\n{\n    \"clusterName\": \"mycluster\",\n    \"defaultReplicaSet\": {\n        \"name\": \"default\",\n        \"primary\": \"192.168.33.21:3306\",\n        \"status\": \"NO_QUORUM\",\n        \"statusText\": \"Cluster has no quorum as visible from '192.168.33.21:3306' and cannot process write transactions. 2 members are not active\",\n        \"topology\": {\n            \"192.168.33.21:3306\": {\n                \"address\": \"192.168.33.21:3306\",\n                \"mode\": \"R/W\",\n                \"readReplicas\": {},\n                \"role\": \"HA\",\n                \"status\": \"ONLINE\"\n            },\n            \"192.168.33.22:3306\": {\n                \"address\": \"192.168.33.22:3306\",\n                \"mode\": \"R/O\",\n                \"readReplicas\": {},\n                \"role\": \"HA\",\n                \"status\": \"UNREACHABLE\"\n            },\n            \"192.168.33.23:3306\": {\n                \"address\": \"192.168.33.23:3306\",\n                \"mode\": \"R/O\",\n                \"readReplicas\": {},\n                \"role\": \"HA\",\n                \"status\": \"(MISSING)\"\n            }\n        }\n    }\n}\n</code></pre> <p>\u4fee\u590d\u8fd9\u79cd\u72b6\u6001\uff0c\u9700\u8981\u6267\u884cforceQuorumUsingPartitionOf\u6307\u5b9a\u5f53\u524d\u6d3b\u8dc3\u8282\u70b9(\u5982\u679c\u662f\u591a\u4e2a\u5219\u9009\u62e9primary node)\uff0c\u6b64\u65f6\u6d3b\u8dc3\u8282\u70b9\u53ef\u4ee5\u63d0\u4f9b\u8bfb\u5199\u64cd\u4f5c\uff0c\u7136\u540e\u5c06\u5176\u4ed6\u8282\u70b9\u52a0\u5165\u6b64\u96c6\u7fa4\u3002</p> <pre><code>js&gt; cluster.forceQuorumUsingPartitionOf('root@192.168.33.21:3306')\n</code></pre> <p>\u8282\u70b9\u6709\u54ea\u72b6\u6001</p> <ul> <li>ONLINE - \u8282\u70b9\u72b6\u6001\u6b63\u5e38\u3002</li> <li>OFFLINE - \u5b9e\u4f8b\u5728\u8fd0\u884c\uff0c\u4f46\u6ca1\u6709\u52a0\u5165\u4efb\u4f55Cluster\u3002</li> <li>RECOVERING - \u5b9e\u4f8b\u5df2\u52a0\u5165Cluster\uff0c\u6b63\u5728\u540c\u6b65\u6570\u636e\u3002</li> <li>ERROR - \u540c\u6b65\u6570\u636e\u53d1\u751f\u5f02\u5e38\u3002</li> <li>UNREACHABLE - \u4e0e\u5176\u4ed6\u8282\u70b9\u901a\u8baf\u4e2d\u65ad\uff0c\u53ef\u80fd\u662f\u7f51\u7edc\u95ee\u9898\uff0c\u53ef\u80fd\u662f\u8282\u70b9crash\u3002</li> <li>MISSING \u8282\u70b9\u5df2\u52a0\u5165\u96c6\u7fa4\uff0c\u4f46\u672a\u542f\u52a8group replication</li> </ul> <p>\u96c6\u7fa4\u6709\u54ea\u4e9b\u72b6\u6001</p> <ul> <li>OK \u2013 \u6240\u6709\u8282\u70b9\u5904\u4e8eonline\u72b6\u6001\uff0c\u6709\u5197\u4f59\u8282\u70b9\u3002</li> <li>OK_PARTIAL \u2013 \u6709\u8282\u70b9\u4e0d\u53ef\u7528\uff0c\u4f46\u4ecd\u6709\u5197\u4f59\u8282\u70b9\u3002</li> <li>OK_NO_TOLERANCE \u2013 \u6709\u8db3\u591f\u7684online\u8282\u70b9\uff0c\u4f46\u6ca1\u6709\u5197\u4f59\uff0c\u4f8b\u5982\uff1a\u4e24\u4e2a\u8282\u70b9\u7684Cluster\uff0c\u5176\u4e2d\u4e00\u4e2a\u6302\u4e86\uff0c\u96c6\u7fa4\u5c31\u4e0d\u53ef\u7528\u4e86\u3002</li> <li>NO_QUORUM \u2013 \u6709\u8282\u70b9\u5904\u4e8eonline\u72b6\u6001\uff0c\u4f46\u8fbe\u4e0d\u5230\u6cd5\u5b9a\u8282\u70b9\u6570\uff0c\u6b64\u72b6\u6001\u4e0bCluster\u65e0\u6cd5\u5199\u5165\uff0c\u53ea\u80fd\u8bfb\u53d6\u3002</li> <li>UNKNOWN \u2013 \u4e0d\u662fonline\u6216recovering\u72b6\u6001\uff0c\u5c1d\u8bd5\u8fde\u63a5\u5176\u4ed6\u5b9e\u4f8b\u67e5\u770b\u72b6\u6001\u3002</li> <li>UNAVAILABLE \u2013 \u7ec4\u5185\u8282\u70b9\u5168\u662foffline\u72b6\u6001\uff0c\u4f46\u5b9e\u4f8b\u5728\u8fd0\u884c\uff0c\u53ef\u80fd\u5b9e\u4f8b\u521a\u91cd\u542f\u8fd8\u6ca1\u52a0\u5165Cluster\u3002</li> </ul> <p>\u7ec4\u590d\u5236\u4fe1\u606f\u6301\u4e45\u5316 \u5b58\u50a8\u4f4d\u7f6e <code>mysqld-auto.cnf</code> </p> \u67e5\u770b\u4ee3\u7801 <pre><code>mysql_static_variables\": {\n        \"group_replication_ssl_mode\": {\n            \"Value\": \"REQUIRED\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162400774\n            }\n        },\n        \"group_replication_group_name\": {\n            \"Value\": \"f5af33a9-68cb-11ef-8fbc-2a9c829ebee5\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162386269\n            }\n        },\n        \"group_replication_group_seeds\": {\n            \"Value\": \"helmbroker-my01-1:3306,helmbroker-my01-2:3306\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712217411206\n            }\n        },\n        \"group_replication_ip_allowlist\": {\n            \"Value\": \"AUTOMATIC\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162406505\n            }\n        },\n        \"group_replication_local_address\": {\n            \"Value\": \"helmbroker-my01-0:3306\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162402566\n            }\n        },\n        \"group_replication_member_weight\": {\n            \"Value\": \"50\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162410144\n            }\n        },\n        \"group_replication_start_on_boot\": {\n            \"Value\": \"ON\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162417423\n            }\n        },\n        \"group_replication_autorejoin_tries\": {\n            \"Value\": \"3\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162415523\n            }\n        },\n        \"group_replication_recovery_use_ssl\": {\n            \"Value\": \"ON\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162396737\n            }\n        },\n        \"group_replication_view_change_uuid\": {\n            \"Value\": \"f5af3c16-68cb-11ef-8fbc-2a9c829ebee5\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162389707\n            }\n        },\n        \"group_replication_exit_state_action\": {\n            \"Value\": \"READ_ONLY\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162408402\n            }\n        },\n        \"group_replication_communication_stack\": {\n            \"Value\": \"MYSQL\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162419318\n            }\n        },\n        \"group_replication_paxos_single_leader\": {\n            \"Value\": \"OFF\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162422954\n            }\n        },\n        \"group_replication_single_primary_mode\": {\n            \"Value\": \"ON\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162394640\n            }\n        },\n        \"group_replication_member_expel_timeout\": {\n            \"Value\": \"5\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162413567\n            }\n        },\n        \"group_replication_transaction_size_limit\": {\n            \"Value\": \"150000000\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162421121\n            }\n        },\n        \"group_replication_recovery_ssl_verify_server_cert\": {\n            \"Value\": \"OFF\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162398833\n            }\n        },\n        \"group_replication_enforce_update_everywhere_checks\": {\n            \"Value\": \"OFF\",\n            \"Metadata\": {\n                \"Host\": \"\",\n                \"User\": \"root\",\n                \"Timestamp\": 1726712162392318\n            }\n        }\n    }\n</code></pre> <p>\u7ebf\u4e0a\u95ee\u9898</p> <pre><code>dba.getCluster().status();\nWARNING: Error connecting to Cluster: MYSQLSH 51004: Unable to find a primary member in the Cluster\nRetrying getCluster() using a secondary member\nWARNING: You are connected to an instance in state 'Read Only'\nWrite operations on the InnoDB cluster will not be allowed.\n\n{\n    \"clusterName\": \"MXMGR\", \n    \"defaultReplicaSet\": {\n        \"name\": \"default\", \n        \"primary\": \"helmbroker-lasm-mysql-base-demo-1:3306\", \n        \"ssl\": \"REQUIRED\", \n        \"status\": \"OK_NO_TOLERANCE_PARTIAL\", \n        \"statusText\": \"Cluster is NOT tolerant to any failures. 1 member is not active.\", \n        \"topology\": {\n            \"helmbroker-lasm-mysql-base-demo-0:3306\": {\n                \"address\": \"helmbroker-lasm-mysql-base-demo-0:3306\", \n                \"memberRole\": \"SECONDARY\", \n                \"mode\": \"R/O\", \n                \"readReplicas\": {}, \n                \"replicationLag\": \"applier_queue_applied\", \n                \"role\": \"HA\", \n                \"status\": \"ONLINE\", \n                \"version\": \"8.0.34\"\n            }, \n            \"helmbroker-lasm-mysql-base-demo-1:3306\": {\n                \"address\": \"helmbroker-lasm-mysql-base-demo-1:3306\", \n                \"instanceErrors\": [\n                    \"NOTE: group_replication is stopped.\"\n                ], \n                \"memberRole\": \"PRIMARY\", \n                \"memberState\": \"OFFLINE\", \n                \"mode\": \"n/a\", \n                \"readReplicas\": {}, \n                \"role\": \"HA\", \n                \"status\": \"UNREACHABLE\", \n                \"version\": \"8.0.34\"\n            }, \n            \"helmbroker-lasm-mysql-base-demo-2:3306\": {\n                \"address\": \"helmbroker-lasm-mysql-base-demo-2:3306\", \n                \"memberRole\": \"SECONDARY\", \n                \"mode\": \"R/O\", \n                \"readReplicas\": {}, \n                \"replicationLag\": \"applier_queue_applied\", \n                \"role\": \"HA\", \n                \"status\": \"ONLINE\", \n                \"version\": \"8.0.34\"\n            }\n        }, \n        \"topologyMode\": \"Single-Primary\"\n    }, \n    \"groupInformationSourceMember\": \"helmbroker-lasm-mysql-base-demo-2:3306\"\n}\n</code></pre>"},{"location":"mysql/mysqlmem/","title":"mysql \u5185\u5b58\u5360\u7528\u5206\u6790","text":""},{"location":"mysql/mysqlmem/#_1","title":"\u64cd\u4f5c\u7cfb\u7edf\u5185\u5b58\u5206\u6790","text":""},{"location":"mysql/mysqlmem/#_2","title":"\u7cfb\u7edf\u5185\u5b58\u7c7b\u578b","text":"<p>VSS </p> \u5185\u5b58\u7c7b\u578b \u5355\u72ec\u5360\u7528 \u5171\u4eab \u5206\u914d\u672a\u4f7f\u7528 VSS \u221a \u221a \u221a RSS \u221a \u221a PSS \u221a \u6bd4\u4f8b\u5206\u914d USS \u221a"},{"location":"mysql/mysqlmem/#_3","title":"\u7cfb\u7edf\u67e5\u770b\u5185\u5b58","text":""},{"location":"mysql/mysqlmem/#ps","title":"ps","text":"<pre><code>ps eo user,pid,vsz,rss $(pgrep -f 'mysqld')\n</code></pre>"},{"location":"mysql/mysqlmem/#top","title":"top","text":"<pre><code>top pid  xxx  &amp;&amp;   shift + M\n</code></pre>"},{"location":"mysql/mysqlmem/#smem","title":"smem","text":""},{"location":"mysql/mysqlmem/#pmap","title":"pmap","text":"<pre><code>   pmap  -x 121357 | sort -nrk3\n</code></pre> <ul> <li>\u200b    Address\uff1a\u8868\u793a\u6b64\u5185\u5b58\u6bb5\u7684\u8d77\u59cb\u5730\u5740</li> <li>\u200b    Kbytes\uff1a\u8868\u793a\u6b64\u5185\u5b58\u6bb5\u7684\u5927\u5c0f(ps\uff1a\u8fd9\u662f\u865a\u62df\u5185\u5b58)</li> <li>\u200b    RSS\uff1a\u8868\u793a\u6b64\u5185\u5b58\u6bb5\u5b9e\u9645\u5206\u914d\u7684\u7269\u7406\u5185\u5b58\uff0c\u8fd9\u662f\u7531\u4e8eLinux\u662f\u5ef6\u8fdf\u5206\u914d\u5185\u5b58\u7684\uff0c\u8fdb\u7a0b\u8c03\u7528malloc\u65f6Linux\u53ea\u662f\u5206                   \u914d\u4e86\u4e00\u6bb5\u865a\u62df\u5185\u5b58\u5757\uff0c\u76f4\u5230\u8fdb\u7a0b\u5b9e\u9645\u8bfb\u5199\u6b64\u5185\u5b58\u5757\u4e2d\u90e8\u5206\u65f6\uff0cLinux\u4f1a\u901a\u8fc7\u7f3a\u9875\u4e2d\u65ad\u771f\u6b63\u5206\u914d\u7269\u7406\u5185\u5b58\u3002</li> <li>\u200b    Dirty\uff1a\u6b64\u5185\u5b58\u6bb5\u4e2d\u88ab\u4fee\u6539\u8fc7\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u4f7f\u7528mmap\u7cfb\u7edf\u8c03\u7528\u7533\u8bf7\u865a\u62df\u5185\u5b58\u65f6\uff0c\u53ef\u4ee5\u5173\u8054\u5230\u67d0\u4e2a\u6587\u4ef6\uff0c\u4e5f\u53ef\u4e0d\u5173\u8054\uff0c\u5f53\u5173\u8054\u4e86\u6587\u4ef6\u7684\u5185\u5b58\u6bb5\u88ab\u8bbf\u95ee\u65f6\uff0c\u4f1a\u81ea\u52a8\u8bfb\u53d6\u6b64\u6587\u4ef6\u7684\u6570\u636e\u5230\u5185\u5b58\u4e2d\uff0c\u82e5\u6b64\u6bb5\u67d0\u4e00\u9875\u5185\u5b58\u6570\u636e\u540e\u88ab\u66f4\u6539\uff0c\u5373\u4e3aDirty\uff0c\u800c\u5bf9\u4e8e\u975e\u6587\u4ef6\u6620\u5c04\u7684\u533f\u540d\u5185\u5b58\u6bb5(anon)\uff0c\u6b64\u5217\u4e0eRSS\u76f8\u7b49\u3002</li> <li>\u200b    Mode\uff1a\u5185\u5b58\u6bb5\u662f\u5426\u53ef\u8bfb(r)\u53ef\u5199(w)\u53ef\u6267\u884c(x)</li> <li> <p>\u200b    Mapping\uff1a\u5185\u5b58\u6bb5\u6620\u5c04\u7684\u6587\u4ef6\uff0c\u533f\u540d\u5185\u5b58\u6bb5\u663e\u793a\u4e3aanon\uff0c\u975e\u533f\u540d\u5185\u5b58\u6bb5\u663e\u793a\u6587\u4ef6\u540d(\u52a0-p\u53ef\u663e\u793a\u5168\u8def\u5f84)\u3002</p> <p>\u68c0\u67e5\u4e00\u6bb5\u65f6\u95f4\u540e\u65b0\u589e\u4e86\u54ea\u4e9b\u5185\u5b58\u6bb5\uff0c\u6216\u54ea\u4e9b\u53d8\u5927</p> <p>pmap -x 1 &gt; pmap-<code>date +%F-%H-%M-%S</code>.log</p> <p>icdiff pmap-2023-07-27-09-46-36.log pmap-2023-07-28-09-29-55.log | less -SR</p> </li> </ul>"},{"location":"mysql/mysqlmem/#_4","title":"\u901a\u8fc7\u8fdb\u7a0b\u53f7\u67e5\u770b","text":"<pre><code>cat /proc/$pid/status/ | grep Vm\n</code></pre>"},{"location":"mysql/mysqlmem/#_5","title":"\u91ca\u653e\u5185\u5b58","text":"<pre><code>sync\necho N &gt; /proc/sys/vm/drop_caches ; N = 1 ,2 , 3\n</code></pre>"},{"location":"mysql/mysqlmem/#mysql_1","title":"Mysql \u670d\u52a1\u5185\u5b58\u67e5\u770b","text":"<p>mysql\u5185\u5b58\u8ba1\u7b97 https://www.mysqlcalculator.com/</p>"},{"location":"mysql/mysqlmem/#_6","title":"\u5185\u5b58\u5360\u7528\u7edf\u8ba1","text":"<ul> <li>\u8fdb\u7a0b\u4f7f\u7528\u5185\u5b58</li> <li>\u7f13\u5b58\u4f7f\u7528\u5185\u5b58</li> <li>\u8fde\u63a5\u4f7f\u7528\u5185\u5b58</li> <li>\u5176\u4ed6\uff0c\u5982\u65e5\u5fd7\uff0c\u4e34\u65f6\u5b58\u50a8\uff0c\u590d\u5236</li> </ul> <p>mysql\u670d\u52a1\u4e3a\u5355\u8fdb\u7a0b\u591a\u7ebf\u7a0b\u8fd0\u884c\u65b9\u5f0f</p> <ol> <li>\u6240\u6709\u7ebf\u7a0b\u5171\u7528\u5171\u4eab\u5168\u5c40\u5185\u5b58</li> <li>\u7ebf\u7a0b\u72ec\u5360\u5185\u5b58</li> </ol> <p>\u603b\u5185\u5b58 = \u5168\u5c40\u5185\u5b58+\u7ebf\u7a0b\u6570*\u7ebf\u7a0b\u72ec\u5360\u5185\u5b58+\u5176\u4ed6</p>"},{"location":"mysql/mysqlmem/#_7","title":"\u5171\u4eab\u5185\u5b58","text":"<pre><code>--- \u67e5\u770b\u5168\u5c40\u5185\u5b58\u53c2\u6570\u8bbe\u7f6e\nshow variables where variable_name in ('innodb_buffer_pool_size','innodb_log_buffer_size','innodb_additional_mem_pool_size','key_buffer_size');\n\n--- \u8ba1\u7b97\u5168\u5c40\u5185\u5b58\nselect (@@innodb_buffer_pool_size\n+@@innodb_log_buffer_size\n+@@key_buffer_size) / 1024/1024 AS MEMORY_MB;\n</code></pre>"},{"location":"mysql/mysqlmem/#_8","title":"\u5355\u7ebf\u7a0b\u5185\u5b58","text":"<pre><code>--- \u8ba1\u7b97\u5355\u4e2a\u7ebf\u7a0b\u5360\u7528\u7684\u5185\u5b58\nSELECT ( (  @@read_buffer_size \n+@@read_rnd_buffer_size \n+@@sort_buffer_size \n+@@join_buffer_size \n+@@binlog_cache_size \n+@@thread_stack \n+@@max_allowed_packet \n+@@net_buffer_length  )\n) / ( 1024  *1024 ) AS MEMORY_MB;\n</code></pre> <p>\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b</p> <pre><code>SHOW FULL PROCESSLIST\n</code></pre>"},{"location":"mysql/mysqlmem/#mysql_2","title":"\u901a\u8fc7mysql\u89c6\u56fe\u8fdb\u884c\u5185\u5b58\u7edf\u8ba1","text":""},{"location":"mysql/mysqlmem/#_9","title":"\u670d\u52a1\u8fd0\u884c\u603b\u5185\u5b58","text":"<pre><code>SELECT \nSUM(CAST(replace(current_alloc,'MiB','')  as DECIMAL(10, 2))  ) \nFROM sys.memory_global_by_current_bytes\nWHERE current_alloc like '%MiB%';\n</code></pre>"},{"location":"mysql/mysqlmem/#_10","title":"\u5206\u4e8b\u4ef6\u7edf\u8ba1\u5185\u5b58","text":"<pre><code>SELECT SUBSTRING_INDEX(event_name,'/', 2 ) AS\n       code_area, sys.format_bytes(SUM(current_alloc))\n       AS current_alloc\n       FROM sys.x$memory_global_by_current_bytes\n       GROUP BY SUBSTRING_INDEX(event_name,'/', 2 )\n       ORDER BY SUM(current_alloc) DESC;\n\nSELECT event_name,\n    SUM(CAST(replace(current_alloc,'MiB','')  as DECIMAL(10, 2))  )\n    FROM sys.memory_global_by_current_bytes\n    WHERE current_alloc like '%MiB%' GROUP BY event_name  \n     ORDER BY SUM(CAST(replace(current_alloc,'MiB','')  as DECIMAL(10, 2))  ) DESC ;\n\nSELECT event_name,\n       sys.format_bytes(CURRENT_NUMBER_OF_BYTES_USED)\nFROM performance_schema.memory_summary_global_by_event_name\nORDER BY  CURRENT_NUMBER_OF_BYTES_USED DESC\nLIMIT 10;\n\n\n-- \u67e5\u770b\u5185\u5b58\u5206\u914d\u5668\u7edf\u8ba1\uff08\u9700 MySQL 5.7+\uff09\nSELECT \n  EVENT_NAME, \n  COUNT_ALLOC \nFROM performance_schema.memory_summary_global_by_event_name \nWHERE EVENT_NAME LIKE 'memory/sql/%' \nORDER BY COUNT_ALLOC DESC;\n</code></pre> <p>SELECT   sys.format_bytes(SUM(CURRENT_NUMBER_OF_BYTES_USED)) FROM performance_schema.memory_summary_global_by_event_name</p>"},{"location":"mysql/mysqlmem/#_11","title":"\u5206\u8d26\u53f7\u7edf\u8ba1","text":"<pre><code>SELECT user,event_name,current_number_of_bytes_used/1024/1024 as MB_CURRENTLY_USED\nFROM performance_schema.memory_summary_by_account_by_event_name\nWHERE host&lt;&gt;\"localhost\"\nORDER BY  current_number_of_bytes_used DESC LIMIT 10;\n</code></pre>"},{"location":"mysql/mysqlmem/#performance","title":"performance \u5360\u7528\u5185\u5b58","text":"<pre><code>show engine performance_schema status;\n</code></pre>"},{"location":"mysql/mysqlmem/#_12","title":"\u5176\u4ed6","text":"<pre><code>\u5b58\u5728\u788e\u7247\u7684\u8868\nselect concat('optimize table ',table_schema,'.',table_name,';'), data_free, engine from information_schema.tables \nwhere data_free&gt;0 and engine !='MEMORY';\n\n\u6392\u5e8f\nSELECT table_schema, TABLE_NAME, concat(data_free/1024/1024, 'M') as data_free FROM `information_schema`.tables\nWHERE data_free &gt; 3 * 1024 * 1024 AND ENGINE = 'innodb' ORDER BY data_free DESC;\n\u5904\u7406\noptimize table xxxx_TABLES;\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u67e5\u770b\u54ea\u4e9b\u4e8b\u52a1\u6b63\u5728\u7b49\u5f85\uff0c\u54ea\u4e9b\u4e8b\u52a1\u6b63\u5728\u963b\u585e\u5b83\u4eec</p> <pre><code>SELECT \n  r.trx_id waiting_trx_id, \n  r.trx_mysql_thread_id waiting_thread, \n  r.trx_query waiting_query, \n  b.trx_id blocking_trx_id, \n  b.trx_mysql_thread_id blocking_thread, \n  b.trx_query blocking_query \nFROM \n  performance_schema.data_lock_waits w \n  INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_engine_transaction_id \n  INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_engine_transaction_id;\n</code></pre> <p>\u6216\u8005\uff0c\u66f4\u7b80\u5355\u7684\u65b9\u5f0f\uff0c\u76f4\u63a5\u770bsys\u6570\u636e\u5e93\u4e2d\u7684 innodb_lock_waits \u89c6\u56fe</p> <pre><code>SELECT \n    waiting_trx_id,\n    waiting_pid,\n    waiting_query,\n    blocking_trx_id,\n    blocking_pid,\n    blocking_query\nFROM\n    sys.innodb_lock_waits;\n</code></pre>"},{"location":"mysql/mysqlmem/#_13","title":"\u5185\u5b58\u76f8\u5173\u53c2\u6570","text":""},{"location":"mysql/mysqlmem/#_14","title":"\u5171\u4eab\u5185\u5b58","text":"<p>innodb_buffer_pool_size \u8be5\u90e8\u5206\u7f13\u5b58\u662f InnoDB \u5f15\u64ce\u6700\u91cd\u8981\u7684\u7f13\u5b58\u533a\u57df\uff0c\u662f\u901a\u8fc7\u5185\u5b58\u6765\u5f25\u8865\u7269\u7406\u6570\u636e\u6587\u4ef6\u7684\u91cd\u8981\u624b\u6bb5\uff0c\u5728\u4e91\u6570\u636e\u5e93 MySQL \u4e0a\u4f1a\u91c7\u7528\u5b9e\u4f8b\u89c4\u683c\u914d\u7f6e\u768450% - 80%\u4f5c\u4e3a\u8be5\u90e8\u5206\u5927\u5c0f\uff08\u4e0a\u56fe\u4e3a1000MB * 0.5 = 500MB\uff09\u3002\u5176\u4e2d\u4e3b\u8981\u5305\u542b\u6570\u636e\u9875\u3001\u7d22\u5f15\u9875\u3001undo \u9875\u3001insert buffer\u3001\u81ea\u9002\u5e94\u54c8\u5e0c\u7d22\u5f15\u3001\u9501\u4fe1\u606f\u4ee5\u53ca\u6570\u636e\u5b57\u5178\u7b49\u4fe1\u606f\u3002\u5728\u8fdb\u884c SQL \u8bfb\u548c\u5199\u7684\u64cd\u4f5c\u65f6\uff0c\u9996\u5148\u5e76\u4e0d\u662f\u5bf9\u7269\u7406\u6570\u636e\u6587\u4ef6\u64cd\u4f5c\uff0c\u800c\u662f\u5148\u5bf9 buffer_pool \u8fdb\u884c\u64cd\u4f5c\uff0c\u518d\u901a\u8fc7 checkpoint \u7b49\u673a\u5236\u5199\u56de\u6570\u636e\u6587\u4ef6\u3002\u8be5\u7a7a\u95f4\u7684\u4f18\u70b9\u662f\u53ef\u4ee5\u63d0\u5347\u6570\u636e\u5e93\u7684\u6027\u80fd\u3001\u52a0\u5feb SQL \u8fd0\u884c\u901f\u5ea6\uff0c\u7f3a\u70b9\u662f\u6545\u969c\u6062\u590d\u901f\u5ea6\u8f83\u6162\u3002</p> <p>innodb_log_buffer_size \u8be5\u90e8\u5206\u4e3b\u8981\u5b58\u653e redo log \u7684\u4fe1\u606f\uff0c\u5728\u4e91\u6570\u636e\u5e93 MySQL \u4e0a\u4f1a\u8bbe\u7f6e64MB\u7684\u5927\u5c0f\u3002InnoDB \u4f1a\u9996\u5148\u5c06 redo log \u5199\u5728\u8fd9\u91cc\uff0c\u7136\u540e\u6309\u7167\u4e00\u5b9a\u9891\u7387\u5c06\u5176\u5237\u65b0\u56de\u91cd\u505a\u65e5\u5fd7\u6587\u4ef6\u4e2d\u3002\u8be5\u7a7a\u95f4\u4e0d\u9700\u8981\u592a\u5927\uff0c\u56e0\u4e3a\u4e00\u822c\u60c5\u51b5\u4e0b\u8be5\u90e8\u5206\u7f13\u5b58\u4f1a\u4ee5\u8f83\u5feb\u9891\u7387\u5237\u65b0\u81f3 redo log\uff08Master Thread \u4f1a\u6bcf\u79d2\u5237\u65b0\u3001\u4e8b\u52a1\u63d0\u4ea4\u65f6\u4f1a\u5237\u65b0\u3001\u5176\u7a7a\u95f4\u5c11\u4e8e1/2\u65f6\u540c\u6837\u4f1a\u5237\u65b0\uff09\u3002</p> <p>innodb_additional_mem_pool_size \u8be5\u90e8\u5206\u4e3b\u8981\u5b58\u653e InnoDB \u5185\u7684\u4e00\u4e9b\u6570\u636e\u7ed3\u6784\uff0c\u5728\u4e91\u6570\u636e\u5e93 MySQL \u4e2d\u7edf\u4e00\u8bbe\u7f6e\u4e3a8MB\u3002\u901a\u5e38\u662f\u5728 buffer_pool \u4e2d\u7533\u8bf7\u5185\u5b58\u7684\u65f6\u5019\u8fd8\u9700\u8981\u5728\u989d\u5916\u5185\u5b58\u4e2d\u7533\u8bf7\u7a7a\u95f4\u5b58\u50a8\u8be5\u5bf9\u8c61\u7684\u7ed3\u6784\u4fe1\u606f\u3002\u8be5\u5927\u5c0f\u4e3b\u8981\u4e0e\u8868\u6570\u91cf\u6709\u5173\uff0c\u8868\u6570\u91cf\u8d8a\u5927\u9700\u8981\u66f4\u5927\u7684\u7a7a\u95f4\u3002</p>"},{"location":"mysql/mysqlmem/#_15","title":"\u79c1\u6709\u5185\u5b58","text":"<p>read_buffer_size  \u5206\u522b\u5b58\u653e\u4e86\u5bf9\u987a\u5e8f\u626b\u63cf\u7684\u7f13\u5b58\uff0c\u5f53 thread \u8fdb\u884c\u987a\u5e8f\u626b\u63cf\u6570\u636e\u65f6\u4f1a\u9996\u5148\u626b\u63cf\u8be5 buffer \u7a7a\u95f4\u4ee5\u907f\u514d\u66f4\u591a\u7684\u7269\u7406\u8bfb\u3002</p> <p>read_rnd_buffer_size  \u5206\u522b\u5b58\u653e\u4e86\u5bf9\u968f\u673a\u626b\u63cf\u7684\u7f13\u5b58\uff0c\u5f53 thread \u8fdb\u884c\u968f\u673a\u626b\u63cf\u6570\u636e\u65f6\u4f1a\u9996\u5148\u626b\u63cf\u8be5 buffer \u7a7a\u95f4\u4ee5\u907f\u514d\u66f4\u591a\u7684\u7269\u7406\u8bfb\u3002</p> <p>sort_buffer_size  \u9700\u8981\u6267\u884c order by \u548c group by \u7684 SQL \u90fd\u4f1a\u5206\u914d sort_buffer\uff0c\u7528\u4e8e\u5b58\u50a8\u6392\u5e8f\u7684\u4e2d\u95f4\u7ed3\u679c\u3002\u5728\u6392\u5e8f\u8fc7\u7a0b\u4e2d\uff0c\u82e5\u5b58\u50a8\u91cf\u5927\u4e8e sort_buffer_size\uff0c\u5219\u4f1a\u5728\u78c1\u76d8\u751f\u6210\u4e34\u65f6\u8868\u4ee5\u5b8c\u6210\u64cd\u4f5c\u3002</p> <p>join_buffer_size  MySQL \u4ec5\u652f\u6301 nest loop \u7684 join \u7b97\u6cd5\uff0c\u5904\u7406\u903b\u8f91\u662f\u9a71\u52a8\u8868\u7684\u4e00\u884c\u548c\u975e\u9a71\u52a8\u8868\u8054\u5408\u67e5\u627e\uff0c\u8fd9\u65f6\u5c31\u53ef\u4ee5\u5c06\u975e\u9a71\u52a8\u8868\u653e\u5165 join_buffer\uff0c\u4e0d\u9700\u8981\u8bbf\u95ee\u62e5\u6709\u5e76\u53d1\u4fdd\u62a4\u673a\u5236\u7684 buffer_pool\u3002</p> <p>binlog_cache_size  \u8be5\u533a\u57df\u7528\u6765\u7f13\u5b58\u8be5 thread \u7684 binlog \u65e5\u5fd7\uff0c\u5728\u4e00\u4e2a\u4e8b\u52a1\u8fd8\u6ca1\u6709 commit \u4e4b\u524d\u4f1a\u5148\u5c06\u5176\u65e5\u5fd7\u5b58\u50a8\u4e8e binlog_cache \u4e2d\uff0c\u7b49\u5230\u4e8b\u52a1 commit \u540e\u4f1a\u5c06\u5176 binlog \u5237\u56de\u78c1\u76d8\u4e0a\u7684 binlog \u6587\u4ef6\u4ee5\u6301\u4e45\u5316\u3002</p> <p>tmp_table_size  \u4e0d\u540c\u4e8e\u4e0a\u9762\u5404\u4e2a session \u7ea7\u7684 buffer\uff0c\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u5728\u63a7\u5236\u53f0\u4e0a\u4fee\u6539\u3002\u8be5\u53c2\u6570\u662f\u6307\u7528\u6237\u5185\u5b58\u4e34\u65f6\u8868\u7684\u5927\u5c0f\uff0c\u5982\u679c\u8be5 thread \u521b\u5efa\u7684\u4e34\u65f6\u8868\u8d85\u8fc7\u5b83\u8bbe\u7f6e\u7684\u5927\u5c0f\u4f1a\u628a\u4e34\u65f6\u8868\u8f6c\u6362\u4e3a\u78c1\u76d8\u4e0a\u7684\u4e00\u5f20 MyISAM \u4e34\u65f6\u8868\u3002</p> <p>https://www.modb.pro/db/86827</p>"},{"location":"mysql/mysqlmem/#_16","title":"\u6000\u7591\u5185\u5b58\u6cc4\u9732","text":"<p>glibc</p> <pre><code>--- \u7edf\u8ba1\u5185\u5b58\ngdb -q -batch -ex 'call malloc_stats()' -p  121357\n--- \u624b\u91ca\u653e\u5185\u5b58\ngdb --batch --pid 121357 --ex 'call malloc_trim(0)'\n</code></pre>"},{"location":"mysql/mysqlmem/#_17","title":"\u5904\u7406\u65b9\u5f0f","text":"<pre><code>--- \u5173\u95ed\u6570\u636e\u5e93\u670d\u52a1\uff0c\u7531\u81ea\u52a8\u91cd\u542f\u673a\u5236\u91cd\u542f\nshutdown\n\nselect * from performance_schema.replication_group_memebers;\n</code></pre> <p>https://mp.weixin.qq.com/s?__biz=MjM5NzAzMTY4NQ==&amp;mid=2653941614&amp;idx=1&amp;sn=8f1eea4f37e885122e3e216c34e76c2a&amp;chksm=bd3b75048a4cfc124559482a159007ba861396ab5bcdaf3c2591de6a2a71adee5c7d590ac8f6#rd</p>"},{"location":"mysql/mysqlmem/#mgr","title":"mgr \u53c2\u6570","text":"<pre><code>@@group_replication_message_cache_size=1073741824\n</code></pre> <p>pmap -x $(pidof mysqld) | sort -k3 -nr | head -n 20</p> <p>\u5b9e\u6d4b\u5206\u6790</p> <pre><code>pt-mysql-summary --user=administrator --password=zVft37KE9Z --host=10.2.14.23 --port=3306\n</code></pre> <p>\u5206\u6790\u5185\u5b58</p> <p>-- \u9650\u5236\u4e34\u65f6\u8868\u5185\u5b58 SET persist tmp_table_size = 64 * 1024 * 1024;     -- 64M SET persist max_heap_table_size = 64 * 1024 * 1024;</p> <p>-- \u964d\u4f4e\u6392\u5e8f/JOIN \u7f13\u51b2\u533a SET persist sort_buffer_size = 128 * 1024;        -- 128K SET persist join_buffer_size = 128 * 1024;</p> <p>-- \u7f29\u5c0f InnoDB \u7f13\u51b2\u6c60 SET persist innodb_buffer_pool_size = 700 * 1024 * 1024;  -- 700M</p> <p>-- \u589e\u52a0\u7ebf\u7a0b\u7f13\u5b58 SET persist thread_cache_size = 100; SET persist max_connections = 100;</p>"},{"location":"mysql/mysqlmem/#mysql_3","title":"mysql \u5185\u5b58\u95ee\u9898\u5206\u6790","text":"<p>\u7cfb\u7edf\u7ea7\u522b </p> <pre><code>#top -p $(pidof mysqld)\n\nPID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM  TIME+ COMMAND \n1   1001      20   0   14.8g   5.9g  50568 S   0.7   0.6 211:56.90 mysqld\n</code></pre> <pre><code>top -p $(pidof mysqld)  # \u5b9e\u65f6\u76d1\u63a7MySQL\u8fdb\u7a0b\u5185\u5b58\ncat /proc/$(pidof mysqld)/status | grep Vm  # \u67e5\u770b\u865a\u62df\u5185\u5b58\u4f7f\u7528\n</code></pre> <pre><code>SELECT * FROM sys.memory_global_total;  \nSELECT EVENT_NAME, \n       ROUND(CURRENT_NUMBER_OF_BYTES_USED/1024/1024,2) AS memory_mb\nFROM performance_schema.memory_summary_global_by_event_name\nORDER BY memory_mb DESC LIMIT 10; \n</code></pre> <pre><code>SELECT m.EVENT_NAME, t.PROCESSLIST_ID, \n       ROUND(m.CURRENT_NUMBER_OF_BYTES_USED/1024/1024,2) AS mem_mb\nFROM performance_schema.memory_summary_by_thread_by_event_name m\nJOIN performance_schema.threads t USING (THREAD_ID)\nWHERE t.PROCESSLIST_ID != CONNECTION_ID()\nORDER BY m.CURRENT_NUMBER_OF_BYTES_USED DESC LIMIT 10;\n</code></pre>"},{"location":"mysql/mysqlmem/#_18","title":"\u538b\u6d4b","text":"<p>sysbench /usr/local/sysbench/share/sysbench/oltp_read_only.lua  --mysql-host=127.0.0.1 --mysql-port=3306 --mysql-user=root --mysql-password=root --mysql-db=sbtest --tables=15 --table-size=1000000 --threads=150 --time=60 run</p> <p>\u5173\u8054 https://mp.weixin.qq.com/s?__biz=MzU5MDU1NDE2MA==&amp;mid=2247484558&amp;idx=1&amp;sn=953551bf6e5830968019415c1f94bcde&amp;chksm=ff3a1efe753cdc85689b7a0ac4323e926075f234ede914078a62a77435e8824aaecb23844424#rd</p> <p>https://mp.weixin.qq.com/s?__biz=Mzg2Mjc5MzQ4OQ==&amp;mid=2247483828&amp;idx=1&amp;sn=09eaef6aeaaa7cf1ed20d4bf7d9b5b12&amp;chksm=ce033bcaf974b2dc80e826d648e69288156276086c7a017c1b8acc62272e3caf14ae10f745df#rd</p> <p>https://segmentfault.com/a/1190000045371971</p> <p>https://cloud.tencent.com/developer/inventory/14836/article/1621898</p> <p>gdb --batch --pid <code>pidof mysqld</code> --ex 'call malloc_trim(0)'</p> <p>\u8fde\u63a5\u65f6\u5019\u9700\u8981\u7684\u53c2\u6570</p> <pre><code>read_buffer_size = 4M\nread_rnd_buffer_size = 4M\nsort_buffer_size = 4M\njoin_buffer_size = 4M\ntmp_table_size = 32M\nmax_heap_table_size = 32M\nmax_connections = 512\n</code></pre>"},{"location":"mysql/mysqlmem/#_19","title":"\u5904\u7406","text":"<p>thread_cache_size = 0 innodb_flush_method=O_DIRECT</p> <p>group_replication_single_primary_mode=ON log_error_verbosity=3 group_replication_bootstrap_group=OFF  group_replication_transaction_size_limit=&lt;\u9ed8\u8ba4\u503c150MB\uff0c\u4f46\u5efa\u8bae\u8c03\u4f4e\u572820MB\u4ee5\u5185\uff0c\u4e0d\u8981\u4f7f\u7528\u5927\u4e8b\u52a1&gt; group_replication_communication_max_message_size=10M group_replication_flow_control_mode=OFF #\u5b98\u65b9\u7248\u672c\u7684\u6d41\u63a7\u673a\u5236\u4e0d\u592a\u5408\u7406\uff0c\u5176\u5b9e\u53ef\u4ee5\u8003\u8651\u5173\u95ed group_replication_exit_state_action=READ_ONLY group_replication_member_expel_timeout=5 </p>"},{"location":"mysql/mysqlslap/","title":"mysqlslap","text":""},{"location":"mysql/mysqlslap/#sql","title":"\u81ea\u5b9a\u4e49sql","text":"<pre><code># cat create.sql\nCREATE TABLE IF NOT EXISTS simple_table (\n    id INT PRIMARY KEY AUTO_INCREMENT,\n    name VARCHAR(100),\n    age INT, \n    email VARCHAR(100)\n);\n\nINSERT INTO simple_table (name, age, email) VALUES ('\u5f20\u4e09', 25, 'zhangsan@example.com');\nINSERT INTO simple_table (name, age, email) VALUES ('\u674e\u56db', 28, 'lisi@example.com');\nINSERT INTO simple_table (name, age, email) VALUES ('\u738b\u4e94', 22, 'wangwu@example.com');\n</code></pre> <pre><code># cat query.sql\nselect * from simple_table;\n</code></pre>"},{"location":"mysql/mysqlslap/#_1","title":"\u538b\u6d4b","text":"<pre><code>mysqlslap --delimiter=\";\" --concurrency=50 --iterations=10 --engine=innodb --create-schema=mydb \\\n--create=create.sql --query=query.sql ENGINE=INNODB  -uroot -pxxxx -h xxx\n</code></pre>"},{"location":"mysql/navtree/","title":"Tutorials","text":"<p>In addition to the basic getting started guides, we offer tutorials that aim to show how you can use Material for MkDocs in different use cases. In contrast to the getting started guides or the reference documentation, the tutorials show the breadth of features available in Material for MkDocs but also within the wider MkDocs ecosystem.</p> <p>The tutorials guide you through worked examples, so by following them you should gain not only an understanding of how to use Material for MkDocs, but also a template for your own projects. For convenience, these templates are also available as template repositories on GitHub.</p> <p>The tutorials assume that you have installed either the public version or the Insiders edition of Material for MkDocs and that you have worked through the creating your site setup guide.</p> <p>Note that where the features we use require the Insiders edition, we mark these with the heart icon:  If you are using the public version then you can skip these steps. Sometimes there will be ways of achieving the same goal that differ between the public version and the Insider edition. In that case, we will show them in a tabbed view so you can see one or the other.</p> <p>!!! note \"Feedback wanted!\"     The tutorials are a recent addition to our documentation and we are still     working out what shape they should have in the end. Please provide any     feedback you might have in this discussion thread.</p> <pre><code>Note, however, that suggestions should be specific and feasible. We want to\nfocus on creating more content at the moment, instead of developing a\nspecific styling or behaviour for the tutorials. If there are worthwhile\nimprovements that we can make through simple customization then we are happy\nto consider those.\n</code></pre>"},{"location":"mysql/navtree/#blogs","title":"Blogs","text":"<ul> <li>Basics (20 min)    covers the basics of setting up a blog, including post metadata.</li> <li>Navigation, pagination, multiple authors (30 min)   describes how to make it easier for your readers to find content.</li> <li>Engagement and dissemination (30 min)   walks you through ways of increasing engagement with your content.</li> </ul> <p>:octicons-repo-template-24: Template Repository</p>"},{"location":"mysql/navtree/#social-cards","title":"Social cards","text":"<ul> <li>Basics (20 min)    shows you how to configure Material for MkDocs to create social cards for   your content.</li> <li>Custom cards (15 min)   shows you how to design your own custom social cards.</li> </ul> <p>:octicons-repo-template-24: Template Repository</p>"},{"location":"mysql/ocp/","title":"Ocp","text":"<pre><code>E)SELECT id, name FROM user WHERE id=23 OR id=32 AND 1=1; \u00a0\nA)SELECT user, passwd FROM members WHERE user = ' ? ' ; INSERT INTO members ('user' , 'passwd' ) VALUES ('bob@example.com' , 'secret' ) ;-- '; \nD)SELECT id, name FROM user WHERE id=23 OR id=32 OR 1=1; \u00a0\nC)SELECT id, name FROM user WHERE user.id= (SELECT members.id FROM members) ; \u00a0\nF)SELECT email, passwd FROM members WHERE email = 'INSERT INTO members('email' , ' passwd ' ) VALUES ('bob@example.com' , 'secret') ;-- '; \u00a0\nB)SELECT user, phone FROM customers WHERE name = ' \\\\; DROP TABLE users; -- '; \n</code></pre> <p>41 </p> <pre><code>On examination, your MySQL installation datadir has become recursively world\u00a0\nread/write/executable. What are two major concerns of running an installation with incorrect file privileges?\u00a0\n\nC)SQL injections could be used to insert bad data into the database. \u00a0\nD)Extra startup time would be required\u00a0for\u00a0the MySQL server to reset the privileges.\uff08\u6ca1\u6709\u8fd9\u4e2a\u529f\u80fd\uff09\u00a0\n\u00a0\nA)Data files could be deleted. (datafiles) \u00a0\nE)MySQL binaries could be damaged, deleted, or altered.\uff08basedir \u4e2d\u624d\u6709 MySQL binaries\uff09 \u00a0\nB)Users could overwrite configuration files.(mysqld-auto.ccnf) \n</code></pre> <p>42</p> <pre><code>Choose two.Which two methods can be used to determine whether a query uses the hash join\u00a0\nalgorithm?\u00a0\nA. EXPLAIN FORMAT=TREE\u00a0\nB. EXPLAIN FORMAT=JSON \nC. EXPIAIN ANALYZE \u00a0\nD. EXPLAIN FORMAT=TRADIRIONAL\u00a0\nE. EXPIAIN without any formatting argument\n</code></pre> <p>71 Choose two.You must\u00a0export\u00a0data from a\u00a0set\u00a0of tables\u00a0in\u00a0the world_x database. Examine this\u00a0set\u00a0of\u00a0 tables:Tables (country, countryinfo, location)Which two options will\u00a0export\u00a0data into one or more\u00a0 files?\u00a0 C)shell&gt; mysqlexport world_x country countryinfo location &gt; mydump.sql  A)shell&gt; mysqldump world_x country countryinfo location &gt; mydump.sql E)shell&gt; mysql --batch world_x.country world_x.countryinfo world_x.1ocation &gt; mydump.sql  D)mysql&gt; CLONE LOCAL DATA DIRECTORY =\u00a0'/var/lib/mysql/world_x/country'\u00a0; mysql&gt; CLONE\u00a0 LOCAL DATA DIRECTORY =\u00a0'/var/lib/mysql/world_x/countryinfo'\u00a0; mysql&gt; CLONE LOCAL DATA\u00a0 DIRECTORY =\u00a0'/var/lib/mysql/world_x/location'\u00a0;  B)mysql&gt; SELECT * INTO OUTFILE\u00a0'/output/country. txt'\u00a0FROM world_x.country; mysql&gt; SELECT *\u00a0 INTO OUTFILE\u00a0'/output/countryinfo. txt'\u00a0FROM world_x.countryinfo; mysql&gt; SELECT * INTO OUTFILE\u00a0 '/output/location. txt'\u00a0FROM world_x.location; </p> <p>72 Choose three.Which are three benefits of using mysqlbackup instead of mysqldump?\u00a0 B)mysqlbackup allows logical backups with concurrency resulting in faster backups and restores.  A)mysqlbackup can perform partial backup of stored programs.  F)mysqlbackup restores data from physical backups, which are faster than logical backups.  C)mysqlbackup integrates tape backup and has the virtual tape option.  E)mysqlbackup does not back up MySQL system tables, which shortens backup time. D)mysqlbackup can back up tables with the InnoDB engine without blocking reducing wait times\u00a0 due to contention. </p> <p>73 Choose two.All MySQL Server instances belonging to InnoDB Cluster have SSL configured and\u00a0 enabled. You must configure InnoDB Cluster to use SSL\u00a0for\u00a0group communication. .Which two\u00a0 statements are\u00a0true?\u00a0 F)Configuring SSL group communication also configures SSL distributed recovery.  D)SSL group communication can be enabled\u00a0for\u00a0an existing cluster, one instance at time, by setting\u00a0 group_replication_ssl_mode.  E)SSL group communication requires the use of an additional\u00a0set\u00a0of parameters\u00a0 group_replication_recovery_*. B)If only some InnoDB Cluster members are enabled\u00a0for\u00a0SSL group communication, and --ssl mode=PREFERRED, communication will fall back to unencrypted connection.  A)An existing InnoDB Cluster must be dissolved and created from scratch to\u00a0enable\u00a0SSL\u00a0for\u00a0group\u00a0 communication.  C)SSL group communication must be enabled at cluster creation time by specifying createCluster\u00a0 (memberSslMode:'REQUIRED'). </p> <p>74</p> <p>After installing MySQL 8.0 on Oracle Linux 7, you initialize the data directory with the mysqld - initialize command.Which two will assist\u00a0in\u00a0locating the root password?\u00a0 C)the root password inserted\u00a0in\u00a0the error\u00a0log\u00a0set\u00a0by the --log-error=file_name variable  A)the root_pw variable stored\u00a0in\u00a0the mysql.install table  B)the root password displayed on the screen via a Warning message \u00a0 D)the root password written to the /root/.my.cnf file  E)as root, executing the SHOW PASSWORD\u00a0command\u00a0by using the SHA-256 password encryption\u00a0 plugin  75  Choose two.Identify two ways to significantly improve data security.\u00a0 B)Use a private network behind a firewall.  D)Configure MySQL to have only one administrative account.  E)Configure mysqld to use only local disks or attached disks and to have its own account in the host\u00a0 system.  A)Configure mysqld to run as the system admin account, such as root.  C)Configure mysqld to use only networked disks. </p> <p>76 Which two are valid uses\u00a0for\u00a0binary logs on a MySQL instance?\u00a0 E)recording the order\u00a0in\u00a0which\u00a0queries are issued  D)point-in-time recovery  A)logging the duration and locks\u00a0for\u00a0all queries  B)replication  C)audit of all queries </p> <p>77 Choose two.Which two are features of MySQL Enterprise Firewall?\u00a0 B) modifying SQL statement dynamically with substitutions  A) blocking of potential threats by configuring pre- approved whitelists  C) recording incoming SQL statement to facilitate the creation of a whitelist of permitted\u00a0 commands  D) automatic locking of user accounts who\u00a0break\u00a0your firewall  E) provides stateless firewall access to TCP/3306 </p> <p>78 Choose three.Which three methods display the complete table definition of an InnoDB table?  E)SELECT * FROM table 1\\G  F)SHOW CREATE TABLE  C)mysqldump --no-data schema table  A)hexdump -v -C table.frm  B)REPAIR TABLE table USE_FRM  D)Query the Information Schema. </p> <p>79 Which two statements are\u00a0true\u00a0about the mysql_config_editor program? \u00a0 F)It manages the configuration of the MySQL Firewall feature.  C)It can move datadir to a new location.  B)It manages the configuration of client programs. (only work\u00a0for\u00a0mysql client)  G)It can be used to create and edit SSL certificates and\u00a0log\u00a0locations. \u00a0 E)It will use client options by default unless you provide \u2013login-path. (mysql = mysql \u2013login path=client) \u00a0 D)It manages the configuration of user privileges\u00a0for\u00a0accessing the server.  A)It provides an interface to change my.cnf files.</p> <p>80 Choose three.A MySQL server is monitored using MySQL Enterprise Monitor\u00a0's agentless\u00a0 installation.Which three features are available with this installation method?\u00a0 C) CPU utilization  B) security-related advisor warnings  E) MySQL Query Analysis data  D) disk usage and disk characteristics including disk advisors warnings  A) MySQL Replication monitoring  G) network-related information and network characteristics  F) operating system memory utilization </p> <p>81 Choose four.Which four are types of information stored\u00a0in\u00a0the MySQL data dictionary?\u00a0 H)access control lists \u00a0 C)performance metrics \u00a0 B)server configuration rollback \u00a0 F)view definitions \u00a0 G)table definitions. \u00a0 E)InnoDB buffer pool LRU management data \u00a0 A)server runtime configuration \u00a0 D)stored procedure definitions </p> <p>82 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles.  C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect.  F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles.  E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. </p> <p>83 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles.  C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect.  F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles.  E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. </p> <p>84 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>85 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>86 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>87 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>88 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>89 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>90 Choose two.Examine this statement:mysql&gt;DROP ROLE r_role1, r_role2 ; Which two are true?\u00a0 B)You must revoke all privileges from r_role1 and r_role2 before dropping the roles. \u00a0 C)It fails if at least one of the roles does not exist.  D)Existing connections can continue to use the roles' privileges until they reconnect. \u00a0 F)It fails if any of the roles is specified in the mandatory_roles variable.  A)You must revoke r_role1 and r_role2 from all users and other roles before dropping the roles. \u00a0 E)It fails if you do not have the ADMIN OPTION of the roles r_role1 and r_role2. \u00a0</p> <p>91 Choose two.Which two statements are true about the data dictionary object cache?\u00a0 B)Character set and collation definition objects are not cached. \u00a0 A)The dictionary object caches use a Least Recently Used (LRU) algorithm to manage entries in each\u00a0 cache.  D)If the dictionary object cache becomes full, MySQL server will be unable to create any more\u00a0 tables/objects. \u00a0 E)tablespace_definition_cache sets the number of tablespace objects that can be stored in the\u00a0 dictionary object cache.  C)All dictionary object caches have a hard-coded size. \u00a0</p> <p>92  Choose two.Examine this statement,\u00a0which\u00a0executes successfully:CREATE USER mary@192.0.2.100\u00a0 IDENTIFIED BY\u00a0'P@SSw0rd'\u00a0REQUIRE NONE PASSWORD EXPIRE;Which two are\u00a0true?\u00a0 A)Mary must connect using the username\u00a0'mary@192.0.2.100'. \u00a0 C)Mary must connect from the client machine 192.0.2.100.  D)Mary cannot connect to the MySQL server until the DBA resets her password. \u00a0 B)Mary requires no password to connect to the MySQL server. \u00a0 E)Mary cannot query data until she changes her password. </p> <p>93 Choose two.Examine this\u00a0command,\u00a0which\u00a0executes successfully on InnoDB\u00a0 Cluster:dba.dropMetadataschema ()Which two statements are\u00a0true?\u00a0 D)Connections driven by MySQL Router are not affected by the\u00a0command. \u00a0 A)The mysql_innodb_cluster_metadata schema is dropped from the instance\u00a0where\u00a0the connection\u00a0 was established. \u00a0 E)The mysql_innodb_cluster_metadata schema is dropped from all reachable members of the cluster.\u00a0</p> <p>F)Group Replication will be dissolved and all metadata purged. \u00a0 C)The\u00a0command\u00a0drops the mysql_innodb_cluster_metadata schema and re-creates it. \u00a0 B)Group Replication is still operational, but InnoDB Cluster must be reimported under MySQL Shell.\u00a0</p> <p>94 Choose two.User account baduser@hostname on your MySQL instance has been compromised.\u00a0 Which two commands stop any new connections using the compromised account?\u00a0 B)ALTER USER baduser@hostname DEFAULT ROLE NONE; \u00a0 D)ALTER USER baduser@hostname IDENTIFIED WITH mysql_no_login;  A)ALTER USER baduser@hostname PASSWORD DISABLED; \u00a0 E)ALTER USER baduser@hostname ACCOUNT LOCK;  C)ALTER USER baduser@hostname MAX_USER_CONNECTIONS 0; \u00a0</p> <p>95 Choose two.Which two are use cases of MySQL asynchronous replication?\u00a0 A)You can scale reads by adding multiple slaves.  C)You can scale writes by creating a replicated mesh. \u00a0 D)It guarantees near real-time replication between a master and a slave. \u00a0 E)It allows backup to be\u00a0done\u00a0on the slave without impacting the master.  B)MySQL Enterprise Backup will automatically back up from an available slave. </p> <p>96 Choose two.Examine this\u00a0command,\u00a0which\u00a0executes successfully:mysqlpump --user=root - password &gt; full_backup.sql Which two databases will be excluded from this dump?\u00a0 A)mysql \u00a0 B)information_schema  D)employee \u00a0 C)world \u00a0 E)sys </p> <p>97 Choose two A valid raw backup of the shop.customers MyISAM table was taken. You must restore\u00a0 the table.You begin with these steps: 1.Confirm that secure_file_priv=\u00a0'/var/tmp ' 2.mysql&gt; DROP TABLE shop.customers; 3.shell&gt; cp /backup/customers.MY* /var/1ib/mysql/shop/ Which two actions are required to complete the restore?\u00a0</p> <p>B)mysql&gt; SOURCE\u00a0'/var/tmp/customers.sdi \u00a0 E)shell&gt; cp /backup/customers.frm /var/1ib/mysql/shop/ \u00a0 H)mysql&gt; ALTER TABLE shop.customers IMPORT TABLESPACE \u00a0 A)shell&gt; cp /backup/customers.sdi /var/tmp  D)mysql&gt; ALTER TABLE shop.customers DISCARD TABLESPACE \u00a0 C)shell&gt; cp /backup/customers.sdi /var/1ib/mysql/shop/ \u00a0 G)mysql&gt; IMPORT TABLE FROM /var/tmp/customers.sdi  F)mysql&gt; IMPORT TABLE FROM /var/1ib/mysql/shop/customers.sdi. </p> <p>98 Choose two.Which two MySQL Shell commands are excluded from the InnoDB Cluster creation\u00a0 procedure?\u00a0 F)dba.createCluster ()\u00a0#\u521b\u5efa\u96c6\u7fa4 \u00a0 B)dba.configureLocalInstance ()\u00a0##\u6301\u4e45\u5316\u914d\u7f6e\u4fe1\u606f \u00a0 G)cluster.forceQuorumUsingPartitionOf ()\u00a0#\u5c06\u96c6\u7fa4\u4ece quorum \u4e22\u5931\u573a\u666f\u6062\u590d\u5230\u53ef\u64cd\u4f5c\u72b6\u6001\u3002\u5982\u679c\u4e00\u4e2a\u7ec4 \u88ab\u5206\u533a\u6216\u53d1\u751f\u7684\u5d29\u6e83\u8d85\u8fc7\u4e86\u53ef\u5bb9\u5fcd\u7684\u8303\u56f4\uff0c\u5219\u53ef\u80fd\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u3002  D)cluster.setPrimaryInstance()\u00a0##\u8bbe\u7f6e\u4e3b\u8282\u70b9  A)cluster.addInstance ()\u00a0#\u6dfb\u52a0\u8282\u70b9 \u00a0 C)dba.checkInstanceConfiguration()\u00a0##\u68c0\u67e5\u8282\u70b9 \u00a0 E)dba.configureInstance()\u00a0##\u68c0</p> <p>99 Choose two.Examine this\u00a0command,\u00a0which\u00a0executes successfully: shell&gt; mysqldump --master-data=2 --single-transaction --result-file=dump.sql mydb Which two statements are\u00a0true?\u00a0</p> <p>E)It executes flush tables with\u00a0read\u00a0lock.  C)It is a cold backup. \u00a0 A)This option uses the READ COMMITTED transaction isolation mode. \u00a0 B)It enforces consistent backups\u00a0for\u00a0all storage engines. \u00a0 D)The backup created is a consistent data dump. </p> <p>100 Choose two.Which two methods allow a DBA to reset a user's password?\u00a0 B)mysql_secure_installation utility \u00a0 A)SET PASSWORD statement  E)mysqladmin client program \u00a0 D)GRANT statement \u00a0 C)ALTER USER statement </p> <p>101 Choose two.The data in this instance is transient; no backup or replication will be required. It is\u00a0 currently under performing. .\u25cfThe database size is static and including indexes is 19G.\u25cfTotal system\u00a0 memory is 32G.After profiling the system, you highlight these MySQL status and global\u00a0 variables:Com_rollback 85408355 Com_commit 1242324 Innodb_buffer_pool_pages_free 163840\u00a0 mysqldbuffer_pool_size=20G innodb_flush_log_at_trx_commit=2 disable-log-binThe OS metrics\u00a0 indicate that disk is a bottleneck. Other variables retain their default values.Which two changes will\u00a0 provide the most benefit to the instance?\u00a0 D)innodb_doublewrite=0  A)sync_binlog=0  F)innodb_log_file_size=1G E)max_connections=10000  C)innodb_flush_log_at_trx_commit=1  B)buffer_pool_size=24G </p> <p>102 choose two Examine Joe's account: CREATE USER 'joe'@'%' IDENTIFIED BY 'secret' GRANT ALL\u00a0 PRIVILEGES ON . TO 'joe'@'%' All existing connections for joe are killed. Which two commands will stop joe establishing access to the MySQL instance? \u00a0 E)ALTER USER 'joe'@'%' IDENTIFIED BY 'invalid' PASSWORD EXPIRE D)ALTER USER 'joe'@'%' SET password='invalid'  A)ALTER USER 'joe'@'%' ACCOUNT LOCK F)REVOKE USAGE ON . FROM 'joe'@'%'  C)REVOKE ALL PRIVILEGES ON . FROM 'joe'@'%'  B)ALTER USER 'joe'@'%' PASSWORD HISTORY : </p> <p>103 Which two can minimize security risks when creating user accounts?\u00a0 D)Do not allow accounts without passwords. E)Require users to have the FIREWALL USER privilege defined.  C)Require the use of mixed\u00a0case\u00a0usernames.  A)Avoid the use of wildcards\u00a0in\u00a0host names. B)Avoid the use of wildcards\u00a0in\u00a0usernames. </p> <p>104 Choose two.Mary connects to a Linux MySQL Server from a client on a Windows machine. Examine this statement and output:\uff08\u89c1\u4e0b\u56fe\uff09Which two are\u00a0true?\u00a0 ![alt text(ocpimages/640.png) C)Mary has the privileges of account mary@%. E)Mary authenticated to the account mary@192.0.2.101.  D)Mary connected using a UNIX socket.  B)Mary connected to the database server whose IP address is 192.0.2.101.  A)Mary connected from a client machine whose IP address is 192.0.2.101. </p> <p>105 Choose two.Which two actions can obtain information about deadlocks?\u00a0 D)Run the SHOW ENGINE INNODB STATUS\u00a0command\u00a0from the mysql client. A)Run the SHOW ENGINE INNODB MUTEX\u00a0command\u00a0from the mysql client.  B)Enable the innodb_status_output_locks global parameter.  E)Use the sys.innodb_lock_waits view.  C)Enable the innodb_print_all_deadlocks global parameter.</p> <p>106 Choose two.Which two are\u00a0true\u00a0about binary logs used\u00a0in\u00a0asynchronous replication?\u00a0 C)They are pushed from the master to the slave.  B)They contain events that describe database changes on the master. D)They contain events that describe only administrative commands run on the master.  A)They contain events that describe all queries run on the master.  E)They are pulled from the master to the slave. </p> <p>107 Choose two A scientific data gathering application uses a MySQL instance back end\u00a0for\u00a0data management.There is a high concurrency of transactions at thousands of transactions per second of volatile data.A restore from binary logs is planned using the\u00a0command:mysqlbinlog--start datetime='2019-08-01 11:00:00'--stop-datetime='2019-08-10 08:30:25'binlog.000238 binlog.000239 binlog.000240 mysqlWhich two characteristics cause the restore to be inconsistent to the original data?\u00a0 E)The time span of binary logs is too long to restore.  C)Temporary tables cannot persist across binary logs.  A)Transaction rate is too high to get a consistent restore. B)Multiple binary logs cannot be specified on the\u00a0command\u00a0line.  D)The temporal values\u00a0do\u00a0not offer high enough precision. </p> <p>108 Choose two.Which two are contained\u00a0in\u00a0the InnoDB system tablespace (ibdata1) by default?\u00a0</p> <p>D)primary indexes  B)change buffer A)doublewrite buffer C)InnoDB Data Dictionary  E)table data  F)user privileges </p> <p>109 Choose two.Examine these InnoDB Cluster parameter\u00a0 settings:cluster.setInstanceOption('host1:3377',\u00a0'memberWeight',\u00a0 40)cluster.setInstanceOption('host2:3377',\u00a0'memberWeight',\u00a0 30)cluster.setInstanceOption('host3:3377',\u00a0'memberweight', 40)\u00a0 cluster.setInstanceOption('host3:3377',\u00a0'exitstateAction', \\ABORT_SERVER) cluster.setOption\u00a0 (\\expelTimeout\\,1)Now examine the partial status:\uff08\u89c1\u4e0b\u56fe\uff09A permanent network failure isolates\u00a0 host3. Which two statements are\u00a0true?\u00a0</p> <p>E)The instance deployed on host2 is elected as the new primary instance.  F)The issuing\u00a0command\u00a0cluster.switchToMultiPrimaryMode() will fail to\u00a0enable\u00a0multi-primary mode.\u00a0 \u00a0 B)Failure of the instance deployed on host1 provokes an outage.  D)The primary instance can be specified by using the\u00a0command\u00a0cluster.setPrimaryInstance\u00a0 (:). A)The instance deployed on host3 will automatically rejoin the cluster when connectivity is re established.  C)The instance deployed on host3 is expelled from the cluster and must be rejoined using\u00a0 cluster.addInstance('host3:3377').  <p>![alt text(ocpimages/109.png)</p> <p>110 Choose two.A clean shutdown was performed with innodb_fast_shutdown=0.While you were\u00a0 manipulating files, all files were accidentally deleted from the top-level data directory.Which two\u00a0 files must be restored from backup to allow the DB to restart cleanly?\u00a0 D)ibdata1 F)undo_001  E)ibtmp1  C)mysql.ibd B)ib_logfile0  A)ib_buffer_pool </p> <p>111 SELECT * FROM performance_schema.table_io_waits_summary_by_table\u00a0 WHERE COUNT_STAR &gt; 0 \\G</p> <p>OBJECT_TYPE: TABLE \u00a0 OBJECT_SCHEMA: test \u00a0 OBJECT_NAME: demo_test \u00a0 COUNT_STAR: 61567093 \u00a0 SUM_TIMER_WAIT: 59009007572922 \u00a0 MIN_TIMER_WAIT: 395922 \u00a0 AVG_TIMER_WAIT: 958095 \u00a0 MAX_TIMER_WAIT: 558852005358 \u00a0</p> <p>COUNT_READ: 38665056 \u00a0 SUM_TIMER_READ: 20598719962188 \u00a0 MIN_TIMER_READ: 395922 \u00a0 AVG_TIMER_READ: 532728 \u00a0 MAX_TIMER_READ: 558852005358 \u00a0</p> <p>COUNT_WRITE: 22902028 \u00a0 SUM_TIMER_WRITE: 38410287610743 \u00a0 MIN_TIMER_WRITE: 1130688 \u00a0 AVG_TIMER_WRITE: 1677006 \u00a0 MAX_TIMER_WRITE: 17205682920 \u00a0</p> <p>COUNT_DELETE: 22902028 \u00a0 SUM_TIMER_DELETE: 38410287610743 \u00a0 MIN_TIMER_DELETE: 1130688 \u00a0 AVG_TIMER_DELETE: 1677006 \u00a0 MAX_TIMER_DELETE: 17205682920</p> <p>D)Average read times are approximately three times faster than writes. C)22902028 rows were deleted. These columns aggregate all delete operations. E)The longest I/O wait was for writes.  B)The I/O average time is 532728. These columns aggregate all fetch operations  A)I/O distribution is approximately 50/50 read/write. </p> <p>112 Choose two.Which two statements are\u00a0true\u00a0about using backups of the binary\u00a0log?\u00a0 C) Multiple binary logs can be used to restore data. D) They allow\u00a0for\u00a0point-in-time recovery of the data. E) Multiple binary logs can be applied\u00a0in\u00a0parallel\u00a0for\u00a0faster data restoration.  A) Binary logs are relatively small, and therefore, excellent\u00a0for\u00a0long-term storage and disaster\u00a0 recovery.  B) Binary logs can always be used to unapply unwanted schema changes.  </p> <p>113 Examine this\u00a0command,\u00a0which\u00a0executes successfully on InnoDB\u00a0 Cluster:dba.dropMetadataSchema()Which two statements are\u00a0true?\u00a0</p> <p>C)Connections driven by MySQL Router are not affected by the\u00a0command.\uff08\u5143\u6570\u636e\u5df2\u7ecf\u6ca1\u6709\uff09  D)The mysql_innodb_cluster_metadata schema is dropped from all reachable members of the cluster. A)The\u00a0command\u00a0drops the mysql_innodb_cluster_metadata schema and re-creates it.(\u4e0d\u91cd\u5efa)  B)The mysql_innodb_cluster_metadata schema is dropped from the instance\u00a0where\u00a0the connection was established.  F)Group Replication is still operational, but InnoDB Cluster must be reimported under MySQL Shell.\u00a0 \u00a0 E)Group Replication will be dissolved and all metadata purged.\uff08\u9700\u8981\u6267\u884c dissolve\uff09 </p> <p>114 Choose two.You are backing up raw InnoDB files by using mysqlbackup.Which two groups of files\u00a0 will be backed up during a full backup?\u00a0 E) .sdi files  A) .ibd files C) .CSM files  B) ibbackup files  D) ib_logfile files </p> <p>115 Choose two.Which two are characteristics of snapshot-based backups?\u00a0 C) Snapshot-based backups greatly reduce time during\u00a0which\u00a0the database and applications are\u00a0 unavailable. B) There is no need\u00a0for\u00a0InnoDB tables to perform its own recovery when restoring from the\u00a0 snapshot backup.  D) A separate physical copy must be made before releasing the snapshot backup. E) Snapshot backups can be used only\u00a0in\u00a0virtual machines.  A) The frozen file system can be cloned to another virtual machine immediately into active service.\u00a0  \u00a0</p> <p>116 Choose three.Examine these statements,\u00a0which\u00a0execute successfully: TRUNCATE\u00a0test; BEGIN;INSERT\u00a0 INTO\u00a0test\u00a0(id, name) VALUES(1, \\Hello) ;\u00a0 ROLLBACK; SELECT id FROM\u00a0test; Which three storage\u00a0 engines would\u00a0return\u00a0a nonempty recordset\u00a0for\u00a0the\u00a0test\u00a0table when executing the statements?\u00a0 A)MEMORY E)MyISAM F)InnoDB  B)BLACKHOLE  D)NDB  C)ARCHIVE </p> <p>117 Choose two.Which two statements are\u00a0true\u00a0about the mysql_config_editor program?\u00a0 F)It manages the configuration of the MySQL Firewall feature.  C)It will use client options by default unless you provide --login-path. D)It can be used to create and edit SSL certificates and\u00a0log\u00a0locations.  A)It provides an interface to change my.cnf files.  E)It manages the configuration of user privileges\u00a0for\u00a0accessing the server.  G)It manages the configuration of client programs. B)It can move datadir to a new location. </p> <p>118 Choose two.Which two statements are\u00a0true\u00a0about the binary\u00a0log\u00a0encryption feature?\u00a0 C)It can be\u00a0set\u00a0at run time. D)It can be activated per session.  A)It requires a keyring plugin. B)When enabled it encrypts existing binary logs.  E)It encrypts any connecting slaves connection thread. </p> <p>119 Choose two.Examine this MySQL client\u00a0command\u00a0to connect to a remote database:mysql -h\u00a0 remote.example.org -u root -p --protocol=TCP --ssl-mode=Which two --ssl-mode values will\u00a0 ensure that an X.509-compliant certificate will be used to establish the SSL/TLS connection to\u00a0 MySQL?\u00a0 B) REQUIRED  C) VERIFY_IDENTITY. E) VERIFY_CA A) DISABLED  D) PREFERED </p> <p>120 Choose two.Examine this query and its output:\uff08\u89c1\u4e0b\u56fe\uff09Which two statements are\u00a0true?\u00a0 ![alt text(ocpimages/120.png) A)User bob had a significantly higher ratio of SELECT + INSERT statements to QUIT than both app\u00a0 and root users.app  D)The root user had the largest number of modified rows for a SELECT statement.  C)The app user had the highest total number of rows read from storage engines. E)The root user had the largest single wait time. B)User bob had the largest total time waiting for locks. </p> <p>121 Examine this SQL statement:mysql&gt; GRANT r_read To mark@localhost WITH ADMIN\u00a0OPTION; Which two are\u00a0true? (Choose two.)\u00a0 D)Mark can revoke the r_read role from another role. \u00a0 C)Mark can grant the r_read role to another user. \u00a0 A)Mark can grant the privileges assigned to the r_read role to another user.  E)ADMIN OPTION allows Mark to drop the role.  B)ADMIN OPTION causes the role to be activated by default.  F)Mark must connect from localhost to activate the r_read role. </p> <p>122 Choose two .Which two statements are true about MySQL Installer? C)Manual download of separate product packages is required before installing them through\u00a0 MySQL Installer. \u00a0 E)It performs product upgrades.  A)It provides only GUI-driven, interactive installations.  B)It installs most Oracle MySQL products. \u00a0 D)It provides a uniform installation wizard across multiple platforms.  </p> <p>123 Choose three .Which three actions are effective in capacity planning?\u00a0 B)buying more RAM  C)buying more disk  G)monitoring OS resources for patterns \u00a0 F)upgrading to the latest application version  A)adding circular replication nodes for increased DML capability  E)basing expected growth on an average of the last 3 years \u00a0 D)buying more CPU  H)consulting the application team about any future projects and use </p> <p>124 Choose the best answer.Four nodes are configured to use circular replication. Examine these\u00a0 configuration parameters\u00a0for\u00a0each node:slave_parallel_type=DATABASE ;\u00a0 slave_parallel_workers=4 slave_preserve_commit_order=0 Which statement is\u00a0true?\u00a0 B)Cross-database constraints can cause database inconsistency. \u00a0 E)Setting slave_preserve_commit_order to ON will improve data consistency.  C)Setting slave_parallel_type=DATABASE won't work for circular replication; it should be set to\u00a0 LOGICAL_CLOCK.  F)Setting transaction_allow_batching to ON will improve data consistency.  D)Increasing slave_parallel_workers will improve high availability.  A)Each slave thread is responsible for updating a specific database. </p> <p>125 Examine this partial output\u00a0for\u00a0InnoDB Cluster\u00a0 status:\u201ctopology\u201d;\u201chost1:3377\u201d:\u201daddress\u201d;\u201dhost1:3377\u201d,\u201cmode\u201d:\u201dR/W\u201d,.......\u201cSTATUS\u201d: \u00a0\u201dONLINE\u201d,\u201cversion\u201d;\u201d8.0.18\u2019,\u201chost1:3377\u201d:\u201daddress\u201d;\u201dhost2:3377\u201d,\u201cmode\u201d:\u201dR/O\u201d,.... \u00a0...\u201cSTATUS\u201d:\u201dMISSING\u201d,,\u201chost1:3377\u201d:\u201daddress\u201d;\u201dhost3:3377\u201d,\u201cmode\u201d:\u201dR/O\u201d,.......\u201cST \u00a0ATUS\u201d:\u201dONLINE\u201d,\u201cversion\u201d;\u201d8.0.18\u2019Which statement explains the state of the instance\u00a0 deployed on host2?\u00a0 C)It can be recovered from a donor instance on host3 by cloning using the\u00a0command\u00a0 cluster.rejoinInstance ('@host2:3377'). \u00a0 E)It can rejoin the cluster by using the\u00a0command\u00a0dba.rebootClusterFromCompleteOutage().  A)It can rejoin the cluster by using the\u00a0command\u00a0cluster.addInstance ('@host2:3377').  D)It has been removed from the cluster by using the\u00a0command\u00a0STOP GROUP_REPLICATION;. .  B)It has been expelled from the cluster because of a transaction error.  <p>126 Choose the best answer.Examine this command:shell&gt; mysqldump --no-create-info --all-databases --result-file=dump.sql Which statement is true?\u00a0 D)It will not write CREATE TABLE statements. \u00a0 A)It will not write CREATE TABLESPACE statements.  B)It will not write CREATE LOGFILE GROUP statements.  C)It will not write CREATE DATABASE statements. </p> <p>127 MySQL programs look\u00a0for\u00a0option files\u00a0in\u00a0standard locations.Which method will show the option files\u00a0 and the order\u00a0in\u00a0which\u00a0they are\u00a0read?\u00a0 C)shell&gt; mysqladmin --debug  A)mysql&gt; SHOW GLOBAL VARIABLES;  B)shell&gt; mysql --print-defaults  D)shell&gt; mysqld --help --verbose </p> <p>128 Choose the best answer.Examine this\u00a0command,\u00a0which\u00a0executes successfully:$ mysqlbackup - user=dba --password --port=3306 --with-timestamp --only-known-file-types--backup dir=/export/backups backup Which statement is\u00a0true?\u00a0</p> <p>C)Only non-encrypted files are backed up.  E)The backup includes only data files and their metadata.  D)Only files\u00a0for\u00a0MySQL or its built-in storage engines are backed up. \u00a0 A)Only tables stored\u00a0in\u00a0their own tablespaces are backed up.  B)Only InnoDB data and\u00a0log\u00a0files are backed up. </p> <p>129</p> <pre><code>What does the slave I/O thread\u00a0do?\u00a0\nB)connects to the master and requests it to send updates recorded\u00a0in\u00a0its binary logs \u00a0\nC)acquires a lock on the binary\u00a0log\u00a0for\u00a0reading each event to be sent to the slave \nD)reads the relay\u00a0log\u00a0and executes the events contained\u00a0in\u00a0them \nA)monitors and schedules I/O calls to the subsystem\u00a0for\u00a0the relay logs \n</code></pre> <p>130</p> <pre><code>Choose the best answer.Which statement is\u00a0true\u00a0about the my.ini file on a Windows platform\u00a0while\u00a0\nMySQL server is running?\u00a0\nC)Editing the file will immediately change the running server configuration. \nD)Using SET PERSIST will update the my.ini file. \nA)MySQL server does not use the my.ini option file\u00a0for\u00a0server configuration options. \nB)The option file is\u00a0read\u00a0by the MySQL server service only at start up. \u00a0\n</code></pre> <p>131</p> <pre><code>Examine the full path name of the backup image from MySQL Enterprise Backup with the -\ncompress option:/backup/full/mybackup/myimage.imgmysqlbackup.cnf contains this\u00a0\ndata:mysqlbackupbackup-dir=/backup/full/myrestorebackup\nimage=/backup/full/mybackup/myimage.img uncompressYou must perform a database restore to\u00a0\na new machine.which\u00a0command\u00a0can provision the new database\u00a0in\u00a0datadir as /data/MEB?\u00a0\nB)mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB image-to-dir-and-apply-log\u00a0\n[\u9519\u8bef]\u00a0\nC)mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB apply-log-and-copy-back [\u9519\n\u8bef]\u00a0\nD)mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB copy-back-and-apply-log [\u6b63\n\u786e]\u00a0\nA)mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB restore-and-apply-log [\u9519\u8bef]\u00a0\nE)mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB image-to-dir\n</code></pre> <p>132</p> <pre><code>Choose the best answer.MySQL Enterprise Monitor Query Analyzer is configured to monitor an\u00a0\ninstance. Which statement is true?\u00a0\nE)The slow query log must be enabled on the monitored server to collect information for the Query\u00a0\nAnalyzer. [\u9519\u8bef]\u00a0\nA)The Query Response Time index (QRTi) is fixed to 100ms and cannot be customized. [\u9519\u8bef]\u00a0\nC)An agent must be installed locally on the instance to use the Query Analyzer. [\u9519\u8bef]\u00a0\nB)Enabling the events_statements_history_long consumer allows tracking the longest running query.\u00a0\n[\u9519\u8bef]\u00a0\nD)The Query Analyzer can monitor an unlimited number of normalized statements. [\u6b63\u786e]\n</code></pre> <p>133</p> <pre><code>Choose the best answerUsers report errors when trying to connect from 192.0.2.5 and is connecting using the mysql_native password authentication plugin.Examine these commands and output:\uff08\u89c1\u4e0b\u56fe\uff09Which statement identifies the cause of the errors?\u00a0\n![alt text](ocpimages/133.png)\n\nE)thread_cache is too small. [\u9519\u8bef]\u00a0\nF)skip_name_resolve is enabled. [\u9519\u8bef]\u00a0\nC)Connections are attempted without a valid user account or password. [\u9519\u8bef]\u00a0\nB)Network connectivity issues occurring between client and the MySQL instance. [\u6b63\u786e]\u00a0\nD)User accounts are defined using the mysql_native_pasword plugin\u00a0for\u00a0password authentication.\u00a0\n[\u9519\u8bef]\u00a0\nA)max_connections is too small. [\u9519\u8bef]\n</code></pre> <p>134</p> <pre><code>You want to check the values of the sort_buffer_size session variables of all existing connections.\u00a0\nWhich performance_schema table can you query?\u00a0\nC)variables_by_thread [\u6b63\u786e]\u00a0\nB)session_variables [\u9519\u8bef]\u00a0\nA)global_variables [\u9519\u8bef]\u00a0\nD)user_variables_by_thread [\u9519\u8bef]\n</code></pre> <p>135</p> <pre><code>Choose the best answer.Which feature is provided by multi-source replication?\u00a0\n\nA)providing a common source for the same data to be replicated to other servers [\u9519\u8bef]\u00a0\nB)allowing multiple servers to back up to one server [\u6b63\u786e]\u00a0\nC)managing conflicts between two sets of the same data [\u9519\u8bef]\u00a0\nD)providing multi-source replication where all servers act as the master [\u9519\u8bef]\n</code></pre> <p>136</p> <pre><code>Choose the best answer.t is a non-empty InnoDB table.Examine these statements, which are\u00a0\nexecuted in one session:BEGIN SELECT * FROM t FOR UPDATE;Which is true?\u00a0\nD)If OPTIMIZE TABLE; is invoked, it will create a table lock on t and force a transaction rollback. [\u6b63\u786e]\u00a0\nC)If OPTIMIZE LOCAL TABLE t; is invoked from another session, it executes normally and returns the\u00a0\nstatus. [\u9519\u8bef]\u00a0\nB)If ANALYZE TABLE; is invoked from the same session, it hangs until the transaction is committed\u00a0\nor rolled back. [\u9519\u8bef]\u00a0\nA)mysqlcheck --analyze --all-databases will execute normally on all tables and return a report. [\u9519\u8bef]\n</code></pre> <p>137</p> <pre><code>Choose the best answe You have upgraded the MySQL binaries from 5.7.28 to 8.0.18 by using an\u00a0in\nplace upgrade. Examine the message sequence generated during the first start of MySQL 8.0.18:\uff08\u89c1\n\u4e0b\u56fe\uff09Which step or\u00a0set\u00a0of steps will resolve the errors\n![alt text](ocpimages/137.png)\nA)Start mysqld again using the --upgrade=FORCE option. [\u9519\u8bef]\u00a0\nC)Execute:mysqlcheck --repair mysql columns_priv event proc proxies_priv tables_priv. [\u6b63\u786e]\u00a0\nB)Go to the &lt;datadir&gt;/mysql directory and execute:myisamchk --update-state columns_priv event proc proxies_priv tables_priv. [\u9519\u8bef]\u00a0\nE)Execute:mysqlcheck --check-upgrade mysql columns_priv event proc proxies_priv tables_priv. [\u9519\u8bef]\u00a0\nD)Remove the redo logs. Replace the MySQL binaries with the 5.7.28 binaries. Prepare the tables\u00a0for\u00a0upgrade. Upgrade to 8.0.18 again. [\u9519\u8bef]\n</code></pre> <p>138</p> <pre><code>Choose the best answer.Which statement is\u00a0true\u00a0about MySQL Enterprise Transparent Data\u00a0\nEncryption (TDE)?\u00a0\nB)TDE can encrypt InnoDB and MyISAM tables only when the tables are stored\u00a0in\u00a0the SYSTEM\u00a0\ntablespace. [\u9519\u8bef]\u00a0\nC)Lost tablespace encryption keys can be regenerated only\u00a0if\u00a0the master database key is known or\u00a0\npresent\u00a0in\u00a0the Key Vault specification. [\u9519\u8bef]\u00a0\nD)Both MyISAM and InnoDB tables can be encrypted by setting the keyring_engine = All variable\u00a0in\u00a0\nthe MySQL configuration file. [\u9519\u8bef]\u00a0\nA)MySQL TDE uses an appropriate keyring plugin to store the keys\u00a0in\u00a0a centralized location. [\u6b63\u786e]\n</code></pre> <p>139</p> <pre><code>You are using the InnoDB engine and the innodb_file_per_table option is\u00a0set. You delete a significant number of rows of a large table named FACTORY.INVENTORY.Which\u00a0command\u00a0will reorganize the physical storage of table data and associated index data\u00a0for\u00a0the INVENTORY table,\u00a0in\u00a0order to reduce storage space and improve I/O efficiency?\u00a0\nB)ANALYZE TABLE FACTORY.INVENTORY \u00a0[\u9519\u8bef]\u00a0\nC)OPTIMIZE TABLE FACTORY.INVENTORY [\u6b63\u786e]\u00a0\nE)mysqldump -u root -p FACTORY INVENTORY [\u9519\u8bef]\u00a0\nA)CHECK TABLE FACTORY.INVENTORY [\u9519\u8bef]\u00a0\nD)mysqlcheck -u root -p FACTORY.INVENTORY \u00a0[\u9519\u8bef]\n</code></pre> <p>140</p> <pre><code>Choose the best answer.You must configure the MySQL\u00a0command-line client to provide the highest\u00a0\nlevel of trust and security when connecting to a remote MySQL Server.Which value of --ssl-mode\u00a0\nwill\u00a0do\u00a0this?\u00a0\nD)REQUIRED [\u9519\u8bef]\u00a0\nA)VERIFY_CA [\u9519\u8bef]\u00a0\nB)PREFERRED [\u9519\u8bef]\u00a0\nC)VERIFY_IDENTITY [\u6b63\u786e]\n</code></pre> <p>141</p> <pre><code>Choose the best answer.You want to dump all databases with names that start with \\db\\. Which\u00a0\ncommand\u00a0will achieve this?\u00a0\nB)mysqlpump --include-databases=db% --result-file=all_db_backup.sql [\u6b63\u786e]\u00a0\nC)mysqlpump --include-databases=db -- result-file=all_db_backup.sql [\u9519\u8bef]\u00a0\nA)mysqlpump &gt; all_db_backup.sql [\u9519\u8bef]\u00a0\nD)mysqlpump -- include-tables-db.% --result-file=all_db_backup.sql [\u9519\u8bef]\n</code></pre> <p>142</p> <pre><code>Choose two.You have an installation of MySQL 8 on Oracle Linux. Consider the outputs:\uff08\u89c1\u4e0b\u56fe\uff09\nWhich statement is\u00a0true\u00a0about disk temporary tables\u00a0for\u00a0this installation?\u00a0\n\nB)Temporary tables are created\u00a0in\u00a0tmpdir only after they reach tmp_table_size. \u4e0d\u5bf9 [\u9519\u8bef]\u00a0\nE)Temporary tables will use the InnoDB temporary tablespace located\u00a0in\u00a0/tmp. \u53c2\u6570 innodb_tmpdir\u00a0\n[\u9519\u8bef]\u00a0\nA)Only internal temporary tables from the optimizer will be created\u00a0in\u00a0tmpdir. tablespace [\u9519\u8bef]\u00a0\nD)Temporary tables will use the InnoDB temporary tablespace located\u00a0in\u00a0datadir. \u53c2\u6570\ninnodb_tmpdir [\u6b63\u786e]\u00a0\nC)Temporary tables are created\u00a0in\u00a0tmpdir only\u00a0if\u00a0configured to use MyISAM. [\u9519\u8bef]\n![alt text](ocpimages/142.png)\n</code></pre> <p>143</p> <pre><code>Choose the best answer.What is the correct syntax\u00a0for\u00a0using transparent data encryption with an\u00a0\nexisting InnoDB table?\u00a0\nC)ALTER TABLE t1 ENCRYPTION='Y'; [\u6b63\u786e]\u00a0\nB)ALTER TABLE t1 ADD ENCRYPTED_TABLESPACE =\u00a0'Y'; [\u9519\u8bef]\u00a0\nD)ALTER TABLE t1 WITH ENCRYPTION USING MASTER KEY; [\u9519\u8bef]\u00a0\nA)ALTER TABLE t1 SET TDE =\u00a0'ON'; [\u9519\u8bef]\u00a0\n</code></pre> <p>144</p> <pre><code>Choose the best answer.You have configured GTID-based asynchronous replication with one master\u00a0\nand one slave. A user accidentally updated some data on the slave.To fix this, you stopped\u00a0\nreplication and successfully reverted the accidental changes. Examine the current GTID information:\n\uff08\u89c1\u4e0b\u56fe\uff09You must fix GTID sets on the slave to avoid replicating unwanted transactions\u00a0in\u00a0case\u00a0of\u00a0\nfailover. Which\u00a0set\u00a0of actions would allow the slave to\u00a0continue\u00a0replicating without erroneous\u00a0\ntransactions?\u00a0\n\u56fe\u7247\u5730\u5740: https://oss-emcsprod-public.modb.pro/image/exam/question_1640760635659.jpg\u00a0\nE)RESET SLAVE; SET GLOBAL gtid_purged=aaaaaaa-aaa-aaaa-aaa-aaaaaaaa:1-10167; [\u9519\u8bef]\u00a0\nD)SET GLOBAL gtid_purged=aaaaaa-aaa-aaa-aaaa-aaaaaaaa:1-2312, bbbbbb-bbbb-bbbb-bbbb\nbbbbbbbbbb:1-9; SET GLOBAL gtid_executed=aaaaaaa-aaaa-aaaa-aaaa-aaaaaa:1-10167; [\u6b63\u786e]\u00a0\nB)RESET MASTER; SET GLOBAL gtid_purged=aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaa:1-10167; [\u9519\u8bef]\u00a0\nC)RESET SLAVE; SET GLOBAL gtid_purged=aaaaa-aaa-aaaa-aaaa-aaaaaaaa:1-3820; SET GLOBAL\u00a0\ngtid_executed=aaaaaa-aaaa-aaa-aaaa-aaaaaaaaaaa:1-10300; [\u9519\u8bef]\u00a0\nA)RESET MASTER; SET GLOBAL gtid_purged=aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaa:1-2312; SET\u00a0\nGLOBAL gtid_executed=aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaa:1-10167; [\u9519\u8bef]\n</code></pre>"},{"location":"mysql/ocp1/","title":"Ocp1","text":"<p>You are having performance issues with MySQL instances monitored by MySQL Enterprise Monitor. Using Query Analyzer, where do you begin to look for problem queries?</p> <p>A) Look for queries with big prolonged spikes in row activity/access graph in the time series graph. B) Sort the \"Exec\" column and check for SQL queries with high Query Response Time index (QRTi) values. C) Look for queries with low total latency times in the Latency section in the time series graph.    D) Sort the \"Exec\" column and check for SQL queries with low Query Response Time index (QRTi) values.</p> <p>Examine the full path name of the backup image from MySQL Enterprise Backup with the --compress option: /backup/full/mybackup/myimage.img</p> <p>mysqlbackup.cnf contains:</p> <p>[mysqlbackup] backup-dir=/backup/full/myrestore backup-image=/backup/full/mybackup/myimage.img uncompress</p> <p>You must perform a database restore to a new machine. The data directory is /data/MEB. Which command can provision the new database in datadir as /data/MEB?</p> <p>A) mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB restore-and-apply-log B) mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB image-to-dir-and-apply-log C) mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB apply-log-and-copy-back   D) mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB copy-back-and-apply-log E) mysqlbackup --defaults-file=mysqlbackup.cnf --datadir=/data/MEB image-to-dir</p>"},{"location":"mysql/pt/","title":"Pt","text":"<p>pt-query-digest </p> <p>https://docs.percona.com/percona-toolkit</p> \u5de5\u5177\u7c7b\u522b \u5de5\u5177\u547d\u4ee4 \u5de5\u5177\u4f5c\u7528 \u5907\u6ce8 \u5f00\u53d1\u7c7b pt-duplicate-key-checker \u5217\u51fa\u5e76\u5220\u9664\u91cd\u590d\u7684\u7d22\u5f15\u548c\u5916\u952e \u2013 pt-online-schema-change \u5728\u7ebf\u4fee\u6539\u8868\u7ed3\u6784 \u2013 pt-query-advisor \u5206\u6790\u67e5\u8be2\u8bed\u53e5\uff0c\u5e76\u7ed9\u51fa\u5efa\u8bae\uff0c\u6709bug \u5df2\u5e9f\u5f03 pt-show-grants \u89c4\u8303\u5316\u548c\u6253\u5370\u6743\u9650 \u2013 pt-upgrade \u5728\u591a\u4e2a\u670d\u52a1\u5668\u4e0a\u6267\u884c\u67e5\u8be2\uff0c\u5e76\u6bd4\u8f83\u4e0d\u540c \u2013 \u6027\u80fd\u7c7b pt-index-usage \u5206\u6790\u65e5\u5fd7\u4e2d\u7d22\u5f15\u4f7f\u7528\u60c5\u51b5\uff0c\u5e76\u51fa\u62a5\u544a \u2013 pt-pmp \u4e3a\u67e5\u8be2\u7ed3\u679c\u8ddf\u8e2a\uff0c\u5e76\u6c47\u603b\u8ddf\u8e2a\u7ed3\u679c \u2013 pt-visual-explain \u683c\u5f0f\u5316\u6267\u884c\u8ba1\u5212 \u2013 pt-table-usage \u5206\u6790\u65e5\u5fd7\u4e2d\u67e5\u8be2\u5e76\u5206\u6790\u8868\u4f7f\u7528\u60c5\u51b5 pt 2.2\u65b0\u589e\u547d\u4ee4 \u914d\u7f6e\u7c7b pt-config-diff \u6bd4\u8f83\u914d\u7f6e\u6587\u4ef6\u548c\u53c2\u6570 \u2013 pt-mysql-summary \u5bf9mysql\u914d\u7f6e\u548cstatus\u8fdb\u884c\u6c47\u603b \u2013 pt-variable-advisor \u5206\u6790\u53c2\u6570\uff0c\u5e76\u63d0\u51fa\u5efa\u8bae \u2013 \u76d1\u63a7\u7c7b pt-deadlock-logger \u63d0\u53d6\u548c\u8bb0\u5f55mysql\u6b7b\u9501\u4fe1\u606f \u2013 pt-fk-error-logger \u63d0\u53d6\u548c\u8bb0\u5f55\u5916\u952e\u4fe1\u606f \u2013 pt-mext \u5e76\u884c\u67e5\u770bstatus\u6837\u672c\u4fe1\u606f \u2013 pt-query-digest \u5206\u6790\u67e5\u8be2\u65e5\u5fd7\uff0c\u5e76\u4ea7\u751f\u62a5\u544a \u5e38\u7528\u547d\u4ee4 pt-trend \u6309\u7167\u65f6\u95f4\u6bb5\u8bfb\u53d6slow\u65e5\u5fd7\u4fe1\u606f \u5df2\u5e9f\u5f03 \u590d\u5236\u7c7b pt-heartbeat \u76d1\u63a7mysql\u590d\u5236\u5ef6\u8fdf \u2013 pt-slave-delay \u8bbe\u5b9a\u4ece\u843d\u540e\u4e3b\u7684\u65f6\u95f4 \u2013 pt-slave-find \u67e5\u627e\u548c\u6253\u5370\u6240\u6709mysql\u590d\u5236\u5c42\u7ea7\u5173\u7cfb \u2013 pt-slave-restart \u76d1\u63a7salve\u9519\u8bef\uff0c\u5e76\u5c1d\u8bd5\u91cd\u542fsalve \u2013 pt-table-checksum \u6821\u9a8c\u4e3b\u4ece\u590d\u5236\u4e00\u81f4\u6027 \u2013 pt-table-sync \u9ad8\u6548\u540c\u6b65\u8868\u6570\u636e \u2013 \u7cfb\u7edf\u7c7b pt-diskstats \u67e5\u770b\u7cfb\u7edf\u78c1\u76d8\u72b6\u6001 \u2013 pt-fifo-split \u6a21\u62df\u5207\u5272\u6587\u4ef6\u5e76\u8f93\u51fa \u2013 pt-summary \u6536\u96c6\u548c\u663e\u793a\u7cfb\u7edf\u6982\u51b5 \u2013 pt-stalk \u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u6536\u96c6\u8bca\u65ad\u6570\u636e \u2013 pt-sift \u6d4f\u89c8\u7531pt-stalk\u521b\u5efa\u7684\u6587\u4ef6 pt 2.2\u65b0\u589e\u547d\u4ee4 pt-ioprofile \u67e5\u8be2\u8fdb\u7a0bIO\u5e76\u6253\u5370\u4e00\u4e2aIO\u6d3b\u52a8\u8868 pt 2.2\u65b0\u589e\u547d\u4ee4 \u5b9e\u7528\u7c7b pt-archiver \u5c06\u8868\u6570\u636e\u5f52\u6863\u5230\u53e6\u4e00\u4e2a\u8868\u6216\u6587\u4ef6\u4e2d \u2013 pt-find \u67e5\u627e\u8868\u5e76\u6267\u884c\u547d\u4ee4 \u2013 pt-kill Kill\u6389\u7b26\u5408\u6761\u4ef6\u7684sql \u5e38\u7528\u547d\u4ee4 pt-align \u5bf9\u9f50\u5176\u4ed6\u5de5\u5177\u7684\u8f93\u51fa pt 2.2\u65b0\u589e\u547d\u4ee4 pt-fingerprint \u5c06\u67e5\u8be2\u8f6c\u6210\u5bc6\u6587 pt 2.2\u65b0\u589e\u547d\u4ee4"},{"location":"mysql/pt/#pt-align","title":"pt-align \u5217\u5bf9\u9f50","text":""},{"location":"mysql/pt/#pt-archiver","title":"pt-archiver \u5f52\u6863\u8868\u6570\u636e","text":"<p>\u6ce8\u610f\u4e8b\u9879\uff0c --source \u540e\u9762\u7684key=value\uff0c\u76f4\u63a5\u4e0d\u8981\u6709\u7a7a\u683c</p> <pre><code>pt-archiver --source u=xxx,p=xxx,h=xx,P=3306,D=mysql,t=t  \\\n --dest t=t1 \\\n --file '/tmp/archive/%Y-%m-%d-%D.%t'                         \\\n --where \"id&gt;64615 and id &lt; 70000\" --limit 1000 --commit-each --progress 1000 --sleep 1 --statistics\n</code></pre>"},{"location":"mysql/pt/#pt-config-diff","title":"pt-config-diff \u914d\u7f6e\u6587\u4ef6\u6bd4\u8f83","text":"<p>\u4e3b\u4ece\u4e4b\u95f4\uff0c\u6216\u65b0\u65e7\u4e4b\u95f4</p> <pre><code>pt-config-diff  u=xxx,p=xxx,h=xx,P=3306 u=xxx,p=xxx,h=xx,P=3307\n</code></pre>"},{"location":"mysql/pt/#pt-deadlock-logger","title":"pt-deadlock-logger \u6b7b\u9501\u68c0\u6d4b","text":"<p>CREATE TABLE <code>wjqtab1</code> (    <code>id</code> int(11) NOT NULL AUTO_INCREMENT,    <code>a</code> int(11) DEFAULT NULL,    <code>b</code> int(11) DEFAULT NULL,    PRIMARY KEY (<code>id</code>),    KEY <code>idxa</code> (<code>a</code>) ) ENGINE=InnoDB;</p> <p>pt-diskstats \u7c7b\u4f3ciostat</p> <p>\u9700\u8981\u5b89\u88c5\u5728\u670d\u52a1\u7aef</p>"},{"location":"mysql/pt/#pt-duplicate-key-checker","title":"pt-duplicate-key-checker \u7edf\u8ba1\u91cd\u590d\u7d22\u5f15","text":"<p>\u751f\u6210\u7d22\u5f15\u7edf\u8ba1\u8868\uff0c\u5e76\u7ed9\u51fa\u5220\u9664\u91cd\u590d\u7d22\u5f15\u5efa\u8bae\u7684sql</p>"},{"location":"mysql/pt/#pt-index-usage","title":"pt-index-usage \u901a\u8fc7(\u6162)\u67e5\u8be2\u65e5\u5fd7\u5206\u6790\u7d22\u5f15\u4f7f\u7528\u60c5\u51b5","text":""},{"location":"mysql/replication/","title":"\u4e3b\u4ece\u590d\u5236","text":""},{"location":"mysql/replication/#binary-log-file-position-based-replication","title":"Binary Log File Position Based Replication","text":"<ul> <li>source \u4e3b\u5e93</li> <li>replica \u4ece\u5e93</li> </ul> <p>\u652f\u6301\u6839\u636e\u9700\u6c42\u590d\u5236\u6307\u5b9adbs\u6216tables, \u6ce8\u610f\u5728replica\u7aef\u8bbe\u7f6e</p>"},{"location":"mysql/replication/#_2","title":"\u524d\u671f\u51c6\u5907","text":"<pre><code>server_id #  unique ID\n## \u4ee5\u4e0b\u4e0e\u4e3b\u4ece\u76f8\u5173\u7684\u9ed8\u8ba4\u503c\nlog_bin= ON\ninnodb_flush_log_at_trx_commit=1\nsync_binlog=1\nskip_networking=OFF\n\n## replica \u7ea7\u8054\u590d\u5236\nlog_replica_updates=ON\nlog_slave_updates=ON \n</code></pre>"},{"location":"mysql/replication/#_3","title":"\u590d\u5236\u7528\u6237","text":"<p>\u590d\u5236\u7528\u6237\u9700\u8981\u6743\u9650 <code>REPLICATION SLAVE</code></p> <p>\u63d0\u793a: \u590d\u5236\u7528\u6237\u5bc6\u7801\u4f1a\u660e\u6587\u5b58\u653e\u5728 mysql.slave_master_info \u4e2d\u3002</p> <pre><code>mysql&gt; CREATE USER 'repl'@'%.example.com' IDENTIFIED BY 'password';\nmysql&gt; GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%.example.com';\n</code></pre> <p>\u63d0\u793a: caching_sha2_password \u9ed8\u8ba4\u52a0\u5bc6\u65b9\u5f0f\uff0c\u9700\u8981\u52a0\u5bc6\u65b9\u5f0f\u8fde\u63a5\u3002</p>"},{"location":"mysql/replication/#file-position","title":"File Position","text":"<p>source </p> <pre><code>-- \u7981\u6b62\u5199\u5165\nmysql&gt;  FLUSH TABLES WITH READ LOCK;\n-- \u83b7\u53d6\u4f4d\u7f6e\u4fe1\u606f\nmysql&gt; SHOW MASTER STATUS\\G\n</code></pre>"},{"location":"mysql/replication/#_4","title":"\u62f7\u8d1d\u6570\u636e","text":"<p>\u5982\u679csource \u4e2d\u6709\u6570\u636e - mysqldump - clone - xtrabackup</p> <p>https://www.modb.pro/db/49521</p>"},{"location":"mysql/replication/#_5","title":"\u914d\u7f6e\u4e3b\u4ece","text":"<pre><code>mysql&gt; UNLOCK TABLES;\n</code></pre> <pre><code>mysql&gt; CHANGE MASTER TO\n    -&gt;     MASTER_HOST='source_host_name',\n    -&gt;     MASTER_USER='replication_user_name',\n    -&gt;     MASTER_PASSWORD='replication_password',\n    -&gt;     MASTER_LOG_FILE='recorded_log_file_name',\n    -&gt;     MASTER_LOG_POS=recorded_log_position;\n\nOr from MySQL 8.0.23:\nmysql&gt; CHANGE REPLICATION SOURCE TO\n    -&gt;     SOURCE_HOST='source_host_name',\n    -&gt;     SOURCE_USER='replication_user_name',\n    -&gt;     SOURCE_PASSWORD='replication_password',\n    -&gt;     SOURCE_LOG_FILE='recorded_log_file_name',\n    -&gt;     SOURCE_LOG_POS=recorded_log_position;\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879: event_scheduler</p> <p>skip_slave_start</p> <pre><code>select * from  mysql.slave_relay_log_info\\G;\n</code></pre> <pre><code>select * from mysql.slave_master_info\\G;\n</code></pre>"},{"location":"mysql/replication/#gtid","title":"\u57fa\u4e8e gtid","text":"<pre><code>server_id \n</code></pre> <pre><code>log_bin=ON\nbinlog_format=ROW\ngtid_mode=ON\nenforce-gtid-consistency=ON\nlog_slave_updates\nsuper_read_on=on\n\n````\n\nmysql_native_password\n\n</code></pre> <p>CREATE USER 'replica_user'@'%' IDENTIFIED BY 'replica_user'; GRANT REPLICATION SLAVE ON . TO 'replica_user'@'%'</p> <pre><code>\nclone \n\n</code></pre> <p>CHANGE MASTER TO MASTER_HOST = 10.1.40.84, MASTER_PORT = 3306, MASTER_USER = , MASTER_PASSWORD = password, MASTER_AUTO_POSITION = 1; Or from MySQL 8.0.22: CHANGE REPLICATION SOURCE TO SOURCE_HOST = '10.1.40.84', SOURCE_PORT = 3306,SOURCE_USER = 'replica_user',SOURCE_PASSWORD = 'replica_user', SOURCE_AUTO_POSITION = 1;</p> <pre><code>\n</code></pre> <p>mysql&gt; START SLAVE; Or from MySQL 8.0.22: mysql&gt; START REPLICA; ```</p> <p>\u4e3b\u4ece\u5207\u6362</p> <p>reset relaylog</p> <p>\u8fc7\u6ee4\u5907\u4efd\u65b0\u589e\u6570\u636e\u5e93  https://mp.weixin.qq.com/s/VnTrFfgiXBzl07CrczyMGQ</p>"},{"location":"mysql/table_size/","title":"Table size","text":"<p>SELECT      table_name AS <code>\u8868\u540d</code>,     ROUND((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024 / 1024, 2) AS <code>\u8868\u5927\u5c0f(GB)</code>,     ROUND(DATA_FREE / 1024 / 1024 / 1024, 2) AS <code>\u788e\u7247/\u672a\u91ca\u653e\u7a7a\u95f4(GB)</code> FROM information_schema.TABLES WHERE      table_name = 'live_data_file_increment_4_4'     AND table_schema = DATABASE();</p> <p>SELECT EVENT_NAME, WORK_COMPLETED, WORK_ESTIMATED  FROM performance_schema.events_stages_current  WHERE EVENT_NAME LIKE '%alter%'</p> <p>SHOW VARIABLES LIKE 'innodb_buffer_pool_size'; SHOW VARIABLES LIKE 'key_buffer_size'; SHOW VARIABLES LIKE 'max_connections'; -- \u6700\u5927\u8fde\u63a5\u6570\uff08\u8fc7\u9ad8\u4f1a\u5bfc\u81f4\u7ebf\u7a0b\u5185\u5b58\u7d2f\u79ef\uff09 SHOW VARIABLES LIKE 'tmp_table_size';  -- \u5185\u5b58\u4e34\u65f6\u8868\u4e0a\u9650</p> <p>SELECT (@@read_buffer_size + @@sort_buffer_size + @@join_buffer_size) / (1024 * 1024) AS per_thread_mb;</p> <p>SELECT (@@read_buffer_size + @@sort_buffer_size + @@join_buffer_size) / (1024 * 1024) AS per_thread_mb; SHOW GLOBAL STATUS LIKE 'Threads_running';       -- \u6d3b\u8dc3\u7ebf\u7a0b\u6570</p> <p>-- \u663e\u793a\u5360\u7528\u6700\u9ad8\u7684\u6a21\u5757\uff08\u5982InnoDB\u7f13\u51b2\u6c60\u3001\u4e34\u65f6\u8868\uff09</p> <pre><code>SELECT event_name, current_alloc \nFROM sys.memory_global_by_current_bytes \nLIMIT 20;\n</code></pre> <pre><code>select sys.format_bytes(SUM(current_alloc)) FROM sys.x$memory_global_by_current_bytes;\n</code></pre> <p>\u5404\u4e2a\u6a21\u5757\u7684\u5206\u522b\u5360\u7528\u7684\u5185\u5b58</p> <pre><code>SELECT SUBSTRING_INDEX(event_name,'/', 2 ) AS\n       code_area, sys.format_bytes(SUM(current_alloc))\n       AS current_alloc\n       FROM sys.x$memory_global_by_current_bytes\n       GROUP BY SUBSTRING_INDEX(event_name,'/', 2 )\n       ORDER BY SUM(current_alloc) DESC;\n</code></pre> <p>\u76d1\u63a7InnoDB\u7f13\u51b2\u6c60\u5229\u7528\u7387\uff1a SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_pages%';</p> <p>SET GLOBAL innodb_buffer_pool_size = </p> <p>\u8fde\u63a5\u5360\u7528\u7684\u5185\u5b58 https://mp.weixin.qq.com/s?__biz=MjM5NzAzMTY4NQ==&amp;mid=2653939777&amp;idx=1&amp;sn=da6b97b8d302b0b910fa52147e0f6854&amp;chksm=bd3b722b8a4cfb3d3e974909558b805ca7200ddaeeefc0b8b04a5562543202a0df40b7d4365e#rd</p> <p>pmap -x $(pgrep mysqld) | grep -i \"anon\" | sort -nrk3 </p> <p>\u67e5\u770b database size</p> <p>selectname,FILE_SIZE/1024/1024/1024as\u00a0 GB\u00a0from\u00a0information_schema.INNODB_TABLESPACES\u00a0wherename='test/t1';</p> <p>SELECT  table_schema as '\u6570\u636e\u5e93', sum(table_rows) as '\u8bb0\u5f55\u6570', sum(truncate(data_length/1024/1024, 2)) as '\u6570\u636e\u5bb9\u91cf(MB)', sum(truncate(index_length/1024/1024, 2)) as '\u7d22\u5f15\u5bb9\u91cf(MB)', sum(truncate(DATA_FREE/1024/1024, 2)) as '\u788e\u7247\u5360\u7528(MB)' from information_schema.tables group by table_schema order by sum(data_length) desc, sum(index_length) desc;</p> <p>\u67e5\u770b table size </p> <p>SELECT  table_name AS <code>\u8868\u540d</code>,  ROUND((DATA_LENGTH) / 1024 / 1024 / 1024, 2) AS <code>\u8868\u5927\u5c0f(GB)</code>,  ROUND((INDEX_LENGTH) / 1024 / 1024 / 1024, 2) AS <code>\u7d22\u5f15\u5927\u5c0f(GB)</code>,     ROUND(DATA_FREE / 1024 / 1024 / 1024, 2) AS <code>\u788e\u7247/\u672a\u91ca\u653e\u7a7a\u95f4(GB)</code> FROM information_schema.TABLES where   table_schema = DATABASE();</p> <p>\u67e5\u770b optimize table \u4e8b\u4ef6</p> <p>SELECT EVENT_NAME, WORK_COMPLETED, WORK_ESTIMATED FROM performance_schema.events_stages_current;</p> <p>optimize table xx \u540e\u67e5\u770b\u8fdb\u5ea6  SELECT   EVENT_NAME,   WORK_COMPLETED,   WORK_ESTIMATED FROM performance_schema.events_stages_current WHERE EVENT_NAME LIKE 'stage/innodb/alter%';</p> <p>SELECT * FROM sys.innodb_lock_waits\\G</p>"},{"location":"mysql/users/","title":"\u7528\u6237\u7ba1\u7406","text":""},{"location":"mysql/users/#_2","title":"\u7528\u6237\u67e5\u770b","text":"<pre><code>select * from mysql.user where user = 'root'\\G;\nHost: localhost\n                    User: root\n             Select_priv: Y\n             Insert_priv: Y\n             Update_priv: Y\n             Delete_priv: Y\n             Create_priv: Y\n               Drop_priv: Y\n             Reload_priv: Y\n           Shutdown_priv: Y\n            Process_priv: Y\n               File_priv: Y\n              Grant_priv: Y\n         References_priv: Y\n              Index_priv: Y\n              Alter_priv: Y\n            Show_db_priv: Y\n              Super_priv: Y\n   Create_tmp_table_priv: Y\n        Lock_tables_priv: Y\n            Execute_priv: Y\n         Repl_slave_priv: Y\n        Repl_client_priv: Y\n        Create_view_priv: Y\n          Show_view_priv: Y\n     Create_routine_priv: Y\n      Alter_routine_priv: Y\n        Create_user_priv: Y\n              Event_priv: Y\n            Trigger_priv: Y\n  Create_tablespace_priv: Y\n                ssl_type: \n              ssl_cipher: 0x\n             x509_issuer: 0x\n            x509_subject: 0x\n           max_questions: 0\n             max_updates: 0\n         max_connections: 0\n    max_user_connections: 0\n                  plugin: auth_socket\n   authentication_string: \n        password_expired: N\n   password_last_changed: 2024-11-12 11:15:54\n       password_lifetime: NULL\n          account_locked: N\n        Create_role_priv: Y\n          Drop_role_priv: Y\n  Password_reuse_history: NULL\n     Password_reuse_time: NULL\nPassword_require_current: NULL\n         User_attributes: NULL\n\n</code></pre>"},{"location":"mysql/users/#auth_socket","title":"auth_socket \u9a8c\u8bc1\u63d2\u4ef6\u7684\u4f7f\u7528\u573a\u666f","text":"<p>\u9a8c\u8bc1\u65b9\u5f0f\u6709\u4ee5\u4e0b\u7279\u70b9\uff1a</p> <pre><code>\u9996\u5148\uff0c\u8fd9\u79cd\u9a8c\u8bc1\u65b9\u5f0f\u4e0d\u8981\u6c42\u8f93\u5165\u5bc6\u7801\uff0c\u5373\u4f7f\u8f93\u5165\u4e86\u5bc6\u7801\u4e5f\u4e0d\u9a8c\u8bc1\u3002\u8fd9\u4e2a\u7279\u70b9\u8ba9\u5f88\u591a\u4eba\u89c9\u5f97\u5f88\u4e0d\u5b89\u5168\uff0c\u5b9e\u9645\u4ed4\u7ec6\u7814\u7a76\u4e00\u4e0b\u8fd9\u79cd\u65b9\u5f0f\uff0c\u53d1\u73b0\u8fd8\u662f\u76f8\u5f53\u5b89\u5168\u7684\uff0c\u56e0\u4e3a\u5b83\u6709\u53e6\u5916\u4e24\u4e2a\u9650\u5236\uff1b\n\u53ea\u80fd\u7528 UNIX \u7684 socket \u65b9\u5f0f\u767b\u9646\uff0c\u8fd9\u5c31\u4fdd\u8bc1\u4e86\u53ea\u80fd\u672c\u5730\u767b\u9646\uff0c\u7528\u6237\u5728\u4f7f\u7528\u8fd9\u79cd\u767b\u9646\u65b9\u5f0f\u65f6\u5df2\u7ecf\u901a\u8fc7\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684\u5b89\u5168\u9a8c\u8bc1\uff1b\n\u64cd\u4f5c\u7cfb\u7edf\u7684\u7528\u6237\u548c MySQL \u6570\u636e\u5e93\u7684\u7528\u6237\u540d\u5fc5\u987b\u4e00\u81f4\uff0c\u4f8b\u5982\u4f60\u8981\u767b\u9646 MySQL \u7684 root \u7528\u6237\uff0c\u5fc5\u987b\u7528\u64cd\u4f5c\u7cfb\u7edf\u7684 root \u7528\u6237\u767b\u9646\u3002\n</code></pre> <p>auth_socket \u8fd9\u4e2a\u63d2\u4ef6\u56e0\u4e3a\u6709\u8fd9\u4e9b\u7279\u70b9\uff0c\u5b83\u5f88\u9002\u5408\u6211\u4eec\u5728\u7cfb\u7edf\u6295\u4ea7\u524d\u8fdb\u884c\u5b89\u88c5\u8c03\u8bd5\u7684\u65f6\u5019\u4f7f\u7528\uff0c\u800c\u4e14\u4e5f\u6709\u76f8\u5f53\u7684\u5b89\u5168\u6027\uff0c\u56e0\u4e3a\u7cfb\u7edf\u6295\u4ea7\u524d\u901a\u5e38\u7ecf\u5e38\u540c\u65f6\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u7684 root \u7528\u6237\u548c MySQL \u7684 root \u7528\u6237\u3002\u5f53\u6211\u4eec\u5728\u7cfb\u7edf\u6295\u4ea7\u540e\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684 root \u7528\u6237\u548c MySQL \u7684 root \u7528\u6237\u5c31\u4e0d\u80fd\u968f\u4fbf\u4f7f\u7528\u4e86\uff0c\u8fd9\u65f6\u53ef\u4ee5\u6362\u6210\u5176\u5b83\u7684\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u5207\u6362\uff1a</p> <p>ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY 'test';</p>"},{"location":"mysql/users/#caching_sha2_password","title":"caching_sha2_password","text":"<p>\u4ece MySQL 8.0.4 \u5f00\u59cb\uff0cMySQL \u9ed8\u8ba4\u8eab\u4efd\u9a8c\u8bc1\u63d2\u4ef6\u4ece mysql_native_password \u6539\u4e3a caching_sha2_password</p>"},{"location":"mysql/users/#_3","title":"\u521b\u5efa\u7528\u6237","text":"<pre><code>CREATE USER 'myuser'@'%' IDENTIFIED WITH caching_sha2_password  BY 'mypassword';\nGRANT ALL ON *.* TO 'myuser'@'%';\nFLUSH PRIVILEGES;\n</code></pre> <p>'myuser'@'%' \u7528\u6237\u540d@IP \u7ec4\u6210\u7528\u6237\u7684\u552f\u4e00\u6807\u8bc6\u3002\u5373\u4f7f\u7528\u6237\u540d\u76f8\u540c\uff0c\u5982\u679cip\u4e0d\u540c\u4ee3\u8868\u4e24\u4e2a\u4e0d\u540c\u7684\u7528\u6237</p>"},{"location":"mysql/users/#_4","title":"\u4fee\u6539\u5bc6\u7801","text":"<pre><code>ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY 'pwd';\nflush privileges;\n</code></pre>"},{"location":"mysql/users/#_5","title":"\u67e5\u770b\u7528\u6237\u6743\u9650","text":"<pre><code>SHOW GRANTS FOR 'myuser'@'%';\n</code></pre>"},{"location":"mysql/users/#ssl","title":"ssl \u8bbf\u95ee","text":"<pre><code>-- \u67e5\u770b\u6570\u636e\u5e93\u670d\u52a1\u662f\u5426\u652f\u6301ssl\nshow variables like '%have%ssl%';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| have_openssl  | YES   |\n| have_ssl      | YES   |\n+---------------+-------+\n-- \u521b\u5efa\u7528\u6237\nCREATE USER 'myssluser'@'%' IDENTIFIED BY 'mysslpassword';\nGRANT ALL ON *.* TO 'myssluser'@'%';\nALTER USER 'myssluser'@'%' REQUIRE SSL;\nFLUSH PRIVILEGES;\nSELECT ssl_type From mysql.user Where user='myssluser';\n-- \u666e\u901a\u767b\u5f55\u5931\u8d25\n$ mysql -umyssluser -p\nEnter password: \nERROR 1045 (28000): Access denied for user 'myssluser'@'xxxxx' (using password: YES)\n-- \u4f7f\u7528ssl\u767b\u5f55\n$ mysql --ssl-mode=REQUIRED  -u myssluser -p\n</code></pre>"},{"location":"mysql/variables2ali/","title":"Variables2ali","text":"<p>Variable_name,Value \"activate_all_roles_on_login\",\"OFF\" \"admin_address\",\"\" \"admin_port\",\"33062\" \"admin_ssl_ca\",\"\" \"admin_ssl_capath\",\"\" \"admin_ssl_cert\",\"\" \"admin_ssl_cipher\",\"\" \"admin_ssl_crl\",\"\" \"admin_ssl_crlpath\",\"\" \"admin_ssl_key\",\"\" \"admin_tls_ciphersuites\",\"\" \"admin_tls_version\",\"TLSv1,TLSv1.1,TLSv1.2,TLSv1.3\" \"async_binlog_recovery\",\"ON\" \"authentication_policy\",\",,\" \"auto_detect_certs\",\"OFF\" \"auto_generate_certs\",\"OFF\" \"auto_increment_increment\",\"1\" \"auto_increment_key_high_priority\",\"ON\" \"auto_increment_offset\",\"1\" \"autocommit\",\"ON\" \"automatic_sp_privileges\",\"ON\" \"avoid_temporal_upgrade\",\"OFF\" \"back_log\",\"3000\" \"basedir\",\"/u01/mysql/\" \"big_tables\",\"OFF\" \"bind_address\",\"\" \"binlog_buffer_size\",\"20971520\" \"binlog_cache_free_flush\",\"ON\" \"binlog_cache_free_flush_limit_size\",\"268435456\" \"binlog_cache_size\",\"1048576\" \"binlog_checksum\",\"CRC32\" \"binlog_direct_non_transactional_updates\",\"OFF\" \"binlog_encryption\",\"OFF\" \"binlog_error_action\",\"ABORT_SERVER\" \"binlog_expire_logs_auto_purge\",\"ON\" \"binlog_expire_logs_seconds\",\"2592000\" \"binlog_format\",\"ROW\" \"binlog_group_commit_sync_delay\",\"0\" \"binlog_group_commit_sync_no_delay_count\",\"0\" \"binlog_group_delay\",\"100\" \"binlog_group_delay_running_threads\",\"100\" \"binlog_gtid_simple_recovery\",\"ON\" \"binlog_max_flush_queue_time\",\"0\" \"binlog_order_commits\",\"OFF\" \"binlog_parallel_flush\",\"OFF\" \"binlog_rotate_encryption_master_key_at_startup\",\"OFF\" \"binlog_row_event_max_size\",\"8192\" \"binlog_row_image\",\"FULL\" \"binlog_row_metadata\",\"MINIMAL\" \"binlog_row_value_options\",\"\" \"binlog_rows_query_log_events\",\"OFF\" \"binlog_stmt_cache_size\",\"32768\" \"binlog_transaction_compression\",\"OFF\" \"binlog_transaction_compression_level_zstd\",\"3\" \"binlog_transaction_dependency_history_size\",\"500000\" \"binlog_transaction_dependency_tracking\",\"WRITESET\" \"block_encryption_mode\",\"aes-128-ecb\" \"build_id\",\"912f3601b14fe596a21fa1ff4b2a663279ccb830\" \"bulk_insert_buffer_size\",\"4194304\" \"caching_sha2_password_auto_generate_rsa_keys\",\"ON\" \"caching_sha2_password_digest_rounds\",\"5000\" \"caching_sha2_password_private_key_path\",\"private_key.pem\" \"caching_sha2_password_public_key_path\",\"public_key.pem\" \"ccl_max_waiting_count\",\"0\" \"ccl_queue_bucket_count\",\"4\" \"ccl_queue_bucket_size\",\"64\" \"ccl_queue_hot_delete\",\"OFF\" \"ccl_queue_hot_update\",\"OFF\" \"ccl_restrict_super_user\",\"OFF\" \"ccl_wait_timeout\",\"86400\" \"character_set_client\",\"utf8mb4\" \"character_set_connection\",\"utf8mb4\" \"character_set_database\",\"utf8mb3\" \"character_set_filesystem\",\"binary\" \"character_set_results\",\"utf8mb4\" \"character_set_server\",\"utf8mb3\" \"character_set_system\",\"utf8mb3\" \"character_sets_dir\",\"/u01/mysql/share/charsets/\" \"check_proxy_users\",\"OFF\" \"clear_log_file_pagecache\",\"OFF\" \"client_endpoint_ip\",\"\" \"collation_connection\",\"utf8mb4_0900_ai_ci\" \"collation_database\",\"utf8mb3_general_ci\" \"collation_server\",\"utf8mb3_general_ci\" \"completion_type\",\"NO_CHAIN\" \"concurrent_insert\",\"AUTO\" \"connect_timeout\",\"10\" \"connection_memory_chunk_size\",\"8192\" \"connection_memory_limit\",\"18446744073709551615\" \"core_file\",\"ON\" \"crash_sql_stmt_max_length\",\"2048\" \"create_admin_listener_thread\",\"OFF\" \"cte_max_recursion_depth\",\"1000\" \"datadir\",\"/home/mysql/data/dbs/\" \"default_authentication_plugin\",\"mysql_native_password\" \"default_collation_for_utf8mb4\",\"utf8mb4_0900_ai_ci\" \"default_password_lifetime\",\"0\" \"default_storage_engine\",\"InnoDB\" \"default_table_encryption\",\"OFF\" \"default_tmp_storage_engine\",\"InnoDB\" \"default_week_format\",\"0\" \"delay_key_write\",\"ON\" \"delayed_insert_limit\",\"100\" \"delayed_insert_timeout\",\"300\" \"delayed_queue_size\",\"1000\" \"disabled_storage_engines\",\"MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY,XENGINE\" \"disconnect_on_expired_password\",\"ON\" \"div_precision_increment\",\"4\" \"enable_gtid_prefetch\",\"OFF\" \"encdb\",\"OFF\" \"encdb_driver_connection\",\"OFF\" \"encdb_kms_agent_cmd\",\"/home/mysql/kms_agent\" \"end_markers_in_json\",\"OFF\" \"enforce_gtid_consistency\",\"ON\" \"eq_range_index_dive_limit\",\"100\" \"error_count\",\"0\" \"event_scheduler\",\"ON\" \"expire_logs_days\",\"0\" \"explain_format\",\"TRADITIONAL\" \"explicit_defaults_for_timestamp\",\"OFF\" \"external_user\",\"\" \"fetch_raw_tablespace_at_startup\",\"ON\" \"flush\",\"OFF\" \"flush_time\",\"0\" \"force_memory_to_innodb\",\"OFF\" \"force_myisam_to_innodb\",\"OFF\" \"foreign_key_checks\",\"ON\" \"ft_boolean_syntax\",\"+ -&gt;&lt;()~:\"\"\"\"&amp;|\" \"ft_max_word_len\",\"84\" \"ft_min_word_len\",\"4\" \"ft_query_expansion_limit\",\"20\" \"ft_stopword_file\",\"(built-in)\" \"general_log\",\"OFF\" \"general_log_file\",\"/home/mysql/data/dbs/i-bp19seygk5m1avgf27u1.log\" \"generated_random_password_length\",\"20\" \"global_connection_memory_limit\",\"18446744073709551615\" \"global_connection_memory_tracking\",\"OFF\" \"group_concat_max_len\",\"1024\" \"group_replication_advertise_recovery_endpoints\",\"DEFAULT\" \"group_replication_allow_local_lower_version_join\",\"OFF\" \"group_replication_auto_increment_increment\",\"7\" \"group_replication_autorejoin_tries\",\"3\" \"group_replication_bootstrap_group\",\"OFF\" \"group_replication_certification_info_reserve_size\",\"500000\" \"group_replication_clone_threshold\",\"9223372036854775807\" \"group_replication_communication_debug_options\",\"GCS_DEBUG_NONE\" \"group_replication_communication_max_message_size\",\"10485760\" \"group_replication_communication_stack\",\"MYSQL\" \"group_replication_components_stop_timeout\",\"300\" \"group_replication_compression_threshold\",\"1000000\" \"group_replication_consistency\",\"BEFORE_ON_PRIMARY_FAILOVER\" \"group_replication_enforce_update_everywhere_checks\",\"OFF\" \"group_replication_exit_state_action\",\"READ_ONLY\" \"group_replication_flow_control_applier_threshold\",\"25000\" \"group_replication_flow_control_certifier_threshold\",\"25000\" \"group_replication_flow_control_hold_percent\",\"10\" \"group_replication_flow_control_max_quota\",\"0\" \"group_replication_flow_control_member_quota_percent\",\"0\" \"group_replication_flow_control_min_quota\",\"0\" \"group_replication_flow_control_min_recovery_quota\",\"0\" \"group_replication_flow_control_mode\",\"DISABLED\" \"group_replication_flow_control_period\",\"1\" \"group_replication_flow_control_release_percent\",\"50\" \"group_replication_force_clear_certification_info\",\"ON\" \"group_replication_force_members\",\"\" \"group_replication_group_name\",\"08365201-4f1e-3249-8e01-2e21deca3e67\" \"group_replication_group_seeds\",\"21.4.0.97:3042,21.4.2.159:3000,20.5.7.127:3007\" \"group_replication_gtid_assignment_block_size\",\"1000000\" \"group_replication_ip_allowlist\",\"AUTOMATIC\" \"group_replication_ip_whitelist\",\"AUTOMATIC\" \"group_replication_local_address\",\"21.4.0.97:3042\" \"group_replication_member_expel_timeout\",\"0\" \"group_replication_member_weight\",\"50\" \"group_replication_message_cache_size\",\"1073741824\" \"group_replication_paxos_single_leader\",\"ON\" \"group_replication_poll_spin_loops\",\"0\" \"group_replication_recovery_complete_at\",\"TRANSACTIONS_APPLIED\" \"group_replication_recovery_compression_algorithms\",\"uncompressed\" \"group_replication_recovery_get_public_key\",\"OFF\" \"group_replication_recovery_public_key_path\",\"\" \"group_replication_recovery_reconnect_interval\",\"60\" \"group_replication_recovery_retry_count\",\"10\" \"group_replication_recovery_ssl_ca\",\"\" \"group_replication_recovery_ssl_capath\",\"\" \"group_replication_recovery_ssl_cert\",\"\" \"group_replication_recovery_ssl_cipher\",\"\" \"group_replication_recovery_ssl_crl\",\"\" \"group_replication_recovery_ssl_crlpath\",\"\" \"group_replication_recovery_ssl_key\",\"\" \"group_replication_recovery_ssl_verify_server_cert\",\"OFF\" \"group_replication_recovery_tls_ciphersuites\",\"\" \"group_replication_recovery_tls_version\",\"TLSv1,TLSv1.1,TLSv1.2,TLSv1.3\" \"group_replication_recovery_use_ssl\",\"OFF\" \"group_replication_recovery_zstd_compression_level\",\"3\" \"group_replication_single_primary_mode\",\"ON\" \"group_replication_ssl_mode\",\"DISABLED\" \"group_replication_start_on_boot\",\"OFF\" \"group_replication_start_on_boot_delay\",\"5000\" \"group_replication_tls_source\",\"MYSQL_MAIN\" \"group_replication_transaction_size_limit\",\"150000000\" \"group_replication_unreachable_majority_timeout\",\"0\" \"group_replication_view_change_uuid\",\"AUTOMATIC\" \"gtid_executed\",\"08365201-4f1e-3249-8e01-2e21deca3e67:1-20451156,\\n74f8c1c7-39d5-11f0-8363-00163e0dfaf9:1-228211,\\n75ab9019-39d5-11f0-b040-00163e1d621b:1-9149,\\n93c7a266-39d5-11f0-a8a2-00163e238152:1-278\" \"gtid_executed_compression_period\",\"0\" \"gtid_mode\",\"ON\" \"gtid_next\",\"AUTOMATIC\" \"gtid_owned\",\"\" \"gtid_prefetch_step\",\"50000\" \"gtid_purged\",\"08365201-4f1e-3249-8e01-2e21deca3e67:1-19493906,\\n74f8c1c7-39d5-11f0-8363-00163e0dfaf9:1-228211,\\n75ab9019-39d5-11f0-b040-00163e1d621b:1-9149,\\n93c7a266-39d5-11f0-a8a2-00163e238152:1-278\" \"have_compress\",\"YES\" \"have_dynamic_loading\",\"YES\" \"have_geometry\",\"YES\" \"have_openssl\",\"YES\" \"have_profiling\",\"YES\" \"have_query_cache\",\"NO\" \"have_rtree_keys\",\"YES\" \"have_ssl\",\"YES\" \"have_statement_timeout\",\"YES\" \"have_symlink\",\"DISABLED\" \"histogram_generation_max_mem_size\",\"20000000\" \"host_cache_size\",\"644\" \"hostname\",\"i-bp19seygk5m1avgf27u1\" \"identity\",\"0\" \"ignore_index_hint_error\",\"OFF\" \"immediate_server_version\",\"999999\" \"implicit_primary_key\",\"ON\" \"information_schema_stats_expiry\",\"86400\" \"init_connect\",\"\" \"init_file\",\"\" \"init_replica\",\"\" \"init_slave\",\"\" \"inner_schema_list\",\"\" \"inner_user_list\",\"\" \"innodb_adaptive_flushing\",\"ON\" \"innodb_adaptive_flushing_lwm\",\"10\" \"innodb_adaptive_hash_index\",\"OFF\" \"innodb_adaptive_hash_index_parts\",\"8\" \"innodb_adaptive_max_sleep_delay\",\"150000\" \"innodb_api_bk_commit_interval\",\"5\" \"innodb_api_disable_rowlock\",\"OFF\" \"innodb_api_enable_binlog\",\"OFF\" \"innodb_api_enable_mdl\",\"OFF\" \"innodb_api_trx_level\",\"0\" \"innodb_autoextend_increment\",\"64\" \"innodb_autoinc_lock_mode\",\"2\" \"innodb_buffer_pool_chunk_size\",\"33554432\" \"innodb_buffer_pool_dump_at_shutdown\",\"ON\" \"innodb_buffer_pool_dump_now\",\"OFF\" \"innodb_buffer_pool_dump_pct\",\"25\" \"innodb_buffer_pool_extension\",\"OFF\" \"innodb_buffer_pool_extension_aio_read\",\"ON\" \"innodb_buffer_pool_extension_chunk_size\",\"33554432\" \"innodb_buffer_pool_extension_clock_scans\",\"10\" \"innodb_buffer_pool_extension_dir\",\"\" \"innodb_buffer_pool_extension_flush_dirty\",\"ON\" \"innodb_buffer_pool_extension_io_read_capacity\",\"0\" \"innodb_buffer_pool_extension_io_write_capacity\",\"0\" \"innodb_buffer_pool_extension_read\",\"ON\" \"innodb_buffer_pool_extension_size\",\"268435456\" \"innodb_buffer_pool_filename\",\"ib_buffer_pool\" \"innodb_buffer_pool_in_core_file\",\"OFF\" \"innodb_buffer_pool_init_optimize\",\"ON\" \"innodb_buffer_pool_instances\",\"8\" \"innodb_buffer_pool_load_abort\",\"OFF\" \"innodb_buffer_pool_load_at_startup\",\"ON\" \"innodb_buffer_pool_load_now\",\"OFF\" \"innodb_buffer_pool_resize_cancel\",\"OFF\" \"innodb_buffer_pool_size\",\"6442450944\" \"innodb_change_buffer_max_size\",\"25\" \"innodb_change_buffering\",\"none\" \"innodb_checksum_algorithm\",\"crc32\" \"innodb_cmp_per_index_enabled\",\"OFF\" \"innodb_commit_concurrency\",\"0\" \"innodb_compression_failure_threshold_pct\",\"5\" \"innodb_compression_level\",\"6\" \"innodb_compression_pad_pct_max\",\"50\" \"innodb_concurrency_tickets\",\"5000\" \"innodb_control_index_page_reserve\",\"ON\" \"innodb_data_file_path\",\"ibdata1:200M:autoextend\" \"innodb_data_file_purge\",\"ON\" \"innodb_data_file_purge_all_at_shutdown\",\"OFF\" \"innodb_data_file_purge_dir\",\"\" \"innodb_data_file_purge_immediate\",\"OFF\" \"innodb_data_file_purge_interval\",\"100\" \"innodb_data_file_purge_max_size\",\"128\" \"innodb_data_file_xattr_enabled\",\"ON\" \"innodb_data_file_xattr_remove\",\"OFF\" \"innodb_data_home_dir\",\"/home/mysql/data/mysql\" \"innodb_ddl_buffer_size\",\"1048576\" \"innodb_ddl_threads\",\"4\" \"innodb_deadlock_detect\",\"ON\" \"innodb_dedicated_server\",\"OFF\" \"innodb_default_row_format\",\"dynamic\" \"innodb_dg_arch_dir\",\"./#orl_archive/\" \"innodb_dg_arch_file_flush_interval\",\"16777216\" \"innodb_dg_arch_file_size\",\"536870912\" \"innodb_dg_arch_io_merge_size\",\"4096\" \"innodb_dg_redo_timestamp_interval\",\"500\" \"innodb_directories\",\"\" \"innodb_disable_sort_file_cache\",\"OFF\"  \"innodb_doublewrite\",\"OFF\" \"innodb_doublewrite_batch_size\",\"0\" \"innodb_doublewrite_dir\",\"\" \"innodb_doublewrite_files\",\"0\" \"innodb_doublewrite_pages\",\"64\" \"innodb_encrypt_algorithm\",\"aes_256_cbc\" \"innodb_extend_and_initialize\",\"ON\" \"innodb_fast_shutdown\",\"1\" \"innodb_faster_lru_scan\",\"OFF\" \"innodb_fatal_semaphore_wait_threshold\",\"600\" \"innodb_file_per_table\",\"ON\" \"innodb_fill_factor\",\"100\" \"innodb_flush_log_at_timeout\",\"1\" \"innodb_flush_log_at_trx_commit\",\"1\" \"innodb_flush_method\",\"O_DIRECT\" \"innodb_flush_neighbors\",\"0\" \"innodb_flush_sync\",\"ON\" \"innodb_flushing_avg_loops\",\"30\" \"innodb_force_load_corrupted\",\"OFF\" \"innodb_force_recovery\",\"0\" \"innodb_fsync_threshold\",\"0\" \"innodb_ft_aux_table\",\"\" \"innodb_ft_cache_size\",\"8000000\" \"innodb_ft_enable_diag_print\",\"OFF\" \"innodb_ft_enable_stopword\",\"ON\" \"innodb_ft_max_token_size\",\"84\" \"innodb_ft_min_token_size\",\"3\" \"innodb_ft_num_word_optimize\",\"2000\" \"innodb_ft_result_cache_limit\",\"2000000000\" \"innodb_ft_server_stopword_table\",\"\" \"innodb_ft_sort_pll_degree\",\"2\" \"innodb_ft_total_cache_size\",\"640000000\" \"innodb_ft_user_stopword_table\",\"\" \"innodb_idle_flush_pct\",\"100\" \"innodb_index_pct_free\",\"10\" \"innodb_instant_ddl_enabled\",\"ON\" \"innodb_io_capacity\",\"20000\" \"innodb_io_capacity_max\",\"40000\" \"innodb_lock_wait_timeout\",\"50\" \"innodb_log_buffer_size\",\"8388608\" \"innodb_log_checksums\",\"ON\" \"innodb_log_compressed_pages\",\"OFF\" \"innodb_log_file_size\",\"1572864000\" \"innodb_log_files_in_group\",\"2\" \"innodb_log_group_home_dir\",\"/home/mysql/data/mysql\" \"innodb_log_optimize_ddl\",\"OFF\" \"innodb_log_spin_cpu_abs_lwm\",\"80\" \"innodb_log_spin_cpu_pct_hwm\",\"50\" \"innodb_log_wait_for_flush_spin_hwm\",\"400\" \"innodb_log_write_ahead_size\",\"4096\" \"innodb_log_writer_threads\",\"ON\" \"innodb_lru_scan_depth\",\"1024\" \"innodb_max_dirty_pages_pct\",\"75.000000\" \"innodb_max_dirty_pages_pct_lwm\",\"10.000000\" \"innodb_max_mtr_records_for_tmp_table\",\"0\" \"innodb_max_purge_lag\",\"0\" \"innodb_max_purge_lag_delay\",\"0\" \"innodb_max_undo_log_size\",\"1073741824\" \"innodb_monitor_disable\",\"\" \"innodb_monitor_enable\",\"\" \"innodb_monitor_reset\",\"\" \"innodb_monitor_reset_all\",\"\" \"innodb_multi_blocks_enabled\",\"ON\" \"innodb_numa_interleave\",\"ON\" \"innodb_old_blocks_pct\",\"37\" \"innodb_old_blocks_time\",\"1000\" \"innodb_online_alter_log_max_size\",\"134217728\" \"innodb_open_files\",\"20000\" \"innodb_optimize_fulltext_only\",\"OFF\" \"innodb_oss_ddl_threads\",\"16\" \"innodb_oss_default_big_block_size\",\"2097152\" \"innodb_oss_files_limit\",\"10240\" \"innodb_oss_prefetch\",\"ON\" \"innodb_oss_prefetch_linear_pct_threshold\",\"10\" \"innodb_oss_prefetch_random_pct_threshold\",\"30\" \"innodb_oss_prefetch_task_limit\",\"32\" \"innodb_page_cleaners\",\"8\" \"innodb_page_size\",\"16384\" \"innodb_parallel_read_threads\",\"0\" \"innodb_parallel_redo_chunk_size\",\"33554432\" \"innodb_parallel_redo_threads\",\"1\" \"innodb_print_all_deadlocks\",\"OFF\" \"innodb_print_data_file_purge_process\",\"OFF\" \"innodb_print_ddl_logs\",\"OFF\" \"innodb_purge_batch_size\",\"300\" \"innodb_purge_rseg_truncate_frequency\",\"128\" \"innodb_purge_threads\",\"8\" \"innodb_random_read_ahead\",\"OFF\" \"innodb_rds_chunk_flush_interval\",\"100\" \"innodb_rds_drop_ahi_ahead\",\"OFF\" \"innodb_rds_faster_ddl\",\"ON\" \"innodb_rds_flashback_allow_gap\",\"30\" \"innodb_rds_flashback_enabled\",\"ON\" \"innodb_rds_flashback_interval\",\"1\" \"innodb_rds_flashback_print_warning\",\"ON\" \"innodb_rds_flashback_task_enabled\",\"OFF\" \"innodb_rds_flashback_task_stop_all\",\"OFF\" \"innodb_rds_free_resize\",\"ON\" \"innodb_rds_resize_lock_interval\",\"0\" \"innodb_rds_suspend_purge\",\"OFF\" \"innodb_read_ahead_threshold\",\"56\" \"innodb_read_io_threads\",\"4\" \"innodb_read_only\",\"OFF\" \"innodb_redo_log_archive_dirs\",\"\" \"innodb_redo_log_capacity\",\"104857600\" \"innodb_redo_log_encrypt\",\"OFF\" \"innodb_redo_log_length_enabled\",\"OFF\" \"innodb_redo_log_unclean_upgrade\",\"ON\" \"innodb_replication_delay\",\"0\" \"innodb_rollback_on_timeout\",\"OFF\" \"innodb_rollback_segments\",\"128\" \"innodb_segment_reserve_factor\",\"12.500000\" \"innodb_sort_buffer_size\",\"1048576\" \"innodb_spin_wait_delay\",\"6\" \"innodb_spin_wait_pause_multiplier\",\"50\" \"innodb_stats_auto_recalc\",\"ON\" \"innodb_stats_include_delete_marked\",\"OFF\" \"innodb_stats_method\",\"nulls_equal\" \"innodb_stats_on_metadata\",\"OFF\" \"innodb_stats_persistent\",\"ON\" \"innodb_stats_persistent_sample_pages\",\"20\" \"innodb_stats_transient_sample_pages\",\"8\" \"innodb_status_output\",\"OFF\" \"innodb_status_output_locks\",\"OFF\" \"innodb_strict_mode\",\"OFF\" \"innodb_sync_array_size\",\"128\" \"innodb_sync_spin_loops\",\"30\" \"innodb_table_locks\",\"ON\" \"innodb_temp_data_file_path\",\"ibtmp1:12M:autoextend\" \"innodb_temp_tablespaces_dir\",\"./#innodb_temp/\" \"innodb_thread_concurrency\",\"0\" \"innodb_thread_sleep_delay\",\"10000\" \"innodb_tmpdir\",\"\" \"innodb_trx_resurrect_table_lock_accelerate\",\"OFF\" \"innodb_undo_directory\",\"./\" \"innodb_undo_log_encrypt\",\"OFF\" \"innodb_undo_log_truncate\",\"ON\" \"innodb_undo_retention\",\"0\" \"innodb_undo_space_reserved_size\",\"0\" \"innodb_undo_space_supremum_size\",\"10240\" \"innodb_undo_tablespaces\",\"2\" \"innodb_use_fdatasync\",\"OFF\" \"innodb_use_native_aio\",\"ON\" \"innodb_validate_tablespace_paths\",\"ON\" \"innodb_version\",\"8.0.36\" \"innodb_write_io_threads\",\"4\" \"insert_id\",\"0\" \"interactive_timeout\",\"7200\" \"internal_tmp_mem_storage_engine\",\"MEMORY\" \"join_buffer_size\",\"1048576\" \"json_document_max_depth\",\"100\" \"keep_files_on_create\",\"OFF\" \"key_buffer_size\",\"16777216\" \"key_cache_age_threshold\",\"300\" \"key_cache_block_size\",\"1024\" \"key_cache_division_limit\",\"100\" \"keyring_operations\",\"ON\" \"kill_idle_transaction_timeout\",\"0\" \"large_files_support\",\"ON\" \"large_page_size\",\"0\" \"large_pages\",\"OFF\" \"last_insert_id\",\"0\" \"lc_messages\",\"en_US\" \"lc_messages_dir\",\"/u01/mysql/share/\" \"lc_time_names\",\"en_US\" \"license\",\"GPL\" \"local_infile\",\"ON\" \"lock_instance_mode\",\"LOCK_NON\" \"lock_wait_timeout\",\"31536000\" \"locked_in_memory\",\"OFF\" \"log_bin\",\"ON\" \"log_bin_basename\",\"/home/mysql/log/mysql/mysql-bin\" \"log_bin_index\",\"/home/mysql/log/mysql/mysql-bin.index\" \"log_bin_trust_function_creators\",\"ON\" \"log_bin_use_v1_row_events\",\"ON\" \"log_error\",\"/home/mysql/log/mysql/master-error.log\" \"log_error_services\",\"log_filter_internal; log_sink_internal\" \"log_error_suppression_list\",\"MY-010520,MY-013360\" \"log_error_verbosity\",\"3\" \"log_output\",\"TABLE\" \"log_queries_not_using_indexes\",\"OFF\" \"log_raw\",\"OFF\" \"log_replica_updates\",\"ON\" \"log_slave_updates\",\"ON\" \"log_slow_admin_statements\",\"OFF\" \"log_slow_extra\",\"OFF\" \"log_slow_replica_statements\",\"OFF\" \"log_slow_slave_statements\",\"OFF\" \"log_statements_unsafe_for_binlog\",\"ON\" \"log_throttle_queries_not_using_indexes\",\"0\" \"log_timestamps\",\"SYSTEM\" \"long_query_time\",\"1.000000\" \"low_priority_updates\",\"OFF\" \"lower_case_file_system\",\"OFF\" \"lower_case_table_names\",\"1\" \"maintain_max_connections\",\"500\" \"maintain_user_list\",\"aliyun_root,aurora,replicator,mysql.infoschema,mysql.session,mysql.sys\" \"mandatory_roles\",\"\" \"master_info_repository\",\"TABLE\" \"master_verify_checksum\",\"OFF\" \"max_allowed_packet\",\"1073741824\" \"max_binlog_cache_size\",\"18446744073709547520\" \"max_binlog_size\",\"524288000\" \"max_binlog_stmt_cache_size\",\"18446744073709547520\" \"max_connect_errors\",\"100\" \"max_connections\",\"6520\" \"max_delayed_threads\",\"20\" \"max_digest_length\",\"1024\" \"max_error_count\",\"64\" \"max_execution_time\",\"0\" \"max_heap_table_size\",\"67108864\" \"max_insert_delayed_threads\",\"20\" \"max_join_size\",\"18446744073709551615\" \"max_length_for_sort_data\",\"1024\" \"max_points_in_geometry\",\"65536\" \"max_prepared_stmt_count\",\"16382\" \"max_relay_log_size\",\"0\" \"max_seeks_for_key\",\"18446744073709500000\" \"max_sort_length\",\"1024\" \"max_sp_recursion_depth\",\"0\" \"max_unix_admin_connections\",\"100\" \"max_user_connections\",\"6000\" \"max_write_lock_count\",\"102400\" \"min_examined_row_limit\",\"0\" \"multi_blocks_count\",\"0\" \"multi_blocks_ddl_count\",\"0\" \"myisam_data_pointer_size\",\"6\" \"myisam_max_sort_file_size\",\"2097152\" \"myisam_mmap_size\",\"18446744073709551615\" \"myisam_recover_options\",\"FORCE\" \"myisam_repair_threads\",\"1\" \"myisam_sort_buffer_size\",\"262144\" \"myisam_stats_method\",\"nulls_unequal\" \"myisam_use_mmap\",\"OFF\" \"mysql_native_password_proxy_users\",\"OFF\" \"mysqlx_bind_address\",\"\" \"mysqlx_compression_algorithms\",\"DEFLATE_STREAM,LZ4_MESSAGE,ZSTD_STREAM\" \"mysqlx_connect_timeout\",\"30\" \"mysqlx_deflate_default_compression_level\",\"3\" \"mysqlx_deflate_max_client_compression_level\",\"5\" \"mysqlx_document_id_unique_prefix\",\"0\" \"mysqlx_enable_hello_notice\",\"ON\" \"mysqlx_idle_worker_thread_timeout\",\"60\" \"mysqlx_interactive_timeout\",\"28800\" \"mysqlx_lz4_default_compression_level\",\"2\" \"mysqlx_lz4_max_client_compression_level\",\"8\" \"mysqlx_max_allowed_packet\",\"67108864\" \"mysqlx_max_connections\",\"100\" \"mysqlx_min_worker_threads\",\"2\" \"mysqlx_port\",\"33060\" \"mysqlx_port_open_timeout\",\"0\" \"mysqlx_read_timeout\",\"30\" \"mysqlx_socket\",\"/tmp/mysqlx.sock\" \"mysqlx_ssl_ca\",\"\" \"mysqlx_ssl_capath\",\"\" \"mysqlx_ssl_cert\",\"\" \"mysqlx_ssl_cipher\",\"\" \"mysqlx_ssl_crl\",\"\" \"mysqlx_ssl_crlpath\",\"\" \"mysqlx_ssl_key\",\"\" \"mysqlx_wait_timeout\",\"28800\" \"mysqlx_write_timeout\",\"60\" \"mysqlx_zstd_default_compression_level\",\"3\" \"mysqlx_zstd_max_client_compression_level\",\"11\" \"net_buffer_length\",\"16384\" \"net_read_timeout\",\"30\" \"net_retry_count\",\"10\" \"net_shrink_count_threshold\",\"5\" \"net_write_timeout\",\"60\" \"new\",\"OFF\" \"ngram_token_size\",\"2\" \"offline_mode\",\"OFF\" \"old\",\"OFF\" \"old_alter_table\",\"OFF\" \"open_files_limit\",\"655350\" \"opt_enable_rds_priv_strategy\",\"ON\" \"opt_indexstat\",\"OFF\" \"opt_outline_enabled\",\"ON\" \"opt_tablestat\",\"OFF\" \"optimizer_max_subgraph_pairs\",\"100000\" \"optimizer_prune_level\",\"1\" \"optimizer_search_depth\",\"62\" \"optimizer_switch\",\"index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,duplicateweedout=on,subquery_materialization_cost_based=on,use_index_extensions=on,condition_fanout_filter=on,derived_merge=on,use_invisible_indexes=off,skip_scan=on,hash_join=on,subquery_to_derived=off,prefer_ordering_index=on,hypergraph_optimizer=off,derived_condition_pushdown=on\" \"optimizer_trace\",\"enabled=off,one_line=off\" \"optimizer_trace_features\",\"greedy_search=on,range_optimizer=on,dynamic_range=on,repeated_subselect=on\" \"optimizer_trace_limit\",\"1\" \"optimizer_trace_max_mem_size\",\"16384\" \"optimizer_trace_offset\",\"-1\" \"original_commit_timestamp\",\"36028797018963968\" \"original_server_version\",\"999999\" \"oss_access_key_id\",\"**\" \"oss_access_key_secret\",\"*\" \"oss_bucket_name\",\"\" \"oss_common_sleep_time\",\"50\" \"oss_directory\",\"\" \"oss_enabled\",\"OFF\" \"oss_endpoint\",\"\" \"oss_get_sleep_time\",\"30\" \"oss_iops_limit\",\"19200\" \"oss_max_connections\",\"64\" \"oss_put_sleep_time\",\"100\" \"oss_recv_bandwidth_limit\",\"307200\" \"oss_send_bandwidth_limit\",\"307200\" \"oss_token\",\"**\" \"oss_wait_available_timeout\",\"600\" \"outline_allowed_sql_digest_truncate\",\"ON\" \"outline_partitions\",\"16\" \"parser_max_mem_size\",\"18446744073709551615\" \"partial_revokes\",\"OFF\" \"password_history\",\"0\" \"password_require_current\",\"OFF\" \"password_reuse_interval\",\"0\" \"performance_agent_enabled\",\"ON\" \"performance_agent_file_size\",\"128\" \"performance_agent_interval\",\"1\" \"performance_agent_network_device\",\"enp,  eth,   em\" \"performance_agent_perfstat_volume_size\",\"3600\" \"performance_point_dbug_enabled\",\"OFF\" \"performance_point_enabled\",\"ON\" \"performance_point_iostat_interval\",\"2\" \"performance_point_iostat_volume_size\",\"10000\" \"performance_point_lock_rwlock_enabled\",\"ON\" \"performance_schema\",\"ON\" \"performance_schema_accounts_size\",\"10000\" \"performance_schema_digests_size\",\"10000\" \"performance_schema_error_size\",\"0\" \"performance_schema_events_stages_history_long_size\",\"0\" \"performance_schema_events_stages_history_size\",\"0\" \"performance_schema_events_statements_history_long_size\",\"0\" \"performance_schema_events_statements_history_size\",\"0\" \"performance_schema_events_transactions_history_long_size\",\"0\" \"performance_schema_events_transactions_history_size\",\"0\" \"performance_schema_events_waits_history_long_size\",\"0\" \"performance_schema_events_waits_history_size\",\"0\" \"performance_schema_hosts_size\",\"10000\" \"performance_schema_max_cond_classes\",\"150\" \"performance_schema_max_cond_instances\",\"10000\" \"performance_schema_max_digest_length\",\"0\" \"performance_schema_max_digest_sample_age\",\"0\" \"performance_schema_max_file_classes\",\"80\" \"performance_schema_max_file_handles\",\"0\" \"performance_schema_max_file_instances\",\"1000\" \"performance_schema_max_index_stat\",\"10000\" \"performance_schema_max_memory_classes\",\"500\" \"performance_schema_max_metadata_locks\",\"10000\" \"performance_schema_max_mutex_classes\",\"256\" \"performance_schema_max_mutex_instances\",\"10000\" \"performance_schema_max_prepared_statements_instances\",\"1000\" \"performance_schema_max_program_instances\",\"10000\" \"performance_schema_max_rwlock_classes\",\"100\" \"performance_schema_max_rwlock_instances\",\"10000\" \"performance_schema_max_socket_classes\",\"10\" \"performance_schema_max_socket_instances\",\"1000\" \"performance_schema_max_sql_text_length\",\"0\" \"performance_schema_max_stage_classes\",\"200\" \"performance_schema_max_statement_classes\",\"256\" \"performance_schema_max_statement_stack\",\"1\" \"performance_schema_max_table_handles\",\"10000\" \"performance_schema_max_table_instances\",\"1000\" \"performance_schema_max_table_lock_stat\",\"10000\" \"performance_schema_max_thread_classes\",\"100\" \"performance_schema_max_thread_instances\",\"10000\" \"performance_schema_session_connect_attrs_size\",\"0\" \"performance_schema_setup_actors_size\",\"10000\" \"performance_schema_setup_objects_size\",\"10000\" \"performance_schema_show_processlist\",\"OFF\" \"performance_schema_users_size\",\"10000\" \"performance_tcp_write_wait_time_enabled\",\"ON\" \"persist_binlog_to_redo\",\"ON\" \"persist_binlog_to_redo_size_limit\",\"1048576\" \"persist_log_bin\",\"ON\" \"persist_only_admin_x509_subject\",\"\" \"persist_sensitive_variables_in_plaintext\",\"ON\" \"persisted_globals_load\",\"ON\" \"pid_file\",\"/home/mysql/data/my3042.pid\" \"plugin_dir\",\"/u01/mysql/lib/plugin/\" \"port\",\"3042\" \"preload_buffer_size\",\"32768\" \"primary_fast_lookup\",\"ON\" \"print_identified_with_as_hex\",\"OFF\" \"profiling\",\"ON\" \"profiling_history_size\",\"15\" \"protocol_compression_algorithms\",\"zlib,zstd,uncompressed\" \"protocol_version\",\"10\" \"proxy_ip_list\",\"21.4.1.234,20.5.6.12\" \"proxy_user\",\"\" \"pseudo_replica_mode\",\"OFF\" \"pseudo_slave_mode\",\"OFF\" \"pseudo_thread_id\",\"636529\" \"push_tran_info_default_interval\",\"10\" \"query_alloc_block_size\",\"8192\" \"query_prealloc_size\",\"8192\" \"rand_seed1\",\"0\" \"rand_seed2\",\"0\" \"range_alloc_block_size\",\"4096\" \"range_optimizer_max_mem_size\",\"8388608\" \"rbr_exec_mode\",\"STRICT\" \"rds_active_memory_profiling\",\"OFF\" \"rds_audit_log_buffer_size\",\"16777216\" \"rds_audit_log_connection_policy\",\"ALL\" \"rds_audit_log_dir\",\"\" \"rds_audit_log_enabled\",\"OFF\" \"rds_audit_log_event_buffer_size\",\"8192\" \"rds_audit_log_flush\",\"OFF\" \"rds_audit_log_format\",\"PLAIN\" \"rds_audit_log_policy\",\"ALL\" \"rds_audit_log_row_limit\",\"100000\" \"rds_audit_log_skip\",\"OFF\" \"rds_audit_log_statement_policy\",\"ALL\" \"rds_audit_log_strategy\",\"ASYNCHRONOUS\" \"rds_audit_log_version\",\"MYSQL_V3\" \"rds_binlog_cache_diagnose_size\",\"524288000\" \"rds_check_core_file_enabled\",\"ON\" \"rds_data_protect_admin\",\"\" \"rds_data_protect_control\",\"USER\" \"rds_data_protect_ignore\",\"\" \"rds_data_protect_level\",\"NONE\" \"rds_dg_arch_enabled\",\"OFF\" \"rds_diagnose_ddl_options\",\"SQLCOM_ALTER_TABLE\" \"rds_diagnose_log_options\",\"BIG_TRANSACTION,DDL\" \"rds_diagnose_throttle_ddl_logs\",\"10\" \"rds_disable_explicit_trans\",\"OFF\" \"rds_expose_priv_list\",\"XA_RECOVER_ADMIN,SESSION_VARIABLES_ADMIN,SHOW_ROUTINE\" \"rds_hotfix_version\",\"0\" \"rds_ignore_password_validation_user_list\",\"aurora,Xtrabak,replicator,eagleye,aliyun_root\" \"rds_kill_connections\",\"20\" \"rds_kill_user_list\",\"mysqladmin\" \"rds_print_tcp_error\",\"OFF\" \"rds_reduce_super_to_repl_slave\",\"OFF\" \"rds_release_date\",\"20241231\" \"rds_version\",\"36\" \"read_buffer_size\",\"1048576\" \"read_only\",\"OFF\" \"read_rnd_buffer_size\",\"262144\" \"recycle_bin\",\"OFF\" \"recycle_bin_retention\",\"604800\" \"recycle_scheduler\",\"OFF\" \"recycle_scheduler_interval\",\"30\" \"recycle_scheduler_purge_table_print\",\"OFF\" \"regexp_stack_limit\",\"8000000\" \"regexp_time_limit\",\"32\" \"relay_log\",\"/home/mysql/log/mysql/slave-relay.log\" \"relay_log_basename\",\"/home/mysql/log/mysql/slave-relay\" \"relay_log_index\",\"/home/mysql/log/mysql/slave-relay-log.index\" \"relay_log_info_file\",\"/home/mysql/log/mysql/slave-relay-log.info\" \"relay_log_info_repository\",\"TABLE\" \"relay_log_purge\",\"ON\" \"relay_log_recovery\",\"OFF\" \"relay_log_space_limit\",\"0\" \"replica_allow_batching\",\"ON\" \"replica_checkpoint_group\",\"512\" \"replica_checkpoint_period\",\"300\" \"replica_compressed_protocol\",\"OFF\" \"replica_exec_mode\",\"STRICT\" \"replica_load_tmpdir\",\"/home/mysql/log/tmp\" \"replica_max_allowed_packet\",\"1073741824\" \"replica_net_timeout\",\"60\" \"replica_parallel_type\",\"LOGICAL_CLOCK\" \"replica_parallel_workers\",\"8\" \"replica_pending_jobs_size_max\",\"134217728\" \"replica_preserve_commit_order\",\"ON\" \"replica_skip_errors\",\"OFF\" \"replica_sql_verify_checksum\",\"ON\" \"replica_transaction_retries\",\"10\" \"replica_type_conversions\",\"\" \"replication_optimize_for_static_plugin_config\",\"OFF\" \"replication_sender_observe_commit_only\",\"OFF\" \"report_host\",\"21.4.0.97\" \"report_password\",\"\" \"report_port\",\"3042\" \"report_user\",\"\" \"require_row_format\",\"OFF\" \"require_secure_transport\",\"OFF\" \"resultset_metadata\",\"FULL\" \"reverse_repair_general_log_on_boot\",\"ON\" \"rotate_log_table\",\"OFF\" \"rotate_log_table_last_name\",\"./mysql/slow_log_1748496702.CSV\" \"rpl_read_size\",\"8192\" \"rpl_semi_sync_master_enabled\",\"OFF\" \"rpl_semi_sync_master_timeout\",\"1000\" \"rpl_semi_sync_master_trace_level\",\"1\" \"rpl_semi_sync_master_wait_for_slave_count\",\"1\" \"rpl_semi_sync_master_wait_no_slave\",\"OFF\" \"rpl_semi_sync_master_wait_point\",\"AFTER_SYNC\" \"rpl_semi_sync_slave_enabled\",\"OFF\" \"rpl_semi_sync_slave_trace_level\",\"1\" \"rpl_stop_replica_timeout\",\"31536000\" \"rpl_stop_slave_timeout\",\"31536000\" \"schema_definition_cache\",\"256\" \"secondary_engine_cost_threshold\",\"100000.000000\" \"secure_file_priv\",\"NULL\" \"select_into_buffer_size\",\"131072\" \"select_into_disk_sync\",\"OFF\" \"select_into_disk_sync_delay\",\"0\" \"sequence_read_skip_cache\",\"OFF\" \"server_id\",\"36609803\" \"server_id_bits\",\"32\" \"server_uuid\",\"75ab9019-39d5-11f0-b040-00163e1d621b\" \"session_track_gtids\",\"OFF\" \"session_track_prepare_statements\",\"OFF\" \"session_track_schema\",\"ON\" \"session_track_state_change\",\"ON\" \"session_track_system_variables\",\"\" \"session_track_temporary_tables\",\"OFF\" \"session_track_transaction_info\",\"OFF\" \"session_track_user_variables\",\"OFF\" \"set_connection_id_enabled\",\"ON\" \"sha256_password_auto_generate_rsa_keys\",\"ON\" \"sha256_password_private_key_path\",\"private_key.pem\" \"sha256_password_proxy_users\",\"OFF\" \"sha256_password_public_key_path\",\"public_key.pem\" \"show_create_table_skip_secondary_engine\",\"OFF\" \"show_create_table_verbosity\",\"OFF\" \"show_gipk_in_create_table_and_information_schema\",\"ON\" \"show_ipk_info\",\"OFF\" \"show_old_temporals\",\"OFF\" \"skip_dd_table_access_check\",\"OFF\" \"skip_external_locking\",\"ON\" \"skip_free_flush_ignorable_event\",\"ON\" \"skip_name_resolve\",\"ON\" \"skip_networking\",\"OFF\" \"skip_replica_start\",\"OFF\" \"skip_show_database\",\"OFF\" \"skip_slave_start\",\"OFF\" \"slave_allow_batching\",\"ON\" \"slave_checkpoint_group\",\"512\" \"slave_checkpoint_period\",\"300\" \"slave_compressed_protocol\",\"OFF\" \"slave_exec_mode\",\"STRICT\" \"slave_load_tmpdir\",\"/home/mysql/log/tmp\" \"slave_max_allowed_packet\",\"1073741824\" \"slave_net_timeout\",\"60\" \"slave_parallel_type\",\"LOGICAL_CLOCK\" \"slave_parallel_workers\",\"8\" \"slave_pending_jobs_size_max\",\"134217728\" \"slave_preserve_commit_order\",\"ON\" \"slave_rows_search_algorithms\",\"TABLE_SCAN,INDEX_SCAN\" \"slave_skip_errors\",\"OFF\" \"slave_sql_verify_checksum\",\"ON\" \"slave_transaction_retries\",\"10\" \"slave_type_conversions\",\"\" \"slow_launch_time\",\"2\" \"slow_log_guarantee\",\"ON\" \"slow_query_log\",\"ON\" \"slow_query_log_file\",\"/home/mysql/log/mysql/slow_query.log\" \"socket\",\"/home/mysql/data/tmp/mysql.sock\" \"sort_buffer_size\",\"2097152\" \"source_verify_checksum\",\"OFF\" \"sql_auto_is_null\",\"OFF\" \"sql_big_selects\",\"ON\" \"sql_buffer_result\",\"OFF\" \"sql_generate_invisible_primary_key\",\"OFF\" \"sql_log_bin\",\"ON\" \"sql_log_off\",\"OFF\" \"sql_mode\",\"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION\" \"sql_notes\",\"ON\" \"sql_quote_show_create\",\"ON\" \"sql_replica_skip_counter\",\"0\" \"sql_require_primary_key\",\"OFF\" \"sql_safe_updates\",\"OFF\" \"sql_select_limit\",\"3000\" \"sql_slave_skip_counter\",\"0\" \"sql_warnings\",\"OFF\" \"ssl_ca\",\"\" \"ssl_capath\",\"\" \"ssl_cert\",\"/home/mysql/data/ssl/ssl_rm-bp1z61qll5e58l2x5.cert\" \"ssl_cipher\",\"ALL:@SECLEVEL=0\" \"ssl_crl\",\"\" \"ssl_crlpath\",\"\" \"ssl_fips_mode\",\"OFF\" \"ssl_key\",\"/home/mysql/data/ssl/ssl_rm-bp1z61qll5e58l2x5.key\" \"ssl_session_cache_mode\",\"ON\" \"ssl_session_cache_timeout\",\"300\" \"stack_overrun_warning\",\"OFF\" \"statement_id\",\"505777456\" \"stored_program_cache\",\"256\" \"stored_program_definition_cache\",\"256\" \"super_read_only\",\"OFF\" \"sync_binlog\",\"1\" \"sync_binlog_interval\",\"50000\" \"sync_binlog_redo_together\",\"OFF\" \"sync_master_info\",\"10000\" \"sync_relay_log\",\"10000\" \"sync_relay_log_info\",\"10000\" \"sync_source_info\",\"10000\" \"system_time_zone\",\"CST\" \"table_definition_cache\",\"4096\" \"table_encryption_privilege_check\",\"OFF\" \"table_open_cache\",\"8192\" \"table_open_cache_instances\",\"16\" \"tablespace_definition_cache\",\"256\" \"temptable_max_mmap\",\"1073741824\" \"temptable_max_ram\",\"1073741824\" \"temptable_use_mmap\",\"OFF\" \"terminology_use_previous\",\"NONE\" \"thread_cache_size\",\"100\" \"thread_handling\",\"pool-of-threads\" \"thread_pool_enabled\",\"ON\" \"thread_pool_idle_timeout\",\"10\" \"thread_pool_max_threads\",\"10000\" \"thread_pool_normal_weights\",\"50\" \"thread_pool_oversubscribe\",\"32\" \"thread_pool_size\",\"4\" \"thread_pool_stall_limit\",\"100\" \"thread_pool_trans_weights\",\"50\" \"thread_stack\",\"1048576\" \"time_zone\",\"+08:00\" \"timestamp\",\"1748496749.610203\" \"tls_ciphersuites\",\"\" \"tls_version\",\"TLSv1,TLSv1.1,TLSv1.2\" \"tmp_table_size\",\"2097152\" \"tmpdir\",\"/home/mysql/log/tmp\" \"transaction_alloc_block_size\",\"8192\" \"transaction_allow_batching\",\"OFF\" \"transaction_isolation\",\"READ-COMMITTED\" \"transaction_prealloc_size\",\"4096\" \"transaction_read_only\",\"OFF\" \"transaction_write_set_extraction\",\"XXHASH64\" \"unique_checks\",\"ON\" \"updatable_views_with_limit\",\"YES\" \"upgrade_clear_invalid_comment\",\"ON\" \"use_secondary_engine\",\"ON\" \"version\",\"8.0.36\" \"version_comment\",\"Source distribution\" \"version_compile_machine\",\"x86_64\" \"version_compile_os\",\"Linux\" \"version_compile_zlib\",\"1.2.13\" \"wait_binlog_flush\",\"ON\" \"wait_timeout\",\"86400\" \"warning_count\",\"0\" \"windowing_use_high_precision\",\"ON\" \"writeset_tracking_for_foreign_key\",\"OFF\" \"writeset_tracking_for_ipk\",\"ON\" \"xa_detach_on_prepare\",\"ON\"</p>"},{"location":"mysql/Backup_Restore/backup/","title":"\u6570\u636e\u5907\u4efd\u4e0e\u6062\u590d","text":""},{"location":"mysql/Backup_Restore/backup/#_2","title":"\u7269\u7406\u5907\u4efd","text":"<p>\u7269\u7406\u5907\u4efd\u662f\u5bf9\u6570\u636e\u5e93\u6587\u4ef6\u7cfb\u7edf\u7684\u76f4\u63a5\u5907\u4efd\uff0c\u4fdd\u6301\u6570\u636e\u6587\u4ef6\u7684\u539f\u59cb\u683c\u5f0f\u3002\u8fd9\u79cd\u65b9\u6cd5\u5feb\u901f\u9ad8\u6548\uff0c\u5e38\u7528\u4e8e\u5927\u578b\u6570\u636e\u5e93\u7684\u5907\u4efd\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#xtrabackup","title":"xtrabackup","text":"<p>Percona XtraBackup \u662f\u6700\u6d41\u884c\u7684 MySQL \u7269\u7406\u5907\u4efd\u5de5\u5177\uff0c\u652f\u6301\u70ed\u5907\u4efd\uff08\u65e0\u9700\u505c\u673a\uff09\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#xtrabackup_1","title":"\u5b89\u88c5 xtrabackup","text":"<pre><code># Ubuntu/Debian\nwget https://repo.percona.com/apt/percona-release_0.1-6.$(lsb_release -sc)_all.deb\nsudo dpkg -i percona-release_0.1-6.$(lsb_release -sc)_all.deb\nsudo apt-get update\nsudo apt-get install percona-xtrabackup-80\n\n# CentOS/RHEL\nsudo yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm\nsudo percona-release setup ps80\nsudo yum install percona-xtrabackup-80\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_3","title":"\u5b8c\u6574\u5907\u4efd","text":"<pre><code># \u57fa\u7840\u5b8c\u6574\u5907\u4efd\nxtrabackup --user=root --password=your_password --backup --target-dir=/path/to/backup/directory\n\n# \u4f7f\u7528\u914d\u7f6e\u6587\u4ef6\nxtrabackup --defaults-file=/etc/mysql/my.cnf --user=root --password=your_password --backup --target-dir=/path/to/backup/directory\n\n# \u6307\u5b9a\u6570\u636e\u5e93\nxtrabackup --user=root --password=your_password --backup --target-dir=/path/to/backup/directory --databases=\"db1 db2\"\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_4","title":"\u589e\u91cf\u5907\u4efd","text":"<pre><code># \u57fa\u4e8e\u4e0a\u6b21\u5907\u4efd\u7684\u589e\u91cf\u5907\u4efd\nxtrabackup --user=root --password=your_password --backup --target-dir=/path/to/incremental/backup --incremental-basedir=/path/to/base/backup\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_5","title":"\u51c6\u5907\u5907\u4efd","text":"<pre><code># \u51c6\u5907\u5b8c\u6574\u5907\u4efd\nxtrabackup --prepare --target-dir=/path/to/backup/directory\n\n# \u51c6\u5907\u589e\u91cf\u5907\u4efd\uff08\u4e24\u6b65\u64cd\u4f5c\uff09\nxtrabackup --prepare --target-dir=/path/to/base/backup --incremental-dir=/path/to/incremental/backup\n\n# \u5408\u5e76\u589e\u91cf\u5907\u4efd\u5230\u57fa\u7840\u5907\u4efd\nxtrabackup --prepare --target-dir=/path/to/base/backup --incremental-dir=/path/to/incremental/backup\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_6","title":"\u6062\u590d\u5907\u4efd","text":"<pre><code># \u5173\u95edMySQL\u670d\u52a1\nsudo systemctl stop mysql\n\n# \u6e05\u7a7a\u6570\u636e\u76ee\u5f55\nsudo rm -rf /var/lib/mysql/*\n\n# \u6062\u590d\u5907\u4efd\nxtrabackup --copy-back --target-dir=/path/to/backup/directory\n\n# \u66f4\u6539\u6587\u4ef6\u6240\u6709\u8005\nsudo chown -R mysql:mysql /var/lib/mysql\n\n# \u542f\u52a8MySQL\u670d\u52a1\nsudo systemctl start mysql\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_7","title":"\u5e38\u7528\u53c2\u6570\u8bf4\u660e","text":"<ul> <li><code>--user</code>\uff1a\u8fde\u63a5 MySQL \u7684\u7528\u6237\u540d</li> <li><code>--password</code>\uff1a\u8fde\u63a5 MySQL \u7684\u5bc6\u7801</li> <li><code>--host</code>\uff1aMySQL \u4e3b\u673a\u5730\u5740</li> <li><code>--port</code>\uff1aMySQL \u7aef\u53e3\u53f7</li> <li><code>--backup</code>\uff1a\u6267\u884c\u5907\u4efd\u64cd\u4f5c</li> <li><code>--target-dir</code>\uff1a\u5907\u4efd\u76ee\u6807\u76ee\u5f55</li> <li><code>--incremental-basedir</code>\uff1a\u589e\u91cf\u5907\u4efd\u7684\u57fa\u51c6\u76ee\u5f55</li> <li><code>--prepare</code>\uff1a\u51c6\u5907\u5907\u4efd\u6570\u636e\uff08\u56de\u6eda\u672a\u63d0\u4ea4\u7684\u4e8b\u52a1\uff09</li> <li><code>--copy-back</code>\uff1a\u5c06\u5907\u4efd\u590d\u5236\u56de\u6570\u636e\u76ee\u5f55</li> <li><code>--defaults-file</code>\uff1a\u6307\u5b9a MySQL \u914d\u7f6e\u6587\u4ef6</li> <li><code>--databases</code>\uff1a\u53ea\u5907\u4efd\u6307\u5b9a\u7684\u6570\u636e\u5e93</li> </ul>"},{"location":"mysql/Backup_Restore/backup/#_8","title":"\u5907\u4efd\u811a\u672c\u793a\u4f8b","text":"<pre><code>#!/bin/bash\n\n# MySQL\u8fde\u63a5\u4fe1\u606f\nMYSQL_USER=\"root\"\nMYSQL_PASSWORD=\"your_password\"\nMYSQL_HOST=\"localhost\"\nMYSQL_PORT=\"3306\"\n\n# \u5907\u4efd\u76ee\u5f55\u8bbe\u7f6e\nBACKUP_BASE_DIR=\"/backup/mysql\"\nDATE=$(date +%Y%m%d_%H%M%S)\nBASE_BACKUP_DIR=\"$BACKUP_BASE_DIR/base\"\nINC_BACKUP_DIR=\"$BACKUP_BASE_DIR/inc\"\n\n# \u786e\u4fdd\u5907\u4efd\u76ee\u5f55\u5b58\u5728\nmkdir -p $BASE_BACKUP_DIR\nmkdir -p $INC_BACKUP_DIR\n\n# \u521b\u5efa\u786c\u94fe\u63a5\u57fa\u7840\u5907\u4efd\uff0c\u4fbf\u4e8e\u589e\u91cf\u5907\u4efd\nLATEST_BACKUP=$(ls -t $BASE_BACKUP_DIR/*/ 2&gt;/dev/null | head -n1)\n\nif [ -n \"$LATEST_BACKUP\" ]; then\n    # \u6267\u884c\u589e\u91cf\u5907\u4efd\n    xtrabackup --user=$MYSQL_USER --password=$MYSQL_PASSWORD \\\n        --backup --target-dir=\"$INC_BACKUP_DIR/$DATE\" \\\n        --incremental-basedir=\"$LATEST_BACKUP\"\n    echo \"Incremental backup completed: $INC_BACKUP_DIR/$DATE\"\nelse\n    # \u6267\u884c\u57fa\u7840\u5907\u4efd\n    xtrabackup --user=$MYSQL_USER --password=$MYSQL_PASSWORD \\\n        --backup --target-dir=\"$BASE_BACKUP_DIR/$DATE\"\n    echo \"Full backup completed: $BASE_BACKUP_DIR/$DATE\"\nfi\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_9","title":"\u903b\u8f91\u5907\u4efd","text":"<p>\u903b\u8f91\u5907\u4efd\u662f\u5c06\u6570\u636e\u5e93\u7684\u7ed3\u6784\u548c\u6570\u636e\u5bfc\u51fa\u4e3a SQL \u8bed\u53e5\uff0c\u53ef\u8bfb\u6027\u597d\uff0c\u4fbf\u4e8e\u8de8\u7248\u672c\u548c\u5e73\u53f0\u8fc1\u79fb\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#mysqldump","title":"mysqldump","text":"<p>mysqldump \u662f MySQL \u5b98\u65b9\u63d0\u4f9b\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\uff0c\u652f\u6301\u591a\u79cd\u5bfc\u51fa\u9009\u9879\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#_10","title":"\u57fa\u672c\u8bed\u6cd5","text":"<pre><code>mysqldump [options] db_name [tbl_name ...]\nmysqldump [options] --databases db_name ...\nmysqldump [options] --all-databases\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_11","title":"\u5e38\u7528\u5907\u4efd\u547d\u4ee4","text":"<pre><code># \u5907\u4efd\u5355\u4e2a\u6570\u636e\u5e93\nmysqldump -u root -p database_name &gt; backup_file.sql\n\n# \u5907\u4efd\u591a\u4e2a\u6570\u636e\u5e93\nmysqldump -u root -p --databases db1 db2 db3 &gt; backup_file.sql\n\n# \u5907\u4efd\u6240\u6709\u6570\u636e\u5e93\nmysqldump -u root -p --all-databases &gt; all_databases_backup.sql\n\n# \u5907\u4efd\u7279\u5b9a\u8868\nmysqldump -u root -p database_name table1 table2 &gt; backup_file.sql\n\n# \u5305\u542b\u521b\u5efa\u6570\u636e\u5e93\u8bed\u53e5\u7684\u5907\u4efd\nmysqldump -u root -p --databases --add-drop-database database_name &gt; backup_file.sql\n\n# \u7ed3\u6784\u5907\u4efd\uff08\u4ec5\u8868\u7ed3\u6784\uff0c\u4e0d\u542b\u6570\u636e\uff09\nmysqldump -u root -p --no-data database_name &gt; structure_backup.sql\n\n# \u6570\u636e\u5907\u4efd\uff08\u4ec5\u6570\u636e\uff0c\u4e0d\u542b\u7ed3\u6784\uff09\nmysqldump -u root -p --no-create-info database_name &gt; data_backup.sql\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_12","title":"\u9ad8\u7ea7\u9009\u9879","text":"<pre><code># \u4f7f\u7528GTID\u8fdb\u884c\u5907\u4efd\uff08MySQL 5.6+\uff09\nmysqldump -u root -p --set-gtid-purged=ON --all-databases &gt; backup.sql\n\n# \u5e76\u884c\u5904\u7406\uff08MySQL 8.0+\uff09\nmysqldump -u root -p --single-transaction --routines --triggers \\\n    --set-gtid-purged=ON --compress --hex-blob \\\n    --default-character-set=utf8mb4 --routines --triggers \\\n    --max-allowed-packet=1073741824 \\\n    database_name &gt; backup.sql\n\n# \u5927\u8868\u5907\u4efd\u4f18\u5316\nmysqldump -u root -p --single-transaction --quick --lock-tables=false \\\n    database_name &gt; backup.sql\n\n# \u5b89\u5168\u5907\u4efd\uff08\u8fc7\u6ee4\u654f\u611f\u5b57\u7b26\uff09\nmysqldump -u root -p --single-transaction --hex-blob database_name &gt; backup.sql\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_13","title":"\u6062\u590d\u64cd\u4f5c","text":"<pre><code># \u6062\u590d\u5907\u4efd\u6587\u4ef6\nmysql -u root -p database_name &lt; backup_file.sql\n\n# \u4ece\u538b\u7f29\u6587\u4ef6\u6062\u590d\ngunzip &lt; backup_file.sql.gz | mysql -u root -p database_name\n\n# \u5e26\u8fdb\u5ea6\u76d1\u63a7\u7684\u6062\u590d\npv backup_file.sql | mysql -u root -p database_name\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#mysqlpump","title":"mysqlpump","text":"<p>mysqlpump \u662f MySQL 5.7+\u63d0\u4f9b\u7684\u6539\u8fdb\u7248\u903b\u8f91\u5907\u4efd\u5de5\u5177\uff0c\u652f\u6301\u5e76\u884c\u5904\u7406\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#_14","title":"\u7279\u6027\u4e0e\u4f18\u52bf","text":"<ul> <li>\u652f\u6301\u591a\u7ebf\u7a0b\u5907\u4efd\uff0c\u63d0\u9ad8\u5907\u4efd\u901f\u5ea6</li> <li>\u652f\u6301\u5e76\u884c\u5904\u7406\u8868\u548c\u6570\u636e\u5e93</li> <li>\u66f4\u597d\u7684\u5907\u4efd\u7ed3\u6784\u7ec4\u7ec7</li> </ul>"},{"location":"mysql/Backup_Restore/backup/#_15","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code># \u5e76\u884c\u5907\u4efd\u6240\u6709\u6570\u636e\u5e93\nmysqlpump -u root -p --parallel-schemas=4 --default-character-set=utf8mb4 &gt; backup.sql\n\n# \u5e76\u884c\u5907\u4efd\u7279\u5b9a\u6570\u636e\u5e93\nmysqlpump -u root -p --default-character-set=utf8mb4 database_name &gt; backup.sql\n\n# \u9650\u5236\u5e76\u884c\u5ea6\nmysqlpump -u root -p --parallel-schemas=2 --default-character-set=utf8mb4 --all-databases &gt; backup.sql\n\n# \u5907\u4efd\u65f6\u8bbe\u7f6e\u538b\u7f29\nmysqlpump -u root -p --compress-algorithms=zlib --default-character-set=utf8mb4 database_name &gt; backup.sql\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#mydumper","title":"mydumper","text":"<p>mydumper \u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684 MySQL \u903b\u8f91\u5907\u4efd\u5de5\u5177\uff0c\u63d0\u4f9b\u591a\u7ebf\u7a0b\u5907\u4efd\u80fd\u529b\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#_16","title":"\u5b89\u88c5","text":"<pre><code># Ubuntu/Debian\nsudo apt-get install mydumper\n\n# CentOS/RHEL\nsudo yum install mydumper\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_17","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code># \u57fa\u672c\u5907\u4efd\nmydumper -u root -p password -o /path/to/backup/\n\n# \u591a\u7ebf\u7a0b\u5907\u4efd\nmydumper -u root -p password -o /path/to/backup/ -j 4\n\n# \u5907\u4efd\u7279\u5b9a\u6570\u636e\u5e93\nmydumper -u root -p password -o /path/to/backup/ -B database_name\n\n# \u538b\u7f29\u5907\u4efd\nmydumper -u root -p password -o /path/to/backup/ --compress\n\n# \u4f18\u5316\u67e5\u8be2\nmydumper -u root -p password -o /path/to/backup/ --compress --long-query-guard 600\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#mysqlsh","title":"mysqlsh","text":"<p>MySQL Shell \u63d0\u4f9b\u4e86\u73b0\u4ee3\u7684 MySQL \u5ba2\u6237\u7aef\u529f\u80fd\uff0c\u5305\u542b\u5907\u4efd/\u6062\u590d\u529f\u80fd\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#_18","title":"\u5168\u5c40\u5bfc\u51fa\u548c\u5bfc\u5165","text":"<pre><code>// MySQL Shell - \u903b\u8f91\u5bfc\u51fa\nvar dump = util.dumpSchemas([\"database_name\"], \"/path/to/dump\");\n\n// MySQL Shell - \u5b8c\u6574\u5b9e\u4f8b\u5bfc\u51fa\nvar dump = util.dumpInstance(\"user@host:port\", {\n  dumpDir: \"/path/to/dump\",\n  threads: 4,\n  excludeSchemas: [\"information_schema\", \"performance_schema\"],\n});\n\n// MySQL Shell - \u5bfc\u5165\nutil.loadDump(\"/path/to/dump\", { threads: 4 });\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#csv","title":"CSV \u5bfc\u51fa\u5907\u4efd","text":"<p>\u6709\u65f6\u9700\u8981\u5c06\u7279\u5b9a\u6570\u636e\u5bfc\u51fa\u4e3a CSV \u683c\u5f0f\u8fdb\u884c\u5206\u6790\u6216\u8fc1\u79fb\u3002</p>"},{"location":"mysql/Backup_Restore/backup/#select-into-outfile","title":"\u4f7f\u7528 SELECT INTO OUTFILE \u5bfc\u51fa","text":"<pre><code>-- \u57fa\u672cCSV\u5bfc\u51fa\nSELECT car_id, timestamp\nINTO OUTFILE '/tmp/mx_task_data.csv'\nFIELDS TERMINATED BY ','\nLINES TERMINATED BY '\\n'\nFROM mx_task_picture_info;\n\n-- \u5e26\u5b57\u6bb5\u5f15\u7528\u7684CSV\u5bfc\u51fa\nSELECT id, name, email\nINTO OUTFILE '/tmp/users.csv'\nFIELDS TERMINATED BY ','\nENCLOSED BY '\"'\nLINES TERMINATED BY '\\n'\nFROM users;\n\n-- \u5e26\u5217\u540d\u7684CSV\u5bfc\u51fa\uff08\u4f7f\u7528UNION\uff09\n(SELECT 'id', 'name', 'email')\nUNION\n(SELECT id, name, email\nINTO OUTFILE '/tmp/users_with_headers.csv'\nFIELDS TERMINATED BY ','\nENCLOSED BY '\"'\nLINES TERMINATED BY '\\n'\nFROM users);\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#mysql-csv","title":"\u4f7f\u7528 mysql \u547d\u4ee4\u5bfc\u51fa CSV","text":"<pre><code># \u76f4\u63a5\u4f7f\u7528mysql\u547d\u4ee4\u5bfc\u51fa\u4e3aCSV\nmysql -u root -p -e \"SELECT * FROM database_name.table_name;\" \\\n--batch --raw --silent --skip-column-names \\\n| sed 's/\\t/,/g' &gt; output.csv\n\n# \u5305\u542b\u5217\u540d\u7684\u5bfc\u51fa\nmysql -u root -p -e \"SELECT * FROM database_name.table_name;\" \\\n--batch --raw --silent --column-names \\\n| sed 's/\\t/,/g' &gt; output_with_headers.csv\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_19","title":"\u5907\u4efd\u7b56\u7565\u548c\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mysql/Backup_Restore/backup/#_20","title":"\u9009\u62e9\u5907\u4efd\u65b9\u5f0f","text":"<ol> <li> <p>\u7269\u7406\u5907\u4efd\u9002\u7528\u4e8e\uff1a</p> </li> <li> <p>\u5927\u578b\u6570\u636e\u5e93</p> </li> <li>\u5bf9\u5907\u4efd\u548c\u6062\u590d\u65f6\u95f4\u6709\u4e25\u683c\u8981\u6c42</li> <li> <p>\u9700\u8981\u8de8\u670d\u52a1\u5668\u514b\u9686</p> </li> <li> <p>\u903b\u8f91\u5907\u4efd\u9002\u7528\u4e8e\uff1a</p> </li> <li>\u8de8\u7248\u672c\u5347\u7ea7\u8fc1\u79fb</li> <li>\u5c0f\u5230\u4e2d\u578b\u6570\u636e\u5e93</li> <li>\u9700\u8981\u9009\u62e9\u6027\u6062\u590d\u7279\u5b9a\u8868</li> <li>\u9700\u8981\u7f16\u8f91\u5907\u4efd\u6587\u4ef6</li> </ol>"},{"location":"mysql/Backup_Restore/backup/#_21","title":"\u5907\u4efd\u8ba1\u5212\u5efa\u8bae","text":"<ul> <li>\u6bcf\u65e5\u57fa\u7840\u5907\u4efd\uff1a\u6267\u884c\u5b8c\u6574\u7269\u7406\u5907\u4efd</li> <li>\u6bcf\u5c0f\u65f6\u589e\u91cf\u5907\u4efd\uff1a\u8bb0\u5f55\u53d8\u5316\u6570\u636e</li> <li>\u4e8b\u52a1\u65e5\u5fd7\u5907\u4efd\uff1a\u8bb0\u5f55\u6bcf\u6761\u4e8b\u52a1</li> <li>\u5907\u4efd\u9a8c\u8bc1\uff1a\u5b9a\u671f\u9a8c\u8bc1\u5907\u4efd\u6587\u4ef6\u5b8c\u6574\u6027</li> <li>\u591a\u5730\u5907\u4efd\uff1a\u81f3\u5c11\u4e24\u4e2a\u5730\u7406\u4f4d\u7f6e\u7684\u5907\u4efd</li> </ul>"},{"location":"mysql/Backup_Restore/backup/#_22","title":"\u5907\u4efd\u5b58\u50a8\u7ba1\u7406","text":"<pre><code># \u81ea\u52a8\u5316\u5907\u4efd\u811a\u672c\n#!/bin/bash\n\nBACKUP_DIR=\"/backup/mysql\"\nDATE=$(date +%Y%m%d_%H%M%S)\nRETENTION_DAYS=7\n\n# \u521b\u5efa\u6bcf\u65e5\u5907\u4efd\u76ee\u5f55\nmkdir -p $BACKUP_DIR/daily\n\n# \u6267\u884c\u5907\u4efd\nmysqldump -u root -p --single-transaction --routines --triggers \\\n    --set-gtid-purged=ON --hex-blob --all-databases \\\n    | gzip &gt; $BACKUP_DIR/daily/backup_$DATE.sql.gz\n\n# \u6e05\u7406\u65e7\u5907\u4efd\nfind $BACKUP_DIR -name \"backup_*.sql.gz\" -mtime +$RETENTION_DAYS -delete\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_23","title":"\u5907\u4efd\u76d1\u63a7","text":"<pre><code># \u5907\u4efd\u76d1\u63a7\u811a\u672c\n#!/bin/bash\n\nBACKUP_FILE=$1\nif [ -f \"$BACKUP_FILE\" ]; then\n    FILE_SIZE=$(stat -c%s \"$BACKUP_FILE\")\n    if [ $FILE_SIZE -gt 1024 ]; then\n        echo \"Backup successful: $BACKUP_FILE ($FILE_SIZE bytes)\"\n        exit 0\n    else\n        echo \"Error: Backup file is too small, possible failure\"\n        exit 1\n    fi\nelse\n    echo \"Error: Backup file does not exist: $BACKUP_FILE\"\n    exit 1\nfi\n</code></pre>"},{"location":"mysql/Backup_Restore/backup/#_24","title":"\u5b89\u5168\u6ce8\u610f\u4e8b\u9879","text":"<ol> <li>\u5907\u4efd\u6587\u4ef6\u52a0\u5bc6\uff1a</li> </ol> <p><code>bash    # \u4f7f\u7528gzip\u52a0\u5bc6\u538b\u7f29    mysqldump -u root -p database_name | gpg --cipher-algo AES256 --compress-algo 1 --symmetric | gzip &gt; backup.gpg.gz</code></p> <ol> <li>\u5907\u4efd\u76ee\u5f55\u6743\u9650\uff1a</li> </ol> <p><code>bash    # \u4ec5\u5141\u8bb8root\u548cmysql\u7528\u6237\u8bbf\u95ee    chmod 700 /backup/mysql    chown -R mysql:mysql /backup/mysql</code></p> <ol> <li>\u7f51\u7edc\u4f20\u8f93\u52a0\u5bc6\uff1a\u4f7f\u7528 scp \u6216 sftp \u4f20\u8f93\u5907\u4efd\u6587\u4ef6</li> </ol>"},{"location":"mysql/Backup_Restore/backup/#_25","title":"\u91cd\u8981\u751f\u4ea7\u73af\u5883\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"mysql/Backup_Restore/backup/#gtid","title":"GTID \u76f8\u5173\u95ee\u9898","text":"<p>\u6ce8\u610f\uff1a<code>--set-gtid-purged</code> \u53c2\u6570\u53ef\u80fd\u4ea7\u751f\u98ce\u9669</p> <p>\u4f7f\u7528 <code>--set-gtid-purged=ON</code> \u53c2\u6570\u4f1a\u4ea7\u751f <code>SET @@SESSION.SQL_LOG_BIN=0;</code> \u548c\u76f8\u5173 GTID \u91cd\u7f6e\u8bed\u53e5\uff0c\u5728 MySQL Group Replication (MGR) \u73af\u5883\u4e2d\u53ef\u80fd\u5bfc\u81f4\u4e3b\u4ece\u4e0d\u4e00\u81f4\u95ee\u9898\u3002</p> <ul> <li>\u5728 MGR \u73af\u5883\u4e2d\uff1a\u4e0d\u8981\u4f7f\u7528 <code>--set-gtid-purged=ON</code> \u9664\u975e\u660e\u786e\u77e5\u9053\u81ea\u5df1\u5728\u505a\u4ec0\u4e48</li> <li>\u66ff\u4ee3\u65b9\u6848\uff1a\u5728\u9ad8\u53ef\u7528\u73af\u5883\u4e0b\u5e94\u4f7f\u7528 <code>--set-gtid-purged=OFF</code> \u6216\u5b8c\u5168\u4e0d\u4f7f\u7528\u6b64\u53c2\u6570</li> <li>\u95ee\u9898\u73b0\u8c61\uff1a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u9047\u5230\u8fc7\u4f7f\u7528 <code>--set-gtid-purged</code> \u4f1a\u5728\u6062\u590d\u540e\u751f\u6210 <code>SET @@SESSION.SQL_LOG_BIN=0</code> \u8fd9\u7c7b\u8bed\u53e5\uff0c\u5bfc\u81f4\u590d\u5236\u94fe\u8def\u4e2d\u65ad\uff0c\u9020\u6210\u4e3b\u4ece\u4e0d\u4e00\u81f4</li> <li>\u5b89\u5168\u6062\u590d\u65b9\u5f0f\uff1a\u5bf9\u4e8e\u96c6\u7fa4\u73af\u5883\uff0c\u5e94\u5f53\u9884\u5148\u89c4\u5212\u6062\u590d\u8fc7\u7a0b\uff0c\u5e76\u5728\u6062\u590d\u524d\u540e\u9a8c\u8bc1\u590d\u5236\u72b6\u6001</li> </ul> <p>\u793a\u4f8b\u5b89\u5168\u7684\u5907\u4efd\u547d\u4ee4\uff1a</p> <pre><code># \u9488\u5bf9 MGR \u6216\u590d\u5236\u73af\u5883\u7684\u5b89\u5168\u5907\u4efd\nmysqldump -u root -p --single-transaction --master-data=2 \\\n    --routines --triggers --hex-blob \\\n    --default-character-set=utf8mb4 --all-databases &gt; backup.sql\n\n# \u6062\u590d\u524d\u9700\u8981\u68c0\u67e5\u590d\u5236\u72b6\u6001\nSHOW SLAVE STATUS\\G\n# \u6216\u9488\u5bf9 MGR\nSHOW STATUS LIKE '%group_replication%';\n</code></pre>"},{"location":"mysql/changelog/","title":"Index","text":"<p>change log index </p>"},{"location":"mysql/changelog/pro1/","title":"Pro1","text":""},{"location":"mysql/changelog/pro1/#1","title":"\u95ee\u98981","text":"<p>\u5ba2\u6237\u7aef\u9519\u8bef Error: 2005 (HY000): Unknown MySQL server host 'localhost' (-11) Error: 2005 (HY000): Unknown MySQL server host 'localhost' (-11) Error: 2005 (HY000): Unknown MySQL server host 'localhost' (-11) mysql\u670d\u52a1  |4508 | unauthenticated user | localhost:38414 | NULL | Connect |    1 | login                  | NULL             | |24509 | unauthenticated user | localhost:38418 | NULL | Connect |    1 | login                  | NULL            |</p> <p>mysql\u914d\u7f6e max_connections back_log=2000 \u670d\u52a1\u5668 ulimit -n net.ipv4.tcp_max_syn_backlog</p>"},{"location":"mysql/changelog/pro1/#2","title":"\u95ee\u98982","text":"<p>router \u8fde\u63a5\u6570</p>"},{"location":"mysql/changelog/pro1/#ssl-version","title":"ssl version","text":"<p>Error: 2026 (HY000): connecting to destination failed with TLS error: error:0A00010B:SSL routines::wrong version number Error: 2026 (HY000): connecting to destination failed with TLS error: error:0A00010B:SSL routines::wrong version number</p> <pre><code>sudo apt-get update\nsudo apt-get install --only-upgrade openssl\n</code></pre>"},{"location":"mysql/changelog/pro1/#mysql","title":"mysql \u5b89\u88c5 \u6362\u5b58\u50a8\u76ee\u5f55","text":"<pre><code>sudo ln -s /etc/apparmor.d/usr.sbin.mysqld /etc/apparmor.d/disable/\nsudo apparmor_parser -R /etc/apparmor.d/usr.sbin.mysqld\n</code></pre> <p>innodb_log_writer_threads   ON innodb_lru_scan_depth   1024 innodb_sort_buffer_size 1048576 innodb_write_io_threads 16 max_insert_delayed_threads  20 thread_cache_size   200 thread_handling one-thread-per-connection thread_stack    1048576 innodb_thread_concurrency   0 innodb_buffer_pool_chunk_size   134217728 innodb_buffer_pool_dump_at_shutdown ON innodb_buffer_pool_dump_now OFF innodb_buffer_pool_dump_pct 25 innodb_buffer_pool_filename ib_buffer_pool innodb_buffer_pool_in_core_file ON innodb_buffer_pool_instances    8 innodb_buffer_pool_load_abort   OFF innodb_buffer_pool_load_at_startup  ON innodb_buffer_pool_load_now OFF innodb_buffer_pool_size 22548578304</p> <pre><code>create database mx1;\ncreate user 'user1'@'%' identified by '123456';\ngrant all on mx1.* to 'user1'@'%';\nflush PRIVILEGES;\n</code></pre> <pre><code>SET NAMES utf8mb4;\nSET FOREIGN_KEY_CHECKS = 0;\n\n-- ----------------------------\n-- Table structure for te_activate_info\n-- ----------------------------\nDROP TABLE IF EXISTS `te_activate_info`;\nCREATE TABLE `te_activate_info` (\n  `id` varchar(32) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,\n  `product_id` varchar(32) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,\n  `device_no` varchar(32) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,\n  `soft_ver` varchar(64) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,\n  `act_code` varchar(32) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,\n  `timeStamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  `brd_source` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT '\u6765\u6e90',\n  PRIMARY KEY (`id`) USING BTREE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 ROW_FORMAT=DYNAMIC;\n\nSET FOREIGN_KEY_CHECKS = 1;\n</code></pre> <pre><code>echo `date` &amp;&amp; mysql -uuser1 -p123456 mx1 &lt; /tmp/insert_te_activate_info.sql &amp;&amp; echo `date`;\n</code></pre> <pre><code>pip install mysql-connector-python\n</code></pre> <pre><code>import mysql.connector\nfrom mysql.connector import errorcode\nimport uuid\nimport random\nimport string\nimport time\nfrom datetime import datetime\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\nfrom mysql.connector import pooling\n\n# \u6570\u636e\u5e93\u8fde\u63a5\u914d\u7f6e\nconfig = {\n  'user': 'mysql',\n  'password': '123456',\n  'host': '10.43.243.140',\n  'database': 'mx1',\n  'pool_name': 'mypool',\n  'pool_size': 32\n}\n\n# \u751f\u6210\u968f\u673a\u5b57\u7b26\u4e32\ndef random_string(length):\n    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))\n\n\ncnxpool = mysql.connector.pooling.MySQLConnectionPool(**config)\n# \u751f\u6210\u968f\u673a\u5b57\u7b26\u4e32\ndef random_string(length):\n    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))\n\n\ncnxpool = mysql.connector.pooling.MySQLConnectionPool(**config)\n\n# \u63d2\u5165\u4e00\u6761\u6570\u636e\ndef insert_data():\n    try:\n#        cnx = mysql.connector.connect(**config, ssl_disabled=False)\n        cnx = cnxpool.get_connection()\n        cursor = cnx.cursor()\n        id = str(uuid.uuid4()).replace('-', '')\n        product_id = random_string(32)\n        device_no = random_string(32)\n        soft_ver = random_string(64)\n        act_code = random_string(32)\n        brd_source = random_string(255)\n\n        insert_sql = \n        INSERT INTO te_activate_info (id, product_id, device_no, soft_ver, act_code, brd_source)\n        VALUES (%s, %s, %s, %s, %s, %s)\n\n        cursor.execute(insert_sql, (id, product_id, device_no, soft_ver, act_code, brd_source))\n        cnx.commit()\n        cursor.close()\n        cnx.close()\n    except mysql.connector.Error as err:\n        print(fError: {err})\n\n# \u8bb0\u5f55\u5f00\u59cb\u65f6\u95f4\nstart_time = time.time()\n\n# \u5e76\u53d1\u63d2\u5165\u6570\u636e\nnum_records = 1000\nlog_interval = 100\nwith ThreadPoolExecutor(max_workers=10) as executor:\n    futures = [executor.submit(insert_data) for _ in range(num_records)]\n    for i, future in enumerate(as_completed(futures)):\n        if (i + 1) % log_interval == 0:\n            current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n            print(f'Inserted {(i + 1)} records at {current_time}')\n\n# \u8bb0\u5f55\u7ed3\u675f\u65f6\u95f4\nend_time = time.time()\ntotal_time = end_time - start_time\n\nprint(fData insertion completed in {total_time:.2f} seconds.)\n</code></pre> <p>https://lore.kernel.org/all/9d59af25-d648-4777-a5c0-c38c246a9610@ewheeler.net/T/</p> <p>https://juju.is/blog/using-bcache-for-performance-gains-on-the-launchpad-database-servers</p>"},{"location":"mysql/changelog/pro1/#_1","title":"\u53c2\u6570\u5bf9\u6bd4","text":"<p>binlog_transaction_dependency_tracking: \u914d\u7f6e\u6587\u4ef61 = COMMIT_ORDER, \u914d\u7f6e\u6587\u4ef62 = WRITESET slow_query_log: \u914d\u7f6e\u6587\u4ef61 = ON, \u914d\u7f6e\u6587\u4ef62 = OFF log_output: \u914d\u7f6e\u6587\u4ef61 = TABLE, \u914d\u7f6e\u6587\u4ef62 = FILE long_query_time: \u914d\u7f6e\u6587\u4ef61 = 3.000000, \u914d\u7f6e\u6587\u4ef62 = 10.000000 max_connections: \u914d\u7f6e\u6587\u4ef61 = 20000, \u914d\u7f6e\u6587\u4ef62 = 1000 binlog_expire_logs_seconds: \u914d\u7f6e\u6587\u4ef61 = 0, \u914d\u7f6e\u6587\u4ef62 = 2592000 innodb_open_files: \u914d\u7f6e\u6587\u4ef61 = 65535, \u914d\u7f6e\u6587\u4ef62 = 4000 net_buffer_length: \u914d\u7f6e\u6587\u4ef61 = 8192, \u914d\u7f6e\u6587\u4ef62 = 16384 lower_case_table_names: \u914d\u7f6e\u6587\u4ef61 = 1, \u914d\u7f6e\u6587\u4ef62 = 0</p> <p>innodb_log_file_size: \u914d\u7f6e\u6587\u4ef61 = 1073741824, \u914d\u7f6e\u6587\u4ef62 = 50331648 innodb_page_cleaners: \u914d\u7f6e\u6587\u4ef61 = 4, \u914d\u7f6e\u6587\u4ef62 = 1</p>"},{"location":"mysql/changelog/pro1/#read-only","title":"#### READ ONLY","text":"<p>innodb_temp_data_file_path: \u914d\u7f6e\u6587\u4ef61 = ibtmp1:12M:autoextend:max:10G, \u914d\u7f6e\u6587\u4ef62 = ibtmp1:12M:autoextend     innodb_data_file_path: \u914d\u7f6e\u6587\u4ef61 = ibdata1:100M:autoextend, \u914d\u7f6e\u6587\u4ef62 = ibdata1:12M:autoextend   </p> <p>innodb_read_io_threads: \u914d\u7f6e\u6587\u4ef61 = 16, \u914d\u7f6e\u6587\u4ef62 = 4         \u6838\u6570*2                            innodb_write_io_threads: \u914d\u7f6e\u6587\u4ef61 = 16, \u914d\u7f6e\u6587\u4ef62 = 4                                        secure_file_priv: \u914d\u7f6e\u6587\u4ef61 = /data/mysql/tmp/, \u914d\u7f6e\u6587\u4ef62 = NULL                              innodb_buffer_pool_instances: \u914d\u7f6e\u6587\u4ef61 = 8, \u914d\u7f6e\u6587\u4ef62 = 1                                                           open_files_limit: \u914d\u7f6e\u6587\u4ef61 = 2000000, \u914d\u7f6e\u6587\u4ef62 = 1048576                                    performance_schema_max_table_instances: \u914d\u7f6e\u6587\u4ef61 = 200, \u914d\u7f6e\u6587\u4ef62 = -1</p>"},{"location":"mysql/changelog/pro1/#_2","title":"####  \u52a8\u6001\u4fee\u6539","text":"<p>local_infile=ON innodb_io_capacity=2000 innodb_io_capacity_max=3000 max_connect_errors=1000000 thread_cache_size=200</p> <p>innodb_buffer_pool_size=</p> <p>read_buffer_size: \u914d\u7f6e\u6587\u4ef61 = 262144, \u914d\u7f6e\u6587\u4ef62 = 131072 read_rnd_buffer_size: \u914d\u7f6e\u6587\u4ef61 = 524288, \u914d\u7f6e\u6587\u4ef62 = 262144 innodb_buffer_pool_size: \u914d\u7f6e\u6587\u4ef61 = 22548578304, \u914d\u7f6e\u6587\u4ef62 = 134217728  \u5185\u5b58\u7684 50%-75% sort_buffer_size: \u914d\u7f6e\u6587\u4ef61 = 524288, \u914d\u7f6e\u6587\u4ef62 = 262144</p>"},{"location":"mysql/changelog/pro1/#1-io","title":"\u95ee\u98981 IO","text":""},{"location":"mysql/changelog/pro1/#_3","title":"\u95ee\u9898 \u7f51\u7edc\u5ef6\u8fdf","text":"<p>\u5f53\u7136\uff0c\u4efb\u4f55\u597d\u4e1c\u897f\u90fd\u6709\u4ee3\u4ef7\u3002\u4f7f\u7528MGR single primary\u6a21\u5f0f\u6bd4\u4f20\u7edf\u7684binlog\u590d\u5236\u6a21\u5f0f\u7684\u6027\u80fd\u5f00\u9500\u548c\u5ef6\u65f6\u7565\u5927\uff0c\u5e76\u4e14\u6709\u4e00\u4e9b\u529f\u80fd\u7ea6\u675f\u3002\u8fd9\u4e9b\u989d\u5916\u5f00\u9500\u4e3b\u8981\u662f\u56e0\u4e3acertify\u8fc7\u7a0b\u5bfc\u81f4\u7684\u2014\u9664\u4e86\u9700\u8981\u4f20\u8f93\u4e8b\u52a1\u7684binlog\u4e4b\u5916\uff0ccertify\u5728\u4e3b\u8282\u70b9\u4e0a\u8fd8\u9700\u8981\u8ba1\u7b97\u548c\u4f20\u8f93write set\uff0cslave\u7aef\u9700\u8981\u63a5\u6536\u548c\u5b58\u50a8write set\uff08\u5373\u4f7f\u5355\u4e3b\u6a21\u5f0f\u4e5f\u9700\u8981\u8ba1\u7b97\uff0c\u4f20\u8f93\u548c\u5b58\u50a8write set\uff09\uff1b\u53e6\u5916\u8fd8\u6709paxos\u534f\u8bae\u8fd0\u884c\u5bfc\u81f4\u7684\u989d\u5916\u7684\u7f51\u7edc\u5ef6\u65f6\uff0c\u8fd9\u90e8\u5206\u5ef6\u65f6\u4f1a\u5bfc\u81f4\u6bcf\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u7684\u5ef6\u65f6\u7565\u5927\u3002\u5e76\u4e14\u4e3a\u4e86\u4fdd\u6301MGR\u7684\u9ad8\u6027\u80fd\uff0c\u8981\u6c42\u534a\u6570\u7684\u5907\u673a\u5fc5\u987b\u4e0e\u4e3b\u673a\u540c\u673a\u623f\uff0c\u5426\u5219paxos\u534f\u8bae\u5bfc\u81f4\u7684\u5ef6\u65f6\u4f1a\u66f4\u5927 \u2014 \u5f53\u7136\uff0c\u8fd9\u4e2a\u8981\u6c42\u5e76\u4e0d\u7b97\u8fc7\u5206\u3002</p> <p>https://www.modb.pro/db/390294</p>"},{"location":"mysql/changelog/pro2/","title":"Pro2","text":""},{"location":"mysql/changelog/pro2/#public-key-retrieval-is-not-allowed","title":"Public Key Retrieval is not allowed","text":"<p>\u89e3\u51b3 java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed \u9519\u8bef</p> <p>\u5728\u4f7f\u7528 MySQL 8.0 \u6216\u66f4\u9ad8\u7248\u672c\u65f6\uff0c\u53ef\u80fd\u4f1a\u9047\u5230\u4ee5\u4e0b\u9519\u8bef\uff1ajava.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed \u8fd9\u662f\u56e0\u4e3a MySQL 8.0 \u9ed8\u8ba4\u542f\u7528\u4e86 caching_sha2_password \u63d2\u4ef6\uff0c\u800c JDBC \u9a71\u52a8\u9ed8\u8ba4\u4e0d\u5141\u8bb8\u68c0\u7d22\u516c\u94a5\u3002\u4ee5\u4e0b\u662f\u51e0\u79cd\u5e38\u89c1\u7684\u89e3\u51b3\u65b9\u6cd5\uff1a \u89e3\u51b3\u65b9\u6848\u4e00\uff1a\u4fee\u6539\u6570\u636e\u5e93\u8fde\u63a5\u5b57\u7b26\u4e32</p> <p>\u5728 JDBC \u8fde\u63a5 URL \u4e2d\u6dfb\u52a0 allowPublicKeyRetrieval=true \u53c2\u6570\uff1a</p> <p>jdbc:mysql://localhost:3306/your_database?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=UTC</p> <pre><code>1\n\nallowPublicKeyRetrieval=true\uff1a\u5141\u8bb8\u68c0\u7d22\u516c\u94a5\u3002\nuseSSL=false\uff1a\u7981\u7528 SSL\uff0c\u89c6\u9700\u6c42\u800c\u5b9a\u3002\n</code></pre> <p>\u89e3\u51b3\u65b9\u6848\u4e8c\uff1a\u4fee\u6539 MySQL \u7528\u6237\u8ba4\u8bc1\u63d2\u4ef6</p> <p>ALTER USER 'your_user'@'your_host' IDENTIFIED WITH mysql_native_password BY 'your_password';</p> <pre><code>1\n</code></pre> <p>\u89e3\u51b3\u65b9\u6848\u4e09\uff1a\u66f4\u65b0 MySQL JDBC \u9a71\u52a8</p> <p>\u786e\u4fdd\u4f7f\u7528\u6700\u65b0\u7248\u7684 MySQL JDBC \u9a71\u52a8\uff0c\u4ee5\u907f\u514d\u4e0e MySQL 8.0 \u7684\u8ba4\u8bc1\u65b9\u5f0f\u4e0d\u517c\u5bb9 Maven \u793a\u4f8b\uff1a</p> <p> mysql mysql-connector-java 8.0.30 </p> <p>\u603b\u7ed3</p> <pre><code>\u5982\u679c\u4e0d\u60f3\u4fee\u6539\u8ba4\u8bc1\u63d2\u4ef6\uff0c\u4f7f\u7528 allowPublicKeyRetrieval=true \u89e3\u51b3\u95ee\u9898\u3002\n\u53ef\u4ee5\u4fee\u6539\u7528\u6237\u8ba4\u8bc1\u63d2\u4ef6\u4e3a mysql_native_password\uff0c\u6216\u66f4\u65b0 JDBC \u9a71\u52a8\u3002\n</code></pre>"},{"location":"mysql/changelog/upgrade/","title":"Upgrade","text":"<p>upgrade</p>"},{"location":"mysql/procase/mgr/","title":"\u7ec4\u590d\u5236\u964d\u7ea7","text":""},{"location":"mysql/procase/mgr/#_2","title":"\u4ece\u5e93\u65e5\u5fd7","text":"<p>2025-10-15T05:32:35.796578-00:00 15 [ERROR] [MY-010584] [Repl] Replica SQL for channel 'group_replication_applier': Worker 1 failed executing transaction '928237fa-a63a-11f0-9468-ca3f25023d79:248969'; Could not execute Update_rows event on table xxx; Can't find record in 'xxx', Error_code: 1032; handler error HA_ERR_KEY_NOT_FOUND, Error_code: MY-001032 2025-10-15T05:32:35.796755-00:00 14 [Warning] [MY-010584] [Repl] Replica SQL for channel 'group_replication_applier': ... The replica coordinator and worker threads are stopped, possibly leaving data in inconsistent state. A restart should restore consistency automatically, although using non-transactional storage for data or info tables or DDL queries could lead to problems. In such cases you have to examine your data (see documentation for details). Error_code: MY-001756 2025-10-15T05:32:35.796826-00:00 14 [ERROR] [MY-011451] [Repl] Plugin group_replication reported: 'The applier thread execution was aborted. Unable to process more transactions, this member will now leave the group.' 2025-10-15T05:32:35.796924-00:00 12 [ERROR] [MY-011452] [Repl] Plugin group_replication reported: 'Fatal error during execution on the Applier process of Group Replication. The server will now leave the group.' 2025-10-15T05:32:35.797160-00:00 12 [ERROR] [MY-011712] [Repl] Plugin group_replication reported: 'The server was automatically set into read only mode after an error was detected.' 2025-10-15T05:32:35.797290-00:00 12 [System] [MY-011565] [Repl] Plugin group_replication reported: 'Setting super_read_only=ON.' 2025-10-15T05:32:41.560786-00:00 0 [System] [MY-011504] [Repl] Plugin group_replication reported: 'Group membership changed: This member has left the group.'</p>"},{"location":"mysql/procase/mgr/#_3","title":"\u4e3b\u5e93\u65e5\u5fd7","text":"<p>2025-10-15T05:32:36.986976-00:00 0 [Warning] [MY-011499] [Repl] Plugin group_replication reported: 'Members removed from the group: mgr-2:3306, mgr-1:3306' 2025-10-15T05:32:36.987107-00:00 0 [System] [MY-011503] [Repl] Plugin group_replication reported: 'Group membership changed to mgr-0:3306 on view 17601430949724618:8.'</p>"},{"location":"mysql/procase/mgr/#binlog","title":"\u4e3b\u5e93 binlog \u65e5\u5fd7","text":"<p>mysqlbinlog --no-defaults --base64-output=decode-rows --include-gtids='928237fa-a63a-11f0-9468-ca3f25023d79:248969' mysql-bin.000003 &gt; /tmp/fatal_transaction1.sql</p> <p>grep -A 15 \"alert_dispose_rule_config\" /tmp/fatal_transaction1.sql</p>"},{"location":"mysql/procase/mgr/#_4","title":"\u5206\u6790","text":"<p>\u9519\u8bef\u63d0\u793a\uff0c\u5728\u66f4\u65b0\u7684\u65f6\u5019\u4ece\u5e93\u6ca1\u6709\u5bf9\u5e94\u7684\u8bb0\u5f55\u3002\u67e5\u770b\uff0c\u4e3b\u4ece\u6570\u636e\u5e93\u8868\uff0c\u53d1\u73b0\u6570\u636e\u4e0d\u4e00\u81f4\u3002 \u8fdb\u4e00\u6b65\u67e5\u770b\u4e3b\u5e93\u65e5\u5fd7\u3002 \u53d1\u73b0\u53ea\u6709\u521b\u5efa\u8868\u548c\u53d1\u751f\u9519\u8bef\u65f6\u7684\u66f4\u65b0\u8bb0\u5f55\u3002\u6ca1\u6709\u6570\u636e\u63d2\u5165\u8bb0\u5f55\u3002</p> <p>\u6839\u672c\u539f\u56e0\u3002\u5728\u6570\u636e\u63d2\u5165\u7684\u65f6\u5019\u7f3a\u5931 binlog \u8bb0\u5f55\u3002</p> <p>\u5f15\u8d77\u8fd9\u79cd\u60c5\u51b5\u7684\u539f\u56e0\u3002</p>"},{"location":"mysql/replication/","title":"\u4e3b\u4ece\u590d\u5236\u4ecb\u7ecd","text":""},{"location":"mysql/replication/#_2","title":"\u5f02\u6b65\u590d\u5236","text":""},{"location":"mysql/replication/#_3","title":"\u540c\u6b65\u590d\u5236","text":""},{"location":"mysql/replication/#_4","title":"\u534a\u540c\u6b65\u590d\u5236","text":""},{"location":"mysql/replication/replication/","title":"\u5f02\u6b65\u590d\u5236","text":"<p>MySQL \u4e3b\u4ece\u590d\u5236\u642d\u5efa\u8fd0\u7ef4\u6587\u6863</p> <p>\u672c\u6587\u6863\u8be6\u7ec6\u4ecb\u7ecd\u4e86\u5728 MySQL 8.0 \u7248\u672c\u4e0b\uff0c\u5982\u4f55\u5728 Ubuntu Linux \u670d\u52a1\u5668\u4e0a\u642d\u5efa\u4e3b\u4ece\u590d\u5236\u73af\u5883\u3002\u6587\u6863\u6db5\u76d6\u4ee5\u4e0b\u4e09\u79cd\u65b9\u5f0f\uff1a</p> <pre><code>\u539f\u59cb\u65b9\u5f0f\uff08\u57fa\u4e8e\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u590d\u5236\uff09\n\nGTID \u65b9\u5f0f\uff08\u57fa\u4e8e\u5168\u5c40\u4e8b\u52a1\u6807\u8bc6\u7b26\u7684\u590d\u5236\uff09\n\nClone \u63d2\u4ef6\u65b9\u5f0f\uff08MySQL 8.0 \u65b0\u589e\u7684\u514b\u9686\u63d2\u4ef6\uff09\n</code></pre> <p>\u6bcf\u79cd\u65b9\u5f0f\u5747\u8003\u8651\u4e3b\u5e93\u5df2\u6709\u5386\u53f2\u6570\u636e\u7684\u60c5\u51b5\uff0c\u5e76\u63d0\u4f9b\u8be6\u7ec6\u7684\u64cd\u4f5c\u6b65\u9aa4\u3002 \u73af\u5883\u51c6\u5907</p> <pre><code>\u64cd\u4f5c\u7cfb\u7edf\uff1aUbuntu 20.04 LTS\n\nMySQL \u7248\u672c\uff1a8.0.x\n\n\u4e3b\u5e93 IP\uff1a192.168.1.100\n\n\u4ece\u5e93 IP\uff1a192.168.1.101\n\n\u590d\u5236\u7528\u6237\uff1arepl\n\n\u590d\u5236\u7528\u6237\u5bc6\u7801\uff1arepl_password\n</code></pre> <ol> <li> <p>\u539f\u59cb\u65b9\u5f0f\uff1a\u57fa\u4e8e\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u590d\u5236 1.1 \u4e3b\u5e93\u914d\u7f6e</p> <p>\u7f16\u8f91 MySQL \u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>\u6253\u5f00\u914d\u7f6e\u6587\u4ef6\uff1a\nbash\n\u590d\u5236\n\nsudo nano /etc/mysql/mysql.conf.d/mysqld.cnf\n\n\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\nini\n\u590d\u5236\n\n[mysqld]\nserver_id = 1\nlog_bin = /var/log/mysql/mysql-bin.log\nbinlog_format = ROW\n\n\u91cd\u542f MySQL \u670d\u52a1\uff1a\nbash\n\u590d\u5236\n\nsudo systemctl restart mysql\n</code></pre> <p>\u521b\u5efa\u590d\u5236\u7528\u6237\uff1a</p> <pre><code>\u767b\u5f55 MySQL\uff1a\nbash\n\u590d\u5236\n\nmysql -u root -p\n\n\u521b\u5efa\u7528\u6237\u5e76\u6388\u6743\uff1a\nsql\n\u590d\u5236\n\nCREATE USER 'repl'@'%' IDENTIFIED BY 'repl_password';\nGRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';\nFLUSH PRIVILEGES;\n</code></pre> <p>\u5907\u4efd\u4e3b\u5e93\u6570\u636e\uff1a</p> <pre><code>\u4f7f\u7528 mysqldump \u5907\u4efd\u6570\u636e\uff1a\nbash\n\u590d\u5236\n\nmysqldump --all-databases --master-data=2 --single-transaction &gt; master_dump.sql\n\n\u5c06\u5907\u4efd\u6587\u4ef6\u4f20\u8f93\u5230\u4ece\u5e93\uff1a\nbash\n\u590d\u5236\n\nscp master_dump.sql user@192.168.1.101:/tmp/\n</code></pre> </li> </ol> <p>1.2 \u4ece\u5e93\u914d\u7f6e</p> <pre><code>\u7f16\u8f91 MySQL \u914d\u7f6e\u6587\u4ef6\uff1a\n\n    \u6253\u5f00\u914d\u7f6e\u6587\u4ef6\uff1a\n    bash\n    \u590d\u5236\n\n    sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf\n\n    \u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\n    ini\n    \u590d\u5236\n\n    [mysqld]\n    server_id = 2\n    relay_log = /var/log/mysql/mysql-relay-bin.log\n    read_only = 1\n\n    \u91cd\u542f MySQL \u670d\u52a1\uff1a\n    bash\n    \u590d\u5236\n\n    sudo systemctl restart mysql\n\n\u6062\u590d\u4e3b\u5e93\u6570\u636e\uff1a\n\n    \u767b\u5f55 MySQL\uff1a\n    bash\n    \u590d\u5236\n\n    mysql -u root -p &lt; /tmp/master_dump.sql\n\n\u914d\u7f6e\u4e3b\u5e93\u8fde\u63a5\u4fe1\u606f\uff1a\n\n    \u767b\u5f55 MySQL\uff1a\n    bash\n    \u590d\u5236\n\n    mysql -u root -p\n\n    \u67e5\u770b\u5907\u4efd\u6587\u4ef6\u4e2d\u7684 MASTER_LOG_FILE \u548c MASTER_LOG_POS\uff1a\n    bash\n    \u590d\u5236\n\n    head -n 50 /tmp/master_dump.sql | grep \"CHANGE MASTER TO\"\n\n    \u914d\u7f6e\u4e3b\u5e93\u4fe1\u606f\uff1a\n    sql\n    \u590d\u5236\n\n    CHANGE MASTER TO\n    MASTER_HOST='192.168.1.100',\n    MASTER_USER='repl',\n    MASTER_PASSWORD='repl_password',\n    MASTER_LOG_FILE='mysql-bin.000001',  -- \u66ff\u6362\u4e3a\u5b9e\u9645\u503c\n    MASTER_LOG_POS=1234;                 -- \u66ff\u6362\u4e3a\u5b9e\u9645\u503c\n\n\u542f\u52a8\u590d\u5236\uff1a\nsql\n\u590d\u5236\n\nSTART SLAVE;\n\n\u68c0\u67e5\u590d\u5236\u72b6\u6001\uff1a\nsql\n\u590d\u5236\n\nSHOW SLAVE STATUS\\G\n\n    \u786e\u4fdd Slave_IO_Running \u548c Slave_SQL_Running \u90fd\u4e3a Yes\u3002\n</code></pre> <ol> <li> <p>GTID \u65b9\u5f0f\uff1a\u57fa\u4e8e\u5168\u5c40\u4e8b\u52a1\u6807\u8bc6\u7b26\u7684\u590d\u5236 2.1 \u4e3b\u5e93\u914d\u7f6e</p> <p>\u7f16\u8f91 MySQL \u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\nini\n\u590d\u5236\n\n[mysqld]\nserver_id = 1\nlog_bin = /var/log/mysql/mysql-bin.log\nbinlog_format = ROW\ngtid_mode = ON\nenforce_gtid_consistency = ON\n\n\u91cd\u542f MySQL \u670d\u52a1\uff1a\nbash\n\u590d\u5236\n\nsudo systemctl restart mysql\n</code></pre> <p>\u521b\u5efa\u590d\u5236\u7528\u6237\uff1a</p> <pre><code>\u540c\u539f\u59cb\u65b9\u5f0f\u3002\n</code></pre> <p>\u5907\u4efd\u4e3b\u5e93\u6570\u636e\uff1a</p> <pre><code>\u4f7f\u7528 mysqldump \u5907\u4efd\u6570\u636e\uff1a\nbash\n\u590d\u5236\n\nmysqldump --all-databases --set-gtid-purged=ON --single-transaction &gt; master_dump.sql\n\n\u5c06\u5907\u4efd\u6587\u4ef6\u4f20\u8f93\u5230\u4ece\u5e93\uff1a\nbash\n\u590d\u5236\n\nscp master_dump.sql user@192.168.1.101:/tmp/\n</code></pre> </li> </ol> <p>2.2 \u4ece\u5e93\u914d\u7f6e</p> <pre><code>\u7f16\u8f91 MySQL \u914d\u7f6e\u6587\u4ef6\uff1a\n\n    \u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\n    ini\n    \u590d\u5236\n\n    [mysqld]\n    server_id = 2\n    relay_log = /var/log/mysql/mysql-relay-bin.log\n    read_only = 1\n    gtid_mode = ON\n    enforce_gtid_consistency = ON\n\n    \u91cd\u542f MySQL \u670d\u52a1\uff1a\n    bash\n    \u590d\u5236\n\n    sudo systemctl restart mysql\n\n\u6062\u590d\u4e3b\u5e93\u6570\u636e\uff1a\n\n    \u540c\u539f\u59cb\u65b9\u5f0f\u3002\n\n\u914d\u7f6e\u4e3b\u5e93\u8fde\u63a5\u4fe1\u606f\uff1a\n\n    \u767b\u5f55 MySQL\uff1a\n    bash\n    \u590d\u5236\n\n    mysql -u root -p\n\n    \u914d\u7f6e\u4e3b\u5e93\u4fe1\u606f\uff1a\n    sql\n    \u590d\u5236\n\n    CHANGE MASTER TO\n    MASTER_HOST='192.168.1.100',\n    MASTER_USER='repl',\n    MASTER_PASSWORD='repl_password',\n    MASTER_AUTO_POSITION=1;\n\n\u542f\u52a8\u590d\u5236\uff1a\nsql\n\u590d\u5236\n\nSTART SLAVE;\n\n\u68c0\u67e5\u590d\u5236\u72b6\u6001\uff1a\nsql\n\u590d\u5236\n\nSHOW SLAVE STATUS\\G\n\n    \u786e\u4fdd Slave_IO_Running \u548c Slave_SQL_Running \u90fd\u4e3a Yes\u3002\n</code></pre> <ol> <li> <p>Clone \u63d2\u4ef6\u65b9\u5f0f\uff1a\u57fa\u4e8e\u514b\u9686\u63d2\u4ef6\u7684\u590d\u5236 3.1 \u4e3b\u5e93\u914d\u7f6e</p> <p>\u5b89\u88c5 Clone \u63d2\u4ef6\uff1a</p> <pre><code>\u767b\u5f55 MySQL\uff1a\nbash\n\u590d\u5236\n\nmysql -u root -p\n\n\u5b89\u88c5\u63d2\u4ef6\uff1a\nsql\n\u590d\u5236\n\nINSTALL PLUGIN clone SONAME 'mysql_clone.so';\n</code></pre> <p>\u521b\u5efa\u590d\u5236\u7528\u6237\uff1a</p> <pre><code>\u540c\u539f\u59cb\u65b9\u5f0f\u3002\n</code></pre> </li> </ol> <p>3.2 \u4ece\u5e93\u914d\u7f6e</p> <pre><code>\u5b89\u88c5 Clone \u63d2\u4ef6\uff1a\n\n    \u767b\u5f55 MySQL\uff1a\n    bash\n    \u590d\u5236\n\n    mysql -u root -p\n\n    \u5b89\u88c5\u63d2\u4ef6\uff1a\n    sql\n    \u590d\u5236\n\n    INSTALL PLUGIN clone SONAME 'mysql_clone.so';\n\n\u514b\u9686\u4e3b\u5e93\u6570\u636e\uff1a\n\n    \u767b\u5f55 MySQL\uff1a\n    bash\n    \u590d\u5236\n\n    mysql -u root -p\n\n    \u6267\u884c\u514b\u9686\u64cd\u4f5c\uff1a\n    sql\n    \u590d\u5236\n\n    CLONE INSTANCE FROM 'repl'@'192.168.1.100' IDENTIFIED BY 'repl_password';\n\n\u914d\u7f6e\u4e3b\u5e93\u8fde\u63a5\u4fe1\u606f\uff1a\n\n    \u540c GTID \u65b9\u5f0f\u3002\n\n\u542f\u52a8\u590d\u5236\uff1a\nsql\n\u590d\u5236\n\nSTART SLAVE;\n\n\u68c0\u67e5\u590d\u5236\u72b6\u6001\uff1a\nsql\n\u590d\u5236\n\nSHOW SLAVE STATUS\\G\n\n    \u786e\u4fdd Slave_IO_Running \u548c Slave_SQL_Running \u90fd\u4e3a Yes\u3002\n</code></pre>"},{"location":"mysql/replication/semisync/","title":"\u534a\u540c\u6b65","text":""},{"location":"postgres/","title":"\ud83d\udc18 PostgreSQL \u4e13\u4e1a\u6587\u6863\u4e2d\u5fc3","text":"\u5f00\u6e90\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u7684\u4e16\u754c\u6807\u51c6 <p>\u9ad8\u6027\u80fd \u2022 \u9ad8\u53ef\u9760 \u2022 \u9ad8\u6269\u5c55 </p>"},{"location":"postgres/#_1","title":"\ud83d\udcda \u5feb\u901f\u5bfc\u822a","text":"\ud83d\ude80 \u5b89\u88c5\u4e0e\u914d\u7f6e <p>\u8be6\u7ec6\u4e86\u89e3 PostgreSQL \u7684\u5b89\u88c5\u90e8\u7f72\u548c\u6027\u80fd\u914d\u7f6e\u65b9\u6cd5\u3002</p> \u8be6\u60c5 \ud83d\udd10 \u5b89\u5168\u7ba1\u7406 <p>\u638c\u63e1 PostgreSQL \u4e2d\u7684\u7528\u6237\u6743\u9650\u548c\u5b89\u5168\u8ba4\u8bc1\u7b56\u7565\u3002</p> \u8be6\u60c5 \ud83c\udfd7\ufe0f \u7d22\u5f15\u4e0e\u67e5\u8be2\u4f18\u5316 <p>\u4f18\u5316\u6570\u636e\u5e93\u7d22\u5f15\u8bbe\u8ba1\u548c\u67e5\u8be2\u6027\u80fd\u63d0\u5347\u6280\u672f\u3002</p> \u8be6\u60c5 \u26a1 \u6027\u80fd\u4f18\u5316 <p>\u5168\u9762\u7684\u6570\u636e\u5e93\u6027\u80fd\u5206\u6790\u4e0e\u8c03\u4f18\u65b9\u6cd5\u8bba\u3002</p> \u8be6\u60c5 \ud83d\udd04 \u6570\u636e\u540c\u6b65 <p>\u6df1\u5165\u7406\u89e3\u6d41\u590d\u5236\u3001\u903b\u8f91\u590d\u5236\u7b49\u6570\u636e\u540c\u6b65\u673a\u5236\u3002</p> \u8be6\u60c5 \ud83d\udcbe \u5907\u4efd\u4e0e\u6062\u590d <p>\u4fdd\u969c\u6570\u636e\u5b89\u5168\u7684\u5907\u4efd\u7b56\u7565\u4e0e\u6062\u590d\u6280\u672f\u8be6\u89e3\u3002</p> \u8be6\u60c5 \ud83d\udea8 \u9ad8\u53ef\u7528\u65b9\u6848 <p>\u5b9e\u73b0\u4e1a\u52a1\u8fde\u7eed\u6027\u7684 HA \u89e3\u51b3\u65b9\u6848\u548c\u6280\u672f\u9009\u578b\u3002</p> \u8be6\u60c5 \ud83d\udd27 \u7ef4\u62a4\u7ba1\u7406 <p>\u6570\u636e\u5e93\u65e5\u5e38\u8fd0\u7ef4\u7ba1\u7406\u548c\u7ef4\u62a4\u4efb\u52a1\u5904\u7406\u3002</p> \u8be6\u60c5"},{"location":"postgres/#postgresql_1","title":"PostgreSQL \u7b80\u4ecb","text":"<p>PostgreSQL \u662f\u4e00\u6b3e\u529f\u80fd\u5f3a\u5927\u7684\u5f00\u6e90\u5bf9\u8c61\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u5177\u6709\u53ef\u9760\u6027\u3001\u7a33\u5b9a\u6027\u548c\u6570\u636e\u5b8c\u6574\u6027\u65b9\u9762\u7684\u5353\u8d8a\u8868\u73b0\u3002\u5b83\u62e5\u6709\u8d85\u8fc7 35 \u5e74\u7684\u5f00\u53d1\u5386\u53f2\uff0c\u5728 ACID \u5408\u89c4\u6027\u3001\u53ef\u6269\u5c55\u6027\u3001\u590d\u6742\u67e5\u8be2\u5904\u7406\u7b49\u65b9\u9762\u8868\u73b0\u51fa\u8272\u3002</p>"},{"location":"postgres/#_2","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u5f00\u6e90\u514d\u8d39\uff1aBSD \u8bb8\u53ef\u534f\u8bae\uff0c\u65e0\u5382\u5546\u9501\u5b9a\u98ce\u9669</li> <li>\u6807\u51c6\u517c\u5bb9\uff1a\u4e25\u683c\u9075\u5faa SQL \u6807\u51c6\uff0c\u652f\u6301\u9ad8\u7ea7\u7279\u6027</li> <li>\u6269\u5c55\u6027\u4f73\uff1a\u652f\u6301\u81ea\u5b9a\u4e49\u51fd\u6570\u3001\u64cd\u4f5c\u7b26\u3001\u6570\u636e\u7c7b\u578b</li> <li>\u6570\u636e\u5b8c\u6574\u6027\uff1a\u4e25\u683c\u7684\u7ea6\u675f\u68c0\u67e5\u548c\u6570\u636e\u7c7b\u578b\u9a8c\u8bc1</li> <li>\u5e76\u53d1\u5904\u7406\uff1a\u5148\u8fdb\u7684\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236(MVCC)</li> <li>\u8de8\u5e73\u53f0\u652f\u6301\uff1a\u652f\u6301\u6240\u6709\u4e3b\u6d41\u64cd\u4f5c\u7cfb\u7edf\u5e73\u53f0</li> </ul>"},{"location":"postgres/#_3","title":"\u4f01\u4e1a\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u2705 \u91d1\u878d\u6838\u5fc3\u4ea4\u6613\u7cfb\u7edf</li> <li>\u2705 \u7535\u5546\u5e73\u53f0\u8ba2\u5355\u5904\u7406</li> <li>\u2705 \u6570\u636e\u5206\u6790\u4e0e\u5546\u4e1a\u667a\u80fd</li> <li>\u2705 \u5730\u7406\u4f4d\u7f6e\u5e94\u7528(Geospatial)</li> <li>\u2705 \u5168\u6587\u641c\u7d22\u529f\u80fd</li> <li>\u2705 JSON/XML \u534a\u7ed3\u6784\u5316\u6570\u636e</li> </ul>"},{"location":"postgres/#_4","title":"\u6280\u672f\u89c4\u683c\u5bf9\u6bd4","text":"\u529f\u80fd PostgreSQL MySQL Oracle SQL Server \u4e25\u683c SQL \u6807\u51c6\u517c\u5bb9 \u2705 \u274c \u26a0\ufe0f \u26a0\ufe0f JSON \u5904\u7406\u80fd\u529b \ud83c\udf1f \ud83c\udf1f \u274c \u26a0\ufe0f GIS \u7a7a\u95f4\u8ba1\u7b97 \ud83c\udf1f \u26a0\ufe0f \ud83c\udf1f \u26a0\ufe0f \u5e76\u53d1\u5904\u7406\u6027\u80fd \ud83c\udf1f \ud83c\udf1f \u2705 \u2705 \u65e0\u6210\u672c\u5546\u7528 \u2705 \u26a0\ufe0f \u274c \u274c MVCC \u652f\u6301 \u2705 \u26a0\ufe0f \u2705 \u2705 <p>\ud83c\udf1f \u5353\u8d8a\u7ea7 \u00a0\u00a0 \u2705 \u4f18\u79c0\u7ea7 \u00a0\u00a0 \u26a0\ufe0f \u4e2d\u7b49\u7ea7 \u00a0\u00a0 \u274c \u8f83\u5f31\u7ea7</p>"},{"location":"postgres/#postgresql_2","title":"\u4f55\u65f6\u4f7f\u7528 PostgreSQL\uff1f","text":""},{"location":"postgres/#_5","title":"\u63a8\u8350\u9009\u7528\u573a\u666f","text":""},{"location":"postgres/#1","title":"1. \u590d\u6742\u67e5\u8be2\u9700\u6c42","text":"<ul> <li>\u9700\u8981\u590d\u6742\u7684 JOIN \u67e5\u8be2\u548c\u805a\u5408\u8fd0\u7b97</li> <li>\u6570\u636e\u5206\u6790\u3001\u62a5\u8868\u751f\u6210\u3001\u5546\u4e1a\u667a\u80fd\u573a\u666f</li> <li>\u5730\u7406\u4fe1\u606f\u7cfb\u7edf\u3001\u7a7a\u95f4\u6570\u636e\u5904\u7406\u9700\u6c42</li> </ul>"},{"location":"postgres/#2","title":"2. \u4e25\u683c\u6570\u636e\u4e00\u81f4\u6027\u8981\u6c42","text":"<ul> <li>\u91d1\u878d\u3001\u652f\u4ed8\u3001\u8d26\u52a1\u7b49\u5173\u952e\u4e1a\u52a1\u7cfb\u7edf</li> <li>\u5bf9\u6570\u636e\u5b8c\u6574\u6027\u548c\u4e00\u81f4\u6027\u8981\u6c42\u6781\u9ad8\u7684\u5e94\u7528</li> <li>\u5f3a\u4e8b\u52a1\u6027\u3001\u9ad8\u9694\u79bb\u6027\u7684\u4e1a\u52a1\u903b\u8f91</li> </ul>"},{"location":"postgres/#3","title":"3. \u6280\u672f\u521b\u65b0\u62d3\u5c55","text":"<ul> <li>\u9700\u8981\u4f7f\u7528 JSONB \u7b49\u975e\u7ed3\u6784\u5316\u6570\u636e\u7c7b\u578b</li> <li>\u81ea\u5b9a\u4e49\u51fd\u6570\u3001\u6570\u636e\u7c7b\u578b\u548c\u8fd0\u7b97\u7b26</li> <li>\u7b2c\u4e09\u65b9\u6269\u5c55\u548c\u81ea\u5b9a\u4e49\u529f\u80fd\u5f00\u53d1</li> </ul>"},{"location":"postgres/#4","title":"4. \u5546\u4e1a\u6388\u6743\u6210\u672c\u8003\u8651","text":"<ul> <li>\u9884\u7b97\u53d7\u9650\u4f46\u9700\u8981\u4f01\u4e1a\u7ea7\u529f\u80fd\u7684\u9879\u76ee</li> <li>\u4e0d\u5e0c\u671b\u53d7\u5230\u5546\u4e1a\u8f6f\u4ef6\u4f9b\u5e94\u5546\u9501\u5b9a\u7684\u573a\u666f</li> </ul>"},{"location":"postgres/#_6","title":"\u53ef\u8003\u8651\u66ff\u4ee3\u7684\u60c5\u51b5","text":"<ul> <li>\u6781\u7aef\u8bfb\u5199\u901f\u5ea6\u8981\u6c42\u4e14\u6570\u636e\u6a21\u578b\u7b80\u5355\uff08\u5982\u7eaf\u952e\u503c\u5b58\u50a8\uff09</li> <li>\u56e2\u961f\u4e25\u91cd\u4f9d\u8d56 Oracle \u7279\u6709\u529f\u80fd\uff0c\u4e14\u65f6\u95f4\u6210\u672c\u6781\u9ad8</li> <li>\u5df2\u5f62\u6210\u5b8c\u5584\u751f\u6001\u4e14\u66ff\u6362\u6210\u672c\u8fc7\u9ad8</li> </ul>"},{"location":"postgres/#_7","title":"\u53d1\u5c55\u8d8b\u52bf","text":"<pre><code>graph LR\n    A[\u73b0\u4ee3\u6570\u636e\u5e93] --&gt; B{\u53d1\u5c55\u65b9\u5411}\n    B --&gt; C[\u4e91\u8ba1\u7b97\u652f\u6301]\n    B --&gt; D[\u6df7\u5408\u4e8b\u52a1\u5206\u6790]\n    B --&gt; E[\u591a\u6a21\u578b\u6570\u636e\u5904\u7406]\n    B --&gt; F[AI\u96c6\u6210\u80fd\u529b]\n\n    C --&gt; G[PostgreSQL]\n    D --&gt; G\n    E --&gt; G\n    F --&gt; G\n\n    G --&gt; H[\u4e30\u5bcc\u6269\u5c55]\n    H --&gt; I[Citus\u5206\u5e03\u5f0f]\n    H --&gt; J[TimescaleDB\u65f6\u5e8f]\n    H --&gt; K[PostGIS\u5730\u7406]\n    H --&gt; L[PGroonga\u5168\u6587\u68c0\u7d22]\n</code></pre>"},{"location":"postgres/#postgresql_3","title":"PostgreSQL \u7684\u6700\u65b0\u6f14\u8fdb\u65b9\u5411\uff1a","text":"<ul> <li>\u5206\u5e03\u5f0f\u80fd\u529b\u589e\u5f3a - \u901a\u8fc7 Citus \u7b49\u6269\u5c55\u652f\u6301\u5927\u89c4\u6a21\u6c34\u5e73\u6269\u5c55</li> <li>\u4e91\u539f\u751f\u96c6\u6210 - \u4e0e\u5bb9\u5668\u5316\u3001\u5fae\u670d\u52a1\u67b6\u6784\u6df1\u5ea6\u878d\u5408</li> <li>\u673a\u5668\u5b66\u4e60\u96c6\u6210 - ML \u4e0e\u7edf\u8ba1\u5206\u6790\u529f\u80fd\u5185\u7f6e\u589e\u5f3a</li> <li>\u65f6\u5e8f\u6570\u636e\u4f18\u5316 - TimescaleDB \u7b49\u4e13\u6709\u65f6\u5e8f\u6269\u5c55</li> <li>\u56fe\u6570\u636e\u5904\u7406 - \u4e30\u5bcc\u7684\u56fe\u6570\u636e\u5e93\u529f\u80fd\u652f\u6301</li> </ul>"},{"location":"postgres/#_8","title":"\u7248\u672c\u89c4\u5212","text":"\u7248\u672c \u53d1\u5e03\u65f6\u95f4 \u652f\u6301\u671f\u9650 \u4e3b\u8981\u7279\u6027 PostgreSQL 12 2019 2024 \u5e74 SQL \u6807\u51c6\u589e\u5f3a\u3001PL/pgSQL \u4f18\u5316 PostgreSQL 13 2020 2025 \u5e74 \u67e5\u8be2\u4f18\u5316\u5668\u6539\u8fdb\u3001\u7d22\u5f15\u6027\u80fd\u63d0\u5347 PostgreSQL 14 2021 2026 \u5e74 \u5e76\u884c\u67e5\u8be2\u3001\u903b\u8f91\u590d\u5236\u589e\u5f3a PostgreSQL 15 2022 2027 \u5e74 \u5206\u533a\u8868\u529f\u80fd\u589e\u5f3a\u3001\u6027\u80fd\u63d0\u5347 PostgreSQL 16 2023 2028 \u5e74 \u5e76\u884c\u5904\u7406\u589e\u5f3a\u3001\u5b89\u5168\u6027\u52a0\u5f3a <p>\u6700\u65b0\u63a8\u8350\u7248\u672c\uff1a<code>PostgreSQL 15</code>, <code>PostgreSQL 14 LTS</code></p>"},{"location":"postgres/#_9","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"postgres/#_10","title":"\u6027\u80fd\u4f18\u5316\u9ec4\u91d1\u6cd5\u5219","text":"<ol> <li> <p>\u7d22\u5f15\u8bbe\u8ba1\u7b56\u7565</p> </li> <li> <p>\u7406\u89e3 B-tree\u3001Hash\u3001GIN\u3001GiST \u4e0d\u540c\u7d22\u5f15\u9002\u7528\u573a\u666f</p> </li> <li>\u4f18\u5148\u8986\u76d6\u6700\u9891\u7e41\u7684\u67e5\u8be2\u6761\u4ef6</li> <li> <p>\u5173\u6ce8\u90e8\u5206\u7d22\u5f15\u4e0e\u8868\u8fbe\u5f0f\u7d22\u5f15\u7684\u5e94\u7528</p> </li> <li> <p>\u8868\u5206\u533a\u89c4\u5212</p> </li> <li> <p>\u5408\u7406\u5229\u7528\u8303\u56f4\u5206\u533a\u3001\u5217\u8868\u5206\u533a\u63d0\u9ad8\u67e5\u8be2\u6548\u7387</p> </li> <li>\u8003\u8651\u65f6\u95f4\u7ef4\u5ea6\u6570\u636e\u51b7\u70ed\u5206\u79bb\u7b56\u7565</li> <li> <p>\u6ce8\u610f\u5206\u533a\u526a\u679d\u5bf9\u6027\u80fd\u7684\u5f71\u54cd</p> </li> <li> <p>\u67e5\u8be2\u7f16\u5199\u6280\u5de7</p> </li> <li>\u907f\u514d SELECT *\u4f7f\u7528\uff0c\u6307\u5b9a\u660e\u786e\u5b57\u6bb5</li> <li>\u6b63\u786e\u4f7f\u7528 JOIN \u548c\u5b50\u67e5\u8be2\uff0c\u907f\u514d\u7b1b\u5361\u5c14\u79ef</li> <li>\u5145\u5206\u5229\u7528\u7a97\u53e3\u51fd\u6570\u5b8c\u6210\u590d\u6742\u7edf\u8ba1</li> </ol>"},{"location":"postgres/#_11","title":"\u5b89\u5168\u914d\u7f6e\u8981\u70b9","text":"<ol> <li> <p>\u7528\u6237\u6743\u9650\u7ba1\u7406</p> </li> <li> <p>\u5b9e\u65bd\u6700\u5c0f\u6743\u9650\u539f\u5219</p> </li> <li>\u6b63\u786e\u914d\u7f6e row-level security(RLS)</li> <li> <p>\u533a\u5206\u89d2\u8272\u7c7b\u578b\u4e0e\u7528\u9014\u6743\u9650\u63a7\u5236</p> </li> <li> <p>\u8fde\u63a5\u8ba4\u8bc1\u7b56\u7565</p> </li> <li>\u5408\u7406\u8bbe\u7f6e pg_hba.conf \u5b89\u5168\u8ba4\u8bc1\u89c4\u5219</li> <li>\u914d\u7f6e SSL \u52a0\u5bc6\u4f20\u8f93\u654f\u611f\u6570\u636e</li> <li>\u8003\u8651\u7b2c\u4e09\u65b9\u8ba4\u8bc1\u540e\u7aef\u96c6\u6210\u65b9\u6848</li> </ol> <p>\u2b50 \u9884\u77e5\u66f4\u591a\u5b9e\u8df5\u7ec6\u8282\uff0c\u53ef\u53c2\u8003\u5de6\u4fa7\u83dc\u5355\u4e2d\u5bf9\u5e94\u4e13\u9898\u7ae0\u8282</p>"},{"location":"postgres/index%20copy/","title":"\ud83d\udc18 PostgreSQL \u4e13\u4e1a\u6587\u6863\u4e2d\u5fc3","text":"<p>\u6b22\u8fce\u6765\u5230 PostgreSQL \u4e13\u4e1a\u6587\u6863\u4e2d\u5fc3\u3002\u8fd9\u91cc\u6c47\u805a\u4e86 PostgreSQL \u6570\u636e\u5e93\u7684\u5168\u65b9\u4f4d\u6280\u672f\u6587\u6863\uff0c\u52a9\u60a8\u6df1\u5165\u4e86\u89e3\u8fd9\u6b3e\u5f3a\u5927\u800c\u53ef\u9760\u7684\u5f00\u6e90\u5bf9\u8c61\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\u3002</p>"},{"location":"postgres/index%20copy/#_1","title":"\u5feb\u901f\u5bfc\u822a","text":"<p>\u501f\u52a9 MkDocs Material \u7684 <code>grid cards</code> \u63d2\u4ef6\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u4fbf\u6377\u7684\u529f\u80fd\u5165\u53e3\u3002</p>   - {: data-title=\"Installation\" } **\u5b89\u88c5\u4e0e\u914d\u7f6e**    ***    \u8be6\u7ec6\u4e86\u89e3 PostgreSQL \u7684\u5b89\u88c5\u90e8\u7f72\u548c\u6027\u80fd\u914d\u7f6e\u65b9\u6cd5\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./install/install01.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"Security\" } **\u5b89\u5168\u7ba1\u7406**    ***    \u638c\u63e1 PostgreSQL \u4e2d\u7684\u7528\u6237\u6743\u9650\u548c\u5b89\u5168\u8ba4\u8bc1\u7b56\u7565\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./security/role-manager.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"Optimization\" } **\u7d22\u5f15\u4e0e\u67e5\u8be2\u4f18\u5316**    ***    \u4f18\u5316\u6570\u636e\u5e93\u7d22\u5f15\u8bbe\u8ba1\u548c\u67e5\u8be2\u6027\u80fd\u63d0\u5347\u6280\u672f\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./index/index01.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"Performance\" } **\u6027\u80fd\u4f18\u5316**    ***    \u5168\u9762\u7684\u6570\u636e\u5e93\u6027\u80fd\u5206\u6790\u4e0e\u8c03\u4f18\u65b9\u6cd5\u8bba\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./performance/params.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"Replication\" } **\u6570\u636e\u540c\u6b65**    ***    \u6df1\u5165\u7406\u89e3\u6d41\u590d\u5236\u3001\u903b\u8f91\u590d\u5236\u7b49\u6570\u636e\u540c\u6b65\u673a\u5236\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./replication/replication01.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"Backup\" } **\u5907\u4efd\u4e0e\u6062\u590d**    ***    \u4fdd\u969c\u6570\u636e\u5b89\u5168\u7684\u5907\u4efd\u7b56\u7565\u4e0e\u6062\u590d\u6280\u672f\u8be6\u89e3\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./backup/index.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"HA\" } **\u9ad8\u53ef\u7528\u65b9\u6848**    ***    \u5b9e\u73b0\u4e1a\u52a1\u8fde\u7eed\u6027\u7684 HA \u89e3\u51b3\u65b9\u6848\u548c\u6280\u672f\u9009\u578b\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./ha/patroni.md){: .annotate target=\"\\_blank\" }  - {: data-title=\"Maintenance\" } **\u7ef4\u62a4\u7ba1\u7406**    ***    \u6570\u636e\u5e93\u65e5\u5e38\u8fd0\u7ef4\u7ba1\u7406\u548c\u7ef4\u62a4\u4efb\u52a1\u5904\u7406\u3002   {:.annotate}    1.  [\u8be6\u60c5\u94fe\u63a5](./install/daily_management.md){: .annotate target=\"\\_blank\" }"},{"location":"postgres/index%20copy/#postgresql_1","title":"PostgreSQL \u7b80\u4ecb","text":"<p>PostgreSQL \u662f\u4e00\u6b3e\u529f\u80fd\u5f3a\u5927\u7684\u5f00\u6e90\u5bf9\u8c61\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\uff0c\u5177\u6709\u53ef\u9760\u6027\u3001\u7a33\u5b9a\u6027\u548c\u6570\u636e\u5b8c\u6574\u6027\u65b9\u9762\u7684\u5353\u8d8a\u8868\u73b0\u3002\u5b83\u62e5\u6709\u8d85\u8fc7 35 \u5e74\u7684\u5f00\u53d1\u5386\u53f2\uff0c\u5728 ACID \u5408\u89c4\u6027\u3001\u53ef\u6269\u5c55\u6027\u3001\u590d\u6742\u67e5\u8be2\u5904\u7406\u7b49\u65b9\u9762\u8868\u73b0\u51fa\u8272\u3002</p>"},{"location":"postgres/index%20copy/#_2","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u5f00\u6e90\u514d\u8d39\uff1aBSD \u8bb8\u53ef\u534f\u8bae\uff0c\u65e0\u5382\u5546\u9501\u5b9a\u98ce\u9669</li> <li>\u6807\u51c6\u517c\u5bb9\uff1a\u4e25\u683c\u9075\u5faa SQL \u6807\u51c6\uff0c\u652f\u6301\u9ad8\u7ea7\u7279\u6027</li> <li>\u6269\u5c55\u6027\u4f73\uff1a\u652f\u6301\u81ea\u5b9a\u4e49\u51fd\u6570\u3001\u64cd\u4f5c\u7b26\u3001\u6570\u636e\u7c7b\u578b</li> <li>\u6570\u636e\u5b8c\u6574\u6027\uff1a\u4e25\u683c\u7684\u7ea6\u675f\u68c0\u67e5\u548c\u6570\u636e\u7c7b\u578b\u9a8c\u8bc1</li> <li>\u5e76\u53d1\u5904\u7406\uff1a\u5148\u8fdb\u7684\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236(MVCC)</li> <li>\u8de8\u5e73\u53f0\u652f\u6301\uff1a\u652f\u6301\u6240\u6709\u4e3b\u6d41\u64cd\u4f5c\u7cfb\u7edf\u5e73\u53f0</li> </ul>"},{"location":"postgres/index%20copy/#_3","title":"\u4f01\u4e1a\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u2705 \u91d1\u878d\u6838\u5fc3\u4ea4\u6613\u7cfb\u7edf</li> <li>\u2705 \u7535\u5546\u5e73\u53f0\u8ba2\u5355\u5904\u7406</li> <li>\u2705 \u6570\u636e\u5206\u6790\u4e0e\u5546\u4e1a\u667a\u80fd</li> <li>\u2705 \u5730\u7406\u4f4d\u7f6e\u5e94\u7528(Geospatial)</li> <li>\u2705 \u5168\u6587\u641c\u7d22\u529f\u80fd</li> <li>\u2705 JSON/XML \u534a\u7ed3\u6784\u5316\u6570\u636e</li> </ul>"},{"location":"postgres/index%20copy/#_4","title":"\u6280\u672f\u89c4\u683c\u5bf9\u6bd4","text":"\u529f\u80fd PostgreSQL MySQL Oracle SQL Server \u4e25\u683c SQL \u6807\u51c6\u517c\u5bb9 \u2705 \u274c \u26a0\ufe0f \u26a0\ufe0f JSON \u5904\u7406\u80fd\u529b \ud83c\udf1f \ud83c\udf1f \u274c \u26a0\ufe0f GIS \u7a7a\u95f4\u8ba1\u7b97 \ud83c\udf1f \u26a0\ufe0f \ud83c\udf1f \u26a0\ufe0f \u5e76\u53d1\u5904\u7406\u6027\u80fd \ud83c\udf1f \ud83c\udf1f \u2705 \u2705 \u65e0\u6210\u672c\u5546\u7528 \u2705 \u26a0\ufe0f \u274c \u274c MVCC \u652f\u6301 \u2705 \u26a0\ufe0f \u2705 \u2705 <p>??? info \"\u56fe\u6807\u8bf4\u660e\" \ud83c\udf1f \u5353\u8d8a\u7ea7 \u00a0\u00a0 \u2705 \u4f18\u79c0\u7ea7 \u00a0\u00a0 \u26a0\ufe0f \u4e2d\u7b49\u7ea7 \u00a0\u00a0 \u274c \u8f83\u5f31\u7ea7</p>"},{"location":"postgres/index%20copy/#postgresql_2","title":"\u4f55\u65f6\u4f7f\u7528 PostgreSQL\uff1f","text":""},{"location":"postgres/index%20copy/#_5","title":"\u63a8\u8350\u9009\u7528\u573a\u666f","text":""},{"location":"postgres/index%20copy/#1","title":"1. \u590d\u6742\u67e5\u8be2\u9700\u6c42","text":"<ul> <li>\u9700\u8981\u590d\u6742\u7684 JOIN \u67e5\u8be2\u548c\u805a\u5408\u8fd0\u7b97</li> <li>\u6570\u636e\u5206\u6790\u3001\u62a5\u8868\u751f\u6210\u3001\u5546\u4e1a\u667a\u80fd\u573a\u666f</li> <li>\u5730\u7406\u4fe1\u606f\u7cfb\u7edf\u3001\u7a7a\u95f4\u6570\u636e\u5904\u7406\u9700\u6c42</li> </ul>"},{"location":"postgres/index%20copy/#2","title":"2. \u4e25\u683c\u6570\u636e\u4e00\u81f4\u6027\u8981\u6c42","text":"<ul> <li>\u91d1\u878d\u3001\u652f\u4ed8\u3001\u8d26\u52a1\u7b49\u5173\u952e\u4e1a\u52a1\u7cfb\u7edf</li> <li>\u5bf9\u6570\u636e\u5b8c\u6574\u6027\u548c\u4e00\u81f4\u6027\u8981\u6c42\u6781\u9ad8\u7684\u5e94\u7528</li> <li>\u5f3a\u4e8b\u52a1\u6027\u3001\u9ad8\u9694\u79bb\u6027\u7684\u4e1a\u52a1\u903b\u8f91</li> </ul>"},{"location":"postgres/index%20copy/#3","title":"3. \u6280\u672f\u521b\u65b0\u62d3\u5c55","text":"<ul> <li>\u9700\u8981\u4f7f\u7528 JSONB \u7b49\u975e\u7ed3\u6784\u5316\u6570\u636e\u7c7b\u578b</li> <li>\u81ea\u5b9a\u4e49\u51fd\u6570\u3001\u6570\u636e\u7c7b\u578b\u548c\u8fd0\u7b97\u7b26</li> <li>\u7b2c\u4e09\u65b9\u6269\u5c55\u548c\u81ea\u5b9a\u4e49\u529f\u80fd\u5f00\u53d1</li> </ul>"},{"location":"postgres/index%20copy/#4","title":"4. \u5546\u4e1a\u6388\u6743\u6210\u672c\u8003\u8651","text":"<ul> <li>\u9884\u7b97\u53d7\u9650\u4f46\u9700\u8981\u4f01\u4e1a\u7ea7\u529f\u80fd\u7684\u9879\u76ee</li> <li>\u4e0d\u5e0c\u671b\u53d7\u5230\u5546\u4e1a\u8f6f\u4ef6\u4f9b\u5e94\u5546\u9501\u5b9a\u7684\u573a\u666f</li> </ul>"},{"location":"postgres/index%20copy/#_6","title":"\u53ef\u8003\u8651\u66ff\u4ee3\u7684\u60c5\u51b5","text":"<ul> <li>\u6781\u7aef\u8bfb\u5199\u901f\u5ea6\u8981\u6c42\u4e14\u6570\u636e\u6a21\u578b\u7b80\u5355\uff08\u5982\u7eaf\u952e\u503c\u5b58\u50a8\uff09</li> <li>\u56e2\u961f\u4e25\u91cd\u4f9d\u8d56 Oracle \u7279\u6709\u529f\u80fd\uff0c\u4e14\u65f6\u95f4\u6210\u672c\u6781\u9ad8</li> <li>\u5df2\u5f62\u6210\u5b8c\u5584\u751f\u6001\u4e14\u66ff\u6362\u6210\u672c\u8fc7\u9ad8</li> </ul>"},{"location":"postgres/index%20copy/#_7","title":"\u53d1\u5c55\u8d8b\u52bf","text":"<pre><code>graph LR\n    A[\u73b0\u4ee3\u6570\u636e\u5e93] --&gt; B{\u53d1\u5c55\u65b9\u5411}\n    B --&gt; C[\u4e91\u8ba1\u7b97\u652f\u6301]\n    B --&gt; D[\u6df7\u5408\u4e8b\u52a1\u5206\u6790]\n    B --&gt; E[\u591a\u6a21\u578b\u6570\u636e\u5904\u7406]\n    B --&gt; F[AI\u96c6\u6210\u80fd\u529b]\n\n    C --&gt; G[PostgreSQL]\n    D --&gt; G\n    E --&gt; G\n    F --&gt; G\n\n    G --&gt; H[\u4e30\u5bcc\u6269\u5c55]\n    H --&gt; I[Citus\u5206\u5e03\u5f0f]\n    H --&gt; J[TimescaleDB\u65f6\u5e8f]\n    H --&gt; K[PostGIS\u5730\u7406]\n    H --&gt; L[PGroonga\u5168\u6587\u68c0\u7d22]\n</code></pre>"},{"location":"postgres/index%20copy/#postgresql_3","title":"PostgreSQL \u7684\u6700\u65b0\u6f14\u8fdb\u65b9\u5411\uff1a","text":"<ul> <li>\u5206\u5e03\u5f0f\u80fd\u529b\u589e\u5f3a - \u901a\u8fc7 Citus \u7b49\u6269\u5c55\u652f\u6301\u5927\u89c4\u6a21\u6c34\u5e73\u6269\u5c55</li> <li>\u4e91\u539f\u751f\u96c6\u6210 - \u4e0e\u5bb9\u5668\u5316\u3001\u5fae\u670d\u52a1\u67b6\u6784\u6df1\u5ea6\u878d\u5408</li> <li>\u673a\u5668\u5b66\u4e60\u96c6\u6210 - ML \u4e0e\u7edf\u8ba1\u5206\u6790\u529f\u80fd\u5185\u7f6e\u589e\u5f3a</li> <li>\u65f6\u5e8f\u6570\u636e\u4f18\u5316 - TimescaleDB \u7b49\u4e13\u6709\u65f6\u5e8f\u6269\u5c55</li> <li>\u56fe\u6570\u636e\u5904\u7406 - \u4e30\u5bcc\u7684\u56fe\u6570\u636e\u5e93\u529f\u80fd\u652f\u6301</li> </ul>"},{"location":"postgres/index%20copy/#_8","title":"\u7248\u672c\u89c4\u5212","text":"\u7248\u672c \u53d1\u5e03\u65f6\u95f4 \u652f\u6301\u671f\u9650 \u4e3b\u8981\u7279\u6027 PostgreSQL 12 2019 2024 \u5e74 SQL \u6807\u51c6\u589e\u5f3a\u3001PL/pgSQL \u4f18\u5316 PostgreSQL 13 2020 2025 \u5e74 \u67e5\u8be2\u4f18\u5316\u5668\u6539\u8fdb\u3001\u7d22\u5f15\u6027\u80fd\u63d0\u5347 PostgreSQL 14 2021 2026 \u5e74 \u5e76\u884c\u67e5\u8be2\u3001\u903b\u8f91\u590d\u5236\u589e\u5f3a PostgreSQL 15 2022 2027 \u5e74 \u5206\u533a\u8868\u529f\u80fd\u589e\u5f3a\u3001\u6027\u80fd\u63d0\u5347 PostgreSQL 16 2023 2028 \u5e74 \u5e76\u884c\u5904\u7406\u589e\u5f3a\u3001\u5b89\u5168\u6027\u52a0\u5f3a <p>\u6700\u65b0\u63a8\u8350\u7248\u672c\uff1a<code>PostgreSQL 15</code>, <code>PostgreSQL 14 LTS</code></p>"},{"location":"postgres/index%20copy/#_9","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"postgres/index%20copy/#_10","title":"\u6027\u80fd\u4f18\u5316\u9ec4\u91d1\u6cd5\u5219","text":"<ol> <li> <p>\u7d22\u5f15\u8bbe\u8ba1\u7b56\u7565</p> </li> <li> <p>\u7406\u89e3 B-tree\u3001Hash\u3001GIN\u3001GiST \u4e0d\u540c\u7d22\u5f15\u9002\u7528\u573a\u666f</p> </li> <li>\u4f18\u5148\u8986\u76d6\u6700\u9891\u7e41\u7684\u67e5\u8be2\u6761\u4ef6</li> <li> <p>\u5173\u6ce8\u90e8\u5206\u7d22\u5f15\u4e0e\u8868\u8fbe\u5f0f\u7d22\u5f15\u7684\u5e94\u7528</p> </li> <li> <p>\u8868\u5206\u533a\u89c4\u5212</p> </li> <li> <p>\u5408\u7406\u5229\u7528\u8303\u56f4\u5206\u533a\u3001\u5217\u8868\u5206\u533a\u63d0\u9ad8\u67e5\u8be2\u6548\u7387</p> </li> <li>\u8003\u8651\u65f6\u95f4\u7ef4\u5ea6\u6570\u636e\u51b7\u70ed\u5206\u79bb\u7b56\u7565</li> <li> <p>\u6ce8\u610f\u5206\u533a\u526a\u679d\u5bf9\u6027\u80fd\u7684\u5f71\u54cd</p> </li> <li> <p>\u67e5\u8be2\u7f16\u5199\u6280\u5de7</p> </li> <li>\u907f\u514d SELECT *\u4f7f\u7528\uff0c\u6307\u5b9a\u660e\u786e\u5b57\u6bb5</li> <li>\u6b63\u786e\u4f7f\u7528 JOIN \u548c\u5b50\u67e5\u8be2\uff0c\u907f\u514d\u7b1b\u5361\u5c14\u79ef</li> <li>\u5145\u5206\u5229\u7528\u7a97\u53e3\u51fd\u6570\u5b8c\u6210\u590d\u6742\u7edf\u8ba1</li> </ol>"},{"location":"postgres/index%20copy/#_11","title":"\u5b89\u5168\u914d\u7f6e\u8981\u70b9","text":"<ol> <li> <p>\u7528\u6237\u6743\u9650\u7ba1\u7406</p> </li> <li> <p>\u5b9e\u65bd\u6700\u5c0f\u6743\u9650\u539f\u5219</p> </li> <li>\u6b63\u786e\u914d\u7f6e row-level security(RLS)</li> <li> <p>\u533a\u5206\u89d2\u8272\u7c7b\u578b\u4e0e\u7528\u9014\u6743\u9650\u63a7\u5236</p> </li> <li> <p>\u8fde\u63a5\u8ba4\u8bc1\u7b56\u7565</p> </li> <li>\u5408\u7406\u8bbe\u7f6e pg_hba.conf \u5b89\u5168\u8ba4\u8bc1\u89c4\u5219</li> <li>\u914d\u7f6e SSL \u52a0\u5bc6\u4f20\u8f93\u654f\u611f\u6570\u636e</li> <li>\u8003\u8651\u7b2c\u4e09\u65b9\u8ba4\u8bc1\u540e\u7aef\u96c6\u6210\u65b9\u6848</li> </ol> <p>\u2b50 \u9884\u77e5\u66f4\u591a\u5b9e\u8df5\u7ec6\u8282\uff0c\u53ef\u53c2\u8003\u5de6\u4fa7\u83dc\u5355\u4e2d\u5bf9\u5e94\u4e13\u9898\u7ae0\u8282</p>"},{"location":"postgres/backup/","title":"\u5907\u4efd\u4e0e\u6062\u590d","text":"<p>\u672c\u8282\u5305\u542b\u4e86 PostgreSQL \u6570\u636e\u5e93\u7684\u5907\u4efd\u4e0e\u6062\u590d\u76f8\u5173\u6587\u6863\u3002</p> <ul> <li>\u5907\u4efd\u65b9\u6848\u8bbe\u8ba1</li> <li>\u903b\u8f91\u5907\u4efd</li> <li>\u7269\u7406\u5907\u4efd</li> <li>pgBackRest</li> <li>WAL-G \u5907\u4efd</li> <li>pgcopydb \u8fc1\u79fb</li> <li>PITR \u5907\u4efd\u6062\u590d</li> </ul>"},{"location":"postgres/backup/logical-backup/","title":"\u903b\u8f91\u5907\u4efd","text":""},{"location":"postgres/backup/logical-backup/#_1","title":"\u5907\u4efd\u6062\u590d\u547d\u4ee4","text":"<pre><code>\u5907\u4efd\uff1apg_dump -U postgres -v -F c -Z 4 -f ***.backup dbname  9\u538b\u7f29\u7387\u6700\u72e0\n\u6062\u590d\uff1apg_restore -U postgres -v -j 8 -d dbname ***.backup   8\u662f\u91c7\u75288\u4e2a\u7ebf\u7a0b\n\n\u6ce8\u610f\u4e8b\u9879\uff1a \u5728\u6062\u590ddatabase\u524d\u9700\u8981\u5148\u521b\u5efa\u597dextentions\n\n\u5907\u4efd\u8868\uff1apg_dump -U postgres -t tablename dbname &gt; 33.sql\n\u6062\u590d\u8868\uff1apsql -U postgres -d dbname &lt; 33.sql\n\n\u53ea\u5907\u4efd\u8868\u7ed3\u6784 pg_dump -U postgres -s -t tablename dbname &gt; 33.sql\n\u53ea\u5907\u4efd\u6570\u636e pg_dump -U postgres -a -t tablename dbname &gt; 33.sql\n</code></pre> <pre><code>\u5168\u5e93\u5907\u4efd: pg_dumpall\n\n\u53ea\u5907\u4efd\u7528\u6237(\u89d2\u8272)\u4fe1\u606f: pg_dumpall -g &gt; roles.sql\n</code></pre>"},{"location":"postgres/backup/logical-backup/#minio","title":"\u5907\u4efd\u538b\u7f29\u5e76\u5b58\u50a8\u5230 minio","text":"<pre><code>  #!/bin/bash\n\n  # PostgreSQL \u8bbe\u7f6e\n  # POSTGRES_USER=\"postgres\"\n  # POSTGRES_HOST=\"127.0.0.1\"\n\n  # MinIO \u8bbe\u7f6e\n  # MINIO_BUCKET=\"pgbackup\"\n  # MINIO_HOST=\"http://localhost:9000\"\n  # MINIO_ACCESS_KEY=\"admin123\"\n  # MINIO_SECRET_KEY=\"admin123\"\n\n  # \u8bbe\u7f6e MinIO \u5ba2\u6237\u7aef\u522b\u540d\n  mc alias set myminio $MINIO_HOST $MINIO_ACCESS_KEY $MINIO_SECRET_KEY\n\n  # \u521b\u5efa\u4ee5\u5f53\u524d\u65e5\u671f\u548c\u65f6\u95f4\u547d\u540d\u7684\u5907\u4efd\u76ee\u5f55\n  BACKUP_DIR=\"$(date +%Y%m%d%H%M)\"\n  MINIO_PATH=\"myminio/$MINIO_BUCKET/$BACKUP_DIR\"\n\n  # \u5907\u4efd\u5168\u5c40\u5bf9\u8c61\n  echo \"Backing up global objects to $MINIO_PATH/roles_globals.sql.gz\"\n  pg_dumpall -g -U \"$POSTGRES_USER\" -h \"$POSTGRES_HOST\" | pigz | mc pipe \"$MINIO_PATH/roles_globals.sql.gz\"\n\n  # \u83b7\u53d6\u6240\u6709\u975e\u6a21\u677f\u6570\u636e\u5e93\u7684\u5217\u8868\n  DATABASES=$(psql -U \"$POSTGRES_USER\" -h \"$POSTGRES_HOST\" -t -c \"SELECT datname FROM pg_database WHERE datistemplate = false;\")\n\n  # \u4e3a\u6bcf\u4e2a\u6570\u636e\u5e93\u6267\u884c\u5907\u4efd\n  for DB in $DATABASES; do\n    echo \"Backing up $DB to $MINIO_PATH/$DB.sql.gz\"\n    pg_dump -U \"$POSTGRES_USER\" -h \"$POSTGRES_HOST\" \"$DB\" | pigz | mc pipe \"$MINIO_PATH/$DB.sql.gz\"\n  done\n\n  echo \"Backup process completed!\"\n</code></pre>"},{"location":"postgres/backup/logical-backup/#copy","title":"copy \u62f7\u8d1d\u6570\u636e","text":"<pre><code>\u6570\u636e\u62f7\u8d1d\u5230\u672c\u5730\uff1a psql -U postgres -d databasename  -p 5432 -h 10.1.1.1 -c \"\\copy (select * from $tablename where xxx) to '/tmp/db/$tablename.csv'\";\n\n\u6570\u636e\u6062\u590d\u5230\u6570\u636e\u5e93: psql -U postgres -d databasename -p 5432 -h 127.0.0.1 -c \"\\copy $tablename from '/tmp/db/$tablename.csv'\";\n</code></pre> <p>\u8bf4\u660e\uff1a copy \u4e0e \\copy \u533a\u522b\uff0c \\copy cvs \u6570\u636e\u5728 client \u7aef\u3001copy svs \u6570\u636e\u5728 server \u7aef\u3002</p>"},{"location":"postgres/backup/logical-backup/#_2","title":"\u6ce8\u610f\u4e8b\u9879: \u9700\u8981\u5728\u65b0\u6570\u636e\u5e93\u4e2d\u5bf9\u5e8f\u5217\u8fdb\u884c\u66f4\u65b0","text":"<pre><code>psql -U postgres -d databasename -p 5432 -h 127.0.0.1 -c \"select setval('xxxx_id_seq', max(id)) from xxx_table\";\n\n</code></pre> <p>copy from \u6570\u636e\u91cf\u5927\u65f6\u6548\u7387\u592a\u4f4e\u66ff\u4ee3\u65b9\u6cd5</p> <pre><code>/usr/pgsql-10/bin/pg_bulkload -U postgres -d dataname -i /xxx/xxx.csv -O tablename -l /tmp/xxx.log -P /tmp/xxx.bad -o \"TYPE=CSV\" -o $'DELIMITER=\\t'\n</code></pre> <p>\u8bf4\u660e\uff1a pg_bulkload \u4e3a\u62d3\u5c55\u5f62\u5f0f\u3002 \u9700\u8981\u5728\u6570\u636e\u5e93\u4e2d'create extends pg_bulkload' \u3002</p>"},{"location":"postgres/backup/logical-backup/#pg_bulkload-copy","title":"pg_bulkload \u4e0e copy \u533a\u522b","text":"<p>copy \u5c06\u6784\u9020\u51fa\u7684\u5143\u7ec4\u63d2\u5165\u5171\u4eab\u5185\u5b58\uff0c\u540c\u65f6\u5199\u65e5\u5fd7\uff0cpg_bulkload \u7ed5\u8fc7\u4e86\u5171\u4eab\u5185\u5b58\uff0c\u4e0d\u5199\u65e5\u5fd7\uff0c\u8fd9\u6837\u4f1a\u51cf\u5c11\u78c1\u76d8 I/O\uff0c\u4f46\u662f\u4e5f\u5f88\u5371\u9669\u3002</p>"},{"location":"postgres/backup/logical-backup/#pg_bulkload-wal","title":"\u4f7f\u7528 pg_bulkload \u65b9\u5f0f\u5bfc\u5165\u6570\u636e\u65f6\u4e00\u5b9a\u8981\u6ce8\u610f\uff0c\u6ce8\u610f\uff0c\u6ce8\u610f\uff01\uff01\uff01\u3000\u7531\u4e8e\u4e0d\u5199 wal \u65e5\u5fd7\u4ece\u5e93\u65e0\u6cd5\u540c\u6b65\uff0c\u4ece\u5e93\u76f4\u63a5\u5b95\u6389\uff0c\u76f4\u63a5\u5b95\u6389\uff01\uff01\uff01 \u6d4b\u8bd5\u7528\u5c31\u597d,\u751f\u4ea7\u73af\u5883\u9700\u8c28\u614e","text":""},{"location":"postgres/backup/logical-backup/#_3","title":"\u5b9e\u65f6\u5907\u4efd\u6062\u590d","text":"<p>https://github.com/ossc-db/pg_rman</p> <p>https://github.com/wal-e/wal-e</p> <p>https://github.com/wal-g/wal-g</p>"},{"location":"postgres/backup/logical-backup/#_4","title":"\u5b9a\u671f\u5907\u4efd","text":"<p>https://github.com/postgrespro/pg_probackup</p>"},{"location":"postgres/backup/logical-backup/#_5","title":"\u5907\u4efd\u6062\u590d\u7ba1\u7406","text":"<p>https://github.com/pgbackrest/pgbackrest</p> <p>\u7531\u4e8e\u539f\u59cb\u5e93\u4e2d\u5b58\u5728 extension \u9700\u8981\u8d85\u7ea7\u7ba1\u7406\u5458\u6743\u9650\u8fdb\u884c\u6062\u590d\uff0c\u6062\u590d\u540e\u5c06\u6240\u6709\u8005\u53d8\u66f4\u4e3a\u666e\u901a\u7528\u6237\u3002 pg \u4e2d\u6ca1\u6709\u65b9\u6cd5\u53ef\u4ee5\u5c06\u6574\u4e2a database \u4e2d table \u7684 owner \u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u7528\u5982\u4e0b\u65b9\u6cd5\u8fdb\u884c\u6279\u91cf\u4fee\u6539</p> <p>\u6279\u91cf\u4fee\u6539\u8868\u548c\u89c6\u56fe\u7684\u6240\u6709\u8005</p> <pre><code>DO $$DECLARE r record;\nBEGIN\nFOR r IN SELECT tablename/viewname FROM pg_tables/pg_views WHERE schemaname = 'public'\nLOOP\n    EXECUTE 'alter table '|| r.tablename/r.viewname ||' owner to new_owner;';\nEND LOOP;\nEND$$;\n</code></pre>"},{"location":"postgres/backup/pgbackrest/","title":"pgbackrest \u6570\u636e\u5907\u4efd\u6062\u590d\u7ba1\u7406","text":""},{"location":"postgres/backup/pgbackrest/#_1","title":"\u57fa\u672c\u6982\u5ff5","text":"<ul> <li>\u5168\u91cf\u5907\u4efd [Full backup]</li> <li>\u5dee\u5f02\u5907\u4efd [Differential backup]</li> <li>\u589e\u91cf\u5907\u4efd [Incremental backup]</li> </ul>"},{"location":"postgres/backup/pgbackrest/#_2","title":"\u5b89\u88c5","text":""},{"location":"postgres/backup/pgbackrest/#_3","title":"\u7f16\u8bd1\u5b89\u88c5","text":"<p>\u7f16\u8bd1\u540e\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u5206\u53d1\u5230\u5176\u4ed6\u73af\u5883\u4e2d\u5373\u53ef\uff0c\u8bef\u5728\u751f\u4ea7\u73af\u5883\u7f16\u8bd1\uff0c\u6709\u4e9b\u4f9d\u8d56\u53ea\u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u9700\u8981\u3002</p> <p>\u5fc5\u8981\u5b89\u88c5\u548c\u914d\u7f6e</p> <pre><code>sudo apt-get install postgresql-client libxml2 libssh2-1\n\nsudo mkdir -p -m 770 /var/log/pgbackrest\nsudo chown postgres:postgres /var/log/pgbackrest\nsudo mkdir -p /etc/pgbackrest\nsudo mkdir -p /etc/pgbackrest/conf.d\nsudo touch /etc/pgbackrest/pgbackrest.conf\nsudo chmod 640 /etc/pgbackrest/pgbackrest.conf\nsudo chown postgres:postgres /etc/pgbackrest/pgbackrest.conf\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_4","title":"\u5b89\u88c5\u5305\u65b9\u5f0f","text":"<pre><code>apt-get install pgbackrest\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_5","title":"\u914d\u7f6e","text":"<p>vi /etc/pgbackrest/pgbackrest.conf \u6216 vi /etc/pgbackrest.conf</p> <pre><code>[demo]\npg1-path=/var/lib/postgresql/16/demo\n</code></pre> <p>\u8bbe\u7f6e\u5b58\u50a8\u8def\u5f84</p> <pre><code>sudo mkdir -p /data/pgbackrest\n\nsudo chmod 750 /data/pgbackrest\n\nsudo chown postgres:postgres /var/lib/pgbackrest\n</code></pre> <p>\u6d4b\u8bd5\u68c0\u67e5\u914d\u7f6e</p> <pre><code>pgbackrest --stanza=demo --log-level-console=info check\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_6","title":"\u5feb\u901f\u4e0a\u624b","text":""},{"location":"postgres/backup/pgbackrest/#wal","title":"\u914d\u7f6e wal \u5f52\u6863","text":"<p>postgresql.conf</p> <pre><code>archive_command = 'pgbackrest --stanza=demo archive-push %p'\narchive_mode = on\nmax_wal_senders = 3\nwal_level = replica\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#stanza","title":"\u521b\u5efa Stanza","text":"<pre><code>pgbackrest --stanza=demo --log-level-console=info stanza-create\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#wal_1","title":"\u9a8c\u8bc1 wal \u5f52\u6863","text":"<p>\u751f\u6210\u65b0\u7684 wal \u67e5\u770b\u662f\u5426\u5f52\u6863\u6210\u529f</p> <pre><code>select pg_create_restore_point('pgBackRest Archive Check');\nselect pg_switch_wal();\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_7","title":"\u6267\u884c\u5907\u4efd","text":"<pre><code>pgbackrest --stanza=demo --log-level-console=info backup\n\npgbackrest --stanza=demo --log-level-console=info backup --type=diff\n\npgbackrest --stanza=demo --log-level-console=info backup --type=full\n\npgbackrest --stanza=demo --log-level-console=info backup --type=incr\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_8","title":"\u5b9a\u671f\u5907\u4efd","text":"<pre><code>#m h   dom mon dow   command\n30 06  *   *   0     pgbackrest --type=full --stanza=demo backup\n30 06  *   *   1-6   pgbackrest --type=diff --stanza=demo backup\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_9","title":"\u67e5\u770b\u5907\u4efd\u4fe1\u606f","text":"<pre><code>pgbackrest info\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_10","title":"\u6570\u636e\u6062\u590d","text":"<pre><code>pgbackrest --stanza=demo restore\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_11","title":"\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"postgres/backup/pgbackrest/#_12","title":"\u6027\u80fd\u4f18\u5316","text":"<p>\u8003\u8651\u5230\u7248\u672c\u517c\u5bb9\u6027\u6216\u5176\u4ed6\u539f\u56e0\uff0c\u591a\u9879\u53ef\u4f18\u5316\u7684\u9009\u9879\u9ed8\u8ba4\u6ca1\u6709\u5f00\u542f</p> <ul> <li>compress-type (v2.27) gz -&gt; zst</li> <li>repo-bundle (v2.39) repo1-bundle=y \u3002 \u5c06\u5c0f\u6587\u4ef6\u6253\u5305\uff0c\u5c24\u5176\u5728\u5bf9\u8c61\u5b58\u50a8\u573a\u666f\u4e2d\u5c06\u4f1a\u5e26\u6765\u6781\u5927\u7684\u6027\u80fd\u63d0\u5347</li> <li>repo-block \u6587\u4ef6\u7ea7\u522b\u5230\u5757\u57fa\u672c\u7684\u5dee\u5f02\u5907\u4efd \u5728\u6267\u884c\u589e\u91cf\u6216\u67e5\u5206\u5907\u4efd\u7684\u65f6\u5019\u3002</li> </ul> <p>\u6839\u636e\u5177\u4f53\u6848\u4f8b\u8fdb\u884c\u4f18\u5316\u7684\u53c2\u6570</p> <ul> <li>process-max \u6bcf\u4e2a\u547d\u4ee4\u6240\u4f7f\u7528\u7684\u6700\u591a\u8fdb\u7a0b\u6570</li> <li>archive-async \u5f02\u6b65\u5f52\u6863 wal \u9700\u8981 spool \u7528\u4e8e\u7f13\u51b2</li> <li>backup-standby \u5728\u4ece\u5e93\u5907\u4efd\uff0c\u51cf\u5c11\u4e3b\u5e93\u538b\u529b</li> <li>start-fast=y \u4e3b\u52a8\u89e6\u53d1 checkpoint</li> </ul> <p>\u914d\u7f6e\u9879</p> <pre><code>compress-type=zst\nrepo1-bundle=y\nrepo1-block=y\narchive-async=y\nlog-level-file=detail\nrepo1-host=repository\nspool-path=/var/spool/pgbackrest\n\n[global:archive-get]\nprocess-max=2\n\n[global:archive-push]\nprocess-max=2\n</code></pre> <pre><code>pgbackrest check\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_13","title":"\u6570\u636e\u52a0\u5bc6","text":"<pre><code>repo1-cipher-pass=cJ77S7DAlAjZJMpLTNe/rTIBU2ak71L9uCWflrBaGahjvry2Y8z1DBtb7I1S22tF\nrepo1-cipher-type=aes-256-cbc\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_14","title":"\u6570\u636e\u6062\u590d\u4e2d\u7684\u9ad8\u7ea7\u5e94\u7528","text":""},{"location":"postgres/backup/pgbackrest/#_15","title":"\u5dee\u5f02\u6062\u590d","text":"<p>--delta \uff0c\u5728\u6062\u590d\u7684\u65f6\u5019\u8ba1\u7b97 SHA-1, mainfest \u4e0e\u672c\u5730\u6570\u636e\u8fdb\u884c\u5bf9\u6bd4\u3002\u5982\u679c\u672c\u5730\u6570\u636e\u4e0e\u6062\u590d\u6570\u636e\u5dee\u5f02\u5c0f\uff0c \u8fd9\u4f1a\u5f88\u9ad8\u6548\uff0c\u4e0e pg_rewind \u7c7b\u4f3c</p>"},{"location":"postgres/backup/pgbackrest/#_16","title":"\u52a0\u901f\u6062\u590d","text":"<p>\u589e\u5927 process-max=4\uff0c \u4e0d\u540c\u4e8e\u5907\u4efd\u573a\u666f\uff0c\u56e0\u4e3a\u6062\u590d\u573a\u666f\u4e2d\u6570\u636e\u5e93\u662f\u5173\u95ed\u72b6\u6001\uff0c\u4e0d\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c \u53ef\u4ee5\u9002\u5f53\u63d0\u9ad8\u5e76\u53d1\u4ee5\u52a0\u5feb\u6062\u590d\u901f\u5ea6\u3002</p>"},{"location":"postgres/backup/pgbackrest/#database-test2","title":"\u53ea\u6062\u590d\u6307\u5b9a\u7684 database test2","text":"<pre><code>pgbackrest --stanza=demo --delta \\\n --db-include=test2 --type=immediate --target-action=promote restore\n</code></pre> <p>\u5982\u679c\u8981\u6062\u590d\u591a\u4e2a database</p> <pre><code>pgbackrest --stanza=demo --delta \\\n --db-include=test1 --db-include=test2  --type=immediate --target-action=promote restore\n</code></pre> <p>\u6062\u590d\u540e\u5220\u9664\u5176\u4ed6\u7684\u5e93</p> <pre><code>drop database testxxx;\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_17","title":"\u6062\u590d\u4e3a\u4ece\u5e93","text":""},{"location":"postgres/backup/pgbackrest/#hot-standby","title":"Hot Standby","text":"<p>\u6570\u636e\u5e93\u6062\u590d\u540e\uff0c\u4ecd\u4fdd\u6301\u6062\u590d\u6a21\u5f0f\uff0c\u5373\u4ece\u5e93\u6a21\u5f0f\uff0c\u800c\u4e0d\u5347\u53d8\u4e3a\u4e3b\u5e93</p> <pre><code>pgbackrest --stanza=demo --delta --type=standby restore\n</code></pre> <p>\u4f7f\u7528 --=standby \u540e\u4ea7\u751f\u7684\u6062\u590d\u6587\u4ef6 <code>standby.signal</code> \u800c\u4e0d\u662f <code>recover.signal</code></p>"},{"location":"postgres/backup/pgbackrest/#streaming-replication","title":"Streaming Replication","text":"<p>\u914d\u7f6e recovery-option</p> <pre><code>[demo]\npg1-path=/var/lib/postgresql/16/demo\nrecovery-option=primary_conninfo=host=172.17.0.6 port=5432 user=replicator\n\n[global]\nlog-level-file=detail\nrepo1-host=repository\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_18","title":"\u76d1\u63a7","text":"<p>\u4ece info \u4e2d\u67e5\u770b</p> <p>https://github.com/woblerr/pgbackrest_exporter</p>"},{"location":"postgres/backup/pgbackrest/#point-in-time-recovery","title":"Point-in-Time Recovery","text":"<pre><code>pgbackrest --stanza=demo --delta \\\n       --type=time \"--target=2025-10-18 08:42:10.202702+00\" \\\n       --target-action=promote restore\n</code></pre> <p>--type \u901a\u5e38\u4f1a\u9009\u62e9\u65f6\u95f4\u7c7b\u578b\uff0c\u6ce8\u610f\u8bbe\u7f6e\u65f6\u533a\uff0c \u5728\u6062\u590d\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684\u5168\u5907\u4efd\u3002</p>"},{"location":"postgres/backup/pgbackrest/#s3","title":"\u5907\u4efd\u5230 s3","text":"<p>\u652f\u6301\u591a\u4e2a repo \u5b58\u50a8, s3 \u9700\u8981 https \u534f\u8bae</p> <pre><code>repo2-bundle=y\nrepo2-cipher-pass=cJ77S7DAlAjZJMpLTNe/rTIBU2ak71L9uCWflrBaGahjvry2Y8z1DBtb7I1S22tF\nrepo2-cipher-type=aes-256-cbc\nrepo2-path=/demo-repo\nrepo2-retention-full=4\nrepo2-s3-bucket=pgback\nrepo2-s3-endpoint=https://10.1.80.61:9000\nrepo2-s3-key=admin\nrepo2-s3-key-secret=admin123\nrepo2-s3-region=us-east-1\nrepo2-type=s3\nrepo2-s3-verify-tls=n\nrepo2-s3-uri-style=path\n</code></pre> <pre><code>pgbackrest --stanza=demo --repo=2 \\\n       --log-level-console=info backup\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_19","title":"\u65e5\u5fd7","text":"<p>/var/log/pgbackrest/</p>"},{"location":"postgres/backup/pgbackrest/#wal_2","title":"\u5f02\u6b65 wal \u65e5\u5fd7\u5907\u4efd","text":"<ul> <li>archive-async=y \u5f00\u542f\u5f02\u6b65</li> <li>spool-path \u4e34\u65f6\u5b58\u50a8\u76ee\u5f55\uff0cpush \u65e9\u671f\u7248\u672c\uff0c\u5148\u628a wal \u590d\u5236\u5230 spool \u5728\u4f20\u8f93\uff0c\u5728 v1.13 \u7248\u672c\u4e2d\u8fdb\u884c\u4e86\u6539\u9020\uff0c\u53ea\u5b58\u50a8 wal \u7684\u72b6\u6001\u3002</li> <li>process-max \u591a\u4efb\u52a1\u3002 \u5206\u522b\u5bf9\u4e8e\u4e0d\u540c\u7684\u8fc7\u7a0b\u3002</li> <li>archive-get-queue-max . get \u91c7\u7528\u9884\u53d6\u7684\u65b9\u5f0f\u3002 size 182MiB\u3002 \u4e0e\u591a\u4efb\u52a1\u914d\u5408\u4f7f\u7528</li> </ul> <pre><code>[demo]\npg1-path=/var/lib/postgresql/16/demo\n\n[global]\narchive-async=y\nlog-level-file=detail\nrepo1-host=repository\nspool-path=/var/spool/pgbackrest\n\n[global:archive-get]\nprocess-max=2\n\n[global:archive-push]\nprocess-max=2\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_20","title":"\u4e13\u5c5e\u4ed3\u5e93","text":"<p>\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4e3a\u7279\u5b9a\u7684 PostgreSQL \u5b9e\u4f8b\u521b\u5efa\u4e00\u4e2a\u4e13\u5c5e\u7684\u5907\u4efd\u4ed3\u5e93\uff08dedicated repository\uff09\u3002\u8fd9\u53ef\u4ee5\u63d0\u9ad8\u5b89\u5168\u6027\u3001\u9694\u79bb\u6027\uff0c\u5e76\u4fbf\u4e8e\u7ba1\u7406\u4e0d\u540c\u5b9e\u4f8b\u7684\u6570\u636e\u3002</p> <ul> <li>\u5c06\u6570\u636e\u5e93\u7684\u5168\u5907\u4efd\u5728\u4e13\u5c5e\u4ed3\u5e93\u4e2d\u6267\u884c</li> <li>\u4e13\u5c5e\u4ed3\u5e93\u4e0e\u5907\u4efd\u7684\u6570\u636e\u4e4b\u95f4\u9700\u8981\u5f7c\u6b64 ssh \u514d\u5bc6\u6216 TSL \u901a\u4fe1\uff0c\u53ca\u5bf9\u5e94\u8bbf\u95ee\u6743\u9650</li> <li>\u4e00\u4e2a\u4e13\u5c5e\u4ed3\u5e93\u7ba1\u7406\u591a\u4e2a\u6570\u636e\u5e93</li> </ul>"},{"location":"postgres/backup/pgbackrest/#_21","title":"\u5728\u4ece\u5e93\u4e2d\u6267\u884c\u5907\u4efd","text":"<p>backup-standby=y</p> <p>\u9002\u5408\u642d\u914d\u4e13\u5c5e\u4ed3\u5e93\u573a\u666f\u3002 \u81ea\u52a8\u5224\u65ad\u4e3b\u4ece\uff0c\u9009\u62e9\u5728\u4ece\u5e93\u4e2d\u5907\u4efd\u5927\u90e8\u5206\u6587\u4ef6\uff0c\u4e3b\u5e93\u4e3b\u5907\u4efd\u5c11\u90e8\u5206\u6587\u4ef6\u3002</p> <p>\u4e0d\u80fd\u72ec\u81ea\u8fd0\u884c\u5728\u4ece\u5e93\u4e2d\uff0c\u9700\u8981\u4e3b\u5e93\u7684\u4fe1\u606f\u3002\u8fd9\u4e00\u70b9\u5bf9\u539f\u6709\u7684\u6570\u636e\u5e93\u7cfb\u7edf\u7ed3\u6784\u5165\u4fb5\u6bd4\u8f83\u5927\u3002</p>"},{"location":"postgres/backup/pgbackrest/#stanza_1","title":"\u5220\u9664 stanza","text":"<p>\u5b98\u65b9\u63a8\u8350\u6b65\u9aa4\uff1a</p> <ol> <li>\u505c\u6b62 PostgreSQL \u670d\u52a1</li> <li>\u505c\u6b62 pgBackRest</li> <li>\u5220\u9664 stanza \u914d\u7f6e</li> </ol> <p>\u601d\u8003\uff0c \u5220\u9664 stanza \u5fc5\u987b\u8981\u505c\u6570\u636e\u5e93\u5417\uff1f \u8fd9\u4e2a\u5f71\u54cd\u592a\u5927\u4e86\u5427\uff0c\u5173\u4e8e\u5220\u9664 stanza \u662f\u5426\u5fc5\u987b\u505c\u6570\u636e\u5e93\u7684\u95ee\u9898\uff0c\u5b9e\u9645\u4e0a\u4e0d\u9700\u8981\u505c\u6b62\u6574\u4e2a PostgreSQL \u6570\u636e\u5e93\u96c6\u7fa4\u3002</p> <p>\u6bcf\u6b21\u5220\u9664\u5176\u4e2d\u4e00\u4e2a repo</p> <pre><code># \u505c\u6b62 pgBackRest\npgbackrest --stanza=demo --log-level-console=info stop\n\n2025-11-28 01:28:54.689 P00   INFO: stop command begin 2.57.0: --exec-id=4181641-c8a319b8 --log-level-console=info --stanza=demo\n2025-11-28 01:28:54.693 P00   INFO: stop command end: completed successfully (7ms)\n# \u5220\u9664 repo1\npgbackrest --stanza=demo --repo=1  --log-level-console=info stanza-delete\n2025-11-28 01:29:15.436 P00   INFO: stanza-delete command begin 2.57.0: --exec-id=4181644-b8b6f0a6 --log-level-console=info --pg1-path=/var/lib/postgresql/17/main1 --pg1-port=5433 --repo=1 --repo1-cipher-pass=&lt;redacted&gt; --repo2-cipher-pass=&lt;redacted&gt; --repo1-cipher-type=aes-256-cbc --repo2-cipher-type=aes-256-cbc --repo1-path=/data/pgback --repo2-path=/demo-repo --repo2-s3-bucket=pgback --repo2-s3-endpoint=https://10.1.80.61:9000 --repo2-s3-key=&lt;redacted&gt; --repo2-s3-key-secret=&lt;redacted&gt; --repo2-s3-region=us-east-1 --repo2-s3-uri-style=path --no-repo2-storage-verify-tls --repo2-type=s3 --stanza=demo\n2025-11-28 01:29:15.447 P00  ERROR: [038]: postmaster.pid exists - looks like PostgreSQL is running. To delete stanza 'demo' on repo1, shut down PostgreSQL for stanza 'demo' and try again, or use --force.\n2025-11-28 01:29:15.447 P00   INFO: stanza-delete command end: aborted with exception [038]\n\n# --force \u5220\u9664\npgbackrest --stanza=demo --repo=1 --log-level-console=info stanza-delete --force\n2025-11-28 01:29:51.722 P00   INFO: stanza-delete command begin 2.57.0: --exec-id=4181648-7769b634 --force --log-level-console=info --pg1-path=/var/lib/postgresql/17/main1 --pg1-port=5433 --repo=1 --repo1-cipher-pass=&lt;redacted&gt; --repo2-cipher-pass=&lt;redacted&gt; --repo1-cipher-type=aes-256-cbc --repo2-cipher-type=aes-256-cbc --repo1-path=/data/pgback --repo2-path=/demo-repo --repo2-s3-bucket=pgback --repo2-s3-endpoint=https://10.1.80.61:9000 --repo2-s3-key=&lt;redacted&gt; --repo2-s3-key-secret=&lt;redacted&gt; --repo2-s3-region=us-east-1 --repo2-s3-uri-style=path --no-repo2-storage-verify-tls --repo2-type=s3 --stanza=demo\n2025-11-28 01:29:52.006 P00   INFO: stanza-delete command end: completed successfully (287ms)\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_22","title":"\u542f\u505c","text":"<p>\u505c\u6b62\u6570\u636e\u5e93\u7684\u5907\u4efd\uff0c\u5305\u62ec wal \u548c\u6570\u636e\u5907\u4efd\u3002 \u4e3b\u8981\u5e94\u7528\u573a\u666f\uff0c\u7528\u4e8e\u4e34\u65f6\u6d4b\u8bd5\u7684\u6570\u636e\u5e93\u3002\u907f\u514d\u5907\u4efd\u6570\u636e\u6c61\u67d3 repo</p> <pre><code>pgbackrest --stanza=demo --log-level-console=info stop\npgbackrest --stanza=demo --log-level-console=info start\n</code></pre>"},{"location":"postgres/backup/pgbackrest/#_23","title":"\u603b\u7ed3","text":"<pre><code>cat /etc/pgbackrest.conf\n[global]\nrepo1-bundle=y\nrepo1-path=/data/pgback\nrepo1-retention-diff=1\nrepo1-retention-full=2\nrepo1-cipher-pass=xxxxxxxx\nrepo1-cipher-type=aes-256-cbc\nrepo2-bundle=y\nrepo2-cipher-pass=xxxx\nrepo2-cipher-type=aes-256-cbc\nrepo2-path=/demo\nrepo2-retention-full=4\nrepo2-s3-bucket=pgback\nrepo2-s3-endpoint=https://s3address:8888\nrepo2-s3-key=key\nrepo2-s3-key-secret=secrec\nrepo2-s3-region=us-east-1\nrepo2-type=s3\nrepo2-s3-verify-tls=n\nrepo2-s3-uri-style=path\nstart-fast=y\ncompress-type=zst\nbackup-standby=n\narchive-async=y\nspool-path=/var/spool/pgbackres\nlog-level-file=info\n\n[global:archive-push]\ncompress-level=9\nprocess-max=2\n\n[global:archive-get]\nprocess-max=2\n\n[demo]\npg1-path=/var/lib/postgresql/17/main1\npg1-port=5433\nprocess-max=4\n</code></pre> <p>cipher-pass</p> <pre><code>openssl rand -base64 48\n</code></pre>"},{"location":"postgres/backup/pgcopydb/","title":"\u5229\u7528pgcopydb \u8fdb\u884c\u6570\u636e\u8fc1\u79fb","text":""},{"location":"postgres/backup/pgcopydb/#_1","title":"\u80cc\u666f","text":"<p>pgcopydb \u4e3b\u8981\u662f\u89e3\u51b3pg_dump | pg_restore \u4e0d\u843d\u76d8\u6570\u636e\u8fc1\u79fb\u7684\u5e76\u884c\u8bdd\u95ee\u9898\u3002\u5e76\u652f\u6301\u5355\u8868\u7684\u5e76\u884c\u6267\u884c\u3002</p>"},{"location":"postgres/backup/pgcopydb/#_2","title":"\u6570\u636e\u8fc1\u79fb","text":""},{"location":"postgres/backup/pgcopydb/#_3","title":"\u6570\u636e\u8054\u901a\u9a8c\u8bc1","text":"<pre><code>$ pgcopydb ping --source=\"dbname=pagila\" --target=\"postgres://user@target:5432/pagila\"\n</code></pre>"},{"location":"postgres/backup/pgcopydb/#_4","title":"\u79bb\u7ebf\u6570\u636e\u8fc1\u79fb","text":"<pre><code>pgcopydb clone\n  --source                      Postgres URI to the source database\n  --target                      Postgres URI to the target database\n  --dir                         Work directory to use\n  --table-jobs                  Number of concurrent COPY jobs to run\n  --index-jobs                  Number of concurrent CREATE INDEX jobs to run\n  --restore-jobs \n  --snapshot                    Use snapshot obtained with pg_export_snapshot\n  --follow                      Implement logical decoding to replay changes\n  --plugin                      Output plugin to use (test_decoding, wal2json)\n  --verbose\n</code></pre>"},{"location":"postgres/backup/pgcopydb/#_5","title":"\u7528\u6237\uff0c\u62d3\u5c55\u540c\u6b65","text":"<pre><code>\u9700\u8981\u6570\u636e\u5e93\u8d85\u7ea7\u7528\u6237\u90e8\u5206, \u4e5f\u53ef\u4ee5\u624b\u52a8\u5728target \u5e93\u4e2d\u6267\u884c\u3002\n# \n$ coproc ( pgcopydb snapshot --source)\n# first two commands would use a superuser role to connect\n$ pgcopydb copy roles --source ... --target ...\n$ pgcopydb copy extensions --source ... --target ...\n$ kill -TERM ${COPROC_PID}\n$ wait ${COPROC_PID}\n</code></pre>"},{"location":"postgres/backup/pgcopydb/#_6","title":"\u6570\u636e\u8fc1\u79fb","text":"<pre><code>\u666e\u901a\u7528\u6237\u5373\u53ef\n# \u8fdb\u884c\u6570\u636e\u8fc1\u79fb\n$ pgcopydb clone --dir=/tmp/pgcopydb-1 --table-jobs=10 --index-jobs=8 --restore-jobs=10 --skip-extensions --snapshot --source ... --target ...\n# \u5220\u9664\u5feb\u7167\n$ kill -TERM ${COPROC_PID}\n$ wait ${COPROC_PID}\n</code></pre>"},{"location":"postgres/backup/pgcopydb/#cdc","title":"CDC\u6570\u636e\u8fc1\u79fb","text":"<pre><code>$ coproc ( pgcopydb snapshot )\n\n$ pgcopydb stream setup\n\n$ pgcopydb clone --follow --dir=/tmp/pgcopydb-1 --table-jobs=10 --index-jobs=8 --restore-jobs=10 --skip-extensions --snapshot --source ... --target ...&amp;\n\n# \u67e5\u770b\u4e3b\u4ece\u5ef6\u8fdf\uff0c\u5f53\u4e3b\u4ece\u8fbe\u5230\u540c\u6b65\u540e\u53ef\u51c6\u5907\u8fdb\u884c\u5e94\u7528\u5207\u6362 \n\n# \u505c\u5e94\u7528\n# \u7528\u4e8e\u63a7\u5236\u6d41\u5f0f\u590d\u5236\u505c\u6b62\u4f4d\u7f6e\uff0c\u4f7f\u590d\u5236\u8fdb\u7a0b\u5728\u5904\u7406\u5b8c\u5f53\u524d\u6240\u6709\u5df2\u63a5\u6536\u7684\u6570\u636e\u540e\u81ea\u52a8\u505c\u6b62\n$ pgcopydb stream sentinel set endpos --current\n\n# \u540c\u6b65\u5e8f\u5217\n$ pgcopydb copy sequences\n\n# \u6e05\u7406\u903b\u8f91\u590d\u5236\u8fc7\u7a0b\u4e2d\u6240\u521b\u5efa\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u590d\u5236\u69fd\uff0c\u8ba2\u9605\u53d1\u5e03\u7b49\n$ pgcopydb stream cleanup\n\n # \u6e05\u7406\u5feb\u7167\n$ kill -TERM ${COPROC_PID}\n$ wait ${COPROC_PID}\n\n\u5e94\u7528\u63a5\u5165\u65b0\u6570\u636e\u5e93\n</code></pre>"},{"location":"postgres/backup/pgcopydb/#_7","title":"\u6570\u636e\u6821\u9a8c","text":"<pre><code>$ pgcopydb compare schema\n$ pgcopydb compare data\n</code></pre>"},{"location":"postgres/backup/pgcopydb/#filter","title":"\u914d\u7f6efilter\u8868\u8fc7\u6ee4","text":"<p>https://pgcopydb.readthedocs.io/en/latest/ref/pgcopydb_config.html</p>"},{"location":"postgres/backup/pgcopydb/#_8","title":"\u6570\u636e\u8fc1\u79fb\u6b65\u9aa4\u8bf4\u660e","text":"<ul> <li>\u5217\u51fa\u666e\u901a\u8868\uff0c\u5206\u533a\u8868\uff0c\u7d22\u5f15\uff0c\u5e8f\u5217</li> <li>\u7136\u540e\u8c03\u7528pg_dump \u8fdb\u5165pre-data</li> <li>\u5229\u7528pg_restore --use-list \u8fdb\u884c\u8fc7\u6ee4</li> <li>\u5e76\u884ccopy data</li> <li>\u5927\u5bf9\u8c61\u5904\u7406</li> <li>\u5e76\u884c\u521b\u5efa\u7d22\u5f15\uff0c\u4e3b\u952e\u7d22\u5f15\uff0c\u73b0\u9636\u6bb5\u4e3a\u552f\u4e00\u7d22\u5f15</li> <li>\u4e3b\u952e\u7d22\u5f15\u6062\u590d</li> <li>vacuum analyze</li> <li>\u5faa\u73af\u540c\u6b65\u5e8f\u5217</li> </ul>"},{"location":"postgres/backup/pgcopydb/#_9","title":"\u4e00\u4e2a\u5177\u4f53\u7684\u8fc1\u79fb\u8fc7\u7a0b","text":"<p>apt-get install pgcopydb</p> <p>\u6d4b\u8bd5\u7ed3\u679c \u4e0d\u80fd\u6ee1\u8db3\u62d3\u5c55\u4e0d\u540c\u7248\u672c\u7684\u517c\u5bb9\u6027\uff0c\u5728\u8fc1\u79fbfunction \u7684\u65f6\u5019\u62a5\u9519\u3002\u6539\u7528\u539f\u59cb\u7684\u903b\u8f91\u590d\u5236</p>"},{"location":"postgres/backup/physical-backup/","title":"\u7269\u7406\u5907\u4efd","text":"<pre><code>pg_basebackup -h 10.2.0.14 -U postgres -F p -P  -D /var/lib/pgsql/xx/data/ --checkpoint=fast -l postgresback2018\n</code></pre>"},{"location":"postgres/backup/pitr/","title":"\u65f6\u95f4\u70b9\u6062\u590d","text":""},{"location":"postgres/backup/pitr/#pitr","title":"PITR","text":"<p>Point-in-time recovery</p> <p>https://blog.csdn.net/a964921988/article/details/84957241</p> <p>https://github.com/digoal/blog/blob/master/201608/20160823_03.md</p> <p>https://github.com/digoal/blog/blob/master/201608/20160823_04.md</p>"},{"location":"postgres/backup/pitr/#_1","title":"\u4f9d\u8d56\u6761\u4ef6","text":"<ul> <li>\u5386\u53f2\u5b8c\u6574\u5907\u4efd</li> <li>\u4e0d\u95f4\u65adwal\u65e5\u5fd7</li> </ul> <p>\u4ee5\u4e0a\u90fd\u53ef\u6709wal-g \u5907\u4efd\u7cfb\u7edf\u63d0\u4f9b\u652f\u6301</p>"},{"location":"postgres/backup/pitr/#_2","title":"\u6062\u590d\u5230\u6307\u5b9a\u70b9","text":"<ul> <li>\u6307\u5b9a\u6807\u7b7e</li> <li>\u5177\u4f53\u65f6\u95f4\u70b9</li> <li>\u5177\u4f53\u4e8b\u52a1 </li> </ul>"},{"location":"postgres/backup/pitr/#_3","title":"\u6307\u5b9a\u6807\u7b7e","text":"<pre><code>recovery.conf\nrecovery_target_action= 'pause'  # promote ,shutdown\n</code></pre> <pre><code>--- \u6253lable \nselect pg_create_restore_point('my_daily_process_ended');\n\n--- \u6062\u590d\u5230\u6307\u5b9a\u7684lable\nrecovery.conf\nrecovery_target_name = 'my_daily_process_ended'\n</code></pre>"},{"location":"postgres/backup/pitr/#_4","title":"\u5177\u4f53\u65f6\u95f4","text":"<pre><code>restore_command = 'cp /data/arch/%f %p'            # e.g. 'cp /mnt/server/archivedir/%f %p'\nrecovery_target_time = '2020-12-23 09:37:17.010268'\nrecovery_target_inclusive = false\nrecovery_target_timeline = 'latest'\n</code></pre>"},{"location":"postgres/backup/pitr/#_5","title":"\u5177\u4f53\u4e8b\u52a1","text":"<pre><code>restore_command = 'cp /data/arch/%f %p'            # e.g. 'cp /mnt/server/archivedir/%f %p'\nrecovery_target_xid = '26897309' \nrecovery_target_inclusive = false    \nrecovery_target_timeline = 'latest\n</code></pre>"},{"location":"postgres/backup/pitr/#wal","title":"wal\u5185\u5bb9\u89e3\u6790\u5177\u4f53\u4f4d\u7f6e\uff0c\u65f6\u95f4\u3001\u4e8b\u52a1","text":"<pre><code>select pg_current_wal_lsn();\n pg_current_wal_lsn \n--------------------\n 59/15000090\n(1 \u884c\u8bb0\u5f55)\n\n</code></pre> <pre><code>-- \u5f53\u524dwal\u4f4d\u7f6e\nselect pg_walfile_name(pg_current_wal_lsn());\n     pg_walfile_name      \n--------------------------\n 000000020000005900000015\n(1 \u884c\u8bb0\u5f55)\n\n-- 00000002 TimeLine\n-- 00000059 \u903b\u8f91\u4f4d\u7f6e\n-- 00000015 \u504f\u79fb\n</code></pre> <pre><code>-- \u89e3\u6790wal\u5185\u5bb9\n/usr/pgsql-10/bin/pg_waldump ./000000020000005900000013\nrmgr: Heap        len (rec/tot):     54/    54, tx:   26897309, lsn: 59/13000028, prev 59/120007D8, desc: DELETE off 1 KEYS_UPDATED , blkref #0: rel 1663/389916/1276307 blk 0\nrmgr: Heap        len (rec/tot):     54/    54, tx:   26897309, lsn: 59/13000060, prev 59/13000028, desc: DELETE off 2 KEYS_UPDATED , blkref #0: rel 1663/389916/1276307 blk 0\nrmgr: Heap        len (rec/tot):     54/    54, tx:   26897309, lsn: 59/13000098, prev 59/13000060, desc: DELETE off 3 KEYS_UPDATED , blkref #0: rel 1663/389916/1276307 blk 0\nrmgr: Heap        len (rec/tot):     54/    54, tx:   26897309, lsn: 59/130000D0, prev 59/13000098, desc: DELETE off 5 KEYS_UPDATED , blkref #0: rel 1663/389916/1276307 blk 0\nrmgr: Transaction len (rec/tot):     46/    46, tx:   26897309, lsn: 59/13000108, prev 59/130000D0, desc: COMMIT 2020-12-23 09:37:17.010268 CST\n\n-- \u4e8b\u52a1 tx\uff1a 26897309\n-- \u65f6\u95f4 2020-12-23 09:37:17.010268 CST\n</code></pre> <pre><code>-- \u6839\u636e rel 1663/389916/1276307  \u67e5\u770b\u5177\u4f53\u662f\u54ea\u4e2a\u8868\nselect datname from pg_database where oid = 389916;\n datname \n---------\n test1\n(1 \u884c\u8bb0\u5f55)\n\nselect relname from pg_class where oid=1276307;\n relname \n---------\n t_1\n(1 \u884c\u8bb0\u5f55)\n</code></pre>"},{"location":"postgres/backup/reback/","title":"\u8bef\u64cd\u4f5c\u95ea\u56de","text":""},{"location":"postgres/backup/reback/#_1","title":"\u539f\u7406","text":"<p>\u5229\u7528mvcc\u539f\u7406\uff0c\u6570\u636e\u5728\u5220\u9664\u6216\u66f4\u65b0\u65f6\u53ea\u662f\u6807\u8bb0\u4e3a\u5220\u9664\u3002\u5f53\u6ca1\u6709\u53d1\u751f\u8fc7gc\u65f6\u5386\u53f2\u6570\u636e\u4ecd\u7136\u5b58\u5728\u3002\u53ea\u662f\u5bf9\u5f53\u524d\u4e8b\u52a1\u4e0d\u53ef\u89c1\u3002</p> <p>\u901a\u8fc7\u4fee\u6539\u5f53\u524d\u4e8b\u52a1\u53f7\u4e3a\u8bef\u64cd\u4f5c\u524d\u7684\u4e8b\u52a1\u53f7\u5c31\u53ef\u4ee5\u770b\u5230\u5386\u53f2\u6570\u636e\u3002</p> <p>\u4f8b\u5982 T1 \uff08\u6dfb\u52a0\u6570\u636e\uff09 T2 - T8\uff08\u5176\u4ed6\u64cd\u4f5c\uff09 T9\uff08\u5220\u9664\u4e86T1\u52a0\u5165\u7684\u6570\u636e\uff09T10... (\u5176\u4ed6\u64cd\u4f5c)\u3002 \u81ea\u9700\u8981\u5c06\u5f53\u524d\u4e8b\u52a1\u53f7\u4fee\u6539\u4e3aT1\u4e4b\u540eT9\u4e4b\u524d\u7684\u4efb\u4f55\u65f6\u523b\u90fd\u53ef\u4ee5\u770b\u5230T1 \u52a0\u5165\u7684\u6570\u636e\u3002</p> <p>\u524d\u63d0\uff1a\u8bef\u64cd\u4f5c\u8868\u5728\u8bef\u64cd\u4f5c\u540e\u6ca1\u6709\u53d1\u751f\u8fc7gc</p> <pre><code>select  last_vacuum , last_autovacuum  from pg_stat_all_tables where = ?;\n</code></pre> <p>\u4fee\u6539\u65b9\u6cd5\uff1a\u5229\u7528pg_resetwal\u5de5\u5177\u91cd\u7f6e\u5f53\u524d\u4e8b\u52a1\u53f7</p> <p>\u6ce8\u610f\uff1a \u5c3d\u5feb\u5c06\u627e\u5230\u7684\u6570\u636e\u5bfc\u51fa\uff0c\u968f\u7740\u5f53\u524d\u6570\u636e\u5e93\u4e8b\u52a1\u53f7\u589e\u52a0\uff0c\u6570\u636e\u5c06\u518d\u6b21\u4e0d\u53ef\u89c1\uff0cT10 \u4e5f\u4f1a\u540c\u6837\u4e0d\u53ef\u89c1\u3002</p>"},{"location":"postgres/backup/reback/#_2","title":"\u793a\u4f8b","text":"<p>\u901a\u8fc7pg_xlogdump\u627e\u5230\u8bef\u5220\u7684\u4e8b\u52a1\u53f7\uff08xid\uff09\uff0c\u505c\u6b62\u6570\u636e\u5e93\uff0c\u7136\u540e\u91cd\u7f6exlog\uff0c\u542f\u52a8\u6570\u636e\u5e93\uff0c\u6570\u636e\u5c31\u662f\u91cd\u7f6e\u7684xid\u4f4d\u7f6e\u53ef\u89c1</p> <p>\u6a21\u62df\u4e8b\u6545\u73b0\u573a</p> <pre><code>-- \u521b\u5efa\u6d4b\u8bd5\u8868\npostgres=# create table reback_t (i int);\npostgres=# select txid_current();\n txid_current \n--------------\n     26913040\n(1 \u884c\u8bb0\u5f55)\n\n-- \u6a21\u62df\u4e1a\u52a1\u63d2\u5165\u6570\u636e \npostgres=# insert into reback_t values (1);\nINSERT 0 1\npostgres=# insert into reback_t values (2);\nINSERT 0 1\npostgres=# insert into reback_t values (3);\nINSERT 0 1\npostgres=# insert into reback_t values (4);\nINSERT 0 1\npostgres=# select txid_current();\n txid_current \n--------------\n     26913045\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# insert into reback_t values (5);\nINSERT 0 1\npostgres=# insert into reback_t values (6);\nINSERT 0 1\npostgres=# insert into reback_t values (7);\nINSERT 0 1\npostgres=# insert into reback_t values (8);\nINSERT 0 1\npostgres=# insert into reback_t values (9);\nINSERT 0 1\npostgres=# insert into reback_t values (10);\nINSERT 0 1\npostgres=# select txid_current();\n txid_current \n--------------\n     26913052\n(1 \u884c\u8bb0\u5f55)\n\n-- \u8bef\u5220\u9664\u6570\u636e,\u4e8b\u6545\u70b9 \npostgres=# delete from reback_t where i &lt; 4;\nDELETE 3\n-- \u5728\u7ebf\u4e1a\u52a1\u7ee7\u7eed\npostgres=# insert into reback_t values (11);\nINSERT 0 1\npostgres=# insert into reback_t values (12);\nINSERT 0 1\npostgres=# insert into reback_t values (13);\nINSERT 0 1\npostgres=# select * from reback_t ;\n i  \n----\n  4\n  5\n  6\n  7\n  8\n  9\n 10\n 11\n 12\n 13\n(10 \u884c\u8bb0\u5f55)\n\npostgres=# \\q\n\n</code></pre> <pre><code>\u505c\u670d\u95ea\u9000\n[root@pg-d data]# systemctl stop  postgresql-10\n\n\u56de\u9000\u5230\u6307\u5b9a\u4e8b\u52a1\u53f7\n[root@pg-d data]# su postgres -c \"/usr/pgsql-10/bin/pg_resetwal -x 26913047 -D /var/lib/pgsql/10/data/\"\nWrite-ahead log reset\n\n\u5efa\u8bae\u4f7f\u7528 --single \u7ef4\u62a4\u6a21\u5f0f\u542f\u52a8\u6570\u636e\u5e93\n</code></pre> <pre><code>\u67e5\u770b\u56de\u9000\u6548\u679c, 1,2 \u53c8\u53ef\u89c1\npostgres=# select * from reback_t ;\n i \n---\n 1\n 2\n 3\n 4\n 5\n(5 \u884c\u8bb0\u5f55)\n\n\u4e8b\u52a1\u53f7 +1\npostgres=# select txid_current();\n txid_current \n--------------\n     26913047\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# select * from reback_t ;\n i \n---\n 1\n 2\n 3\n 4\n 5\n 6\n(6 \u884c\u8bb0\u5f55)\n-- \u5176\u4ed6\u64cd\u4f5c , \u4e8b\u52a1\u7ee7\u7eed\u5411\u524d\u3002\u3002\u3002\npostgres=# insert into reback_t values (21);\nINSERT 0 1\npostgres=# select * from reback_t ;\n i  \n----\n  1\n  2\n  3\n  4\n  5\n  6\n  7\n  8\n 21\n(9 \u884c\u8bb0\u5f55)\n-- \u5f53\u4e8b\u52a1\u53f7\u589e\u957f\u5230\u4e8b\u6545\u70b926913053\u65f6\uff0c\u4e8b\u6545\u518d\u6b21\u91cd\u73b0\npostgres=# select * from reback_t ;\n i\n----\n  3\n  4\n  5\n  6\n  7\n  8\n 21\n(7 \u884c\u8bb0\u5f55)\n</code></pre> <pre><code>-- \u4e8b\u52a1\u771f\u76f8\npostgres=# select xmin,xmax,* from reback_t ;\n   xmin   | xmax | i  \n----------+------+----\n 26913044 |    0 |  4\n 26913046 |    0 |  5\n 26913047 |    0 |  6\n 26913048 |    0 |  7\n 26913049 |    0 |  8\n 26913050 |    0 |  9\n 26913051 |    0 | 10\n 26913054 |    0 | 11\n 26913055 |    0 | 12\n 26913049 |    0 | 21\n\n</code></pre> <p>\u601d\u8003 trunce \u540e\u662f\u5426\u80fd\u591f\u95ea\u56de</p> <pre><code>postgres=# select txid_current();\n txid_current \n--------------\n     26913056\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# truncate reback_t ;\nTRUNCATE TABLE\npostgres=# \\q\n\n#systemctl stop  postgresql-10\n\n#su postgres -c \"/usr/pgsql-10/bin/pg_resetwal -x 26913050 -D /var/lib/pgsql/10/data/\"\nWrite-ahead log reset\n\n# systemctl start  postgresql-10\n# psql \npsql (12.5, \u670d\u52a1\u5668 10.13)\n\u8f93\u5165 \"help\" \u6765\u83b7\u53d6\u5e2e\u52a9\u4fe1\u606f.\n\npostgres=# select xmin,xmax,* from reback_t ;\n   xmin   |   xmax   | i  \n----------+----------+----\n 26913041 | 26913053 |  1\n 26913042 | 26913053 |  2\n 26913043 | 26913053 |  3\n 26913044 |        0 |  4\n 26913046 |        0 |  5\n 26913047 |        0 |  6\n 26913048 |        0 |  7\n 26913049 |        0 |  8\n 26913049 | 26913056 | 21\n(9 \u884c\u8bb0\u5f55)\n</code></pre>"},{"location":"postgres/backup/reback/#_3","title":"\u8bef\u64cd\u4f5c\u95ea\u56de","text":"<p>\u63d2\u4ef6 pg_dirtyread</p> <p>\u5c01\u4faf\u975e\u6211\u610f\uff0c\u6211\u613f\u6d77\u6ce2\u5e73\u3002</p>"},{"location":"postgres/backup/reback_supper_user/","title":"\u627e\u56desupper user \u6743\u9650","text":""},{"location":"postgres/backup/reback_supper_user/#_1","title":"\u80cc\u666f","text":"<p>\u610f\u5916\u5220\u9664postgres supper user \u6743\u9650 </p>"},{"location":"postgres/backup/reback_supper_user/#_2","title":"\u627e\u56de\u65b9\u6cd5","text":"<p>\u5173\u95ed\u6570\u636e\u5e93 \u7528\u5355\u7528\u6237\u6a21\u5f0f\u91cd\u65b0\u542f\u52a8</p> <pre><code>/usr/lib/postgresql/xxxx/bin/postgres --single -D $PGDATA\n\n</code></pre> <p>\u91cd\u65b0\u8bbe\u7f6esupper user \u6743\u9650</p> <pre><code>alter user postgres with superuser;\n</code></pre>"},{"location":"postgres/backup/wal-g/","title":"\u5229\u7528 wal-g \u7ba1\u7406\u6570\u636e\u5e93\u5907\u4efd\u548c\u6062\u590d","text":""},{"location":"postgres/backup/wal-g/#minio","title":"\u5b58\u50a8\u670d\u52a1 minio","text":"<p>\u8bbe\u7f6e\u7528\u6237\u540d\u548c\u5bc6\u7801</p> <pre><code>docker run -d -p 9000:9000 -e MINIO_ACCESS_KEY=xxxxx(changeme) -e MINIO_SECRET_KEY=kkkkk(changeme)  -v /data/minio/:/data  minio/minio server /data\n</code></pre> <p>\u521b\u5efa bucket</p> <pre><code>mc mb local/buecket003\n</code></pre>"},{"location":"postgres/backup/wal-g/#wal-g_1","title":"wal-g \u4e0b\u8f7d","text":"<pre><code>wget https://github.com/wal-g/wal-g/releases/download/v0.2.9/wal-g.linux-amd64.tar.gz\n\ntar -zxvf wal-g.linux-amd64.tar.gz\n</code></pre>"},{"location":"postgres/backup/wal-g/#_1","title":"\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf","text":"<p>minio</p> <p>cat wal-g.env</p> <pre><code>export PGDATA=/var/lib/pgsql/10/data/\nexport WALG_S3_PREFIX=s3://bucket003/\nexport PGPORT=5432\nexport PGUSER=postgres\nexport AWS_SECRET_ACCESS_KEY=xxxxx(changeme)\nexport AWS_REGION=us-east-1\nexport AWS_ACCESS_KEY_ID=kkkkk(changeme)\nexport AWS_ENDPOINT=http://localhost:9000\nexport AWS_S3_FORCE_PATH_STYLE=true\n</code></pre> <p>swift</p> <pre><code>export PGDATA=\nexport WALG_SWIFT_PREFIX=swift://buckt003/\nexport PGPORT=\nexport PGUSER=\nexport OS_USERNAME=\nexport OS_PASSWORD=\nexport OS_AUTH_URL=http://ip:port/auth/v1.0\n</code></pre>"},{"location":"postgres/backup/wal-g/#_2","title":"\u6570\u636e\u5907\u4efd","text":""},{"location":"postgres/backup/wal-g/#_3","title":"\u5168\u91cf\u5907\u4efd","text":"<p>\u5b9a\u65f6\u4efb\u52a1\uff0c\u5468\u671f\u5907\u4efd\u5168\u91cf\u6570\u636e</p> <pre><code>source mydir/wal-g.env &amp;&amp;  wal-g  backup-push $PGDATA\n</code></pre>"},{"location":"postgres/backup/wal-g/#wal","title":"wal \u65e5\u5fd7\u5907\u4efd","text":"<p>\u8bbe\u7f6e\u6570\u636e\u5e93\u914d\u7f6e\u6587\u4ef6\uff0c\u5907\u4efd wal \u65e5\u5fd7\u6587\u4ef6</p> <pre><code>archive_mode = on ## \u4ece\u5e93 always\narchive_command = 'source mydir/wal-g.env &amp;&amp;  wal-g wal-push %p'\narchive_timeout = 60\n</code></pre>"},{"location":"postgres/backup/wal-g/#_4","title":"\u6062\u590d\u6570\u636e","text":""},{"location":"postgres/backup/wal-g/#_5","title":"\u67e5\u770b\u6240\u6709\u5168\u5907\u4efd","text":"<pre><code>wal-g backup-list\nname                          last_modified        wal_segment_backup_start\nbase_000000020000001E000000CB 2019-11-07T01:34:08Z 000000020000001E000000CB\nbase_000000020000001E000000CD 2019-11-07T01:37:03Z 000000020000001E000000CD\nbase_000000020000001E000000CF 2019-11-07T02:23:34Z 000000020000001E000000CF\nbase_000000020000001E000000D1 2019-11-07T02:31:00Z 000000020000001E000000D1\nbase_000000020000001E000000D3 2019-11-07T02:38:29Z 000000020000001E000000D3\nbase_000000020000001E000000DA 2019-11-07T06:08:19Z 000000020000001E000000DA\nbase_000000020000001E000000DD 2019-11-07T06:30:24Z 000000020000001E000000DD\nbase_000000020000001E000000DF 2019-11-07T08:45:30Z 000000020000001E000000DF\n</code></pre>"},{"location":"postgres/backup/wal-g/#_6","title":"\u4e0b\u8f7d\u4e00\u4e2a\u5168\u5907\u4efd","text":"<p>\u6700\u8fd1\u7684\u4e00\u4e2a\u5168\u5907\u4efd\u53ef\u7528 LATEST \u8868\u793a</p> <pre><code>wal-g backup-fetch /var/lib/pgsql/10/data-restore/ base_000000020000001E000000CB\n</code></pre> <p>\u5b9e\u65f6\u6062\u590d</p> <p>cat recover.conf</p> <pre><code>restore_command = 'source mydir/wal-g.env &amp;&amp; wal-g wal-fetch %f %p'\nrecovery_target_time='2019-09-10 09:51:55.794813+08'\nrecovery_target_timeline='latest'\n</code></pre> <p>\u5173\u95ed\u6570\u636e\u5e93 pause \u72b6\u6001</p> <pre><code>select pg_wal_replay_resume();\n</code></pre>"},{"location":"postgres/backup/wal-g/#_7","title":"\u7ba1\u7406\u5b58\u50a8","text":""},{"location":"postgres/backup/wal-g/#_8","title":"\u6e05\u7406\u5b58\u50a8","text":"<p>\u4fdd\u7559\u6700\u8fd1\u7684 10 \u4e2a\u5907\u4efd\u53ca wal</p> <pre><code>wal-g delete  retain  FULL  10 (\u8bd5\u5220)\n\nwal-g delete  retain  FULL  10  --confirm \uff08\u771f\u5220\uff09\n</code></pre> <p>\u5220\u9664\u67d0\u4e2a\u5907\u4efd\u524d\u7684\u5907\u4efd</p> <pre><code>wal-g delete before backup_name\n</code></pre>"},{"location":"postgres/backup/wal-g/#wal_1","title":"\u5c06\u73b0\u6709\u7684\u6240\u6709 wal \u4e0a\u4f20","text":"<p>cat wal-push-all.sh</p> <pre><code>#!/bin/bash\n#print the directory and file\n\nfor file in $PGDATA/pg_wal/*\ndo\nif [ -f \"$file\" ]\nthen\n  wal-g wal-push $file\nfi\ndone\n</code></pre>"},{"location":"postgres/backup/wal-g/#_9","title":"\u5b9a\u671f\u5168\u5907\u4efd\u53ca\u6e05\u7406","text":"<p>cat /etc/cron.weekly/pg_backup_retain.sh \u4f8b\u5982\u6bcf\u5468\u4e00\u4e2a\u5168\u5907\u4efd\uff0c\u4fdd\u7559\u8fd1\u534a\u5e74\u6570\u636e</p> <pre><code>source mydir/wal-g.env &amp;&amp;  wal-g  backup-push $PGDATA\nsource mydir/wal-g.env &amp;&amp;  wal-g delete retain FULL 26 --confirm\n</code></pre>"},{"location":"postgres/backup/wal-g/#_10","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>1 \u9700\u8981\u5148\u8fdb\u884c wal \u65e5\u5fd7\u7684\u5907\u4efd\u518d\u8fdb\u884c\u5168\u5907\u4efd\u3002\u5426\u5219\u5728\u6062\u590d\u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u9057\u6f0f\u671f\u95f4\u7684 wal \u65e5\u5fd7\u3002</p> <p>2 \u5168\u5907\u4efd\u9700\u8981\u7b49\u5f85\u5f53\u524d wal \u65e5\u5fd7\u53d1\u751f\u5207\u6362\u624d\u80fd\u5b8c\u6210\u3002\u5982\u679c\u662f\u5199\u5165\u6162\u6216\u6682\u65e0\u5199\u5165\u6570\u636e\u5e93\u53ef\u6267\u884c select pg_switch_wal() \u8fdb\u884c\u624b\u52a8\u89e6\u53d1\u3002</p> <p>3 \u5168\u5907\u4efd\u4e0d\u5305\u62ec pg_wal \u76ee\u5f55\u4e0b\u7684 wal \u65e5\u5fd7\u6587\u4ef6</p>"},{"location":"postgres/backup/wal-g/#_11","title":"\u601d\u8003","text":"<p>\u5f52\u6863\u5907\u4efd wal \u65e5\u5fd7 \u4f1a\u6bd4\u751f\u4ea7\u7cfb\u7edf\u7684\u6570\u636e\u5e93\u6ede\u540e\u4e00\u4e2a wal \u6587\u4ef6 \u3002 \u662f\u5f53 wal \u65e5\u5fd7\u5199\u6ee1\u6216\u5207\u6362\u5199\u65b0 wal \u65e5\u5fd7\u7684\u65f6\u5019\u89e6\u53d1\u7684\u5f52\u6863 \u3002</p> <p>\u5982\u679c\u9700\u8981\u4f7f\u7528\u5f52\u6863\u6587\u4ef6\u6062\u590d\u6570\u636e\u5e93\u65f6\u9700\u8981\u8003\u8651\u65f6\u5019\u53ef\u4ee5\u627e\u5230\u6700\u8fd1\u7684 wal \u65e5\u5fd7\u6587\u4ef6\uff0c\u6bd4\u5982\u5728\u4ece\u5e93\u4e2d\u3002</p>"},{"location":"postgres/backup/wal-g/#_12","title":"\u5176\u4ed6\u6709\u7528\u811a\u672c","text":"<p>\u4e0b\u8f7d\u4e00\u6bb5\u8fde\u7eed\u8303\u56f4\u5185\u7684 wal \u65e5\u5fd7\u6587\u4ef6 \u5230\u76ee\u5f55 walbackup \u76ee\u5f55\u4e2d\uff0c\u9632\u6b62\u4e0b\u8f7d\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u7f51\u7edc\u95ee\u9898\u7b49\u3002\u53ef\u91cd\u590d\u591a\u6b21\u6267\u884c</p> <p>cat refetch_wal.sh</p> <pre><code>walfiles=$(python calc_wal.py $1 $2)\n\nsource mydir/wal-g.env\n\nfor wal_seq in $walfiles; do\n if [[ ! -f walbackup/\"$wal_seq\" ]];then\n   wal-g wal-fetch $wal_seq walbackup/$wal_seq\n   echo \"fetch wal file \" $wal_seq\n fi\ndone\n</code></pre> <p>cat calc_wal.py</p> <pre><code>import sys\n\n\ndef next_str(start):\n    s_8 = start[:8]\n    s_16 = start[8:16]\n    s_24 = start[16:]\n    if s_24.endswith('FF'):\n        s_24 = hex(int('01',base=16))[2:].zfill(8)\n        s_16 = hex(int(s_16, base=16) + 1)[2:].zfill(8)\n    else:\n        s_24 = hex(int(s_24, base=16) + 1)[2:].zfill(8)\n    return ''.join([s_8, s_16, s_24]).upper()\n\n\ndef get_all(start, end):\n    start = start.upper()\n    end = end.upper()\n    new_seq = None\n    print(start)\n    while new_seq != end:\n        new_seq = next_str(new_seq if new_seq is not None else start)\n        print(new_seq)\n\n\nif __name__ == \"__main__\":\n    get_all(sys.argv[1], sys.argv[2])\n\n</code></pre> <p>\u4f7f\u7528\u65b9\u6cd5</p> <p>refetch_wal.sh wal \u5f00\u59cb\u6587\u4ef6\u540d wal \u7ed3\u675f\u6587\u4ef6\u540d</p>"},{"location":"postgres/backup/wal-g/#wal-g-30","title":"wal-g 3.0","text":""},{"location":"postgres/backup/wal-g/#_13","title":"\u5b89\u88c5","text":"<p>\u5b98\u65b9\u76ee\u524d\u53ea\u63d0\u4f9b ubuntu \u7cfb\u7edf\u7684\u7f16\u8bd1\u6587\u4ef6\uff0c\u5176\u4ed6\u73af\u5883\u9700\u8981\u81ea\u5df1\u8fdb\u884c\u7f16\u8bd1</p>"},{"location":"postgres/backup/wal-g/#centos-7","title":"centos 7 \u5b89\u88c5","text":"<pre><code># 1. \u5b89\u88c5\u57fa\u7840\u4f9d\u8d56\nsudo yum groupinstall \"Development Tools\" -y\nsudo yum install epel-release -y\nsudo yum install git wget cmake3 brotli-devel libsodium-devel -y\nsudo ln -sf /usr/bin/cmake3 /usr/bin/cmake\n\n# 2. \u5b89\u88c5\u6700\u65b0\u7248 Go \u7f16\u8bd1\u5668 (CentOS 7 \u9ed8\u8ba4 Go \u7248\u672c\u8fc7\u4f4e)\n\nGO_VERSION=1.25.2\n# \u6839\u636e\u9700\u8981\u8c03\u6574\u7248\u672c\nwget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz\nsudo tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz\n\n# 3. \u914d\u7f6e Go \u73af\u5883\u53d8\u91cf\necho 'export PATH=$PATH:/usr/local/go/bin' &gt;&gt; ~/.bashrc\necho 'export GOPATH=$HOME/go' &gt;&gt; ~/.bashrc\nsource ~/.bashrc\n\n# 4. \u83b7\u53d6 WAL-G \u6e90\u7801\nmkdir -p $GOPATH/src/github.com/wal-g\ngit clone https://github.com/wal-g/wal-g.git $GOPATH/src/github.com/wal-g/wal-g\ncd $GOPATH/src/github.com/wal-g/wal-g\ngit checkout v3.0.5\n\n# 5. \u914d\u7f6e\u7f16\u8bd1\u9009\u9879\uff08\u542f\u7528\u538b\u7f29\u4f18\u5316\uff09\nexport USE_BROTLI=1\nexport USE_LIBSODIUM=1\n\n\n# 6. \u7f16\u8bd1 PostgreSQL \u7248\u672c\nmake deps            # \u5b89\u88c5Go\u4f9d\u8d56\nmake pg_build        # \u7f16\u8bd1\u4e3b\u7a0b\u5e8f\n\n# 7. \u9a8c\u8bc1\u5b89\u88c5\n$GOPATH/src/github.com/wal-g/wal-g/main/pg/wal-g --version\n</code></pre>"},{"location":"postgres/backup/wal-g/#_14","title":"\u914d\u7f6e","text":"<p>\u63d0\u4f9b\u4e24\u79cd\u914d\u7f6e\u7ba1\u7406\u65b9\u5f0f</p> <ul> <li>\u73af\u5883\u53d8\u91cf</li> <li>\u914d\u7f6e\u6587\u4ef6</li> </ul>"},{"location":"postgres/backup/wal-g/#_15","title":"\u538b\u7f29","text":"<p>WALG_COMPRESSION_METHOD</p> <ul> <li>lz4 \u9ed8\u8ba4\uff0c \u6700\u5feb</li> <li>lzma \u538b\u7f29\u7387\u6700\u9ad8\u7ea6 6 \u500d lz4\uff0c\u901f\u5ea6\u6162</li> <li>zstd</li> <li>brotli</li> </ul>"},{"location":"postgres/backup/wal-g/#_16","title":"\u52a0\u5bc6","text":""},{"location":"postgres/backup/wal-g/#yandex-cloud-kms","title":"\u7ed3\u5408\u4e09\u65b9\u52a0\u5bc6 Yandex Cloud KMS","text":""},{"location":"postgres/backup/wal-g/#libsodium","title":"LIBSODIUM \u52a0\u5bc6\u7b97\u6cd5","text":"<ul> <li>WALG_LIBSODIUM_KEY</li> <li>WALG_LIBSODIUM_KEY_PATH</li> <li>WALG_LIBSODIUM_KEY_TRANSFORM</li> </ul> <p>\u4e09\u53d8\u91cf\u534f\u540c\u5173\u7cfb</p> <p>\u5bc6\u94a5\u6765\u6e90</p> \u53d8\u91cf \u4f5c\u7528 <code>WALG_LIBSODIUM_KEY</code> \u76f4\u63a5\u8d4b\u503c\u5bc6\u94a5\uff08\u5982 <code>export WALG_LIBSODIUM_KEY=\"d0b1e2...\"</code>\uff09 <code>WALG_LIBSODIUM_KEY_PATH</code> \u4ece\u6587\u4ef6\u8bfb\u53d6\u5bc6\u94a5\uff08\u6587\u4ef6\u5185\u5bb9\u81ea\u52a8\u53bb\u9664\u7a7a\u683c/\u6362\u884c\u7b26\uff09 <p>\u2705 \u4f18\u5148\u7ea7\uff1a\u82e5\u540c\u65f6\u8bbe\u7f6e\uff0c<code>WALG_LIBSODIUM_KEY</code> \u4f18\u5148\u4e8e <code>WALG_LIBSODIUM_KEY_PATH</code></p> <p>\u5bc6\u94a5\u683c\u5f0f\u8f6c\u6362 (<code>WALG_LIBSODIUM_KEY_TRANSFORM</code>)</p> <p>\u5bc6\u94a5\u9700\u7cbe\u786e 32 \u5b57\u8282\uff08256 \u4f4d\uff09\uff0c\u7528\u6237\u8f93\u5165\u7684\u539f\u59cb\u6570\u636e\u9700\u8f6c\u6362\uff1a</p> \u8f6c\u6362\u7c7b\u578b \u64cd\u4f5c\u65b9\u5f0f \u9002\u7528\u573a\u666f <code>hex</code> \u5c06\u5341\u516d\u8fdb\u5236\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u4e8c\u8fdb\u5236\uff08\u5982 <code>\"1a2b3c\"</code> \u2192 <code>0x1a 0x2b 0x3c...</code>\uff09 <code>openssl rand -hex 32</code> \u751f\u6210\u7684\u5bc6\u94a5 <code>base64</code> \u89e3\u7801 Base64 \u5b57\u7b26\u4e32\u4e3a\u4e8c\u8fdb\u5236 <code>openssl rand -base64 32</code> \u751f\u6210\u7684\u5bc6\u94a5 <code>none</code> (\u9ed8\u8ba4) \u4e0d\u8f6c\u6362\uff1a - \u8d85\u957f \u2192 \u622a\u65ad\u524d 32 \u5b57\u8282 - \u4e0d\u8db3 \u2192 \u8865\u96f6\u81f3 32 \u5b57\u8282 \u4e0d\u63a8\u8350\uff08\u5b89\u5168\u9690\u60a3\uff09 <p>\u5e94\u7528\u793a\u4f8b</p> <pre><code># \u65b9\u5f0f 1\uff1a\u751f\u6210 HEX \u683c\u5f0f\u5bc6\u94a5\uff08\u9700\u8bbe transform=hex\uff09\nopenssl rand -hex 32  # \u8f93\u51fa\u7c7b\u4f3c deae5d7c7b34a3a5e4e...\nexport WALG_LIBSODIUM_KEY=\"deae5d7c7b34a3a5e4e...\"  # 64\u5b57\u7b26hex\u4e32\nexport WALG_LIBSODIUM_KEY_TRANSFORM=\"hex\"\n</code></pre> <pre><code># \u65b9\u5f0f 2\uff1a\u751f\u6210 Base64 \u683c\u5f0f\u5bc6\u94a5\uff08\u9700\u8bbe transform=base64\uff09\nopenssl rand -base64 32  # \u8f93\u51fa\u7c7b\u4f3c RvmrEXp9CqO8gU6Zq7b7vw==\necho \"RvmrEXp9CqO8gU6Zq7b7vw==\" &gt; /etc/walg.key\nexport WALG_LIBSODIUM_KEY_PATH=\"/etc/walg.key\"\nexport WALG_LIBSODIUM_KEY_TRANSFORM=\"base64\"\n</code></pre>"},{"location":"postgres/backup/wal-g/#openpgp","title":"OpenPGP \u52a0\u5bc6","text":"<ul> <li>WALG_PGP_KEY</li> <li>WALG_PGP_KEY_PATH</li> <li>WALG_PGP_KEY_PASSPHRASE</li> </ul> <p>\u4e0e\u524d\u9762\u4f7f\u7528\u65b9\u5f0f\u7c7b\u4f3c</p> <p>\u5177\u4f53\u6848\u4f8b</p> <pre><code># \u751f\u6210\u52a0\u5bc6\u6587\u4ef6\uff0c\u6839\u636e\u63d0\u793a\u586b\u5199\ngpg --full-generate-key\n\n# \u5217\u6210key\ngpg --list-keys\n 8316E01F780D5E7FBCF722C3C4B51651B1B807F9\n# \u6839\u636e\u524d\u9762\u5217\u51fa\u7684key \u5bfc\u51fa \u516c\u94a5\u548c\u79c1\u94a5\n# \u516c\u94a5\ngpg --armor --export 8316E01F780D5E7FBCF722C3C4B51651B1B807F9 &gt; public.key\n# \u79c1\u94a5\ngpg --armor --export-secret-keys     --pinentry-mode loopback     --passphrase \"123\"     8316E01F780D5E7FBCF722C3C4B51651B1B807F9 &gt; private.key\n</code></pre> <p>wal-push \uff0cbackup-push \u4e0a\u4f20\u65f6\u7528\u516c\u94a5 wal-fetch \uff0cbackup-fetch \u4e0b\u8f7d\u65f6\u5019\u7528\u79c1\u94a5</p>"},{"location":"postgres/backup/wal-g/#envelope-pgp","title":"Envelope PGP \u6df7\u5408\u52a0\u5bc6","text":""},{"location":"postgres/backup/wal-g/#for-postgres","title":"FOR postgres \u914d\u7f6e","text":""},{"location":"postgres/backup/wal-g/#walg_disk_rate_limit","title":"WALG_DISK_RATE_LIMIT","text":"<p>backup-push \u78c1\u76d8\u8bfb\u6570\u636e\u901f\u7387\u9650\u5236</p>"},{"location":"postgres/backup/wal-g/#backup-fetch-wal-fetch","title":"\u4e0b\u8f7d\u5e76\u884c backup-fetch \u6216 wal-fetch","text":"<p>WALG_DOWNLOAD_CONCURRENCY</p>"},{"location":"postgres/backup/wal-g/#wal-push","title":"\u4e0a\u4f20\u5e76\u884c wal-push","text":"<p>WALG_UPLOAD_CONCURRENCY</p>"},{"location":"postgres/backup/wal-g/#backup-push","title":"\u4e0a\u4f20\u5e76\u884c backup-push","text":"<p>WALG_UPLOAD_DISK_CONCURRENCY</p>"},{"location":"postgres/backup/wal-g/#delta","title":"DELTA \u5907\u4efd","text":"<p>WALG_DELTA_MAX_STEPS \u9ed8\u8ba4 0</p>"},{"location":"postgres/backup/wal-g/#bundle","title":"bundle \u5927\u5c0f","text":"<p>WALG_TAR_SIZE_THRESHOLD</p>"},{"location":"postgres/backup/wal-g/#_17","title":"\u4f7f\u7528","text":""},{"location":"postgres/backup/wal-g/#_18","title":"\u5907\u4efd\u6570\u636e","text":"<p>backup-push $PGDATA</p>"},{"location":"postgres/backup/wal-g/#_19","title":"\u6062\u590d\u6570\u636e","text":"<p>backup-fetch</p>"},{"location":"postgres/backup/wal-g/#wal_2","title":"\u5907\u4efd wal","text":"<p>wal-g wal-push</p>"},{"location":"postgres/backup/wal-g/#wal_3","title":"\u6062\u590d wal","text":"<p>wal-g wal-fetch</p>"},{"location":"postgres/backup/wal-g/#_20","title":"\u5220\u9664\u5f52\u6863","text":"<p>wal-g delete</p>"},{"location":"postgres/backup/wal-g/#_21","title":"\u8fdc\u7a0b\u5907\u4efd","text":"<p>export PGPORT=xxxx export PGUSER=xxxx export PGPASSWORD=xxx export PGHOST=xxx</p> <p>\u6267\u884c\u7684\u662f pg_basebackup, \u9700\u8981 replication \u6743\u9650</p> <p>\u53ea\u80fd\u5168\u5907\u4efd\uff0c\u4e0d\u80fd delta \u5907\u4efd</p> <p>POSTGER &gt;= 15 \u7248\u672c\u76ee\u524d\u4e0d\u80fd\u8fdc\u7a0b\u5907\u4efd\uff0c\u5b58\u5728\u95ee\u9898</p> <pre><code>wal-g backup-push\n</code></pre> <p>\u9002\u5408\u573a\u666f\u5982 kubernets \u4e2d\u7684 cronjobs</p>"},{"location":"postgres/backup/wal-g/#_22","title":"\u5b9e\u9645\u5e94\u7528","text":""},{"location":"postgres/backup/wal-g/#_23","title":"\u914d\u7f6e","text":"<p>/opt/wal-g.env</p> <pre><code>\nexport AWS_ACCESS_KEY_ID=\"xxx\"\nexport AWS_SECRET_ACCESS_KEY=\"xxxx\"\nexport WALG_S3_PREFIX=\"s3://xxx/\"\nexport AWS_ENDPOINT=\"http://xxxx:9000\"\nexport AWS_S3_FORCE_PATH_STYLE=\"true\"\nexport AWS_REGION=dx-1\nexport PGDATA=/var/lib/pgsql/14/data/\nexport PGPORT=xxx\nexport PGUSER=poxxstgres\nexport PGPASSWORD=xxxx\nexport PGHOST=xxxx\nexport WALG_TAR_SIZE_THRESHOLD=3221225472\nexport WALG_DELTA_MAX_STEPS=3\nexport WALG_UPLOAD_DISK_CONCURRENCY=3\n</code></pre>"},{"location":"postgres/backup/wal-g/#_24","title":"\u6570\u636e\u5907\u4efd","text":"<p>\u4e3b\u4ece\u6570\u636e\u5e93\u5efa\u8bae\u914d\u7f6e\u76f8\u540c\uff0c\u5355\u5b9e\u9645\u4e0a\u53ea\u6709\u4e3b\u5e93\u751f\u6548</p> <pre><code># - Archiving -\narchive_mode = on               # enables archiving; off, on, or always\n                                # (change requires restart)\narchive_command = 'source /opt/wal-g.env &amp;&amp;  wal-g wal-push %p'         # command to use to archive a logfile segment\n                                # placeholders: %p = path of file to archive\n                                #               %f = file name only\n                                # e.g. 'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'\narchive_timeout = 300           # force a logfile segment switch after thi\n</code></pre> <p>\u4ece\u5e93\u6267\u884c\u6570\u636e\u5b8c\u6574\u548c\u589e\u91cf\u5907\u4efd</p> <pre><code># \u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nsource /opt/wal-g.env\n\n# \u6267\u884c\u5168\u91cf\u5907\u4efd\nwal-g backup-push $PGDATA\n</code></pre>"},{"location":"postgres/backup/wal-g/#_25","title":"\u6570\u636e\u6062\u590d","text":"<p>\u6570\u636e\u4e0b\u8f7d</p> <pre><code># \u52a0\u8f7d\u73af\u5883\u53d8\u91cf\nsource /opt/wal-g.env\n\n# \u6267\u884c\u5168\u91cf\u5907\u4efd\nwal-g backup-fetch $PGDATA\n</code></pre> <p>\u5728\u542f\u52a8\u524d\u6839\u636e\u9700\u6c42\uff0c\u5168\u65b0\u7684\u4e3b\u5e93\u8fd8\u662f\u4ece\u5e93 \u914d\u7f6e postgresql.auto.conf</p> <p>\u4ece\u5e93\u5efa\u8bae\u8fd9\u4e24\u4e2a\u90fd\u914d\u7f6e\u4e0a\uff0c\u5f53\u6062\u590d\u65f6\u4f7f\u7528\u7684 wal \u901a\u8fc7 restore_command \u4ece\u8fdc\u7a0b\u6062\u590d\u540e\u4f1a\u81ea\u52a8\u5207\u6362\u5230\u901a\u8fc7 primary_conninfo \u83b7\u53d6\uff0c\u5f53 primary_conninfo \u5931\u8d25\u662f\u4f1a\u5c1d\u8bd5 restore_command \u4ece\u8fdc\u7a0b\u83b7\u53d6\u3002</p> <pre><code>primary_conninfo =\nrestore_command =\nrecovery_target_XXX =\n</code></pre> <pre><code>touch $PGDATA/recovery.signal or $PGDATA/standby.signal\n</code></pre>"},{"location":"postgres/backup/wal-g/#partial-restore-experimental","title":"Partial restore (experimental)","text":"<p>\u90e8\u5206\u6062\u590d\u529f\u80fd\uff0c\u8bd5\u9a8c\u9636\u6bb5</p>"},{"location":"postgres/backup/wal-g/#_26","title":"\u5b9a\u65f6\u4efb\u52a1","text":"<p>cat /etc/cron.weekly/walg-backup-push.sh</p> <pre><code>source /opt/wal-g.env &amp;&amp;  wal-g  backup-push $PGDATA\nsource /opt/wal-g.env &amp;&amp;  wal-g delete retain FULL 4 --confirm\n\n</code></pre> <p>TODO \u5982\u4f55 \u76d1\u63a7\u5907\u4efd\u60c5\u51b5</p>"},{"location":"postgres/backupandrestore/","title":"\u5907\u4efd\u4e0e\u6062\u590d\u65b9\u6848","text":""},{"location":"postgres/backupandrestore/#_2","title":"\u5907\u4efd\u4e0e\u6062\u590d","text":"<p>\u672c\u8282\u5305\u542b\u4e86 PostgreSQL \u6570\u636e\u5e93\u7684\u5907\u4efd\u4e0e\u6062\u590d\u76f8\u5173\u6587\u6863\u3002</p> <ul> <li>\u5907\u4efd\u65b9\u6848\u8bbe\u8ba1</li> <li>\u903b\u8f91\u5907\u4efd</li> <li>\u7269\u7406\u5907\u4efd</li> <li>pgBackRest</li> <li>WAL-G \u5907\u4efd</li> <li>pgcopydb \u8fc1\u79fb</li> <li>PITR \u5907\u4efd\u6062\u590d</li> </ul>"},{"location":"postgres/design/extention/","title":"\u6570\u636e\u5e93\u62d3\u5c55","text":"<ul> <li> <p>\u6d41\u8ba1\u7b97\u6570\u636e\u5e93\u4ea7\u54c1 pipelineDB *</p> </li> <li> <p>\u63a8\u8350\u6570\u636e\u5e93\u4ea7\u54c1 recDB</p> </li> <li> <p>\u65f6\u5e8f\u6570\u636e\u5e93 timescaleDB *</p> </li> <li> <p>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u63d2\u4ef6 citus *</p> </li> <li> <p>\u5217\u5b58\u50a8\u63d2\u4ef6 IMCS, cstore\u7b49</p> </li> <li> <p>\u9762\u5411OLAP\u7684codegen\u6570\u636e\u5e93 pg_LLVM</p> </li> <li> <p>\u5411\u91cf\u8ba1\u7b97\u63d2\u4ef6 vops</p> </li> <li> <p>\u6570\u636e\u5e93\u6027\u80fd\u5206\u6790 pg_stat_statements pg_buffercache</p> </li> <li> <p>\u76f4\u63a5\u8bbf\u95ee\u6570\u636e\u5e93\u6587\u4ef6\u7cfb\u7edf adminpack</p> </li> <li> <p>\u52a0\u5bc6\u6570\u636e pgcrypto</p> </li> <li> <p>\u9884\u70ed\u7f13\u5b58 pg_prewarm</p> </li> <li> <p>\u68c0\u67e5\u5b58\u50a8\uff0c\u7279\u522b\u662f\u8868\u81a8\u80c0 pgstattuple </p> </li> <li> <p>\u6a21\u7cca\u641c\u7d22 pg_trgm</p> </li> <li> <p>\u8fde\u63a5\u5230\u8fdc\u7a0b\u670d\u52a1\u5668 postgres_fdw</p> </li> <li> <p>k\u8fd1\u90bb\uff08KNN\uff09\u641c\u7d22 btree_gist</p> </li> </ul> <p>\u6bd4\u5982\u68c0\u7d2210\u5de6\u53f3\u7684\u6570\u636e\uff0c\u4ef7\u683c\u5728100\u5de6\u53f3\u7684\u6570\u636e\u3002</p> <pre><code>create index idx_value_001 on t_talbe01 USING gist(value);\nselect * from t_table01 where value &lt;-&gt; 100 limit 10;\n</code></pre>"},{"location":"postgres/design/hll/","title":"HyperLogLog","text":"","tags":[]},{"location":"postgres/design/hll/#_1","title":"\u4f7f\u7528\u573a\u666f","text":"<p>\u5728\u5e94\u7528\u4e2d\u7edf\u8ba1\u53bb\u91cd\u540e\u7684\u4e2a\u6570\uff0c\u4f20\u7edf\u7684\u65b9\u6cd5\u901a\u5e38\u662f\u8fd9\u4e48\u64cd\u4f5c count(distict(xxx))\u3002 \u5982\u679c\u6570\u636e\u91cf\u53d8\u5927\uff0c\u6216\u7edf\u8ba1\u9891\u7e41\uff0c\u6027\u80fd\u4f1a\u8d8a\u6765\u8d8a\u5dee\u3002</p> <p>\u53ef\u4ee5\u8003\u8651\u4e00\u4e2a\u8fd1\u4f3c\u7edf\u8ba1\u8ba1\u7b97\u65b9\u6cd5hll</p> <pre><code>create extension hll;\n</code></pre> <p>HyperLogLog \u662f\u4e00\u79cd\u7b97\u6cd5, \u53ef\u4ee5\u7528\u6765\u4f30\u7b97\u6570\u636e\u96c6\u7684\u57fa\u6570. \u57fa\u6570\u662f\u6307\u4e00\u4e2a\u96c6\u5408\u4e2d\u4e0d\u540c\u503c\u7684\u6570\u76ee, \u7b49\u540c\u4e8e <code>COUNT(DISTINCT field)</code> \u8fd4\u56de\u503c. \u5bf9\u4e8e\u8d85\u5927\u6570\u636e\u96c6\u6765\u8bf4, \u7cbe\u786e\u7684\u57fa\u6570\u7edf\u8ba1\u5f80\u5f80\u9700\u8981\u6d88\u8017\u5927\u91cf\u7684\u5185\u5b58\u4e0e\u65f6\u95f4, \u5e76\u4e14\u6d88\u8017\u7684\u5185\u5b58\u4e0e\u65f6\u95f4\u4f1a\u968f\u7740\u6570\u636e\u96c6\u57fa\u6570\u7684\u589e\u52a0\u800c\u6210\u6bd4\u4f8b\u589e\u52a0. \u800c HyperLogLog \u80fd\u591f\u5728\u5e38\u6570\u7ea7\u7684\u5185\u5b58\u4e0e\u65f6\u95f4\u4e0b, \u4ee5\u6781\u4f4e\u7684\u8bef\u5dee\u6765\u83b7\u53d6\u6570\u636e\u96c6\u57fa\u6570\u7684\u8fd1\u4f3c\u7edf\u8ba1.</p>","tags":[]},{"location":"postgres/design/hll/#_2","title":"\u7b80\u5355\u4f8b\u5b50","text":"<pre><code>-- \u5546\u5e97\u7684\u5230\u8bbf\u7edf\u8ba1\nCREATE TABLE store_visitors (\n            store_id              integer, -- \u5546\u5e97ID\n            distinct_visitors     hll   -- \u4e0d\u91cd\u590d\u7684\u5ba2\u6237\u6570\n    );\n\n-- \u65b0\u5e97\u94fa\u6ce8\u518c\nINSERT INTO store_visitors(id, set) VALUES (1, hll_empty());\n\n-- \u6a21\u62df\u5ba2\u6237\u5230\u8bbf\u8fc7\u7a0b\nUPDATE store_visitors SET set = hll_add(set, hll_hash_integer(12345)) WHERE id = 1;\nUPDATE store_visitors SET set = hll_add(set, hll_hash_integer(12346)) WHERE id = 1;\nUPDATE store_visitors SET set = hll_add(set, hll_hash_integer(12345)) WHERE id = 1;\n\n-- \u7edf\u8ba1\u7ed3\u679c\nSELECT hll_cardinality(set) FROM store_visitors WHERE id = 1;\n</code></pre> <p>hll \u6570\u636e\u7ed3\u6784\u53ea\u4f7f\u7528\u5f88\u5c11\u7684\u5185\u5b58\uff0c\u800c\u4e14\u4e0d\u4f1a\u968f\u7740\u6570\u636e\u91cf\u7684\u589e\u52a0\u6027\u80fd\u4e0b\u964d\u3002\u53ef\u4ee5\u7528\u6765\u8fdb\u884c\u5b9e\u65f6\u7edf\u8ba1\u3002</p>","tags":[]},{"location":"postgres/design/hll/#_3","title":"\u66f4\u5b9e\u7528\u7684\u4f8b\u5b50","text":"","tags":[]},{"location":"postgres/design/hll/#_4","title":"\u521b\u5efa\u6d4b\u8bd5\u6570\u636e\u8868\u53ca\u6570\u636e","text":"<pre><code>CREATE TABLE github_events\n(\n    event_id bigint,\n    event_type text,\n    event_public boolean,\n    repo_id bigint,\n    payload jsonb,\n    repo jsonb,\n    user_id bigint,\n    org jsonb,\n    created_at timestamp\n);\n\n\\COPY github_events FROM events.csv CSV\n\u6570\u636e\u6e90 https://examples.citusdata.com/events.csv\n</code></pre>","tags":[]},{"location":"postgres/design/hll/#_5","title":"\u4f20\u7edf\u7edf\u8ba1","text":"<pre><code>-- \u6bcf\u5206\u949f \u6700\u5c0f\u7c92\u5ea6 events\u6570\u91cf \nCREATE TABLE github_events_rollup_minute\n(\n    created_at timestamp,\n    event_count bigint\n);\n\n-- \u8f7d\u5165\u6570\u636e\nINSERT INTO github_events_rollup_minute(\n    created_at,\n    event_count\n)\nSELECT\n    date_trunc('minute', created_at) AS created_at,\n    COUNT(*) AS event_count\nFROM github_events\nGROUP BY 1\n\n</code></pre> <p>\u4e00\u4e9b\u9650\u5236</p> <ul> <li>\u4e0d\u53ef\u4ee5\u8fdb\u884cdistinct\u7edf\u8ba1</li> <li>\u4e0d\u901a\u7ef4\u5ea6\u7684\u7edf\u8ba1\u90fd\u9700\u8981\u5efa\u8868\u3002\u590d\u6742\u5ea6\u9ad8\u3002\u5982\u6309\u65f6\u95f4\u7edf\u8ba1\uff0c\u6309\u4e8b\u4ef6\u7c7b\u578b\u7edf\u8ba1\uff0c\u6309\u65f6\u95f4\u548c\u4e8b\u4ef6\u7c7b\u578b\u7efc\u5408\u7edf\u8ba1\u3002</li> </ul>","tags":[]},{"location":"postgres/design/hll/#hll","title":"\u4f7f\u7528hll \u7edf\u8ba1","text":"<p>\u200b   \u5f97\u76ca\u4e8ehll \u53ef\u4ee5\u5bf9\u4e24\u4e2a\u6216\u591a\u4e2a\u96c6\u5408\u8fdb\u884c\u5408\u5e76\u64cd\u4f5c\u3002</p> <pre><code>-- \u4e00\u5f20\u8868\u641e\u5b9a\u591a\u7ef4\u7edf\u8ba1\nCREATE TABLE github_events_rollup_minute(\n    created_at timestamp,\n    event_type text,\n    distinct_user_id_count hll\n);\n\n-- \u8f7d\u5165\u6570\u636e\nINSERT INTO github_events_rollup_minute(\n    created_at,\n    event_type,\n    distinct_user_id_count\n)\n\nSELECT\n    date_trunc('minute', created_at) AS created_at,\n    event_type,\n    hll_add_agg(hll_hash_bigint(user_id))\nFROM github_events\nGROUP BY 1, 2;\n\n</code></pre> <pre><code>-- \u6309\u65f6\u95f4\u7ef4\u5ea6\u7edf\u8ba1\nSELECT\n    EXTRACT(HOUR FROM created_at) AS hour,\n    hll_cardinality(hll_union_agg(distinct_user_id_count)) AS distinct_count\nFROM\n    github_events_rollup_minute\nWHERE\n    created_at BETWEEN '2016-12-01 00:00:00'::timestamp AND '2016-12-01 23:59:59'::timestamp\nGROUP BY 1\nORDER BY 1;\n\n  hour |  distinct_count\n-------+------------------\n     5 |  10598.637184899\n     6 | 17343.2846931687\n     7 | 18182.5699816622\n     8 | 12663.9497604266\n(4 rows)\n</code></pre> <pre><code>-- \u6309\u4e8b\u4ef6\u7c7b\u578b\u7ef4\u5ea6\u7edf\u8ba1\nSELECT\n    EXTRACT(HOUR FROM created_at) AS hour,\n    hll_cardinality(hll_union_agg(distinct_user_id_count)) AS distinct_push_count\nFROM\n    github_events_rollup_minute\nWHERE\n    created_at BETWEEN '2016-12-01 00:00:00'::timestamp AND '2016-12-01 23:59:59'::timestamp\n    AND event_type = 'PushEvent'::text\nGROUP BY 1\nORDER BY 1;\n\n\n hour | distinct_push_count\n------+---------------------\n    5 |    6206.61586498546\n    6 |    9517.80542100396\n    7 |    10370.4087640166\n    8 |    7067.26073810357\n(4 rows)\n</code></pre>","tags":[]},{"location":"postgres/design/hll/#_6","title":"\u5206\u5e03\u5f0f\u6570\u636e\u5e93","text":"<p>\u200b   \u5728\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u8fdb\u884ccount(distinct(xxx)) \u7edf\u8ba1\uff0c\u4f20\u7edf\u65b9\u5f0f\u5b9e\u73b0\u7684\u903b\u8f91</p> <ul> <li>\u5728\u6bcf\u4e2a\u5206\u7247\u4e0a\u8fdb\u884cdistinct\u7684\u7ed3\u679c\u8fdb\u884c\u6c47\u603b\u540e\uff0c\u518d\u6b21count(distinct())\u3002\u6700\u7ec8\u53ea\u80fd\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u8fdb\u884c\u805a\u5408\u3002</li> <li>map/reduce  \u6027\u80fd\u8f83\u5dee</li> </ul> <p>\u200b    citus\u5229\u7528hll \u8f7b\u677e\u89e3\u51b3</p> <pre><code>CREATE EXTENSION hll;\n</code></pre> <pre><code>SET citus.count_distinct_error_rate TO 0.005;\n</code></pre> <pre><code>CREATE TABLE github_events\n(\n    event_id bigint,\n    event_type text,\n    event_public boolean,\n    repo_id bigint,\n    payload jsonb,\n    repo jsonb,\n    user_id bigint,\n    org jsonb,\n    created_at timestamp\n);\n\nSELECT create_distributed_table('github_events', 'user_id');\n\n\\COPY github_events FROM large_events.csv CSV\n\n-- \u5f00\u59cb\u7edf\u8ba1\nSELECT\n    COUNT(DISTINCT user_id)\nFROM\n    github_events;\n\n-- \u5f00\u59cb\u7edf\u8ba1\nSELECT\n    COUNT(DISTINCT user_id)\nFROM\n    github_events\nWHERE\n    event_type = 'PushEvent'::text;\n</code></pre>","tags":[]},{"location":"postgres/design/hll/#_7","title":"\u53c2\u6570\u4f18\u5316","text":"<p>\u200b           \u5728\u5206\u6790\u578b\u6570\u636e\u5e93PostgreSQL\u7248\u4e2d, HyperLogLog \u7684\u8bef\u5dee\u4e0e\u5185\u5b58\u6d88\u8017\u91cf\u53d7\u5982\u4e0b\u53c2\u6570\u63a7\u5236:</p> <ul> <li>log2m, \u8be5\u53c2\u6570\u63a7\u5236\u7740 HyperLogLog \u5bf9\u6570\u636e\u96c6\u57fa\u6570\u4f30\u7b97\u7684\u8bef\u5dee\u4e3a: <code>1.04 / math.sqrt(2 ** log2m)</code>. \u8be5\u53c2\u6570\u540c\u65f6\u4e5f\u63a7\u5236\u7740 HyperLogLog \u5185\u5b58\u6d88\u8017\u91cf.</li> <li>regwidth, \u8be5\u53c2\u6570\u4e0e log2m \u4e00\u8d77\u51b3\u5b9a\u4e86 HyperLogLog \u5185\u5b58\u6d88\u8017\u91cf\u6700\u591a\u4e3a <code>(2 ** log2m) * regwidth / 8</code> \u5b57\u8282. \u540c\u65f6\u8be5\u51fd\u6570\u4e5f\u51b3\u5b9a\u4e86 HyperLogLog \u6240\u80fd\u4f30\u7b97\u6570\u636e\u96c6\u57fa\u6570\u7684\u6700\u5927\u503c.</li> </ul> <pre><code>\u9ed8\u8ba4\u503c\nhll(log2m=11, regwidth=5, expthresh=-1, sparseon=1) \n</code></pre> <pre><code>\u8bbe\u7f6e\u53c2\u6570\nselect hll_set_defaults(16,5,-1,1);\n</code></pre>","tags":[]},{"location":"postgres/design/insert01/","title":"\u5feb\u901f\u751f\u6210\u5927\u91cf\u6570\u636e","text":""},{"location":"postgres/design/insert01/#1w","title":"\u5728\u6570\u636e\u5e93\u4e2d\u5feb\u901f\u751f\u62101w\u6761\u6570\u636e\uff0c\u6216\u6d4b\u8bd5\u6570\u636e\u5e93\u7684\u5199\u5165\u6027\u80fd\u3002","text":"<pre><code>\u521b\u5efa\u6570\u636e\u5e93\u8868\npostgres=# create table tbl(id int, info text, crt_time timestamp);\nCREATE TABLE \n</code></pre>"},{"location":"postgres/design/insert01/#generate_series","title":"\u65b9\u6cd5\u4e00 generate_series","text":"<pre><code>\u67e5\u770b\u65b9\u6cd5\u51fd\u6570\npostgres=# \\df generate_series \n                                                                   \u51fd\u6570\u5217\u8868\n  \u67b6\u6784\u6a21\u5f0f  |      \u540d\u79f0       |           \u7ed3\u679c\u6570\u636e\u7c7b\u578b            |                            \u53c2\u6570\u6570\u636e\u7c7b\u578b                            | \u7c7b\u578b \n------------+-----------------+-----------------------------------+--------------------------------------------------------------------+------\n pg_catalog | generate_series | SETOF bigint                      | bigint, bigint                                                     | \u5e38\u89c4\n pg_catalog | generate_series | SETOF bigint                      | bigint, bigint, bigint                                             | \u5e38\u89c4\n pg_catalog | generate_series | SETOF integer                     | integer, integer                                                   | \u5e38\u89c4\n pg_catalog | generate_series | SETOF integer                     | integer, integer, integer                                          | \u5e38\u89c4\n pg_catalog | generate_series | SETOF numeric                     | numeric, numeric                                                   | \u5e38\u89c4\n pg_catalog | generate_series | SETOF numeric                     | numeric, numeric, numeric                                          | \u5e38\u89c4\n pg_catalog | generate_series | SETOF timestamp without time zone | timestamp without time zone, timestamp without time zone, interval | \u5e38\u89c4\n pg_catalog | generate_series | SETOF timestamp with time zone    | timestamp with time zone, timestamp with time zone, interval       | \u5e38\u89c4\n(8 \u884c\u8bb0\u5f55)\n\npostgres=# insert into tbl select id, md5(random()::text), clock_timestamp() from generate_series(1,10000) t(id);  \nINSERT 0 10000  \n</code></pre>"},{"location":"postgres/design/insert01/#pgbench","title":"\u65b9\u6cd5\u4e8c pgbench","text":"<pre><code>vi test.sql  \n\\set id random(1,10000000)  \ninsert into tbl values (:id, md5(random()::text), now());  \n\npgbench -M prepared -n -r -f ./test.sql -P 1 -c 32 -j 32 -t 1000  \n\n</code></pre>"},{"location":"postgres/design/insert01/#do","title":"\u65b9\u6cd5\u4e09 do","text":"<pre><code>postgres=# do language plpgsql $$  \ndeclare  \nbegin  \n  for i in 1..100 loop  \n    insert into tbl select mod(id,i), md5(random()::text), clock_timestamp() from generate_series(1,1000) t(id);  \n  end loop;  \nend;  \n$$;  \nDO \n\n</code></pre>"},{"location":"postgres/design/materialized/","title":"\u7269\u5316\u89c6\u56fe","text":"","tags":[]},{"location":"postgres/design/materialized/#_1","title":"\u7269\u5316\u89c6\u56fe","text":"<p>\u7269\u5316\u89c6\u56fe\u4e0e\u666e\u901a\u89c6\u56fe\u7684\u533a\u522b\u5728\u4e8e\uff0c\u7269\u5316\u89c6\u56fe\u662f\u7269\u7406\u4e0a\u771f\u5b9e\u5b58\u5728\u7684\u8868\u3002</p>","tags":[]},{"location":"postgres/design/materialized/#_2","title":"\u7269\u5316\u89c6\u56fe\u7684\u521b\u5efa","text":"<pre><code> \\h create materialized view \nCommand:     CREATE MATERIALIZED VIEW\nDescription: define a new materialized view\nSyntax:\nCREATE MATERIALIZED VIEW [ IF NOT EXISTS ] table_name\n    [ (column_name [, ...] ) ]\n    [ USING method ]\n    [ WITH ( storage_parameter [= value] [, ... ] ) ]\n    [ TABLESPACE tablespace_name ]\n    AS query\n    [ WITH [ NO ] DATA ]\n</code></pre> <p>\u4e0ecreat table as \u57fa\u672c\u76f8\u540c\uff0c\u4f46\u662f\u7269\u5316\u89c6\u56fe\u4e0d\u540c\u4e8etable \u7684\u662f\u7269\u5316\u65f6\u5019\u4e2d\u7684\u6570\u636e\u5185\u5bb9\u53ef\u4ee5\u5237\u65b0\u3002</p>","tags":[]},{"location":"postgres/design/materialized/#_3","title":"\u7269\u5316\u89c6\u56fe\u7684\u66f4\u65b0","text":"<pre><code>postgres=# \\h REFRESH \nCommand:     REFRESH MATERIALIZED VIEW\nDescription: replace the contents of a materialized view\nSyntax:\nREFRESH MATERIALIZED VIEW [ CONCURRENTLY ] name\n    [ WITH [ NO ] DATA ]\n\nURL: https://www.postgresql.org/docs/12/sql-refreshmaterializedview.html\n</code></pre> <ul> <li>\u5168\u91cf\u66f4\u65b0</li> </ul> <p>\u5168\u91cf\u66f4\u65b0\u9501\u8868\u901f\u5ea6\u5feb</p> <ul> <li>\u589e\u91cf\u66f4\u65b0 \uff08CONCURRENTLY\uff09</li> </ul> <p>\u589e\u91cf\u66f4\u65b0\u505a\u7684\u64cd\u4f5c\u662f\u5c06\u5f53\u524d\u89c6\u56fe\u8868\u4e2d\u7684\u6570\u636e\u548cquery\u4e2d\u7684\u6570\u636e\u505a\u4e00\u4e2ajoin\u64cd\u4f5c\uff0c\u7136\u540e\u624d\u5c06\u5dee\u91cf\u505a\u586b\u5145\u3002</p>","tags":[]},{"location":"postgres/design/materialized/#_4","title":"\u5e94\u7528\u573a\u666f","text":"<p>\u5bf9\u62bd\u53d6\u6570\u636e\u7ed3\u679c\u96c6\u8bbf\u95ee\u9891\u7387\u9ad8\uff0c\u4f46\u662f\u66f4\u65b0\u53d8\u5316\u9891\u7387\u4f4e\u3002</p> <p>\u5bf9\u5173\u6ce8\u7684\u6570\u636e\u7ed3\u679c\u96c6\u8fdb\u884c\u62bd\u8c61\u4e3a\u7269\u5316\u89c6\u56fe\u3002\u65b9\u4fbf\u540e\u9762\u5e94\u7528\u7684\u9891\u7e41\u8bfb\u53d6\u3002</p>","tags":[]},{"location":"postgres/design/normal-form/","title":"\u6570\u636e\u5e93\u4e09\u8303\u5f0f\u4e94\u7ea6\u675f","text":""},{"location":"postgres/design/normal-form/#_1","title":"\u4e09\u8303\u5f0f","text":"<ul> <li>\u7b2c\u4e00\u8303\u5f0f\uff1a\u6570\u636e\u8868\u4e2d\u7684\u6bcf\u4e00\u5217\uff08\u6bcf\u4e2a\u5b57\u6bb5\uff09\u5fc5\u987b\u662f\u4e0d\u53ef\u62c6\u5206\u7684\u6700\u5c0f\u5355\u5143\uff0c\u4e5f\u5c31\u662f\u786e\u4fdd\u6bcf\u4e00\u5217\u7684\u539f\u5b50\u6027\uff1b</li> <li>\u7b2c\u4e8c\u8303\u5f0f\uff082NF\uff09\uff1a\u6ee1\u8db31NF\u540e\uff0c\u8981\u6c42\u8868\u4e2d\u7684\u6240\u6709\u5217\uff0c\u90fd\u5fc5\u987b\u4f9d\u8d56\u4e8e\u4e3b\u952e\uff0c\u800c\u4e0d\u80fd\u6709\u4efb\u4f55\u4e00\u5217\u4e0e\u4e3b\u952e\u6ca1\u6709\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2a\u8868\u53ea\u63cf\u8ff0\u4e00\u4ef6\u4e8b\u60c5\uff1b</li> <li>\u7b2c\u4e09\u8303\u5f0f\uff1a\u5fc5\u987b\u5148\u6ee1\u8db3\u7b2c\u4e8c\u8303\u5f0f\uff082NF\uff09\uff0c\u8981\u6c42\uff1a\u8868\u4e2d\u7684\u6bcf\u4e00\u5217\u53ea\u4e0e\u4e3b\u952e\u76f4\u63a5\u76f8\u5173\u800c\u4e0d\u662f\u95f4\u63a5\u76f8\u5173\uff0c\uff08\u8868\u4e2d\u7684\u6bcf\u4e00\u5217\u53ea\u80fd\u4f9d\u8d56\u4e8e\u4e3b\u952e\uff09\uff1b</li> </ul> <pre><code>-- 1NF \u7b2c\u4e00\u8303\u5f0f\n\n\u5b57\u6bb5\u4e0d\u80fd\u518d\u5206\uff0c\u5c31\u6ee1\u8db3\u7b2c\u4e00\u8303\u5f0f\u3002\n\n-- 2NF \u7b2c\u4e8c\u8303\u5f0f\n\n\u6ee1\u8db3\u7b2c\u4e00\u8303\u5f0f\u7684\u524d\u63d0\u4e0b\uff0c\u4e0d\u80fd\u51fa\u73b0\u90e8\u5206\u4f9d\u8d56\u3002\n\n\u6d88\u9664\u8054\u5408\u4e3b\u952e\u53ef\u4ee5\u907f\u514d\u90e8\u5206\u4f9d\u8d56\u3002\u589e\u52a0\u5355\u5217\u5173\u952e\u5b57\u3002\n\n-- 3NF \u7b2c\u4e09\u8303\u5f0f\n\n\u6ee1\u8db3\u7b2c\u4e8c\u8303\u5f0f\u7684\u524d\u63d0\u4e0b\uff0c\u4e0d\u80fd\u51fa\u73b0\u4f20\u9012\u4f9d\u8d56\u3002\n\n\u67d0\u4e2a\u5b57\u6bb5\u4f9d\u8d56\u4e8e\u4e3b\u952e\uff0c\u800c\u6709\u5176\u4ed6\u5b57\u6bb5\u4f9d\u8d56\u4e8e\u8be5\u5b57\u6bb5\u3002\u8fd9\u5c31\u662f\u4f20\u9012\u4f9d\u8d56\u3002\n\n\u5c06\u4e00\u4e2a\u5b9e\u4f53\u4fe1\u606f\u7684\u6570\u636e\u653e\u5728\u4e00\u4e2a\u8868\u5185\u5b9e\u73b0\u3002\n</code></pre> <p>\u7b2c\u4e8c\u8303\u5f0f\uff082NF\uff09\u548c\u7b2c\u4e09\u8303\u5f0f\uff083NF\uff09\u7684\u6982\u5ff5\u5f88\u5bb9\u6613\u6df7\u6dc6\uff0c\u533a\u5206\u5b83\u4eec\u7684\u5173\u952e\u70b9\u5728\u4e8e\uff0c2NF\uff1a\u975e\u4e3b\u952e\u5217\u662f\u5426\u5b8c\u5168\u4f9d\u8d56\u4e8e\u4e3b\u952e\uff0c\u8fd8\u662f\u4f9d\u8d56\u4e8e\u4e3b\u952e\u7684\u4e00\u90e8\u5206\uff1b3NF\uff1a\u975e\u4e3b\u952e\u5217\u662f\u76f4\u63a5\u4f9d\u8d56\u4e8e\u4e3b\u952e\uff0c\u8fd8\u662f\u76f4\u63a5\u4f9d\u8d56\u4e8e\u975e\u4e3b\u952e\u5217\u3002</p> <p>\u4e3e\u4f8b\u8bf4\u660e\uff1a</p> <p>\u5173\u7cfb\u8868\uff08A\uff0cB\uff0cC\uff0cD\uff09\u4e2dA\uff0cB\u662f\u5019\u9009\u952e\uff0c\u90a3\u4e48\uff1a\uff08A\uff0cB\uff09\u2192 C \uff08A\uff0cB\uff09\u2192 D</p> <p>2NF : \u4e0d\u80fd\u5b58\u5728\u975e\u4e3b\u5c5e\u6027\u90e8\u5206\u4f9d\u8d56\u4e3b\u952e \u5982: B \u2192 C \u6216 A \u2192 C \u7b49\u3002\u5f53\u4e3b\u952e\u4e3a\u591a\u503c\u8054\u5408\u4e3b\u952e\u65f6\u53ef\u80fd\u4f1a\u5b58\u5728\u8fdd\u53cd2NF</p> <p>3NF : \u4e0d\u80fd\u5b58\u5728\u975e\u4e3b\u5c5e\u6027\u4e4b\u95f4\u7684\u4f20\u9012\u4f9d\u8d56 \u5982: C \u2192 D \u6216 D \u2192 C</p> <p>BCNF : \u4e0d\u80fd\u5b58\u5728\u4e3b\u5c5e\u6027\u4e4b\u95f4\u7684\u4f20\u9012\u4f9d\u8d56 \u5982 : A \u2192 B \u6216 B \u2192 A</p>"},{"location":"postgres/design/normal-form/#_2","title":"\u4e94\u7ea6\u675f","text":"<ul> <li>primary KEY:\u8bbe\u7f6e\u4e3b\u952e\u7ea6\u675f\uff1b</li> <li>UNIQUE\uff1a\u8bbe\u7f6e\u552f\u4e00\u6027\u7ea6\u675f\uff0c\u4e0d\u80fd\u6709\u91cd\u590d\u503c\uff1b</li> <li>DEFAULT \u9ed8\u8ba4\u503c\u7ea6\u675f</li> <li>NOT NULL\uff1a\u8bbe\u7f6e\u975e\u7a7a\u7ea6\u675f\uff0c\u8be5\u5b57\u6bb5\u4e0d\u80fd\u4e3a\u7a7a\uff1b</li> <li>FOREIGN key :\u8bbe\u7f6e\u5916\u952e\u7ea6\u675f\u3002</li> </ul>"},{"location":"postgres/design/pg_json/","title":"\u6570\u636e\u5e93\u7684json\u7c7b\u578b","text":"","tags":[]},{"location":"postgres/design/pg_json/#json-jsonb","title":"json \u4e0e jsonb","text":"<p>json \u4fdd\u6301\u539f\u59cb\u683c\u5f0f\uff0c  jsonb\u662f\u89e3\u6790\u8f93\u5165\u540e\u4fdd\u5b58\u7684\u4e8c\u8fdb\u5236\uff0c\u5728\u89e3\u6790\u65f6\u4f1a\u8fc7\u6ee4\u6389\u4e0d\u5fc5\u8981\u7684\u7a7a\u683c\u548c\u91cd\u590d\u7684\u5065\u3002</p> <pre><code>SELECT '{\"name\": \"zhangsan\", \"age\":      17, \"sex\":\"m\",\"age\":17.5}'::json;\n                            json                            \n------------------------------------------------------------\n {\"name\": \"zhangsan\", \"age\":      17, \"sex\":\"m\",\"age\":17.5}\n</code></pre> <pre><code>SELECT '{\"name\": \"zhangsan\", \"age\":      17, \"sex\":\"m\",\"age\":17.5}'::jsonb;\n                     jsonb                     \n-----------------------------------------------\n {\"age\": 17.5, \"sex\": \"m\", \"name\": \"zhangsan\"}\n</code></pre> <p>json \u63d2\u5165\u53ef\u80fd\u4f1a\u66f4\u5feb\u4e9b\uff0cjsonb\u7684\u8bfb\u53d6\u66f4\u5feb</p>","tags":[]},{"location":"postgres/design/pg_json/#_1","title":"\u64cd\u4f5c\u7b26","text":"","tags":[]},{"location":"postgres/design/pg_json/#json-jsonb_1","title":"json ,jsonb \u64cd\u4f5c\u7b26","text":"\u64cd\u4f5c\u7b26 \u53f3\u64cd\u4f5c\u6570\u7c7b\u578b \u63cf\u8ff0 \u793a\u4f8b \u7ed3\u679c -&gt; int \u83b7\u53d6JSON\u6570\u7ec4\u5143\u7d20\uff08\u7d22\u5f15\u4ece0\u5f00\u59cb\uff09 select '[{\"a\":\"foo\"},{\"b\":\"bar\"},{\"c\":\"baz\"}]'::json-&gt;2; {\"c\":\"baz\"} -&gt; text \u901a\u8fc7\u952e\u83b7\u53d6\u503c select '{\"a\": {\"b\":\"foo\"}}'::json-&gt;'a'; {\"b\":\"foo\"} -&gt;&gt; int \u83b7\u53d6JSON\u6570\u7ec4\u5143\u7d20\u4e3a text select '[1,2,3]'::json-&gt;&gt;2; 3 -&gt;&gt; text \u901a\u8fc7\u952e\u83b7\u53d6\u503c\u4e3atext select '{\"a\":1,\"b\":2}'::json-&gt;&gt;'b'; 2 #&gt; text[] \u5728\u6307\u5b9a\u7684\u8def\u5f84\u83b7\u53d6JSON\u5bf9\u8c61 select '{\"a\": {\"b\":{\"c\": \"foo\"}}}'::json#&gt;'{a,b}'; {\"c\": \"foo\"} #&gt;&gt; text[] \u5728\u6307\u5b9a\u7684\u8def\u5f84\u83b7\u53d6JSON\u5bf9\u8c61\u4e3a text select '{\"a\":[1,2,3],\"b\":[4,5,6]}'::json#&gt;&gt;'{a,2}'; 3","tags":[]},{"location":"postgres/design/pg_json/#jsonb","title":"jsonb \u64cd\u4f5c\u7b26","text":"","tags":[]},{"location":"postgres/design/pg_json/#_2","title":"\u7d22\u5f15\u67e5\u8be2","text":"","tags":[]},{"location":"postgres/design/pg_json/#key-btree","title":"\u5355key \u67e5\u8be2\u3002btree \u7d22\u5f15","text":"<pre><code>postgres=# create table test (id int, js jsonb);  \nCREATE TABLE  \n\npostgres=# create index idx_test_2 on test using btree (((js-&gt;&gt;'key1')::int));  \nCREATE INDEX  \n\npostgres=# explain select * from test where (js-&gt;&gt;'key1')::int between 1 and 10 ;  \n                                              QUERY PLAN                                                \n------------------------------------------------------------------------------------------------------  \n Index Scan using idx_test_2 on test  (cost=0.15..24.27 rows=6 width=36)  \n   Index Cond: ((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10))  \n(2 rows)  \n\n</code></pre>","tags":[]},{"location":"postgres/design/pg_json/#keybtree_gin","title":"\u591aKEY\u6df7\u5408\uff0c\u4f7f\u7528btree_gin, \u8868\u8fbe\u5f0f\u7d22\u5f15","text":"<pre><code>postgres=# create extension btree_gin;  \nCREATE EXTENSION  \n\npostgres=# create index idx_test_1 on test using gin (((js-&gt;&gt;'key1')::int), ((js-&gt;&gt;'key2')::int), ((js-&gt;&gt;'key3')::int));  \nCREATE INDEX  \n\npostgres=# explain select * from test where (js-&gt;&gt;'key1')::int between 1 and 10   \npostgres-# ;  \n                                                 QUERY PLAN                                                   \n------------------------------------------------------------------------------------------------------------  \n Bitmap Heap Scan on test  (cost=24.07..33.64 rows=6 width=36)  \n   Recheck Cond: ((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10))  \n   -&gt;  Bitmap Index Scan on idx_test_1  (cost=0.00..24.06 rows=6 width=0)  \n         Index Cond: ((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10))  \n(4 rows)  \n\npostgres=# explain select * from test where (js-&gt;&gt;'key1')::int between 1 and 10  or (js-&gt;&gt;'key2')::int between 1 and 15;  \n                                                                                             QUERY PLAN                                                                                               \n----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  \n Bitmap Heap Scan on test  (cost=48.13..59.32 rows=13 width=36)  \n   Recheck Cond: (((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10)) OR ((((js -&gt;&gt; 'key2'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key2'::text))::integer &lt;= 15)))  \n   -&gt;  BitmapOr  (cost=48.13..48.13 rows=13 width=0)  \n         -&gt;  Bitmap Index Scan on idx_test_1  (cost=0.00..24.06 rows=6 width=0)  \n               Index Cond: ((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10))  \n         -&gt;  Bitmap Index Scan on idx_test_1  (cost=0.00..24.06 rows=6 width=0)  \n               Index Cond: ((((js -&gt;&gt; 'key2'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key2'::text))::integer &lt;= 15))  \n(7 rows)  \n\npostgres=# explain select * from test where (js-&gt;&gt;'key1')::int between 1 and 10  and (js-&gt;&gt;'key2')::int between 1 and 15;  \n                                                                                             QUERY PLAN                                                                                                \n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  \n Bitmap Heap Scan on test  (cost=40.00..44.05 rows=1 width=36)  \n   Recheck Cond: ((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10) AND (((js -&gt;&gt; 'key2'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key2'::text))::integer &lt;= 15))  \n   -&gt;  Bitmap Index Scan on idx_test_1  (cost=0.00..40.00 rows=1 width=0)  \n         Index Cond: ((((js -&gt;&gt; 'key1'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key1'::text))::integer &lt;= 10) AND (((js -&gt;&gt; 'key2'::text))::integer &gt;= 1) AND (((js -&gt;&gt; 'key2'::text))::integer &lt;= 15))  \n(4 rows)  \n\n</code></pre>","tags":[]},{"location":"postgres/design/pg_json/#gin","title":"gin \u7d22\u5f15\u7684\u652f\u6301","text":"<pre><code>The default GIN operator class for jsonb supports queries with top-level key-exists operators ?, ?&amp; and ?| operators and path/value-exists operator @&gt;.  \n\nThe non-default GIN operator class jsonb_path_ops supports indexing the @&gt; operator only.  \n</code></pre> <p>\u652f\u6301 @&gt; \u64cd\u4f5c\u7b26\u7684\u7d22\u5f15\u5982\u4e0b\uff08jsonb_path_ops\u53ea\u652f\u6301@&gt;\u64cd\u4f5c\u7b26\uff0c\u7d22\u5f15\u7684\u4f53\u79ef\u8981\u5c0f\u4e9b\u4f46\u662f\u6548\u7387\u9ad8\uff09 </p> <pre><code>create table tbl(id int, js jsonb);\n\ncreate index idx_tbl_1 on tbl using gin (js jsonb_path_ops);\n</code></pre> <p>\u652f\u6301\u9664\u8303\u56f4\u67e5\u8be2\u4ee5\u5916\u7684\u6240\u6709\u67e5\u8be2\u7684\u7d22\u5f15\u5982\u4e0b</p> <pre><code>create table tbl(id int, js jsonb);  \n\npostgres=# create index idx_tbl_1 on tbl using gin (js);  -- \u4f7f\u7528\u9ed8\u8ba4ops\u5373\u53ef \n\n</code></pre>","tags":[]},{"location":"postgres/design/pg_json/#json-key-value","title":"JSON KEY VALUE\u503c\u8303\u56f4\u67e5\u8be2\u52a0\u901f","text":"<p>\u628a\u8303\u56f4\u67e5\u8be2\u7684\u7c7b\u578b\u63d0\u53d6\u51fa\u6765\uff0c\u521b\u5efabtree\u8868\u8fbe\u5f0f\u7d22\u5f15\uff0c\u5982\u679c\u6709\u4efb\u610f\u7ec4\u5408\u7684\u8303\u56f4\u67e5\u8be2\uff0c\u4f7f\u7528gin\u6216rum\u8868\u8fbe\u5f0f\u7d22\u5f15\u3002</p> <pre><code>create extension btree_gin;  \ncreate index idx1 on tbl using gin( ((js-&gt;&gt;'k1')::float8), ((js-&gt;&gt;'k2')::numeric), ... ((js-&gt;&gt;'kn')::float8) );   \n</code></pre> <pre><code>create extension rum;  \ncreate index idx1 on tbl using rum( ((js-&gt;&gt;'k1')::float8), ((js-&gt;&gt;'k2')::numeric), ... ((js-&gt;&gt;'kn')::float8) );\n</code></pre>","tags":[]},{"location":"postgres/design/pg_json/#_3","title":"\u6a21\u7cca\u5339\u914d\u7d22\u5f15","text":"<p>https://pgxn.org/dist/parray_gin/1.3.3/</p> <p>\u7ed3\u5408\u4e86pg_trgm, \u5c06\u6570\u7ec4\u6216JSON\u4e2d\u7684value\u6253\u6563\u6210token\u540e\u8fdb\u884c\u7d22\u5f15\u6784\u5efa. \u5b9e\u73b0\u6570\u7ec4\u6216JSON\u5143\u7d20\u7ea7\u522b\u7684\u6a21\u7cca\u5339\u914d</p>","tags":[]},{"location":"postgres/design/pg_trgm/","title":"pg_trgm\u7684gist\u548cgin\u7d22\u5f15\u52a0\u901f\u5b57\u7b26\u5339\u914d\u67e5\u8be2","text":""},{"location":"postgres/design/pg_trgm/#_1","title":"\u80cc\u666f","text":"<p>\u5bf9\u8f66\u724c\u53f7\u7684\u8bb0\u5fc6\u6709\u65f6\u53ef\u80fd\u8bb0\u4f4f\u7684\u662f\u524d\u51e0\u4f4d\uff0c\u6709\u65f6\u53ef\u80fd\u662f\u540e\u51e0\u4f4d\uff0c\u4e0d\u540c\u7684\u4eba\u8bb0\u8f66\u724c\u53f7\u7684\u4e60\u60ef\u4e5f\u4e0d\u540c\u3002  \u901a\u5e38\u662f\u662f\u5bb9\u6613\u8bb0\u4f4f\u9996\u5c3e\uff0c\u4e2d\u95f4\u4e0d\u6e05\u695a\u3002 \u90a3\u4e48\u5982\u4f55\u5728\u5927\u91cf\u5df2\u6709\u8f66\u724c\u6570\u636e\u4e2d\u5feb\u901f\u6839\u636e\u6a21\u7cca\u7684\u4fe1\u606f\u6765\u8fdb\u884c\u67e5\u8be2\u5462\uff1f </p>"},{"location":"postgres/design/pg_trgm/#_2","title":"\u6a21\u62df","text":"<p>\u6570\u636e\u5e93\u8868\u4e2d\u7ea6\u6709500w\u6761\u8f66\u724c\u53f7\u8bb0\u5f55\uff0c\u5bf9\u8868\u4e2d\u7684\u8f66\u724c\u53f7\u8fdb\u884c\u6a21\u7cca\u67e5\u8be2\u3002 \u5373\u652f\u6301 car_id like '%XXXX%XXX%' \u67e5\u8be2</p> <pre><code>---\u521b\u5efa\u8868\ncreate table t_car (id int , car_id text);\n\n--\u63d2\u5165500\u4e07\u8f66\u724c\u6570\u636e \n\ninsert into t_car select generate_series(1,5000000), (array['\u8fbdA','\u8fbdB','\u5409A','\u5409B','\u9ed1A','\u9ed1B'])[floor(random()*6+1)] || substring(md5(random()::text),0,6);\n\n--\u67e5\u770b\u6570\u636e\n\nselect * from t_car limit 5;\n id |  car_id  \n----+----------\n  1 | \u5409A43bb9\n  2 | \u5409B19b64\n  3 | \u8fbdAfb04e\n  4 | \u5409Bcf90c\n  5 | \u8fbdBe67df\n(5 \u884c\u8bb0\u5f55)\n\n</code></pre>"},{"location":"postgres/design/pg_trgm/#_3","title":"\u7d22\u5f15","text":"<ul> <li>\u987a\u5e8f\u626b\u63cf</li> </ul> <pre><code>explain analyze verbose select * from t_car where car_id = '\u8fbdBe67df';\n                                                          QUERY PLAN                                                          \n------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..54069.87 rows=2 width=14) (actual time=0.458..268.782 rows=4 loops=1)\n   Output: id, car_id\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on public.t_car  (cost=0.00..53069.67 rows=1 width=14) (actual time=140.151..253.061 rows=1 loops=3)\n         Output: id, car_id\n         Filter: (t_car.car_id = '\u8fbdBe67df'::text)\n         Rows Removed by Filter: 1666665\n         Worker 0: actual time=246.618..246.619 rows=0 loops=1\n         Worker 1: actual time=173.812..251.916 rows=1 loops=1\n Planning time: 0.174 ms\n Execution time: 268.820 ms\n(12 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a269.684 ms\n</code></pre> <ul> <li>btree</li> </ul> <pre><code>\u521b\u5efabtree\u7c7b\u578b\u7d22\u5f15\ncreate index btree_index_01 on t_car using btree (car_id);\n\n\u7b49\u503c\u67e5\u8be2,\u7ed3\u679c\u8fd8\u662f\u76f8\u5f53\u7ed9\u529b\npostgres=# explain analyze verbose select * from t_car where car_id = '\u8fbdBe67df';\n                                                          QUERY PLAN                                                          \n------------------------------------------------------------------------------------------------------------------------------\n Index Scan using btree_index_01 on public.t_car  (cost=0.43..3.77 rows=2 width=14) (actual time=0.047..0.057 rows=4 loops=1)\n   Output: id, car_id\n   Index Cond: (t_car.car_id = '\u8fbdBe67df'::text)\n Planning time: 0.218 ms\n Execution time: 0.091 ms\n(5 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a0.971 ms\n\n\u540e\u6a21\u7cca\u67e5\u8be2\uff0c\u4e0d\u5c3d\u4eba\u610f\u3002\u4e0d\u7b26\u5408\u9884\u671f\u3002\npostgres=# explain analyze verbose select * from t_car where car_id like '\u8fbdBe67df%';\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..54119.47 rows=498 width=14) (actual time=0.426..281.444 rows=4 loops=1)\n   Output: id, car_id\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on public.t_car  (cost=0.00..53069.67 rows=208 width=14) (actual time=138.857..270.492 rows=1 loops=3)\n         Output: id, car_id\n         Filter: (t_car.car_id ~~ '\u8fbdBe67df%'::text)\n         Rows Removed by Filter: 1666665\n         Worker 0: actual time=148.488..267.226 rows=2 loops=1\n         Worker 1: actual time=268.058..268.058 rows=0 loops=1\n Planning time: 0.153 ms\n Execution time: 281.481 ms\n(12 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a282.275 ms\n</code></pre> <p>\u4ee5\u4e0abtree\u7d22\u5f15\u6ca1\u6709\u8d77\u5230\u4f5c\u7528\u7684\u539f\u56e0,\u662f\u56e0\u4e3a\u5728\u521b\u5efa\u7d22\u5f15\u65f6\uff0c\u9ed8\u8ba4\u7684opclass\u4e3a\u7b49\u503c\u67e5\u8be2\u3002\u8be6\u60c5 </p> <pre><code>\u91cd\u65b0\u521b\u5efabtree\u7d22\u5f15\n\ndrop index btree_index_01;\ncreate index btree_index_01 on t_car using btree (car_id text_pattern_ops);\n\n\u8fd9\u6b21\u67e5\u8be2\u7ed3\u679c\u7b26\u5408\u9884\u671f\nexplain analyze verbose select * from t_car where car_id like '\u8fbdBe67df%';\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Index Scan using btree_index_01 on public.t_car  (cost=0.43..2.66 rows=498 width=14) (actual time=0.050..0.073 rows=4 loops=1)\n   Output: id, car_id\n   Index Cond: ((t_car.car_id ~&gt;=~ '\u8fbdBe67df'::text) AND (t_car.car_id ~&lt;~ '\u8fbdBe67dg'::text))\n   Filter: (t_car.car_id ~~ '\u8fbdBe67df%'::text)\n Planning time: 0.473 ms\n Execution time: 0.106 ms\n(6 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a1.407 ms\n\n\u524d\u6a21\u7cca\u67e5\u8be2\u8fd8\u662f\u4e0d\u884c\nexplain analyze verbose select * from t_car where car_id like '%\u8fbdBe67df';\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..54119.47 rows=498 width=14) (actual time=0.476..309.504 rows=4 loops=1)\n   Output: id, car_id\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on public.t_car  (cost=0.00..53069.67 rows=208 width=14) (actual time=121.528..297.927 rows=1 loops=3)\n         Output: id, car_id\n         Filter: (t_car.car_id ~~ '%\u8fbdBe67df'::text)\n         Rows Removed by Filter: 1666665\n         Worker 0: actual time=200.075..294.789 rows=1 loops=1\n         Worker 1: actual time=164.486..295.015 rows=1 loops=1\n Planning time: 0.139 ms\n Execution time: 309.536 ms\n(12 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a310.278 ms\n\n\u89e3\u51b3\u524d\u6a21\u7cca\u67e5\u8be2\u7684\u65b9\u6cd5\uff0c\u53cd\u8f6c\u67e5\u8be2\u5b57\u6bb5\u3002\u5728\u903b\u8f91\u4e0a\u53d8\u6210\u540e\u6a21\u7cca\u67e5\u8be2\u3002\ncreate index btree_index_02 on t_car using btree (reverse(car_id) text_pattern_ops);\n</code></pre> <ul> <li>gin</li> </ul> <p>\u771f\u6b63\u7684\u652f\u6301\u6a21\u7cca\u67e5\u8be2</p> <pre><code>\u521b\u5efa\u6269\u5c55\ncreate extension pg_trgm;\n\n\u521b\u5efagin\u7d22\u5f15\n\ncreate index gin_index_01 on t_car using gin(car_id gin_trgm_ops);\n\n\u6a21\u7cca\u67e5\u8be2\u901f\u5ea6\u4e5f\u80fd\u98de\nexplain analyze verbose select * from t_car where car_id like '%\u8fbdBe67df%';\n                                                       QUERY PLAN                                                       \n------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.t_car  (cost=36.86..579.80 rows=498 width=14) (actual time=3.936..4.018 rows=4 loops=1)\n   Output: id, car_id\n   Recheck Cond: (t_car.car_id ~~ '%\u8fbdBe67df%'::text)\n   Heap Blocks: exact=4\n   -&gt;  Bitmap Index Scan on gin_index_01  (cost=0.00..36.73 rows=498 width=0) (actual time=3.900..3.900 rows=4 loops=1)\n         Index Cond: (t_car.car_id ~~ '%\u8fbdBe67df%'::text)\n Planning time: 2.918 ms\n Execution time: 4.359 ms\n\nexplain analyze verbose select * from t_car where car_id like '%\u8fbdBe6%df%';\n                                                        QUERY PLAN                                                         \n---------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.t_car  (cost=17.06..560.00 rows=498 width=14) (actual time=5.958..15.353 rows=35 loops=1)\n   Output: id, car_id\n   Recheck Cond: (t_car.car_id ~~ '%\u8fbdBe6%df%'::text)\n   Rows Removed by Index Recheck: 3273\n   Heap Blocks: exact=3098\n   -&gt;  Bitmap Index Scan on gin_index_01  (cost=0.00..16.93 rows=498 width=0) (actual time=5.172..5.172 rows=3308 loops=1)\n         Index Cond: (t_car.car_id ~~ '%\u8fbdBe6%df%'::text)\n Planning time: 0.224 ms\n Execution time: 15.462 ms\n(9 \u884c\u8bb0\u5f55)\n\n</code></pre>"},{"location":"postgres/design/pg_trgm/#_4","title":"\u6269\u5c55\u9605\u8bfb","text":"<p>rum \u662f\u4e00\u4e2a\u7d22\u5f15\u63d2\u4ef6\uff0c\u7531Postgrespro\u5f00\u6e90\uff0c\u9002\u5408\u5168\u6587\u68c0\u7d22\uff0c\u5c5e\u4e8eGIN\u7684\u589e\u5f3a\u7248\u672c\u3002   </p> <p>\u589e\u5f3a\u5305\u62ec\uff1a   </p> <p>1\u3001\u5728RUM\u7d22\u5f15\u4e2d\uff0c\u5b58\u50a8\u4e86lexem\u7684\u4f4d\u7f6e\u4fe1\u606f\uff0c\u6240\u4ee5\u5728\u8ba1\u7b97ranking\u65f6\uff0c\u4e0d\u9700\u8981\u56de\u8868\u67e5\u8be2\uff08\u800cGIN\u9700\u8981\u56de\u8868\u67e5\u8be2\uff09\u3002    </p> <p>2\u3001RUM\u652f\u6301phrase\u641c\u7d22\uff0c\u800cGIN\u65e0\u6cd5\u652f\u6301\u3002    </p> <p>3\u3001\u5728\u4e00\u4e2aRUM\u7d22\u5f15\u4e2d\uff0c\u5141\u8bb8\u7528\u6237\u5728posting tree\u4e2d\u5b58\u50a8\u9664ctid\uff08\u884c\u53f7\uff09\u4ee5\u5916\u7684\u5b57\u6bb5VALUE\uff0c\u4f8b\u5982\u65f6\u95f4\u6233\u3002    </p> <p>\u5982\u679c\u8fd9\u79cd\u9700\u6c42\u591a\u4e86\u8fd8\u662f\u8003\u8651elasticsearch\u5427</p> <p>zombodb\u662fPostgreSQL\u4e0eElasticSearch\u7ed3\u5408\u7684\u4e00\u4e2a\u7d22\u5f15\u63a5\u53e3\uff0c\u53ef\u4ee5\u76f4\u63a5\u8bfb\u5199ES\u3002</p>"},{"location":"postgres/design/upset/","title":"upset \u7528\u6cd5","text":"","tags":[]},{"location":"postgres/design/upset/#_1","title":"\u521b\u5efa\u8868","text":"<pre><code>DROP TABLE IF EXISTS \"goods\";\nCREATE TABLE \"goods\" (\n  \"store_cd\" int4 NOT NULL,\n  \"good_cd\" varchar(50) COLLATE \"pg_catalog\".\"default\" NOT NULL,\n  \"name\" varchar(255) COLLATE \"pg_catalog\".\"default\"\n);\n\nINSERT INTO \"goods\" VALUES (101, '1', '\u5f20\u4e09');\nINSERT INTO \"goods\" VALUES (102, '2', '\u674e\u56db');\nINSERT INTO \"goods\" VALUES (103, '3', '\u738b\u4e94');\n\nALTER TABLE \"goods\" ADD CONSTRAINT \"pr_cd_key\" PRIMARY KEY (\"store_cd\", \"good_cd\");\n\n</code></pre>","tags":[]},{"location":"postgres/design/upset/#_2","title":"\u6570\u636e\u5b58\u5728\u5219\u66f4\u65b0\u6570\u636e\uff0c\u4e0d\u5b58\u5728\u5219\u63d2\u5165\u6570\u636e","text":"<pre><code>---\nINSERT INTO GOODS VALUES ( 104, '4', '\u8d75\u516d' ) \nON CONFLICT ON CONSTRAINT pr_key_cd DO\nUPDATE \n    SET NAME = '\u66f4\u65b0' \nWHERE\n    GOODS.STORE_CD = '104' \n    AND GOODS.GOOD_CD = '4'\n----\npr_key_cd\u4e3a\u5fc5\u987b\u4e3a\u552f\u4e00\u4e3b\u952e\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e0b\u9762\u5199\u6cd5\uff08\u6ce8\u610f\uff1a\u5fc5\u987b\u4fdd\u8bc1\u7b5b\u9009\u51fa\u6570\u636e\u552f\u4e00\uff09\nINSERT INTO GOODS VALUES ( 104, '4', '\u8d75\u516d' ) \nON CONFLICT ( STORE_CD, GOOD_CD ) DO\nUPDATE \n    SET NAME = '\u66f4\u65b0' \nWHERE\n    GOODS.STORE_CD = '104' \n    AND GOODS.GOOD_CD = '4'\n    AND NAME &lt;&gt; '\u66f4\u65b0' ---\u8fc7\u6ee4 \u6ca1\u6709\u5fc5\u8981\u7684\u66f4\u65b0\n</code></pre>","tags":[]},{"location":"postgres/design/upset/#_3","title":"\u6570\u636e\u5b58\u5728\u5219\u5ffd\u7565\uff0c\u4e0d\u5b58\u5728\u5219\u63d2\u5165","text":"<pre><code>INSERT INTO GOODS VALUES ( 104, '4', '\u8d75\u516d' ) \nON CONFLICT ON CONSTRAINT pr_key_cd DO NOTHING;\n\n-- \u53e6\u4e00\u79cd\u5b9e\u73b0\u65b9\u5f0f\ninsert into goods select 103,'3','\u8d75\u516d' from (select 1) temp where not exists (select 1 from goods where store_cd=103 and good_cd = '3');\n</code></pre> <p>\u4e0a\u9762\u7684\u4e24\u79cd\u7684\u5199\u6cd5\uff0c\u662f\u5148\u6267\u884cinsert\u5982\u679c\u4e3b\u952e\u51b2\u7a81\u5219\u6267\u884cupdate\uff0c\u6ca1\u6709\u51b2\u7a81\u5c31\u6267\u884cinsert\u4e86\u3002</p>","tags":[]},{"location":"postgres/design/upset/#update","title":"\u5148\u6267\u884cupdate\u8bed\u53e5","text":"<pre><code>WITH TABLE1 AS ( UPDATE GOODS SET NAME = '\u66f4\u65b0' WHERE STORE_CD = '104' AND GOOD_CD = '4' RETURNING * ) \nINSERT INTO GOODS SELECT  104, '4', '\u8d75\u516d' \nWHERE NOT EXISTS ( SELECT 1 FROM TABLE1 WHERE STORE_CD = '104' AND GOOD_CD = '4') \n</code></pre>","tags":[]},{"location":"postgres/design/wal_lsn/","title":"\u4f8b\u5b50","text":"<pre><code>select pg_current_wal_lsn(),pg_walfile_name(pg_current_wal_lsn()),pg_walfile_name_offset(pg_current_wal_lsn());\n pg_current_wal_lsn |     pg_walfile_name      |       pg_walfile_name_offset\n--------------------+--------------------------+------------------------------------\n 2478/BB36EC90      | 0000000300002478000000BB | (0000000300002478000000BB,3599504)\n(1 row)\n</code></pre> <pre><code>select x'36EC90'::int ;\n  int4\n---------\n 3599504\n(1 row)\n</code></pre>","tags":[]},{"location":"postgres/design/wal_lsn/#_2","title":"\u8bf4\u660e","text":"","tags":[]},{"location":"postgres/design/wal_lsn/#_3","title":"\u65b9\u6cd5","text":"<ul> <li>pg_current_wal_lsn()\uff1a\u83b7\u5f97\u5f53\u524dwal\u65e5\u5fd7\u5199\u5165\u4f4d\u7f6e\u3002</li> <li>pg_walfile_name():\u8f6c\u6362wal\u65e5\u5fd7\u4f4d\u7f6e\u4e3a\u6587\u4ef6\u540d\u3002</li> <li>pg_walfile_name_offset():\u8fd4\u56de\u8f6c\u6362\u540e\u7684wal\u65e5\u5fd7\u6587\u4ef6\u540d\u548c\u504f\u79fb\u91cf\u3002</li> </ul>","tags":[]},{"location":"postgres/design/wal_lsn/#lsn","title":"LSN","text":"<p>LSN:2478/BB36EC90</p> <ul> <li>2478\uff1a\u4ee3\u8868wal\u6587\u4ef6\u7684\u7b2c\u4e8c\u90e8\u5206</li> <li>BB\uff1a\u4ee3\u8868wal\u6587\u4ef6\u7684\u6700\u540e\u4e24\u4f4d</li> <li>36EC90\uff1a\u4ee3\u8868\u504f\u79fb\u91cf</li> </ul>","tags":[]},{"location":"postgres/design/wal_lsn/#wal","title":"WAL","text":"<p>0000000300002478000000BB wal\u6587\u4ef6\u75318*3 = 24\u4e2a\u5b57\u7b26\uff0c\u4e09\u90e8\u5206\u7ec4\u6210\uff0c\u6bcf\u90e8\u5206\u75318\u4e2a\u5b57\u7b26\u7ec4\u6210\uff0c\u4ee3\u8868\u542b\u4e49\u5982\u4e0b</p> <ul> <li>00000003\uff1a\u4ee3\u8868\u6570\u636e\u5e93\u8fd0\u884c\u7684\u65f6\u95f4\u8f74\uff0c\u5982\u679c\u6062\u590d\u8fc7\u6570\u636e\u5e93\uff08\u4e3b\u5907\u5207\u6362\uff09\u8fd9\u4e2a\u503c\u4f1a\u589e\u5927</li> <li>00002478\uff1a\u5bf9LSN\u7684\u7b2c\u4e8c\u90e8\u5206\u5bf9\u5e94</li> <li>000000BB\uff1a\u4ee3\u8868walfile\u6587\u4ef6\u7684\u6700\u540e\u4e24\u4f4d</li> </ul>","tags":[]},{"location":"postgres/design/wal_size/","title":"wal \u603b\u5927\u5c0f","text":""},{"location":"postgres/design/wal_size/#_1","title":"\u9519\u8bef\u63cf\u8ff0","text":"<p>\u5728\u4e3b\u4ece\u590d\u5236\u5e94\u7528\u573a\u666f\u4e2d\uff0c\u4f1a\u9047\u5230\u4e00\u4e2a\u9ebb\u70e6\u4e8b\u3002</p> <pre><code>requested WAL segment 000000020000013F000000E8 has already been removed\n</code></pre> <p>\u539f\u56e0\u4e5f\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u4ece\u5e93\u5728\u540c\u6b65\u4e3b\u5e93\u7684\u65f6\u5019\uff0c\u4e3b\u5e93\u7684wal\u65e5\u5fd7\u5df2\u7ecf\u88ab\u6e05\u7406\u3002</p> <p>\u4e4b\u6240\u4ee5\u9ebb\u70e6\uff0c\u662f\u56e0\u4e3a\u5982\u679c\u4e3b\u5e93\u7684wal\u6ca1\u6709\u5f52\u6863\u5907\u4efd\uff0c\u4ece\u5e93\u53ea\u80fd\u6e05\u7a7a\u73b0\u6709\u6570\u636e\uff0c\u91cd\u65b0\u62c9\u53d6\u4e00\u4efd\u5168\u91cf\u3002\u5bf9\u6570\u636e\u91cf\u8f83\u5927\u7684\u670d\u52a1\u8017\u65f6\u8017\u529b\u3002\u6700\u597d\u662f\u80fd\u5c3d\u529b\u907f\u514d\u8fd9\u6837\u7684\u4e8b\u60c5\u53d1\u751f\u3002</p>"},{"location":"postgres/design/wal_size/#_2","title":"\u65e5\u5fd7\u4fdd\u7559\u539f\u5219","text":""},{"location":"postgres/design/wal_size/#_3","title":"\u51e0\u4e2a\u91cd\u8981\u7684\u53c2\u6570","text":"<ul> <li>wal_keep_size \u9ed8\u8ba4128MB  \uff0c \u7248\u672c13 \u5f00\u59cb wal_keep_segments\u53c2\u6570\u5e9f\u5f03\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662fwal_keep_size\u3002 wal_keep_size = wal_keep_segments * wal_segment_size (typically 16MB)</li> <li>max_wal_size  </li> <li>min_wal_size</li> <li>max_slot_wal_keep_size</li> </ul> <p>\u5047\u8bbepg_wal\u4e0b\u7684\u6587\u4ef6\u4e3a\uff1a</p> <pre><code>000000A7000000040000005A\n000000A7000000040000005B\n000000A7000000040000005C\n000000A7000000040000005D\n000000A7000000040000005E\n000000A7000000040000005F\n000000A70000000400000060\n000000A70000000400000061\n000000A70000000400000062\n000000A70000000400000063\n000000A70000000400000064\n</code></pre> <p>\u5047\u8bbe\u5f53\u524d\u6b63\u5728\u5199\u7684WAL\u6587\u4ef6\u4e3a000000A70000000400000060\uff0c\u5219wal_keep_segments\u63a7\u5236000000A7000000040000005A\u5230000000A70000000400000060\u7684\u4e2a\u6570\uff0c \u800cmin_wal_size\u63a7\u5236000000A70000000400000060\u5230000000A70000000400000064\uff0c\u5373\u8fd9\u4e00\u6bb5\u81f3\u5c11\u8981\u4fdd\u7559min_wal_size\u7684WAL\u65e5\u5fd7\u3002</p> <p>wal \u65e5\u5fd7\u7684\u4fdd\u7559\u4e3b\u8981\u662f\u7531 <code>min_wal_size + wal_keep_segments</code> \u51b3\u5b9a\u3002</p>"},{"location":"postgres/design/wal_size/#_4","title":"\u6e05\u7406\u7684\u65f6\u673a","text":"<p>checkpoint\u65f6</p> <p>\u5b9e\u9645\u4e0a\u53c2\u6570max_wal_size\u4e3b\u8981\u662f\u4e3a\u4e86\u63a7\u5236checkpoint\u53d1\u751f\u7684\u9891\u7e41\u7a0b\u5ea6\uff1a</p> <p>target = (double) ConvertToXSegs(max_wal_size_mb) / (2.0 + CheckPointCompletionTarget);</p> <p>\u5982\u679ccheckpoint_completion_target\u8bbe\u7f6e\u4e3a0.5\u65f6\uff0c\u5219\u6bcf\u5199\u4e86 max_wal_size/2.5 \u7684WAL\u65e5\u5fd7\u65f6\uff0c\u5c31\u4f1a\u53d1\u9001\u4e00\u6b21checkpoint\u3002</p> <p>checkpoint_completion_target\u7684\u8303\u56f4\u4e3a0~1\uff0c\u90a3\u4e48\u7ed3\u679c\u5c31\u662f\u5199\u7684WAL\u7684\u65e5\u5fd7\u91cf\u8d85\u8fc7: max_wal_size\u76841/3\uff5e1/2\u65f6\uff0c\u5c31\u4f1a\u53d1\u751f\u4e00\u6b21checkpoint\u3002</p>"},{"location":"postgres/design/wal_size/#_5","title":"\u65e5\u5fd7\u4fdd\u7559\u7b56\u7565","text":"<p>\u8fc7\u5c0f\uff0c\u5bb9\u6613\u5bfc\u81f4\u4ece\u5e93wal\u65e5\u5fd7\u540c\u6b65\u65f6\u4e22\u5931</p> <p>\u8fc7\u5927\uff0c\u6d6a\u8d39\u5b58\u50a8\u7a7a\u95f4\u3002</p>"},{"location":"postgres/design/wal_size/#slots","title":"\u7ed3\u5408slots","text":"<p>\u590d\u5236\u69fd\u662f\u7528\u6765\u4fdd\u8bc1\u903b\u8f91\u590d\u5236\u6216\u7269\u7406\u590d\u5236\u9700\u8981\u7684WAL\u65e5\u5fd7\u4e0d\u4f1a\u88ab\u6e05\u7406\u6389</p> <p>\u907f\u514d\u56e0slot\u5f02\u5e38\u5bfc\u81f4wal\u5806\u79ef\u8fc7\u591a \u9700\u8981\u76d1\u63a7 \u590d\u5236\u69fd\u7684\u72b6\u6001</p> <pre><code>SELECT slot_name, slot_type, database, xmin,active,active_pid FROM pg_replication_slots ORDER BY age(xmin) DESC;\n</code></pre> <p>max_slot_wal_keep_size</p>"},{"location":"postgres/design/wal_size/#wal_1","title":"\u6269\u5c55\u59ff\u52bf wal \u81a8\u80c0\u9884\u9632","text":""},{"location":"postgres/design/wal_size/#_6","title":"\u957f\u4e8b\u52a1","text":"<pre><code>select pid,usename, xact_start from pg_stat_activity where now() - xact_start &gt; interval '8 hours';\n</code></pre> <pre><code>select pid,client_addr,usename,datname, xact_start,state from pg_stat_activity where state not in ('active','idle') order by  xact_start;\n</code></pre>"},{"location":"postgres/design/wal_size/#_7","title":"\u4e24\u9636\u6bb5\u4e8b\u52a1","text":"<pre><code>SELECT gid, prepared, owner, database, transaction AS xmin\nFROM pg_prepared_xacts\nORDER BY age(transaction) DESC;\n</code></pre>"},{"location":"postgres/design/wal_size/#wal_2","title":"\u4e3b\u5e93\u7684WAL\u65e5\u5fd7\u7684\u5f52\u6863\u672a\u6210\u529f","text":"<p>https://www.postgresql.org/docs/16/wal-configuration.html</p>"},{"location":"postgres/extentions/citus01/","title":"citus \u7b80\u5355\u5e94\u7528","text":""},{"location":"postgres/extentions/citus01/#_1","title":"\u5e38\u7528\u65b9\u6cd5","text":"<p>\u96c6\u7fa4\u7ba1\u7406</p> <pre><code>\u52a0\u5165\u8282\u70b9\nSELECT * from master_add_node('worker-101', 5432);\n\u67e5\u770b\u8282\u70b9\u72b6\u6001\nSELECT * FROM master_get_active_worker_nodes();\n\nselect * from pg_dist_node;\n</code></pre> <p>\u6570\u636e\u5e93\u7ba1\u7406</p> <ul> <li>\u5206\u7247\u8868(distributed table \uff0c hash | append )</li> <li>\u53c2\u8003\u8868(reference table \u6570\u636e\u91cf\u5c0f)</li> <li>\u672c\u5730\u8868(\u539f\u751f\u8868\uff0c\u6ca1\u6709\u4efb\u4f55\u5904\u7406.\u517c\u5bb9\u6027\u9ad8)</li> </ul> <pre><code>\u5bf9\u8868\u8fdb\u884c\u5206\u7247\n\nSELECT create_distributed_table('companies', 'id');\n\n\u5206\u7247\u67e5\u770b\nSELECT * from pg_dist_shard;\n</code></pre> <p>\u5143\u6570\u636e\u8868</p> <pre><code>pg_dist_shard\npg_dist_placement\npg_dist_node\n</code></pre> <p>\u53c2\u6570</p> <p>\u66f4\u591a\u53c2\u8003</p> <p>sql \u9650\u5236</p> <p>1 \u975e\u4eb2\u548c\u6027\u8868\u4e4b\u95f4\u7684outer join </p> <p>\u65b9\u6848\uff1a CTE \u5e7f\u64ad \u3001\u4e34\u65f6\u8868\u3001fdw</p> <p>2 \u672c\u5730\u8868\u53c2\u4e0e\u7684join \u4e0d\u652f\u6301</p> <p>3 postgis \u652f\u6301\u7684\u9650\u5236\uff0c\u590d\u6742\u8ba1\u7b97</p> <p>\u6ce8\u610f\u4e8b\u9879</p> <p>1 max_adptive_executor_pool_size \u9632\u6b62\u4f46\u5e93\u8d1f\u8f7d\u8fc7\u5927</p> <p>2 \u53c2\u8003\u8868\u9ed8\u8ba4\u67e5\u8be2\u6bcf\u6b21\u90fd\u662f\u8bbf\u95ee\u4e00\u4e2a\u6570\u636e\u5e93\u7684\u5206\u5e03\u3002 \u8bbe\u7f6e task_assigment_policy TO 'rond ' \u8f6e\u8be2\u4f7f\u7528</p> <p>3 ddl \u8bed\u8a00\u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e2d\u6267\u884c\u3002</p> <p>https://blog.csdn.net/icreasy3/article/details/90720192</p>"},{"location":"postgres/extentions/citus11/","title":"\u73af\u5883\u4ecb\u7ecd","text":"","tags":[]},{"location":"postgres/extentions/citus11/#_2","title":"\u7248\u672c\u4fe1\u606f","text":"<ul> <li> <p>centos7</p> </li> <li> <p>postgres 14.4</p> </li> <li> <p>citus 110-2</p> </li> </ul>","tags":[]},{"location":"postgres/extentions/citus11/#_3","title":"\u5b89\u88c5\u6b65\u9aa4","text":"<ul> <li> <p>\u5b89\u88c5</p> <p><code>\u7565</code></p> </li> <li> <p>\u914d\u7f6e</p> </li> </ul> <pre><code>sudo pg_conftool 14 main set wal_level logical\nsudo pg_conftool 14 main set listen_addresses '*'\nsudo pg_conftool 14 main set shared_preload_libraries citus\n</code></pre> <pre><code>sudo vi /etc/postgresql/14/main/pg_hba.conf\n</code></pre> <ul> <li>\u521b\u5efa\u6570\u636e\u5e93\u514d\u5bc6\u7801\u767b\u5f55</li> </ul> <p><code>-- Edit .pgpass in the postgres user\u2019s home directory,    hostname:port:database:username:password</code></p>","tags":[]},{"location":"postgres/extentions/citus11/#_4","title":"\u8282\u70b9\u4fe1\u606f","text":"nodenanme IP role master01 10.10.20.11 coordinator worker01 10.10.2.12 worker worker02 10.10.2.14 worker","tags":[]},{"location":"postgres/extentions/citus11/#_5","title":"\u642d\u5efa\u96c6\u7fa4","text":"<p>\u521b\u5efadatabase&amp;extension</p> <p>\u5728\u6bcf\u4e2aworker\u8282\u70b9\u4e0a\u6267\u884c</p> <pre><code>CREATE DATABASE newbie;\n\\c newbie\nCREATE EXTENSION citus;\n</code></pre> <p>\u5728master\u63a5\u8282\u70b9\u4e0a\u6267\u884c</p> <pre><code>CREATE DATABASE newbie;\n\\c newbie\nCREATE EXTENSION citus;\nSELECT citus_set_coordinator_host('10.10.2.11', 5432);\n#\u6dfb\u52a0worker\u8282\u70b9\nSELECT * from citus_add_node('10.10.2.12', 5432);\nSELECT * from citus_add_node('10.10.2.14', 5432);\n-- ... for all of them\n</code></pre> <p>\u67e5\u770b\u96c6\u7fa4\u8282\u70b9</p> <pre><code>SELECT * FROM citus_get_active_worker_nodes();\n node_name  | node_port \n------------+-----------\n 10.10.2.12 |      5432\n 10.10.2.14 |      5432\n(2 rows)\n</code></pre> <p>\u67e5\u770b\u8282\u70b9\u5206\u8868</p> <pre><code>select * from pg_dist_node;\n nodeid | groupid |  nodename  | nodeport | noderack | hasmetadata | isactive | noderole | nodecluster | metadatasynced | shouldhaveshards \n--------+---------+------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------\n      1 |       0 | 10.10.2.11 |     5432 | default  | t           | t        | primary  | default     | t              | f\n      3 |       2 | 10.10.2.12 |     5432 | default  | t           | t        | primary  | default     | t              | t\n      4 |       3 | 10.10.2.14 |     5432 | default  | t           | t        | primary  | default     | t              | t\n\n</code></pre>","tags":[]},{"location":"postgres/extentions/citus11/#_6","title":"\u8868\u7ba1\u7406","text":"","tags":[]},{"location":"postgres/extentions/citus11/#_7","title":"\u8868\u7c7b\u578b","text":"<ul> <li>\u672c\u5730\u8868</li> <li>\u53c2\u8003\u8868</li> <li>\u5206\u5e03\u8868</li> </ul>","tags":[]},{"location":"postgres/extentions/citus11/#_8","title":"\u672c\u5730\u8868","text":"<p>\u4e0e\u4f20\u7edf\u8868\u4f7f\u7528\u65b9\u5f0f\u4e00\u81f4\uff0c\u6570\u636e\u53ea\u5b58\u653e\u5728master\u8282\u70b9</p>","tags":[]},{"location":"postgres/extentions/citus11/#_9","title":"\u53c2\u8003\u8868","text":"<p>\u6bcf\u4e2a\u8282\u70b9(master , worker)\u5305\u542b\u4e00\u4efd\u8868\u7684\u6240\u6709\u6570\u636e\uff0c\u5bf9\u8868\u7684DML\u91c7\u75282pc\u3002\u9002\u7528\u4e8e\u5b58\u653e\u4e1a\u52a1\u5143\u6570\u636e\uff0c\u4fbf\u4e8e\u4e0e\u5206\u5e03\u8868\u8054\u5408\u67e5\u8be2\u4f7f\u7528</p>","tags":[]},{"location":"postgres/extentions/citus11/#_10","title":"\u5206\u5e03\u8868","text":"<p>\u6839\u636e\u5206\u5e03\u952e\uff08\u901a\u5e38\u4e3a\u8868\u7684\u6307\u5b9a\u5217\uff09\uff0c\u5c06\u6570\u636e\u5206\u5e03\u5230\u6bcf\u4e2aworker\u8282\u70b9\u4e2d\u3002\u6bcf\u4e2aworker\u8282\u70b9\u5305\u542b\u8868\u7684\u90e8\u5206\u6570\u636e\u5185\u5bb9</p>","tags":[]},{"location":"postgres/extentions/citus11/#_11","title":"\u67e5\u770b\u8868\u4fe1\u606f","text":"<pre><code>-- \u5305\u62ec\u53c2\u8003\u8868\u548c\u5206\u5e03\u8868\nselect * from citus_tables ;\n\n-- \u5305\u62ec\u6240\u6709\u7c7b\u578b\u7684\u8868\u53ca\u5206\u5e03\u4fe1\u606f\nselect * from citus_shards ;\n\n--- \u67e5\u770b\u5e93\u5206\u5e03\u8868size\nSELECT logicalrelid AS name,\n       pg_size_pretty(citus_table_size(logicalrelid)) AS size\n  FROM pg_dist_partition where name = '$tablename';\n\n--- \u67e5\u770b\u5206\u5e03\u8868\u5206\u5e03\u5728\u6bcf\u4e2anode\u4e0a\u7684size \nselect table_name, nodename as node_name,round(sum(shard_size)*100.0/citus_table_size(table_name),2) percent, pg_size_pretty(sum(shard_size)) as table_size_node,pg_size_pretty(citus_table_size(table_name)) AS table_size from citus_shards where citus_table_type = 'distributed' group by nodename , table_name;\n\n          table_name           | node_name  | percent | table_size_node | table_size\n-------------------------------+------------+---------+-----------------+------------\nmydistable | 10.10.2.12 |   32.60 | 1424 kB         | 4368 kB\nmydistable | 10.10.2.14 |   60.81 | 2656 kB         | 4368 kB\n(2 rows)\n\n</code></pre>","tags":[]},{"location":"postgres/extentions/citus11/#_12","title":"\u8868\u7ba1\u7406","text":"","tags":[]},{"location":"postgres/extentions/citus11/#_13","title":"\u53c2\u8003\u8868\u521b\u5efa","text":"<pre><code>SELECT create_reference_table('tablename');\n</code></pre>","tags":[]},{"location":"postgres/extentions/citus11/#_14","title":"\u5206\u5e03\u8868\u521b\u5efa","text":"<p>```istributed relations cannot have UNIQUE, EXCLUDE, or PRIMARY KEY constraints that do not include the partition column (with an equality operator if EXCLUDE) SELECT create_distributed_table('tablename', 'column');</p> <pre><code>\n####   \u6ce8\u610f\u4e8b\u9879 \n\n`distributed relations cannot have UNIQUE, EXCLUDE, or PRIMARY KEY constraints that do not include the partition column (with an equality operator if EXCLUDE)`\n\n#### \u4eb2\u548c\u6027\n\n</code></pre> <p>SELECT create_distributed_table('github_events', 'repo_id',                                 colocate_with =&gt; 'github_repo');</p> <pre><code>\n#### \u66f4\u65b0\u8868\u4eb2\u548c\u6027\n\n</code></pre> <p>SELECT update_distributed_table_colocation('A', colocate_with =&gt; 'B');</p> <pre><code>\n#### \u5206\u7247\u6570\u91cf\n\n</code></pre> <p>show citus.shard_count; set citus.shard_count = 64;</p> <pre><code>\n#### \u67e5\u770b\u9ed8\u8ba4\u5206\u5e03\u7b56\u7565\n\n````\nSELECT * FROM pg_dist_rebalance_strategy;\n````\n\n#### \u8bbe\u7f6e\u5206\u5e03\u7b56\u7565\n\n</code></pre> <p>SELECT citus_set_default_rebalance_strategy('by_disk_size');</p> <pre><code>\n#### \u8fdb\u5ea6\u67e5\u770b\n\n</code></pre> <p>SELECT * FROM get_rebalance_progress();</p> <pre><code>\n#### \u5220\u9664\u672c\u5730\u6570\u636e\n\n</code></pre> <p>-- \u5728\u5c06\u666e\u901a\u8868\u8f6c\u5316\u5316\u4e3a\u5206\u5e03\u8868\u6216\u53c2\u8003\u8868\u540e\uff0c\u6e05\u7a7a\u672c\u5730\u6570\u636e\uff0c\u5f85\u6d4b\u8bd5 SELECT truncate_local_data_after_distributing_table('tablename')</p> <pre><code>\n### \u6062\u590d\u8868\u4e3a\u672c\u5730\u8868\n\n</code></pre> <p>select undistribute_table('table_name') select undistribute_table('table_name',cascade_via_foreign_keys=&gt;true); # \u5371\u9669\u64cd\u4f5c\uff0c\u6ce8\u610f\u6240\u6709\u8868\u5173\u8054\u5173\u7cfb</p> <pre><code>\n\n\n## \u51fd\u6570\u7ba1\u7406\n\n### \u81ea\u5b9a\u4e49\u51fd\u6570\n\n</code></pre> <p>CREATE OR REPLACE FUNCTION   delete_campaign(company_id int, campaign_id int) RETURNS void LANGUAGE plpgsql AS $fn$ BEGIN   DELETE FROM campaigns    WHERE id = $2 AND campaigns.company_id = $1;   DELETE FROM ads    WHERE ads.campaign_id = $2 AND ads.company_id = $1; END; $fn$;</p> <pre><code>\n### \u81ea\u5b9a\u4e49\u51fd\u6570\u4e0b\u63a8\n\n</code></pre> <p>SELECT create_distributed_function(   'delete_campaign(int, int)', 'company_id',   colocate_with := 'campaigns' );</p> <pre><code>\n### \u67e5\u770b\u6267\u884c\u8ba1\u5212\uff0c\u67e5\u770b\u5168\u90e8\u7684task\n\n</code></pre> <p>SET citus.explain_all_tasks = 1;</p> <pre><code>\n# \u9ad8\u7ea7\u7279\u6027\n\n## \u91cd\u65b0\u5206\u5e03\n\n\u52a0\u5165\u5220\u9664\u8282\u70b9\u65f6\uff0c\u4e0d\u505c\u670d\u6570\u636e\u8fc1\u79fb\n\n</code></pre> <p>rebalance_table_shards()  #\u6240\u6709 rebalance_table_shards('tabename') #\u4e00\u4e2a\u8868</p> <pre><code>\n## \u79df\u6237\u9694\u79bb\n\n\u5927\u79df\u6237\u5355\u72ec\u5206\u914d\uff0c\u72ec\u4eabworker\u8d44\u6e90\n\n\u521b\u5efa\u5206\u914d\n\n</code></pre> <p>-- \u6839\u636e\u79df\u6237ID\u9694\u79bb\u7684\u5206\u7247 -- \u8fd4\u56de\u65b0\u7684shard id\u3002 SELECT isolate_tenant_to_new_shard('table_name', tenant_id); SELECT isolate_tenant_to_new_shard('table_name', tenant_id\uff0c'CASCADE'); \u2502 isolate_tenant_to_new_shard \u2502 \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524 \u2502 102240 \u2502</p> <pre><code>\n\u8fc1\u79fb\u5206\u7247\n\n</code></pre> <p>SELECT nodename, nodeport   FROM citus_shards  WHERE shardid = 102240;</p> <p>--  \u5217\u51fa\u53ef\u80fd\u6301\u6709\u8be5\u5206\u7247\u7684\u53ef\u7528\u5de5\u4f5c\u8282\u70b9 SELECT * FROM master_get_active_worker_nodes();</p> <p>-- \u5c06\u5206\u7247\u79fb\u52a8\u5230\u4f60\u9009\u62e9\u7684WORK\u8282\u70b9\u4e0a --\uff08\u5b83\u4e5f\u4f1a\u79fb\u52a8\u4efb\u4f55\u7528CASCADE\u9009\u9879\u521b\u5efa\u7684\u5206\u7247\uff09\u3002 SELECT citus_move_shard_placement(   102240,   'source_host', source_port,   'dest_host', dest_port);</p> <pre><code>\n## \u65f6\u5e8f\u6570\u636e\u5206\u8868\u7ba1\u7406\n\n</code></pre> <p>-- \u81ea\u52a8\u521b\u5efa\u5206\u533a\u8868 SELECT create_time_partitions(   table_name         := 'github_events',   partition_interval := '1 month',   end_at             := now() + '12 months' );</p> <pre><code>\n</code></pre> <p>-- \u67e5\u770b\u5206\u533a\u8868 SELECT partition   FROM time_partitions  WHERE parent_table = 'github_events'::regclass;</p> <pre><code>\n\n\n## \u5f52\u6863\u6570\u636e\u5217\u5b58\n\n</code></pre> <p>--\u8f6c\u5316\u4e3a\u5217\u5b58 CALL alter_old_partitions_set_access_method(   'github_columnar_events',   '2015-01-01 06:00:00' / older_than /,   'columnar' );</p> <pre><code>\n</code></pre> <p>-- \u67e5\u770b\u8868\u7684\u5b58\u50a8\u65b9\u5f0f SELECT partition, access_method   FROM time_partitions  WHERE parent_table = 'github_columnar_events'::regclass;</p> <pre><code>\n# \u8bfb\u5199\u5206\u79bb\n\n</code></pre> <p>-- \u52a0\u5165\u6570\u636e\u5e93\u4ece\u8282\u70b9 select * from citus_add_secondary_node('new-node', 12345, 'primary-node', 12345);</p> <pre><code>\n\n\n</code></pre> <p>-- \u5f00\u542f\u8bfb\u5199\u5206\u79bb citus.use_secondary_nodes     never: (default) All reads happen on primary nodes.     always: Reads run against secondary nodes instead, and insert/update statements are disabled.</p> <pre><code>\n# \u8282\u70b9\u7ba1\u7406\n\n## \u8282\u70b9\u67e5\u770b\n\n</code></pre> <p>select * from pg_dist_node;  nodeid | groupid |  nodename  | nodeport | noderack | hasmetadata | isactive | noderole | nodecluster | metadatasynced | shouldhaveshards  --------+---------+------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------       1 |       0 | 10.10.2.11 |     5432 | default  | t           | t        | primary  | default     | t              | f       3 |       2 | 10.10.2.12 |     5432 | default  | t           | t        | primary  | default     | t              | t       4 |       3 | 10.10.2.14 |     5432 | default  | t           | t        | primary  | default     | t              | t</p> <pre><code>\n## \u5220\u9664\u8282\u70b9\n\n</code></pre> <p>-- \u5220\u9664\u4e00\u4e2a\u8282\u70b9 SELECT * from citus_drain_node('10.0.0.1', 5432);</p> <pre><code>\n</code></pre> <p>-- \u5220\u9664\u591a\u4e2a\u8282\u70b9</p>","tags":[]},{"location":"postgres/extentions/citus11/#_15","title":"\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6267\u884c","text":"<p>SELECT * FROM citus_set_node_property(node_hostname, node_port, 'shouldhaveshards', false);</p>","tags":[]},{"location":"postgres/extentions/citus11/#_16","title":"citus11 \u7ba1\u7406\u624b\u518c","text":"<p>SELECT * FROM rebalance_table_shards(drain_only := true);</p> <pre><code>\n## \u66f4\u65b0\u8282\u70b9 \n\n</code></pre> <p>select * from citus_update_node(123, 'new-address', 5432);</p> <pre><code>\n## \u52a0\u5165\u5907\u7528\u8282\u70b9\n\n</code></pre> <p>select * from citus_add_inactive_node('new-node', 12345);</p> <pre><code>\n## \u6fc0\u6d3b\u5907\u7528\u8282\u70b9\n\n</code></pre> <p>select * from citus_activate_node('new-node', 12345);</p> <pre><code>\n# \u96c6\u7fa4\u5065\u5eb7\u7ba1\u7406\n\n</code></pre> <p>SELECT * FROM citus_check_cluster_node_health();</p> <pre><code>\n# \u9ad8\u53ef\u7528\u7ba1\u7406\n\n</code></pre> <p>select * from citus_add_secondary_node('new-node', 12345, 'primary-node', 12345);</p> <pre><code>\n</code></pre> <p>select * from citus_update_node(123, 'new-address', 5432); ```</p>","tags":[]},{"location":"postgres/extentions/pg_fdw/","title":"\u8de8\u5e93\u64cd\u4f5c","text":"<p>dblink</p> <p>https://www.cnblogs.com/lottu/p/13331387.html</p> <p>fdw</p> <p>https://www.cnblogs.com/lottu/p/13345187.html</p> <p>\u6ce8\u610f\u4e8b\u9879</p> <ul> <li> <p>\u67e5\u8be2\u6761\u4ef6\u4e0b\u63a8\uff0c\u65b0\u7248\u672c\u529f\u80fd\u66f4\u5168</p> </li> <li> <p>ddl \u64cd\u4f5c , fdw \u5982\u679c\u7528\u4e8e\u5386\u53f2\u5f52\u6863</p> </li> </ul>"},{"location":"postgres/extentions/pg_rman/","title":"pg_rman \u5907\u4efd\u6062\u590d\u6570\u636e\u5e93","text":""},{"location":"postgres/extentions/pg_rman/#_1","title":"\u9002\u7528\u573a\u666f","text":"<p>PG_RMAN \u57fa\u4e8e\u672c\u5730\u6570\u636e\u62f7\u8d1d\u7684\u65b9\u5f0f\uff0c\u8981\u6c42\u4e0e\u6570\u636e\u5e93\u9700\u8981\u5b89\u88c5\u5728\u540c\u4e00\u4e2a\u673a\u5668\u8282\u70b9\u4e0a\u3002</p> <p>\u9002\u7528\u4e8e\u9879\u76ee\u521d\u671f\uff0c\u5bf9\u6570\u636e\u5e93\u7684\u89c4\u5212\u5904\u4e8e\u521d\u7ea7\u9636\u6bb5\u3002\u5b9e\u4f53\u673a\u4e0d\u5145\u5206\u7684\u60c5\u51b5\u662f\u4e2a\u5f88\u597d\u7684\u9009\u62e9\u3002</p> <p>\u6570\u636e\u5e93\u4f7f\u7528ssd\u76d8\uff0c\u5907\u4efd\u78c1\u76d8\u91c7\u7528\u4f01\u4e1asata\u5927\u76d8\u3002\u6216nfs\u7f51\u76d8\u7b49\u3002</p> <p>PG_RMAN \u652f\u6301\u5168\u5907\u4efd\uff0c\u589e\u91cf\u5907\u4efd\uff0c\u5907\u4efd\u9a8c\u8bc1\uff0c\u4fdd\u7559\u7b56\u7565\u7b49</p> <p>\u5e94\u7528\u8f6f\u4ef6\u5305\u5730\u5740 https://github.com/ossc-db/pg_rman/releases</p>"},{"location":"postgres/extentions/pg_rman/#_2","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>-- \u521d\u59cb\u5316\n/usr/pgsql-13/bin/pg_rman -D /var/lib/pgsql/13/data/  -B /data/backup/ init\n\n-- \u5728/data/backup \u76ee\u5f55\u4e0b\u4f1a\u4ea7\u751f\u5982\u4e0b\u76ee\u5f55\u7ed3\u6784\nbackup \npg_rman.ini\nsystem_identifier\ntimeline_history\n\n-- \u5168\u5907\u4efd\npg_rman backup -B /pgdata/backup -D /var/lib/pgsql/13/data/  -b full  -h 127.0.0.1 -p 5432 -U backup -d postgres\n\n-- \u9a8c\u8bc1\npg_rman validate\n\n-- \u8be6\u60c5\u67e5\u770b\npg_rman show detail\n\n-- \u589e\u91cf\u5907\u4efd\npg_rman backup -B /pgdata/backup -D /var/lib/pgsql/13/data/  -b incremental  -h 127.0.0.1 -p 5432 -U backup -d postgres\n\n</code></pre> <p>\u8bbe\u7f6e\u4fdd\u7559\u7b56\u7565</p> <pre><code>vi pg_rman.ini \n\nKEEP_ARCLOG_DAYS = 7\nKEEP_DATA_DAYS = 7\nKEEP_SRVLOG_DAYS = 7\n\n</code></pre> <pre><code>-- \u6062\u590d\npg_rman restore -B /pgdata/backup -D /var/lib/pgsql/13/data/ \n\n\u6570\u636e\u6062\u590d\u540e \u6570\u636e\u5e93\u53ef\u80fd\u5904\u4e8epg_wal_replay_resume() \u7684\u72b6\u6001,\u5728\u6570\u636e\u5e93\u6267\u884c\u5b8c pg_wal_replay_resume \u540e\u6570\u636e\u5e93\u5c31\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\n</code></pre>"},{"location":"postgres/extentions/pgbouncer/","title":"pgbouncer \u8fde\u63a5\u6c60","text":""},{"location":"postgres/extentions/pgbouncer/#_1","title":"\u80cc\u666f\u4ecb\u7ecd","text":"<ul> <li>Pgbouncer \u662f\u4e00\u4e2a\u9488\u5bf9 PostgreSQL \u6570\u636e\u5e93\u7684\u8f7b\u91cf\u7ea7\u8fde\u63a5\u6c60</li> <li>pgbouncer \u7684\u76ee\u6807\u662f\u964d\u4f4e\u56e0\u4e3a\u65b0\u8fde\u63a5\u5230 PostgreSQL \u7684\u8fde\u63a5\u800c\u5bfc\u81f4\u7684\u6027\u80fd\u635f\u5931</li> </ul> <p>\u4f7f\u7528\u672f\u8bed\u8bf4\u660e\uff1a \u4e3a\u4e86\u540e\u9762\u7684\u63cf\u8ff0\u66f4\u6e05\u6670\uff0c\u4f7f\u7528\u5982\u4e0b\u672f\u8bed</p> <ul> <li>Client : \u6307\u8bbf\u95ee\u8005</li> <li>Pgboucer: \u6307\u8fde\u63a5\u6c60</li> <li>Postgres: \u6307\u6570\u636e\u5e93\u3002</li> <li>Connetions: \u6307\u5f7c\u6b64\u4e4b\u95f4\u7684\u8fde\u63a5</li> </ul> <p>\u6574\u4f53\u67b6\u6784</p> <p>\u539f\u6765: Client -&gt; Postgres \u73b0\u5728: Client -&gt; Pgbounce -&gt; Postgres</p>"},{"location":"postgres/extentions/pgbouncer/#_2","title":"\u4f18\u52bf","text":"<p>\u5185\u5b58\u6d88\u8017\u4f4e(\u9ed8\u8ba4\u4e3a 2k/\u8fde\u63a5)\uff0c\u56e0\u4e3a Bouncer \u4e0d\u9700\u8981\u6bcf\u6b21\u90fd\u63a5\u53d7\u5b8c\u6574\u7684\u6570\u636e\u5305\u3002 Postgres \u7684\u8fde\u63a5\u662f\u8fdb\u7a0b\u6a21\u578b\uff0cpogbouncer \u4f7f\u7528 libevent \u8fdb\u884c socket \u901a\u4fe1\u3002</p> <p>\u603b\u7ed3\uff1a \u6570\u636e\u8bbf\u95ee\u8fc7\u7a0b\u4e2d\u5efa\u7acb\u8fde\u63a5\u5f88\u8017\u8d44\u6e90\uff0cpgboucer \u5c31\u662f\u4e3a\u4e86\u51cf\u5c11\u6570\u636e\u8bbf\u95ee\u4e2d\u7684\u5efa\u7acb\u8fde\u63a5\u6b21\u6570\uff0c\u91cd\u590d\u5229\u7528\u5df2\u5efa\u7acb\u7684\u8fde\u63a5\u8fdb\u800c\u7f13\u89e3\u6570\u636e\u5e93\u538b\u529b\u3002</p>"},{"location":"postgres/extentions/pgbouncer/#_3","title":"\u4e09\u79cd\u8fde\u63a5\u6c60\u6a21\u578b","text":"<ul> <li>session \u4f1a\u8bdd\u7ea7 \uff1b \u6bd4\u8f83\u53cb\u597d</li> <li>transaction \u4e8b\u52a1\u7ea7\uff1b \u6bd4\u8f83\u6fc0\u8fdb</li> <li>statement \u4e00\u4e2a sql \uff1b \u5ba2\u6237\u7aef\u5f3a\u5236 autocommit \u6a21\u5f0f</li> </ul>"},{"location":"postgres/extentions/pgbouncer/#_4","title":"\u5b89\u88c5","text":"<pre><code>\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u4e2d\u7248\u672c\nyum list pgbouncer.x86_64\npgbouncer.x86_64                         1.15.0-1.rhel7\n\n\u5347\u7ea7\u5230\u6700\u65b0\u7248\nyum update pgbouncer.x86_64\n\n\u5b89\u88c5\nyum install pgbouncer.x86_64 -y\n\n\u542f\u52a8\nsystemctl start pgbouncer\nsystemctl enable pgbouncer\n\n</code></pre>"},{"location":"postgres/extentions/pgbouncer/#_5","title":"\u7b80\u5355\u914d\u7f6e","text":"<pre><code>cat /etc/pgbouncer/pgbouncer.ini | grep -v '^;' | grep -v '^$'\n[databases]\npostgres= host=127.0.0.1 port=5432 user=postgres dbname=postgres connect_query='select 1' pool_size=40\nzabbix= host=10.1.88.74 port=5432 dbname=zabbix  connect_query='select 1' pool_size=40\n[pgbouncer]\nlogfile = /var/log/pgbouncer/pgbouncer.log\npidfile = /var/run/pgbouncer/pgbouncer.pid\nlisten_addr = 0.0.0.0\nlisten_port = 6432\nauth_type = md5\nauth_file = /etc/pgbouncer/userlist.txt\nadmin_users = postgres\nstats_users = stats, postgres\npool_mode = session\nserver_reset_query = DISCARD ALL\nmax_client_conn = 100\ndefault_pool_size = 20\nlog_connections = 0\nlog_disconnections = 0\n</code></pre>"},{"location":"postgres/extentions/pgbouncer/#_6","title":"\u8bf4\u660e:","text":""},{"location":"postgres/extentions/pgbouncer/#databases","title":"[databases]","text":"<p>\u4e3b\u8981\u601d\u60f3\u627f\u4e0a\u542f\u4e0b\u7684\u4f5c\u7528\u76f8\u5f53\u4e8e\u4ee3\u7406\uff0c\u5448\u4e0a\u5bf9\u8bbf\u95ee\u8005\uff0c\u542f\u4e0b\u5bf9\u540e\u7aef\u6570\u636e\u5e93\u3002 \u7b2c\u4e00\u9879\u7684\u540d\u79f0\u662f pgbouncer \u5bf9\u5916\u63d0\u4f9b\u7684\u6570\u636e\u5e93\u540d postgres ,\u7b49\u53f7\u540e\u9762\u662f\u8fde\u63a5\u540e\u7aef\u6570\u636e\u5e93\u540d\u4fe1\u606f pool_mode = session pool_size , \u6307\u5b9a database \u8fde\u63a5\u5230\u540e\u7aef\u670d\u52a1\u5668\u7684\u8fde\u63a5\u6570\u7684\u6700\u5927\u503c\u3002\u914d\u5408\u6570\u636e\u5e93\u4e2d\u7684 database connection limit ;</p> <p>\u5173\u4e8e user \u914d\u7f6e\u540e\u9762\u7ec6\u8bf4</p>"},{"location":"postgres/extentions/pgbouncer/#pgbouncer","title":"[pgbouncer]","text":"<p>pgbouncer \u81ea\u8eab\u7684\u914d\u7f6e max_client_conn=\u5141\u8bb8\u7528\u6237\u5efa\u7acb\u591a\u5c11\u4e2a\u8fde\u63a5\u5230 pgbouncer ,\u7c7b\u4f3c\u4e8e\u6570\u636e\u5e93\u4e2d\u7684 max_connection\u3002 default_pool_size \u8868\u793a\u9ed8\u8ba4\u8fde\u63a5\u6c60\u4e2d\u5efa\u7acb\u591a\u5c11\u4e2a\u5230\u540e\u7aef\u6570\u636e\u5e93\u7684\u8fde\u63a5,\u5168\u5c40\u3002</p>"},{"location":"postgres/extentions/pgbouncer/#user","title":"\u5173\u4e8e\u7528\u6237 User \u7684\u914d\u7f6e\u8bf4\u660e","text":"<p>\u4e3b\u8981\u914d\u7f6e [databases]\u4e2d user \u8868\u793a\u8fde\u63a5\u5230\u540e\u7aef\u6570\u636e\u5e93\u6240\u4f7f\u7528\u7684\u7528\u6237 [pgbouncer]\u4e2d user \u8868\u793a\u7528\u6237\u8fde\u63a5\u5230 pgbouncer \u4e2d\u6240\u4f7f\u7528\u7684\u7528\u6237</p> <p>\u60c5\u51b5 1\uff1a \u5982\u679c\u5728 databases \u4e2d\u6307\u5b9a user=zabbix Client \u65e0\u8bba\u4f7f\u7528\u7684\u662f\u54ea\u4e2a\u7528\u6237\uff0c\u8fde\u63a5 postgres \u7684\u7528\u6237\u90fd\u662f zabbix</p> <p>\u60c5\u51b5 2: \u5982\u679c\u5728 database \u4e2d\u6ca1\u6709\u6307\u5b9a user ,\u8fde\u63a5 postgres \u7684\u7528\u6237\u4e3a Client \u4f7f\u7528\u7684\u7528\u6237</p> <p>pg \u4e2d\u67e5\u770b\u5f53\u524d\u7528\u6237</p> <pre><code>postgres=# select * from current_user;\n current_user\n--------------\n postgres\n(1 \u884c\u8bb0\u5f55)\n</code></pre> <p>auth_file \u5185\u5bb9 \u683c\u5f0f \"user\" \"password\",\u6ce8\u610f\u9700\u8981\u53cc\u5f15\u53f7 \u53ef\u4ee5\u5728\u6570\u636e\u5e93\u4e2d\u83b7\u53d6\u5185\u5bb9</p> <pre><code>select usename,passwd from pg_shadow ;\n</code></pre> <pre><code>cat /etc/pgbouncer/userlist.txt\n\"zabbix\" \"md520e0e8833ebe8947cd347f94b1c4977f\"\n</code></pre> <p>\u8ba4\u8bc1\u65b9\u6cd5: \u5728 pgbouncer \u4e2d\u6267\u884c</p> <pre><code>show config;\nauth_query | SELECT usename, passwd FROM pg_shadow WHERE usename=$1\n</code></pre> <p>\u63a8\u8350\uff1a \u4e0d\u5728 database \u4e2d\u914d\u7f6e user, \u5728 auth_file \u4e2d\u914d\u7f6e user</p>"},{"location":"postgres/extentions/pgbouncer/#pgboucer","title":"\u767b\u9646 pgboucer \u63a7\u5236\u53f0","text":"<pre><code>psql -p 6432 -U postgres  -h 127.0.0.1 pgbouncer\npsql (10.4, \u670d\u52a1\u5668 1.9.0/bouncer)\n\u8f93\u5165 \"help\" \u6765\u83b7\u53d6\u5e2e\u52a9\u4fe1\u606f.\n\npgbouncer=# show clients\npgbouncer-# ;\n type |   user   | database  | state  |   addr    | port  | local_addr | local_port |    connect_time     |    request_time     | wait | wait_us | close_needed |    ptr    | link | remote_pid | tls\n------+----------+-----------+--------+-----------+-------+------------+------------+---------------------+---------------------+------+---------+--------------+-----------+------+------------+-----\n C    | postgres | pgbouncer | active | 127.0.0.1 | 57048 | 127.0.0.1  |       6432 | 2019-01-02 16:22:22 | 2019-01-02 16:22:29 |    0 |       0 |            0 | 0x1a938c0 |      |          0 |\n(1 \u884c\u8bb0\u5f55)\n\npgbouncer=# show pools;\n     database     |   user    | cl_active | cl_waiting | sv_active | sv_idle | sv_used | sv_tested | sv_login | maxwait | maxwait_us | pool_mode\n------------------+-----------+-----------+------------+-----------+---------+---------+-----------+----------+---------+------------+-----------\n normandy_cloud_d | postgres  |         0 |          0 |         0 |       0 |       1 |         0 |        0 |       0 |          0 | session\n pgbouncer        | pgbouncer |         1 |          0 |         0 |       0 |       0 |         0 |        0 |       0 |          0 | statement\n(2 \u884c\u8bb0\u5f55)\n\n\u66f4\u591a\n\nshow  help;\nNOTICE:  Console usage\n\u63cf\u8ff0:\n    SHOW HELP|CONFIG|DATABASES|POOLS|CLIENTS|SERVERS|VERSION\n    SHOW FDS|SOCKETS|ACTIVE_SOCKETS|LISTS|MEM\n    SHOW DNS_HOSTS|DNS_ZONES\n    SHOW STATS|STATS_TOTALS|STATS_AVERAGES\n    SET key = arg\n    RELOAD\n    PAUSE [&lt;db&gt;]\n    RESUME [&lt;db&gt;]\n    DISABLE &lt;db&gt;\n    ENABLE &lt;db&gt;\n    RECONNECT [&lt;db&gt;]\n    KILL &lt;db&gt;\n    SUSPEND\n    SHUTDOWN\n\n\n</code></pre>"},{"location":"postgres/extentions/pgbouncer/#poolsize","title":"\u5173\u4e8e poolsize \u7684\u8bf4\u660e","text":"<p>[databases]\u4e2d pool_size: \u914d\u7f6e\u8fde\u63a5\u6c60\u7684\u5927\u5c0f,\u5982\u679c\u6ca1\u6709\u914d\u7f6e\uff0c\u4f7f\u7528[pgbouncer]default_pool_size [pgbouncer]\u4e2d default_pool_size: \u8fde\u63a5\u6c60\u7684\u9ed8\u8ba4\u5927\u5c0f max_client_conn: client \u5230 pgbouncer \u7684\u6700\u5927\u6570 pool_mode: \u8fde\u63a5\u6a21\u5f0f min_pool_size: \u8fde\u63a5\u6c60\u7684\u6700\u5c0f\u5927\u5c0f\uff0c\u5373\u6bcf\u4e2a\u8fde\u63a5\u6c60\u81f3\u5c11\u4f1a\u5411\u540e\u7aef\u6570\u636e\u5e93\u4fdd\u6301\u591a\u5c11\u4e2a\u8fde\u63a5\u3002Pgboucer -&gt; Postgres reserve_pool_size: How many additional connections to allow to a pool. 0 disables. reserve_pool_timeout: \u4fdd\u7559\u8fde\u63a5\u7684\u8d85\u65f6\u65f6\u95f4 max_user_connections: Client -&gt; pgbouncer \u6bcf\u4e2a\u7528\u6237\u6700\u5927\u8fde\u63a5\u6570 max_db_connections: Client -&gt; Pgbouncer \u6bcf\u4e2a\u6570\u636e\u5e93\u6700\u5927\u8fde\u63a5\u6570 disable_pqexec: \u7981\u6b62\u7b80\u5355\u67e5\u8be2\u3002 \u7b80\u5355\u67e5\u8be2\u534f\u8bae\u5141\u8bb8\u4e00\u4e2a\u8bf7\u6c42\u53d1\u9001\u591a\u6761 Sql\uff0c\u4f46\u662f\u5bb9\u6613\u9020\u6210 Sql \u6ce8\u5165\u98ce\u9669\u3002</p>"},{"location":"postgres/extentions/pgbouncer/#_7","title":"\u5173\u4e8e\u65e5\u5fd7\u4fe1\u606f\u914d\u7f6e\u8bf4\u660e","text":"<p>syslog: \u662f\u5426\u6253\u5f00 syslog syslog_ident: Under what name to send logs to syslog. Default: pgbouncer (program name) log_disconnections: log_connections: log_pooler_errors: Client pgbouncer \u4e4b\u95f4\u7684\u9519\u8bef\u65e5\u5fd7</p>"},{"location":"postgres/extentions/pgbouncer/#pgbouncer_1","title":"\u5173\u4e8e\u8bbf\u95ee pgbouncer \u914d\u7f6e","text":"<p>admin_users: \u53ef\u4ee5\u767b\u9646 console \u6267\u884c\u6240\u6709\u547d\u4ee4\u7684\u7528\u6237\u3002 \u591a\u4e2a\u7528\u6237\u4e4b\u95f4\u7528','\u53f7\u5206\u5272 stats_users: \u53ef\u4ee5\u767b\u9646 console \u6267\u884c SHOW \u547d\u4ee4(except SHOW FDS)\u7684\u7528\u6237\u3002</p>"},{"location":"postgres/extentions/pgbouncer/#_8","title":"\u5173\u4e8e\u76d1\u63a7\u68c0\u67e5\u8d85\u65f6\u8bbe\u7f6e","text":"<p>server_reset_query: \u5f53\u4e00\u4e2a\u540e\u7aef\u7684\u6570\u636e\u5e93\u8fde\u63a5\u4f1a\u8bdd\u88ab\u67d0\u4e00\u4e2a\u5ba2\u6237\u7aef\u4f7f\u7528\u65f6\uff0c\u5b83\u7684\u5c5e\u6027\u53ef\u80fd\u4f1a\u88ab\u4fee\u6539\u3002\u5f53\u8fd9\u4e2a\u540e\u7aef\u6570\u636e\u5e93\u8fde\u63a5\u88ab\u7b2c\u4e8c\u4e2a\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u65f6\u5c31\u6709\u53ef\u80fd\u4ea7\u751f\u95ee\u9898\u3002\u5982\u4e0a\u4e2a\u8fde\u63a5\u4e2d\u6709 ABORT or ROLLBACK ,\u4e0b\u4e2a\u4f7f\u7528\u6b64\u8fde\u63a5\u7684\u7528\u6237\u80af\u80fd\u4f1a\u5f88\u60e8\u3002 \u6240\u4ee5\u9700\u8981\u5c06\u6240\u6709\u7684\u5c5e\u6027\u6e05\u7a7a\u3002 Default: DISCARD ALL</p> <p>server_check_delay\uff1a Default: 30.0 server_check_query\uff1a select 1</p> <p>\u66f4\u591a\u914d\u7f6e\u4fe1\u606f</p>"},{"location":"postgres/extentions/pgbouncer/#_9","title":"\u751f\u4ea7\u6848\u4f8b","text":"<pre><code>--- \u521b\u5efa user_search \u81ea\u5b9a\u4e49\u51fd\u6570\nCREATE OR REPLACE FUNCTION public.user_search(uname text)\nRETURNS TABLE(usename name, passwd text)\nLANGUAGE sql\nSECURITY DEFINER\nAS $function$ SELECT usename, passwd FROM pg_shadow WHERE usename=$1; $function$\n</code></pre> <pre><code># \u914d\u7f6epgbouncer\ncat /etc/pgbouncer/pgbouncer.ini\n[databases]\npostgres = host=/var/run/postgresql port=5432 dbname=postgres\n\n- = host=/var/run/postgresql port=5432\n\n[pgbouncer]\nlogfile = /var/log/pgbouncer/pgbouncer.log\npidfile = /run/pgbouncer/pgbouncer.pid\nlisten_addr = 0.0.0.0\nlisten_port = 6432\nunix_socket_dir = /var/run/pgbouncer\nauth_type = scram-sha-256\nauth_user = pgbouncer\nauth_dbname = postgres\nauth_query = SELECT usename, passwd FROM user_search($1)\nadmin_users = postgres\nstats_users = postgres\nignore_startup_parameters = extra_float_digits,geqo,search_path\n\npool_mode = session\nserver_reset_query = DISCARD ALL\nmax_client_conn = 100000\ndefault_pool_size = 100\nquery_wait_timeout = 120\nreserve_pool_size = 1\nreserve_pool_timeout = 1\nmax_db_connections = 10000\npkt_buf = 8192\nlisten_backlog = 4096\nmax_prepared_statements = 1024\nso_reuseport = 1\nclient_tls_sslmode = require\nclient_tls_key_file = /etc/tls/server.key\nclient_tls_cert_file = /etc/tls/server.crt\nclient_tls_ca_file = /etc/tls/ca.crt\nclient_tls_protocols = secure\nclient_tls_ciphers = secure\nserver_tls_sslmode = require\nserver_tls_key_file = /etc/tls/server.key\nserver_tls_cert_file = /etc/tls/server.crt\nserver_tls_ca_file = /etc/tls/ca.crt\nserver_tls_protocols = secure\nserver_tls_ciphers = secure\nlog_connections = 0\nlog_disconnections = 0\n\n# Documentation https://pgbouncer.github.io/config.html\n</code></pre>"},{"location":"postgres/extentions/pgpool2/","title":"pgpoolii \u8bfb\u5199\u5206\u79bb","text":"<p>https://www.pgpool.net/docs/pgpool-II-3.5.4/doc/tutorial-zh_cn.html#dist-def</p> <p>https://www.xiaomastack.com/2019/08/16/postgresql\u96c6\u7fa4/</p>"},{"location":"postgres/extentions/pipelinedb01/","title":"Pipelinedb\u6587\u6863\u6982\u89c8","text":"<p>\u5b98\u65b9\u6587\u6863</p>"},{"location":"postgres/extentions/pipelinedb01/#_1","title":"\u4ecb\u7ecd","text":"<p>What PipelineDB is   What PipelineDB is not    </p>"},{"location":"postgres/extentions/pipelinedb01/#quitstart","title":"QuitStart","text":"<p>\u4e00\u4e2a\u7edf\u8ba1wiki\u6d4f\u89c8\u7684\u4f8b\u5b50</p>"},{"location":"postgres/extentions/pipelinedb01/#_2","title":"\u5b89\u88c5","text":"<p>\u5404\u79cd\u73af\u5883\u5b89\u88c5</p>"},{"location":"postgres/extentions/pipelinedb01/#continuous-views","title":"Continuous Views","text":"<p>\u5b9a\u4e49\u6d41\u89c6\u56fe\uff0c\u5176\u5b9e\u5c31\u662f\u5b9a\u4e49 \u7edf\u8ba1\u5206\u6790\u7684QUERY\uff0c \u4f8b\u5982select id, count(*), avg(x), ... from table group by ...; \u5b9a\u4e49\u597d\u4e4b\u540e\uff0c\u6570\u636e\u63d2\u5165table\uff0c\u8fd9\u4e2a\u6d41\u89c6\u56fe\u5c31\u4f1a\u4e0d\u65ad\u589e\u91cf\u7684\u8fdb\u884c\u7edf\u8ba1\uff0c\u4f60\u53ea\u8981\u67e5\u8be2\u8fd9\u4e2a\u6d41\u89c6\u56fe\uff0c\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u5b9e\u65f6\u7684\u7edf\u8ba1\u7ed3\u679c\u3002 \u6570\u636e\u5e93\u4e2d\u5b58\u50a8\u7684\u662f\u5b9e\u65f6\u7edf\u8ba1\u7684\u7ed3\u679c\uff08\u5b9e\u9645\u4e0a\u662f\u5728\u5185\u5b58\u4e2d\u8fdb\u884c\u589e\u91cf\u5408\u5e76\u7684\uff0c\u589e\u91cf\u7684\u65b9\u5f0f\u6301\u4e45\u5316\uff09\u3002</p> <p>CREATE CONTINUOUS VIEW   DROP CONTINUOUS VIEW   TRUNCATE CONTINUOUS VIEW   Viewing Continuous Views   Data Retrieval   Time-to-Live (TTL) Expiration   Activation and Deactivation   Examples    </p>"},{"location":"postgres/extentions/pipelinedb01/#continuous-transforms","title":"Continuous Transforms","text":"<p>\u4e0e\u6d41\u89c6\u56fe\u4e0d\u540c\u7684\u662f\uff0ctransform\u662f\u7528\u6765\u8f6c\u6362\u6570\u636e\u6d41\u7684\uff0c\u6240\u4ee5\u5b83\u53ef\u4ee5\u4e0d\u4fdd\u7559\u6570\u636e\uff0c\u4f46\u662f\u53ef\u4ee5\u8bbe\u5b9a\u6761\u4ef6\uff0c\u5f53\u8bb0\u5f55\u6ee1\u8db3\u6761\u4ef6\u65f6\uff0c\u5c31\u89e6\u53d1\u4e8b\u4ef6\u3002</p> <p>\u7528\u9014\uff0c\u5c06\u8f93\u5165\u7684\u6570\u636e\u6d41\u8fdb\u884c\u8f6c\u6362\u5904\u7406\uff0c\u8fc7\u6ee4\uff0c\u52a0\u5de5\u7b49\uff0c\u7528\u4e8e\u590d\u6742\u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u6bd4\u5982\u591a\u4e2a\u6765\u6e90\u7684\u6570\u636e\u6d41\u7684\u5408\u5e76\u52a0\u5de5\u3002\u4e0e\u73b0\u6709\u7684\u8868\u8fdb\u884cjoins\u64cd\u4f5c,\u53ef\u4ee5\u5c06\u7ed3\u679c\u4f20\u5165\u5176\u4ed6\u6d41\u4e2d\uff0c\u5b9e\u73b0\u6301\u7eed\u8f6c\u6362\u3002</p> <p>\u4f8b\u5982\u76d1\u89c6\u4f20\u611f\u5668\u7684\u503c\uff0c\u5f53\u503c\u7684\u8303\u56f4\u8d85\u51fa\u65f6\uff0c\u89e6\u53d1\u62a5\u8b66\uff08\u5982\u901a\u8fc7REST\u63a5\u53e3\u53d1\u7ed9\u6307\u5b9a\u7684server\uff09\uff0c\u6216\u8005\u5c06\u62a5\u8b66\u8bb0\u5f55\u4e0b\u6765\uff08\u901a\u8fc7\u89e6\u53d1\u5668\u51fd\u6570\uff09\u3002</p> <p>CREATE CONTINUOUS TRANSFORM   DROP CONTINUOUS TRANSFORM   Viewing Continuous Transforms   Built-in Transform Triggers   Creating Your Own Trigger    </p>"},{"location":"postgres/extentions/pipelinedb01/#streams","title":"Streams","text":"<p>\u6d41\u89c6\u56fe\u548ctransform\u90fd\u662f\u57fa\u4e8e\u6d41\u7684\uff0c\u6240\u4ee5\u6d41\u662f\u57fa\u7840\u3002</p> <p>\u6211\u4eec\u9996\u5148\u9700\u8981\u5b9a\u4e49\u6d41\uff0c\u5f80\u6d41\u91cc\u9762\u5199\u6570\u636e\uff0c\u7136\u540e\u5728\u6d41\u52a8\u7684\u6570\u636e\u4e2d\u4f7f\u7528\u6d41\u89c6\u56fe\u6216\u8005transform\u5bf9\u6570\u636e\u8fdb\u884c\u5b9e\u65f6\u5904\u7406\u3002</p> <p>Writing To Streams   Output Streams   stream_targets   Arrival Ordering   Event Expiration </p>"},{"location":"postgres/extentions/pipelinedb01/#built-in-functionality","title":"Built-in Functionality","text":"<p>\u5185\u7f6e\u7684\u51fd\u6570</p> <p>General   Aggregates   PipelineDB-specific Types   PipelineDB-specific Functions   Miscellaneous Functions </p>"},{"location":"postgres/extentions/pipelinedb01/#continuous-aggregates","title":"Continuous Aggregates","text":"<p>\u805a\u5408\u7684\u4ecb\u7ecd\uff0c\u901a\u5e38\u6d41\u5904\u7406\u5206\u4e24\u7c7b\uff0c\u5373\u524d\u9762\u8bb2\u7684</p> <p>\u6d41\u89c6\u56fe\uff08\u901a\u5e38\u662f\u5b9e\u65f6\u805a\u5408\u7684\u7ed3\u679c\uff09\uff0c\u6bd4\u5982\u6309\u5206\u949f\u5b9e\u65f6\u7684\u5bf9\u7ea2\u7eff\u706f\u7684\u8f66\u6d41\u7edf\u8ba1\u6570\u636e\u7ed8\u56fe\uff0c\u6216\u8005\u6309\u5206\u949f\u5bf9\u80a1\u7968\u7684\u5b9e\u65f6\u6570\u636e\u8fdb\u884c\u7ed8\u56fe\u3002</p> <p>transform\uff08\u4e8b\u4ef6\u5904\u7406\u673a\u5236\uff09\uff0c\u6bd4\u5982\u76d1\u63a7\u6c34\u8d28\uff0c\u4f20\u611f\u5668\u7684\u503c\u8d85\u51fa\u67d0\u4e2a\u8303\u56f4\u65f6\uff0c\u8bb0\u5f55\u65e5\u5fd7\uff0c\u5e76\u540c\u65f6\u89e6\u53d1\u544a\u8b66\uff08\u53d1\u9001\u7ed9server\uff09\u3002</p> <p>PipelineDB-specific Aggregates   Combine   CREATE AGGREGATE   General Aggregates   Statistical Aggregates   Ordered-set Aggregates   Hypothetical-set Aggregates   Unsupported Aggregates   </p>"},{"location":"postgres/extentions/pipelinedb01/#clients","title":"Clients","text":"<p>\u51e0\u79cd\u5e38\u89c1\u7684\u5ba2\u6237\u7aef\u7528\u6cd5\uff0c\u5b9e\u9645\u4e0a\u652f\u6301PostgreSQL\u7684\u90fd\u652f\u6301pipelinedb\uff0c\u4ed6\u4eec\u7684\u8fde\u63a5\u534f\u8bae\u662f\u4e00\u81f4\u7684\u3002</p> <p>Python   Ruby   Java   </p>"},{"location":"postgres/extentions/pipelinedb01/#probabilistic-data-structures-algorithms","title":"Probabilistic Data Structures &amp; Algorithms","text":"<p>\u6982\u7387\u7edf\u8ba1\u76f8\u5173\u7684\u529f\u80fd\uff0c\u4f8b\u5982HLL\u7b49\u3002\u7528\u8d77\u6765\u4e5f\u975e\u5e38\u7684\u723d\uff0c\u4f8b\u5982\u7edf\u8ba1\u7f51\u7ad9\u7684UV\uff0c\u6216\u8005\u7ea2\u7eff\u706f\u901a\u8fc7\u7684\u6c7d\u8f66\u7f16\u53f7\u552f\u4e00\u503c\u8f66\u6d41\uff0c\u901a\u8fc7\u624b\u673a\u4fe1\u53f7\u7edf\u8ba1\u57fa\u7ad9\u8f90\u5c04\u65b9\u5706\u591a\u5c11\u516c\u91cc\u7684\u6309\u65f6UV\u7b49\u3002</p> <p>Bloom Filter   Count-Min Sketch   Filtered-Space Saving Top-K   HyperLogLog   T-Digest    </p>"},{"location":"postgres/extentions/pipelinedb01/#sliding-windows","title":"Sliding Windows","text":"<p>\u56e0\u4e3a\u5f88\u591a\u573a\u666f\u7684\u6570\u636e\u6709\u65f6\u6548\uff0c\u6216\u8005\u6709\u65f6\u95f4\u7a97\u53e3\u7684\u6982\u5ff5\uff0c\u6240\u4ee5pipelinedb\u63d0\u4f9b\u4e86\u7a97\u53e3\u5206\u7247\u7684\u63a5\u53e3\uff0c\u5141\u8bb8\u7528\u6237\u5bf9\u6570\u636e\u7684\u65f6\u6548\u8fdb\u884c\u5b9a\u4e49\u3002</p> <p>\u4f8b\u5982\u4ec5\u4ec5\u7edf\u8ba1\u6700\u8fd1\u4e00\u5206\u949f\u7684\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u7edf\u8ba1\u6570\u636e\u3002</p> <p>\u6bd4\u5982\u70ed\u529b\u56fe\uff0c\u5c55\u793a\u6700\u8fd1\u4e00\u5206\u949f\u7684\u70ed\u5ea6\uff0c\u5bf9\u4e8e\u65e7\u7684\u6570\u636e\u4e0d\u5173\u5fc3\uff0c\u5c31\u53ef\u4ee5\u9002\u5e94SW\u8fdb\u884c\u5b9a\u4e49\uff0c\u4ece\u800c\u4fdd\u7559\u7684\u6570\u636e\u5c11\uff0c\u5bf9\u673a\u5668\u7684\u8981\u6c42\u4f4e\uff0c\u6548\u7387\u8fd8\u9ad8\u3002</p> <p>Examples   Sliding Aggregates   Temporal Invalidation   Multiple Windows   step_factor    </p>"},{"location":"postgres/extentions/pipelinedb01/#continuous-joins","title":"Continuous JOINs","text":"<p>\u6d41\u89c6\u56fe \u652f\u6301JOIN\uff0c\u652f\u6301JOIN\uff0c\u652f\u6301JOIN\uff0c\u91cd\u8981\u7684\u4e8b\u60c5\u8bf4\u4e09\u904d\u3002</p> <p>\u6d41 JOIN \u6d41(\u672a\u6765\u7248\u672c\u652f\u6301,\u76ee\u524d\u53ef\u4ee5\u901a\u8fc7transform\u95f4\u63a5\u5b9e\u73b0)</p> <p>\u6d41 JOIN TABLE(\u5df2\u652f\u6301)</p> <p>Stream-table JOINs   Supported Join Types   Examples   Stream-stream JOINs </p>"},{"location":"postgres/extentions/pipelinedb01/#backup","title":"Backup","text":"<p>\u4e0epg\u6570\u636e\u76f8\u540c\uff0c\u5982\u679c\u5355\u72ec\u5907\u4efd\u51fa\u4e00\u4e2a\u89c6\u56fe\u9700\u8981\u4e0e\u5bf9\u5e94\u7684\u7269\u5316\u8868\u4e00\u540c\u5907\u4efd\u3002</p>"},{"location":"postgres/extentions/pipelinedb01/#replication","title":"Replication","text":"<p>\u4f9d\u8d56\u4e8epg\u6570\u636e\u5e93\u6d41\u590d\u5236\uff0c HA \u53ef\u4ee5\u4f7f\u7528Patroni</p>"},{"location":"postgres/extentions/pipelinedb01/#integrations","title":"Integrations","text":"<ul> <li> <p>Apache Kafka  </p> </li> <li> <p>Amazon Kinesis</p> </li> </ul>"},{"location":"postgres/extentions/pipelinedb01/#statistics","title":"Statistics","text":"<p>\u7edf\u8ba1\u4fe1\u606f\uff0c\u5bf9\u4e8eDBA\u6709\u5f88\u5927\u7684\u5e2e\u52a9</p> <p>pipelinedb.proc_stats   pipelinedb.query_stats   pipelinedb.stream_stats   pipelinedb.db_stats </p>"},{"location":"postgres/extentions/pipelinedb01/#configuration","title":"Configuration","text":""},{"location":"postgres/extentions/pipelinedb01/#pipelinedbstream_insert_level","title":"pipelinedb.stream_insert_level","text":"<p>\u6027\u80fd\u6700\u4f73\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u4e3aasync\uff0c\u6570\u636e\u5199\u5165\u5185\u5b58\u5373\u54cd\u5e94\u5199\u5165\u5ba2\u6237\u7aef\u3002 \u6027\u80fd\u9002\u4e2d\uff0c\u8bbe\u7f6e\u4e3async_receive\uff0c\u6570\u636e\u88abworker process\u63a5\u6536\u540e\u54cd\u5e94\u5199\u5165\u5ba2\u6237\u7aef\u3002 (\u9ed8\u8ba4\u503c) \u6d4b\u8bd5\u73af\u5883, sync_commit</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbnum_combiners","title":"pipelinedb.num_combiners","text":"<p>\u6709\u591a\u5c11\u4e2acombiner\u8fdb\u7a0b\u3002\u7531\u4e8ecombiner\u8fdb\u7a0b\u8d1f\u8d23\u5c06\u8ba1\u7b97\u597d\u7684\u7ed3\u679c\u6570\u636e\u5408\u5e76\u843d\u76d8\uff0c\u6240\u4ee5\u5f53\u8bbe\u7f6e\u7684COMBINER\u8fdb\u7a0b\u4e2a\u6570\u8db3\u591f\u8fbe\u5230IO\u74f6\u9888\u65f6\u4e3a\u5b9c\u3002\u8bbe\u7f6e\u53d6\u51b3\u4e8eIO\u80fd\u529b\u3002    </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbcommit_interval","title":"pipelinedb.commit_interval","text":"<p>\u6bcf\u4e2acombiner\u8fdb\u7a0b\uff0c\u4f1a\u5148\u5c06\u5408\u5e76\u7684\u7ed3\u679c\u6570\u636eHOLD\u5728combiner_work_mem\uff0c\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002commit_interval\u8868\u793a\u95f4\u9694\u591a\u957f\u65f6\u95f4\u5237\u63d0\u4ea4\u7ed3\u679c\u3002    </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbnum_workers","title":"pipelinedb.num_workers","text":"<p>worker\u8fdb\u7a0b\u8d1f\u8d23\u8ba1\u7b97STREAM\u4e0a\u5b9a\u4e49\u7684continue view, continue transform\u3002  \u8bbe\u7f6e\u53d6\u51b3\u4e8e\u6709\u591a\u5c11STREAM\uff0c\u6709\u591a\u5c11continue view, continue transform\uff0c\u6709\u591a\u5c11CPU\u80fd\u529b\u3002   </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbnum_queues","title":"pipelinedb.num_queues","text":"<p>\u5f53\u6570\u636e\u4eceSTREAM\u53d6\u51fa\uff08worker\u548ccombiner\u6279\u91cf\u6d88\u8d39\u3001\u8ba1\u7b97stream\u5185\u7684\u6570\u636e\uff0c\u5e76\u5c06\u7ed3\u679c\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u7136\u540e\u4ecestream\u4e2d\u6e05\u6389\u5bf9\u5e94\u7684\u6d41\u6570\u636e\u3002\u6574\u4e2a\u8fc7\u7a0b\u9700\u8981queue process\uff0c\u786e\u4fdd\u505a\u8fd9\u4e00\u7cfb\u5217\u52a8\u4f5c\u7684\u65f6\u5019\uff0c\u4e0d\u5f71\u54cd\u7528\u6237\u6301\u7eed\u5c06\u6570\u636e\u5199\u5165stream\u3002\uff09   \u8bbe\u7f6e\u53d6\u51b3\u4e8enum_workers\uff0cnum_combiners\u3002   </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbnum_reapers","title":"pipelinedb.num_reapers","text":"<p>reaper\u8fdb\u7a0b\uff0c\u7528\u4e8e\u6e05\u9664\u8bbe\u7f6e\u4e86TTL\u7684continue view\u7684\u8fc7\u671f\u6570\u636e\u3002  \u7c7b\u4f3c\u4e8e\u540e\u53f0\u5b9a\u65f6\u4efb\u52a1\u8fdb\u7a0b\u3002\u4e0d\u9700\u8981\u592a\u591a\uff0c\u8bbe\u7f6e\u53d6\u51b3\u4e8e\u6709\u591a\u5c11\u8bbe\u7f6e\u4e86TTL\u7684continue view\u3002</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbttl_expiration_batch_size","title":"pipelinedb.ttl_expiration_batch_size","text":"<p>\u6e05\u9664\u8bbe\u7f6e\u4e86TTL\u7684continue view\u7684\u8fc7\u671f\u6570\u636e\u3002 \u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u6700\u591a\u6e05\u7406\u591a\u5c11\u6761\u6570\u636e\uff0c\u4e3b\u8981\u9632\u6b62\u957f\u4e8b\u52a1\u3002</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbttl_expiration_threshold","title":"pipelinedb.ttl_expiration_threshold","text":"<p>\u5f53\u8d85\u51fa\u8bbe\u7f6e\u9608\u503c\u591a\u5c11\u540e\uff0c\u5f00\u59cb\u6e05\u7406\u8fc7\u671f\u6570\u636e\u3002 \u4f8b\u5982\u8bbe\u7f6eTTL\u4e3a2\u5929\uff0c\u8bbe\u7f6ettl_expiration_threshold\u4e3a5%\u3002 \u90a3\u4e48\u5f53\u6570\u636e\u8fc7\u671f\u8fbe\u5230 (2 + 5%*2) \u5929\u540e\uff0c\u624d\u5f00\u59cb\u89e6\u53d1\u6e05\u7406\u3002  \u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3aTTL continue view\u7684\u81a8\u80c0\u7387\u3002  </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbbatch_size","title":"pipelinedb.batch_size","text":"<p>\u5f53\u67e5\u8be2continuous view\u65f6\uff0c\u4f1a\u89e6\u53d1PIPELINEDB\u5bf9continuous view\u7684\u7ed3\u679c\u8fdb\u884c\u6301\u4e45\u5316\u3002   batch_size\u8bbe\u7f6e\uff0c\u8868\u793a\u6267\u884ccontinuous view\u67e5\u8be2\u524d\uff0c\u6700\u591a\u5141\u8bb8\u591a\u5c11\u4e2aevents\u5806\u79ef(\u4f8b\u5982insert stream\u7684\u6761\u6570)\u3002   \u8bbe\u7f6e\u8d8a\u5927\uff0c\u53ef\u80fd\u589e\u52a0\u67e5\u8be2continuous view\u7684\u54cd\u5e94\u5ef6\u8fdf\uff0c\u6216\u8005\u5f53\u6570\u636e\u5e93CRASH\u65f6\u4e22\u6389\u66f4\u591a\u6570\u636e\u3002   </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbcombiner_work_mem","title":"pipelinedb.combiner_work_mem","text":"<p>\u6bcf\u4e2acombiner\u7684\u5de5\u4f5c\u5185\u5b58\u5927\u5c0f\u3002combiner process\u5728\u5408\u5e76WORKER\u8ba1\u7b97\u7ed3\u679c\u65f6\u7528\u4e8e\u6392\u5e8f\uff0cHASH TABLE\u7b49\u3002  \u5982\u679ccombiner\u4f7f\u7528\u5185\u5b58\u8d85\u51fa\u8fd9\u4e2a\u8bbe\u7f6e\uff0c\u5219\u4f7f\u7528\u78c1\u76d8\u3002  </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbanonymous_update_checks","title":"pipelinedb.anonymous_update_checks","text":"<p>Toggles whether PipelineDB should anonymous check if a new version is available. Default: true.</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbmatrels_writable","title":"pipelinedb.matrels_writable","text":"<p>\u662f\u5426\u5141\u8bb8continue view\u88ab\u76f4\u63a5\u4fee\u6539\u3002\uff08\u76f4\u63a5\u901a\u8fc7SQL\u4fee\u6539\uff0c\u800c\u4e0d\u662f\u4ec5\u88abcombiner\u8fdb\u7a0b\u4fee\u6539\uff09 Toggles whether changes can be directly made to materialization tables. Default: false.</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbipc_hwm","title":"pipelinedb.ipc_hwm","text":"<p>Sets the high watermark for IPC messages between worker and combiner processes. Default: 10.</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbmax_wait","title":"pipelinedb.max_wait","text":"<p>\u4e0epipelinedb.batch_size\u542b\u4e49\u7c7b\u4f3c\uff0c\u53ea\u662f\u65f6\u95f4\u5ea6\u91cf\u3002  \u6267\u884ccontinuous view\u67e5\u8be2\u524d\uff0c\u6700\u591a\u5141\u8bb8\u7b49\u591a\u957f\u65f6\u95f4\u3002  </p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbfillfactor","title":"pipelinedb.fillfactor","text":"<p>continue view\u7684fillfactor\uff0c\u7531\u4e8e\u6d41\u8ba1\u7b97\u7684\u7ed3\u679ccontinue view\u9700\u8981\u7ecf\u5e38\u88abcombiner\u66f4\u65b0\uff0c\u6240\u4ee5\u591a\u6570\u4e3a\u66f4\u65b0\u64cd\u4f5c\uff0c\u90a3\u4e48\u8bbe\u7f6e\u5408\u7406\u7684fillfactor\u53ef\u4ee5\u4f7f\u5f97\u66f4\u5bb9\u6613HOT\uff08\u907f\u514d\u7d22\u5f15\u81a8\u80c0\uff09\u3002  Default: 50.</p>"},{"location":"postgres/extentions/pipelinedb01/#pipelinedbsliding_window_step_factor","title":"pipelinedb.sliding_window_step_factor","text":"<p>\u6ed1\u7a97continue view\u7684\u5c0f\u7a97\u9897\u7c92\u5ea6\u3002 \u4f8b\u5982\u5b9a\u4e49\u6ed1\u7a97\u4e3a1\u5c0f\u65f6\uff0c\u90a3\u4e48\u8fd9\u4e2a\u89c6\u56fe\u5c31\u662f\u6700\u8fd1\u4e00\u5c0f\u65f6\u7684\u7edf\u8ba1\uff0c\u4e3a\u4e86\u5f97\u5230\u8fd9\u4e2a\u7edf\u8ba1\u503c\uff0c\u5fc5\u987b\u5b9e\u65f6\u8001\u5316\u4e00\u5c0f\u65f6\u524d\u7684\u6570\u636e\uff0c\u4fdd\u6301\u7edf\u8ba1\u662f\u6700\u8fd1\u4e00\u5c0f\u65f6\u7684\u3002\u600e\u4e48\u505a\u5230\u7684\u5462\uff1f  \u5b9e\u9645\u4e0apipelinedb\u5185\u90e8\u901a\u8fc7\u5b9a\u4e49\u6bd4\u6ed1\u7a97\u66f4\u5c0f\u7c92\u5ea6\u7a97\u53e3\u7684\u5b9e\u65f6\u7edf\u8ba1\uff0c\u628a\u7a97\u53e3\u5207\u6210\u66f4\u5c0f\u7684\u7a97\u53e3\uff0c\u67e5\u8be2\u65f6\u5bf9\u5c0f\u7c92\u5ea6\u7a97\u53e3\u8fdb\u884c\u6c47\u805a\u4ea7\u751f\u5927\u7a97\u53e3\u7684\u6570\u636e\u3002  \u4f8b\u5982\u5b9a\u4e49\u7684\u7a97\u53e3\u4e3a1\u5c0f\u65f6\uff0c\u90a3\u4e48\u53ef\u4ee5\u6309\u5206\u949f\u7684\u7c92\u5ea6\u8fdb\u884c\u7edf\u8ba1\uff0c\u67e5\u8be2\u65f6\uff0c\u6c47\u805a\u6700\u8fd1\u768460\u4e2a\u7a97\u53e3\u7684\u6570\u636e\uff0c\u5f97\u5230\u5c0f\u65f6\u7684\u7a97\u53e3\u6570\u636e\u3002  \u9897\u7c92\u5ea6\u4e3a5\uff0c\u8868\u793a5%\u7684\u9897\u7c92\u3002\u4f8b\u5982\u5b9a\u4e49\u7a97\u53e3\u4e3a1\u5c0f\u65f6\uff0c\u90a3\u4e48\u9897\u7c92\u5c31\u662f5%*60min = 3min\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f1a3\u5206\u949f\u7edf\u8ba1\u4e00\u4e2a\u503c\uff0c\u6700\u540e\u67e5\u8be2\u65f6\u6c47\u805a\u4e3a1\u5c0f\u65f6\u7684\u7a97\u53e3\u503c   </p>"},{"location":"postgres/extentions/pipelinedb02/","title":"Pipelinedb \u7b80\u4ecb","text":""},{"location":"postgres/extentions/pipelinedb02/#_1","title":"\u9879\u76ee\u5df2\u7ecf\u505c\u6b62\u7ef4\u62a4","text":"<p>\u9002\u914d\u652f\u6301\u7248\u672c</p> <pre><code>PostgreSQL 10: 10.1, 10.2, 10.3, 10.4, 10.5\nPostgreSQL 11: 11.0\n</code></pre>"},{"location":"postgres/extentions/pipelinedb02/#_2","title":"\u57fa\u672c\u6982\u5ff5","text":""},{"location":"postgres/extentions/pipelinedb02/#stream","title":"\u6d41(Stream)","text":"<p>\u6d41\u662f\u57fa\u7840\uff0cContinuous Views\u548ctransform\u5219\u662f\u57fa\u4e8e\u6d41\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u5904\u7406\u7684\u624b\u6bb5\u3002 \u5bf9\u4e8e\u540c\u4e00\u4efd\u6570\u636e\uff0c\u53ea\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a\u6d41\uff0c\u5199\u5165\u4e00\u4efd\u5373\u53ef\u3002 \u5982\u679c\u5bf9\u540c\u4e00\u4efd\u6570\u636e\u6709\u591a\u4e2a\u7ef4\u5ea6\u7684\u7edf\u8ba1\uff0c\u53ef\u4ee5\u5199\u5728\u4e00\u6761SQL\u5b8c\u6210\u7684\uff08\u5982\u540c\u4e00\u7ef4\u5ea6\u7684\u8fd0\u7b97\u6216\u8005\u53ef\u4ee5\u652f\u6301\u7a97\u53e3\u7684\u591a\u7ef4\u5ea6\u8fd0\u7b97\uff09\uff0c\u53ea\u9700\u5b9a\u4e49\u4e00\u4e2aContinuous Views\u6216transform\u3002\u5982\u679c\u4e0d\u80fd\u5728\u540c\u4e00\u6761SQL\u4e2d\u5b8c\u6210\u8ba1\u7b97\uff0c\u5219\u5b9a\u4e49\u591a\u4e2aContinuous Views\u6216transform\u5373\u53ef\u3002 \u5982\u679c\u6709\u591a\u4efd\u6570\u636e\u6765\u6e90\uff08\u4f8b\u5982\u8bbe\u8ba1\u65f6\u5c31\u5df2\u7ecf\u533a\u5206\u4e86\u4e0d\u540c\u7684\u8868\uff09\u65f6\uff0c\u5b9a\u4e49\u4e0d\u540c\u7684\u6d41\u5373\u53ef\uff1b</p>"},{"location":"postgres/extentions/pipelinedb02/#_3","title":"\u6d41\u89c6\u56fe","text":"<p>\u6d41\u89c6\u56fe\uff0c\u5176\u5b9e\u5c31\u662f\u5b9a\u4e49\u7edf\u8ba1\u5206\u6790\u7684QUERY\uff0c \u4f8b\u5982select id, count(*), avg(x), ... from stream_1 group by ...; \u5c31\u5c5e\u4e8e\u4e00\u4e2a\u6d41\u89c6\u56fe\u3002 \u5b9a\u4e49\u597d\u4e4b\u540e\uff0c\u6570\u636e\u63d2\u5165\u6d41(stream_1)\uff0c\u8fd9\u4e2a\u6d41\u89c6\u56fe\u5c31\u4f1a\u4e0d\u65ad\u589e\u91cf\u7684\u8fdb\u884c\u7edf\u8ba1\uff0c\u4f60\u53ea\u8981\u67e5\u8be2\u8fd9\u4e2a\u6d41\u89c6\u56fe\uff0c\u5c31\u53ef\u4ee5\u67e5\u770b\u5230\u5b9e\u65f6\u7684\u7edf\u8ba1\u7ed3\u679c\u3002 \u6570\u636e\u5e93\u4e2d\u5b58\u50a8\u7684\u662f\u5b9e\u65f6\u7edf\u8ba1\u7684\u7ed3\u679c\uff08\u5b9e\u9645\u4e0a\u662f\u5728\u5185\u5b58\u4e2d\u8fdb\u884c\u589e\u91cf\u5408\u5e76\u7684\uff0c\u589e\u91cf\u7684\u65b9\u5f0f\u6301\u4e45\u5316\uff09\u3002</p>"},{"location":"postgres/extentions/pipelinedb02/#transforms","title":"Transforms","text":"<p>\u4e0e\u6d41\u89c6\u56fe\u4e0d\u540c\u7684\u662f\uff0ctransform\u662f\u7528\u6765\u89e6\u53d1\u4e8b\u4ef6\u7684\uff0c\u6240\u4ee5\u5b83\u53ef\u4ee5\u4e0d\u4fdd\u7559\u6570\u636e\uff0c\u4f46\u662f\u53ef\u4ee5\u8bbe\u5b9a\u6761\u4ef6\uff0c\u5f53\u8bb0\u5f55\u6ee1\u8db3\u6761\u4ef6\u65f6\uff0c\u5c31\u89e6\u53d1\u4e8b\u4ef6\u3002 \u4f8b\u5982\u76d1\u89c6\u4f20\u611f\u5668\u7684\u503c\uff0c\u5f53\u503c\u7684\u8303\u56f4\u8d85\u51fa\u65f6\uff0c\u89e6\u53d1\u62a5\u8b66\uff08\u5982\u901a\u8fc7REST\u63a5\u53e3\u53d1\u7ed9\u6307\u5b9a\u7684server\uff09\uff0c\u6216\u8005\u5c06\u62a5\u8b66\u8bb0\u5f55\u4e0b\u6765\uff08\u901a\u8fc7\u89e6\u53d1\u5668\u51fd\u6570\uff09\u3002</p>"},{"location":"postgres/extentions/pipelinedb02/#_4","title":"\u652f\u6301\u7279\u6027","text":"<p>pipelinedb\u7ee7\u627f\u4e86PostgreSQL\u5f88\u597d\u7684\u6269\u5c55\u6027\uff0c\u4f8b\u5982\u652f\u6301\u4e86\u6982\u7387\u7edf\u8ba1\u76f8\u5173\u7684\u529f\u80fd\uff0c\u4f8b\u5982HLL\u7b49\u3002\u7528\u8d77\u6765\u4e5f\u975e\u5e38\u7684\u723d\uff0c\u4f8b\u5982\u7edf\u8ba1\u7f51\u7ad9\u7684UV\uff0c\u6216\u8005\u7ea2\u7eff\u706f\u901a\u8fc7\u7684\u6c7d\u8f66\u7f16\u53f7\u552f\u4e00\u503c\u8f66\u6d41\uff0c\u901a\u8fc7\u624b\u673a\u4fe1\u53f7\u7edf\u8ba1\u57fa\u7ad9\u8f90\u5c04\u65b9\u5706\u591a\u5c11\u516c\u91cc\u7684\u6309\u65f6UV\u7b49\u3002 Bloom Filter   Count-Min Sketch   Filtered-Space Saving Top-K   HyperLogLog   T-Digest    </p>"},{"location":"postgres/extentions/pipelinedb02/#sliding-windows","title":"\u6ed1\u7a97(Sliding Windows)","text":"<p>\u56e0\u4e3a\u5f88\u591a\u573a\u666f\u7684\u6570\u636e\u6709\u65f6\u6548\uff0c\u6216\u8005\u6709\u65f6\u95f4\u7a97\u53e3\u7684\u6982\u5ff5\uff0c\u6240\u4ee5pipelinedb\u63d0\u4f9b\u4e86\u7a97\u53e3\u5206\u7247\u7684\u63a5\u53e3\uff0c\u5141\u8bb8\u7528\u6237\u5bf9\u6570\u636e\u7684\u65f6\u6548\u8fdb\u884c\u5b9a\u4e49\u3002 \u4f8b\u5982\u4ec5\u4ec5\u7edf\u8ba1\u6700\u8fd1\u4e00\u5206\u949f\u7684\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u7edf\u8ba1\u6570\u636e\u3002 \u6bd4\u5982\u70ed\u529b\u56fe\uff0c\u5c55\u793a\u6700\u8fd1\u4e00\u5206\u949f\u7684\u70ed\u5ea6\uff0c\u5bf9\u4e8e\u65e7\u7684\u6570\u636e\u4e0d\u5173\u5fc3\uff0c\u5c31\u53ef\u4ee5\u9002\u5e94SW\u8fdb\u884c\u5b9a\u4e49\uff0c\u4ece\u800c\u4fdd\u7559\u7684\u6570\u636e\u5c11\uff0c\u5bf9\u673a\u5668\u7684\u8981\u6c42\u4f4e\uff0c\u6548\u7387\u8fd8\u9ad8\u3002</p>"},{"location":"postgres/extentions/pipelinedb02/#base-on-centos7postgres10","title":"\u5b89\u88c5 base on centos7&amp;postgres10","text":"<pre><code>add repository\ncurl -s http://download.pipelinedb.com/yum.sh | sudo bash\n\npipeline package\nsudo yum install pipelinedb-postgresql-10\n\n\u4fee\u6539\u6570\u636e\u5e93\u914d\u7f6e\n# At the bottom of &lt;data directory&gt;/postgresql.conf\nshared_preload_libraries = 'pipelinedb'\nmax_worker_processes = 128\n\n\u91cd\u542f\u6570\u636e\u5e93\nsystemctl restart postgresql-10\n\n\u521b\u5efa\u6269\u5c55 pipelinedb\nCREATE EXTENSION pipelinedb\n\n\u67e5\u770b\n\\dx\n                                               \u5df2\u5b89\u88c5\u6269\u5c55\u5217\u8868\n        \u540d\u79f0        | \u7248\u672c  |  \u67b6\u6784\u6a21\u5f0f  |                               \u63cf\u8ff0                                \n--------------------+-------+------------+-------------------------------------------------------------------\n pipelinedb         | 1.0.0 | public     | PipelineDB\n</code></pre>"},{"location":"postgres/extentions/pipelinedb02/#_5","title":"\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50","text":"<pre><code>\u521b\u5efa\u4e00\u4e2a\u6d41\n\nCREATE  FOREIGN TABLE  s1 (id int, val int) SERVER pipelinedb;  // \u7406\u89e3\u4e3a\u5b66\u751fId\uff0c\u6210\u7ee9\n\n\u6d41\u89c6\u56fe\u7edf\u8ba1count, avg, min, max, sum\u51e0\u4e2a\u5e38\u89c1\u7ef4\u5ea6\nCREATE VIEW v1 WITH (action=materialize) AS  SELECT id,count(*),avg(val),min(val),max(val),sum(val)\nFROM s1 GROUP BY id;\n\n\u63d2\u5165\u6570\u636e\ninsert into s1 values (0,100);\ninsert into s1 values (1,90);\ninsert into s1 values (2,93);\ninsert into s1 values (0,99);\ninsert into s1 values (1,96);\ninsert into s1 values (2,83);\n\n\u67e5\u770b\u7ed3\u679c\n\npipelinedb=# select * from v1;\n id | count |         avg         | min | max | sum\n----+-------+---------------------+-----+-----+-----\n  1 |     2 | 93.0000000000000000 |  90 |  96 | 186\n  0 |     2 | 99.5000000000000000 |  99 | 100 | 199\n  2 |     2 | 88.0000000000000000 |  83 |  93 | 176\n(3 \u884c\u8bb0\u5f55)\n\npipelinedb=# select * from v1_mrel;\n id | count |   avg   | min | max | sum | $pk\n----+-------+---------+-----+-----+-----+-----\n  1 |     2 | {2,186} |  90 |  96 | 186 |   4\n  0 |     2 | {2,199} |  99 | 100 | 199 |   6\n  2 |     2 | {2,176} |  83 |  93 | 176 |   5\n(3 \u884c\u8bb0\u5f55)\n\n\u8868\u7ed3\u6784\u6982\u89c8\n\npipelinedb=# \\d\n public   | s1                 | \u6240\u5f15\u7528\u7684\u5916\u8868 | postgres\n public   | v1                 | \u89c6\u56fe         | postgres\n public   | v1_def             | \u89c6\u56fe         | postgres\n public   | v1_mrel            | \u6570\u636e\u8868       | postgres\n public   | v1_osrel           | \u6240\u5f15\u7528\u7684\u5916\u8868 | postgres\n public   | v1_seq             | \u5e8f\u5217\u6570       | postgres\n\npipelinedb=# \\d+ s1\n                                               \u5f15\u7528\u7684\u5916\u90e8\u8868 \"public.s1\"\n       \u680f\u4f4d        |           \u7c7b\u578b           | Collation | Nullable | Default | FDW options | \u5b58\u50a8  | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0\n-------------------+--------------------------+-----------+----------+---------+-------------+-------+----------+------\n id                | integer                  |           |          |         |             | plain |          |\n val               | integer                  |           |          |         |             | plain |          |\n arrival_timestamp | timestamp with time zone |           |          |         |             | plain |          |\nServer: pipelinedb\n\npipelinedb=# \\d+ v1\n                        \u89c6\u56fe \"public.v1\"\n \u680f\u4f4d  |  \u7c7b\u578b   | Collation | Nullable | Default | \u5b58\u50a8  | \u63cf\u8ff0\n-------+---------+-----------+----------+---------+-------+------\n id    | integer |           |          |         | plain |\n count | bigint  |           |          |         | plain |\n avg   | numeric |           |          |         | main  |\n min   | integer |           |          |         | plain |\n max   | integer |           |          |         | plain |\n sum   | bigint  |           |          |         | plain |\n\u89c6\u56fe\u5b9a\u4e49:\n SELECT v1_mrel.id,\n    v1_mrel.count,\n    int8_avg(v1_mrel.avg) AS avg,\n    v1_mrel.min,\n    v1_mrel.max,\n    v1_mrel.sum\n   FROM ONLY v1_mrel;\n\npipelinedb=# \\d+ v1_def\n                      \u89c6\u56fe \"public.v1_def\"\n \u680f\u4f4d  |  \u7c7b\u578b   | Collation | Nullable | Default | \u5b58\u50a8  | \u63cf\u8ff0\n-------+---------+-----------+----------+---------+-------+------\n id    | integer |           |          |         | plain |\n count | bigint  |           |          |         | plain |\n avg   | numeric |           |          |         | main  |\n min   | integer |           |          |         | plain |\n max   | integer |           |          |         | plain |\n sum   | bigint  |           |          |         | plain |\n\u89c6\u56fe\u5b9a\u4e49:\n SELECT s1.id,\n    count(*) AS count,\n    avg(s1.val) AS avg,\n    min(s1.val) AS min,\n    max(s1.val) AS max,\n    sum(s1.val) AS sum\n   FROM s1\n  GROUP BY s1.id;\n\u9009\u9879: action=materialize, cv=v1, stream=public.s1, matrel=v1_mrel, overlay=v1, osrel=v1_osrel, seqrel=v1_seq, pkindex=v1_mrel_pkey, lookupindex=v1_mrel_expr_idx\n\npipelinedb=# \\d+ v1_mrel\n                            \u6570\u636e\u8868 \"public.v1_mrel\"\n \u680f\u4f4d  |   \u7c7b\u578b   | Collation | Nullable | Default |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0\n-------+----------+-----------+----------+---------+----------+----------+------\n id    | integer  |           |          |         | plain    |          |\n count | bigint   |           |          |         | plain    |          |\n avg   | bigint[] |           |          |         | extended |          |\n min   | integer  |           |          |         | plain    |          |\n max   | integer  |           |          |         | plain    |          |\n sum   | bigint   |           |          |         | plain    |          |\n $pk   | bigint   |           | not null |         | plain    |          |\n\u7d22\u5f15\uff1a\n    \"v1_mrel_pkey\" PRIMARY KEY, btree (\"$pk\")\n    \"v1_mrel_expr_idx\" btree (pipelinedb.hash_group(id))\n\u9009\u9879: fillfactor=50\n\npipelinedb=# \\d+ v1_osrel\n                                              \u5f15\u7528\u7684\u5916\u90e8\u8868 \"public.v1_osrel\"\n       \u680f\u4f4d        |           \u7c7b\u578b           | Collation | Nullable | Default | FDW options |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0\n-------------------+--------------------------+-----------+----------+---------+-------------+----------+----------+------\n old               | v1                       |           |          |         |             | extended |          |\n new               | v1                       |           |          |         |             | extended |          |\n delta             | v1_mrel                  |           |          |         |             | extended |          |\n arrival_timestamp | timestamp with time zone |           |          |         |             | plain    |          |\nServer: pipelinedb\n\npipelinedb=# \\d+ v1_seq\n                            \u5e8f\u5217\u6570 \"public.v1_seq\"\n  \u7c7b\u578b  | Start | Minimum |       Maximum       | Increment | Cycles? | Cache\n--------+-------+---------+---------------------+-----------+---------+-------\n bigint |     1 |       1 | 9223372036854775807 |         1 | no      |     1\n\u5c5e\u4e8e: public.v1_mrel.\"$pk\"\n\n</code></pre>"},{"location":"postgres/extentions/timescaledb/","title":"TimescaleDB \u65f6\u5e8f\u6570\u636e\u5e93","text":"<p>\u65f6\u5e8f\u6570\u636e\u5e93 https://github.com/timescale/timescaledb</p> <p>\u6570\u636e\u5e93\u914d\u7f6e https://github.com/timescale/timescaledb-tune</p> <p>copy\u5e76\u884c\u5bfc\u5165\u6570\u636e https://github.com/timescale/timescaledb-parallel-copy</p>"},{"location":"postgres/extentions/timescaledb/#_1","title":"\u5e38\u7528\u65b9\u6cd5","text":"<p>\u521b\u5efa\u62d3\u5c55</p> <pre><code>CREATE EXTENSION timescaledb;\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u666e\u901a\u7684\u8868</p> <pre><code>CREATE TABLE conditions (\n  time        TIMESTAMPTZ       NOT NULL,\n  location    TEXT              NOT NULL,\n  temperature DOUBLE PRECISION  NULL,\n  humidity    DOUBLE PRECISION  NULL\n);\n</code></pre> <p>\u8f6c\u6362\u6210\u65f6\u5e8f\u6570\u636e\u5e93\u8868</p> <pre><code>SELECT create_hypertable('conditions', 'time');\n</code></pre> <ul> <li>conditions \u8868\u540d</li> <li>time \u65f6\u5e8f\u5b57\u6bb5</li> </ul> <p>\u4fee\u6539\u65f6\u5e8f\u95f4\u9694 \u5bf9\u65b0\u8868\u751f\u6548</p> <pre><code>SELECT set_chunk_time_interval('conditions', INTERVAL '24 hours');\n</code></pre> <p>\u67e5\u770b\u5206\u533a</p> <pre><code>SELECT show_chunks('conditions');\n\nSELECT show_chunks('conditions', older_than =&gt; INTERVAL '3 months')\n\nSELECT show_chunks('conditions', older_than =&gt; DATE '2017-01-01');\n\nSELECT show_chunks(newer_than =&gt; INTERVAL '3 months');\n\nSELECT show_chunks(older_than =&gt; INTERVAL '3 months', newer_than =&gt; INTERVAL '4 months');\n\n</code></pre> <p>\u67e5\u770b\u6570\u636e\u5927\u5c0f</p> <pre><code>SELECT * FROM timescaledb_information.hypertable;\n</code></pre> <p>\u81ea\u52a8\u5220\u9664</p> <pre><code>\u6dfb\u52a0\u89c4\u5219\nSELECT add_drop_chunks_policy('conditions', INTERVAL '6 months');\n\u5220\u9664\u89c4\u5219\nSELECT remove_drop_chunks_policy('conditions');\n</code></pre>"},{"location":"postgres/extentions/timescaledb/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<pre><code>When creating hypertables, one constraing that TimescaleDB imposes is that the partitioning column (in your case 'date_time') must be included in any unique indexes (and Primary Keys) for that table.\n</code></pre> <p>https://stackoverflow.com/questions/61205063/error-cannot-create-a-unique-index-without-the-column-date-time-used-in-part</p>"},{"location":"postgres/extentions/timescaledb/#_3","title":"\u65f6\u5e8f\u6570\u636e\u7279\u5f81","text":"<ul> <li>have a timestamp</li> <li>append only ,less update or delete</li> <li>recent hot</li> </ul>"},{"location":"postgres/extentions/timescaledb/#_4","title":"\u9650\u5236","text":"<p>\u9664\u5206\u533a\u5217\u5916\u4e0d\u53ef\u4ee5\u5728\u5176\u4ed6\u5217\u4e2d\u6709\u552f\u4e00\u7ea6\u675f</p> <p>\u539f\u6570\u636e\u5e93\u4e2d\u7684\u552f\u4e00\u7ea6\u675f\u4e3a\u5168\u5c40\u8868\u5185\u552f\u4e00\u7ea6\u675f\uff0c\u5728\u5206\u533a\u8868\uff08chunks\uff09\u4e2d\u4e0d\u80fd\u591f\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00</p> <pre><code>When converting a normal SQL table to a hypertable, pay attention to how you handle constraints.\nA hypertable can contain foreign keys to normal SQL table columns, but the reverse is not allowed. UNIQUE and PRIMARY constraints must include the partitioning key.\n</code></pre>"},{"location":"postgres/extentions/timescaledb/#_5","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"postgres/extentions/timescaledb/#chunk","title":"chunk \u65f6\u95f4\u8303\u56f4","text":"<p>\u4e0e\u6570\u636e\u91cf\u6709\u5173\uff0c\u4e00\u4e2achunk\u5bb9\u91cf\u7ea61/4 \u5185\u5b58\u5927\u5c0f</p> <pre><code>SELECT * FROM create_hypertable('conditions', 'time',\n       chunk_time_interval =&gt; INTERVAL '1 day');\n</code></pre>"},{"location":"postgres/extentions/timescaledb/#_6","title":"\u7ec4\u5408\u7d22\u5f15","text":"<p>1 \u7b49\u503c\u67e5\u8be2 \uff08e,time\uff09e \u4e3a\u7b49\u503c\u67e5\u8be2\u5217 time \u4e3a\u5206\u533a\u65f6\u95f4\u5217   2 \u8303\u56f4\u67e5\u8be2  (time,c) c \u4e3a\u8fde\u7eed\u503c\u5217 </p>"},{"location":"postgres/extentions/timescaledb/#_7","title":"\u6392\u5e8f","text":""},{"location":"postgres/extentions/timescaledb/#_8","title":"\u538b\u7f29","text":"<p>\u8bbe\u7f6e\u5386\u53f2\u6570\u636e\u538b\u7f29\u7b56\u7565\uff0c\u538b\u7f29\u540e\u53d8\u6210\u5217\u5b58\uff0c\u4e14\u4e3a\u53ea\u8bfb</p> <p>```   alter table conditions set( timescaledb.compress);</p> <p>timescaledb.compress_segmentby   timescaledb.compress_orderby  <code>\u8bbe\u7f6e\u538b\u7f29\u7b56\u7565</code>   SELECT add_compress_chunks_policy('conditions', INTERVAL '60d');   <code>\u5220\u9664\u538b\u7f29\u7b56\u7565</code>   remove_compress_chunks_policy()  <code>\u624b\u52a8\u538b\u7f29</code>  SELECT compress_chunk('_timescaledb_internal._hyper_1_2_chunk');  <code>\u89e3\u538b\u7f29</code>  SELECT compress_chunk('_timescaledb_internal._hyper_1_2_chunk');  <code>\u67e5\u770b\u538b\u7f29\u60c5\u51b5</code>  SELECT * FROM timescaledb_information.compressed_chunk_stats;  ```</p> <p>\u624b\u52a8\u6279\u91cf\u538b\u7f29</p> <p><code>SELECT compress_chunk(i) from show_chunks('conditions', newer_than, older_than) i;</code></p>"},{"location":"postgres/extentions/timescaledb/#_9","title":"\u4fdd\u7559\u7b56\u7565","text":"<p>\u8bbe\u7f6e\u4fdd\u7559\u6570\u636e\u7b56\u7565</p> <pre><code>SELECT add_drop_chunks_policy('conditions', INTERVAL '24 hours');\n</code></pre>"},{"location":"postgres/extentions/timescaledb/#_10","title":"\u8fde\u7eed\u5206\u6790\u7a97\u53e3","text":"<p>\u7269\u5316\u89c6\u56fe\u81ea\u52a8\u6301\u7eed\u66f4\u65b0</p>"},{"location":"postgres/extentions/timescaledb/#_11","title":"\u66f4\u591a\u4fe1\u606f\u67e5\u770b","text":"<p>\u6bd4\u5982\u538b\u7f29\u7b56\u7565\uff0c\u4fdd\u7559\u7b56\u7565\uff0c\u6301\u7eed\u96c6\u6210\u7b56\u7565\u7b49</p> <pre><code>\\dv timescaledb_information.*\n                            List of relations\n         Schema          |            Name             | Type |  Owner   \n-------------------------+-----------------------------+------+----------\n timescaledb_information | compressed_chunk_stats      | view | postgres\n timescaledb_information | compressed_hypertable_stats | view | postgres\n timescaledb_information | continuous_aggregate_stats  | view | postgres\n timescaledb_information | continuous_aggregates       | view | postgres\n timescaledb_information | drop_chunks_policies        | view | postgres\n timescaledb_information | hypertable                  | view | postgres\n timescaledb_information | license                     | view | postgres\n timescaledb_information | policy_stats                | view | postgres\n timescaledb_information | reorder_policies            | view | postgres\n</code></pre>"},{"location":"postgres/ha/adlock/","title":"\u54a8\u8be2\u9501 adlock","text":"<p>https://github.com/digoal/blog/blob/master/201805/20180524_02.md</p>"},{"location":"postgres/ha/adlock/#_1","title":"\u884c\u7ea7\u9501","text":"<pre><code>select .. for update \n\nselect .. for update skip locked\n\nselect .. for share\n</code></pre>"},{"location":"postgres/ha/ha_fd/","title":"\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u8bbe\u8ba1\u5206\u6790","text":""},{"location":"postgres/ha/ha_fd/#_1","title":"\u57fa\u672c\u6982\u5ff5","text":"<p>\u96c6\u7fa4\uff1a \u4e00\u7ec4\u591a\u4e2a\u540c\u65f6\u5bf9\u5916\u63d0\u4f9b\u76f8\u540c\u670d\u52a1\u7684\u5b9e\u4f53\u673a\u7ec4\u6210\u4e00\u4e2a\u96c6\u7fa4\u3002\u8fd9\u91cc\u7684\u96c6\u7fa4\u4e3a\u4e3b\u4ece\u7ed3\u6784\uff0c\u53ef\u5199\u8282\u70b9\u4e3a\u4e3b\u8282\u70b9\uff0c\u5176\u4ed6\u53ea\u8bfb\u8282\u70b9\u4e3a\u4ece\u8282\u70b9\u3002</p> <p>\u9ad8\u53ef\u7528\uff1a \u5728\u53d1\u751f\u5c40\u90e8\u6545\u969c\u65f6\u5bf9\u6574\u4f53\u4e1a\u52a1\u5f71\u54cd\u5f88\u4f4e\u3002\u5373\u4e0d\u53ef\u7528\u7684\u65f6\u95f4\u8981\u5c3d\u91cf\u7684\u77ed\u3002</p> <p>\u5bf9\u5916\u90e8\u5e94\u7528\u7684\u8bbf\u95ee\u6765\u8bf4\uff0c\u65e0\u9700\u5173\u6ce8\u5982\u4f55\u5b9e\u73b0\uff0c\u5982\u540c\u53ea\u8bbf\u95ee\u4e00\u4e2a\u8282\u70b9\u3002\u5e76\u80fd\u5f97\u5230\u6301\u7eed\u7684\u670d\u52a1\u80fd\u529b\u3002</p>"},{"location":"postgres/ha/ha_fd/#_2","title":"\u7ec4\u7ec7\u7ed3\u6784","text":""},{"location":"postgres/ha/ha_fd/#_3","title":"\u9ad8\u53ef\u7528\u57fa\u77f3","text":"<ul> <li>\u5197\u4f59</li> <li>\u5207\u6362\u673a\u5236</li> <li>\u540c\u6b65\u7b56\u7565</li> </ul>"},{"location":"postgres/ha/ha_fd/#_4","title":"\u5197\u4f59","text":"<p>\u907f\u514d\u5355\u70b9\u6545\u969c\u7684\u672c\u8d28\u662f\u5197\u4f59,\u4e0d\u540c\u7ea7\u522b\u7684\u5197\u4f59\u5e26\u6765\u7684\u662f\u4e0d\u540c\u7ea7\u522b\u7684\u9ad8\u53ef\u7528\u3002</p>"},{"location":"postgres/ha/ha_fd/#_5","title":"\u5355\u673a\u5197\u4f59","text":"<ul> <li>\u5b58\u50a8 </li> </ul> <p>\u591a\u5757\u786c\u76d8\u505araid\uff0c\u7f51\u7edc\u5b58\u50a8\uff0c\u5916\u90e8\u5b58\u50a8\uff0c\u5171\u4eab\u5b58\u50a8\uff0c\u5feb\u7167\u7b49</p> <ul> <li>\u7f51\u7edc </li> </ul> <p>\u591a\u7f51\u5361bond</p> <ul> <li>\u7535\u6e90 </li> </ul> <p>\u591a\u7535\u6e90\uff0cUPS\u7b49</p> <p>\u7531\u4e8e\u6bcf\u4e2a\u5355\u673a\u4e0a\u90fd\u7528\u4e00\u4efd\u5b8c\u6574\u7684\u6570\u636e\u3002\u5f53\u5355\u673a\u53d1\u751f\u6545\u969c\u65f6\u53ef\u4fdd\u969c\u4ecd\u7136\u80fd\u591f\u63d0\u4f9b\u670d\u52a1\u3002</p>"},{"location":"postgres/ha/ha_fd/#_6","title":"\u591a\u673a\u5197\u4f59","text":"<p>\u4e0d\u8981\u628a\u9e21\u86cb\u653e\u5728\u540c\u4e00\u4e2a\u7bee\u5b50\u91cc\u3002</p> <ul> <li>\u8282\u70b9\u95f4\u7f51\u7edc,\u4ea4\u6362\u673a</li> <li>\u5206\u5e03\u5728\u4e0d\u540c\u673a\u67dc</li> <li>\u5206\u5e03\u5728\u4e0d\u540c\u6570\u636e\u4e2d\u5fc3</li> </ul>"},{"location":"postgres/ha/ha_fd/#_7","title":"\u540c\u6b65\u7b56\u7565","text":"<ul> <li>\u5f02\u6b65</li> <li>\u534a\u540c\u6b65</li> <li>\u5168\u540c\u6b65</li> </ul> <p>\u6027\u80fd: \u5f02\u6b65 &gt; \u534a\u540c\u6b65  &gt;  \u5168\u4e0d\u540c\u6b65</p> <p>\u6570\u636e\u53ef\u9760\u6027\uff1a \u5168\u540c\u6b65 &gt; \u534a\u540c\u6b65 &gt; \u5f02\u6b65</p> <p>\u6027\u80fd\u548c\u6570\u636e\u53ef\u9760\u6027\u7efc\u5408\u8003\u91cf</p>"},{"location":"postgres/ha/ha_fd/#_8","title":"\u5207\u6362\u673a\u5236\u7ec4\u6210","text":"<p>\u5728\u53d1\u751f\u5f02\u5e38\u60c5\u51b5\uff0c\u5e94\u8be5\u6709\u4ee5\u4e0b\u4e09\u4e2a\u90e8\u5206\u914d\u5408\u540c\u65f6\u5b8c\u6210\u5207\u6362</p> <ul> <li>\u7edf\u4e00\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1</li> </ul> <p>\u901a\u8fc7\u670d\u52a1\u53d1\u73b0\uff0c\u96c6\u7fa4\u5bf9\u5916\u4f53\u7edf\u8bbf\u95ee\u5165\u53e3,\u8d1f\u8f7d\u5747\u8861\u3002</p> <p>\u5bf9\u5e94\u7528\u8bbf\u95ee\u6570\u636e\u5e93\u96c6\u7fa4\u8fdb\u884c\u63a5\u8026\u3002\u5f53\u540e\u7aef\u6570\u636e\u5e93\u8282\u70b9\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u5bf9\u5e94\u7528\u65e0\u611f\u3002</p> <p>\u53ef\u9009\u53d6 DNS \u6216 consul </p> <ul> <li>\u6570\u636e\u5e93\u7ba1\u7406 MDB</li> </ul> <p>\u5bf9\u96c6\u7fa4\u591a\u5b9e\u4f53\u673a\u8fdb\u884c\u7edf\u4e00\u7ba1\u7406\uff0c\u81ea\u5b9a\u6545\u969c\u5207\u6362\u673a\u5236\u3002\u5e76\u5b8c\u6210\u6545\u969c\u8f6c\u79fb\u3002</p> <p>MDB\u4e0eDB\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u3002\u53ef\u5728DB\u53d1\u751f\u610f\u5916\u65f6\u5bf9DB\u8fdb\u884c\u91cd\u65b0\u542f\u52a8\u3002</p> <p>\u53ef\u9009\u7528 patroni</p> <ul> <li>\u7ba1\u7406\u914d\u7f6e\u4e2d\u5fc3</li> </ul> <p>\u63a5\u6536\u96c6\u7fa4\u4e2d\u5b9e\u4f53\u673a\u5fc3\u8df3\u4fe1\u606f\uff0c\u5b9e\u65f6\u638c\u63e1\u96c6\u7fa4\u4e2d\u5b9e\u4f53\u673a\u72b6\u6001\u3002\u53ef\u5bf9\u96c6\u7fa4\u8fdb\u884c\u9009\u4e3b\u3002</p> <p>\u53ef\u9009\u7528 DCS \uff0cetcd \u3001zookeeper\u3001 consul\u3001 raft</p> <p>\u53e6\u5916\u8fd9\u4e9b\u7ec4\u4ef6\u672c\u8eab\u5c31\u6709\u5b8c\u5584\u7684\u9ad8\u53ef\u7528\u65b9\u6848</p>"},{"location":"postgres/ha/ha_fd/#_9","title":"\u7edf\u4e00\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u9ad8\u53ef\u7528","text":"<p>\u7531\u4e8e\u8be5\u7ec4\u4ef6\u5c5e\u4e8e\u65e0\u72b6\u6001\u5e94\u7528\u3002\u5197\u4f59\u548c\u670d\u52a1\u53ef\u7528\u6027\u72b6\u6001\u5224\u65ad\u5373\u53ef\u6ee1\u8db3\u9ad8\u53ef\u7528\u3002\u670d\u52a1\u53ef\u7528\u6027\u5224\u65ad\u901a\u7528\u7684app\u57fa\u672c\u90fd\u53ea\u8eab\u652f\u6301\u3002</p> <ul> <li>\u4e8c\u5c42 keepalived</li> <li>\u56db\u5c42 haproxy</li> <li>\u4e03\u5c42 dns</li> </ul> <p>\u5176\u4ed6:  consul ,zookeeper \u7b49  \u670d\u52a1\u6ce8\u518c\uff0c\u670d\u52a1\u53d1\u73b0\u7ba1\u7406\u4e2d\u5fc3\u3002</p>"},{"location":"postgres/ha/ha_fd/#mdb","title":"\u6570\u636e\u5e93\u7ba1\u7406 MDB \u9ad8\u53ef\u7528","text":"<p>\u7531\u4e8e\u4e00\u53f0\u8282\u70b9\u4e0a\uff0c\u53ea\u6709\u4e00\u4e2aMDB\u3002MDB \u53d1\u751f\u4ee5\u5916\uff0c\u4e0eMDB\u540c\u5c5e\u4e8e\u4e00\u53f0\u8282\u70b9\u4e0a\u7684DB\u5c06\u5904\u4e8e\u6258\u7ba1\u72b6\u6001\u3002</p> <p>MDB \u9ad8\u53ef\u7528\u7684\u5b9e\u73b0\u65b9\u5f0f\u4e0d\u662f\u5197\u4f59\uff0c\u56e0\u4e3aDMB \u53ea\u5bf9\u672c\u8282\u70b9\u4e0a\u7684DB\u8d1f\u8d23\u3002\u5197\u4f59\u610f\u4e49\u4e0d\u660e\u663e\u3002</p> <p>\u5177\u4f53\u7684\u5b9e\u73b0\u65b9\u5f0f\u662f MDB \u8fdb\u7a0b\u5b9e\u65f6\u4e0e\u672c\u8282\u70b9\u7684\u64cd\u4f5c\u7cfb\u7edf\u901a\u4fe1\uff0c\u53d1\u9001\u5fc3\u8df3\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u3002\u5f53\u64cd\u4f5c\u7cfb\u7edf\u8d85\u51fa\u4e00\u5b9a\u65f6\u95f4\u540e\u6ca1\u6709\u6536\u5230\u5fc3\u8df3\u4fe1\u606f\uff0c\u5c06\u53d1\u751f\u91cd\u542f\u7cfb\u7edf\u3002 </p> <p>DB \u5fe0\u8bda\u4e0e MDB \uff0c\u4e00\u8363\u4ff1\u8363\uff0c\u4e00\u635f\u4ff1\u635f\u3002\u540c\u751f\u5171\u4ea1\u3002</p>"},{"location":"postgres/ha/ha_fd/#_10","title":"\u5207\u6362\u673a\u5236\u8bbe\u7f6e","text":"<p>\u5207\u6362\u673a\u5236\u7684\u914d\u7f6e\u7ba1\u7406\u90fd\u662f\u5728MDB\u4e0a\u6765\u5b8c\u6210\u3002</p> <p>\u96c6\u7fa4\u8282\u70b9\u5177\u4f53\u7684\u7ba1\u7406\u8005\uff0c\u5982\u4f55\u5c06\u8fd9\u4e9b\u5197\u4f59\u8282\u70b9\u7edf\u4e00\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002</p> <p>\u5728\u5404\u79cd\u5f02\u5e38\u60c5\u51b5\u53d1\u751f\u65f6\u4f5c\u51fa\u76f8\u5e94\u7684\u51b3\u7b56\uff0c\u5373\u5bf9\u5e94\u7684\u8c03\u6574\u3002</p> <p>\u6545\u969c\u5f02\u5e38\u7c7b\u578b\u4e3b\u8981\u5206\u4e24\u7c7b\uff1a</p> <ul> <li>\u7ec4\u4ef6\u6a21\u5757\u5f02\u5e38</li> <li>\u7ec4\u4ef6\u6a21\u5757\u95f4\u901a\u4fe1\u5f02\u5e38</li> </ul>"},{"location":"postgres/ha/ha_fd/#_11","title":"\u7ec4\u4ef6\u6a21\u5757\u5f02\u5e38","text":"<p>\u6839\u636e\u7ec4\u4ef6\u7ed3\u6784\u56fe\uff0c \u5bf9\u5916\u7edf\u4e00\u8bbf\u95ee\u548c\u8282\u70b9\u72b6\u6001\u4fe1\u606f\u7ec4\u4ef6\u672c\u8eab\u652f\u6301\u9ad8\u53ef\u7528\u3002\u8fd9\u91cc\u4e0d\u5728\u8003\u8651\u3002</p> <p>\u63a5\u4e0b\u6765\u5206\u522b\u5bf9\u5982\u4e0b\u7ec4\u4ef6\u5f02\u5e38\u6545\u969c\u53d1\u751f\u65f6\u8fdb\u884c\u5206\u6790</p> <ul> <li>DB</li> <li>MDB</li> <li>OS </li> </ul>"},{"location":"postgres/ha/ha_fd/#db","title":"DB\u5f02\u5e38","text":"<p>DB \u7684\u53ef\u7528\u6027\u6709MDB\u8fdb\u884c\u76d1\u63a7\u3002\u5b9e\u65f6\u6536\u96c6DB\u4fe1\u606f\u5e76\u56de\u62a5\u7ed9\u8282\u70b9\u72b6\u6001\u4fe1\u606f\u7ec4\u4ef6\u3002 \u6536\u96c6\u4fe1\u606f\u4e3b\u8981\u5305\u62ec\uff1a \u5f53\u524d\u53ef\u7528\u6027\u72b6\u6001\uff0c\u4e3b\u4ece\u7c7b\u578b\uff0c\u4e3b\u4ece\u62d3\u6251\uff0c\u4e3b\u4ece\u5ef6\u957f\uff0c\u5f53\u524dLSN\uff0cTimeLine\u7b49</p> <p>\u5f53MDB \u53d1\u73b0DB\u5f02\u5e38\u65f6\u9996\u5148\u5c1d\u8bd5\u5bf9DB\u8fdb\u884c\u91cd\u542f\u5904\u7406\uff0c\u5bb6\u4e11\u5148\u4e0d\u5916\u626c\uff0c\u5185\u90e8\u77db\u76fe\u5185\u90e8\u5148\u5904\u7406\u3002\u5982\u679c\u91cd\u542f\u4e0d\u80fd\u89e3\u51b3\uff0c\u628a\u5f02\u5e38\u4fe1\u606f\u4e0a\u62a5\u4e2a\u4e2d\u5fc3\u3002DB\u8282\u70b9\u5728\u96c6\u7fa4\u4e2d\u5254\u9664\u3002\u82e5\u5f53\u524d\u8282\u70b9\u4e3a\u4e3b\u8282\u70b9\uff0c\u96c6\u7fa4\u91cd\u65b0\u9009\u4e3b\u3002</p>"},{"location":"postgres/ha/ha_fd/#mdb_1","title":"MDB \u5f02\u5e38","text":""},{"location":"postgres/ha/ha_fd/#_12","title":"\u901a\u4fe1\u5f02\u5e38","text":"<ul> <li>\u901a\u4fe1\u65ad\u5f00</li> <li>\u901a\u4fe1\u6062\u590d</li> </ul>"},{"location":"postgres/ha/patroni/","title":"PG\u9ad8\u53ef\u7528Patroni","text":"","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_1","title":"\u73af\u5883","text":"<ul> <li>\u64cd\u4f5c\u7cfb\u7edf Centos 7</li> <li>patroni \u7248\u672c 2.0.2</li> <li>postgres \u7248\u672c 13</li> </ul>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_2","title":"\u5b9e\u73b0\u76ee\u6807","text":"<ul> <li>\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4</li> <li>patroni \u7ed3\u6784\u5206\u6790</li> <li>patroni \u642d\u5efa\u65b0\u96c6\u7fa4</li> <li>patroni \u63a5\u7ba1\u73b0\u6709\u96c6\u7fa4</li> <li>patroni \u7ba1\u7406pg\u914d\u7f6e</li> <li>\u624b\u52a8swithover</li> <li>\u81ea\u52a8failover</li> <li>\u7ef4\u62a4\u6a21\u5f0f</li> <li>\u5f39\u6027\u6269\u5bb9\uff0c\u7f29\u5bb9</li> <li>\u5bf9\u5916\u63d0\u4f9b\u7edf\u4e00\u670d\u52a1</li> <li>RestFULLAPI</li> <li>\u5907\u4efd\u6062\u590d</li> <li>\u76d1\u63a7</li> <li>\u65e5\u5fd7</li> <li>\u5347\u7ea7</li> </ul>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_3","title":"\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4","text":"<p>pg\u7684\u9ad8\u53ef\u7528\u65b9\u6848\u90fd\u662f\u57fa\u4e8e\u6d41\u590d\u5236\u6765\u5b9e\u73b0</p> <ul> <li> <p>PAF pacemaker + corosyns  </p> </li> <li> <p>repmgr repmgr \u624b\u52a8\u6d41\u590d\u5236\u7ba1\u7406 repmgrd \u81ea\u52a8\u6d41\u590d\u5236\u7ba1\u7406 \u5b88\u62a4\u8fdb\u7a0b \u4e3b+\u4ece \u4e3b+\u4ece+\u89c1\u8bc1\u8282\u70b9</p> </li> </ul> <p>\u66f4\u591a\u4ecb\u7ecd</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#patroni","title":"patroni\u67b6\u6784\u5206\u6790","text":"<ul> <li>DCS[etcd] \u5916\u90e8\u4f9d\u8d56 \uff0c\u96c6\u7fa4\u901a\u4fe1\u9009\u4e3b</li> <li>patroni \u4e0epg\u5728\u540c\u4e00\u4e2a\u8282\u70b9\uff0c \u5b88\u62a4\u8fdb\u7a0b</li> </ul>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#patroni_1","title":"patroni\u642d\u5efa\u65b0\u96c6\u7fa4","text":"","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_4","title":"\u521b\u5efa\u865a\u62df\u673a\u73af\u5883","text":"\u8282\u70b9 IP \u5e94\u7528 node0 10.10.1.10 etcd,ntp node1 10.10.1.11 patroni,pg,ntp node2 10.10.1.12 patroni,pg,ntp node3 10.10.1.13 patroni,pg,ntp","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#etcd","title":"\u5b89\u88c5etcd","text":"<p>\u5355\u8282\u70b9etcd \u5b89\u88c5</p> <pre><code>yum install etcd \n</code></pre> <p>\u914d\u7f6e\u5176\u4ed6\u8282\u70b9\u53ef\u8bbf\u95ee /etcd/etcd.conf</p> <pre><code>ETCD_LISTEN_CLIENT_URLS=\"http://10.10.1.10:2379\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://10.10.1.10:2379\"\n</code></pre> <p>etcd \u96c6\u7fa4\u7ba1\u7406</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#patroni_2","title":"\u5b89\u88c5\u914d\u7f6epatroni","text":"<p>python3 \u73af\u5883</p> <pre><code>yum install gcc python3 python3-devel -y\npip3 install --upgrade pip\n</code></pre> <p>\u4f9d\u8d56\u5b89\u88c5</p> <pre><code>pip install psycopg2-binary\npip install patroni[etcd]\n</code></pre> <p>ntp \u5b89\u88c5</p> <pre><code>yum install ntp -y\nsystemctl start ntpd\nsystemctl enable ntpd\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_5","title":"\u6570\u636e\u5e93\u5b89\u88c5","text":"<p>\u53c2\u8003</p> <p>\u4e0d\u9700\u8981\u521d\u59cb\u5316</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_6","title":"\u57fa\u7840\u914d\u7f6e","text":"<p>vi /etc/patroni.yml</p> <pre><code>scope: pg_cluster01           # \u96c6\u7fa4\u540d\u79f0 \nnamespace: /pgs/       # \u540d\u79f0\u7a7a\u95f4\uff0c\u5bf9\u5e94etcd \u6839\u76ee\u5f55\nname: postgresql0        # \u8282\u70b9\u540d\u79f0\n\nrestapi:\n    listen: 10.10.1.11:8008             #\u5bf9\u5916restfull \u63a5\u53e3\n    connect_address: 10.10.1.11:8008\n\netcd:\n    host: 10.10.1.10:2379             # etcd\u670d\u52a1\u5730\u5740\n\nbootstrap:                            # \u5fc3\u8df3 \n    dcs:\n        ttl: 30\n        loop_wait: 10\n        retry_timeout: 10      # \u8bbf\u95eeetcd \u8d85\u65f6\u591a\u4e45\u540e\u91cd\u8bd5\n        maximum_lag_on_failover: 1048576  #\u4ece\u5e93\u843d\u540e\u4e3b\u5e93\u591a\u5c11bytes\u540efailover\u65f6\u4e0d\u80fd\u88ab\u9009\u4e3a\u4e3b\n        postgresql:                 # \u6d41\u590d\u5236\n          use_pg_rewind: true\n          use_slots: false          # \u9ed8\u8ba4true  \u4e3b\u4ece\u6570\u636e\u5e93wal\u4fdd\u7559\u7b56\u7565\n          parameters:                # \u4ee5\u4e0b\u4e3a\u8bbe\u7f6e\u6570\u636e\u5e93\u53c2\u6570\uff0c\u591a\u4e2a\u8282\u70b9\u914d\u7f6e\u7edf\u4e00 \n#           synchronous_standby_names: \"*\" # \u6d41\u590d\u5236 \u540c\u6b65\n#           synchronous_commit: \"on\"  # \u540c\u6b65\u7b49\u7ea7\n#           wal_level: hot_standby\n#           hot_standby: \"on\"\n#           wal_keep_segments: 8\n#           max_wal_senders: 10\n#           max_replication_slots: 10\n#           wal_log_hints: \"on\"\n#           archive_mode: \"on\"\n#           archive_timeout: 1800s\n#           archive_command: mkdir -p ../wal_archive &amp;&amp; test ! -f ../wal_archive/%f &amp;&amp; cp %p ../wal_archive/%f\n#        recovery_conf:\n#          restore_command: cp ../wal_archive/%f %p\n\n    initdb:                           #\u521d\u59cb\u5316\u6570\u636e\u5e93\n    - encoding: UTF8\n    - data-checksums\n\n    pg_hba:                           # \u6570\u636e\u5e93\u8bbf\u95ee\u9a8c\u8bc1\u914d\u7f6e\n    - host replication replicator 0.0.0.0/0 md5\n    - host all all 0.0.0.0/0 md5\n\n    users:                            #\u521d\u59cb\u5316\u6570\u636e\u5e93\u65f6\u521b\u5efa\u5e94\u7528\u7528\u6237\n        admin:\n            password: admin\n            options:\n                - createrole\n                - createdb\n\npostgresql:                           #\u6570\u636e\u5e93\u8bbe\u7f6e\n    listen: 0.0.0.0:5432\n    connect_address: 10.10.1.11:5432\n    data_dir: /var/lib/pgsql/13/data/\n    pgpass: /tmp/pgpass\n    authentication:\n        replication:\n            username: replicator\n            password: rep-pass\n        superuser:\n            username: postgres\n            password: secretpassword\n    parameters:\n        unix_socket_directories: '.'\n\ntags:\n    nofailover: false\n    noloadbalance: false\n    clonefrom: false\n    nosync: false\n\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_7","title":"\u670d\u52a1\u7ba1\u7406","text":"<p>cat /usr/lib/systemd/system/patroni.service </p> <pre><code>[Unit]\nDescription=Runners to orchestrate a high-availability PostgreSQL\nAfter=syslog.target network.target\n\n[Service]\nType=simple\n\nUser=postgres\nGroup=postgres\n\n# Note: avoid inserting whitespace in these Environment= lines, or you may\n# break postgresql-setup.\n\n# Location of database directory\nEnvironment=PATH=$PATH:/usr/pgsql-13/bin\n\n# Where to send early-startup messages from the server (before the logging\n# options of postgresql.conf take effect)\n# This is normally controlled by the global default set by systemd\n# StandardOutput=syslog\n\n# Disable OOM kill on the postmaster\nOOMScoreAdjust=-1000\nEnvironment=PG_OOM_ADJUST_FILE=/proc/self/oom_score_adj\nEnvironment=PG_OOM_ADJUST_VALUE=0\n\nExecStart=/usr/local/bin/patroni /etc/patroni.yml\nExecReload=/bin/kill -HUP $MAINPID\n\nKillMode=process\nKillMode=mixed\nKillSignal=SIGINT\n\n# Do not set any timeout value, so that systemd will not kill postmaster\n# during crash recovery.\nTimeoutSec=0\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u9a8c\u8bc1</p> <pre><code> sudo systemd-analyze verify patroni.service\n</code></pre> <p>\u542f\u52a8</p> <pre><code>systemctl start patroni\n</code></pre> <p>\u67e5\u770b\u542f\u52a8\u65e5\u5fd7</p> <pre><code>journalctl -u patroni.service -f -n 1000\n</code></pre> <p>\u67e5\u770bpatroni</p> <pre><code>#patronictl -c /etc/patroni.yml list\n+ Cluster: pg_cluster (6935229608238737808) ----+----+-----------+\n| Member      | Host       | Role   | State   | TL | Lag in MB |\n+-------------+------------+--------+---------+----+-----------+\n| postgresql0 | 10.10.1.11 | Leader | running |  2 |           |\n+-------------+------------+--------+---------+----+-----------+\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_8","title":"\u5176\u4ed6\u8282\u70b9\u91cd\u590d\u4ee5\u4e0a\u64cd\u4f5c, \u5728\u96c6\u7fa4\u4e2d\u52a0\u5165\u65b0\u8282\u70b9","text":"<p><code>\u6ce8\u610f\u4e8b\u9879</code> <code>patroni.yml \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u4e0d\u540c\u7684\u8282\u70b9\u9700\u8981\u4fee\u6539\u6210\u5bf9\u5e94\u8282\u70b9\u76f8\u7b26\u7684\u503c</code></p> <p><code>name: postgresql0</code></p> <p><code>IP\u5199\u6210\u8282\u70b9\u5bf9\u5e94\u7684IP</code></p> <pre><code>#patronictl -c /etc/patroni.yml list -e\n+ Cluster: pg_cluster (6935302809216505755) -----+----+-----------+-----------------+-------------------+------+\n| Member      | Host       | Role    | State   | TL | Lag in MB | Pending restart | Scheduled restart | Tags |\n+-------------+------------+---------+---------+----+-----------+-----------------+-------------------+------+\n| postgresql0 | 10.10.1.11 | Leader  | running | 14 |           |                 |                   |      |\n| postgresql2 | 10.10.1.12 | Replica | running | 14 |         0 |                 |                   |      |\n| postgresql3 | 10.10.1.13 | Replica | running | 14 |         0 |                 |                   |      |\n+-------------+------------+---------+---------+----+-----------+-----------------+-------------------+------+\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#patronipg","title":"patroni\u7ba1\u7406pg\u914d\u7f6e","text":"","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_9","title":"\u591a\u8282\u70b9\u7edf\u4e00\u914d\u7f6e","text":"<p>\u4ee5\u4e0b\u4fee\u6539\u540e\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u8282\u70b9\u90fd\u751f\u6548\uff0c\u5e76\u4e14\u4fdd\u6301\u4e00\u81f4\u3002</p> <pre><code>\u4fee\u6539\u96c6\u7fa4\u914d\u7f6e\n# patronictl -c /etc/patroni.yml edit-config\n\n</code></pre> <pre><code>\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e \n#patronictl -c /etc/patroni.yml show-config\n\nloop_wait: 10\nmaximum_lag_on_failover: 1048576\npostgresql:\n  parameters:\n    max_connections: 1000\n    synchronous_standby_names: '*'\n  use_pg_rewind: true\n  use_slots: false\nretry_timeout: 10\nttl: 30\n</code></pre> <pre><code>\u4fee\u6539\u540e\u5f85\u751f\u6548\n#patronictl -c /etc/patroni.yml list \n+ Cluster: pg_cluster (6935302809216505755) -----+----+-----------+-----------------+\n| Member      | Host       | Role    | State   | TL | Lag in MB | Pending restart |\n+-------------+------------+---------+---------+----+-----------+-----------------+\n| postgresql0 | 10.10.1.11 | Leader  | running | 14 |           | *               |\n| postgresql2 | 10.10.1.12 | Replica | running | 14 |         0 | *               |\n| postgresql3 | 10.10.1.13 | Replica | running | 14 |         0 | *               |\n+-------------+------------+---------+---------+----+-----------+-----------------+\n</code></pre> <pre><code>\u91cd\u542f\u96c6\u7fa4\u751f\u6548, \u53ef\u6307\u5b9a\u6267\u884c\u8ba1\u5212\u3002\u5b9a\u65f6\u81ea\u52a8\u6267\u884c\n#patronictl -c /etc/patroni.yml restart pg_cluster(\u96c6\u7fa4\u540d)\n</code></pre> <p>\u4ee5\u4e0a\u4fee\u6539\u7684\u6587\u4ef6\u4e3a postgres.conf</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_10","title":"\u5355\u8282\u70b9\u6570\u636e\u5e93\u914d\u7f6e","text":"<p>\u6709\u4e9b\u53c2\u6570\u53ea\u60f3\u5728\u7279\u5b9a\u8282\u70b9\u751f\u6548\uff0c\u914d\u7f6e\u65b9\u5f0f\u4e0e\u5355\u8282\u70b9\u6570\u636e\u5e93\u4e00\u81f4</p> <p>vi postgres.base.conf</p> <p>\u5bf9\u5e94\u8282\u70b9\u6267\u884c restart \u6216 reload \u751f\u6548</p> <pre><code>systemctl restart patroni \nsystemctl reload patroni \n</code></pre> <p>\u6216</p> <pre><code>#patronictl -c /etc/patroni.yml restart/reload pg_cluster(\u96c6\u7fa4\u540d) postgresql0(\u8282\u70b9\u540d) \n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#restfull-api","title":"\u5229\u7528RESTFULL API \u8fdb\u884c\u914d\u7f6e\u7ba1\u7406","text":"","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#swithover","title":"\u624b\u52a8swithover","text":"<p>\u8ba1\u5212\u5185\u8c03\u6574\u4e3b\u8282\u70b9\uff0c\u96c6\u7fa4\u62d3\u6251\u5173\u7cfb</p> <pre><code>\u5c06\u539f\u4e3bpostgresql0\u5207\u6362\u4e3apostgresql2\n#patronictl -c /etc/patroni.yml switchover\nMaster [postgresql0]: \nCandidate ['postgresql2', 'postgresql3'] []: postgresql2\nWhen should the switchover take place (e.g. 2021-03-04T08:50 )  [now]: \nCurrent cluster topology\n+ Cluster: postgres (6935302809216505755) -----+----+-----------+\n| Member      | Host       | Role    | State   | TL | Lag in MB |\n+-------------+------------+---------+---------+----+-----------+\n| postgresql0 | 10.10.1.11 | Leader  | running | 14 |           |\n| postgresql2 | 10.10.1.12 | Replica | running | 14 |         0 |\n| postgresql3 | 10.10.1.13 | Replica | running | 14 |         0 |\n+-------------+------------+---------+---------+----+-----------+\nAre you sure you want to switchover cluster postgres, demoting current master postgresql0? [y/N]: y\n2021-03-04 07:50:08.99426 Successfully switched over to \"postgresql2\"\n+ Cluster: postgres (6935302809216505755) -----+----+-----------+\n| Member      | Host       | Role    | State   | TL | Lag in MB |\n+-------------+------------+---------+---------+----+-----------+\n| postgresql0 | 10.10.1.11 | Replica | stopped |    |   unknown |\n| postgresql2 | 10.10.1.12 | Leader  | running | 14 |           |\n| postgresql3 | 10.10.1.13 | Replica | running | 14 |         0 |\n+-------------+------------+---------+---------+----+-----------+\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#failover","title":"\u81ea\u52a8failover","text":"<p>\u5f53\u96c6\u7fa4\u73af\u5883\u53d1\u751f\u5f02\u5e38\u72b6\u51b5\u65f6\uff0c\u96c6\u7fa4\u81ea\u52a8\u6240\u91c7\u53d6\u7684\u5bf9\u5e94\u63aa\u65bd\u3002</p> <p>\u66f4\u591a\u5f02\u5e38\u72b6\u51b5CASE\u53ef\u53c2\u8003\uff0c\u9ad8\u53ef\u7528\u96c6\u7fa4\u8bbe\u8ba1</p> <ul> <li>\u8282\u70b9\u65ad\u7f51\uff0c\u901a\u4fe1\u5931\u8d25\uff0c\u670d\u52a1\u4e0d\u505c</li> <li>\u8282\u70b9\u65ad\u7535\uff0c\u901a\u4fe1\u5931\u8d25\uff0c\u505c\u670d</li> <li>\u901a\u4fe1\u6210\u529f\uff0c\u670d\u52a1\u505c</li> <li>dcs \u5931\u6548, \u96c6\u7fa4\u53d8\u4e3a\u53ea\u8bfb</li> <li>\u5931\u8054\u8282\u70b9\u91cd\u65b0\u52a0\u5165\u96c6\u7fa4</li> </ul>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_11","title":"\u7ef4\u62a4\u6a21\u5f0f","text":"<p>\u7ef4\u62a4\u6a21\u5f0f\uff1a \u96c6\u7fa4\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002\u4f46\u96c6\u7fa4\u5173\u7cfb\u4e0d\u5728\u63a5\u53d7patroni\u7ba1\u7406\u3002\u6b64\u65f6\u7684\u96c6\u7fa4\u4e3a\u539f\u751f\u7684\u6d41\u590d\u5236\u3002</p> <p>\u4e3b\u52a8\u7ef4\u62a4\u6a21\u5f0f\uff1a \u96c6\u7fa4\u6b63\u5e38\u7684\u60c5\u51b5\u4e0b\u5f00\u542f\u7ef4\u62a4\u6a21\u5f0f, \u96c6\u7fa4\u4e0d\u5728\u62e5\u6709autofailover \u80fd\u529b,\u4ecd\u7136\u5177\u6709swithover\u529f\u80fd\u3002\u5f53DCS \u5931\u6548\u96c6\u7fa4\u4e0d\u53d7\u5f71\u54cd.</p> <pre><code># \u8fdb\u5165\u7ef4\u62a4\u6a21\u5f0f\npatronictl -c /etc/patroni.yml pause\nSuccess: cluster management is paused\n\n# \u9000\u51fa\u7ef4\u62a4\u6a21\u5f0f\npatronictl -c /etc/patroni.yml resume\nSuccess: cluster management is resumed\n\n# \u5f53\u524d\u72b6\u6001 \u662f\u5426\u4e3a\u7ef4\u62a4\u6a21\u5f0f\n1 \u53ef\u67e5\u770b\u5728DSC \u4e2d\u7684config\u4fe1\u606f\n2 API \u63a5\u53e3\u4fe1\u606f\n\npatronictl -c /etc/patroni/patroni.yaml show-config | grep pause\npause: true\n</code></pre> <p>\u88ab\u52a8\u7ef4\u62a4\u6a21\u5f0f\uff1a \u5f53DCS \u5931\u6548\u65f6\u96c6\u7fa4\u53d8\u4e3a\u53ea\u8bfb\u6a21\u5f0f</p> <p>\u5904\u7406\u65b9\u6cd5, \u589e\u52a0patroni\u4e0eDCS\u4e4b\u95f4\u7684\u8d85\u65f6\u65f6\u95f4\u3002\u5728\u6536\u5230DCS\u5f02\u5e38\u8b66\u544a\u540e\u7ed9\u81ea\u5df1\u5145\u5206\u7684\u65f6\u95f4\u6765\u5904\u7406\u3002 </p> <pre><code>retry_timeout: 86400 (\u4e00\u5929)\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_12","title":"\u5f39\u6027\u6269\u5bb9\u7f29\u5bb9","text":"<ul> <li>\u6269\u5bb9 :</li> </ul> <p>\u5c06patroni.yml \u62f7\u8d1d\u5230\u65b0\u8282\u70b9 \u4fee\u6539\u5bf9\u5e94\u7684\u5185\u5bb9\u540e \u542f\u52a8\u81ea\u52a8\u52a0\u5165\u96c6\u7fa4</p> <ul> <li>\u7f29\u5bb9 :</li> </ul> <p>\u5173\u95ed \u8282\u70b9patroni \u670d\u52a1\u81ea\u52a8\u9000\u51fa\u96c6\u7fa4</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_13","title":"\u5bf9\u5916\u63d0\u4f9b\u7edf\u4e00\u670d\u52a1","text":"<ul> <li>\u4e8c\u5c42 VIP vip-manager</li> <li>\u56db\u5c42 haproxy</li> <li>\u4e03\u5c42 DNS</li> </ul> <p>\u670d\u52a1\u53d1\u73b0\u53c2\u8003\u4e0b\u9762\u7684 restfullapi</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#restfullapi","title":"RestFullAPI","text":"<pre><code>-- \u8bfb\u53d6\u914d\u7f6e\u6587\u4ef6\n# curl -s http://10.10.1.11:8008/config | jq .\n{\n  \"loop_wait\": 10,\n  \"maximum_lag_on_failover\": 1048576,\n  \"postgresql\": {\n    \"parameters\": {\n      \"max_connections\": 1001,\n      \"synchronous_standby_names\": \"*\"\n    },\n    \"use_pg_rewind\": true,\n    \"use_slots\": false\n  },\n  \"retry_timeout\": 10,\n  \"ttl\": 30\n}\n-- \u8bfb\u53d6\u96c6\u7fa4\u4fe1\u606f\ncurl -s http://10.10.1.11:8008/cluster | jq .\n{\n  \"members\": [\n    {\n      \"name\": \"postgresql0\",\n      \"role\": \"leader\",\n      \"state\": \"running\",\n      \"api_url\": \"http://10.10.1.11:8008/patroni\",\n      \"host\": \"10.10.1.11\",\n      \"port\": 5432,\n      \"timeline\": 16\n    },\n    {\n      \"name\": \"postgresql2\",\n      \"role\": \"replica\",\n      \"state\": \"running\",\n      \"api_url\": \"http://10.10.1.12:8008/patroni\",\n      \"host\": \"10.10.1.12\",\n      \"port\": 5432,\n      \"timeline\": 16,\n      \"lag\": 0\n    },\n    {\n      \"name\": \"postgresql3\",\n      \"role\": \"replica\",\n      \"state\": \"running\",\n      \"api_url\": \"http://10.10.1.13:8008/patroni\",\n      \"host\": \"10.10.1.13\",\n      \"port\": 5432,\n      \"timeline\": 16,\n      \"lag\": 0\n    }\n  ]\n}\n-- \u83b7\u53d6\u8282\u70b9\u89d2\u8272\u4fe1\u606f\ncurl -s http://10.10.1.12:8008/health | jq .role\n\"replica\"\n\ncurl -s http://10.10.1.11:8008/health | jq .role\n\"master\"\n\n-- \u6839\u636eresponse code status\n\u4e3b\u8282\u70b9 200 , \u4ece\u8282\u70b9503 \ncurl -si http://10.10.1.13:8008/master\n\u4ece\u8282\u70b9 200 ,\u4e3b\u8282\u70b9503\ncurl -si http://10.10.1.13:8008/replica\n\n</code></pre>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_14","title":"\u5907\u4efd\u6062\u590d","text":"<ul> <li> <p>etcd \u5907\u4efd\u6062\u590d</p> </li> <li> <p>patroni \u8282\u70b9\u5173\u95ed\u540e\u5220\u9664etcd\u6570\u636e \uff0c\u91cd\u65b0\u542f\u52a8\u540e\u6570\u636e\u518d\u6b21\u751f\u6210</p> </li> <li> <p>\u6b63\u5728\u8fd0\u884c\u7684\u96c6\u7fa4\u5220\u9664etcd\u6570\u636e , \u6570\u636e\u518d\u6b21\u81ea\u52a8\u751f\u6210\u3002</p> </li> <li> <p>pg \u5907\u4efd\u6062\u590d</p> </li> <li> <p>\u5168\u91cf\u5907\u4efd</p> </li> <li>wal \u5907\u4efd</li> </ul> <p>\u5b98\u65b9\u65b9\u6848 wal-e</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_15","title":"\u76d1\u63a7","text":"<ul> <li>patroni_exporter </li> <li>etcd_exporter</li> <li>postgres_exporter</li> </ul>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_16","title":"\u65e5\u5fd7","text":"<ul> <li>FLK</li> </ul>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni/#_17","title":"\u5347\u7ea7","text":"<p>[\u53c2\u8003]</p> <p>https://www.cnblogs.com/zhangeamon/p/9772118.html</p> <p>https://www.linode.com/docs/databases/postgresql/create-a-highly-available-postgresql-cluster-using-patroni-and-haproxy</p> <p>ansible \u7ba1\u7406</p> <p>\u5b9e\u8df5</p>","tags":["\u9ad8\u53ef\u7528"]},{"location":"postgres/ha/patroni02/","title":"Patroni \u9ad8\u53ef\u7528\u7ba1\u7406\u8fdb\u9636","text":""},{"location":"postgres/ha/patroni02/#_1","title":"\u5b8c\u6210\u76ee\u6807","text":"<ul> <li>\u4e3b\u4ece\u540c\u6b65\u7b56\u7565</li> <li>\u5f02\u5730\u591a\u673a\u623f\u7b56\u7565</li> <li>failover \u89e6\u53d1\u8be6\u60c5</li> <li>\u8bbf\u95ee\u8ba4\u8bc1</li> <li>watch-dog</li> <li>\u914d\u7f6e\u6587\u4ef6\u8be6\u60c5</li> <li>fencing</li> <li>DCS \u5931\u6548\u5904\u7406</li> <li>\u52a0\u5165\u8282\u70b9\u590d\u5236\u6570\u636e\u9650\u6d41</li> <li>\u4e3b\u4ece\u5207\u6362\u6d41\u91cf,\u907f\u514d\u91cd\u65b0\u62c9\u53d6</li> <li>\u7ea7\u8054\u590d\u5236</li> <li>callback</li> <li>\u65e5\u5fd7&amp;\u76d1\u63a7</li> </ul>"},{"location":"postgres/ha/patroni02/#_2","title":"\u4e3b\u4ece\u540c\u6b65\u7b56\u7565","text":"<p>\u6570\u636e\u5e93\u4e3b\u4ece\u4e4b\u95f4\u540c\u6b65\u7c7b\u578b</p> <pre><code>Synchronous state of this standby server. Possible values are:\nasync: This standby server is asynchronous.\npotential: This standby server is now asynchronous, but can potentially become synchronous if one of current synchronous ones fails.\nsync: This standby server is synchronous.\nquorum: This standby server is considered as a candidate for quorum standbys.\n</code></pre> <p>\u6570\u636e\u5e93\u7ea7\u540c\u6b65\u914d\u7f6e</p> <pre><code>synchronous_standby_names: '*'\nsynchronous_commit = on \n</code></pre> <p>patroni\u540c\u6b65\u7ba1\u7406</p> <pre><code>patronictl edit-config -s 'synchronous_mode=true'\u52a0\u5165\u8282\u70b9\u590d\u5236\u6570\u636e\u9650\u6d41\npatronictl edit-config -s 'synchronous_mode_strict:true'\n\n\u53c2\u6570\u8bf4\u660e:\n\nsynchronous_mode = true , \n\n\u4e3a\u540c\u6b65\u6a21\u5f0f\uff0c\u53ea\u6709\u4e00\u4e2a\u4ece\u8282\u70b9\u4e3async\u3002\u5728failover\u65f6sync\u8282\u70b9\u624d\u6709\u8d44\u683c\u9009\u4e3a\u65b0\u4e3b\u3002\n\u4e0e\u539f\u6765\u7684pg\u540c\u6b65\u4e0d\u540c\uff0c\u539fpg\u670d\u52a1\u5f53\u6240\u6709\u7684\u4ece\u8282\u70b9\u4e0d\u53ef\u7528\u65f6\u5199\u64cd\u4f5c\u5c06\u4f1a\u88ab\u5835\u585e\u3002\n\u7531patroni \u7ba1\u7406\u7684pg \u8bbe\u7f6e\u4e3asynchronous_mode = true \uff0c\u5f53\u540c\u6b65\u4ece\u5e93\u4e0d\u53ef\u7528\u65f6\u4e3b\u5e93\u53d1\u751f\u964d\u7ea7\u3002\u4e0d\u4f1a\u5f71\u54cd\u4e1a\u52a1\u5199\u64cd\u4f5c\u3002\n\nsynchronous_mode_strict:true\n\u5982\u679c\u4e0d\u60f3\u53d1\u751f\u4e3b\u5e93\u964d\u7ea7\uff0c\u8bbe\u7f6e\u6b64\u53c2\u6570\u3002\u6570\u636e\u5b89\u5168\u6027\u4f1a\u66f4\u9ad8\u3002\u5efa\u8bae\u4e00\u4e3b\u591a\u4ece\u3002\n\n</code></pre> <pre><code>patronictl edit-config -s 'synchronous_mode=true'\npatronictl -c /etc/patroni.yml list\n+ Cluster: postgres (6935302809216505755) +---------+----+-----------+------------------+\n| Member      | Host       | Role         | State   | TL | Lag in MB | Tags             |\n+-------------+------------+--------------+---------+----+-----------+------------------+\n| postgresql0 | 10.10.1.11 | Replica      | running | 31 |         0 | nofailover: true |\n|             |            |              |         |    |           | nosync: true     |\n+-------------+------------+--------------+---------+----+-----------+------------------+\n| postgresql2 | 10.10.1.12 | Sync Standby | running | 31 |         0 |                  |\n+-------------+------------+--------------+---------+----+-----------+------------------+\n| postgresql3 | 10.10.1.13 | Leader       | running | 31 |           |                  |\n+-------------+------------+--------------+---------+----+-----------+------------------+\n</code></pre>"},{"location":"postgres/ha/patroni02/#_3","title":"\u5f02\u5730\u591a\u673a\u623f\u7b56\u7565","text":"<p>A. \u5f53\u5f02\u5730\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u8282\u70b9\u65f6\u3002</p> <ul> <li>\u5907\u7528\u673a\u623f\u8282\u70b9\u5728failover\u65f6\u4e0d\u80fd\u9009\u505a\u4e3b</li> <li>\u5907\u7528\u673a\u623f\u8282\u70b9\u4e3b\u4ece\u590d\u5236\u91c7\u7528\u5f02\u6b65\u65b9\u5f0f</li> </ul> <p>\u5b9e\u73b0\u65b9\u6cd5\uff1a \u5728yml \u4e2d\u7684tag\u914d\u7f6e\u5982\u4e0b</p> <pre><code>tags: \n  nofailover: true # failover \u65f6\u4e0d\u80fd\u9009\u4e3a\u4e3b\u8282\u70b9\n  nosync: true # \u5f02\u6b65\n</code></pre> <pre><code>patronictl -c /etc/patroni.yml list\n+ Cluster: postgres (6935302809216505755) -----+----+-----------+------------------+\n| Member      | Host       | Role    | State   | TL | Lag in MB | Tags             |\n+-------------+------------+---------+---------+----+-----------+------------------+\n| postgresql0 | 10.10.1.11 | Replica | running | 20 |         0 | nofailover: true |\n|             |            |         |         |    |           | nosync: true     |\n+-------------+------------+---------+---------+----+-----------+------------------+\n| postgresql2 | 10.10.1.12 | Replica | running | 20 |         0 |                  |\n+-------------+------------+---------+---------+----+-----------+------------------+\n| postgresql3 | 10.10.1.13 | Leader  | running | 20 |           |                  |\n+-------------+------------+---------+---------+----+-----------+------------------+\n</code></pre> <p>B. \u5f53\u5f02\u5730\u8282\u70b9\u4e3a\u591a\u4e2a\u8282\u70b9\u65f6</p> <p>\u5982\u679c\u591a\u4e2a\u8282\u70b9\u90fd\u4ece\u4e3b\u8282\u70b9\u673a\u623f\u540c\u6b65</p> <p>1 \u673a\u623f\u95f4\u5e26\u5bbd</p> <p>2 \u673a\u623f\u95f4\u7f51\u7edc\u5ef6\u8fdf</p> <p>\u66f4\u5408\u7406\u7684\u7ed3\u6784\u62d3\u6251\u5e94\u8be5\u91c7\u7528\u6570\u636e\u5e93\u7ea7\u8054\u590d\u5236\u6a21\u5f0f</p> <p>Standby cluster</p>"},{"location":"postgres/ha/patroni02/#_4","title":"\u8bbf\u95ee\u8ba4\u8bc1","text":"<ul> <li>DSC \u8bbf\u95ee\u8ba4\u8bc1\u7ba1\u7406</li> </ul> <p>DSC \u4f5c\u4e3a\u96c6\u7fa4\u7684\u914d\u7f6e\u7ba1\u7406\u4e2d\u5fc3\uff0c\u867d\u7136\u4e0d\u5b58\u50a8\u4e1a\u52a1\u6570\u636e\uff0c\u4f46\u662f\u5b89\u5168\u6027\u4e5f\u662f\u81f3\u5173\u91cd\u8981\u3002</p> <pre><code>etcd \n  username: 'user'\n  password: 'pwd'\n</code></pre> <ul> <li>API \u8bbf\u95ee\u8ba4\u8bc1</li> </ul> <p>\u7528\u4e8epatroni\u53ef\u901a\u8fc7API \u8bbf\u95ee\u6765\u8fdb\u884c\u7ba1\u7406\uff0c\u5c06\u7aef\u53e3\u66b4\u9732\u51fa\u6765\u4e0d\u52a0\u9632\u62a4\u65e0\u7591\u662f\u5c06\u7ba1\u7406\u6743\u62f1\u624b\u76f8\u8ba9\u3002</p>"},{"location":"postgres/ha/patroni02/#watch-dog","title":"watch-dog","text":"<p>\u57fa\u672c\u539f\u7406\uff1a \u5f53patroni\u542f\u52a8\u540e\u4f1a\u4e0d\u505c\u7684\u5411watch-dog\u53d1\u9001\u5fc3\u8df3\u3002\u5f53watch dog\u8d85\u8fc7\u4e00\u5b9a\u65f6\u95f4\u95f4\u9694\u6ca1\u6709\u6536\u5230\u5fc3\u8df3\u5219\u8ba4\u4e3apatroni\u8fdb\u7a0b\u53d1\u751f\u610f\u5916\uff0cwatch dog\u91cd\u65b0\u7cfb\u7edf\u3002</p> <p>\u57fa\u672c\u914d\u7f6e\uff1a </p> <pre><code>\u5b89\u88c5watchdog\nyum install watchdog -y\nsystemctl start watchdog\n</code></pre> <p>patroni.service</p> <pre><code>ExecStartPre=-/usr/bin/sudo /sbin/modprobe softdog\nExecStartPre=-/usr/bin/sudo /bin/chown postgres /dev/watchdog\n</code></pre> <p>patroni.yml</p> <pre><code>watchdog:\n  mode: automatic # Allowed values: off, automatic, required\n  device: /dev/watchdog\n  safety_margin: 5\n</code></pre>"},{"location":"postgres/ha/patroni02/#fencing","title":"fencing","text":"<p>\u907f\u514d\u53cc\u4e3b\u95ee\u9898</p> <p>patroni \u5728\u4e3b\u8282\u70b9\u7f51\u7edc\u4e0edcs\u4e0d\u901a\u4fe1\u53d1\u751f\u6545\u969c\u65f6\u4f1a\u964d\u7ea7\u4e3a\u53ea\u8bfb\u3002\u4f46\u53ef\u80fd\u5b58\u5728\u4e00\u4e2a\u5fc3\u8df3\u5468\u671f\u7684\u53cc\u4e3b\u3002</p> <p>\u66f4\u4e25\u683c\u7684\u65b9\u5f0f\u662f\u91c7\u7528pg\u7684\u540c\u6b65\u6a21\u5f0f\uff0c\u5f53\u4e3b\u8282\u70b9\u53d1\u73b0\u65e0\u4efb\u4f55\u53ef\u7528\u7684\u4ece\u5e93\u65f6\u5199\u64cd\u4f5c\u88abhang\u4f4f\u3002</p> <pre><code>patronictl edit-config -s 'synchronous_mode=true'\npatronictl edit-config -s 'synchronous_mode_strict:true'\n</code></pre> <p>\u5f53\u96c6\u7fa4\u662f\u4e00\u4e3b\u591a\u4ece\uff0c\u6bd4\u5982\u4e00\u4e3b4\u4ece\u3002\u53ef\u80fd\u53d1\u751f2\u8282\u70b9\u4e4b\u95f4\u4e92\u901a\uff0c \u53e6\u59163\u8282\u70b9\u4e4b\u95f4\u4e92\u901a\u7684\u60c5\u51b5\u3002</p> <p>pg \u5b9e\u73b0\u8bf7\u81ea\u884c\u7ed3\u5408 pg 'quorum' \u53c2\u6570\u8fdb\u884c\u8003\u91cf\u3002\u5177\u4f53\u7ed3\u5408\u4e1a\u52a1\u6570\u636e\u5b89\u5168\u7b49\u7ea7\u8981\u6c42\u3002 </p> <p>patroni </p> <pre><code>synchronous_node_count = 1 # default 1\n</code></pre>"},{"location":"postgres/ha/patroni02/#dcs","title":"dcs\u5931\u6548\u5904\u7406","text":"<p>\u9996\u5148\u5f53DCS\u5931\u6548\u540e\u96c6\u7fa4\u7684\u53cd\u5e94\uff1a</p> <p>\u96c6\u7fa4\u53d8\u4e3a\u53ea\u8bfb\u6a21\u5f0f\uff0c\u539f\u6765\u96c6\u7fa4\u4e2d\u7684\u6240\u6709pg\u670d\u52a1\u90fd\u53d8\u4e3a\u53ea\u8bfb\u3002\u4e3b\u8282\u70b9pg\u4e5f\u88ab\u964d\u7ea7\u4e3a\u53ea\u8bfb\u3002</p> <p>\u53d1\u751f\u4e0a\u8ff0\u73b0\u5728\u4e3b\u8981\u662fpatroni\u7684failover\u673a\u5236\u3002 </p> <ul> <li>\u4e3b\u52a8\u65b9\u5f0f\uff0cdcs\u5931\u6548\u540e\u5bf9\u73b0\u6709\u96c6\u7fa4\u4e0d\u9020\u6210\u5f71\u54cd\u3002\u540c\u65f6\u4e5f\u5931\u53bb\u4e86failover\u80fd\u529b\u3002 </li> </ul> <p>\u601d\u8def failover \u5173\u95ed\u6216\u5ef6\u957f\u751f\u6548</p> <pre><code>\u65b9\u6cd5\u4e00 \uff1a \u5173\u95ed\u96c6\u7fa4\u7684failover\n patronictl -c /etc/patroni.yml pause\n</code></pre> <pre><code>\u65b9\u6cd5\u4e8c \uff1a \nretry_timeout: timeout for DCS and PostgreSQL operation retries (in seconds). DCS or network issues shorter than this will not cause Patroni to demote the leader. Default value: 10\n\u5c06\u8fd9\u4e2a\u53c2\u6570\u7684\u503c\u8bbe\u7f6e\u5927\u4e00\u4e9b\uff0c\u6bd4\u5982\u4e00\u5929\u3002\n</code></pre> <ul> <li>\u88ab\u52a8\u65b9\u5f0f\uff0cDSC\u5df2\u7ecf\u5931\u6548\u5e76\u4e14\u77ed\u65f6\u95f4\u5185\u4e0d\u80fd\u4fee\u590d\u3002\u5df2\u5bf9\u73b0\u6709\u751f\u4ea7\u9020\u6210\u5f71\u54cd\u7684\u7d27\u6025\u5904\u7406\u65b9\u5f0f\u3002</li> </ul> <p>\u601d\u8def pg \u8131\u79bbpatroi \u7684\u7ba1\u7406\uff0c\u91c7\u7528\u81ea\u8eab\u6d41\u590d\u5236</p> <p>\u5177\u4f53\u65b9\u6cd5 </p>"},{"location":"postgres/ha/patroni02/#_5","title":"\u52a0\u5165\u8282\u70b9\u590d\u5236\u6570\u636e\u9650\u6d41","text":"<p>pg \u6d41\u590d\u5236\u65b0\u52a0\u5165\u8282\u70b9\u9650\u6d41 </p> <pre><code>pg_basebackup -r\n</code></pre> <p>\u9009\u62e9\u4ece\u54ea\u4e2a\u8282\u70b9\u62c9\u53d6\u5b8c\u6574\u5907\u4efd</p> <pre><code>tags.clonefrom\n</code></pre>"},{"location":"postgres/ha/patroni02/#_6","title":"\u907f\u514d\u91cd\u65b0\u62c9\u53d6","text":"<pre><code>pg_rewind\n</code></pre>"},{"location":"postgres/ha/patroni02/#_7","title":"\u7ea7\u8054\u590d\u5236","text":"<pre><code>tags.replicatefrom: name  \n</code></pre> <p>\u6d4b\u8bd5\u7ed3\u679c\u5199IP\u4e0d\u751f\u6548\uff0c\u5199name\u53ef\u4ee5</p> <p>https://zhuanlan.zhihu.com/p/260958352</p>"},{"location":"postgres/ha/pgautofailover/","title":"pg_auto_failover \u5b9e\u8df5","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_1","title":"\u4e00\u4e2a\u7b80\u5355\u7684\u67b6\u6784","text":"<p>citus\u540c\u6e90postgres\u9ad8\u53ef\u7528\u65b9\u6848</p> <p>\u89d2\u8272:</p> <ul> <li>\u4e3b\u8282\u70b9 (master)</li> <li>\u590d\u5236\u8282\u70b9 (slave)</li> <li>\u76d1\u63a7\u8282\u70b9 (monitor)</li> </ul>","tags":[]},{"location":"postgres/ha/pgautofailover/#_2","title":"\u96c6\u7fa4\u642d\u5efa","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_3","title":"\u73af\u5883\u8bf4\u660e","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_4","title":"\u8f6f\u4ef6\u7248\u672c","text":"<ul> <li>postgresql 14.4</li> <li>pg_auto_failover 1.6.4</li> <li>centos 7</li> </ul>","tags":[]},{"location":"postgres/ha/pgautofailover/#_5","title":"\u7f51\u7edc\u73af\u5883","text":"IP \u8f6f\u4ef6 10.10.2.11 monitor 10.10.2.12 master 10.10.2.13 replication","tags":[]},{"location":"postgres/ha/pgautofailover/#_6","title":"\u4ece\u96f6\u5f00\u59cb\u5efa\u8bbe","text":"<p>\u200b   \u6ca1\u6709\u4efb\u4f55\u5386\u53f2\u5305\u88b1\uff0c\u5305\u62ec\u6570\u636e\u5e93\u81ea\u8eab\u7684\u642d\u5efa</p> <p>\u200b   \u624b\u52a8\u5b89\u88c5</p> <p>\u200b     \u5728\u6240\u6709\u7684\u8282\u70b9\u4e0a\u6267\u884c</p> <pre><code>-- \u6570\u636e\u5e93\u5b89\u88c5\nsudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm\nsudo yum install -y postgresql14-server\n</code></pre> <pre><code># install pg_auto_failover\ncurl https://install.citusdata.com/community/rpm.sh | sudo bash\nyum install pg_auto_failover_14.x86_64 -y\n\n# confirm installation\n/usr/pgsql-14/bin/pg_autoctl --version\n</code></pre> <p>\u200b     \u521b\u5efamonitor\u8282\u70b9</p> <pre><code>--\u521b\u5efa\u76d1\u63a7\u8282\u70b9\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl create monitor \\\n   --hostname node0 \\\n   --auth trust \\\n   --ssl-self-signed \\\n   --pgdata /var/lib/pgsql/14/data/ \\\n   --pgctl /usr/pgsql-14/bin/pg_ctl \"\n\n--\u542f\u52a8\u76d1\u63a7\u8282\u70b9\u670d\u52a1\n/usr/pgsql-14/bin/pg_autoctl -q show systemd --pgdata \"/var/lib/pgsql/14/data\" | tee /etc/systemd/system/pgautofailover.service\n\nsystemctl start pgautofailover\n\n-- \u67e5\u770bnode\u8fde\u63a5monitor \u4fe1\u606f\n/usr/pgsql-14/bin/pg_autoctl show uri --formation monitor --pgdata /var/lib/pgsql/14/data/\n\npostgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require\n\n</code></pre> <p>\u200b       \u521b\u5efa\u6570\u636e\u5e93\u4e3b\u8282\u70b9</p> <pre><code>-- \u521b\u5efa\u6570\u636e\u5e93\u8282\u70b9\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl create postgres \\\n    --hostname node1 \\\n    --name node1 \\\n    --pgctl /usr/pgsql-14/bin/pg_ctl \\\n    --pgdata /var/lib/pgsql/14/data/ \\\n    --auth trust \\\n    --ssl-self-signed \\\n    --monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require' \\\n    \"\n\n</code></pre> <pre><code>\u521b\u5efa\u8282\u70b9\u8bf4\u660e\uff0c\u5728create postgres\u540e\uff0c\u5c06\u5728\u672c\u5730\u751f\u6210\u914d\u7f6e\u4fe1\u606f\u3002\u5177\u4f53\u53ef\u67e5\u770b\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl show file   --pgdata /var/lib/pgsql/14/data/\"\n</code></pre> <pre><code>-- systemd \u7ba1\u7406\u670d\u52a1\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl -q show systemd --pgdata /var/lib/pgsql/14/data \"  &gt; /etc/systemd/system/pgautofailover.service\n\n-- \u542f\u52a8\u670d\u52a1\nsystemctl start pgautofailover\n</code></pre> <p>\u200b       \u521b\u5efa\u6570\u636e\u5e93\u4ece\u8282\u70b9</p> <pre><code>-- \u5728\u53e6\u4e00\u4e2a\u8282\u70b9\u521b\u5efa\u4ece\u5e93\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl create postgres \\\n    --hostname node2 \\\n    --name node2 \\\n    --pgctl /usr/pgsql-14/bin/pg_ctl \\\n    --pgdata /var/lib/pgsql/14/data/ \\\n    --auth trust \\\n    --ssl-self-signed \\\n    --monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require' \\\n    \"\n</code></pre> <pre><code>-- systemd \u7ba1\u7406\u670d\u52a1\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl -q show systemd --pgdata /var/lib/pgsql/14/data \"  &gt; /etc/systemd/system/pgautofailover.service\n\n-- \u542f\u52a8\u670d\u52a1\nsystem start pgautofailover\n</code></pre> <pre><code>-- \u5728monitor\u8282\u70b9\u67e5\u770b\u72b6\u6001\n/usr/pgsql-14/bin/pg_autoctl   show state --pgdata /var/lib/pgsql/14/data/\n\n  Name |  Node |  Host:Port |       TLI: LSN |   Connection |      Reported State |      Assigned State\n-------+-------+------------+----------------+--------------+---------------------+--------------------\nnode1 |     1 | node1:5432 |   1: 0/500BD90 |   read-write |             primary |             primary\n node2 |   111 | node2:5432 |   1: 0/500BD90 |    read-only |           secondary |           secondary\n\n</code></pre> <pre><code>-- \u5728\u76d1\u63a7\u70b9\u5220\u9664postgres\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl drop node  --destroy --force --name node2 \"\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#_7","title":"\u73b0\u6709\u6570\u636e\u5e93\u63a5\u7ba1","text":"<p>\u200b   \u4e0d\u5f71\u54cd\u73b0\u6709\u6570\u636e\u5e93\u4e1a\u52a1\uff0c\u4f7f\u5176\u5177\u6709\u9ad8\u53ef\u7528\u80fd\u529b</p> <p>\u200b    \u4e0e\u4ece\u96f6\u5f00\u59cb\u521b\u5efa\u96c6\u7fa4\u4e0d\u540c\u7684\u662f\uff0c\u5728create postgres\u9636\u6bb5\uff0c\u6839\u636e    --pgdata \u76ee\u5f55\u6240\u6307\u5b9a\u7684 pg_controldata \u6765\u5224\u65ad\u6570\u636e\u5e93\u6570   \u636e\u76ee\u5f55\u73b0\u6709\u60c5\u51b5\u3002\u5305\u62ec\u662f\u5426\u9700\u8981\u521d\u59cb\u5316\u6570\u636e\u5e93\uff0c\u53ca\u73b0\u6709\u6570\u636e\u5e93\u72b6\u6001 </p>","tags":[]},{"location":"postgres/ha/pgautofailover/#_8","title":"\u96c6\u7fa4\u7ba1\u7406","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_9","title":"\u72b6\u6001\u67e5\u770b","text":"<pre><code>/usr/pgsql-14/bin/pg_autoctl   show state --pgdata /var/lib/pgsql/14/data/\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#switch","title":"\u624b\u52a8switch","text":"<pre><code>/usr/pgsql-14/bin/pg_autoctl  perform switchover --formation default --group 0  --pgdata /var/lib/pgsql/14/data/\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#failover","title":"\u81ea\u52a8failover","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_10","title":"\u8282\u70b9\u5931\u8d25","text":"<pre><code>- \u4e3b\u8282\u70b9\u5931\u8d25\n  When the primary node is unhealthy, and only when the secondary node is itself in good health, then the primary node is asked to transition to the DRAINING state, and the attached secondary is asked to transition to the state PREPARE_PROMOTION. In this state, the secondary is asked to catch-up with the WAL traffic from the primary, and then report success.\n\nThe monitor then continues orchestrating the promotion of the standby: it stops the primary (implementing STONITH in order to prevent any data loss), and promotes the secondary into being a primary now.\n\nDepending on the exact situation that triggered the primary unhealthy, it\u2019s possible that the secondary fails to catch-up with WAL from it, in that case after the PREPARE_PROMOTION_CATCHUP_TIMEOUT the standby reports success anyway, and the failover sequence continues from the monitor.\n\nWhen the keeper reports an acceptable WAL difference in the two nodes again, then the replication is upgraded back to being synchronous. While a secondary node is not in the SECONDARY state, secondary promotion is disabled.\n\u4e3b\u673a\u6062\u590d\u540e\u91cd\u65b0\u52a0\u5165\u96c6\u7fa4\u4e2d\uff0c\u5e76\u4e14\u72b6\u6001\u4e3asecondary\n</code></pre> <pre><code>- \u5907\u8282\u70b9\u5931\u8d25\nWhen the secondary node is unhealthy, the monitor assigns to it the state CATCHINGUP, and assigns the state WAIT_PRIMARY to the primary node. When implementing the transition from PRIMARY to WAIT_PRIMARY, the keeper disables synchronous replication.\n</code></pre> <pre><code>- \u76d1\u63a7\u8282\u70b9\u5931\u8d25\nThen the primary and secondary node just work as if you didn\u2019t have setup pg_auto_failover in the first place, as the keeper fails to report local state from the nodes. Also, health checks are not performed. It means that no automated failover may happen, even if needed.\n</code></pre> <p>\u5c3d\u91cf\u907f\u514d\u76d1\u63a7\u8282\u70b9\u4e0e\u4e3b\u8282\u70b9\u540c\u65f6\u5931\u8d25\u7684\u60c5\u51b5\uff0c\u5982\u907f\u514d\u540c\u673a\u67b6\uff0c\u540c\u673a\u623f\uff0c\u540c\u4e00\u4e2a\u7f51\u7edc\u5206\u533a\u3002</p>","tags":[]},{"location":"postgres/ha/pgautofailover/#_11","title":"\u7f51\u7edc\u95ee\u9898","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_12","title":"\u7ef4\u62a4\u6a21\u5f0f","text":"<pre><code>$ pg_autoctl enable maintenance\n$ pg_autoctl disable maintenance\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#_13","title":"\u589e\u51cf\u8282\u70b9","text":"<p>\u200b   \u6dfb\u52a0\u6570\u636e\u5e93\u8282\u70b9</p> <p>\u200b        \u4e0e\u524d\u9762\u52a0\u5165\u4ece\u8282\u70b9\u4e00\u81f4</p> <p>\u200b     \u5220\u9664\u6570\u636e\u5e93\u8282\u70b9</p> <pre><code>-- \u5728\u76d1\u63a7\u70b9\u5220\u9664postgres\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl drop node  --destroy --force --name node3 --formation formation_name_003\"\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#_14","title":"\u5207\u6362\u7b56\u7565\u673a\u5236","text":"<pre><code> pgautofailover.health_check_max_retries | 2\n pgautofailover.health_check_period      | 20000\n pgautofailover.health_check_retry_delay | 2000\n pgautofailover.health_check_timeout     | 5000\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#_15","title":"\u591a\u96c6\u7fa4\u7ba1\u7406","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#_16","title":"\u591a\u96c6\u7fa4\u7ba1\u7406\u8bf4\u660e","text":"<p>\u200b   \u591a\u96c6\u7fa4\u8fd9\u91cc\u7684\u542b\u4e49\u662f\u4e00\u4e2amonitor\u7ba1\u7406\u591a\u5957\u96c6\u7fa4</p> <p>\u200b   \u4e3b\u8981\u7528\u5230\u7684\u4e24\u4e2a\u6982\u5ff5</p> <ul> <li> <p>formation</p> </li> <li> <p>group</p> </li> </ul> <p>A formation is a logical set of PostgreSQL services that are managed together.</p> <p>It is possible to operate many formations with a single monitor instance. Each formation has a group of Postgres nodes and the FSM orchestration implemented by the monitor applies separately to each group.</p> <p>\u901a\u8fc7\u8bf4\u660e\u53ef\u4ee5\u77e5\u9053\uff0c\u5229\u7528formation\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2amonitor\u7ba1\u7406\u591a\u5957\u96c6\u7fa4\u3002</p> <p>A group consists of a PostgreSQL primary server and a secondary server setup with Hot Standby synchronous replication.</p> <p>The notion of a formation that contains multiple groups in pg_auto_failover is useful when setting up and managing a whole Citus formation, where the coordinator nodes belong to group zero of the formation, and each Citus worker node becomes its own group and may have Postgres standby nodes.</p> <p>\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e2a\u601d\u8def\uff0c\u4e00\u5957citus\u96c6\u7fa4\u5728\u4e00\u4e2aformation\u4e4b\u4e0b\uff0ccitus\u4e2d\u7684\u591a\u4e2a\u4e3b\u4ece\u8282\u70b9\u901a\u8fc7group\u6765\u533a\u5206\u3002</p>","tags":[]},{"location":"postgres/ha/pgautofailover/#_17","title":"\u5177\u4f53\u5b9e\u73b0\u6848\u4f8b","text":"","tags":[]},{"location":"postgres/ha/pgautofailover/#formation","title":"\u5229\u7528formation \u7ba1\u7406\u591a\u5957\u96c6\u7fa4","text":"<pre><code>-- \u521b\u5efaformation , \u9ed8\u8ba4\u4f7f\u7528default\n/usr/pgsql-14/bin/pg_autoctl create formation \\\n --pgdata /var/lib/pgsql/14/data/ \\\n --monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover1?sslmode=require' \\\n --formation formation_name_003 \\\n --kind pgsql \\\n --dbname pg_auto_failover\n</code></pre> <pre><code>--\u67e5\u770b formation \u4fe1\u606f\nselect * from pgautofailover.formation ;\n    formationid     | kind  |      dbname       | opt_secondary | number_sync_standbys \n--------------------+-------+-------------------+---------------+----------------------\n default            | pgsql | postgres          | t             |                    0\n formation_name_003 | pgsql | postgres          | t             |                    0\n(2 rows)\n</code></pre> <pre><code>-- \u5728\u521b\u5efa\u6570\u636e\u5e93\u8282\u70b9\u65f6\u6307\u5b9aformation\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl create postgres \\\n--hostname node3 \\\n--formation formation_name_003 \\\n--name node3 \\\n--pgctl /usr/pgsql-14/bin/pg_ctl \\\n--pgdata /var/lib/pgsql/14/data/ \\\n--auth trust \\\n--ssl-self-signed \\\n--monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require' \\ \n\"\n\n\u6ce8\u610f\u4e8b\u9879: \n--hostname \u672c\u673ahost\uff0c\n--formation \u4e0a\u9762\u521b\u5efa\u7684formation ,\n--name\u8282\u70b9\u540d\u79f0 ,\n--monitor monitor\u8282\u70b9\u8fde\u63a5\u4fe1\u606f\n</code></pre> <pre><code>-- \u67e5\u770b\u6570\u636e\u5e93\u8282\u70b9\u672c\u5730\u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e\nsu - postgres -c \"/usr/pgsql-14/bin/pg_autoctl show file   --pgdata /var/lib/pgsql/14/data/\"\n</code></pre> <pre><code>-- \u5728monitor\u8282\u70b9\u67e5\u770b \u6570\u636e\u5e93node\u8282\u70b9\u6ce8\u518c\u60c5\u51b5\nselect formationid,nodeid ,groupid,nodename from pgautofailover.node;\n    formationid     | nodeid | groupid | nodename \n--------------------+--------+---------+----------\n formation_name_003 |    120 |       0 | node3\n default            |      1 |       0 | node_1\n default            |    111 |       0 | node2\n(3 rows)\n\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#group-citus","title":"\u5229\u7528group \u7ba1\u7406citus\u4e2d\u7684\u591a\u96c6\u7fa4","text":"<p>\u5728\u521b\u5efapg\u8282\u70b9\u65f6\u5e76\u6ca1\u6709\u53c2\u8003\u7528\u6765\u6307\u5b9agroup, \u6587\u6863\u4e2d\u6709\u5982\u4e0b\u5173\u4e8egroup\u7684\u63cf\u8ff0\u3002</p> <p>in a pgsql formation, there can be only one group, with groupId 0</p> <p>At the moment citus formation kinds are not managed in the Open Source version of pg_auto_failover.</p> <p>\u5f88\u9057\u61be\uff0c\u73b0\u5f00\u6e90\u7248\u672c\u5e76\u4e0d\u652f\u6301 citus\u7c7b\u578b\u7684formation\u3002 \u7c7b\u578b\u4e3apgsql\u7684formation\u4e2d\u53ea\u652f\u6301\u4e3a\u96f6\u7684group\u3002</p> <p>\u7528pgautofailover\u6765\u7ba1\u7406citus \u96c6\u7fa4\u8fd8\u662f\u4f7f\u7528\u591a\u4e2aformaton \u5427</p>","tags":[]},{"location":"postgres/ha/pgautofailover/#_18","title":"\u76d1\u63a7\u8282\u70b9\u9ad8\u53ef\u7528","text":"<pre><code>-- \u6570\u636e\u5e93\u7684\u4e3b\u4ece\u6d41\u590d\u5236 mon1\u4e3b\u8282\u70b9,mon2\u590d\u5236\u8282\u70b9 \n-- \u5728\u521b\u5efaformation \u53ca postgres \u8282\u70b9\u65f6\uff0c \u5c06-- monitor \u53c2\u6570\u6307\u5b9a\u4e3a\npostgres://mon1:5432,mon2:5432,mon3:5432/pg_auto_failover?target_session_attrs=read-write&amp;sslmode=prefer\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#_19","title":"\u5ba2\u6237\u7aef\u9ad8\u53ef\u7528","text":"<pre><code>$ psql -d \"postgresql://host1,host2/dbname?target_session_attrs=read-write\"\n$ psql -d \"postgresql://host1:port2,host2:port2/dbname?target_session_attrs=read-write\"\n$ psql -d \"host=host1,host2 port=port1,port2 target_session_attrs=read-write\"\n</code></pre>","tags":[]},{"location":"postgres/ha/pgautofailover/#_20","title":"\u5e38\u7528\u547d\u4ee4","text":"<p>https://pg-auto-failover.readthedocs.io/en/master/ref/manual.html</p>","tags":[]},{"location":"postgres/ha/pgautofailover/#_21","title":"\u5b89\u5168\u53ca\u6743\u9650","text":"","tags":[]},{"location":"postgres/ha/repmgr/","title":"\u57fa\u4e8eRepmgr\u5b9e\u73b0\u6570\u636e\u5e93\u9ad8\u53ef\u7528","text":"","tags":[]},{"location":"postgres/ha/repmgr/#_1","title":"\u5b89\u88c5\u73af\u5883","text":"","tags":[]},{"location":"postgres/ha/repmgr/#_2","title":"\u8f6f\u4ef6\u73af\u5883","text":"<ul> <li>postgres 10</li> <li>repmgr 5.3.2</li> <li>centos7</li> </ul>","tags":[]},{"location":"postgres/ha/repmgr/#_3","title":"\u7f51\u7edc\u73af\u5883","text":"IP\u5730\u5740 \u8fd0\u884c\u8f6f\u4ef6 10.10.2.12/node1 repmgr,repmgrd,pg 10.10.2.13/node2 repmgr,repmgrd,pg 10.10.2.14/node3 repmgr,repmgrd,pg","tags":[]},{"location":"postgres/ha/repmgr/#_4","title":"\u524d\u671f\u51c6\u5907","text":"<ul> <li>hosts \u6587\u4ef6\u914d\u7f6e</li> </ul> <p><code>vi /etc/hosts #    10.10.2.12 node1   10.10.2.13 node2   10.10.2.14 node3</code></p> <ul> <li>\u5b89\u88c5PG10</li> </ul> <pre><code> $ yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n  $ yum update -y \n  $ yum install -y postgresql10-server postgresql10  postgresql10-contrib\n  # \u53ea\u6709\u4e3b\u5e93\u9700\u8981\u521d\u59cb\u5316\n  $ sudo su postgres -c  \"/usr/pgsql-10/bin/initdb  --data-checksums -D /var/lib/pgsql/10/data\" \n</code></pre> <ul> <li>\u5b89\u88c5repmgr</li> </ul> <p><code>$ yum install -y repmgr10.x86_64</code></p> <ul> <li>\u63d0\u5347postgres \u7528\u6237\u5177\u6709\u90e8\u5206sudo \u6267\u884c\u6743\u9650</li> </ul> <p>repmgr \u9700\u8981\u975eroot\u7528\u6237\u7ba1\u7406</p> <p><code>vi /etc/sudoers.d/postgres # chmod 400 /etc/sudoers.d/postgres   Defaults:postgres !requiretty   postgres ALL = NOPASSWD: /usr/bin/systemctl stop postgresql-10, \\   /usr/bin/systemctl start postgresql-10, \\   /usr/bin/systemctl restart postgresql-10, \\   /usr/bin/systemctl reload postgresql-10</code></p> <ul> <li>ssh \u514d\u5bc6\u4e92\u901a</li> </ul> <p>\u914d\u7f6essh\u514d\u5bc6\u4e92\u901a\u975e\u5fc5\u987b\uff0c\u5728\u6267\u884cswitchover\u64cd\u4f5c\u65f6\u9700\u8981 </p> <p><code>$ su - postgres   $ ssh-keygen   $ cat .ssh/id_rsa.pub &gt;  .ssh/authorized_keys # \u672c\u673a\u514d\u5bc6\u767b\u5f55    # \u5c06 .ssh \u76ee\u5f55\u4e0bauthorized_keys\uff0cid_rsa\uff0cid_rsa.pub \u62f7\u8d1d\u5230\u5176\u4ed6\u8282\u70b9\u5bf9\u5e94\u4f4d\u7f6e\u4e0a\uff0c\u5e76\u8d4b\u503c\u5bf9\u5e94\u6743\u9650   $ chmod 600 .ssh/authorized_keys   $ chmod 600 .ssh/id_rsa   $ chmod 644 .ssh/id_rsa.pub    # \u7528\u547d\u4ee4\u62f7\u8d1d\u5230\u5176\u4ed6\u8282\u70b9 # \u9996\u6b21\u8fde\u63a5\u9700\u8981\u8bbe\u7f6e\u5bc6\u7801   $ ssh-copy-id ${\u8fdc\u7aef\u670d\u52a1\u5668}    $ ssh $\u8fdc\u7aef\u670d\u52a1\u5668}</code></p>","tags":[]},{"location":"postgres/ha/repmgr/#_5","title":"\u914d\u7f6e","text":"<ul> <li>PG \u914d\u7f6e</li> </ul> <p><code>vi postgres.conf   # \u5fc5\u987b\u9879   max_wal_senders = 10   max_replication_slots = 10 # \u590d\u5236\u69fd   wal_level = 'logical' # replica \u6216 logical \uff0c\u4fbf\u4e8e\u540e\u671f\u5e94\u7528\u903b\u8f91\u590d\u5236\u5efa\u8bae\u4f7f\u7528logical   hot_standby = on # \u4ece\u5e93\u5728recovery\u72b6\u6001\u4e0b\u53ef\u8bfb   wal_log_hints = on # pg_rewind \u4f9d\u8d56\u914d\u7f6e   # \u53ef\u9009\uff0c\u5efa\u8bae\u5f00\u542f\u9879\u76ee\u3002\u540e\u671f\u4fee\u6539\u53ef\u80fd\u9700\u8981\u91cd\u542f\u6570\u636e\u5e93   archive_mode = always # \u4ece\u5e93\u4e5f\u53ef\u505a\u5f52\u6863   archive_command = '/bin/true'   archive_timeout = 300 # \u5355\u4f4d\u79d2 \uff0c\u4e94\u5206\u949f   wal_keep_segments = 1024 # \u4fdd\u7559wal\u6587\u4ef6\u4e2a\u6570\uff0c \u5982\u679c\u8bbe\u7f6eslot \u53ef\u5ffd\u7565   # \u8bbf\u95ee\u76f8\u5173   listen_addresses = '*'                  # \u76d1\u542c\u7f51\u5361   port = 5432                             # \u7aef\u53e3   max_connections = 1000                  # \u6700\u5927\u8fde\u63a5\u6570   superuser_reserved_connections = 3     #  \u8d85\u7ea7\u7528\u6237\u9884\u7559</code></p> <p>```   vi pg_hba.conf #  \u786e\u4fdd\u672c\u673arepmgr \u7528\u6237\u53ef\u8bbf\u95ee   host    replication   repmgr      127.0.0.1/32            trust   host    replication   repmgr      0.0.0.0/0               trust</p> <p>local   repmgr        repmgr                              trust   host    repmgr        repmgr      127.0.0.1/32            trust   host    repmgr        repmgr      0.0.0.0/0               md5   ```</p> <p><code># \u5143\u6570\u636e\u4fe1\u606f\u5b58\u50a8\u8bbe\u7f6e   postgres=# create user repmgr;   CREATE ROLE   postgres=# alter user repmgr with password 'xxxxx';   ALTER ROLE   postgres=# alter user repmgr replication ;   ALTER ROLE   postgres=# create database repmgr owner repmgr;   CREATE DATABASE   postgres=#\\c repmgr   repmgr=# create extension repmgr;   CREATE EXTENSION   repmgr=# GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA repmgr TO repmgr ;</code></p> <ul> <li>repmgr</li> </ul> <p><code>vi repmgr.conf # /etc/repmgr/10/repmgr.conf   ## \u5fc5\u987b\u9879   node_id=1   node_name= node1   conninfo ='host=node1 dbname=repmgr user=repmgr connect_timeout=2'   data_directory = '/var/lib/pgsql/10/data'   ## \u53ef\u9009\u9879   config_directory = # pg\u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e   replication_user = repmgr # \u9ed8\u8ba4\u4e3aconninfo \u4e2d\u4f7f\u7528\u7684user   location = # \u670d\u52a1\u5668\u6240\u5728\u7269\u7406\u4f4d\u7f6e\uff0c\u6709\u52a9\u4e8e\u5224\u65ad\u5f53\u53d1\u751f\u8111\u88c2\u65f6\u7f51\u7edc\u4e92\u901a\u903b\u8f91   use_replication_slots = true # \u662f\u5426\u4f7f\u7528\u7269\u7406\u590d\u5236\u69fd   log_level = INFO # \u65e5\u5fd7\u7b49\u7ea7   log_file =  '/var/log/repmgr/repmgr.log' # \u65e5\u5fd7\u8f93\u51fa\u6587\u4ef6\u4f4d\u7f6e \uff0c\u7ed3\u5408lograte\u7ba1\u7406   # \u6570\u636e\u5e93yum \u65b9\u5f0f\u5b89\u88c5\uff0c\u4f7f\u7528systemd \u7ba1\u7406\u65f6   service_start_command   = 'sudo systemctl start postgresql-10'   service_stop_command    = 'sudo systemctl stop postgresql-10'   service_restart_command = 'sudo systemctl restart postgresql-10'   service_reload_command  = 'sudo systemctl reload postgresql-10'</code></p>","tags":[]},{"location":"postgres/ha/repmgr/#_6","title":"\u6ce8\u518c\u4e3b\u5e93","text":"<ul> <li>\u542f\u52a8\u6570\u636e\u5e93</li> </ul> <p><code># \u542f\u52a8\u6570\u636e\u5e93\u670d\u52a1   systemctl start postgresql-10   # \u8bbe\u7f6e\u5f00\u673a\u81ea\u542f   systemctl enable postgresql-10</code></p> <p><code># \u8fde\u63a5\u6d4b\u8bd5 repmgr.conf \u4e2d\u7684conninfo \u8fde\u63a5\u4e32\u4fe1\u606f\u6d4b\u8bd5\u672c\u5730\u767b\u5f55   psql  'host=node1 dbname=repmgr user=repmgr connect_timeout=2'</code></p> <ul> <li>\u6ce8\u518c</li> </ul> <p>```   $ su - postgres</p> <p># \u6d4b\u8bd5\u6ce8\u518c\u4e3b\u8282\u70b9   $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf primary register --dry-run -L debug   INFO: connecting to primary database...   DEBUG: connecting to: \"user=repmgr dbname=repmgr host=node1 port=5432 connect_timeout=2 fallback_application_name=repmgr options=-csearch_path=\"   INFO: \"repmgr\" extension is already installed</p> <p># \u6b63\u5f0f\u6ce8\u518c\u4e3b\u8282\u70b9   $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf primary register    INFO: connecting to primary database...   INFO: \"repmgr\" extension is already installed   NOTICE: primary node record (ID: 2) registered</p> <p># \u67e5\u770b\u8282\u70b9\u4fe1\u606f   $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show    ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                              ----+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------    2  | node1 | primary | * running |          | default  | 100      | 2        | host=node1 port=5432 user=repmgr dbname=repmgr</p> <p>```</p> <ul> <li>\u5728\u6570\u636e\u5e93\u4e2d\u67e5\u770b\u6ce8\u518c\u4fe1\u606f</li> </ul> <p>```   $ repmgr=# set search_path = \"$user\", public,repmgr;   SET</p> <p>$ repmgr=# \\d+                                List of relations    Schema |        Name        | Type  | Owner  |    Size    | Description    --------+--------------------+-------+--------+------------+-------------    repmgr | events             | table | repmgr | 16 kB      |     repmgr | monitoring_history | table | repmgr | 0 bytes    |     repmgr | nodes              | table | repmgr | 16 kB      |     repmgr | replication_status | view  | repmgr | 0 bytes    |     repmgr | show_nodes         | view  | repmgr | 0 bytes    |     repmgr | voting_term        | table | repmgr | 8192 bytes |    (6 rows)</p> <p>$ SELECT * FROM repmgr.nodes;   -[ RECORD 1 ]----+-----------------------------------------------   node_id          | 2   upstream_node_id |    active           | t   node_name        | node1   type             | primary   location         | default   priority         | 100   conninfo         | host=node1 port=5432 user=repmgr dbname=repmgr   repluser         | repmgr   slot_name        | repmgr_slot_2   config_file      | /etc/repmgr/10/repmgr.conf</p> <p>$ SELECT * FROM repmgr.show_nodes ;   -[ RECORD 1 ]------+-----------------------------------------------   node_id            | 2   node_name          | node1   active             | t   upstream_node_id   |    upstream_node_name |    type               | primary   priority           | 100   conninfo           | host=node1 port=5432 user=repmgr dbname=repmgr   ```</p>","tags":[]},{"location":"postgres/ha/repmgr/#_7","title":"\u52a0\u5165\u4ece\u5e93","text":"<p>\u52a0\u5165node2 \uff0cnode3 \u4e24\u4e2a\u8282\u70b9</p> <ul> <li> <p>\u5b89\u88c5PG &amp; repmgr</p> </li> <li> <p>\u914d\u7f6erepmgr</p> </li> <li> <p>\u4ece\u4e3b\u8282\u70b9clone</p> </li> </ul> <p>```   # \u8bd5\u8fd0\u884c \u8fde\u63a5\u4fe1\u606f -U -h -d \u4e3a\u4e3b\u5e93\u5730\u5740 , \u662f\u5426\u4f7f\u7528\u590d\u5236\u69fd \u5728 repmgr.conf \u4e2d\u6307\u5b9a   $ /usr/pgsql-10/bin/repmgr -h node1 -U repmgr -d repmgr -f /etc/repmgr/10/repmgr.conf standby clone --dry-run</p> <p># \u6b63\u5f0f\u8fd0\u884c   $ /usr/pgsql-10/bin/repmgr -h node1 -U repmgr -d repmgr -f /etc/repmgr/10/repmgr.conf standby clone    # \u53ef\u9009\u53c2\u6570   -c, --fast-checkpoint \u4e3b\u5e93\u6267\u884ccheckpoint   --upstream-node-id  \u53ef\u7528\u4e8e\u7ea7\u8054\u590d\u5236   ```</p> <pre><code>```\n</code></pre> <p># \u542f\u52a8\u6570\u636e\u5e93   $ sudo systemctl start postgresql-10   # \u6ce8\u518c\u4ece\u8282\u70b9   $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby register      ```</p> <p><code># \u767b\u5f55\u4e3b\u5e93\u67e5\u770b \u4e3b\u4ece\u590d\u5236\u4fe1\u606f   select * from pg_stat_replication ;   -[ RECORD 1 ]----+------------------------------   pid              | 12204   usesysid         | 16384   usename          | repmgr   application_name | node3   client_addr      | 10.10.2.13   client_hostname  |    client_port      | 37412   backend_start    | 2022-08-11 06:15:08.568251+00   backend_xmin     |    state            | streaming   sent_lsn         | 0/5000648   write_lsn        | 0/5000648   flush_lsn        | 0/5000648   replay_lsn       | 0/5000648   write_lag        |    flush_lag        |    replay_lag       |    sync_priority    | 0   sync_state       | async</code></p> <p><code>select * from pg_replication_slots ;   -[ RECORD 1 ]-------+--------------   slot_name           | repmgr_slot_3   plugin              |    slot_type           | physical   datoid              |    database            |    temporary           | f   active              | t   active_pid          | 12386   xmin                |    catalog_xmin        |    restart_lsn         | 0/7001158   confirmed_flush_lsn |</code></p> <p><code>/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show    ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                ----+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------    2  | node1 | primary | * running |          | default  | 100      | 2        | host=node1 port=5432 user=repmgr dbname=repmgr    3  | node3 | standby |   running | node1    | default  | 100      | 2        | host=node2 user=repmgr dbname=repmgr</code></p>","tags":[]},{"location":"postgres/ha/repmgr/#switchover","title":"\u4e3b\u52a8switchover","text":"<pre><code># \u5728\u8ba1\u5212\u63d0\u5347\u4e3a\u4e3b\u5e93\u7684\u8282\u70b9\u4e0a\u6267\u884c\n/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby switchover --siblings-follow \n\n# \u67e5\u770b\u5207\u6362\u7ed3\u679c \n/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show\n ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                     \n----+-------+---------+-----------+----------+----------+----------+----------+--------------------------------------------------------\n 1  | node1 | primary | * running |          | default  | 100      | 4        | host=node1 port=5432 user=repmgr dbname=repmgr        \n 2  | node2 | standby |   running | node1    | default  | 100      | 3        | host=node2 user=repmgr dbname=repmgr                  \n 3  | node3 | standby |   running | node1    | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2\n\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\uff0c1 \u539f\u4e3b\u5e93\u4e0a\u7684slot \u4ecd\u7136\u5b58\u5728\uff08\u540e\u671f\u6d4b\u8bd5\u51e0\u6b21\u53d1\u73b0\u4f1a\u81ea\u52a8\u5220\u9664\uff09 2 \u7ea7\u8054\u590d\u5236\u7684\u60c5\u51b5\u4e0b\u907f\u514d\u6700\u4e0b\u6e38\u8282\u70b9\u63d0\u5347\u4e3b</p>","tags":[]},{"location":"postgres/ha/repmgr/#_8","title":"\u4fee\u6539\u7ea7\u8054\u5173\u7cfb","text":"<pre><code>/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby follow --upstream-node-id 1\n</code></pre>","tags":[]},{"location":"postgres/ha/repmgr/#switchover_1","title":"\u88ab\u52a8switchover","text":"<p>\u6a21\u62df\u4e3b\u8282\u70b9\u6545\u969c</p> <pre><code># node1 \u5173\u95ed\nsudo systemctl stop postgresql-10\n\n# node2 \u4e0a\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\n/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show\n ID | Name  | Role    | Status        | Upstream | Location | Priority | Timeline | Connection string                                     \n----+-------+---------+---------------+----------+----------+----------+----------+--------------------------------------------------------\n 1  | node1 | primary | ? unreachable | ?        | default  | 100      |          | host=node1 port=5432 user=repmgr dbname=repmgr        \n 2  | node2 | standby |   running     | ? node1  | default  | 100      | 4        | host=node2 user=repmgr dbname=repmgr                  \n 3  | node3 | standby |   running     | ? node1  | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2\n\nWARNING: following issues were detected\n  - unable to connect to node \"node1\" (ID: 1)\n  - node \"node1\" (ID: 1) is registered as an active primary but is unreachable\n  - unable to connect to node \"node2\" (ID: 2)'s upstream node \"node1\" (ID: 1)\n  - unable to determine if node \"node2\" (ID: 2) is attached to its upstream node \"node1\" (ID: 1)\n  - unable to connect to node \"node3\" (ID: 3)'s upstream node \"node1\" (ID: 1)\n  - unable to determine if node \"node3\" (ID: 3) is attached to its upstream node \"node1\" (ID: 1)\n\nHINT: execute with --verbose option to see connection error messages\n</code></pre> <p>\u63d0\u5347node2 \u8282\u70b9\u4e3a\u4e3b\u8282\u70b9</p> <pre><code># \u5728node2 \u4e0a\u6267\u884c\n$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby promote\nWARNING: 1 sibling nodes found, but option \"--siblings-follow\" not specified\nDETAIL: these nodes will remain attached to the current primary:\n  node3 (node ID: 3)\nNOTICE: promoting standby to primary\nDETAIL: promoting server \"node2\" (ID: 2) using \"/usr/pgsql-10/bin/pg_ctl  -w -D '/var/lib/pgsql/10/data' promote\"\nwaiting for server to promote.... done\nserver promoted\nNOTICE: waiting up to 60 seconds (parameter \"promote_check_timeout\") for promotion to complete\nNOTICE: STANDBY PROMOTE successful\nDETAIL: server \"node2\" (ID: 2) was successfully promoted to primary\n\n# \u67e5\u770b\u96c6\u7fa4\u72b6\u6001\n$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show\n ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                     \n----+-------+---------+-----------+----------+----------+----------+----------+--------------------------------------------------------\n 1  | node1 | primary | - failed  | ?        | default  | 100      |          | host=node1 port=5432 user=repmgr dbname=repmgr        \n 2  | node2 | primary | * running |          | default  | 100      | 5        | host=node2 user=repmgr dbname=repmgr                  \n 3  | node3 | standby |   running | ? node1  | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2\n\nWARNING: following issues were detected\n  - unable to connect to node &amp;quot;node1&amp;quot; (ID: 1)\n  - unable to connect to node &amp;quot;node3&amp;quot; (ID: 3)&amp;apos;s upstream node &amp;quot;node1&amp;quot; (ID: 1)\n  - unable to determine if node &amp;quot;node3&amp;quot; (ID: 3) is attached to its upstream node &amp;quot;node1&amp;quot; (ID: 1)\n\nHINT: execute with --verbose option to see connection error messages\n\n# \u5982\u679c\u539f\u6765\u96c6\u7fa4\u4e2d\u6709\u5176\u4ed6\u4ece\u8282\u70b9\uff0c\u4e3b\u8282\u70b9\u4e5f\u6307\u5411\u6545\u969c\u8282\u70b9node1 \uff0c \u5728\u63d0\u5347node2\u8282\u70b9\u65f6\u540c\u65f6\u5c06\u5176\u4ed6\u8282\u70b9\u6307\u5411\u81ea\u5df1\n$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby promote --siblings-follow \n</code></pre> <p>node3 \u91cd\u65b0\u6307\u5b9a\u4e3b\u5e93\u4e3anode2</p> <pre><code># \u5728node3 \u4e0a\u6267\u884c\n$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby follow\n# \u67e5\u770b\u72b6\u6001\n$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show\n ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                     \n----+-------+---------+-----------+----------+----------+----------+----------+--------------------------------------------------------\n 1  | node1 | primary | - failed  | ?        | default  | 100      |          | host=node1 port=5432 user=repmgr dbname=repmgr        \n 2  | node2 | primary | * running |          | default  | 100      | 5        | host=node2 user=repmgr dbname=repmgr                  \n 3  | node3 | standby |   running | node2    | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2\n\nWARNING: following issues were detected\n  - unable to connect to node \"node1\" (ID: 1)\n\nHINT: execute with --verbose option to see connection error messages\n</code></pre> <p>node1 \u91cd\u65b0\u52a0\u5165\u96c6\u7fa4</p> <pre><code># \u767b\u5f55\u5230\u539f\u4e3bnode1 \u8282\u70b9 \uff0c \u786e\u4fdd\u6570\u636e\u662f\u5173\u95ed\u72b6\u6001 \n$ /usr/pgsql-10/bin/repmgr node rejoin -f /etc/repmgr/10/repmgr.conf -d 'host=node3 dbname=repmgr user=repmgr'  --force-rewind --config-files=postgresql.conf --verbose --dry-run\nNOTICE: using provided configuration file \"/etc/repmgr/10/repmgr.conf\"\nNOTICE: rejoin target is node \"node3\" (ID: 3)\nINFO: replication slots in use, 3 free slots on node 9\nINFO: replication connection to the rejoin target node was successful\nINFO: local and rejoin target system identifiers match\nDETAIL: system identifier is 7129425727714895616\nINFO: prerequisites for using pg_rewind are met\nINFO: temporary archive directory \"/tmp/repmgr-config-archive-node1\" created\nINFO: file \"postgresql.conf\" would be copied to \"/tmp/repmgr-config-archive-node1/postgresql.conf\"\nINFO: 1 files would have been copied to \"/tmp/repmgr-config-archive-node1\"\nINFO: temporary archive directory \"/tmp/repmgr-config-archive-node1\" deleted\nINFO: pg_rewind would now be executed\nDETAIL: pg_rewind command is:\n  /usr/pgsql-10/bin/pg_rewind -D '/var/lib/pgsql/10/data' --source-server='host=node3 dbname=repmgr user=repmgr connect_timeout=2'\nINFO: prerequisites for executing NODE REJOIN are met\n\n# \u6b63\u5f0f\u6267\u884c\n$ /usr/pgsql-10/bin/repmgr node rejoin -f /etc/repmgr/10/repmgr.conf -d 'host=node3 dbname=repmgr user=repmgr'  --force-rewind --config-files=postgresql.conf --verbose\n# \u542f\u52a8\u6570\u636e\u5e93\n$ sudo systemctl start postgresql-10\n# \u67e5\u770b\u7ed3\u679c\n$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show\n</code></pre> <p>node1 \u8282\u70b9\u6545\u969c\u4e0d\u53ef\u6062\u590d\u60c5\u51b5</p> <p>```</p>","tags":[]},{"location":"postgres/ha/repmgr/#node1","title":"\u5c06node1 \u8282\u70b9\u4ece\u96c6\u7fa4\u4e2d\u6ce8\u9500, \u767b\u5f55\u5230\u5176\u4ed6\u4efb\u610f\u8282\u70b9","text":"<p>$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby unregister --node-id  ```</p> <pre><code> $ repmgr -f /etc/repmgr/10/repmgr.conf cluster event\n</code></pre>","tags":[]},{"location":"postgres/ha/repmgr/#failover","title":"\u81ea\u52a8failover","text":"<p>\u4fee\u6539\u914d\u7f6e</p> <p>vi postgresql.conf</p> <pre><code>shared_preload_libraries = 'repmgr'\n</code></pre> <p>vi /etc/repmgr/10/repmgr.conf</p> <pre><code>failover=automatic\npromote_command='/usr/pgsql-10/bin/repmgr standby promote -f /etc/repmgr/10/repmgr.conf --log-to-file'\nfollow_command='/usr/pgsql-10/bin/repmgr standby follow -f /etc/repmgr/10/repmgr.conf --log-to-file --upstream-node-id=%n'\nlog_file='/var/lib/pgsql/repmgrd.log'\nmonitoring_history=true #\uff08\u542f\u7528\u76d1\u63a7\u53c2\u6570\uff09\nmonitor_interval_secs=5 #\uff08\u5b9a\u4e49\u76d1\u89c6\u6570\u636e\u95f4\u9694\u5199\u5165\u65f6\u95f4\u53c2\u6570\uff09\nreconnect_attempts=10 #\uff08\u6545\u969c\u8f6c\u79fb\u4e4b\u524d\uff0c\u5c1d\u8bd5\u91cd\u65b0\u8fde\u63a5\u4e3b\u5e93\u6b21\u6570\uff08\u9ed8\u8ba4\u4e3a6\uff09\u53c2\u6570\uff09\nreconnect_interval=5 #\uff08\u6bcf\u95f4\u96945s\u5c1d\u8bd5\u91cd\u65b0\u8fde\u63a5\u4e00\u6b21\u53c2\u6570\n</code></pre> <p>\u91cd\u542f postgres</p> <pre><code>repmgr node service --action=restart\n</code></pre> <p>\u542f\u52a8 repmgrd</p> <pre><code>systemctl start repmgr-10\nsystemctl enable repmgr-10\n</code></pre> <p>\u6d4b\u8bd5</p> <p>\u7565</p> <p>\u4e3b\u8282\u70b9\u91cd\u65b0\u52a0\u5165\u96c6\u7fa4</p> <pre><code># \u5168\u90e8\u539f\u4e3b\u8282\u70b9\u4fdd\u6301\u5173\u95ed\u72b6\u6001\u3002 \u9996\u5148\u5c06\u6267\u884cpg_rewind -&gt;   \u81ea\u52a8\u542f\u52a8\u670d\u52a1 - &gt; \u6ce8\u518c\u670d\u52a1\n repmgr node rejoin -d 'host=node1 dbname=repmgr user=repmgr' --force-rewind --config-files=postgresql.conf,postgresql.auto.conf --verbose --dry-run\n repmgr node rejoin -d 'host=node1 dbname=repmgr user=repmgr' --force-rewind --config-files=postgresql.conf,postgresql.auto.conf --verbose\n</code></pre>","tags":[]},{"location":"postgres/ha/repmgr/#failover_1","title":"\u81ea\u52a8failover \u51e0\u70b9\u8bf4\u660e","text":"<p>\u4e3a\u9884\u9632\u7f51\u7edc\u8111\u88c2\u53d1\u751f\uff1a repmgr \u505a\u4e86\u5982\u4e0b\u52aa\u529b\uff1a 1 \uff0c\u4f7f\u7528\u89c1\u8bc1\u8282\u70b9\u3002\u4e3b\u8981\u5e94\u7528\u4e8e\u53ea\u6709\u4e3b\u4ece\u4e24\u4e2a\u8282\u70b9\u7684\u573a\u666f\uff0c \u5c06\u89c1\u8bc1\u8282\u70b9\u4e0e\u4e3b\u8282\u70b9\u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u7f51\u7edc\u533a\u95f4\u3002 \u5f53\u4e3b\u8282\u70b9\u4e0e\u89c1\u8bc1\u8282\u70b9\u540c\u65f6\u4e0d\u53ef\u89c1\u65f6\uff0c\u8ba4\u4e3a\u662f\u7f51\u7edc\u9519\u8bef\uff0c\u4e0d\u53d1\u751f\u5207\u6362\u3002\u5f53\u89c1\u8bc1\u8282\u70b9\u53ef\u89c1\uff0c\u4e3b\u8282\u70b9\u4e0d\u53ef\u89c1\u65f6\uff0c\u8ba4\u4e3a\u4e3b\u8282\u70b9\u5931\u6548\uff0c\u89e6\u53d1\u5207\u6362\u3002</p> <p>\u5f15\u5165\u89c1\u8bc1\u8282\u70b9\u63d0\u9ad8\u4e86\u7ef4\u62a4\u6210\u672c\u3002 </p> <p>\u591aIDC\u7f51\u7edc\u573a\u666f\uff0c\u65b9\u68482 \uff1a \u4f7f\u7528location \u6807\u8bb0\u670d\u52a1\u6240\u5728\u7684\u4f4d\u7f6e\u3002\u5f53\u4e0e\u4e3b\u8282\u70b9location\u76f8\u540c\u7684\u8282\u70b9\u90fd\u4e0d\u53ef\u89c1\u65f6\uff0c\u8ba4\u4e3a\u662f\u7f51\u7edc\u9519\u8bef\uff0c\u4e0d\u53d1\u751f\u5207\u6362\u3002\u5982\u679c\u96c6\u7fa4\u4e2d\u6ca1\u6709\u5176\u4ed6\u8282\u70b9\u4e0e\u4e3b\u8282\u70b9\u7684location\u914d\u7f6e\u76f8\u540c\uff0c\u5219\u6c38\u8fdc\u4e0d\u53d1\u751f\u5207\u6362\u3002</p> <p>\u4e3e\u4f8b\uff1a \u4e09\u4e2aIDC\uff0c\u4e09\u4e2apg\u670d\u52a1\u3002location\u5206\u522b\u8bbe\u7f6e\u4e3adc1\uff08\u4e3b\u8282\u70b9\uff09\uff0cdc2\uff08\u4ece\u8282\u70b9\uff09\uff0cdc3\uff08\u4ece\u8282\u70b9\uff09\u3002 \u5f53dc1 \u8282\u70b9\u53d1\u751f\u6545\u969c\u65f6\u4e0d\u4f1a\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u3002 \u56e0\u4e3a\u96c6\u7fa4\u4e2dlocation \u4e3adc1\u7684\u8282\u70b9\uff08\u53ea\u6709\u4e00\u4e2a\uff09\u90fd\u4e0d\u53ef\u89c1\u3002</p> <p>\u5408\u7406\u7684\u8bbe\u7f6e\u5e94\u8be5\u4e3acd1(\u4e3b\u8282\u70b9) ,dc1(\u4e00\u4e2a\u4ece)\uff0cdc2\uff08\u53e6\u4e00\u4e2a\u4ece\uff09\u3002 \u6b64\u65f6\u5f53dc1 \u53d1\u751f\u4ee5\u5916\u65f6\uff0c\u53ef\u6545\u969c\u8f6c\u79fb\u3002</p>","tags":[]},{"location":"postgres/ha/repmgr/#repmgrpg","title":"\u6ce8\u610f\u4e8b\u9879\uff1a \u5f53\u4e3b\u8282\u70b9\u7f51\u7edc\u95ee\u9898\u3002\u5982\u7f51\u5361\uff0c\u7f51\u7ebf\u6545\u969c\u3002\u670d\u52a1\u6b63\u5e38\u7684\u60c5\u51b5\u4e0b\u3002\u96c6\u7fa4\u4e5f\u4f1a\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u3002\u5f53\u7f51\u7edc\u6062\u590d\u7684\u65f6\u5019\u53d1\u751f\u8111\u88c2\u3002 \u4e3b\u8981\u95ee\u9898\u3002\u5f53\u4e3b\u8282\u70b9\u8131\u79bb\u96c6\u7fa4\u65f6\u6ca1\u6709\u5f7b\u5e95\u5173\u95ed\u670d\u52a1\u3002repmgr\u4e0d\u80fd\u7ba1\u7406pg\u670d\u52a1,\u5c06\u5176\u5173\u95ed\u3002","text":"<p>\u53ef\u4ee5\u5982\u4e0b\u8bbe\u7f6e\uff0c\u901a\u8fc7\u786e\u5b9a\u4e0e\u4ece\u8282\u70b9\u8fde\u63a5\u4e2a\u6570\u51b3\u5b9a\u662f\u5426\u5173\u95ed\u5f53\u524d\u670d\u52a1\u3002\u5728command\u4e2d\u5173\u95ed\u5f53\u524dpg</p> <pre><code>#child_nodes_check_interval=5           # Interval (in seconds) to check for attached child nodes (standbys)\n#child_nodes_connected_min_count=-1     # Minimum number of child nodes which must remain connected, otherwise\n                                        # disconnection command will be triggered\n#child_nodes_disconnect_min_count=-1    # Minimum number of disconnected child nodes required to execute disconnection command\n                                        # (ignored if \"child_nodes_connected_min_count\" set)\n#child_nodes_disconnect_timeout=30      # Interval between child node disconnection and disconnection command execution\nchild_nodes_disconnect_command='' \n</code></pre>","tags":[]},{"location":"postgres/ha/repmgr/#location","title":"location \u4fee\u6539","text":"<p>localtion \u53c2\u6570\u5728\u9ad8\u53ef\u7528\u67b6\u6784\u4e2d\u4e3a\u9632\u6b62\u7f51\u7edc\u5206\u533a\u95ee\u9898\u53d1\u6325\u91cd\u8981\u4f5c\u7528\u3002 \u53d1\u751f\u6545\u969c\u8f6c\u79fb\u540elocation \u901a\u5e38\u4e5f\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1\u3002</p> <p>\u4fee\u6539 /etc/repmgr/10/repmgr.conf</p> <p>\u751f\u6548</p> <pre><code>repmgr standby register --force\nsystemctl restart repmgr-10\n</code></pre> <p>\u67e5\u770b</p> <pre><code>repmgr cluster show\n\u6216\nselect * from repmgr.nodes;\n</code></pre> <p>\u4fee\u6539location</p>","tags":[]},{"location":"postgres/ha/repmgrd/","title":"repmgrd\u4ecb\u7ecd","text":""},{"location":"postgres/ha/repmgrd/#repmgrd","title":"repmgrd\u4ecb\u7ecd","text":"<p>repmgrd \u4f5c\u4e3a\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684\u4e00\u4e2a\u7ba1\u7406\u548c\u76d1\u63a7\u7684\u5b88\u62a4\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u81ea\u52a8\u8fdb\u884c\u6545\u969c\u8f6c\u79fb\u548c\u7ef4\u62a4\u590d\u5236\u5173\u7cfb\uff0c\u5e76\u63d0\u4f9b\u6709\u5173\u6bcf\u4e2a\u8282\u70b9\u72b6\u6001\u7684\u76d1\u63a7\u4fe1\u606f\u3002</p> <p>repmgrd \u4e0d\u4f9d\u8d56\u5176\u4ed6\u670d\u52a1</p> <p>\u63d0\u4f9b\u7684\u529f\u80fd\u5305\u62ec:</p> <ul> <li>\u4f17\u591a\u7684\u914d\u7f6e\u9879\u63d0\u4f9b\u9009\u62e9</li> <li>\u6839\u636e\u573a\u666f\u53ef\u81ea\u5b9a\u4e49\u5bf9\u5e94\u6267\u884c\u811a\u672c</li> <li>\u4e00\u4e2a\u547d\u4ee4\u8fdb\u5165\u7ef4\u62a4\u6a21\u5f0f</li> <li>\u591a\u6570\u636e\u4e2d\u5fc3\u573a\u666f\uff0c\u901a\u8fc7location\u9650\u5236\u5019\u9009\u4e3b\u8282\u70b9</li> <li>\u591a\u79cd\u9a8c\u8bc1Postgresql\u5b58\u6d3b\u72b6\u6001\u65b9\u6cd5\uff08PostgreSQL ping, query execution or new connection\uff09</li> <li>\u4fdd\u7559\u76d1\u63a7\u6570\u636e\uff08\u53ef\u9009\uff09</li> </ul>"},{"location":"postgres/ha/repmgrd/#repmgrd_1","title":"repmgrd \u6545\u969c\u8f6c\u79fb","text":""},{"location":"postgres/ha/repmgrd/#_1","title":"\u89c1\u8bc1\u8282\u70b9\u4ecb\u7ecd","text":"<p>\u662f\u4e00\u4e2a\u72ec\u7acb\u4e8e\u5f53\u524d\u4e3b\u4ece\u590d\u5236\u6570\u636e\u5e93\u7684Postgresql\u6570\u636e\u5e93\u3002</p> <p>\u76ee\u7684\u662f\u5f53\u53d1\u751ffailover\u573a\u666f\u65f6\uff0c\u7528\u6765\u8bc1\u660e\u4e3b\u670d\u52a1\u81ea\u8eab\u4e0d\u53ef\u7528\u8fd8\u662f\u6570\u636e\u4e2d\u5fc3\u7f51\u7edc\u95ee\u9898</p> <p>\u4e00\u4e2a\u5178\u578b\u7684\u573a\u666f</p> <p>\u4f4d\u4e8e\u4e24\u4e2a\u6570\u636e\u4e2d\u5fc3\u7684\u4e3b\u4ece\u590d\u5236\u7ed3\u6784\u3002\u548c\u4e3b\u670d\u52a1\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u4e0a\u521b\u5efa\u4e00\u4e2a\u89c1\u8bc1\u670d\u52a1\u3002\u5f53\u4e3b\u670d\u52a1\u4e0d\u53ef\u7528\u65f6\uff0c\u4ece\u8282\u70b9\u5224\u65ad\u903b\u8f91\uff0c\u5982\u679c\u4e3b\u670d\u52a1\u548c\u89c1\u8bc1\u8282\u70b9\u90fd\u4e0d\u53ef\u89c1\u5219\u8ba4\u4e3a\u662f\u7f51\u7edc\u95ee\u9898\u3002\u5982\u679c\u4e3b\u670d\u52a1\u4e0d\u53ef\u89c1\uff0c\u89c1\u8bc1\u8282\u70b9\u53ef\u89c1\u5219\u8ba4\u4e3a\u662f\u4e3b\u670d\u52a1\u53d1\u751f\u95ee\u9898\u3002</p> <p>\u6ce8\u610f\u4e8b\u9879:</p> <p>\u4e0d\u8981\u5c06\u89c1\u8bc1\u8282\u70b9\u4e0e\u4e3b\u4ece\u670d\u52a1\u5b89\u88c5\u5728\u540c\u4e00\u4e2a\u7269\u7406\u673a\u4e0a\u3002</p> <p>\u591a\u6570\u636e\u4e2d\u5fc3\u573a\u666f\u5efa\u8bae\u4f7f\u7528localiton\u6765\u9884\u9632\u8111\u88c2\u95ee\u9898</p> <p>\u89c1\u8bc1\u8282\u70b9\u53ea\u5728repmgrd\u542f\u7528\u65f6\u6709\u6548\u3002</p>"},{"location":"postgres/ha/repmgrd/#_2","title":"\u6dfb\u52a0\u89c1\u8bc1\u8282\u70b9","text":"<p>\u5b89\u88c5\u4e00\u4e2a\u72ec\u7acb\u7684Postgresql\u5b9e\u4f8b\uff0c\u914d\u7f6e\u53c2\u8003\u666e\u901a\u7684repmgr\u3002</p> <p>\u6ce8\u518c\u89c1\u8bc1\u8282\u70b9 </p> <pre><code>repmgr -f /etc/repmgr.conf witness register -h node1\n</code></pre> <p>\u601d\u8003: \u89c1\u8bc1\u8282\u70b9\u662f\u5426\u9700\u8981\u8fd0\u884crepmgrd\u3002 \u89c1\u8bc1\u8282\u70b9\u4e0d\u540c\u4e8e\u5176\u4ed6\u4ece\u8282\u70b9\uff0c\u5143\u6570\u636e\u53ef\u4ee5\u901a\u8fc7\u6d41\u590d\u5236\u76f4\u63a5\u83b7\u53d6\u5230\u3002\u9700\u8981repmgrd\u6765\u7ef4\u62a4\u3002</p>"},{"location":"postgres/ha/repmgrd/#_3","title":"\u89e3\u51b3\u8111\u88c2\u95ee\u9898","text":"<p>\u591a\u6570\u636e\u4e2d\u5fc3\u5e26\u6765\u7684\u8111\u88c2\u95ee\u9898\uff0c\u5f53\u4e0d\u540c\u6570\u636e\u4e2d\u5fc3\u7684\u8282\u70b9\u5f7c\u6b64\u4e0d\u53ef\u89c1\u65f6\uff0c\u4ece\u5e93\u7684\u670d\u52a1\u53d1\u751ffailover \u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u4e3b\u8282\u70b9\u3002\u6b64\u65f6\u6574\u4e2a\u96c6\u7fa4\u540c\u65f6\u62e5\u6709\u4e24\u4e2a\u4e3b\u670d\u52a1\u3002</p> <p>\u867d\u7136\u89c1\u8bc1\u670d\u52a1\u53ef\u4ee5\u5728\u4ef2\u88c1\u3002\u4f46\u662f\u89c1\u8bc1\u670d\u52a1\u5b58\u5728\u5982\u4e0b\u5f0a\u7aef\u3002</p> <ul> <li>\u9700\u8981\u4fdd\u8bc1\u89c1\u8bc1\u8282\u70b9\u4e0e\u4e3b\u670d\u52a1\u8282\u70b9\u4f4d\u4e8e\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u3002</li> <li>\u5f53\u96c6\u7fa4\u4e2d\u591a\u6570\u8282\u70b9\u4e0e\u4e3b\u670d\u52a1\u8282\u70b9\u4e0d\u5728\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u65f6\uff0c\u589e\u52a0\u989d\u5916\u7684\u7ef4\u62a4\u6210\u672c\uff0c\u4e14\u4e0d\u4fbf\u6269\u5c55\uff0c\u5c24\u5176\u662f\u5927\u89c4\u6a21\u5e94\u7528\u65f6\u3002</li> </ul> <p>repmgr4 \u63d0\u51falocation\u7684\u6982\u5ff5\uff0c\u901a\u8fc7\u914d\u7f6elocation\u6765\u6307\u5b9a\u8282\u70b9\u7684\u7269\u7406\u4f4d\u7f6e\u3002</p> <p>\u5f53\u53d1\u751ffailover\u65f6\u3002repmgr\u9996\u5148\u68c0\u6d4b\u662f\u5426\u5b58\u5728\u4e0e\u4e3b\u670d\u52a1\u4f4d\u4e8e\u540c\u4e00\u4e2alocaltion\u7684\u670d\u52a1\u662f\u53ef\u89c1\u7684\u3002\u5982\u679c\u4e0d\u5b58\uff08\u5373\u6574\u4e2a\u4e0e\u4e3b\u670d\u52a1\u4f4d\u4e8e\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u7684\u8282\u70b9\u90fd\u4e0d\u53ef\u89c1\uff09\u5728\u5219\u8ba4\u4e3a\u662f\u7f51\u7edc\u95ee\u9898\u3002\u4e0d\u63d0\u5347\u65b0\u4e3b\u5e93\uff0c\u5e76\u4e14\u8fdb\u5165\u964d\u7ea7\u6a21\u5f0f\u3002</p>"},{"location":"postgres/ha/repmgrd/#_4","title":"\u4e3b\u670d\u52a1\u53ef\u89c1\u6027\u5171\u8bc6","text":"<p>\u66f4\u590d\u6742\u7684\u96c6\u7fa4\u7ed3\u6784\uff0c\u5f53\u4ece\u8282\u70b9\u670d\u52a1\u8fde\u63a5\u4e0d\u5230\u4e3b\u670d\u52a1\u65f6\uff0c\u8be2\u95ee\u5176\u4ed6\u4ece\u670d\u52a1\u6700\u540e\u4e00\u6b21\u770b\u5230\u4e3b\u670d\u52a1\u7684\u65f6\u95f4\u3002\u5f53\u5b58\u5728\u8282\u70b9\u53ef\u4ee5\u8fde\u63a5\u5230\u4e3b\u670d\u52a1\u5219\u8bc1\u660e\u4e3b\u670d\u52a1\u8fd8\u5b58\u6d3b\uff0c\u5e76\u4e14\u53ef\u4ee5\u6b63\u5e38\u63d0\u4f9b\u5199\u670d\u52a1\u3002\u6b64\u65f6\u4e0d\u53d1\u751f\u65b0\u7684\u9009\u4e3e\u3002</p> <p>\u914d\u7f6e\u53c2\u6570</p> <pre><code> primary_visibility_consensus=true\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\u3002\u5fc5\u987b\u6bcf\u4e2a\u670d\u52a1\u90fd\u8bbe\u7f6e\u4e3atrue\u624d\u751f\u6548</p>"},{"location":"postgres/ha/repmgrd/#_5","title":"\u4ece\u8282\u70b9\u65ad\u5f00\u8fde\u63a5","text":"<p>\u5f53standby_disconnect_on_failover\u8bbe\u7f6e\u4e3atrue\u65f6\uff0c\u5728\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u65f6\u9996\u5148\u4ece\u8282\u70b9\u65ad\u5f00\u672c\u5730\u7684wal receiver,\u5e76\u4e14\u7b49\u5f85\u6240\u6709\u5176\u4ed6\u8282\u70b9\u65ad\u5f00\u81ea\u5df1\u7684wal receiver\u3002</p> <p>\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u4e3a\u786e\u4fdd\u5728\u6545\u969c\u8f6c\u79fb\u65f6\uff0c\u6240\u6709\u7684\u8282\u70b9lsn\u5904\u4e8e\u9759\u6b62\u72b6\u6001\u3002</p> <p>\u91cd\u8981\u63d0\u793a:</p> <ul> <li> <p>Postgresql9.5 \u53ca\u4ee5\u4e0a\uff0crepmgr \u7684\u6570\u636e\u5e93\u7528\u6237\u5177\u6709\u8d85\u7ea7\u7528\u6237\u6743\u9650</p> </li> <li> <p><code>standby_disconnect_on_failover</code> \u5fc5\u987b\u8981\u6240\u6709\u8282\u70b9\u670d\u52a1\u90fd\u8bbe\u7f6e\u624d\u751f\u6548</p> </li> <li>\u6ce8\u610f\u8bbe\u7f6e\u6b64\u53c2\u6570\u540e\u5c06\u5e26\u6765\u7684\u5ef6\u8fdf\uff0c\u5305\u62ec\u786e\u5b9a\u81ea\u5df1wal receiver\u662f\u5426\u5df2\u7ecf\u5173\u95ed\u3002\u7b49\u4ed6\u786e\u8ba4\u5176\u4ed6\u8282\u70b9wal receiver \u662f\u5426\u5df2\u7ecf\u5b8c\u5168\u5173\u95ed</li> <li>\u5f00\u542f\u6b64\u53c2\u6570\u5efa\u8bae\u540c\u65f6\u5f00\u542f   <code>primary_visibility_consensus</code></li> </ul>"},{"location":"postgres/ha/repmgrd/#_6","title":"\u6545\u969c\u8f6c\u79fb\u9a8c\u8bc1","text":"<p>\u5728\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u65f6\uff0c\u67d0\u4e2a\u8282\u70b9\u88ab\u9009\u4e3e\u4e3a\u65b0\u7684\u4e3b\u8282\u70b9\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u81ea\u5b9a\u4e49\u5224\u65ad\u811a\u672c\uff0c\u8fdb\u4e00\u6b65\u51b3\u5b9a\u5f53\u524d\u662f\u5426\u53ef\u4ee5\u88ab\u63d0\u5347\u4e3a\u4e3b\u8282\u70b9\uff08\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u8f85\u52a9\u903b\u8f91\uff09\u3002  \u5fc5\u987b\u5728\u6240\u6709\u8282\u70b9\u8fdb\u884c\u914d\u7f6e\u3002       </p> <p>\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>failover_validation_command=/path/to/script.sh %n     \n</code></pre> <p>\u53ef\u4f7f\u7528\u53c2\u6570\uff1a</p> <ul> <li><code>%n</code>: node ID</li> <li><code>%a</code>: node name</li> <li><code>%v</code>: \u53ef\u89c1\u8282\u70b9\u6570</li> <li><code>%u</code>: number of shared upstream nodes</li> <li><code>%t</code>: \u603b\u8282\u70b9\u6570</li> </ul> <p>\u6839\u636e\u811a\u672c\u8fd4\u56de\u7801\uff08\u662f\u5426\u975e0\uff09\u51b3\u5b9a\u662f\u5426\u53ef\u4ee5\u5c06\u5f53\u524d\u8282\u70b9\u63d0\u5347\u4e3a\u4e3b\u8282\u70b9\uff0c\u5982\u679c\u4e0d\u7b26\u5408\u6761\u4ef6\uff0c\u4e2d\u65ad\u672c\u6b21\u6545\u969c\u8f6c\u79fb\u6d41\u7a0b\uff0c<code>election_rerun_interval</code> \u79d2\u540e\u8fdb\u5165\u4e0b\u4e00\u8f6e\u6545\u969c\u8f6c\u79fb\u6d41\u7a0b\u3002</p>"},{"location":"postgres/ha/repmgrd/#_7","title":"\u7ea7\u8054\u590d\u5236","text":"<p>Postgresql 9.2 \u6570\u636e\u5e93\u5177\u6709\u4e86\u7ea7\u8054\u590d\u5236\u529f\u80fd\u3002repmgr \u53ef\u4ee5\u63d0\u4f9b\u7ea7\u8054\u590d\u5236\u652f\u6301\u3002</p> <p>\u5f53\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u65f6\uff0crepmgr\u4fdd\u6301\u7ea7\u8054\u5173\u7cfb\u4e0d\u53d8\u3002</p> <p>\u5728\u4e0a\u6e38\u8282\u70b9\u53d1\u751f\u6545\u969c\u65f6\u4e0b\u6e38\u8282\u70b9\u81ea\u52a8\u91cd\u65b0\u5c1d\u8bd5\u8fde\u63a5\u539f\u4e0a\u6e38\u8282\u70b9\u7684\u7236\u8282\u70b9\u3002</p>"},{"location":"postgres/ha/repmgrd/#_8","title":"\u4e3b\u8282\u70b9\u68c0\u6d4b\u4ece\u5e93\u8fde\u63a5","text":"<p>\u4ee5\u4e0a\u7684\u8003\u8651\u60c5\u5f62\u5927\u591a\u662f\u901a\u8fc7\u4ece\u8282\u70b9\u68c0\u6d4b\u4e3b\u8282\u70b9\u7684\u8fd0\u884c\u60c5\u51b5\u6765\u51b3\u5b9a\u662f\u5426\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u3002\u5728repmgr\u4e2d\u4e3b\u8282\u70b9\u4e5f\u53ef\u4ee5\u68c0\u6d4b\u5230\u4ece\u8282\u70b9\u7684\u8fde\u63a5\u60c5\u51b5\u3002</p> <p>\u901a\u8fc7\u4e3b\u673a\u70b9\u4e0d\u65ad\u7684\u68c0\u6d4b\u4ece\u8282\u70b9\u7684\u8fde\u63a5\u60c5\u51b5\uff0c\u5f53\u6ee1\u8db3\u67d0\u4e9b\u72b6\u51b5\u65f6\u53ef\u4ee5\u6267\u884c\u81ea\u5b9a\u4e49\u811a\u672c\u3002\u5982\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u540e\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u4e3b\u670d\u52a1\u65f6\uff0c\u5176\u4ed6\u7684\u4ece\u8282\u70b9\u4e5f\u90fd\u8ddf\u7740\u6307\u5411\u4e86\u65b0\u4e3b\u8282\u70b9\uff0c\u539f\u4e3b\u8282\u70b9\u7684\u4ece\u8282\u70b9\u4e2a\u6570\u53d8\u4e3a\u96f6\u3002\u8fd9\u65f6\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u4e00\u4e2a\u7279\u6b8a\u7684\u547d\u4ee4\u6765\u963b\u6b62\u5e94\u7528\u5199\u5165\u539f\u4e3b\u8282\u70b9\u3002</p>"},{"location":"postgres/ha/repmgrd/#_9","title":"\u68c0\u6d4b\u8fc7\u7a0b\u548c\u6807\u51c6","text":"<ul> <li>\u95f4\u9694\u65f6\u95f4<code>child_nodes_check_interval</code> \u9ed8\u8ba45\u79d2\u67e5\u8be2\u4e00\u6b21pg_stat_replication \u89c6\u56fe\uff0c\u5e76\u4e0e\u6ce8\u518crepmgr\u65f6\u6307\u5b9aupstream node\u4e3a\u4e3b\u53ca\u8282\u70b9\u7684\u5217\u8868\u8fdb\u884c\u5bf9\u6bd4</li> <li>\u5982\u679c\u68c0\u6d4b\u5230\u4ece\u8282\u70b9\u4e0d\u5728pg_stat_replication \u89c6\u56fe\u4e2d\u3002\u8bb0\u5f55\u68c0\u6d4b\u5230\u7684\u65f6\u95f4\u5e76\u89e6\u53d1   <code>child_node_disconnect</code> \u4e8b\u4ef6</li> <li>\u5982\u679c\u4ece\u8282\u70b9\u91cd\u65b0\u51fa\u73b0\u5728pg_stat_repliation\u89c6\u56fe\u4e2d\uff0c\u6e05\u9664\u4e0a\u9762\u7684\u68c0\u6d4b\u65f6\u95f4\u8bb0\u5f55\uff0c\u5e76\u89e6\u53d1  <code>child_node_reconnect</code>\u4e8b\u4ef6</li> <li>\u5982\u679c\u68c0\u6d4b\u5230\u4e00\u4e2a\u65b0\u7684\u4ece\u8282\u70b9\u52a0\u5165\uff0c\u5c06\u65b0\u8282\u70b9\u52a0\u5165\u5230\u5185\u90e8\u5217\u8868\u4e2d\u5e76\u89e6\u53d1<code>child_node_new_connect</code> \u4e8b\u4ef6</li> <li>\u5982\u679c\u5728repmgr.conf\u4e2d\u914d\u7f6e\u4e86\u53c2\u6570<code>child_nodes_disconnect_command</code>\uff0crepmgrd\u4f1a\u5faa\u73af\u68c0\u6d4b\u6240\u6709\u8282\u70b9\uff0c\u5982\u679c\u68c0\u6d4b\u5230\u8fde\u63a5\u7684\u4ece\u8282\u70b9\u6570\u5c0f\u4e8e<code>child_nodes_connected_min_count</code> \uff08\u9ed8\u8ba4\u96f6\uff09\u5e76\u4e14\u8d85\u8fc7<code>child_nodes_disconnect_timeout</code>\uff08\u9ed8\u8ba430s\uff09\u6240\u6307\u5b9a\u7684\u65f6\u95f4\u65f6\uff0c\u89e6\u53d1          <code>child_nodes_disconnect_command</code> \u4e8b\u4ef6</li> <li>\u6ce8\u610f\u4e8b\u9879\uff0c\u5728 repmgrd \u542f\u52a8\u65f6\u6ca1\u6709\u8fde\u63a5\u7684\u5b50\u8282\u70b9\u4e0d\u4f1a\u88ab\u8ba4\u4e3a\u662f\u4e22\u5931\u7684\uff0c\u56e0\u4e3a repmgrd \u65e0\u6cd5\u77e5\u9053\u5b83\u4eec\u4e3a\u4ec0\u4e48\u6ca1\u6709\u88ab\u8fde\u63a5\u3002</li> </ul>"},{"location":"postgres/ha/repmgrd/#_10","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li> <p>\u5b50\u8282\u70b9\u914d\u7f6e\u4e3a\u5f52\u6863\u590d\u5236\u65f6</p> </li> <li> <p>\u5b50\u8282\u70b9\u7684primary_conninfo\u4fe1\u606f\u4e2d\u7684application_name\u4e0e\u8282\u70b9\u7684 repmgr.conf\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\u8282\u70b9\u540d\u79f0\u76f8\u540c\u3002\u6b64\u5916\uff0c\u8fd9\u4e2aapplication_name\u5728\u6574\u4e2a\u590d\u5236\u96c6\u7fa4\u4e2d\u5fc5\u987b\u662f\u552f\u4e00\u7684\u3002\u5982\u679c\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684application_name\uff0c\u6216\u8005application_name\u5728\u6574\u4e2a\u590d\u5236\u96c6\u7fa4\u4e2d\u4e0d\u662f\u552f\u4e00\u7684\uff0crepmgr\u5c06\u65e0\u6cd5\u53ef\u9760\u5730\u76d1\u63a7\u5b50\u8282\u70b9\u7684\u8fde\u63a5\u3002</p> </li> </ul>"},{"location":"postgres/ha/repmgrd/#_11","title":"\u914d\u7f6e\u53c2\u6570","text":"<ul> <li>child_nodes_check_interval  \u68c0\u6d4b\u95f4\u9694\u65f6\u95f4 \u9ed8\u8ba4\u503c5s</li> <li>child_nodes_disconnect_command \u81ea\u5b9a\u4e49\u811a\u672c</li> <li>child_nodes_disconnect_timeout  \u8d85\u65f6\u65f6\u95f4 \u9ed8\u8ba4\u503c30s</li> <li>child_nodes_connected_min_count  \u5b58\u6d3b\u4ece\u5e93\u7684\u6700\u5c0f\u503c\u3002\u5f53\u68c0\u6d4b\u5230\u5b58\u6d3b\u7684\u4ece\u8282\u70b9\u6570\u5c0f\u4e8e\u8be5\u503c\u65f6\uff0c\u89e6\u53d1child_nodes_disconnect_command \u4e8b\u4ef6\u3002</li> <li>child_nodes_disconnect_min_count \u4e22\u5931\u8282\u70b9\u7684\u6700\u5c0f\u503c\uff0c\u5f53\u4e22\u5931\u7684\u8282\u70b9\u6570\u5927\u4e8e\u8be5\u503c\u65f6\u89e6\u53d1child_nodes_disconnect_command \u4e8b\u4ef6\u3002</li> </ul> <p>\u6ce8\u610fchild_nodes_connected_min_count \u503c\u4f1a\u8986\u76d6child_nodes_disconnect_min_count\u3002\u5f53\u8fd9\u4e24\u4e2a\u53c2\u6570\u90fd\u672a\u8bbe\u7f6e\u65f6\u3002\u68c0\u6d4b\u5230\u4ece\u8282\u70b9\u5b58\u5728\u4e2a\u6570\u4e3a\u96f6\u65f6\u89e6\u53d1child_nodes_disconnect_command \u4e8b\u4ef6\u3002</p>"},{"location":"postgres/ha/repmgrd/#_12","title":"\u4e8b\u4ef6\u7c7b\u578b","text":"<ul> <li>child_node_disconnect</li> <li>child_node_reconnect</li> <li>child_node_new_connect</li> <li>child_nodes_disconnect_command</li> </ul>"},{"location":"postgres/ha/repmgrd/#_13","title":"\u67e5\u770b\u4e8b\u4ef6","text":"<pre><code>repmgr cluster event --event=xxxxx (\u4e8b\u4ef6\u7c7b\u578b)\n</code></pre>"},{"location":"postgres/ha/repmgrd/#repmgrd_2","title":"repmgrd \u914d\u7f6e","text":"<p>Postgresql \u914d\u7f6e postgressql.conf  \u9700\u8981\u91cd\u542f\u670d\u52a1</p> <pre><code>shared_preload_libraries = 'repmgr'\n</code></pre> <ul> <li> <p>monitor_interval_secs \u68c0\u6d4b\u4e0a\u6e38\u8282\u70b9\u65f6\u95f4\u95f4\u9694 \u9ed8\u8ba42\u79d2</p> </li> <li> <p>connection_check_type \u68c0\u6d4b\u7c7b\u578b PQping (default)\u3001connection\u3001query</p> </li> <li> <p>reconnect_attempts \u91cd\u8fde\u5c1d\u8bd5\u6b21\u6570 \u9ed8\u8ba46\u6b21</p> </li> <li> <p>reconnect_interval \u91cd\u8fde\u5c1d\u8bd5\u95f4\u9694\u65f6\u95f4</p> </li> <li> <p>degraded_monitoring_timeout \u9ed8\u8ba4-1 \u7981\u6b62\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0crepmgrd\u5c06\u65e0\u9650\u671f\u5730\u7ee7\u7eed\u5904\u4e8e\u964d\u7ea7\u76d1\u89c6\u6a21\u5f0f\u3002\u8bbe\u7f6e\u8be5\u53c2\u6570\u8d85\u65f6\uff08\u4ee5\u79d2\u4e3a\u5355\u4f4d\uff09\uff0c\u4e4b\u540erepmgrd\u5c06\u7ec8\u6b62\u3002</p> </li> </ul>"},{"location":"postgres/ha/repmgrd/#_14","title":"\u5fc5\u987b\u8bbe\u7f6e\u7684\u53c2\u6570","text":"<ul> <li><code>failover</code>      =automatic</li> <li><code>promote_command</code>   =/'usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file'</li> <li><code>follow_command</code>=  '/usr/bin/repmgr standby follow -f /etc/repmgr.conf --log-to-file --upstream-node-id=%n'</li> </ul>"},{"location":"postgres/ha/repmgrd/#_15","title":"\u53ef\u9009\u53c2\u6570","text":"<pre><code>priority\nfailover_validation_command\nprimary_visibility_consensus\nalways_promote\nstandby_disconnect_on_failover\nelection_rerun_interval\nsibling_nodes_disconnect_timeout\n</code></pre>"},{"location":"postgres/ha/repmgrd/#_16","title":"\u5176\u4ed6\u53c2\u6570","text":"<p>\u9664\u4e86\u4ee5\u4e0a\u914d\u7f6e\uff0cconninfo \u4e5f\u4f1a\u5f71\u54cd repmgr \u5982\u4f55\u4e0e PostgreSQL \u8fdb\u884c\u7f51\u7edc\u8fde\u63a5\uff0c\u5982\u53c2\u6570connect_timeout\u3002\u540c\u65f6\u4e5f\u53d7\u5230\u7cfb\u7edf\u7f51\u7edc\u8bbe\u7f6e  <code>tcp_syn_retries</code>\u5c06\u5f71\u54cd\u3002</p>"},{"location":"postgres/ha/repmgrd/#_17","title":"\u65e5\u5fd7\u81ea\u52a8\u5207\u5272","text":"<pre><code>  /var/log/repmgr/repmgrd.log {\n        missingok\n        compress\n        rotate 52\n        maxsize 100M\n        weekly\n        create 0600 postgres postgres\n        postrotate\n            /usr/bin/killall -HUP repmgrd\n        endscript\n    }\n</code></pre>"},{"location":"postgres/ha/repmgrd/#repmgrd_3","title":"repmgrd \u64cd\u4f5c","text":""},{"location":"postgres/ha/repmgrd/#repmgrd_4","title":"repmgrd \u7ef4\u62a4\u6a21\u5f0f","text":"<p>\u8fdb\u5165\u7ef4\u62a4\u6a21\u5f0f\u540e\uff0c\u5c06\u4e0d\u4f1a\u53d1\u751f\u81ea\u52a8\u6545\u969c\u8f6c\u79fb\u3002</p> <pre><code># \u7ef4\u62a4\u6a21\u5f0f\nrepmgr -f /etc/repmgr.conf service pause\n# \u89e3\u9664\u7ef4\u62a4\u6a21\u5f0f\nrepmgr -f /etc/repmgr.conf service unpause\n# \u67e5\u770b\u5f53\u524d\u6a21\u5f0f\nrepmgr -f /etc/repmgr.conf service status\n</code></pre> <p>\u6ce8\u610f: \u7ef4\u62a4\u6a21\u5f0f\u7684\u72b6\u6001\u4e0d\u4f1a\u56e0\u4e3a\u91cd\u542frepmgrd\u6216Postgresql\u670d\u52a1\u800c\u6539\u53d8\u3002</p> <p>\u5f53\u8fdb\u884cPostgresql \u7248\u672c\u5347\u7ea7\u65f6\uff0c\u8981\u5b8c\u5168\u5173\u95edrepmgrd \u670d\u52a1\u3002\u5e76\u4e14\u5b89\u88c5\u4e0e\u6570\u636e\u5e93\u5bf9\u5e94\u7684\u65b0\u7248\u672crepmgr\u3002</p> <p>\u624b\u52a8\u6545\u969c\u8f6c\u79fb<code>repmgr standby switchover</code> \u4f1a\u81ea\u52a8\u8fdb\u884c pause/unpause \u72b6\u6001\u5207\u6362\u3002</p> <p>\u5f53Postgresql\u6570\u636e\u5e93\u901a\u8fc7<code>pg_wal_replay_pause</code>\u5904\u4e8e\u6682\u505cwal\u65e5\u5fd7\u56de\u653e\u72b6\u6001\u65f6\uff0c\u6545\u969c\u8f6c\u79fb\u4f1a\u81ea\u52a8\u6062\u590dwal\u56de\u653e\u3002</p> <p>\u6ce8\u610f\u6267\u884crepmgr_standby_promote \u5c06\u88ab\u62d2\u7edd\uff0c\u76f4\u5230\u7ba1\u7406\u5458wal resumed\u6062\u590d\u56de\u653e\u3002</p>"},{"location":"postgres/ha/repmgrd/#_18","title":"\u964d\u7ea7\u6a21\u5f0f","text":"<p>\u5f53\u9047\u5230\u67d0\u4e9b\u60c5\u51b5\u65f6\u5c06\u8fdb\u5165 \"\u964d\u7ea7\u76d1\u63a7 \"\u6a21\u5f0f\uff0c\u5373 repmgrd \u4ecd\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\uff0c\u4f46\u5728\u7b49\u5f85\u60c5\u51b5\u7684\u89e3\u51b3\u3002</p> <p>\u60c5\u51b5\u5305\u62ec: \u5f53\u53d1\u751f\u6545\u969c\u65f6</p> <ul> <li>\u4e0e\u4e3b\u8282\u70b9\u4f4d\u4e8e\u540c\u4e00\u4e2a\u6570\u636e\u4e2d\u7684\u7684\u5176\u4ed6\u8282\u70b9\u90fd\u4e0d\u53ef\u89c1\u3002\u6839\u636elocation\u53c2\u6570</li> <li>\u6ca1\u6709\u53ef\u4ee5\u63d0\u5347\u4e3a\u4e3b\u8282\u70b9\u7684\u5019\u9009\u8282\u70b9</li> <li>\u5019\u9009\u8282\u70b9\u4e0d\u80fd\u88ab\u63d0\u5347\u4e3b\u8282\u70b9</li> <li>\u8282\u70b9\u4e0d\u80fd\u4f5c\u4e3a\u65b0\u4e3b\u8282\u70b9\u7684\u4ece\u8282\u70b9</li> <li>\u8282\u70b9\u6ca1\u6709\u8bbe\u7f6e\u81ea\u52a8\u6545\u969c\u8f6c\u79fb</li> <li>\u4e3b\u8282\u70b9\u6545\u969c\uff0c\u4f46\u662f\u6ca1\u5176\u4ed6\u8282\u70b9\u88ab\u63d0\u5347\u4e3a\u4e3b\u8282\u70b9</li> </ul> <p>\u9ed8\u8ba4\u60c5\u51b5\uff0c\u964d\u7ea7\u6a21\u5f0f\u5c06\u4e00\u81f4\u6301\u7eed\u4e0b\u53bb\u3002\u4f46\u5982\u679c\u8bbe\u7f6e\u4e86degraded_monitoring_timeout\u53c2\u6570\uff0c\u8d85\u8fc7\u6307\u5b9a\u503c\uff0crepmgrd\u5c06\u505c\u6b62\u8fd0\u884c\u3002</p>"},{"location":"postgres/ha/repmgrd/#_19","title":"\u76d1\u63a7\u6570\u636e\u5b58\u50a8","text":"<p>\u5f53\u53c2\u6570monitoring_history=true\u65f6\uff0c\u76d1\u63a7\u8bb0\u5f55\u6570\u636e\u5c06\u4f1a\u4e0d\u65ad\u7684\u5199\u5165\u5230<code>repmgr.monitoring_history</code>\u8868\u4e2d\u3002 \u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4<code>repmgr cluster cleanup -k/ --keep-history</code> (\u9009\u62e9\u9700\u8981\u4fdd\u7559\u8bb0\u5f55\u5929\u6570) \u5b9a\u671f\u6e05\u7406\u6570\u636e\u3002</p> <p>\u8fd9\u4e9b\u6570\u636e\u4e5f\u4f1a\u590d\u5236\u5230\u4ece\u8282\u70b9\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e<code>ALTER TABLE repmgr.monitoring_history SET UNLOGGED;</code> \u4f7f\u6570\u636e\u4e0d\u590d\u5236\u5230\u4ece\u8282\u70b9\u3002</p>"},{"location":"postgres/ha/repmgrd/#_20","title":"\u9009\u4e3e\u6d41\u7a0b\u7b80\u4ecb","text":"<p>\u6e90\u7801\u4f4d\u7f6e <code>repmgrd-physical.c</code></p> <p>\u5f53primary \u8282\u70b9\u88ab\u68c0\u6d4b\u5230\u53d1\u751f\u6545\u969c\uff0c\u8fdb\u5165\u9009\u4e3e\u9636\u6bb5\u65f6\u7684\u5927\u6982\u6d41\u7a0b\u3002</p> <pre><code>/*\n * Failover decision for nodes attached to the current primary.\n *\n * NB: this function sets \"sibling_nodes\"; caller (do_primary_failover)\n * expects to be able to read this list\n */\n# \u9009\u4e3e\u6d41\u7a0b Postgresql \u652f\u6301\u7ea7\u8054\u590d\u5236\u3002\u65b0\u7684\u4e3b\u8282\u70b9\u53ea\u80fd\u5728\u4e00\u7ea7\u5b50\u8282\u70b9\u4e2d\u4ea7\u751f\u3002\n#  sibling_nodes \u5144\u5f1f\u8282\u70b9\nstatic ElectionResult\ndo_election(NodeInfoList *sibling_nodes, int *new_primary_id)\n{\n    int         electoral_term = -1;\n    #\n    NodeInfoListCell *cell = NULL;\n# \n    t_node_info *candidate_node = NULL;\n# \u9009\u4e3e\u72b6\u6001\n    election_stats stats;\n\n    ReplInfo    local_replication_info;\n\n    /* To collate details of nodes with primary visible for logging purposes */\n    PQExpBufferData nodes_with_primary_visible;\n\n    /*\n     * Check if at least one server in the primary's location is visible; if\n     * not we'll assume a network split between this node and the primary\n     * location, and not promote any standby.\n     *\n     * NOTE: this function is only ever called by standbys attached to the\n     * current (unreachable) primary, so \"upstream_node_info\" will always\n     * contain the primary node record.\n     */\n    # \u6839\u636e\u662f\u5426\u5b58\u5728\u4e0e\u6545\u969c\u8282\u70b9\u4f4d\u7f6e\u76f8\u540c\u7684\u53ef\u89c1\u8282\u70b9\u3002\u5982\u679c\u90fd\u4e3a\u4e0d\u53ef\u89c1\u72b6\u6001\uff0c\u5219\u8ba4\u4e3a\u662f\u7f51\u7edc\u95ee\u9898\u3002PS: \u6bcf\u4e2a\u8282\u70b9\u53ef\u914d\u7f6elocation \u53c2\u6570\u6307\u5b9a\u6240\u5728\u7684\u7269\u7406\u4f4d\u7f6e\u3002\u5982\u591a\u6570\u636e\u4e2d\u5fc3\u573a\u666f\n    bool        primary_location_seen = false;\n\n    int         nodes_with_primary_still_visible = 0;\n\n    if (config_file_options.failover_delay &gt; 0)\n    {\n        log_debug(\"sleeping %i seconds (\\\"failover_delay\\\") before initiating failover\",\n                  config_file_options.failover_delay);\n        sleep(config_file_options.failover_delay);\n    }\n\n    /* we're visible */ \n    #\u53ef\u89c1\u8282\u70b9\u6570\n    stats.visible_nodes = 1;\n    #\u4e0e\u5f53\u524dnode\u4e3a\u76f8\u540c\u4e0a\u6e38\u7684\u8282\u70b9\u6570 shared_upstream_nodes = sibling_nodes + 1(\u5f53\u524d\u8282\u70b9)\n    stats.shared_upstream_nodes = 0;\n    # \u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u6570\n    stats.all_nodes = 0;\n    # SELECT term FROM repmgr.voting_term; \u521d\u59cb\u503c\u4e3a1 , \u6267\u884crepmgr standby promote\u52a0\u4e00\n    electoral_term = get_current_term(local_conn);\n\n    if (electoral_term == -1)\n    {\n        log_error(_(\"unable to determine electoral term\"));\n\n        return ELECTION_NOT_CANDIDATE;\n    }\n\n    log_debug(\"do_election(): electoral term is %i\", electoral_term);\n   # \u5982\u679crepmgr.conf\u4e2dfailover\u53c2\u6570\u8bbe\u7f6e\u4e3amanual ,\u8be5\u8282\u70b9\u4e0d\u53c2\u4e0e\u9009\u4e3e\n    if (config_file_options.failover == FAILOVER_MANUAL)\n    {\n        log_notice(_(\"this node is not configured for automatic failover so will not be considered as promotion candidate, and will not follow the new primary\"));\n        log_detail(_(\"\\\"failover\\\" is set to \\\"manual\\\" in repmgr.conf\"));\n        log_hint(_(\"manually execute \\\"repmgr standby follow\\\" to have this node follow the new primary\"));\n\n        return ELECTION_NOT_CANDIDATE;\n    }\n#\u5982\u679c\u8bbe\u7f6epriority\u4e3a0 \uff0c\u8be5\u8282\u70b9\u4e0d\u53c2\u4e0e\u9009\u4e3e \u3002\u89c1\u8bc1\u8282\u70b9\u7684priority=0\u3002 \u53ca\u89c1\u8bc1\u8282\u70b9\u5230\u8fd9\u91cc\u5df2\u7ecf\u51fa\u5c40\n    /* node priority is set to zero - don't become a candidate, and lose by default */\n    if (local_node_info.priority &lt;= 0)\n    {\n        log_notice(_(\"this node's priority is %i so will not be considered as an automatic promotion candidate\"),\n                   local_node_info.priority);\n\n        return ELECTION_LOST;\n    }\n    #\u8be5\u65b9\u6cd5 SQL \u67e5\u8be2 \u89c6\u56ferepmgr.nodes ,\u83b7\u53d6\u5144\u5f1f\u8282\u70b9\u3002\u4f55\u4e3a\u5144\u5f1f\uff0c\u4e0e\u5f53\u524d\u8282\u70b9\u4e0a\u6e38\u8282\u70b9\u76f8\u540c\u7684\u8282\u70b9\uff0c\u4e0d\u5305\u62ec\u81ea\u8eab\u3002\n    # \u6ce8\u610f\u4e00\u70b9\u3002 \u89c1\u8bc1\u8282\u70b9\u7684\u4e5f\u7b97\u5728\u5144\u5f1f\u8282\u70b9\u4e2d\u3002\u56e0\u4e3a\u5728nodes\u8868\u4e2d\u4ed6\u4eec\u7684upstream_node_id \u76f8\u540c \n    # SELECT REPMGR_NODES_COLUMNS FROM repmgr.nodes n  WHERE n.upstream_node_id = %i  AND n.node_id != %i    AND n.active IS TRUE ORDER BY n.node_id  \n    /* get all active nodes attached to upstream, excluding self */\n    get_active_sibling_node_records(local_conn,\n                                    local_node_info.node_id,\n                                    upstream_node_info.node_id,\n                                    sibling_nodes);\n\n    log_info(_(\"%i active sibling nodes registered\"), sibling_nodes-&gt;node_count);\n\n    stats.shared_upstream_nodes = sibling_nodes-&gt;node_count + 1;\n    #\u83b7\u53d6\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u6570\u91cf SELECT count(*) FROM repmgr.nodes n \n    get_all_nodes_count(local_conn, &amp;stats.all_nodes);\n\n    log_info(_(\"%i total nodes registered\"), stats.all_nodes);\n    #\u5224\u65ad\u8bb0\u5f55\u5f53\u524d\u8282\u70b9\u4f4d\u7f6e\u662f\u5426\u4e0e \u4e0a\u6e38\u8282\u70b9\uff08\u4e3b\u8282\u70b9\uff09\u4f4d\u7f6e\u76f8\u540c\n    if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) != 0)\n    {\n        log_info(_(\"primary node \\\"%s\\\" (ID: %i) has location \\\"%s\\\", this node's location is \\\"%s\\\"\"),\n                 upstream_node_info.node_name,\n                 upstream_node_info.node_id,\n                 upstream_node_info.location,\n                 local_node_info.location);\n    }\n    else \n    {\n        log_info(_(\"primary node  \\\"%s\\\" (ID: %i) and this node have the same location (\\\"%s\\\")\"),\n                 upstream_node_info.node_name,\n                 upstream_node_info.node_id,\n                 local_node_info.location);\n    }\n\n    local_node_info.last_wal_receive_lsn = InvalidXLogRecPtr;\n    # \u6ca1\u6709\u5144\u5f1f\u8282\u70b9\uff0c\u6ca1\u6709\u89c1\u8bc1\u8282\u70b9\uff0c\u72ec\u751f\u5b50\u3002\u5982\u679c\u4e0e\u4e3b\u8282\u70b9\u4f4d\u7f6e\u76f8\u540c\u76f4\u63a5\u7ee7\u627f\u738b\u4f4d\uff0c\u6c5f\u6e56\u4e2d\u7684\u6253\u6253\u6740\u6740\u5728\u8fd9\u91cc\u4e0d\u5b58\u5728\u3002\n    /* fast path if no other standbys (or witness) exists - normally win by default */\n    if (sibling_nodes-&gt;node_count == 0)\n    {   # \u6bd4\u8f83\u4e0a\u6e38\u8282\u70b9\uff08\u539f\u4e3b\u8282\u70b9\uff09\u4e0e\u5f53\u524d\u8282\u70b9\u7684\u4f4d\u7f6e\uff0c\u5982\u679c\u76f8\u540c\n        if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) == 0)\n        {# \u5347\u7ea7\u4e3a\u4e3b\u670d\u52a1\u524d\u7684\u914d\u7f6e\u7684\u9a8c\u8bc1\u811a\u672c\uff0c\u662f\u5426\u8fd4\u56de\u503c\u4e3a0\n            if (config_file_options.failover_validation_command[0] != '\\0')\n            { \n                return execute_failover_validation_command(&amp;local_node_info, &amp;stats);\n            }\n\n            log_info(_(\"no other sibling nodes - we win by default\"));\n          # \u80dc\u51fa\uff0c\u65b0\u738b\u8bde\u751f\u3002\n            return ELECTION_WON;\n        }\n        else\n        {\n            /*\n             * If primary and standby have different locations set, the assumption\n             * is that no action should be taken as we can't tell whether there's\n             * been a network interruption or not.\n             *\n             * Normally a situation with primary and standby in different physical\n             * locations would be handled by leaving the location as \"default\" and\n             * setting up a witness server in the primary's location.\n             */\n            log_debug(\"no other nodes, but primary and standby locations differ\");\n           # \u867d\u7136\u53ea\u6709\u4e00\u4e2a\u4ece\u8282\u70b9\uff0c\u4f46\u662f\u4e0e\u4e3b\u8282\u70b9\u7684\u4f4d\u7f6e\u4e0d\u540c\uff0c\u4e0d\u80fd\u8fdb\u884c\u5347\u7ea7\u3002\u96c6\u7fa4\u8fdb\u884c\u964d\u7ea7\u5904\u7406\u3002\u5f88\u9057\u61be\u3002\n           # \u76f8\u5f53\u4e8e \u4e3b\u8282\u70b9\u76f8\u540c\u4f4d\u7f6e\u7684\u8282\u70b9\u90fd\u4e0d\u53ef\u89c1\u3002\u88ab\u8ba4\u4e3a\u7f51\u7edc\u5206\u533a\u6545\u969c\u3002\n            monitoring_state = MS_DEGRADED;\n            INSTR_TIME_SET_CURRENT(degraded_monitoring_start);\n\n            return ELECTION_NOT_CANDIDATE;\n        }\n    }\n    # \u5f53\u6709\u591a\u4e2a\u5144\u5f1f\u7684\u65f6\u5019\n    else \n    {\n        /* standby nodes found - check if we're in the primary location before checking theirs */ # \u5f53\u524d\u8282\u70b9\u662f\u5426\u4e0e\u4e3b\u8282\u70b9\u4f4d\u7f6e\u76f8\u540c\n        if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) == 0)\n        {   # \u5b58\u5728\u4e0e\u4e3b\u8282\u70b9\u4f4d\u7f6e\u76f8\u540c\u7684\u76f4\u63a5\u4ece\u8282\u70b9\n            primary_location_seen = true;\n        }\n    }\n\n    /* get our lsn */ # \n    if (get_replication_info(local_conn, STANDBY, &amp;local_replication_info) == false)\n    {\n        log_error(_(\"unable to retrieve replication information for local node\"));\n        return ELECTION_LOST;\n    }\n     # wal \u56de\u653e\u72b6\u6001\u4e3a paused \uff0c\u5c1d\u8bd5\u6062\u590dwal\u56de\u653e\u72b6\u6001 , resume\u5931\u8d25 \u5f53\u524d\u8282\u70b9\u4e0d\u53c2\u4e0e\u9009\u4e3e\n    /* check if WAL replay on local node is paused */\n    if (local_replication_info.wal_replay_paused == true)\n    {\n        log_debug(\"WAL replay is paused\");\n        if (local_replication_info.last_wal_receive_lsn &gt; local_replication_info.last_wal_replay_lsn)\n        {\n            log_warning(_(\"WAL replay on this node is paused and WAL is pending replay\"));\n            log_detail(_(\"replay paused at %X/%X; last WAL received is %X/%X\"),\n                       format_lsn(local_replication_info.last_wal_replay_lsn),\n                       format_lsn(local_replication_info.last_wal_receive_lsn));\n        }\n        # \u5c1d\u8bd5\u6062\u590dwal\u72b6\u6001\n        /* attempt to resume WAL replay - unlikely this will fail, but just in case */\n        if (resume_wal_replay(local_conn) == false)\n        {\n            log_error(_(\"unable to resume WAL replay\"));\n            log_detail(_(\"this node cannot be reliably promoted\"));\n            # resume \u5931\u8d25\uff0c\u8be5\u8282\u70b9\u4e0d\u53c2\u4e0e\u9009\u4e3e\n            return ELECTION_LOST;\n        }\n\n        log_notice(_(\"WAL replay forcibly resumed\"));\n    }\n\n    local_node_info.last_wal_receive_lsn = local_replication_info.last_wal_receive_lsn;\n\n    log_info(_(\"local node's last receive lsn: %X/%X\"), format_lsn(local_node_info.last_wal_receive_lsn));\n\n    /* pointer to \"winning\" node, initially self */\n    candidate_node = &amp;local_node_info;\n\n    initPQExpBuffer(&amp;nodes_with_primary_visible);\n   # \u4f17\u5019\u9009\u8282\u70b9\u8fdb\u5165\u9009\u4e3e\u4f1a\u573a\uff0c\u5f00\u59cb\u53ae\u6740\u3002\n    for (cell = sibling_nodes-&gt;head; cell; cell = cell-&gt;next)\n    {\n        ReplInfo    sibling_replication_info;\n\n        log_info(_(\"checking state of sibling node \\\"%s\\\" (ID: %i)\"),\n                 cell-&gt;node_info-&gt;node_name,\n                 cell-&gt;node_info-&gt;node_id);\n\n        /* assume the worst case */\n        cell-&gt;node_info-&gt;node_status = NODE_STATUS_UNKNOWN;\n\n        cell-&gt;node_info-&gt;conn = establish_db_connection(cell-&gt;node_info-&gt;conninfo, false);\n\n        if (PQstatus(cell-&gt;node_info-&gt;conn) != CONNECTION_OK)\n        {\n            close_connection(&amp;cell-&gt;node_info-&gt;conn);\n\n            continue;\n        }\n\n        cell-&gt;node_info-&gt;node_status = NODE_STATUS_UP;\n\n        stats.visible_nodes++;\n\n        /*\n         * see if the node is in the primary's location (but skip the check if\n         * we've seen a node there already)\n         */\n        if (primary_location_seen == false)\n        {\n            if (strncmp(cell-&gt;node_info-&gt;location, upstream_node_info.location, MAXLEN) == 0)\n            {\n                log_debug(\"node %i in primary location \\\"%s\\\"\",\n                          cell-&gt;node_info-&gt;node_id,\n                          cell-&gt;node_info-&gt;location);\n                primary_location_seen = true;\n            }\n        }\n\n        /*\n         * check if repmgrd running - skip if not\n         *\n         * TODO: include pid query in replication info query?\n         *\n         * NOTE: from Pg12 we could execute \"pg_promote()\" from a running repmgrd;\n         * here we'll need to find a way of ensuring only one repmgrd does this\n         */\n        if (repmgrd_get_pid(cell-&gt;node_info-&gt;conn) == UNKNOWN_PID)\n        {\n            log_warning(_(\"repmgrd not running on node \\\"%s\\\" (ID: %i), skipping\"),\n                        cell-&gt;node_info-&gt;node_name,\n                        cell-&gt;node_info-&gt;node_id);\n            continue;\n        }\n\n        if (get_replication_info(cell-&gt;node_info-&gt;conn, cell-&gt;node_info-&gt;type, &amp;sibling_replication_info) == false)\n        {\n            log_warning(_(\"unable to retrieve replication information for node \\\"%s\\\" (ID: %i), skipping\"),\n                        cell-&gt;node_info-&gt;node_name,\n                        cell-&gt;node_info-&gt;node_id);\n            continue;\n        }\n\n        /*\n         * Check if node is not in recovery - it may have been promoted\n         * outside of the failover mechanism, in which case we may be able\n         * to follow it.\n         */\n\n        # \u6709\u5144\u5f1f\u8282\u70b9\u88ab\u624b\u52a8\u63d0\u5347\u4e3a\u4e3b\u8282\u70b9\n        if (sibling_replication_info.in_recovery == false &amp;&amp; cell-&gt;node_info-&gt;type != WITNESS)\n        {\n            bool can_follow;\n\n            log_warning(_(\"node \\\"%s\\\" (ID: %i) is not in recovery\"),\n                        cell-&gt;node_info-&gt;node_name,\n                        cell-&gt;node_info-&gt;node_id);\n\n            /*\n             * Node is not in recovery, but still reporting an upstream\n             * node ID; possible it was promoted manually (e.g. with \"pg_ctl promote\"),\n             * or (less likely) the node's repmgrd has just switched to primary\n             * monitoring node but has not yet unset the upstream node ID in\n             * shared memory. Either way, log this.\n             */\n            if (sibling_replication_info.upstream_node_id != UNKNOWN_NODE_ID)\n            {\n                log_warning(_(\"node \\\"%s\\\" (ID: %i) still reports its upstream is node %i, last seen %i second(s) ago\"),\n                            cell-&gt;node_info-&gt;node_name,\n                            cell-&gt;node_info-&gt;node_id,\n                            sibling_replication_info.upstream_node_id,\n                            sibling_replication_info.upstream_last_seen);\n            }\n            #\u68c0\u9a8c\u5f53\u524d\u8282\u70b9\u662f\u5426\u80fdfollow \u88ab\u63d0\u5347\u7684\u5144\u5f1f\u8282\u70b9\n            can_follow = check_node_can_follow(local_conn,\n                                               local_node_info.last_wal_receive_lsn,\n                                               cell-&gt;node_info-&gt;conn,\n                                               cell-&gt;node_info);\n            # \u5728\u9009\u4e3e\u7ed3\u679c\u524d\u6709\u8282\u70b9\u624b\u52a8\u63d0\u5347\u8282\u70b9\u4e3a\u4e3b\u8282\u70b9\u3002\u5e76\u4e14\u5f53\u524d\u8282\u70b9\u53ef\u4ee5follower\u3002\u5f53\u524d\u8282\u70b9\u4e0d\u5728\u53c2\u4e0e\u9009\u4e3e\n            if (can_follow == true)\n            {\n                *new_primary_id = cell-&gt;node_info-&gt;node_id;\n                termPQExpBuffer(&amp;nodes_with_primary_visible);\n                return ELECTION_CANCELLED;\n            }\n            # \u5982\u679c\u4e0d\u80fdfollower\u4e3b\u8282\u70b9\u3002\u8fd9\u79cd\u60c5\u51b5\u4f1a\u5f88\u68d8\u624b\u3002\n            /*\n             * Tricky situation here - we'll assume the node is a rogue primary\n             */\n            log_warning(_(\"not possible to attach to node \\\"%s\\\" (ID: %i), ignoring\"),\n                        cell-&gt;node_info-&gt;node_name,\n                        cell-&gt;node_info-&gt;node_id);\n            continue;\n        }\n        else\n        {\n            log_info(_(\"node \\\"%s\\\" (ID: %i) reports its upstream is node %i, last seen %i second(s) ago\"),\n                     cell-&gt;node_info-&gt;node_name,\n                     cell-&gt;node_info-&gt;node_id,\n                     sibling_replication_info.upstream_node_id,\n                     sibling_replication_info.upstream_last_seen);\n        }\n\n        /* check if WAL replay on node is paused */\n        if (sibling_replication_info.wal_replay_paused == true)\n        {\n            /*\n             * Theoretically the repmgrd on the node should have resumed WAL play\n             * at this point.\n             */\n            if (sibling_replication_info.last_wal_receive_lsn &gt; sibling_replication_info.last_wal_replay_lsn)\n            {\n                log_warning(_(\"WAL replay on node \\\"%s\\\" (ID: %i) is paused and WAL is pending replay\"),\n                            cell-&gt;node_info-&gt;node_name,\n                            cell-&gt;node_info-&gt;node_id);\n            }\n        }\n\n        /*\n         * Check if node has seen primary \"recently\" - if so, we may have \"partial primary visibility\".\n         * For now we'll assume the primary is visible if it's been seen less than\n         * monitor_interval_secs * 2 seconds ago. We may need to adjust this, and/or make the value\n         * configurable.\n         */\n\n        if (sibling_replication_info.upstream_last_seen &gt;= 0 &amp;&amp; sibling_replication_info.upstream_last_seen &lt; (config_file_options.monitor_interval_secs * 2))\n        {\n            if (sibling_replication_info.upstream_node_id != upstream_node_info.node_id)\n            {\n                log_warning(_(\"assumed sibling node \\\"%s\\\" (ID: %i) monitoring different upstream node %i\"),\n                            cell-&gt;node_info-&gt;node_name,\n                            cell-&gt;node_info-&gt;node_id,\n                            sibling_replication_info.upstream_node_id);\n\n            }\n            else\n            {\n                nodes_with_primary_still_visible++;\n                log_notice(_(\"%s node \\\"%s\\\" (ID: %i) last saw primary node %i second(s) ago, considering primary still visible\"),\n                           get_node_type_string(cell-&gt;node_info-&gt;type),\n                           cell-&gt;node_info-&gt;node_name,\n                           cell-&gt;node_info-&gt;node_id,\n                           sibling_replication_info.upstream_last_seen);\n                appendPQExpBuffer(&amp;nodes_with_primary_visible,\n                                  \" - node \\\"%s\\\" (ID: %i): %i second(s) ago\\n\",\n                                  cell-&gt;node_info-&gt;node_name,\n                                  cell-&gt;node_info-&gt;node_id,\n                                  sibling_replication_info.upstream_last_seen);\n            }\n        }\n        else\n        {\n            log_info(_(\"%s node \\\"%s\\\" (ID: %i) last saw primary node %i second(s) ago\"),\n                     get_node_type_string(cell-&gt;node_info-&gt;type),\n                     cell-&gt;node_info-&gt;node_name,\n                     cell-&gt;node_info-&gt;node_id,\n                     sibling_replication_info.upstream_last_seen);\n        }\n\n        # \u89c1\u8bc1\u8282\u70b9\u4e0d\u53c2\u4e0e\u9009\u4e3e\n        /* don't interrogate a witness server */\n        if (cell-&gt;node_info-&gt;type == WITNESS)\n        {\n            log_debug(\"node %i is witness, not querying state\", cell-&gt;node_info-&gt;node_id);\n            continue;\n        }\n        # priority=0 \u7684\u8282\u70b9\u4e0d\u53c2\u4e0e\u9009\u4e3e\n        /* don't check 0-priority nodes */\n        if (cell-&gt;node_info-&gt;priority &lt;= 0)\n        {\n            log_info(_(\"node \\\"%s\\\" (ID: %i) has priority of %i, skipping\"),\n                       cell-&gt;node_info-&gt;node_name,\n                       cell-&gt;node_info-&gt;node_id,\n                       cell-&gt;node_info-&gt;priority);\n            continue;\n        }\n\n\n        /* get node's last receive LSN - if \"higher\" than current winner, current node is candidate */\n        cell-&gt;node_info-&gt;last_wal_receive_lsn = sibling_replication_info.last_wal_receive_lsn;\n\n        log_info(_(\"last receive LSN for sibling node \\\"%s\\\" (ID: %i) is: %X/%X\"),\n                 cell-&gt;node_info-&gt;node_name,\n                 cell-&gt;node_info-&gt;node_id,\n                 format_lsn(cell-&gt;node_info-&gt;last_wal_receive_lsn));\n\n        /* compare LSN */ # \u6bd4\u8f83LSN\n        if (cell-&gt;node_info-&gt;last_wal_receive_lsn &gt; candidate_node-&gt;last_wal_receive_lsn)\n        {\n            /* other node is ahead */\n            log_info(_(\"node \\\"%s\\\" (ID: %i) is ahead of current candidate \\\"%s\\\" (ID: %i)\"),\n                     cell-&gt;node_info-&gt;node_name,\n                     cell-&gt;node_info-&gt;node_id,\n                     candidate_node-&gt;node_name,\n                     candidate_node-&gt;node_id);\n\n            candidate_node = cell-&gt;node_info;\n        }\n        # LSN \u76f8\u540c\u6bd4\u8f83 priority,priority\u4e5f\u76f8\u540c\u7136\u540e\u6bd4\u8f83 node_id\n        /* LSN is same - tiebreak on priority, then node_id */\n        #LSN \u5bf9\u6bd4\n        else if (cell-&gt;node_info-&gt;last_wal_receive_lsn == candidate_node-&gt;last_wal_receive_lsn)\n        {\n            log_info(_(\"node \\\"%s\\\" (ID: %i) has same LSN as current candidate \\\"%s\\\" (ID: %i)\"),\n                     cell-&gt;node_info-&gt;node_name,\n                     cell-&gt;node_info-&gt;node_id,\n                     candidate_node-&gt;node_name,\n                     candidate_node-&gt;node_id);\n            #priority \u5bf9\u6bd4\n            if (cell-&gt;node_info-&gt;priority &gt; candidate_node-&gt;priority)\n            {\n                log_info(_(\"node \\\"%s\\\" (ID: %i) has higher priority (%i) than current candidate \\\"%s\\\" (ID: %i) (%i)\"),\n                         cell-&gt;node_info-&gt;node_name,\n                         cell-&gt;node_info-&gt;node_id,\n                         cell-&gt;node_info-&gt;priority,\n                         candidate_node-&gt;node_name,\n                         candidate_node-&gt;node_id,\n                         candidate_node-&gt;priority);\n\n                candidate_node = cell-&gt;node_info;\n            }\n            else if (cell-&gt;node_info-&gt;priority == candidate_node-&gt;priority)\n            {\n                if (cell-&gt;node_info-&gt;node_id &lt; candidate_node-&gt;node_id)\n                {\n                    log_info(_(\"node \\\"%s\\\" (ID: %i) has same priority but lower node_id than current candidate \\\"%s\\\" (ID: %i)\"),\n                             cell-&gt;node_info-&gt;node_name,\n                             cell-&gt;node_info-&gt;node_id,\n                             candidate_node-&gt;node_name,\n                             candidate_node-&gt;node_id);\n\n                    candidate_node = cell-&gt;node_info;\n                }\n            }\n            else\n            {\n                log_info(_(\"node \\\"%s\\\" (ID: %i) has lower priority (%i) than current candidate \\\"%s\\\" (ID: %i) (%i)\"),\n                         cell-&gt;node_info-&gt;node_name,\n                         cell-&gt;node_info-&gt;node_id,\n                         cell-&gt;node_info-&gt;priority,\n                         candidate_node-&gt;node_name,\n                         candidate_node-&gt;node_id,\n                         candidate_node-&gt;priority);\n            }\n        }\n    }\n    # \u7f51\u7edc\u5206\u533a\uff0c\u964d\u7ea7\u3002\n    if (primary_location_seen == false)\n    {\n        log_notice(_(\"no nodes from the primary location \\\"%s\\\" visible - assuming network split\"),\n                   upstream_node_info.location);\n        log_detail(_(\"node will enter degraded monitoring state waiting for reconnect\"));\n\n        monitoring_state = MS_DEGRADED;\n        INSTR_TIME_SET_CURRENT(degraded_monitoring_start);\n\n        reset_node_voting_status();\n\n        termPQExpBuffer(&amp;nodes_with_primary_visible);\n\n        return ELECTION_CANCELLED;\n    }\n    # \u4e3b\u8282\u70b9\u4ecd\u53ef\u89c1\n    if (nodes_with_primary_still_visible &gt; 0)\n    {\n        log_info(_(\"%i nodes can see the primary\"),\n                   nodes_with_primary_still_visible);\n\n        log_detail(_(\"following nodes can see the primary:\\n%s\"),\n                   nodes_with_primary_visible.data);\n        #\u4e3b\u8282\u70b9\u53ef\u89c1\u6027\u5171\u8bc6\n        if (config_file_options.primary_visibility_consensus == true)\n        {\n            log_notice(_(\"cancelling failover as some nodes can still see the primary\"));\n            monitoring_state = MS_DEGRADED;\n            INSTR_TIME_SET_CURRENT(degraded_monitoring_start);\n\n            reset_node_voting_status();\n\n            termPQExpBuffer(&amp;nodes_with_primary_visible);\n\n            return ELECTION_CANCELLED;\n        }\n    }\n\n    termPQExpBuffer(&amp;nodes_with_primary_visible);\n\n    log_info(_(\"visible nodes: %i; total nodes: %i; no nodes have seen the primary within the last %i seconds\"),\n             stats.visible_nodes,\n             stats.shared_upstream_nodes,\n             (config_file_options.monitor_interval_secs * 2));\n    # \u540c\u7ea7\u8282\u70b9\u4e2d\u5927\u90e8\u5206\u4e0d\u53ef\u89c1\uff0c\u4e0d\u53c2\u4e0e\u9009\u4e3e\n    if (stats.visible_nodes &lt;= (stats.shared_upstream_nodes / 2.0))\n    {\n        log_notice(_(\"unable to reach a qualified majority of nodes\"));\n        log_detail(_(\"node will enter degraded monitoring state waiting for reconnect\"));\n\n        monitoring_state = MS_DEGRADED;\n        INSTR_TIME_SET_CURRENT(degraded_monitoring_start);\n\n        reset_node_voting_status();\n\n        return ELECTION_CANCELLED;\n    }\n\n    log_notice(_(\"promotion candidate is \\\"%s\\\" (ID: %i)\"),\n               candidate_node-&gt;node_name,\n               candidate_node-&gt;node_id);\n   # \u65b0\u9009\u51fa\u7684\u8282\u70b9\u4e3a\u5f53\u524d\u8282\u70b9\n    if (candidate_node-&gt;node_id == local_node_info.node_id)\n    {\n        /*\n         * If \"failover_validation_command\" is set, execute that command\n         * and decide the result based on the command's output\n         */\n      # \u9a8c\u8bc1failover_validation_command \u811a\u672c\u7684\u6267\u884c\n        if (config_file_options.failover_validation_command[0] != '\\0')\n        {\n            return execute_failover_validation_command(candidate_node, &amp;stats);\n        }\n        # \u5f53\u524d\u8282\u70b9\u5ba3\u5e03\u80dc\u51fa\uff0c\u4e3a\u4e3b\u8282\u70b9\n        return ELECTION_WON;\n    }\n\n    return ELECTION_LOST;\n}if (primary_location_seen == false)\n    {\n        log_notice(_(\"no nodes from the primary location \\\"%s\\\" visible - assuming network split\"),\n                   upstream_node_info.location);\n        log_detail(_(\"node will enter degraded monitoring state waiting for reconnect\"));\n\n        monitoring_state = MS_DEGRADED;\n        INSTR_TIME_SET_CURRENT(degraded_monitoring_start);\n\n        reset_node_voting_status();\n\n        termPQExpBuffer(&amp;nodes_with_primary_visible);\n\n        return ELECTION_CANCELLED;\n    }\n\n    if (nodes_with_primary_still_visible &gt; 0)\n    {\n        log_info(_(\"%i nodes can see the primary\"),\n                   nodes_with_primary_still_visible);\n\n        log_detail(_(\"following nodes can see the primary:\\n%s\"),\n                   nodes_with_primary_visible.data);\n\n        if (config_file_options.primary_visibility_consensus == true)\n        {\n            log_notice(_(\"cancelling failover as some nodes can still see the primary\"));\n            monitoring_state = MS_DEGRADED;\n            INSTR_TIME_SET_CURRENT(degraded_monitoring_start);\n\n            reset_node_voting_status();\n\n            termPQExpBuffer(&amp;nodes_with_primary_visible);\n\n            return ELECTION_CANCELLED;\n        }\n    }\n</code></pre>"},{"location":"postgres/ha/repmgrd/#_21","title":"\u603b\u7ed3","text":"<p><code>\u9009\u4e3e\u7ed3\u679c\u72b6\u6001</code></p> <pre><code>ELECTION_NOT_CANDIDAT\nELECTION_WON\nELECTION_LOST\nELECTION_CANCELLED\nELECTION_RERUN\n</code></pre> <p>\u6839\u636elocation \u6216 winess\u8282\u70b9\u51b3\u5b9a\u96c6\u7fa4\u662f\u5426\u5904\u4e8e\u7f51\u7edc\u5206\u533a\u72b6\u6001\uff0c\u8fdb\u5165\u9009\u4e3e\u6216\u964d\u7ea7\u6a21\u5f0f\u3002</p> <p>\u5f53\u53ea\u6709\u4e00\u4e2a\u4e00\u7ea7\u4ece\u8282\u70b9</p> <ul> <li>\u4ece\u8282\u70b9\u539f\u4e3b\u8282\u70b9\u4f4d\u7f6e\u76f8\u540c\u76f4\u63a5\u9009\u4e3e\u6210\u529f\u3002</li> <li>\u4ece\u8282\u70b9\u4e0e\u539f\u4e3b\u8282\u70b9\u4f4d\u7f6e\u4e0d\u540c\u4e14\u6ca1\u6709\u89c1\u8bc1\u8282\u70b9\u5219\u964d\u7ea7\u3002</li> </ul> <p>\u4e0d\u53c2\u4e0e\u9009\u4e3e\u7684\u8282\u70b9</p> <ul> <li>Priority=0</li> <li>repmgr.conf\u4e2dfailover\u53c2\u6570\u8bbe\u7f6e\u4e3amanual</li> <li>wal \u5904\u4e8e pause \u72b6\u6001\u5c06\u88abresume\u3002\u4f46resume\u5931\u8d25</li> </ul> <p>Repmgr\u9009\u4e3e\u5019\u9009\u5907\u8282\u70b9\u4f1a\u4ee5\u4ee5\u4e0b\u987a\u5e8f\u9009\u4e3e\uff1aLSN-&gt; Priority-&gt; Node_ID\u3002</p>"},{"location":"postgres/ha/repmgrd/#_22","title":"\u6d41\u7a0b\u56fe","text":""},{"location":"postgres/ha/repmgrd/#_23","title":"\u529f\u80fd\u589e\u5f3a","text":"<p>\u5982\u4f55\u5c06repmgrd\u771f\u6b63\u6295\u5165\u5230\u751f\u4ea7\u4e2d\uff0c\u771f\u6b63\u7684\u843d\u5730\u3002\u9762\u5bf9\u67d0\u4e9bCASES\u65f6\u4ecd\u80fd\u6ee1\u8db3HA\u8981\u6c42</p>"},{"location":"postgres/ha/repmgrd/#virtual-ip","title":"Virtual IP","text":"<ul> <li>\u6ce8\u518c\u4e3b\u8282\u70b9\u65f6\uff0c\u7ed1\u5b9avip</li> <li>Failover &amp; Switchover\u65f6 \u5229\u7528failover_validation_command\u4e8b\u4ef6\u91cd\u65b0\u7ed1\u5b9avip </li> <li>\u6574\u4e2a\u96c6\u7fa4\u91cd\u542f\u65f6\uff0c\u8bc6\u522b\u51fa\u4e3b\u8282\u70b9\u7ed1\u5b9avip</li> </ul>"},{"location":"postgres/ha/repmgrd/#_24","title":"\u4e3b\u8282\u70b9\u5f02\u5e38\u540e\u6062\u590d\u5904\u7406","text":"<ul> <li>\u4e3b\u8282\u70b9\u7f51\u7edc\u95ee\u9898\uff0c\u5982\u7f51\u7edc\u9632\u706b\u5899\u7b49\u539f\u56e0\u3002Postgresql\u670d\u52a1\u4ecd\u5728\u8fd0\u884c\uff0c\u5e76\u53ef\u5199\u3002</li> </ul> <pre><code>\u8bbe\u7f6e\u53c2\u6570 child_nodes_connected_min_count\n\u89e6\u53d1\u4e8b\u4ef6 child_nodes_disconnect_command \u4e2d\u5b9a\u4e49\u56de\u8c03\u65b9\u6cd5\u5c06\u4e3b\u8282\u70b9\u964d\u7ea7\u4e3a\u53ea\u8bfb\uff0c\u6216\u5173\u95ed\u3002\n</code></pre> <ul> <li>\u5f02\u5e38\u6062\u590d\u65f6\uff0c\u7f51\u7edc\u91cd\u65b0\u6062\u590d\u8fde\u63a5\u3002</li> </ul> <p>\u627e\u51fa\u96c6\u7fa4\u6545\u969c\u8f6c\u79fb\u540e\u65b0\u4e3b\u8282\u70b9\uff0c \u65b9\u6cd5 libpq \u4e2d\u53ef\u5199\u591a\u4e2ahosts\u3002</p> <p>pg_rewind \u5bf9\u9f50\u65f6\u95f4\u7ebf</p> <p>rejoin \u65b0\u96c6\u7fa4</p> <ul> <li> <p>\u65ad\u7535 \uff0c\u4e0d\u80fd\u505a\u4efb\u4f55\u5904\u7406</p> </li> <li> <p>\u7535\u529b\u6062\u590d\u3002\u670d\u52a1\u91cd\u542f\uff0c\u68c0\u6d4b\u4ece\u5e93\u6570\u91cf\u5982\u679c\u4e3a0 \u6682\u65f6\u4e0d\u63d0\u4f9b\u670d\u52a1\u3002\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4 stop service -&gt; rejoin\u96c6\u7fa4</p> </li> </ul>"},{"location":"postgres/ha/repmgrd/#_25","title":"\u4ece\u8282\u70b9\u6545\u969c\u53ca\u6062\u590d","text":"<ul> <li>\u5f53\u4ece\u8282\u70b9\u53d1\u751f\u6545\u969c\u65f6\u4e0d\u4f1a\u5f15\u8d77\u6545\u969c\u8f6c\u79fb\u3002\u5f53\u9700\u8981\u6ce8\u610f\u5f53\u4ece\u8282\u70b9\u6545\u969c\u6062\u590d\u540ewal\u65e5\u5fd7\u4f1a\u843d\u540e\u4e0e\u4e3b\u5e93\u3002</li> </ul>"},{"location":"postgres/ha/repmgrd/#_26","title":"\u5bf9\u5916\u670d\u52a1\u7ba1\u7406","text":"<p>\u5e94\u7528\u5728\u901a\u5e38\u60c5\u51b5\u4e0b\u4e0d\u4f1a\u76f4\u63a5\u8fde\u63a5\u6570\u636e\u5e93\uff0c\u6bd4\u5982\u901a\u8fc7dns\uff0chaproxy\u7b49\u4e2d\u95f4\u7ba1\u7406\u670d\u52a1\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u548c\u89e3\u8026\u3002</p> <p>\u5728\u6570\u636e\u5e93\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u65f6\uff0c\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u5c3d\u91cf\u505a\u5230\u4e0d\u9700\u53d8\u5316\uff0c\u65e0\u611f\u3002</p> <p>\u65b0\u589e\u4e00\u4e2a\u72ec\u7acb\u4e0e\u73b0\u6709\u670d\u52a1\u4e4b\u5916\u7684\u670d\u52a1\u3002</p>"},{"location":"postgres/ha/repmgrd/#_27","title":"\u4e3b\u8981\u529f\u80fd","text":"<p>\u63d0\u4f9b\u4e00\u4e2a\u4e03\u5c42http\u8bf7\u6c42, \u5305\u62ec\u8bbf\u95ee\u6743\u9650\u9a8c\u8bc1</p> <p><code>\u8fd4\u56de\u503c</code>: \u670d\u52a1\u5df2\u7ecf\u6b63\u5e38\u8fd0\u884c\u7684\u65f6\u95f4 ps:\u4e0a\u5c42\u8d1f\u8f7d\u5747\u8861\u7528\u6237\u53ef\u53c2\u8003\u8be5\u503c\u8fdb\u884c\u6743\u9650\u5206\u914d\u3002\u5982\u8282\u70b9\u521a\u63a5\u5165\u96c6\u7fa4\u7f13\u5b58\u6570\u636e\u5c1a\u672a\u51c6\u5907\u5145\u5206\uff0c\u5efa\u8bae\u4e1a\u52a1\u6d41\u91cf\u9010\u6b65\u63a5\u5165\u3002</p> <p><code>\u8fd4\u56de\u7801</code>: 200 , \u5176\u4ed6</p> <p><code>\u4e3b\u5e93</code>  \u8bbf\u95ee\u5730\u5740 ip:port/master ?xxx</p> <p>\u200b      \u5982\u8fd4\u56de\u7801\u4e3a200\uff0c\u5f53\u524d\u8282\u70b9\u4e3a\u4e3b\u8282\u70b9\u5e76\u4e14\u670d\u52a1\u6b63\u5e38\u3002</p> <p>\u200b      \u5176\u4ed6\u8fd4\u56de\u7801,\u6682\u65f6\u4e0d\u80fd\u63d0\u4f9b\u5199\u670d\u52a1</p> <p>\u200b     \u4e3b\u8981\u5224\u65ad\u903b\u8f91: PG\u670d\u52a1\u53ef\u8fde\u63a5\u6027\uff0c\u4e0b\u6e38\u8282\u70b9\u4e2a\u6570</p> <p><code>\u4ece\u5e93</code> \u8bbf\u95ee\u5730\u5740 ip:port/replocation ?xxx</p> <p>\u200b      \u4e3b\u8981\u5224\u65ad\u903b\u8f91: PG\u670d\u52a1\u53ef\u8fde\u63a5\u6027\uff0c\u843d\u540e\u4e3b\u8282\u70b9\u7684wal\u5dee\u503c</p>"},{"location":"postgres/ha/repmgrd/#_28","title":"\u53ef\u89e3\u51b3\u7684\u95ee\u9898","text":"<ul> <li> <p>vip \u4e0d\u80fd\u8de8\u7f51\u6bb5\u7ba1\u7406</p> </li> <li> <p>\u5728Postgresql\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u65f6\u8fdb\u884c\u5065\u5eb7\u72b6\u6001\u68c0\u6d4b\u3002\u5982\u679c\u4e0d\u6ee1\u8db3\u9700\u6c42\uff0c\u505c\u6b62\u5bf9\u5e94\u7528\u63d0\u4f9b\u670d\u52a1\uff0c\u5f85\u6062\u590d\u540e\u5728\u63d0\u4f9b\u670d\u52a1</p> </li> </ul>"},{"location":"postgres/ha/repmgrd/#_29","title":"\u6545\u969c\u5207\u6362\u65f6\u95f4\u9884\u4f30","text":"<p>switchover &amp; failover: \u6545\u969c\u53d1\u751f\u540e\u68c0\u6d4b\u5207\u6362\u7684\u603b\u65f6\u95f4\u9884\u4f30</p> <p>\u4e3b\u8981\u53c2\u8003\u56e0\u7d20:</p> <ul> <li> <p>monitor_interval_secs \u68c0\u6d4b\u4e0a\u6e38\u8282\u70b9\u65f6\u95f4\u95f4\u9694 \u9ed8\u8ba42\u79d2</p> </li> <li> <p>connection_check_type \u68c0\u6d4b\u7c7b\u578b \u6bcf\u6b21\u68c0\u6d4b\u7684timeout</p> </li> <li> <p>reconnect_attempts \u91cd\u8fde\u5c1d\u8bd5\u6b21\u6570 \u9ed8\u8ba46\u6b21</p> </li> <li> <p>reconnect_interval \u91cd\u8fde\u5c1d\u8bd5\u95f4\u9694\u65f6\u95f4</p> </li> </ul>"},{"location":"postgres/ha/repmgrd/#_30","title":"\u53ea\u6709\u4e24\u4e2a\u8282\u70b9","text":"<p>\u4e3b\u8981\u9762\u4e34\u95ee\u9898: \u4e24\u4e2a\u8282\u70b9\u4e3b\u8981\u662f\u5f53\u53d1\u751f\u7f51\u7edc\u6545\u969c\u65f6\uff0c\u800c\u975epostgres\u6570\u636e\u5e93\u5e94\u7528\u95ee\u9898\u65f6\u3002\u4ece\u5e93\u65e0\u6cd5\u5224\u65ad\u662f\u7f51\u7edc\u8fd8\u662f\u4e3b\u5e93\u53d1\u751f\u4e86\u6545\u969c\u3002\u89c1\u8bc1\u8282\u70b9\u4e3b\u8981\u662f\u4e3a\u4e86\u89e3\u51b3\u8fd9\u6837\u7684\u95ee\u9898\u3002</p> <p>\u89e3\u51b3\u601d\u8def: \u6a21\u62df\u89c1\u8bc1\u8282\u70b9\u3002\u5728\u4ece\u5e93\u65e0\u6cd5\u4e0e\u4e3b\u5e93\u901a\u4fe1\u65f6\uff0cping \u4e00\u4e2a\u5176\u4ed6\u8282\u70b9\u3002\u6216ping \u7f51\u5173\u6216\u81ea\u5df1\u7684ip\u3002 \u5f53ping\u5931\u8d25\u65f6\u8ba4\u4e3a\u53d1\u751f\u4e86\u7f51\u7edc\u95ee\u9898\u3002</p> <p>\u5177\u4f53\u5b9e\u73b0: \u914d\u7f6e <code>failover_validation_command</code></p> <p>\u200b   failover_validation_command.sh</p> <pre><code>#! bin/bash\nping -c 5 {{ inventory_hostname }}\nif [ $? -eq 0 ]; then\n    echo \"ping $ip  success!\"\n    return 0\nelse\n    echo \"ping  $ip fail!\"\n    return 1\nfi\n</code></pre>"},{"location":"postgres/index/hypopg-index/","title":"PostgreSQL \u4e2d\u7684\u5047\u8bbe\u7d22\u5f15","text":"<p>github</p>"},{"location":"postgres/index/hypopg-index/#_1","title":"\u80cc\u666f","text":"<p>\u6570\u636e\u5e93\u4e2d\u7d22\u5f15\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u81f3\u5173\u91cd\u8981\u3002\u5f80\u5f80\u91c7\u7528\u521b\u5efa\u65b0\u7684\u7d22\u5f15\u7684\u65b9\u5f0f\u6765\u4f18\u5316\u73b0\u6709\u6570\u636e\u5e93\u3002</p> <p>\u6d4b\u8bd5\u73af\u5883\u901a\u5e38\u4e0e\u6b63\u5f0f\u73af\u5883\u7684\u6570\u636e\u91cf\u6570\u636e\u5206\u5e03\u4e0d\u540c\uff0c\u5728\u6d4b\u8bd5\u73af\u5883\u4e2d\u7d22\u5f15\u6548\u679c\u4e0d\u80fd\u5b8c\u5168\u4ee3\u8868\u771f\u5b9e\u7684\u8fd0\u884c\u73af\u5883\u7d22\u5f15\u7684\u6548\u679c\u3002 \u4f46\u662f\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\u4f1a\u5360\u7528\u7cfb\u7edf\u7684\u8d44\u6e90\u5e76\u4e14\u9700\u8981\u4e00\u5b9a\u7684\u65f6\u95f4\u3002\u5bf9\u6b63\u5728\u8fd0\u884c\u7684\u7cfb\u7edf\u4f1a\u5e26\u6765\u989d\u5916\u7684\u538b\u529b\u3002 \u5982\u679c\u65b0\u7684\u7d22\u5f15\u5e76\u4e0d\u7406\u60f3\u6216\u4e0d\u751f\uff0c\u518d\u628a\u7d22\u5f15\u5220\u9664\u6548\u5c82\u4e0d\u662f\u65e2\u8d39\u65f6\u6709\u8d39\u529b\uff0c\u5bf9\u7ebf\u4e0a\u8fd0\u884c\u7684\u6570\u636e\u5e93\u4e5f\u4e0d\u53cb\u597d\u3002</p> <p>\u521b\u5efa\u5047\u8bbe\u7d22\u5f15\u51e0\u4e4e\u4e0d\u9700\u8981\u5360\u7528\u7cfb\u7edf\u7684\u8d44\u6e90\uff0c\u672c\u8d28\u4e0a\u662f\u5229\u7528\u6570\u636e\u5e93\u7684\u7edf\u8ba1\u4fe1\u606f\u6765\u6a21\u62df\u7d22\u5f15\u4f7f\u7528\u7684\u6548\u679c\u3002</p> <p>\u521b\u5efa\u5b8c\u6210\u540e\u53ef\u901a\u8fc7explain \u6765\u9a8c\u8bc1\u7d22\u5f15\uff0c\u9884\u5148\u4e86\u89e3\u65b0\u7d22\u5f15\u7684\u4f7f\u7528\u6548\u679c\u3002</p>"},{"location":"postgres/index/hypopg-index/#_2","title":"\u5b89\u88c5","text":"<ul> <li>RHEL/Rocky Linux</li> </ul> <pre><code>yum install hypopg\n</code></pre> <ul> <li>Debian / Ubuntu</li> </ul> <pre><code>#  XY is the major version\napt install postgresql-XY-hypopg\n</code></pre> <ul> <li>\u6e90\u7801\u5b89\u88c5</li> </ul> <pre><code>wget https://github.com/HypoPG/hypopg/archive/master.zip\n\nunzip master.zip\ncd hypopg-master\n\nmake\nsudo make install\n\nmake install\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_3","title":"\u4ecb\u7ecd","text":"<p>HypoPG \u521b\u5efa\u7684\u7d22\u5f15 \u53ea\u5b58\u5728\u5f53\u524d\u8fde\u63a5\u7684\u79c1\u6709\u5185\u5b58\u4e2d\uff0c\u4e0d\u4f1a\u5f71\u54cd\u5230\u4efb\u4f55\u5176\u4ed6\u8fd0\u884c\u4e2d\u7684\u8fde\u63a5\u3002</p>"},{"location":"postgres/index/hypopg-index/#_4","title":"\u652f\u6301","text":"<ul> <li>btree</li> <li>brin</li> <li>hash (requires PostgreSQL 10 or above)</li> <li>bloom (requires the bloom extension to be installed)</li> </ul>"},{"location":"postgres/index/hypopg-index/#_5","title":"\u4f7f\u7528","text":""},{"location":"postgres/index/hypopg-index/#_6","title":"\u521b\u5efa","text":"<pre><code>CREATE EXTENSION hypopg ;\n\\dx\n                     List of installed extensions\n  Name   | Version |   Schema   |             Description\n---------+---------+------------+-------------------------------------\n hypopg  | 1.1.0   | public     | Hypothetical indexes for PostgreSQL\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_7","title":"\u793a\u4f8b","text":""},{"location":"postgres/index/hypopg-index/#_8","title":"\u521b\u5efa\u6d4b\u8bd5\u6570\u636e\u8868","text":"<pre><code>CREATE TABLE hypo (id integer, val text) ;\nINSERT INTO hypo SELECT i, 'line ' || i FROM generate_series(1, 100000) i ;\nVACUUM ANALYZE hypo ;\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_9","title":"\u6267\u884c\u8ba1\u5212","text":"<pre><code>EXPLAIN SELECT val FROM hypo WHERE id = 1;\n                       QUERY PLAN\n--------------------------------------------------------\n Seq Scan on hypo  (cost=0.00..1791.00 rows=1 width=14)\n   Filter: (id = 1)\n(2 rows)\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_10","title":"\u521b\u5efa\u5047\u8bbe\u7d22\u5f15","text":"<pre><code>SELECT * FROM hypopg_create_index('CREATE INDEX ON hypo (id)') ;\n indexrelid |      indexname\n------------+----------------------\n      18284 | &lt;18284&gt;btree_hypo_id\n(1 row)\n\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_11","title":"\u6267\u884c\u8ba1\u5212","text":"<pre><code>EXPLAIN SELECT val FROM hypo WHERE id = 1;\n                                    QUERY PLAN\n----------------------------------------------------------------------------------\n Index Scan using &lt;18284&gt;btree_hypo_id on hypo  (cost=0.04..8.06 rows=1 width=10)\n   Index Cond: (id = 1)\n(2 rows)\n</code></pre> <pre><code>EXPLAIN ANALYZE SELECT val FROM hypo WHERE id = 1;\n                                            QUERY PLAN\n---------------------------------------------------------------------------------------------------\n Seq Scan on hypo  (cost=0.00..1791.00 rows=1 width=10) (actual time=0.046..46.390 rows=1 loops=1)\n   Filter: (id = 1)\n   Rows Removed by Filter: 99999\n Planning time: 0.160 ms\n Execution time: 46.460 ms\n(5 rows)\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_12","title":"\u7ba1\u7406\u5047\u8bbe\u7d22\u5f15","text":"<ul> <li>hypopg_list_indexes: \u67e5\u770b\u7d22\u5f15\u5217\u8868</li> </ul> <pre><code>SELECT * FROM hypopg_list_indexes ;\n indexrelid |      index_name       | schema_name | table_name | am_name\n------------+-----------------------+-------------+------------+---------\n      18284 | &lt;18284&gt;btree_hypo_id  | public      | hypo       | btree\n(1 row)\n</code></pre> <ul> <li>hypopg_get_indexdef: \u67e5\u770b\u7d22\u5f15\u5b9a\u4e49</li> </ul> <pre><code>SELECT index_name, hypopg_get_indexdef(indexrelid) FROM hypopg_list_indexes ;\n      index_name       |             hypopg_get_indexdef\n-----------------------+----------------------------------------------\n &lt;18284&gt;btree_hypo_id  | CREATE INDEX ON public.hypo USING btree (id)\n(1 row)\n</code></pre> <ul> <li>hypopg_relation_size: \u67e5\u770b\u5927\u5c0f</li> </ul> <pre><code>SELECT index_name, pg_size_pretty(hypopg_relation_size(indexrelid))\n  FROM hypopg_list_indexes ;\n</code></pre> <ul> <li>hypopg_drop_index: \u5220\u9664\u4e00\u4e2a\u7d22\u5f15</li> <li>hypopg_reset: \u6e05\u7a7a\u6240\u6709\u7d22\u5f15</li> </ul>"},{"location":"postgres/index/hypopg-index/#_13","title":"\u9690\u85cf\u7d22\u5f15\uff08\u540c\u6837\u5f88\u6709\u7528\uff09","text":""},{"location":"postgres/index/hypopg-index/#_14","title":"\u521b\u5efa\u771f\u5b9e\u7d22\u5f15","text":"<pre><code>SELECT hypopg_reset();\nCREATE INDEX ON hypo(id);\nCREATE INDEX ON hypo(id, val);\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_15","title":"\u9690\u85cf\u7d22\u5f15","text":"<pre><code>EXPLAIN SELECT * FROM hypo WHERE id = 1;\n                                    QUERY PLAN\n----------------------------------------------------------------------------------\nIndex Only Scan using hypo_id_val_idx on hypo  (cost=0.29..8.30 rows=1 width=13)\nIndex Cond: (id = 1)\n(2 rows)\n\n</code></pre> <pre><code>SELECT hypopg_hide_index('hypo_id_val_idx'::REGCLASS);\n hypopg_hide_index\n-------------------\nt\n(1 row)\n\nEXPLAIN SELECT * FROM hypo WHERE id = 1;\n                            QUERY PLAN\n-------------------------------------------------------------------------\nIndex Scan using hypo_id_idx on hypo  (cost=0.29..8.30 rows=1 width=13)\nIndex Cond: (id = 1)\n(2 rows)\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_16","title":"\u9690\u85cf\u7d22\u5f15","text":"<pre><code>SELECT hypopg_hide_index('hypo_id_idx'::REGCLASS);\n hypopg_hide_index\n-------------------\nt\n(1 row)\n\nEXPLAIN SELECT * FROM hypo WHERE id = 1;\n                    QUERY PLAN\n-------------------------------------------------------\nSeq Scan on hypo  (cost=0.00..180.00 rows=1 width=13)\nFilter: (id = 1)\n(2 rows)\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_17","title":"\u53d6\u6d88\u9690\u85cf\u7d22\u5f15","text":"<pre><code>SELECT hypopg_unhide_index('hypo_id_idx'::regclass);\n hypopg_unhide_index\n-------------------\nt\n(1 row)\n\nEXPLAIN SELECT * FROM hypo WHERE id = 1;\n                            QUERY PLAN\n-------------------------------------------------------------------------\nIndex Scan using hypo_id_idx on hypo  (cost=0.29..8.30 rows=1 width=13)\nIndex Cond: (id = 1)\n(2 rows)\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_18","title":"\u67e5\u770b\u88ab\u9690\u85cf\u7684\u7d22\u5f15","text":"<pre><code>SELECT * FROM hypopg_hidden_indexes();\n indexid\n---------\n526604\n(1 rows)\n</code></pre>"},{"location":"postgres/index/hypopg-index/#_19","title":"\u53d6\u6d88\u6240\u6709\u88ab\u9690\u85cf\u7684\u7d22\u5f15","text":"<pre><code>hypopg_unhide_all_index()\n</code></pre>"},{"location":"postgres/index/index-bloom/","title":"Bloom \u7d22\u5f15","text":""},{"location":"postgres/index/index-bloom/#bloom","title":"Bloom \u7d22\u5f15","text":"<p>Bloom \u8fc7\u6ee4\u5668\u4ee3\u8868\u7684\u662f\u4e00\u7ec4\u503c\u3002\u5b83\u7684\u4f5c\u7528\u662f\u68c0\u6d4b\u4e00\u4e2a\u5143\u7d20\u662f\u5426\u53ef\u80fd\u5c5e\u4e8e\u96c6\u5408\uff0c\u5b83\u53ef\u4ee5\u5141\u8bb8\u6709\u4e00\u4e9bfalse positive\uff0c\u4f46\u662f\u4e0d\u5141\u8bb8\u5b58\u5728false negative\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5c3d\u7ba1\u67d0\u4e2a\u5143\u7d20\u4e0d\u5728\u96c6\u5408\u4e2d\uff0c\u6d4b\u8bd5\u4e5f\u53ef\u80fd\u8fd4\u56detrue\u3002\u7136\u800c\uff0c\u5982\u679c\u5143\u7d20\u5728\u96c6\u5408\u4e2d\uff0c\u5c31\u4e0d\u53ef\u80fd\u8fd4\u56defalse\u3002  \u521b\u5efa\u5728\u4e00\u7ec4\u5217\u4e2d\u7684Bloom\u7d22\u5f15\u53ef\u4ee5\u88ab\u7528\u6765\u52a0\u901f\u5728\u8fd9\u4e9b\u5217\u7684\u5b50\u96c6\u4e0a\u7528AND\u76f8\u8fde\u7684\u7b49\u5f0f\u7684\u67e5\u8be2\u3002 </p> <p>\u5f53\u8868\u5177\u6709\u5f88\u591a\u5c5e\u6027\u5e76\u4e14\u67e5\u8be2\u53ef\u80fd\u4f1a\u6d4b\u8bd5\u5176\u4e2d\u4efb\u610f\u7ec4\u5408\u65f6\uff0c\u8fd9\u79cd\u7c7b\u578b\u7684\u7d22\u5f15\u6700\u6709\u7528\u3002\u4f20\u7edf\u7684 btree \u7d22\u5f15\u6bd4\u5e03\u9c81\u59c6\u7d22\u5f15\u66f4\u5feb\uff0c\u4f46\u662f\u9700\u8981\u5f88\u591a btree \u7d22\u5f15\u6765\u652f\u6301\u6240\u6709\u53ef\u80fd\u7684\u67e5\u8be2\uff0c\u800c\u5bf9\u4e8e\u5e03\u9c81\u59c6\u7d22\u5f15\u6765\u8bf4\u53ea\u9700\u8981\u4e00\u4e2a\u5373\u53ef\u3002</p>"},{"location":"postgres/index/index-bloom/#bloom-btree","title":"\u6ce8\u610f: bloom \u7d22\u5f15\u53ea\u652f\u6301\u7b49\u503c\u67e5\u8be2\uff0c\u800c btree \u7d22\u5f15\u8fd8\u80fd\u6267\u884c\u4e0d\u7b49\u548c\u8303\u56f4\u641c\u7d22\u3002","text":""},{"location":"postgres/index/index-bloom/#_1","title":"\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15","text":"<pre><code>CREATE INDEX bloomidx ON tbloom USING bloom (i1,i2,i3)\n       WITH (length=80, col1=2, col2=2, col3=4);\n</code></pre> <p>with \u90e8\u5206\u53ef\u7701\u7565</p> <p>length \u6bcf\u4e2a\u7b7e\u540d\uff08\u7d22\u5f15\u9879\uff09\u7684\u957f\u5ea6\u4f4d\u6570\u3002\u9ed8\u8ba4\u662f80\u4f4d\uff0c\u6700\u957f\u662f4096\u4f4d\u3002</p> <p>col1 \u2014 col32 \u4ece\u6bcf\u4e00\u4e2a\u7d22\u5f15\u5217\u4ea7\u751f\u7684\u4f4d\u6570\u3002\u6bcf\u4e2a\u53c2\u6570\u7684\u540d\u5b57\u8868\u793a\u5b83\u6240\u63a7\u5236\u7684\u7d22\u5f15\u5217\u7684\u7f16\u53f7\u3002\u9ed8\u8ba4\u662f2\u4f4d\uff0c\u6700\u5927\u662f4095\u4f4d\u3002\u6ca1\u6709\u5b9e\u9645\u4f7f\u7528\u7684\u7d22\u5f15\u5217\u7684\u53c2\u6570\u4f1a\u88ab\u5ffd\u7565\u3002</p>"},{"location":"postgres/index/index-bloom/#_2","title":"\u4f7f\u7528\u4f8b\u5b50","text":"<p>http://postgres.cn/docs/10/bloom.html</p>"},{"location":"postgres/index/index-invalid/","title":"\u7d22\u5f15\u5931\u6548","text":""},{"location":"postgres/index/index-invalid/#_1","title":"\u7b80\u4ecb","text":"<p>\u7d22\u5f15\u7684\u4f5c\u7528\uff0c\u52a0\u901f\u68c0\u7d22\uff0c\u6392\u5e8f\uff0c\u5206\u7ec4\u3002</p> <p>\u4f18\u70b9\uff1a \u68c0\u7d22</p> <p>\u7f3a\u70b9\uff1a \u65b0\u589e\uff0c\u66f4\u65b0\u65f6\u9700\u8981\u7ef4\u62a4\u7d22\u5f15\uff0c\u5360\u78c1\u76d8\u7a7a\u95f4\uff0c\u521b\u5efa\u65f6\u9501\u8868\u3002</p> <p>\u7ef4\u62a4\uff1a \u6839\u636e\u7edf\u8ba1\u8868\u53d1\u751f\u5168\u8868\u626b\u63cf\u6b21\u6570\uff0c\u7d22\u5f15\u4f7f\u7528\u6b21\u6570\u3002\u5408\u7406\u6dfb\u52a0\u5220\u9664\u7d22\u5f15\u3002</p>"},{"location":"postgres/index/index-invalid/#_2","title":"\u7d22\u5f15\u5931\u6548\u7684\u573a\u666f","text":"<p>\u5982\u679cwhere\u8fc7\u6ee4\u6761\u4ef6\u8bbe\u7f6e\u4e0d\u5408\u7406\uff0c\u5373\u4f7f\u7d22\u5f15\u5b58\u5728\uff0c\u4e14where\u8fc7\u6ee4\u6761\u4ef6\u4e2d\u5305\u542b\u7d22\u5f15\u5217\uff0c\u4e5f\u4f1a\u5bfc\u81f4\u5168\u8868\u626b\u63cf\uff0c\u7d22\u5f15\u4e0d\u8d77\u4f5c\u7528\u3002\u4ec0\u4e48\u6761\u4ef6\u4e0b\u4f1a\u5bfc\u81f4\u7d22\u5f15\u5931\u6548\u5462\uff1f</p> <p>1.\u4efb\u4f55\u8ba1\u7b97\u3001\u51fd\u6570\u3001\u7c7b\u578b\u8f6c\u6362</p> <p>2.!=</p> <p>3.NOT\uff0c\u76f8\u5f53\u4e8e\u4f7f\u7528\u51fd\u6570</p> <p>4.\u6a21\u7cca\u67e5\u8be2\u901a\u914d\u7b26\u5728\u5f00\u5934</p> <p>5.\u7d22\u5f15\u5b57\u6bb5\u5728\u8868\u4e2d\u5360\u6bd4\u8f83\u9ad8</p> <p>6.\u591a\u5b57\u6bb5btree\u7d22\u5f15\u67e5\u8be2\u6761\u4ef6\u4e0d\u5305\u542b\u7b2c\u4e00\u5217</p> <p>7.\u591a\u5b57\u6bb5\u7d22\u5f15\u67e5\u8be2\u6761\u4ef6\u4f7f\u7528OR\uff08\u6709\u65f6\u4e5f\u4f1a\u8d70\u7d22\u5f15\u626b\u63cf\uff0c\u4f46\u67e5\u8be2\u6548\u7387\u4e0d\u9ad8\uff09</p> <p>8.\u8868\u4e2d\u6570\u636e\u91cf\u592a\u5c11\u65f6</p>"},{"location":"postgres/index/index-invalid/#_3","title":"\u5b9e\u4f8b","text":"<p>\u6d4b\u8bd5\u8868</p> <pre><code>\u521b\u5efa\u8868\npostgres#=create table tbl_index(a bigint,b timestamp without time zone ,c varchar(12));\n\n\u63d2\u51651kw\u6570\u636e\uff0c\u6253\u5f00\u8ba1\u65f6\u5668 \u5bf9\u6bd4\u521b\u5efa\u7d22\u5f15\u5bf9\u6570\u636e\u63d2\u5165\u7684\u5f71\u54cd\u3002\n\npostgres=# \\timing \nTiming is on.\n\npostgres=# insert into tbl_index select generate_series(1,10000000),clock_timestamp()::timestamp without time zone,'zhang';\nINSERT 0 10000000\nTime: 25004.214 ms (00:25.004)\n\npostgres=# create index tbl_index_a ON tbl_index using btree (a);\nCREATE INDEX\nTime: 4119.733 ms (00:04.120)\n\npostgres=# create index tbl_index_b ON tbl_index using btree (b);\nCREATE INDEX\nTime: 6229.857 ms (00:06.230)\n\npostgres=# insert into tbl_index select generate_series(1,10000000),clock_timestamp()::timestamp without time zone,'eamon';\nINSERT 0 10000000\nTime: 153963.850 ms (02:33.964)\n</code></pre> <p>tips </p> <p>\u5927\u91cf\u6570\u636e\u5bfc\u5165\u65f6\u5efa\u8bae\u5148\u5bfc\u5165\u6570\u636e\u540e\u521b\u5efa\u7d22\u5f15</p> <p>\u66f4\u65b0\u9891\u7e41\u7684\u5b57\u6bb5\u4e0d\u5efa\u8bae\u5efa\u7d22\u5f15\uff0c\u5982update_time</p>"},{"location":"postgres/index/index-invalid/#1","title":"1.\u4efb\u4f55\u8ba1\u7b97\u3001\u51fd\u6570\u3001\u7c7b\u578b\u8f6c\u6362","text":"<pre><code>#\u7d22\u5f15\u68c0\u7d22\npostgres=# explain analyze select * from tbl_index where a = 100;\n                                                       QUERY PLAN                                                        \n-------------------------------------------------------------------------------------------------------------------------\n Index Scan using tbl_index_a on tbl_index  (cost=0.44..19.78 rows=4 width=22) (actual time=0.012..0.015 rows=2 loops=1)\n   Index Cond: (a = 100)\n Planning time: 0.053 ms\n Execution time: 0.027 ms\n(4 rows)\n\n#\u8ba1\u7b97\npostgres=# explain analyze select * from tbl_index where a +1 = 100;\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..263387.92 rows=99999 width=22) (actual time=0.495..478.375 rows=2 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on tbl_index  (cost=0.00..252388.02 rows=41666 width=22) (actual time=220.138..465.801 rows=1 loops=3)\n         Filter: ((a + 1) = 100)\n         Rows Removed by Filter: 6666666\n Planning time: 0.107 ms\n Execution time: 478.411 ms\n(8 rows)\n#\u89e3\u51b3\u65b9\u6cd5\ncreate index tbl_index_a_1 on tbl_index using btree ((a+1));\n\n#\u7c7b\u578b\u8f6c\u6362\npostgres=# explain analyze select * from tbl_index where a::varchar  = '100';\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..284221.09 rows=99999 width=22) (actual time=0.529..724.035 rows=2 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on tbl_index  (cost=0.00..273221.19 rows=41666 width=22) (actual time=355.491..713.103 rows=1 loops=3)\n         Filter: (((a)::character varying)::text = '100'::text)\n         Rows Removed by Filter: 6666666\n Planning time: 0.168 ms\n Execution time: 724.075 ms\n(8 rows)\n\npostgres=# explain analyze select * from tbl_index where b::date = '2020-04-15';\n                                                             QUERY PLAN                                                             \n------------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..263387.92 rows=99999 width=22) (actual time=0.505..4764.531 rows=20000000 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on tbl_index  (cost=0.00..252388.02 rows=41666 width=22) (actual time=0.021..789.147 rows=6666667 loops=3)\n         Filter: ((b)::date = '2020-04-15'::date)\n Planning time: 0.146 ms\n Execution time: 5182.919 ms\n(7 rows)\n\nTime: 5184.795 ms (00:05.185)\n\n#\u89e3\u51b3\u65b9\u6cd5 \n\ncreate index tbl_index_a2str on tbl_index using btree ((a::varchar));\ncreate index tbl_index_b2date on tbl_index using btree ((b::date));\n\nselect * from tbl_index where b &lt; '2020-04-16 00:00:00' and b &gt;= '2020-04-15 00:00:00';\n\n</code></pre>"},{"location":"postgres/index/index-invalid/#2","title":"2.!=","text":"<pre><code>postgres=# explain analyze select * from tbl_index where a != 100;\n                                                        QUERY PLAN                                                        \n--------------------------------------------------------------------------------------------------------------------------\n Seq Scan on tbl_index  (cost=0.00..377387.04 rows=19999839 width=22) (actual time=0.020..1384.726 rows=19999998 loops=1)\n   Filter: (a &lt;&gt; 100)\n   Rows Removed by Filter: 2\n Planning time: 0.132 ms\n Execution time: 1790.685 ms\n(5 rows)\n\nTime: 1792.412 ms (00:01.792)\n</code></pre>"},{"location":"postgres/index/index-invalid/#3-not","title":"3. NOT","text":"<pre><code>postgres=# explain analyze select * from tbl_index where a is null;\n                                                       QUERY PLAN                                                       \n------------------------------------------------------------------------------------------------------------------------\n Index Scan using tbl_index_a on tbl_index  (cost=0.44..8.21 rows=1 width=22) (actual time=0.022..0.022 rows=0 loops=1)\n   Index Cond: (a IS NULL)\n Planning time: 0.123 ms\n Execution time: 0.055 ms\n(4 rows)\n\nTime: 1.694 ms\npostgres=# explain analyze select * from tbl_index where a is not null;\n                                                        QUERY PLAN                                                        \n--------------------------------------------------------------------------------------------------------------------------\n Seq Scan on tbl_index  (cost=0.00..327389.00 rows=20000000 width=22) (actual time=0.025..1375.125 rows=20000000 loops=1)\n   Filter: (a IS NOT NULL)\n Planning time: 0.121 ms\n Execution time: 1789.101 ms\n(4 rows)\n\nTime: 1790.625 ms (00:01.791)\n</code></pre>"},{"location":"postgres/index/index-invalid/#4","title":"4.\u6a21\u7cca\u67e5\u8be2\u901a\u914d\u7b26\u5728\u5f00\u5934","text":"<p>\u53c2\u89c1</p>"},{"location":"postgres/index/index-invalid/#5","title":"5.\u7d22\u5f15\u5b57\u6bb5\u5728\u8868\u4e2d\u5360\u6bd4\u8f83\u9ad8","text":"<pre><code>postgres=# create index tbl_index_c on tbl_index using btree (c);\nCREATE INDEX\nTime: 10552.062 ms (00:10.552)\n\npostgres=# analyze tbl_index ;\nANALYZE\nTime: 118.018 ms\npostgres=# explain analyze select * from tbl_index where c = 'zhang';\n                                                        QUERY PLAN                                                        \n--------------------------------------------------------------------------------------------------------------------------\n Seq Scan on tbl_index  (cost=0.00..377389.90 rows=10034703 width=22) (actual time=0.021..1409.096 rows=10000000 loops=1)\n   Filter: ((c)::text = 'zhang'::text)\n   Rows Removed by Filter: 10000000\n Planning time: 0.562 ms\n Execution time: 1612.769 ms\n(5 rows)\n\nTime: 1615.034 ms (00:01.615)\n\npostgres=# explain analyze select * from tbl_index where c = 'eamon';\n                                                        QUERY PLAN                                                         \n---------------------------------------------------------------------------------------------------------------------------\n Seq Scan on tbl_index  (cost=0.00..377389.90 rows=9965369 width=22) (actual time=616.952..1404.717 rows=10000000 loops=1)\n   Filter: ((c)::text = 'eamon'::text)\n   Rows Removed by Filter: 10000000\n Planning time: 0.066 ms\n Execution time: 1607.572 ms\n(5 rows)\n\nTime: 1609.019 ms (00:01.609)\n\npostgres=# insert into tbl_index values(1,clock_timestamp()::timestamp without time zone,'zhangeamon');\nINSERT 0 1\nTime: 2.598 ms\n\npostgres=# explain analyze select * from tbl_index where c = 'zhangeamon';\n                                                       QUERY PLAN                                                        \n-------------------------------------------------------------------------------------------------------------------------\n Index Scan using tbl_index_c on tbl_index  (cost=0.44..7.46 rows=1 width=22) (actual time=0.086..96.848 rows=1 loops=1)\n   Index Cond: ((c)::text = 'zhangeamon'::text)\n Planning time: 0.157 ms\n Execution time: 96.881 ms\n(4 rows)\n\nTime: 98.464 ms\n</code></pre>"},{"location":"postgres/index/index-invalid/#6btree","title":"6.\u591a\u5b57\u6bb5btree\u7d22\u5f15\u67e5\u8be2\u6761\u4ef6\u4e0d\u5305\u542b\u7b2c\u4e00\u5217","text":"<pre><code>#\u521b\u5efa\u8868\npostgres=# create table tbl_indexes(a int ,b varchar,c varchar);\nCREATE TABLE\nTime: 6.942 ms\n\n#\u63d2\u5165\u6570\u636e\npostgres=# insert into tbl_indexes select generate_series(1,5000000),substring(md5(random()::text),0,6),substring(md5(random()::text),0,6);\nINSERT 0 5000000\nTime: 15003.647 ms (00:15.004)\n\n#\u521b\u5efa\u591a\u503c\u7d22\u5f15\npostgres=# create index tbl_indexes_a_b_c on tbl_indexes using btree (a,b,c);\nCREATE INDEX\nTime: 2207.480 ms (00:02.207)\n\npostgres=# select * from tbl_indexes limit 10;\n a  |   b   |   c   \n----+-------+-------\n  1 | 0e7fb | d6370\n  2 | e2eb1 | 51d3e\n  3 | 93521 | 5f6b6\n  4 | 5880d | 23527\n  5 | 66f8e | f462f\n  6 | 6ceb3 | c9beb\n  7 | 18d44 | 11d64\n  8 | f76a4 | edd04\n  9 | 91975 | 4c79d\n 10 | 56f26 | 09e16\n(10 rows)\n\n\n#\u8d70\u7d22\u5f15\npostgres=# explain analyze select * from tbl_indexes where a = 10;\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on tbl_indexes  (cost=582.18..28488.04 rows=25000 width=68) (actual time=0.030..0.031 rows=1 loops=1)\n   Recheck Cond: (a = 10)\n   Heap Blocks: exact=1\n   -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..575.93 rows=25000 width=0) (actual time=0.022..0.022 rows=1 loops=1)\n         Index Cond: (a = 10)\n Planning time: 0.127 ms\n Execution time: 0.075 ms\n(7 rows)\n\nTime: 2.878 ms\npostgres=# explain analyze select * from tbl_indexes where a = 10 and b = '91975';\n                                                         QUERY PLAN                                                         \n----------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on tbl_indexes  (cost=5.71..482.09 rows=125 width=68) (actual time=0.025..0.025 rows=0 loops=1)\n   Recheck Cond: ((a = 10) AND ((b)::text = '91975'::text))\n   -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..5.68 rows=125 width=0) (actual time=0.022..0.022 rows=0 loops=1)\n         Index Cond: ((a = 10) AND ((b)::text = '91975'::text))\n Planning time: 0.146 ms\n Execution time: 0.074 ms\n(6 rows)\n\nTime: 2.886 ms\npostgres=# explain analyze select * from tbl_indexes where a = 10 and b = '91975' and c = '4c79d';\n                                                             QUERY PLAN                                                              \n-------------------------------------------------------------------------------------------------------------------------------------\n Index Only Scan using tbl_indexes_a_b_c on tbl_indexes  (cost=0.43..8.45 rows=1 width=68) (actual time=0.025..0.025 rows=0 loops=1)\n   Index Cond: ((a = 10) AND (b = '91975'::text) AND (c = '4c79d'::text))\n   Heap Fetches: 0\n Planning time: 0.158 ms\n Execution time: 0.067 ms\n(5 rows)\n\nTime: 3.136 ms\npostgres=# explain analyze select * from tbl_indexes where a = 10  and c = '4c79d';\n                                                          QUERY PLAN                                                          \n------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on tbl_indexes  (cost=638.46..1114.84 rows=125 width=68) (actual time=0.027..0.027 rows=0 loops=1)\n   Recheck Cond: ((a = 10) AND ((c)::text = '4c79d'::text))\n   -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..638.43 rows=125 width=0) (actual time=0.023..0.024 rows=0 loops=1)\n         Index Cond: ((a = 10) AND ((c)::text = '4c79d'::text))\n Planning time: 0.178 ms\n Execution time: 0.077 ms\n(6 rows)\n\nTime: 2.917 ms\n\n#\u4e0d\u8d70\u7d22\u5f15\npostgres=# explain analyze select * from tbl_indexes where b = '91975' and c = '4c79d';\n                                                         QUERY PLAN                                                          \n-----------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..59290.50 rows=125 width=68) (actual time=0.577..127.956 rows=1 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on tbl_indexes  (cost=0.00..58278.00 rows=52 width=68) (actual time=78.366..119.555 rows=0 loops=3)\n         Filter: (((b)::text = '91975'::text) AND ((c)::text = '4c79d'::text))\n         Rows Removed by Filter: 1666666\n Planning time: 0.154 ms\n Execution time: 127.993 ms\n(8 rows)\n\nTime: 130.603 ms\n\n</code></pre>"},{"location":"postgres/index/index-invalid/#7or","title":"7.\u591a\u5b57\u6bb5\u7d22\u5f15\u67e5\u8be2\u6761\u4ef6\u4f7f\u7528OR\uff08\u6709\u65f6\u4e5f\u4f1a\u8d70\u7d22\u5f15\u626b\u63cf\uff0c\u4f46\u67e5\u8be2\u6548\u7387\u4e0d\u9ad8\uff09","text":"<pre><code>postgres=# explain analyze select * from tbl_indexes where a = 10  or c = '4c79d';\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..64265.50 rows=49875 width=68) (actual time=0.520..138.035 rows=5 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on tbl_indexes  (cost=0.00..58278.00 rows=20781 width=68) (actual time=52.632..129.858 rows=2 loops=3)\n         Filter: ((a = 10) OR ((c)::text = '4c79d'::text))\n         Rows Removed by Filter: 1666665\n Planning time: 0.151 ms\n Execution time: 138.075 ms\n(8 rows)\n\nTime: 139.952 ms\npostgres=# explain analyze select * from tbl_indexes where a = 10  or b = '4c79d';\n                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=1000.00..64265.50 rows=49875 width=68) (actual time=0.513..131.024 rows=8 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Seq Scan on tbl_indexes  (cost=0.00..58278.00 rows=20781 width=68) (actual time=51.260..123.413 rows=3 loops=3)\n         Filter: ((a = 10) OR ((b)::text = '4c79d'::text))\n         Rows Removed by Filter: 1666664\n Planning time: 0.152 ms\n Execution time: 131.064 ms\n(8 rows)\n\nTime: 132.946 ms\npostgres=# explain analyze select * from tbl_indexes where a = 10  or a = 11;\n                                                              QUERY PLAN                                                              \n--------------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on tbl_indexes  (cost=1176.80..29434.85 rows=49875 width=68) (actual time=0.034..0.036 rows=2 loops=1)\n   Recheck Cond: ((a = 10) OR (a = 11))\n   Heap Blocks: exact=1\n   -&gt;  BitmapOr  (cost=1176.80..1176.80 rows=50000 width=0) (actual time=0.026..0.027 rows=0 loops=1)\n         -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..575.93 rows=25000 width=0) (actual time=0.020..0.020 rows=1 loops=1)\n               Index Cond: (a = 10)\n         -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..575.93 rows=25000 width=0) (actual time=0.005..0.005 rows=1 loops=1)\n               Index Cond: (a = 11)\n Planning time: 0.152 ms\n Execution time: 0.090 ms\n(10 rows)\n\nTime: 2.928 ms\n\n\u5982\u679c\u68c0\u7d22\u6761\u4ef6\u4e3a\u540c\u4e00\u4e2a\u5b57\u6bb5 \u5982a = 1 or a =2  \u8f6c\u6362\u4e3a a in (1,2) \u4f1a\u66f4\u4f18\u3002\n</code></pre> <p>\u5982\u679c\u591a\u4e2a\u5b57\u6bb5\u4e3a\u540c\u4e00\u7c7b\u578b\u53ef\u4f7f\u7528\u6570\u7ec4\u5316\u7d22\u5f15</p> <pre><code>indexdb=# CREATE TABLE tbloom AS\nindexdb-#    SELECT\nindexdb-#      (random() * 1000000)::int as i1,\nindexdb-#      (random() * 1000000)::int as i2,\nindexdb-#      (random() * 1000000)::int as i3,\nindexdb-#      (random() * 1000000)::int as i4,\nindexdb-#      (random() * 1000000)::int as i5,\nindexdb-#      (random() * 1000000)::int as i6\nindexdb-#    FROM\nindexdb-#   generate_series(1,10000000);\nSELECT 10000000\n\n-- \u521b\u5efabloom\u7d22\u5f15\nindexdb=# CREATE index btreeidx ON tbloom (i1, i2, i3, i4, i5, i6);\nCREATE INDEX\n\nindexdb=# EXPLAIN ANALYZE SELECT * FROM tbloom WHERE i2 = 898732 OR i5 = 123451;\n                                                                  QUERY PLAN                                                                  \n----------------------------------------------------------------------------------------------------------------------------------------------\n Gather  (cost=249337.50..385507.50 rows=99750 width=24) (actual time=345.415..684.760 rows=19 loops=1)\n   Workers Planned: 2\n   Workers Launched: 2\n   -&gt;  Parallel Bitmap Heap Scan on tbloom  (cost=248337.50..374532.50 rows=41562 width=24) (actual time=397.157..672.875 rows=6 loops=3)\n         Filter: ((i2 = 898732) OR (i5 = 123451))\n         Rows Removed by Filter: 3333327\n         Heap Blocks: exact=21455\n         -&gt;  Bitmap Index Scan on btreeidx  (cost=0.00..248312.56 rows=10000000 width=0) (actual time=331.686..331.686 rows=10000000 loops=1)\n Planning time: 0.165 ms\n Execution time: 684.813 ms\n(10 rows)\n\n-- \u521b\u5efa\u6570\u7ec4\u5316\u7d22\u5f15\nindexdb=# create index ON tbloom USING gin ( (array[i2,i5]));\nCREATE INDEX\n\nindexdb=# explain analyze select * from tbloom where (ARRAY[i2, i5]) &amp;&amp; array[898732] or (ARRAY[i2, i5]) &amp;&amp; array[123451];\n                                                              QUERY PLAN                                                              \n--------------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on tbloom  (cost=991.87..68961.41 rows=99750 width=24) (actual time=0.068..0.174 rows=41 loops=1)\n   Recheck Cond: ((ARRAY[i2, i5] &amp;&amp; '{898732}'::integer[]) OR (ARRAY[i2, i5] &amp;&amp; '{123451}'::integer[]))\n   Heap Blocks: exact=41\n   -&gt;  BitmapOr  (cost=991.87..991.87 rows=100000 width=0) (actual time=0.046..0.046 rows=0 loops=1)\n         -&gt;  Bitmap Index Scan on tbloom_array_idx  (cost=0.00..471.00 rows=50000 width=0) (actual time=0.030..0.030 rows=23 loops=1)\n               Index Cond: (ARRAY[i2, i5] &amp;&amp; '{898732}'::integer[])\n         -&gt;  Bitmap Index Scan on tbloom_array_idx  (cost=0.00..471.00 rows=50000 width=0) (actual time=0.015..0.015 rows=18 loops=1)\n               Index Cond: (ARRAY[i2, i5] &amp;&amp; '{123451}'::integer[])\n Planning time: 0.266 ms\n Execution time: 0.242 ms\n(10 rows)\n\nTime: 1.311 ms\n</code></pre> <p>\u6027\u80fd\u63d0\u5347\u660e\u663e</p>"},{"location":"postgres/index/index-invalid/#8","title":"8.\u8868\u4e2d\u6570\u636e\u91cf\u5c11\u65f6","text":"<pre><code>postgres=# create table tbl_index_less(a int);\nCREATE TABLE\n\npostgres=# create index tbl_index_less_a on tbl_index_less using btree (a);\nCREATE INDEX\n\n-- \u52a010\u6761\npostgres=# insert into tbl_index_less select generate_series(1,10);\nINSERT 0 10\n\npostgres=# analyze tbl_index_less ;\nANALYZE\n\npostgres=# explain analyze select * from tbl_index_less where a = 4;\n                                               QUERY PLAN                                               \n--------------------------------------------------------------------------------------------------------\n Seq Scan on tbl_index_less  (cost=0.00..1.12 rows=1 width=4) (actual time=0.013..0.016 rows=1 loops=1)\n   Filter: (a = 4)\n   Rows Removed by Filter: 9\n Planning time: 0.276 ms\n Execution time: 0.054 ms\n(5 rows)\n\n-- \u52a0100\u6761\npostgres=# insert into tbl_index_less select generate_series(10,100);\nINSERT 0 91\n\npostgres=# explain analyze select * from tbl_index_less where a = 4;\n                                               QUERY PLAN                                               \n--------------------------------------------------------------------------------------------------------\n Seq Scan on tbl_index_less  (cost=0.00..2.26 rows=1 width=4) (actual time=0.017..0.033 rows=1 loops=1)\n   Filter: (a = 4)\n   Rows Removed by Filter: 100\n Planning time: 0.236 ms\n Execution time: 0.062 ms\n(5 rows)\n\n-- 1000\u6761\npostgres=# insert into tbl_index_less select generate_series(100,1000);\nINSERT 0 901\n\npostgres=# analyze tbl_index_less ;\nANALYZE\npostgres=# explain analyze select * from tbl_index_less where a = 4;\n                                                              QUERY PLAN                                                              \n--------------------------------------------------------------------------------------------------------------------------------------\n Index Only Scan using tbl_index_less_a on tbl_index_less  (cost=0.28..8.29 rows=1 width=4) (actual time=0.010..0.010 rows=1 loops=1)\n   Index Cond: (a = 4)\n   Heap Fetches: 1\n Planning time: 0.073 ms\n Execution time: 0.023 ms\n(5 rows)\n\n</code></pre> <p>tips </p> <p>\u6570\u636e\u5e93\u662f\u5982\u4f55\u77e5\u9053\u8868\u4e2d\u7684\u6570\u636e\u91cf\u53ca\u6570\u636e\u5206\u5e03\u60c5\u51b5 \uff0c\u4e3b\u8981\u662f\u4f9d\u8d56\u7edf\u8ba1\u4fe1\u606f pg_class ,pg_stats\u3002</p> <p>\u5f53\u8868\u6570\u636e\u53d8\u66f4\u5f88\u5927\u65f6\uff0c\u5982\u6279\u91cf\u5bfc\u5165\u6570\u636e\u6216\u5220\u9664\u6570\u636e\u65f6\u3002\u9700\u8981\u53ca\u65f6\u4f7f\u7528analyze\u66f4\u65b0\u7edf\u8ba1\u4fe1\u606f\u3002</p> <p>\u5173\u4e8e null  https://yq.aliyun.com/articles/241219</p> <p>\u67e5\u770b\u8868\u987a\u5e8f\u626b\u63cf\u548c\u7d22\u5f15\u7684\u6b21\u6570</p> <pre><code>select * from pg_stat_all_tables where relname = 'tab_name';\nselect * from pg_stat_all_indexes where relname = 'tbl_name';\n</code></pre> <p>\u521b\u5efa\u7d22\u5f15 http://www.cnblogs.com/alianbog/p/5631505.html </p> <p>mysql \u7d22\u5f15\u5efa\u8bae \u53c2\u8003 https://mp.weixin.qq.com/s/xdbo67F72a9eTV93TEuL6w</p> <p>\u7d22\u5f15\u5229\u7528\u7edf\u8ba1</p> <pre><code>A PostgreSQL extension for collecting statistics about predicates, helping find what indices are missing\n</code></pre>"},{"location":"postgres/index/index-invalid/#_4","title":"\u5229\u7528\u7d22\u5f15\u5931\u6548\u6539\u53d8\u6267\u884c\u8ba1\u5212\u6848\u4f8b","text":"<p>\u8868\u5b9a\u4e49&amp;\u6570\u636e\u5206\u5e03</p> <pre><code>create table tb1(id int primary key,c1 int);\ncreate index on tb1(c1);\ninsert into tb1 select id, id/10000 from generate_series(1,10000000)id;\n</code></pre> <p>SQL&amp;\u6267\u884c\u8ba1\u5212</p> <pre><code>postgres=# explain analyze select * from tb1 where c1=999 order by id limit 10; QUERY PLAN\n-------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.43..332.29 rows=10 width=8) (actual time=1571.315..1571.319 rows=10 loops=1)\n-&gt; Index Scan using tb1_pkey on tb1 (cost=0.43..328935.03 rows=9912 width=8) (actual time=1571.314..1571.316 rows=10 loops=1)\nFilter: (c1 = 999)\nRows Removed by Filter: 9989999 Planning Time: 0.112 ms\nExecution Time: 1571.337 ms\n(6 rows)\n</code></pre> <p>\u4e0a\u9762Index Scan\u4f30\u7b97\u7684\u884c\u6570\u548ccost\u90fd\u6bd4\u8f83\u51c6\u786e\uff0c\u4f46\u8bc4\u4f30LIMIT\u5b50\u53e5\u65f6\uff0c\u4f18\u5316\u5668\u5047\u8bbe\u6570\u636e\u5206\u5e03\u662f\u5747\u5300\u7684\uff0c \u53ea\u9700\u626b\u63cf\u4e3b\u952e\u7d22\u5f15\u7684 10/9912\u5373\u53ef\u627e\u523010\u6761\u5339\u914d\u7684\u8bb0\u5f55\uff0c\u6700\u7ec8\u7684\u4f30\u7b97\u4ee3\u4ef7\u4e5f\u88abLIMIT\u964d\u523010/9921\u3002\u4f46\u5b9e\u9645\u4e0a\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\u90fd\u96c6\u4e2d\u5728\u7d22\u5f15\u7684\u5c3e\u90e8\u3002</p>"},{"location":"postgres/index/index-invalid/#sql","title":"sql \u6539\u5199","text":"<p>SQL\u6539\u5199\u65b9\u6cd51:\u7834\u574f\u7d22\u5f15\u6392\u5e8f</p> <pre><code>select * from tb1 where c1=999 order by id+0 limit 10;\n</code></pre> <p>SQL\u6539\u5199\u65b9\u6cd52:\u7269\u5316\u5b50\u67e5\u8be2</p> <pre><code>WITH t AS MATERIALIZED(\nselect * from tb1 where c1=999 )\nselect * from t order by id limit 10\n</code></pre>"},{"location":"postgres/index/index01/","title":"\u6570\u636e\u5e93\u7d22\u5f15\u7c7b\u578b\u53ca\u4f7f\u7528\u573a\u666f","text":""},{"location":"postgres/index/index01/#_1","title":"\u7528\u9014","text":""},{"location":"postgres/index/index01/#_2","title":"\u4f18\u70b9","text":"<ul> <li>\u4e3b\u952e\u552f\u4e00\u7ea6\u675f</li> <li>\u52a0\u901f\u68c0\u7d22</li> <li>\u6392\u5e8f </li> </ul>"},{"location":"postgres/index/index01/#_3","title":"\u7f3a\u70b9","text":"<ul> <li>\u66f4\u65b0\u6570\u636e\u65f6\u9700\u8981\u540c\u65f6\u7ef4\u62a4\u5bf9\u5e94\u7d22\u5f15</li> <li>\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\uff0c\u751a\u81f3\u6bd4\u8868\u6570\u636e\u672c\u8eab\u8fd8\u8981\u591a</li> </ul>"},{"location":"postgres/index/index01/#_4","title":"\u4f7f\u7528\u573a\u666f\u5229\u5f0a\u5206\u6790","text":"<ul> <li>TP\u4e0eAP\u5e94\u7528</li> <li>\u8bfb\u5199\u4f7f\u7528\u6bd4\u4f8b</li> <li>\u70b9\u67e5\u8be2\u6279\u91cf\u67e5\u8be2</li> </ul>"},{"location":"postgres/index/index01/#_5","title":"\u521b\u5efa\u7d22\u5f15","text":"<pre><code>\\h create index\n\u547d\u4ee4\uff1a       CREATE INDEX\n\u63cf\u8ff0\uff1a       \u5efa\u7acb\u65b0\u7684\u7d22\u5f15\n\u8bed\u6cd5\uff1a\nCREATE [ UNIQUE ] INDEX [ CONCURRENTLY ] [ [ IF NOT EXISTS ] \u540d\u79f0 ] ON \u8868\u540d [ USING \u65b9\u6cd5 ]\n    ( { \u5217\u540d\u79f0 | ( \u8868\u8fbe\u5f0f ) } [ COLLATE \u6821\u5bf9\u89c4\u5219 ] [ \u64cd\u4f5c\u7b26\u7c7b\u578b\u7684\u540d\u79f0 ] [ ASC | DESC ] [ NULLS { FIRST | LAST } ] [, ...] )\n    [ WITH ( \u5b58\u50a8\u53c2\u6570 = \u503c [, ... ] ) ]\n    [ TABLESPACE \u8868\u7a7a\u95f4\u7684\u540d\u79f0 ]\n    [ WHERE \u8ff0\u8bcd ]\n</code></pre>"},{"location":"postgres/index/index01/#_6","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ol> <li>\u589e\u52a0maintenance_work_mem,\u6709\u5229\u4e8e\u63d0\u9ad8\u521b\u5efa\u7d22\u5f15\u7684\u6548\u7387</li> <li>\u521b\u5efa\u7d22\u5f15\u65f6\u4f1a\u6709\u4e00\u4e2ashare\u9501\u9501\u8868\uff0c\u786e\u4fdd\u8868\u4e0d\u80fd\u6709\u4efb\u4f55\u66f4\u6539\u3002\u5728\u751f\u4ea7\u7cfb\u7edf\u4e2d\u5982\u679c\u5728\u4e00\u4e2a\u5927\u8868\u4e2d\u963b\u585e\u65f6\u95f4\u8fc7\u957f\u4f1a\u6709\u95ee\u9898\uff0c\u89e3\u51b3\u65b9\u6cd5\uff0c create index CONCURRENTLY \u3002    \u521b\u5efa\u7684\u65f6\u95f4\u4f1a\u589e\u52a0\u4e00\u500d\uff0c\u4e0d\u4fdd\u8bc1\u4f1a\u521b\u5efa\u6210\u529f\u3002</li> </ol>"},{"location":"postgres/index/index01/#_7","title":"\u6570\u636e\u5e93\u7d22\u5f15\u7c7b\u578b\u6982\u89c8(\u5b9e\u73b0\u7b97\u6cd5)","text":"<ul> <li>b-tree\u9002\u5408\u6240\u6709\u7684\u6570\u636e\u7c7b\u578b\uff0c\u652f\u6301\u6392\u5e8f\uff0c\u652f\u6301\u5927\u4e8e\u3001\u5c0f\u4e8e\u3001\u7b49\u4e8e\u3001\u5927\u4e8e\u6216\u7b49\u4e8e\u3001\u5c0f\u4e8e\u6216\u7b49\u4e8e\u7684\u641c\u7d22\u3002LIKE,ILIKE,~ \u641c\u7d22\u3002  </li> <li>hash \u53ea\u652f\u6301\u7b49\u503c\u67e5\u8be2,\u7279\u522b\u9002\u7528\u4e8e\u5b57\u6bb5VALUE\u975e\u5e38\u957f,\u4f8b\u5982\u5f88\u957f\u7684\u5b57\u7b26\u4e32\uff0c\u5e76\u4e14\u7528\u6237\u53ea\u9700\u8981\u7b49\u503c\u641c\u7d22\uff0c\u5efa\u8bae\u4f7f\u7528hash index\u3002 \u6ce8\u610f\uff1ahash\u7d22\u5f15\u6ca1\u6709\u4ea7\u751fwal,\u4e3b\u4ece\u6d41\u590d\u5236\u65f6\u4ece\u5e93\u6ca1\u6709\u521b\u5efa </li> <li>gin\u662f\u5012\u6392\u7d22\u5f15,\u9002\u5408\u591a\u503c\u7c7b\u578b\uff0c\u4f8b\u5982\u6570\u7ec4\u3001JSON\u3001\u5168\u6587\u68c0\u7d22\u3001TOKEN\u3002  </li> <li>gist\uff1aR-Tree\u7d22\u5f15\uff0c\u652f\u6301\u5305\u542b\uff0c\u76f8\u4ea4\uff0c\u8ddd\u79bb\uff0c\u70b9\u9762\u5224\u65ad\u7b49\u67e5\u8be2\uff1b\u9002\u5408\u51e0\u4f55\u7c7b\u578b\u3001\u8303\u56f4\u7c7b\u578b\u3001\u5168\u6587\u68c0\u7d22\u3001\u5f02\u6784\u7c7b\u578b\u7b49\u3002 </li> <li>sp-gist\uff1a\u7a7a\u95f4\u5206\u533a\uff08\u5e73\u8861\uff09r-tree\uff0c\u652f\u6301\u5305\u542b\uff0c\u76f8\u4ea4\uff0c\u8ddd\u79bb\uff0c\u70b9\u9762\u5224\u65ad\u7b49\u67e5\u8be2\uff1b\u9002\u5408\u51e0\u4f55\u7c7b\u578b\u3001\u8303\u56f4\u7c7b\u578b\u3001\u5168\u6587\u68c0\u7d22\u3001\u5f02\u6784\u7c7b\u578b\u7b49\u3002 </li> <li>brin\uff1a\u5757\u7ea7\u7d22\u5f15\uff0c\u9002\u5408\u7269\u7406\u5b58\u50a8\u4e0e\u5217\u503c\u5b58\u5728\u8f83\u597d\u76f8\u5173\u6027\u7684\u5b57\u6bb5\u3002\u6bd4\u5982\u65f6\u5e8f\u6570\u636e\u3001\u7269\u8054\u7f51\u4f20\u611f\u6570\u636e\u3001FEED\u6570\u636e\u7b49\u3002\u652f\u6301\u8303\u56f4\u67e5\u8be2\u3001\u7b49\u503c\u67e5\u8be2\u3002  </li> <li>rum\uff1a\u6269\u5c55\u7d22\u5f15\u63a5\u53e3\uff0c\u652f\u6301\u5168\u6587\u68c0\u7d22\uff0c\u652f\u6301\u9644\u52a0\u6807\u91cf\u7c7b\u578b\u7684\u5168\u6587\u68c0\u7d22\uff0c\u652f\u6301\u5e26\u4f4d\u7f6e\u5173\u7cfb\u7684\u5168\u6587\u68c0\u7d22\u3002  </li> <li>bloom \u5e03\u9686\u8fc7\u6ee4\u5668\uff0c\u652f\u6301\u5bf9\u4efb\u610f\u5217\u7684\u7ec4\u5408\u67e5\u8be2\u3002</li> </ul> <p>\u8be6\u7ec6\u4ecb\u7ecd https://leopard.in.ua/2015/04/13/postgresql-indexes   </p> <p>\u901a\u8fc7pageinspect debug \u7d22\u5f15</p> <p>\u67e5\u770b\u6570\u636e\u5e93\u6709\u54ea\u4e9b\u7d22\u5f15\u7c7b\u578b</p> <pre><code>select * from pg_am;\n amname |  amhandler  | amtype \n--------+-------------+--------\n btree  | bthandler   | i\n hash   | hashhandler | i\n gist   | gisthandler | i\n gin    | ginhandler  | i\n spgist | spghandler  | i\n brin   | brinhandler | i\n(6 \u884c\u8bb0\u5f55)\n\n</code></pre>"},{"location":"postgres/index/index01/#_8","title":"\u6570\u636e\u7d22\u5f15\u7c7b\u578b\uff08\u521b\u5efa\u65b9\u5f0f\uff09","text":"<ul> <li>\u90e8\u5206\u7d22\u5f15</li> <li>\u8868\u8fbe\u5f0f\u7d22\u5f15</li> <li>\u552f\u4e00\u7d22\u5f15</li> <li>\u591a\u5217\u7d22\u5f15</li> </ul>"},{"location":"postgres/index/index01/#_9","title":"\u5e94\u7528\u4e3e\u4f8b","text":""},{"location":"postgres/index/index01/#_10","title":"\u5b57\u7b26\u4e32\u7c7b\u578b\u5efa\u7acb\u7d22\u5f15\u6280\u5de7","text":"<ol> <li>\u5012\u5e8f\u5b58\u50a8</li> </ol> <p>\u7531\u4e8e\u8eab\u4efd\u8bc1\u524d\u9762\u7684\u5730\u533a\u7801\u90fd\u662f\u76f8\u540c\u7684\uff0c\u6240\u4ee5\u5b58\u50a8\u8eab\u4efd\u8bc1\u65f6\uff0c\u53ef\u4ee5\u5c06\u5b83\u5012\u8fc7\u6765\u5b58\u3002\u8eab\u4efd\u8bc1\u540e6\u4f4d\u4f5c\u4e3a\u524d\u7f00\u7d22\u5f15\u6709\u4e00\u5b9a\u7684\u533a\u5206\u5ea6</p> <ol> <li>\u957f\u6587\u672c\u5148\u63d0\u53d6\u6458\u8981\u540e\u521b\u5efa\u7d22\u5f15 </li> </ol> <p>\u53ef\u4ee5\u5728\u8868\u4e0a\u518d\u521b\u5efa\u4e00\u4e2a\u6458\u8981\u5b57\u6bb5\uff0c\u540c\u65f6\u5728\u8fd9\u4e2a\u5b57\u6bb5\u4e0a\u521b\u5efa\u7d22\u5f15\u3002 hash \u3001 md5 \u3001 crc\u7b49\u6458\u8981\u7b97\u6cd5\u3002</p>"},{"location":"postgres/index/index01/#_11","title":"\u68c0\u67e5\u7f3a\u5931\u7684\u7d22\u5f15","text":"<p>\u5c1d\u8bd5\u67e5\u627e\u51fa\u7ecf\u5e38\u88ab\u626b\u63cf\u7684\u5927\u578b\u8868\uff08avg\u9ad8\uff09,\u987a\u5e8f\u626b\u63cf\u7684\u5360\u6bd4\u9ad8\uff0c\u90a3\u4e9b\u8868\u5c06\u51fa\u73b0\u5728\u7ed3\u679c\u7684\u9876\u90e8\u3002</p> <pre><code>SELECT schemaname, relname, seq_scan,seq_tup_read,idx_scan,seq_tup_read / seq_scan AS avg FROM pg_stat_user_tables WHERE seq_scan &gt; 0 ORDER BY seq_tup_read DESC LIMIT 20;\n</code></pre>"},{"location":"postgres/index/index01/#gistgin","title":"GiST\u548cGIN\u7d22\u5f15\u7c7b\u578b","text":"<p>\u4e24\u79cd\u7c7b\u578b\u7684\u7d22\u5f15\u53ef\u4ee5\u7528\u4e8e\u52a0\u5feb\u5168\u6587\u641c\u7d22\u3002\u6ce8\u610f\u5168\u6587\u68c0\u7d22\u4e0d\u4e00\u5b9a\u975e\u8981\u4f7f\u7528\u7d22\u5f15\u3002 \u4f46\u662f\u5728\u89c4\u5219\u57fa\u7840\u4e0a\u641c\u7d22\u5217\u7684\u60c5\u51b5\u4e0b\uff0c\u7d22\u5f15\u5f80\u5f80\u662f\u53ef\u53d6\u7684\u3002</p> <pre><code>create extention pg_trgm;\nCREATE INDEX name ON table USING gist(column);\n\u521b\u5efa\u4ee5GiST\uff08\u901a\u7528\u641c\u7d22\u6811\uff09\u4e3a\u57fa\u7840\u7684\u7d22\u5f15\uff0ccolumn\u53ef\u4ee5\u662ftsvector or tsquery \u7c7b\u578b\u3002\n</code></pre> <pre><code>create extention pg_trgm; \nCREATE INDEX name ON table USING gin(column);\n\u521b\u5efa\u4ee5GIN\uff08\u57fa\u56e0\u5012\u6392\u7d22\u5f15\uff09\u4e3a\u57fa\u7840\u7684\u7d22\u5f15\uff0ccolumn\u5fc5\u987b\u662ftsvector\u7c7b\u578b\u3002\n</code></pre> <p>\u5728\u4e24\u4e2a\u7d22\u5f15\u7c7b\u578b\u4e4b\u95f4\u6709\u7740\u5de8\u5927\u7684\u6027\u80fd\u5dee\u5f02\uff0c\u56e0\u6b64\u4e86\u89e3\u5b83\u4eec\u7684\u7279\u6027\u662f\u5f88\u91cd\u8981\u7684\u3002</p> <p>GiST\u7d22\u5f15\u662f\u6709\u635f\u8017\u7684\uff0c\u8fd9\u610f\u5473\u7740\u8be5\u7d22\u5f15\u53ef\u80fd\u4f1a\u4ea7\u751f\u9519\u8bef\u7684\u5339\u914d\uff0c \u5e76\u4e14\u6709\u5fc5\u8981\u68c0\u67e5\u5b9e\u9645\u7684\u8868\u884c\u6d88\u9664\u8fd9\u79cd\u9519\u8bef\u5339\u914d\uff08PostgreSQL\u9700\u8981\u65f6\u81ea\u52a8\u6267\u884c\uff09\u3002 GiST\u7d22\u5f15\u662f\u6709\u635f\u8017\u7684\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u6587\u6863\u5728\u7d22\u5f15\u4e2d\u901a\u8fc7\u4e00\u4e2a\u56fa\u5b9a\u957f\u5ea6\u7684\u6807\u7b7e\u8fdb\u884c\u8868\u793a\u3002 \u5b83\u662f\u901a\u8fc7\u6563\u5217\u6bcf\u4e2a\u5355\u8bcd\u5230\u4e00\u4e2an\u4f4d\u7684\u5b57\u7b26\u4e32\u7684\u5355\u4e00\u7684\u70b9\u4ea7\u751f\uff0c\u6240\u6709\u8fd9\u4e9b\u4f4dOR-ed\u4e00\u8d77\u4ea7\u751f\u4e00\u4e2an\u4f4d\u7684\u6587\u4ef6\u6807\u7b7e\u3002 \u5f53\u4e24\u4e2a\u5355\u8bcd\u6563\u5217\u5230\u76f8\u540c\u70b9\u7684\u4f4d\u7f6e\uff0c\u5c06\u6709\u4e00\u4e2a\u9519\u8bef\u5339\u914d\u3002\u5982\u679c\u67e5\u8be2\u4e2d\u7684\u6240\u6709\u5355\u8bcd\u5339\u914d\uff08\u771f\u5b9e\u7684\u6216\u9519\u8bef\u7684\uff09\uff0c \u5219\u5fc5\u987b\u68c0\u7d22\u8868\u884c\u67e5\u770b\u5339\u914d\u662f\u5426\u662f\u6b63\u786e\u7684\u3002</p> <p>\u6570\u636e\u4e22\u5931\u5bfc\u81f4\u4e86\u6027\u80fd\u4e0b\u964d\uff0c\u7531\u4e8e\u8868\u8bb0\u5f55\u7684\u4e0d\u5fc5\u8981\u7684\u83b7\u53d6\uff0c\u4ea7\u751f\u4e86\u9519\u8bef\u7684\u5339\u914d\u3002 \u7531\u4e8e\u968f\u673a\u8bbf\u95ee\u8868\u8bb0\u5f55\u662f\u7f13\u6162\u7684\uff0c\u8fd9\u9650\u5236\u4e86GiST\u7d22\u5f15\u7684\u6548\u80fd\u3002\u9519\u8bef\u5339\u914d\u7684\u53ef\u80fd\u6027\u53d6\u51b3\u4e8e\u51e0\u4e2a\u56e0\u7d20\uff0c \u7279\u522b\u662f\u72ec\u7279\u8bcd\u7684\u6570\u91cf\uff0c\u6240\u4ee5\u63a8\u8350\u4f7f\u7528\u8bcd\u5178\u6765\u964d\u4f4e\u8fd9\u4e9b\u6570\u91cf\u3002</p> <p>GIN\u7d22\u5f15\u5e76\u6ca1\u6709\u635f\u8017\u6807\u51c6\u67e5\u8be2\uff0c\u4f46\u5b83\u4eec\u7684\u6027\u80fd\u53d6\u51b3\u4e8e\u5bf9\u6570\u72ec\u7279\u7684\u5355\u8bcd\u6570\u3002 \uff08\u7136\u800c\uff0cGIN\u7d22\u5f15\u53ea\u5b58\u50a8tsvector\u503c\u7684\u5b57\uff08\u8bcd\uff09\uff0c\u800c\u4e0d\u662f\u5b83\u4eec\u7684\u6743\u91cd\u6807\u7b7e\u3002\u56e0\u6b64\uff0c \u5f53\u4f7f\u7528\u6d89\u53ca\u6743\u91cd\u7684\u67e5\u8be2\u65f6\uff0c\u9700\u8981\u590d\u67e5\u4e00\u4e2a\u8868\u884c\u3002\uff09</p> <p>\u5728\u9009\u62e9\u8981\u4f7f\u7528\u7684\u7d22\u5f15\u7c7b\u578b\u65f6\uff0cGiST\u6216\u8005GIN\u8003\u8651\u8fd9\u4e9b\u6027\u80fd\u4e0a\u7684\u5dee\u5f02\uff1a</p> <ul> <li> <p>GIN\u7d22\u5f15\u67e5\u627e\u6bd4GiST\u5feb\u7ea6\u4e09\u500d</p> </li> <li> <p>GIN\u7d22\u5f15\u5efa\u7acb\u6bd4GIST\u9700\u8981\u5927\u7ea6\u4e09\u500d\u7684\u65f6\u95f4\u3002</p> </li> <li> <p>GIN\u7d22\u5f15\u66f4\u65b0\u6bd4GiST\u7d22\u5f15\u901f\u5ea6\u6162\uff0c\u4f46\u5982\u679c\u5feb\u901f\u66f4\u65b0\u652f\u6301\u65e0\u6548\uff0c\u5219\u6162\u4e86\u5927\u7ea610\u500d\uff08\u8be6\u60c5\u8bf7\u89c1\u8282\u7b2c 58.4.1 \u8282\uff09</p> </li> <li> <p>GIN\u7d22\u5f15\u6bd4GiST\u7d22\u5f15\u5927\u4e24\u5230\u4e09\u500d</p> </li> </ul> <p>\u4e00\u822c\u6765\u8bf4\uff0cGIN\u7d22\u5f15\u5bf9\u9759\u6001\u6570\u636e\u662f\u6700\u597d\u7684\uff0c\u56e0\u4e3a\u67e5\u627e\u901f\u5ea6\u5f88\u5feb\u3002\u5bf9\u4e8e\u52a8\u6001\u6570\u636e\uff0c GiST\u7d22\u5f15\u66f4\u65b0\u6bd4\u8f83\u5feb\u3002\u5177\u4f53\u800c\u8a00\uff0cGiST\u7d22\u5f15\u975e\u5e38\u9002\u5408\u52a8\u6001\u6570\u636e\uff0c\u5e76\u4e14\u5982\u679c\u72ec\u7279\u7684\u5b57\uff08\u8bcd\uff09\u5728100,000\u4ee5\u4e0b\uff0c \u5219\u6bd4\u8f83\u5feb\uff0c\u800cGIN\u7d22\u5f15\u5c06\u5904\u7406100,000+\u8bcd\u6c47\uff0c\u4f46\u662f\u66f4\u65b0\u6bd4\u8f83\u6162\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0cGIN\u7d22\u5f15\u7f16\u8bd1\u65f6\u95f4\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0maintenance_work_mem\u6539\u8fdb\uff0c \u800cGiST\u7d22\u5f15\u7f16\u8bd1\u65f6\u95f4\u5bf9\u53c2\u6570\u4e0d\u654f\u611f\u3002 </p> <p>\u539f\u6587</p> <p>\u5176\u4ed6</p> <p>Django\u4f7f\u7528postgresql\u505a\u6570\u636e\u5e93 db_index\u521b\u5efa\u7d22\u5f15\u65f6\u4f1a\u521b\u5efa\u7b2c\u4e8c\u4e2a\u7d22\u5f15varchar_pattern_ops\u95ee\u9898</p> <p>https://blog.csdn.net/xiaofuge027/article/details/95338398</p> <p>\u5220\u9664\u65e0\u7528\u7d22\u5f15</p> <pre><code>DO $$DECLARE r record;\nBEGIN\nFOR r IN select  indexrelname from pg_stat_user_indexes where schemaname = 'public' and indexrelname like '%like'\n\nLOOP\n    EXECUTE 'drop index ' || r.indexrelname ||';';\nEND LOOP;\nEND$$;\n</code></pre> <p>\u4e00\u5f20\u8868\u4e2d\u7684\u7d22\u5f15\u5229\u7528\u60c5\u51b5</p> <pre><code>select \n    relname, indexrelname, idx_scan, idx_tup_read, idx_tup_fetch \nfrom \n    pg_stat_user_indexes \nwhere\n    relname = 't_name' \norder by \n    idx_scan asc, idx_tup_read asc, idx_tup_fetch asc;\n</code></pre> <p>\u6240\u6709\u8868\u4e2d\u7684\u7d22\u5f15\u5229\u7528\u60c5\u51b5</p> <pre><code>select \n    relname, indexrelname, idx_scan, idx_tup_read, idx_tup_fetch \nfrom \n    pg_stat_user_indexes \norder by \n    idx_scan asc, idx_tup_read asc, idx_tup_fetch asc;\n\n</code></pre>"},{"location":"postgres/index/index01/#_12","title":"\u7d22\u5f15\u7ba1\u7406","text":"<pre><code>reindex (verbose) table \n</code></pre> <p>\u5e76\u884c\u91cd\u5efa\u7d22\u5f15</p>"},{"location":"postgres/index/partition/","title":"\u539f\u751f\u5206\u533a\u8868","text":""},{"location":"postgres/index/partition/#_1","title":"\u5206\u533a\u8868","text":"<p>\u6570\u636e\u5e93\u5206\u533a\u662f\u4e00\u79cd\u5c06\u6570\u636e\u505a\u7269\u7406\u5206\u7247\u7684\u6570\u636e\u5e93\u8bbe\u8ba1\u6280\u672f\uff0c\u867d\u7136\u5206\u533a\u6280\u672f\u53ef\u4ee5\u6709\u591a\u79cd\u5b9e\u73b0\u65b9\u6cd5\uff0c</p> <p>\u4f46\u5176\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u5728\u7279\u5b9a\u7684SQL\u64cd\u4f5c\u4e2d\u51cf\u5c11\u6570\u636e\u8bfb\u53d6\u7684\u603b\u91cf\u4ee5\u7f29\u51cf\u54cd\u5e94\u65f6\u95f4\u3002</p> <p>\u4f7f\u7528\u5206\u533a\u8868\u5bf9\u5e94\u7528\u7a0b\u5e8f\u662f\u900f\u660e\u7684\uff0c\u5bf9\u4e8eINSERT,UPDATE,DELETE,SELECT\u64cd\u4f5c\uff0c\u90fd\u53ea\u9700\u8981\u5bf9\u7236\u8868tbl\u8fdb\u884c\u64cd\u4f5c\uff0c\u800c\u65e0\u9700\u5173\u5fc3\u64cd\u4f5c\u54ea\u4e00\u5f20\u5b50\u8868\u3002</p>"},{"location":"postgres/index/partition/#_2","title":"\u5206\u533a\u65b9\u5f0f","text":"<ul> <li>\u6c34\u5e73\u5206\u533a  </li> </ul> <p>\u6bd4\u5982\u6309\u7167\u65f6\u95f4\u7ef4\u5ea6\u8fdb\u884c\u5212\u5206\uff0c\u8ba2\u5355\u65f6\u95f4\u3002  </p> <p>\u6c34\u5e73\u5206\u533a\u5212\u5206\u65b9\u5f0f HASH , LIST , RANGE   </p> <ul> <li>\u5782\u76f4\u5206\u533a</li> </ul> <p>\u8303\u5f0f\u89c4\u8303 \uff1a \u8ba2\u5355\u6570\u636e \uff08\u5ba2\u6237\u8868\uff0c\u5546\u54c1\u8868\uff0c\u8ba2\u5355\u8868\uff09</p>"},{"location":"postgres/index/partition/#_3","title":"\u4f18\u70b9","text":"<ul> <li>\u6027\u80fd\u63d0\u5347\u3002\u9488\u5bf9\u5177\u4f53\u8303\u56f4\u67e5\u8be2\u6216\u70b9\u67e5\u8be2\u3002</li> <li>\u6570\u636e\u7ba1\u7406\u3002 \u5f52\u6863\uff0c\u5220\u9664\u3002\u7279\u522b\u662f\u4ee5\u4e00\u4e2a\u5206\u533a\u505a\u4e3a\u64cd\u4f5c\u5355\u5143\u3002</li> <li>\u6570\u636e\u5e93\u7ba1\u7406\u3002\u7edf\u8ba1\u4fe1\u606f\uff0cvacuum, repack \u64cd\u4f5c\u7b49</li> </ul>"},{"location":"postgres/index/partition/#_4","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u5206\u533a\u952e\u9009\u53d6\uff0c\u5982\u8868\u5355\u7684\u521b\u5efa\u65f6\u95f4\u3002</li> <li>\u5206\u533a\u5927\u5c0f\u7684\u5212\u5206\u3002\u4e00\u4e2a\u8868\u591a\u5927\u65f6\u5f00\u59cb\u8003\u8651\u5206\u533a\u3002\u4e00\u4e2a\u5206\u533a\u591a\u5927\u6bd4\u8f83\u5408\u9002\u3002\uff08\u7efc\u5408\u5177\u4f53\u4e1a\u52a1\uff09</li> <li>\u5206\u533a\u8868\u6570\u91cf\u63a7\u5236\u3002\u8fc7\u591a\u7684\u5206\u533a\u8868\u53ef\u80fd\u662f\u4e00\u79cd\u707e\u96be\u3002\u53ef\u4ee5\u8003\u8651\u5408\u5e76\u5206\u533a\uff0c\u5f52\u6863\u6570\u636e\u3002</li> <li>\u9ed8\u8ba4\u5206\u533a</li> <li>\u8868\u7ed3\u6784\u66f4\u6539\u5bf9\u73b0\u6709\u8868\u7ed3\u6784\u7684\u5f71\u54cd\u3002\u66f4\u65b0\u7236\u8868\u7ed3\u6784\u5bf9\u5df2\u6709\u5b50\u8868\u7ed3\u6784\u7684\u5f71\u54cd\u3002</li> <li>\u7d22\u5f15\u64cd\u4f5c\uff0c\u5bf9\u5b50\u8868\u65e0\u6548</li> <li>\u5206\u533a\u952e\u66f4\u65b0</li> <li>\u4e3b\u952e\uff0c\u552f\u4e00\u952e\u7ea6\u675f\u3002 \u5168\u5c40\u8fd8\u662f\u5b50\u8868\u6709\u6548\u3002(\u552f\u4e00\u952e+\u5206\u533a\u952e),\u4e3b\u8868\u7684\u4e3b\u952e,\u552f\u4e00\u952e\u5fc5\u987b\u5305\u542b\u5206\u533a\u952e\u3002</li> <li>\u65b0\u5206\u533a\u521b\u5efa\u65b9\u5f0f\u3002\u6bd4\u5982\u6309\u7167\u6708\u5206\u533a\uff0c\u4e0b\u4e2a\u6708\u7684\u5b50\u8868\u662f\u624b\u52a8\u8fd8\u662f\u81ea\u52a8\u521b\u5efa\u3002\u81ea\u52a8\u521b\u5efa\u5bf9\u65b0\u63d2\u5165\u6570\u636e\u7684\u5206\u533a\u952e\u65f6\u95f4\u9700\u8981\u4e25\u683c\u9a8c\u8bc1\u3002</li> <li>enable_partition_pruning \u9700\u8981\u5f00\u542f</li> </ul>"},{"location":"postgres/index/partition/#_5","title":"\u4f7f\u7528\u9650\u5236","text":"<ul> <li>\u6ca1\u6709\u529e\u6cd5\u521b\u5efa\u8de8\u8d8a\u6240\u6709\u5206\u533a\u7684\u6392\u9664\u7ea6\u675f\uff0c\u53ea\u53ef\u80fd\u5355\u4e2a\u7ea6\u675f\u6bcf\u4e2a\u53f6\u5b50\u5206\u533a\u3002</li> <li>\u5206\u533a\u8868\u4e0a\u7684\u60df\u4e00\u7ea6\u675f\uff08\u4e5f\u5c31\u662f\u4e3b\u952e\uff09\u5fc5\u987b\u5305\u62ec\u6240\u6709\u5206\u533a\u952e\u5217\u3002\u5b58\u5728\u6b64\u9650\u5236\u662f\u56e0\u4e3aPostgreSQL\u53ea\u80fd\u6bcf\u4e2a\u5206\u533a\u4e2d\u5206\u522b\u5f3a\u5236\u5b9e\u65bd\u552f\u4e00\u6027\u3002 </li> </ul>"},{"location":"postgres/index/partition/#_6","title":"\u666e\u901a\u8868\u8f6c\u6362\u4e3a\u5206\u533a\u8868","text":"<ul> <li>pg \u7248\u672c &lt; 12 \u5229\u7528pathman \u53ef\u5728\u7ebf\u5e73\u6ed1\u8f6c\u6362</li> <li>pg \u7248\u672c &gt;=12 \u539f\u59cb\u65b9\u5f0f </li> </ul> <p>\u601d\u8def\uff1a</p> <p>1 \u65b0\u5efa\u4e00\u5f20\u7ed3\u6784\u5b8c\u5168\u76f8\u540c\u7684\u8868\uff0c</p> <p>2 \u5c06\u539f\u8868\u4f5c\u4e3a\u65b0\u8868\u5b50\u8868 </p> <p>3 \u4fee\u6539\u5bf9\u6362\u8868\u540d \uff08\u8fc7\u7a0b\u52a0\u9501\uff09</p>"},{"location":"postgres/index/partition/#_7","title":"\u5206\u533a\u8868\u793a\u4f8b","text":"<ul> <li>LIST \u5206\u533a</li> </ul> <pre><code>CREATE TABLE tbl_list(\n  id bigserial,\n  ival int,\n  cval char(1),\n  dval timestamp default now(),\n  primary key(id, ival)\n) partition by list(ival);\ncreate table tbl_list_0 partition of tbl_list for values in (0);\ncreate table tbl_list_1_2 partition of tbl_list for values in (1,2);\ncreate table tbl_list_default partition of tbl_list default;\n\n</code></pre> <ul> <li>RANGE \u5206\u533a</li> </ul> <pre><code>CREATE TABLE tbl_range(\n  id bigserial,\n  ival int,\n  cval char(1),\n  dval timestamp default now(),\n  primary key(id, dval)\n) partition by range(dval);\ncreate table tbl_range_202001 partition of tbl_range for values from ('2020-01-01 00:00:00') to ('2020-02-01 00:00:00');\ncreate table tbl_range_202002 partition of tbl_range for values from ('2020-02-01 00:00:00') to ('2020-03-01 00:00:00');\ncreate table tbl_range_default partition of tbl_range default;\n\n</code></pre> <ul> <li>HASH \u5206\u533a  \uff0c\u4e0d\u80fd\u5305\u542b\u9ed8\u8ba4\u5206\u533a</li> </ul> <pre><code>CREATE TABLE tbl_hash(\n  id bigserial,\n  ival int,\n  cval char(1),\n  dval timestamp default now(),\n  primary key(id, ival)\n) partition by hash(ival);\ncreate table tbl_hash_0 partition of tbl_hash for values WITH (MODULUS 3, REMAINDER 0);\ncreate table tbl_hash_1 partition of tbl_hash for values WITH (MODULUS 3, REMAINDER 1);\ncreate table tbl_hash_2 partition of tbl_hash for values WITH (MODULUS 3, REMAINDER 2);\n</code></pre>"},{"location":"postgres/index/partman/","title":"Partman\u63d2\u4ef6","text":""},{"location":"postgres/index/partman/#_1","title":"\u5206\u533a\u8868","text":""},{"location":"postgres/index/template/","title":"\u6a21\u677f\u6570\u636e\u5e93","text":""},{"location":"postgres/index/template/#_1","title":"\u6a21\u677f\u6570\u636e\u5e93","text":"<p>\u6a21\u677f\u6570\u636e\u5e93\u5c31\u662f\u521b\u5efa\u65b0database\u65f6\uff0cPostgreSQL\u4f1a\u57fa\u4e8e\u6a21\u677f\u6570\u636e\u5e93\u5236\u4f5c\u4e00\u4efd\u526f\u672c\uff0c\u5176\u4e2d\u4f1a\u5305\u542b\u6240\u6709\u7684\u6570\u636e\u5e93\u8bbe\u7f6e\u548c\u6570\u636e\u6587\u4ef6\u3002 PostgreSQL\u5b89\u88c5\u597d\u4ee5\u540e\u4f1a\u9ed8\u8ba4\u9644\u5e26\u4e24\u4e2a\u6a21\u677f\u6570\u636e\u5e93\uff1atemplate0\u548ctemplate1\u3002</p> <ul> <li>template0 \u5e72\u51c0\u7248\uff0c\u4efb\u4f55\u65f6\u5019\u4e0d\u8981\u4fee\u6539</li> <li>template1 \u9ed8\u8ba4\u7248\uff0c\u5982\u679c\u521b\u5efa\u6570\u636e\u5e93\u65f6\u4e0d\u6307\u5b9a\u6a21\u677f\u5c06\u9ed8\u8ba4\u6a21\u677f\u6307\u5b9a\u4e3atemplate1</li> </ul>"},{"location":"postgres/index/template/#_2","title":"\u533a\u522b","text":"<ul> <li> <p>template1 \u53ef\u4ee5\u8fde\u63a5\u5e76\u521b\u5efa\u5bf9\u8c61\uff0ctemplate0 \u4e0d\u53ef\u4ee5\u8fde\u63a5</p> </li> <li> <p>\u4f7f\u7528 template1 \u6a21\u677f\u5e93\u5efa\u5e93\u65f6\u4e0d\u53ef\u6307\u5b9a\u65b0\u7684 encoding \u548c locale\uff0c\u800c template0 \u53ef\u4ee5</p> </li> </ul>"},{"location":"postgres/index/template/#_3","title":"\u4f7f\u7528","text":"<p>\u4f7f\u7528\u65b9\u6cd5\u3000</p> <pre><code>\n create database mytemplate template template1;\n\n create database mydatabase template mytemplate;\n\n</code></pre> <p>\u8bbe\u7f6e\u81ea\u5df1\u7684\u6a21\u677f\u3000mytemplate</p> <p>\u5728\u81ea\u5df1\u7684\u6a21\u677f\u4e2d\u9700\u6539\u4fe1\u606f\uff0c\u6bd4\u5982\u3000\u6dfb\u52a0\u5fc5\u5907\u7684\u6269\u5c55\uff0c\u7edf\u8ba1\u51fd\u6570\u5e93\u7b49\u3002</p> <p>\u5176\u4ed6\u6570\u636e\u5e93\u5728\u521b\u5efa\u65f6\u4f7f\u7528\u81ea\u5b9a\u7684\u6a21\u677f</p>"},{"location":"postgres/index/unlogged_table/","title":"unlogged table","text":""},{"location":"postgres/index/unlogged_table/#_1","title":"\u4ecb\u7ecd","text":"<p>\u5728\u5199\u6570\u636e\u7684\u65f6\u5019\u4e0d\u8bb0\u5f55wal\u7684\u8868\u3002</p> <p>\u5728\u610f\u5916\u53d1\u751f\u65f6\u8868\u4e2d\u7684\u6570\u636e\u88abtrunce \u3002\u5982\u65ad\u7535\u3001 \u4e3b\u8fdb\u7a0bkill \u3001scrash \u7b49\u3002</p> <p>\u6b63\u5e38\u5173\u95ed\u91cd\u542f\u6570\u636e\u5e93\u65f6\u6570\u636e\u4e0d\u4f1a\u4e22\u5931\u3002</p> <p>\u4f18\u70b9\uff1a \u63d0\u9ad8\u5199\u5165\u6548\u7387</p> <p>\u4e0d\u8db3\uff1a \u6570\u636e\u5b89\u5168\u6027\u4e0d\u80fd\u5f97\u5230\u4fdd\u969c\u3002 \u7531\u4e8e\u6ca1\u6709wal \u6d41\u590d\u5236\u4ece\u5e93\u4e0d\u80fd\u540c\u6b65</p> <p>\u5e94\u7528\u573a\u666f\uff1a </p> <p>\u6570\u636e\u53ef\u4e22\u5931\uff0c\u5982\u9891\u7e41\u66f4\u65b0\uff0c\u53ea\u4fdd\u7559\u6700\u540e\u72b6\u6001\u4fe1\u606f\u7684\u8868\u3002</p> <p>\u5bfc\u5165\u8868\u6570\u636e\uff0c\u540e\u5c06\u8868\u6539\u4e3a\u6b63\u5e38\u8868\u3002</p>"},{"location":"postgres/index/unlogged_table/#_2","title":"\u4f7f\u7528","text":"<pre><code>-- \u521b\u5efaunlogged table,\u4e0e\u521b\u5efa\u666e\u901a\u7684\u8868\u7c7b\u4f3c\u3002\u52a0\u4e2aunlogged \u5173\u952e\u5b57\npostgres=# create unlogged table ult (id int,name text);\nCREATE TABLE\npostgres=# \\d+ ult \n                      \u4e0d\u8bb0\u5f55\u65e5\u5fd7\u7684\u8868 \"public.ult\"\n \u680f\u4f4d |  \u7c7b\u578b   | \u6821\u5bf9\u89c4\u5219 | \u53ef\u7a7a\u7684 | \u9884\u8bbe |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0 \n------+---------+----------+--------+------+----------+----------+------\n id   | integer |          |        |      | plain    |          | \n name | text    |          |        |      | extended |          | \n\n\n-- \u5c06\u666e\u901a\u8868\u4e0eunlogged table \u4e4b\u95f4\u8f6c\u6362\npostgres=# alter table ult set logged ;\nALTER TABLE\npostgres=# \\d+ ult \n                          \u6570\u636e\u8868 \"public.ult\"\n \u680f\u4f4d |  \u7c7b\u578b   | \u6821\u5bf9\u89c4\u5219 | \u53ef\u7a7a\u7684 | \u9884\u8bbe |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0 \n------+---------+----------+--------+------+----------+----------+------\n id   | integer |          |        |      | plain    |          | \n name | text    |          |        |      | extended |          | \n\npostgres=# alter table ult set unlogged ;\nALTER TABLE\npostgres=# \\d+ ult \n                      \u4e0d\u8bb0\u5f55\u65e5\u5fd7\u7684\u8868 \"public.ult\"\n \u680f\u4f4d |  \u7c7b\u578b   | \u6821\u5bf9\u89c4\u5219 | \u53ef\u7a7a\u7684 | \u9884\u8bbe |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0 \n------+---------+----------+--------+------+----------+----------+------\n id   | integer |          |        |      | plain    |          | \n name | text    |          |        |      | extended |          | \n\n</code></pre>"},{"location":"postgres/install/bgwriter/","title":"Backgroud Writer \u8fdb\u7a0b","text":"","tags":[]},{"location":"postgres/install/bgwriter/#_1","title":"\u4e3b\u8981\u4f5c\u7528","text":"<p>\u8d1f\u8d23\u5c06shared buffer \u4e2d\u7684\u5185\u5bb9\u5237\u5199\u5230\u78c1\u76d8\u4e2d\uff0c9.1\u7248\u4e4b\u540e\u90e8\u5206\u5185\u5bb9\u4ea4\u7ed9checkpoint\u5b8c\u6210\u3002</p>","tags":[]},{"location":"postgres/install/bgwriter/#_2","title":"\u53c2\u6570\u914d\u7f6e","text":"<pre><code># - Background Writer -\n\n#bgwriter_delay = 200ms                 # 10-10000ms between rounds\n#bgwriter_lru_maxpages = 100            # 0-1000 max buffers written/round\n#bgwriter_lru_multiplier = 2.0          # 0-10.0 multiplier on buffers scanned/round\n#bgwriter_flush_after = 512kB           # measured in pages, 0 disables\n</code></pre> <ul> <li> <p>bgwriter_delay  \u4e24\u6b21\u5199\u5165\u4efb\u52a1\u4e4b\u95f4\u7684\u7761\u7720\u95f4\u9694\u65f6\u95f4</p> </li> <li> <p>bgwriter_lru_maxpages  \u6bcf\u6b21bgwriter\u4efb\u52a1\u5199buffer\u7684\u6700\u5927page\u6570\uff0c\u4e00\u65e6\u8fbe\u5230\u8fd9\u4e2a\u6570\u91cf\uff0cbgwriter\u5c31\u7ed3\u675f\u4efb\u52a1\u5f00\u59cb\u4f11\u606f\uff0c\u4e5f\u5c31\u662f\u8bf4bgwriter\u4f11\u7720200\u6beb\u79d2\uff0c\u7136\u540e\u5199\u5165\u51e0\u5341\u6beb\u79d2\u5c31\u53c8\u5f00\u59cb\u4e86\u4f11\u606f </p> </li> <li> <p>bgwriter_lru_multiplier multiplier(\u4e58\u6570)  \u7528\u4e8e\u8bc4\u4f30\u4e0b\u4e00\u6b21\u5199\u4efb\u52a1\u7684\u6570\u91cf\uff0c\u5176\u4f9d\u636e\u662f\u8fd9\u6bb5\u65f6\u95f4\u5185\u65b0\u7533\u8bf7\u7684buffer\u6570\u91cf\u7684\u500d\u6570\uff0c\u5982\u679c\u8fd9\u4e2a\u53c2\u6570\u4e58\u4ee5\u65b0\u589e\u52a0buffer\u5206\u914d\u7684\u6570\u91cf\u540e\u5c0f\u4e8ebgwriter_lru_maxpages\uff0c\u90a3\u4e48\u6709\u53ef\u80fd\u4e0b\u4e00\u4e2a\u5199\u4efb\u52a1\u7684\u6570\u91cf\u4f1a\u5c0f\u4e8e\u9884\u671f\u7684\u5199\u5165\u91cf\u3002\u5c06\u8fd9\u4e2a\u53c2\u6570\u8c03\u5927\uff0c\u4f1a\u589e\u52a0bgwriter\u56de\u5199\u810f\u5757\u7684\u6570\u91cf\uff0c\u4e0d\u8fc7\u4f1a\u589e\u52a0\u5199IO\u538b\u529b\uff0c\u5c06\u8fd9\u4e2a\u53c2\u6570\u8c03\u5c0f\uff0c\u53ef\u4ee5\u964d\u4f4e\u5199IO\u538b\u529b\uff0c\u4e0d\u8fc7\u53ef\u80fd\u5bfc\u81f4backend\u5199\u810f\u5757\u7684\u6bd4\u4f8b\u589e\u52a0\u3002\u4e0d\u540c\u8d1f\u8f7d\u7684\u7cfb\u7edf\u4e2d\uff0c\u8fd9\u4e2a\u53c2\u6570\u7684\u503c\u5e94\u8be5\u662f\u9700\u8981\u505a\u8c03\u6574\u7684\uff0c\u800c\u4e0d\u662f\u53ea\u662f\u7528\u7f3a\u7701\u503c2\u3002\u5982\u679c\u4f60\u53d1\u73b0\u4f60\u7684\u7cfb\u7edf\u7684\u5199IO\u538b\u529b\u8fd8\u4e0d\u5927\uff0c\u4f46\u662f bgwriter\u5199\u6bd4\u4f8b\u504f\u4f4e\uff0cbackend\u5199\u6bd4\u4f8b\u504f\u9ad8\uff0c\u90a3\u4e48\u5c1d\u8bd5\u52a0\u5927\u8fd9\u4e2a\u53c2\u6570\u8fd8\u662f\u6709\u6548\u7684</p> </li> <li> <p>bgwriter_flush_after \u5199\u5165\u91cf\u8d85\u8fc7\u9600\u503c\u8fdb\u884c\u540e\u8fdb\u884c\u540c\u6b65\u5237 </p> </li> </ul>","tags":[]},{"location":"postgres/install/checkpoint/","title":"checkpoint \u68c0\u67e5\u70b9","text":""},{"location":"postgres/install/checkpoint/#_1","title":"\u4f5c\u7528","text":"<p>\u4e00\u822ccheckpoint\u4f1a\u5c06\u67d0\u4e2a\u65f6\u95f4\u70b9\u4e4b\u524d\u7684\u810f\u6570\u636e\u5168\u90e8\u5237\u65b0\u5230\u78c1\u76d8\uff0c\u4ee5\u5b9e\u73b0\u6570\u636e\u7684\u4e00\u81f4\u6027\u4e0e\u5b8c\u6574\u6027\u3002\u5176\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u7f29\u77ed\u5d29\u6e83\u6062\u590d\u65f6\u95f4\u3002</p> <p>\u6570\u636e\u5e93\u9760\u8c31\u7684\u539f\u56e0</p>"},{"location":"postgres/install/checkpoint/#dml","title":"\u4e00\u6761DML \u5199\u5165\u8fc7\u7a0b","text":"<p>\u5728\u5199\u5165\u6570\u636e\u7684\u65f6\uff0c\u5f53\u4e8b\u52a1\u63d0\u4ea4\u540e\u4fee\u6539\u4fe1\u606f\u987a\u5e8f\u540c\u6b65\u5199\u5165wal\u3002shared buffer\u4e2d\u4fe1\u606f\u5e76\u4e0d\u662f\u9a6c\u4e0a\u843d\u76d8\u3002\u5f02\u6b65\u540c\u6b65\u78c1\u76d8\u3002</p> <p>\u8fd9\u91cc\u5b9e\u73b0\u53cc\u5199:</p> \u4f4d\u7f6e \u662f\u5426\u540c\u6b65 \u65b9\u5f0f \u8d1f\u8d23\u8fdb\u7a0b WAL \u540c\u6b65 \u987a\u5e8f\u5199 walwriter TableFile \u5f02\u6b65 \u968f\u673a\u8bfb\u5199 backgroudwriter <p>\u5373\u4fdd\u969c\u4e86\u6570\u636e\u7684\u5b8c\u6574\u6027\u53c8\u540c\u65f6\u517c\u987e\u7684\u6027\u80fd\u3002</p>"},{"location":"postgres/install/checkpoint/#_2","title":"\u610f\u5916\u53d1\u751f\u65f6\u5982\u4f55\u6062\u590d","text":"<p>\u6709\u4e86wal \u53ef\u4ee5\u4fdd\u8bc1\u6570\u636e\u7684\u5b8c\u6574\u6027\uff0c\u6570\u636e\u4e0d\u4e22\u5931\u3002\u90a3\u4e48\u5177\u4f53\u8be5\u5982\u4f55\u6062\u590d\uff1f</p> <p>\u56e0\u4e3a\u4ea7\u751fwal\u662f\u4e2a\u987a\u5e8f\u5199\u7684\u8fc7\u7a0b\uff0c\u53ea\u8981\u56de\u653ewal\u5c31\u53ef\u91cd\u73b0\u5199\u5165\u8fc7\u7a0b\u3002\u5982\u91cd\u73b0\u4e00\u4e2a\u4e00\u6478\u4e00\u6837\u7684\u4ece\u5e93\u3002</p> <p>\u9996\u5148\u8981\u786e\u5b9a\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u5f53\u524d\u6570\u636e\u5e93\u72b6\u6001\u4e0b\u5e94\u8be5\u4ece\u90a3\u4e2a\u5177\u4f53\u4f4d\u7f6e\u5f00\u59cb\u56de\u653e\u3002 \u8fd9\u91cc\u5c31\u9700\u8981checkpoint\u3002</p> <p>\u8fd9\u4e2a\u5177\u4f53\u4f4d\u7f6e\uff08\u68c0\u67e5\u70b9\uff09\u4e4b\u524d\u7684\u6570\u636e\u5df2\u7ecf\u540c\u6b65\u5230\u6570\u636e\u5e93\uff0c\u4e4b\u540e\u7684\u6570\u636e\u8981\u4e48\u5728\u7f13\u5b58\u4e2d\u7684\u810f\u6570\u636e\uff0c\u8981\u4e48\u53ef\u80fd\u610f\u5916\u4e22\u5931\u3002</p> <p>\u68c0\u67e5\u70b9\u53ef\u4f5c\u4e3a\u6e05\u7406WAL\u7684\u4f9d\u636e\uff0c\u4ece\u800c\u907f\u514dWAL\u65e5\u5fd7\u5806\u79ef\u3002</p>"},{"location":"postgres/install/checkpoint/#checkpoint","title":"Checkpoint \u5177\u4f53\u5de5\u4f5c","text":"<ol> <li>\u8bb0\u5f55\u68c0\u67e5\u70b9\u7684\u5f00\u59cb\u4f4d\u7f6e\uff0c\u8bb0\u5f55\u4e3a redo point\uff08\u91cd\u505a\u4f4d\u70b9\uff09</li> <li>\u5c06 shared buffer \u4e2d\u7684\u6570\u636e\u5237\u5230\u78c1\u76d8\u91cc\u9762\u53bb</li> <li>\u5237\u810f\u7ed3\u675f\uff0c\u68c0\u67e5\u70b9\u4e4b\u524d\u7684\u6570\u636e\u5747\u5df2\u88ab\u5237\u5230\u78c1\u76d8\u5b58\u50a8\uff08\u6570\u636e1\u548c2\uff09</li> <li>\u8bb0\u5f55\u76f8\u5173\u4fe1\u606f</li> <li>\u5c06\u6700\u65b0\u7684\u68c0\u6d4b\u70b9\u8bb0\u5f55\u5728 pg_control \u6587\u4ef6\u4e2d</li> </ol>"},{"location":"postgres/install/checkpoint/#_3","title":"\u89e6\u53d1\u6761\u4ef6","text":"<ul> <li>\u8d85\u7ea7\u7528\u6237\uff08\u5176\u4ed6\u7528\u6237\u4e0d\u53ef\uff09\u6267\u884cCHECKPOINT\u547d\u4ee4</li> <li>\u6570\u636e\u5e93shutdown</li> <li>\u6570\u636e\u5e93recovery\u5b8c\u6210</li> <li>XLOG\u65e5\u5fd7\u91cf\u8fbe\u5230\u4e86\u89e6\u53d1checkpoint\u9608\u503c</li> <li>\u5468\u671f\u6027\u5730\u8fdb\u884ccheckpoint,\u5468\u671f\u5185\u65e0\u5199\u5165\u4e0d\u6267\u884ccheckpoint</li> <li>\u9700\u8981\u5237\u65b0\u6240\u6709\u810f\u9875</li> </ul>"},{"location":"postgres/install/checkpoint/#_4","title":"\u76f8\u5173\u53c2\u6570","text":"<pre><code>Postgresql 10\n# - Checkpoints - \n\ncheckpoint_timeout = 5min               # range 30s-1d\nmax_wal_size = 2GB\nmin_wal_size = 1GB\ncheckpoint_completion_target = 0.9      # checkpoint target duration, 0.0 - 1.0\n#checkpoint_flush_after = 256kB         # measured in pages, 0 disables\n#checkpoint_warning = 30s               # 0 disables\n</code></pre> <ul> <li>checkpoint_segments  WAL log\u7684\u6700\u5927\u6570\u91cf\uff0c\u7cfb\u7edf\u9ed8\u8ba4\u503c\u662f3\u3002\u8d85\u8fc7\u8be5\u6570\u91cf\u7684WAL\u65e5\u5fd7\uff0c\u4f1a\u81ea\u52a8\u89e6\u53d1checkpoint\u3002 \u65b0\u7248(9.6)\u4f7f\u7528min_wal_size, max_wal_size  \u6765\u52a8\u6001\u63a7\u5236wal\u65e5\u5fd7</li> <li>checkpoint_timeout  \u7cfb\u7edf\u81ea\u52a8\u6267\u884ccheckpoint\u4e4b\u95f4\u7684\u6700\u5927\u65f6\u95f4\u95f4\u9694\u3002\u7cfb\u7edf\u9ed8\u8ba4\u503c\u662f5\u5206\u949f\u3002</li> <li>checkpoint_completion_target \u8be5\u53c2\u6570\u8868\u793acheckpoint\u7684\u5b8c\u6210\u65f6\u95f4\u5360\u4e24\u6b21checkpoint\u65f6\u95f4\u95f4\u9694\u7684\u6bd4\u4f8b\uff0c\u7cfb\u7edf\u9ed8\u8ba4\u503c\u662f0.5,\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2acheckpoint\u9700\u8981\u5728checkpoints\u95f4\u9694\u65f6\u95f4\u768450%\u5185\u5b8c\u6210\u3002</li> <li>checkpoint_warning \u7cfb\u7edf\u9ed8\u8ba4\u503c\u662f30\u79d2\uff0c\u5982\u679ccheckpoints\u7684\u5b9e\u9645\u53d1\u751f\u95f4\u9694\u5c0f\u4e8e\u8be5\u53c2\u6570\uff0c\u5c06\u4f1a\u5728server log\u4e2d\u5199\u5165\u4e00\u6761\u76f8\u5173\u4fe1\u606f\u3002\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u4e3a0\u7981\u7528\u3002</li> </ul>"},{"location":"postgres/install/checkpoint/#_5","title":"\u8bb0\u5f55\u65e5\u5fd7","text":"<pre><code>\u53c2\u6570\u914d\u7f6e\u5f00\u542f\nlog_checkpoints = on\n</code></pre> <pre><code>\u65e5\u5fd7\u4fe1\u606f\nrestartpoint complete: wrote 12166 buffers (0.6%); 0 WAL file(s) added, 0 removed, 0 recycled; write=269.888 s, sync=0.002 s, total=269.892 s; sync files=489, longest=0.001 s, average=0.001 s; distance=156927 kB, estimate=156927 kB\nrecovery restart point at 204F/41B7840\",\"last completed transaction was at log time\n</code></pre> <p>\u901a\u8fc7 pg_stat_bgwriter \u89c6\u56fe\u67e5\u770b</p> <pre><code>select checkpoints_timed,checkpoints_req,checkpoint_write_time,buffers_checkpoint,buffers_clean from pg_stat_bgwriter ;\n-[ RECORD 1 ]---------+------------------------------\ncheckpoints_timed     | 7\ncheckpoints_req       | 0\ncheckpoint_write_time | 1619504\ncheckpoint_sync_time  | 125\nbuffers_checkpoint    | 190388\nbuffers_clean         | 13574\n</code></pre>"},{"location":"postgres/install/checkpoint/#_6","title":"\u5e94\u7528","text":"<p>\u9884\u9632wal\u5199\u653e\u5927</p>"},{"location":"postgres/install/checkpoint/#wal","title":"\u5982\u4f55\u5224\u65ad\u662f\u5426\u9700\u8981\u4f18\u5316WAL\uff1f","text":"<p>wal \u6587\u4ef6\u540d\u7ec4\u6210</p> <ul> <li>timeline 8\u4f4d</li> <li>\u903b\u8f91\u53f7 8\u4f4d</li> <li>\u504f\u79fb\u91cf</li> </ul> <p>\u4e0ewal_lsn\u5bf9\u5e94\u5173\u7cfb\u67e5\u770b</p> <pre><code>postgres=# select pg_current_wal_lsn();\n pg_current_wal_lsn \n--------------------\n 5A/AD000000\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# select pg_walfile_name(pg_current_wal_lsn());\n     pg_walfile_name      \n--------------------------\n 000000020000005A000000AC\n\n</code></pre> <p>\u5173\u4e8e\u5982\u4f55\u5224\u65ad\u662f\u5426\u9700\u8981\u4f18\u5316WAL\uff0c\u53ef\u4ee5\u901a\u8fc7\u5206\u6790WAL\uff0c\u7136\u540e\u68c0\u67e5\u4e0b\u9762\u7684\u6761\u4ef6\uff0c\u505a\u4e00\u4e2a\u7c97\u7565\u7684\u5224\u65ad\uff1a</p> <ul> <li>FPI\u6bd4\u4f8b\u9ad8\u4e8e70%</li> <li>HOT_UPDATE\u6bd4\u4f8b\u4f4e\u4e8e70%</li> </ul> <p>FPI\u53caHOT_UPDATE\u67e5\u770b\u65b9\u6cd5</p> <pre><code>/usr/pgsql-10/bin/pg_waldump --stats=record -p /var/lib/pgsql/10/data/pg_wal/ -t 2  -s 15/56098120 -e 15/56098200\n\n-z \u7edf\u8ba1\u4fe1\u606f\n\n-p wal path\n\n-t timeline\n\n-s sart lsn\n\n-e end lsn\n\n\u83b7\u53d6wal lsn psql -c \"checkpoint;select pg_current_wal_lsn\" \n</code></pre> <pre><code>/usr/pgsql-10/bin/pg_waldump --stats=record -s 1095/90000000 -e 1098/70000000 -t 3\nType                                           N      (%)          Record size      (%)             FPI size      (%)        Combined size      (%)\n----                                           -      ---          -----------      ---             --------      ---        -------------      ---\nXLOG/CHECKPOINT_ONLINE                       107 (  0.00)                11342 (  0.00)                    0 (  0.00)                11342 (  0.00)\nXLOG/NEXTOID                                   2 (  0.00)                   60 (  0.00)                    0 (  0.00)                   60 (  0.00)\nXLOG/FPI                                       1 (  0.00)                   49 (  0.00)                   64 (  0.00)                  113 (  0.00)\nTransaction/COMMIT                       2541235 (  3.27)             86401990 (  1.44)                    0 (  0.00)             86401990 (  0.71)\nTransaction/ABORT                            462 (  0.00)                15708 (  0.00)                    0 (  0.00)                15708 (  0.00)\nTransaction/COMMIT                          1337 (  0.00)               181730 (  0.00)                    0 (  0.00)               181730 (  0.00)\nStorage/CREATE                                 3 (  0.00)                  126 (  0.00)                    0 (  0.00)                  126 (  0.00)\nStorage/TRUNCATE                               3 (  0.00)                  138 (  0.00)                    0 (  0.00)                  138 (  0.00)\nCLOG/ZEROPAGE                                 78 (  0.00)                 2340 (  0.00)                    0 (  0.00)                 2340 (  0.00)\nCLOG/TRUNCATE                                  1 (  0.00)                   38 (  0.00)                    0 (  0.00)                   38 (  0.00)\nStandby/LOCK                                   5 (  0.00)                  210 (  0.00)                    0 (  0.00)                  210 (  0.00)\nStandby/RUNNING_XACTS                       2165 (  0.00)               115914 (  0.00)                    0 (  0.00)               115914 (  0.00)\nStandby/INVALIDATIONS                        653 (  0.00)                73814 (  0.00)                    0 (  0.00)                73814 (  0.00)\nHeap2/CLEAN                              3212348 (  4.13)            394164646 (  6.58)            308907392 (  4.97)            703072038 (  5.76)\nHeap2/FREEZE_PAGE                              4 (  0.00)                  261 (  0.00)                 3776 (  0.00)                 4037 (  0.00)\nHeap2/CLEANUP_INFO                           357 (  0.00)                14994 (  0.00)                    0 (  0.00)                14994 (  0.00)\nHeap2/VISIBLE                             231176 (  0.30)             13640564 (  0.23)              1933312 (  0.03)             15573876 (  0.13)\nHeap/INSERT                              2746943 (  3.53)            475090632 (  7.93)            367845268 (  5.92)            842935900 (  6.91)\nHeap/DELETE                              2744490 (  3.53)            148841990 (  2.48)            886729344 ( 14.27)           1035571334 (  8.48)\nHeap/UPDATE                               382906 (  0.49)             32082700 (  0.54)             73490712 (  1.18)            105573412 (  0.86)\nHeap/HOT_UPDATE                         59903887 ( 77.09)           4253014469 ( 71.00)            104818576 (  1.69)           4357833045 ( 35.70)\nHeap/LOCK                                 357336 (  0.46)             19298469 (  0.32)              2406840 (  0.04)             21705309 (  0.18)\nHeap/INPLACE                                1887 (  0.00)               305288 (  0.01)              1981592 (  0.03)              2286880 (  0.02)\nHeap/INSERT+INIT                            1467 (  0.00)              2120913 (  0.04)                    0 (  0.00)              2120913 (  0.02)\nHeap/UPDATE+INIT                               2 (  0.00)                  445 (  0.00)                    0 (  0.00)                  445 (  0.00)\nBtree/INSERT_LEAF                        5397231 (  6.95)            415152935 (  6.93)           4231482284 ( 68.08)           4646635219 ( 38.07)\nBtree/INSERT_UPPER                         34770 (  0.04)              2824004 (  0.05)            125457032 (  2.02)            128281036 (  1.05)\nBtree/SPLIT_L                               4589 (  0.01)             18282344 (  0.31)             12146020 (  0.20)             30428364 (  0.25)\nBtree/SPLIT_R                              30544 (  0.04)            117070220 (  1.95)             47733540 (  0.77)            164803760 (  1.35)\nBtree/DELETE                                9838 (  0.01)              2622892 (  0.04)              2366804 (  0.04)              4989696 (  0.04)\nBtree/UNLINK_PAGE                          14014 (  0.02)              1262698 (  0.02)             39943120 (  0.64)             41205818 (  0.34)\nBtree/NEWROOT                                  1 (  0.00)                   78 (  0.00)                    0 (  0.00)                   78 (  0.00)\nBtree/MARK_PAGE_HALFDEAD                   14014 (  0.02)              1038026 (  0.02)               364100 (  0.01)              1402126 (  0.01)\nBtree/VACUUM                               39493 (  0.05)              3974383 (  0.07)              8039632 (  0.13)             12014015 (  0.10)\nBtree/REUSE_PAGE                           27138 (  0.03)              1248348 (  0.02)                    0 (  0.00)              1248348 (  0.01)\nGin/UPDATE_META_PAGE                          52 (  0.00)                 9476 (  0.00)               144256 (  0.00)               153732 (  0.00)\nGin/INSERT_LISTPAGE                            1 (  0.00)                  358 (  0.00)                    0 (  0.00)                  358 (  0.00)\nSequence/LOG                                9093 (  0.01)               900207 (  0.02)                    0 (  0.00)               900207 (  0.01)\n                                        --------                      --------                      --------                      --------\nTotal                                   77709633                    5989764799 [49.07%]           6215793664 [50.93%]          12205558463 [100%]\n</code></pre> <p>\u4ee5\u4e0a\u4ec5\u4ec5\u662f\u7c97\u7565\u7684\u7ecf\u9a8c\u503c\uff0c\u4ec5\u4f9b\u53c2\u8003\u3002\u5e76\u4e14\u8fd9\u4e2aFPI\u6bd4\u4f8b\u53ef\u80fd\u4e0d\u9002\u7528\u4e8e\u4f4e\u5199\u8d1f\u8f7d\u7684\u7cfb\u7edf\uff0c\u4f4e\u5199\u8d1f\u8f7d\u7684\u7cfb\u7edfFPI\u6bd4\u4f8b\u4e00\u5b9a\u975e\u5e38\u9ad8\uff0c\u4f46\u662f\uff0c\u4f4e\u5199\u8d1f\u8f7d\u7cfb\u7edf\u7531\u4e8e\u5199\u64cd\u4f5c\u5f88\u5c11\uff0c\u56e0\u6b64FPI\u6bd4\u4f8b\u5373\u4f7f\u9ad8\u4e00\u70b9\u4e5f\u6ca1\u592a\u5927\u5f71\u54cd\u3002</p> <p>\u4f18\u5316WAL\u53ca\u526f\u4f5c\u7528</p> <ul> <li> <p>\u5ef6\u957fcheckpoint\u65f6\u95f4\u95f4\u9694 \u5bfc\u81f4crash\u6062\u590d\u65f6\u95f4\u53d8\u957f\u3002crash\u6062\u590d\u65f6\u9700\u8981\u56de\u653e\u7684WAL\u65e5\u5fd7\u91cf\u4e00\u822c\u5c0f\u4e8emax_wal_size\u7684\u4e00\u534a\uff0cWAL\u56de\u653e\u901f\u5ea6(wal_compression=on\u65f6)\u4e00\u822c\u662f50MB/s~150MB/s\u4e4b\u95f4\u3002\u53ef\u4ee5\u6839\u636e\u53ef\u5bb9\u5fcd\u7684\u6700\u5927crash\u6062\u590d\u65f6\u95f4\uff0c\u4f30\u7b97\u51fa\u5141\u8bb8\u7684max_wal_size\u7684\u6700\u5927\u503c\u3002</p> </li> <li> <p>\u8c03\u6574fillfactor \u8fc7\u5c0f\u7684\u8bbe\u7f6e\u4f1a\u6d6a\u8d39\u5b58\u50a8\u7a7a\u95f4\uff0c\u8fd9\u4e2a\u4e0d\u96be\u7406\u89e3\u3002\u53e6\u5916\uff0c\u5bf9\u4e8e\u9891\u7e41\u66f4\u65b0\u7684\u8868\uff0c\u5373\u4f7f\u628afillfactor\u8bbe\u6210100%\uff0c\u6bcf\u4e2apage\u91cc\u8fd8\u662f\u8981\u4e00\u90e8\u5206\u7a7a\u95f4\u88abdead tuple\u5360\u636e\uff0c\u4e0d\u4f1a\u6bd4\u8bbe\u7f6e\u6210\u4e00\u4e2a\u5408\u9002\u7684\u7a0d\u5c0f\u7684fillfactor\u66f4\u8282\u7701\u7a7a\u95f4\u3002</p> </li> <li> <p>\u8bbe\u7f6ewal_compression=on \u9700\u8981\u989d\u5916\u5360\u7528CPU\u8d44\u6e90\u8fdb\u884c\u538b\u7f29\uff0c\u4f46\u5f71\u54cd\u4e0d\u5927</p> </li> </ul> <p>http://www.postgres.cn/news/viewone/1/273</p> <p>\u66f4\u591a\u7ec6\u8282\u8bf4\u660e</p> <p>https://yq.aliyun.com/articles/582847</p> <p>\u539f\u7406</p> <p>https://zhmin.github.io/2019/11/24/postgresql-checkpoint/</p> <p>https://www.modb.pro/db/47042</p>"},{"location":"postgres/install/cluster/","title":"cluster \u805a\u65cf\u8868","text":"<p>\u5b58\u50a8\u6570\u636e\u7ebf\u6027\u76f8\u5173\u6027 \u6d4b\u8bd5</p>"},{"location":"postgres/install/daily_management/","title":"\u6570\u636e\u5e93\u65e5\u5e38\u7ba1\u7406","text":""},{"location":"postgres/install/daily_management/#_1","title":"\u65e5\u5e38\u7ba1\u7406","text":"<ul> <li>\u53ef\u7528\u6027</li> <li>\u76d1\u6d4b\u9879</li> </ul>"},{"location":"postgres/install/daily_management/#_2","title":"\u53ef\u7528\u6027","text":"<ul> <li>\u4e3b\u4ece</li> <li>HA</li> <li>\u5168\u91cf\u5907\u4efd</li> <li>\u589e\u91cf\u5907\u4efd</li> <li>\u6062\u590d</li> </ul>"},{"location":"postgres/install/daily_management/#_3","title":"\u76d1\u6d4b\u9879","text":""},{"location":"postgres/install/daily_management/#_4","title":"\u78c1\u76d8\u7a7a\u95f4","text":"<ul> <li>\u5168\u5e93</li> </ul> <pre><code>select pg_size_pretty(sum(pg_database_size(oid))) from pg_database;\n</code></pre> <ul> <li>\u6570\u636e\u5e93</li> </ul> <pre><code>select datname, pg_size_pretty(pg_database_size(oid)) from pg_database order by pg_database_size(oid) desc limit 10;\n</code></pre> <ul> <li>\u8868\u603b</li> </ul> <pre><code> SELECT table_schema || '.' || table_name AS table_full_name, pg_size_pretty(pg_total_relation_size('\"' || table_schema || '\".\"' || table_name || '\"')) AS size\nFROM information_schema.tables where table_schema = 'public' ORDER BY pg_total_relation_size('\"' || table_schema || '\".\"' || table_name || '\"') DESC limit 10;\n</code></pre> <ul> <li> <p>\u8868</p> </li> <li> <p>\u7d22\u5f15</p> </li> </ul>"},{"location":"postgres/install/daily_management/#_5","title":"\u51b7\u70ed\u6570\u636e","text":"<ul> <li>\u4e0a\u6b21\u7edf\u8ba1\u4fe1\u606f\u66f4\u65b0\u65f6\u95f4</li> <li>\u70ed\u8868dml    qps io</li> <li>\u70ed\u8868qdml</li> <li>\u51b7\u6570\u636e</li> <li>\u51b7\u7d22\u5f15</li> </ul>"},{"location":"postgres/install/daily_management/#_6","title":"\u7d22\u5f15\u5229\u7528","text":"<ul> <li>\u5168\u8868\u626b\u63cf\u6b21\u6570</li> <li>\u5168\u8868\u626b\u63cf\u8bb0\u5f55\u6570</li> <li>\u9009\u62e9\u6027\u53ef\u80fd\u4e0d\u597d\u7684\u7d22\u5f15</li> <li>\u5229\u7528\u7387\u4f4e\u7684\u7d22\u5f15</li> <li>\u5229\u7528\u7387\u9ad8\u7684\u7d22\u5f15</li> </ul>"},{"location":"postgres/install/daily_management/#_7","title":"\u8868\u81a8\u80c0","text":"<ul> <li>\u8868</li> <li>\u7d22\u5f15</li> <li>\u7cfb\u7edf\u81a8\u80c0\u65f6\u95f4\u70b9</li> <li>\u5f15\u53d1\u81ea\u52a8\u56de\u6536\u6b21\u6570</li> <li>\u5173\u95ed\u81ea\u52a8\u56de\u6536</li> </ul>"},{"location":"postgres/install/daily_management/#checkpiont","title":"checkpiont","text":"<ul> <li>\u9891\u7387</li> <li>wal\u81a8\u80c0</li> </ul>"},{"location":"postgres/install/daily_management/#_8","title":"\u9501","text":"<ul> <li>\u9501\u7b49\u5f85</li> <li>\u6b7b\u9501\u6b21\u6570 \u52a0\u5165\u5b9e\u65f6\u76d1\u63a7</li> <li>\u56de\u6eda\u6b21\u6570 \u52a0\u5165\u5b9e\u65f6\u76d1\u63a7</li> <li>\u9501\u4ea7\u751f\u7684\u67e5\u8be2\u53d6\u6d88 \u52a0\u5165\u5b9e\u65f6\u76d1\u63a7</li> </ul>"},{"location":"postgres/install/daily_management/#sql","title":"SQL","text":"<ul> <li>\u603b\u8017\u65f6</li> <li>io\u8017\u65f6</li> <li>\u6027\u80fd\u6296\u52a8</li> <li>\u5185\u5b58</li> <li>\u4e34\u65f6\u7a7a\u95f4</li> <li>\u957f\u4e8b\u52a1</li> <li>\u6162\u67e5\u8be2</li> </ul>"},{"location":"postgres/install/delete/","title":"\u5220\u9664\u6570\u636e","text":""},{"location":"postgres/install/delete/#deleteupdate-limit","title":"\u5220\u9664\u6570\u636e DELETE|UPDATE LIMIT","text":"<p>\u5bf9\u6570\u636e\u8fdb\u884c\u5f52\u6863\u5b8c\u6bd5\u540e\uff0c\u5bf9\u6570\u636e\u8fdb\u884c\u6e05\u7406\u3002</p> <p>postgres \u6682\u4e0d\u652f\u6301 delete limit \u7528\u6cd5 \u3002\u6839\u636e\u6761\u4ef6\u5220\u9664\u5927\u91cf\u6570\u636e\u65f6\u3002</p> <p>\u4f7f\u7528with\u6a21\u62df\u5fc5\u987b\u6709PK\u6216\u8005\u975e\u7a7aUK</p> <pre><code>with t1 as (select id from t where create_time &lt; '2020-01-01 00:00:00' limit 10) \n                  delete from t where id in (select * from t1);\n</code></pre>"},{"location":"postgres/install/delete/#_2","title":"\u8868\u4e4b\u95f4\u4f9d\u8d56\u987a\u5e8f","text":"<pre><code>with recursive fk_tree as (\n  -- All tables not referencing anything else\n  select t.oid as reloid, \n         t.relname as table_name, \n         s.nspname as schema_name,\n         null::text as referenced_table_name,\n         null::text as referenced_schema_name,\n         1 as level\n  from pg_class t\n    join pg_namespace s on s.oid = t.relnamespace\n  where relkind = 'r'\n    and not exists (select *\n                    from pg_constraint\n                    where contype = 'f'\n                      and conrelid = t.oid)\n    and s.nspname = 'public' -- limit to one schema \n\n  union all \n\n  select ref.oid, \n         ref.relname, \n         rs.nspname,\n         p.table_name,\n         p.schema_name,\n         p.level + 1\n  from pg_class ref\n    join pg_namespace rs on rs.oid = ref.relnamespace\n    join pg_constraint c on c.contype = 'f' and c.conrelid = ref.oid\n    join fk_tree p on p.reloid = c.confrelid\n  where ref.oid != p.reloid  -- do not enter to tables referencing theirselves.\n), all_tables as (\n  -- this picks the highest level for each table\n  select schema_name, table_name,\n         level, \n         row_number() over (partition by schema_name, table_name order by level desc) as last_table_row\n  from fk_tree\n)\nselect schema_name, table_name, level\nfrom all_tables at\nwhere last_table_row = 1\norder by level;\n</code></pre>"},{"location":"postgres/install/delete/#_3","title":"\u5220\u9664\u540e\u78c1\u76d8\u7a7a\u95f4\u91ca\u653e","text":"<p>\u5220\u9664\u5927\u91cf\u6570\u636e\u540e<code>analyze</code>\u53ca\u65f6\u66f4\u65b0\u6570\u636e\u7edf\u8ba1\u4fe1\u606f </p> <p>\u5982\u9700\u56de\u6536\u5220\u9664\u6570\u636e\u6240\u5360\u7528\u7684\u7a7a\u95f4 <code>vacuum full</code> , \u6ce8\u610f\u4e8b\u9879\uff0c<code>\u00b7\u4f1a\u9501\u00b7</code>\uff0c\u5f71\u54cd\u7ebf\u4e0a\u4e1a\u52a1</p> <p>\u65e0\u9501\u65b9\u5f0f\uff0c\u53c2\u8003</p> <ul> <li>pg_repack</li> </ul>"},{"location":"postgres/install/install/","title":"\u5b89\u88c5","text":""},{"location":"postgres/install/install/#_2","title":"\u914d\u7f6e","text":""},{"location":"postgres/install/install01/","title":"\u5b89\u88c5 Postgresql","text":"<p>\u5b98\u7f51</p> <p>1.\u51c6\u5907\u6e90</p> <pre><code>\u6e05\u9664\u5386\u53f2\u6b8b\u4f59\uff0c\u6709\u4e9b\u662f\u7cfb\u7edf\u81ea\u5e26\u7684\u65e7\u7248\u672c\u6570\u636e\u5e93\n\nrpm -qa | grep postgres\n\nrpm -r ****\n\n\u5b89\u88c5\u65b0\u6570\u636e\u6e90\n\nyum install https://download.postgresql.org/pub/repos/yum/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm\n\nyum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n\n\u53ef\u5c06\u6240\u6709\u7684\u8f6f\u4ef6\u66f4\u65b0\u5230\u6700\u65b0\u7248\u672c\u5982 \uff0c postgresql-10.2 \u66f4\u65b0\u5230\u5f53\u524d\u6700\u65b0\u7684postgresql-10.6\n\nyum update -y \n\n</code></pre> <p>2.\u5b89\u88c5</p> <pre><code>yum install -y postgresql10-server postgresql10  postgresql10-contrib\n</code></pre> <p>3.\u521d\u59cb\u5316</p> <pre><code>\u9ed8\u8ba4\u521d\u59cb\u5316\n/usr/pgsql-10/bin/postgresql-10-setup initdb\n\n\u5efa\u8bae\u5f00\u542f checksums\nsudo su postgres -c  \"/usr/pgsql-10/bin/initdb  --data-checksums -D /var/lib/pgsql/10/data\" \n\n\u81ea\u5b9a\u4e49\n/usr/pgsql-10/bin/initdb -D $PGDATA -U postgres -E UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8 -k \n\n-D \u6570\u636e\u5b58\u653e\u4f4d\u7f6e\n-U \u8d85\u7ea7\u7528\u6237\n-E \u9ed8\u8ba4\u7f16\u7801\n--lc-collate \u533a\u57df Collate\u4f1a\u5f71\u54cd\u4e2d\u6587\u7684\u6392\u5e8f\uff0c\u5728zh_CN\u7684\u533a\u57df\u4e0b\u4e2d\u6587\u6309\u62fc\u97f3\u6392\u5e8f\uff0c\u5176\u5b83\u533a\u57df\u6309\u5b57\u7b26\u7f16\u7801\u6392\u5e8f\u3002\n--lc-ctype \u5b57\u7b26\u7c7b\u578bCtype\u4f1a\u5f71\u54cdpg_trgm\u548c\u90e8\u5206\u6b63\u5219\u5339\u914d\u7684\u7ed3\u679c\uff0c\u6bd4\u5982Ctype\u4e3a'C'\u65f6\uff0cpg_trgm\u5c06\u65e0\u6cd5\u652f\u6301\u4e2d\u6587\u3002\n-k \u4f7f\u7528 data checksums\n</code></pre> <p>\u53ef\u5c06\u6570\u636e\u5b58\u653e\u5230\u5176\u4ed6\u76ee\u5f55\u4e0b\uff0c\u4f7f\u7528\u8f6f\u8fde\u63a5\u7684\u65b9\u5f0f\u3002</p> <p>\u4e3a\u4ec0\u4e48\u4f1a\u4f7f\u7528\u8f6f\u8fde\u63a5\u800c\u4e0d\u662f\u66f4\u6539PGDATA\u73af\u5883\u53d8\u91cf\uff0c\u56e0\u4e3a\u5347\u7ea7\u6570\u636e\u5e93\u7684\u65f6 PGDATA \u88ab\u6307\u56de\u9ed8\u8ba4\u503c\u3002</p> <p>\u901a\u8fc7\u8f6f\u8fde\u63a5\u7684\u65b9\u5f0f\u4e0d\u6539\u53d8\u521d\u59cb\u503c:  1 \u5347\u7ea7\u7684\u65f6\u5019\u4e0d\u7528\u4fee\u6539PGDATA  2 \u6570\u636e\u4f4d\u7f6e\u5b58\u653e\u56fa\u5b9a\uff0c\u4fbf\u4e8e\u4ee5\u540e\u7ba1\u7406\u3002  </p> <p>4.\u542f\u52a8\u670d\u52a1\u3000\uff06\u3000\u5f00\u673a\u81ea\u542f</p> <pre><code>systemctl start postgresql-10.service\n\nsystemctl enable postgresql-10.service\n</code></pre> <p>5.\u8bbe\u7f6e\u8bbf\u95ee\u6743\u9650</p> <p>vi postgresql.conf</p> <pre><code>  listen_addresses ='*'\n</code></pre> <p>vi pg_hba.conf</p> <pre><code>  # \"local\" is for Unix domain socket connections only\n  local   all             all                                     trust\n  # IPv4 local connections:\n  host    all             all             127.0.0.1/32            trust\n  host    all             all             0.0.0.0/0               md5\n  # IPv6 local connections:\n  host    all             all             ::1/128                 ident\n\n</code></pre> <pre><code>systemctl restart postgresql-10.service\n</code></pre> <p>6.\u8bbe\u7f6e\u5bc6\u7801</p> <pre><code>  #psql -U postgres\n\n  postgres=# ALTER USER postgres WITH PASSWORD 'postgres'\n  \\q\n\n</code></pre> <ol> <li> <p>\u5efa\u8bae\u9ed8\u8ba4\u5f00\u542fextension</p> </li> <li> <p>pg_repack</p> </li> <li>pg_stat_statements</li> <li>auto_explain</li> </ol>"},{"location":"postgres/install/install01/#_1","title":"\u8fdb\u4e00\u6b65\u4f18\u5316","text":""},{"location":"postgres/install/install01/#linux","title":"\u7cfb\u7edfLinux \u5185\u6838\u53c2\u6570","text":"<p>vi /etc/sysctl.conf </p> <pre><code>kernel.shmall = 4294967296  \nkernel.shmmax=135497418752  \nkernel.shmmni = 4096  \nkernel.sem = 50100 64128000 50100 1280  \nfs.file-max = 7672460  \nfs.aio-max-nr = 1048576  \nnet.ipv4.ip_local_port_range = 9000 65000  \nnet.core.rmem_default = 262144  \nnet.core.rmem_max = 4194304  \nnet.core.wmem_default = 262144  \nnet.core.wmem_max = 4194304  \nnet.ipv4.tcp_max_syn_backlog = 4096  \nnet.core.netdev_max_backlog = 10000  \n#net.ipv4.netfilter.ip_conntrack_max = 655360  \nnet.ipv4.tcp_timestamps = 0  \nnet.ipv4.tcp_tw_recycle=1  \nnet.ipv4.tcp_timestamps=1  \nnet.ipv4.tcp_keepalive_time = 72   \nnet.ipv4.tcp_keepalive_probes = 9   \nnet.ipv4.tcp_keepalive_intvl = 7  \nvm.zone_reclaim_mode=0  \nvm.dirty_background_bytes = 40960000  \nvm.dirty_ratio = 80  \nvm.dirty_expire_centisecs = 6000  \nvm.dirty_writeback_centisecs = 50  \nvm.swappiness=0  \nvm.overcommit_memory = 0  \nvm.overcommit_ratio = 90  \n</code></pre> <p>sysctl -p \u751f\u6548</p>"},{"location":"postgres/install/install01/#linux_1","title":"\u7cfb\u7edfLinux \u6700\u5927\u53e5\u67c4\u6570","text":"<p>vi /etc/security/limits.conf   </p> <pre><code>* soft    nofile  131072  \n* hard    nofile  131072  \n* soft    nproc   131072  \n* hard    nproc   131072  \n* soft    core    unlimited  \n* hard    core    unlimited  \n* soft    memlock 500000000  \n* hard    memlock 500000000 \n\n</code></pre>"},{"location":"postgres/install/install01/#ntp","title":"ntp","text":"<pre><code>yum install ntp -y\n\nsystemctl start ntpd\nsystemctl enable ntpd\n</code></pre> <p>reboot \u751f\u6548</p>"},{"location":"postgres/install/install01/#_2","title":"\u6570\u636e\u5e93\u53c2\u6570","text":"<p>\u53c2\u89c1</p>"},{"location":"postgres/install/install01/#_3","title":"\u5e38\u89c1\u95ee\u9898","text":"<pre><code>Package: postgresql12-devel-12.3-1PGDG.rhel7.x86_64 (pgdg12)\n           Requires: llvm-toolset-7-clang &gt;= 4.0.1\ninstall CentOS SCLo RH repository and install llvm-toolset-7-clang to resolve it.\nyum install centos-release-scl-rh\nyum install llvm-toolset-7-clang\n</code></pre>"},{"location":"postgres/install/install02/","title":"\u6570\u636e\u5e93\u5b89\u88c5 Postgres12 Ubuntu18","text":"<p>\u8f6f\u4ef6\u6e90</p> <pre><code>echo \"deb http://apt.postgresql.org/pub/repos/apt/ bionic-pgdg main\" &gt;&gt; /etc/apt/sources.list.d/pgdg.list\n</code></pre> <pre><code>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -\n</code></pre> <pre><code>sudo apt-get update -y\n\n</code></pre> <p>\u5b89\u88c5 </p> <pre><code>apt-get install postgresql-12 postgresql-client-12 postgresql-12-postgis-2.5 postgresql-contrib -y\n\n</code></pre> <p>\u521d\u59cb\u5316</p> <pre><code>/usr/pgsql-12/bin/postgresql-12-setup initdb\n</code></pre> <p>\u542f\u52a8</p> <pre><code>systemctl start postgresql\nsystemctl stop postgresql\nsystemctl status postgresql\nsystemctl enable postgresql\n</code></pre> <p>\u914d\u7f6e</p> <pre><code>cd /etc/postgresql/12/main/\n\nvi postgres.conf\n\nvi pg_hba.conf\n\n</code></pre>"},{"location":"postgres/install/pgstattuple/","title":"\u8868\u7a7a\u95f4\u81a8\u80c0","text":""},{"location":"postgres/install/pgstattuple/#_2","title":"\u8868\u7a7a\u95f4\u81a8\u80c0\u4ecb\u7ecd","text":"<p>\u7531\u4e8emvcc\u673a\u5236\uff0c\u6570\u636e\u88ab\u5220\u9664\u540e\u53ea\u662f\u88ab\u6807\u8bb0\u4e3a\u5220\u9664\uff0c\u5b9e\u9645\u7a7a\u95f4\u6ca1\u6709\u88ab\u91ca\u653e\uff0c\u8fd9\u662f\u8868\u7a7a\u95f4\u81a8\u80c0\u7684\u6839\u672c\u539f\u56e0\u3002</p>"},{"location":"postgres/install/pgstattuple/#_3","title":"\u76f8\u5173\u77e5\u8bc6\u70b9","text":""},{"location":"postgres/install/pgstattuple/#_4","title":"\u5783\u573e\u56de\u6536","text":"<ul> <li>vacuum  : tuple\u88ab\u6e05\u7406\u3002\u6570\u636e\u5e93\u53ef\u4ee5\u81ea\u52a8\u6267\u884cautovacuum</li> <li>vacuum full : tuple\u88ab\u6e05\u7406\u5e76\u4e14\u7a7a\u95f4\u8fde\u7eed\u7d27\u51d1\u3002\u5f0a\u7aef\uff0c\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u9501\u8868\u3002\u5e94\u7528\u4e0d\u53ef\u7528</li> </ul>"},{"location":"postgres/install/pgstattuple/#fillfactor","title":"fillfactor \u586b\u5145\u56e0\u5b50","text":""},{"location":"postgres/install/pgstattuple/#vacuum_defer_cleanup_age","title":"vacuum_defer_cleanup_age","text":"<p>\u662f\u4ee5\u4e8b\u52a1\u4e3a\u5355\u4f4d\u3002\u914d\u5408pg_resetwal \u53ef\u4ee5\u505a\u5230flashback</p> <p>\u4ee3\u4ef71\uff0c \u4e3b\u5e93\u81a8\u80c0\uff0c\u56e0\u4e3a\u5783\u573e\u7248\u672c\u8981\u5ef6\u8fdf\u82e5\u5e72\u4e2a\u4e8b\u52a1\u540e\u624d\u80fd\u88ab\u56de\u6536\u3002</p> <p>\u4ee3\u4ef72\uff0c\u91cd\u590d\u626b\u63cf\u5783\u573e\u7248\u672c\uff0c\u91cd\u590d\u8017\u8d39\u5783\u573e\u56de\u6536\u8fdb\u7a0b\u7684CPU\u8d44\u6e90\u3002\uff08n_dead_tup\u4f1a\u4e00\u76f4\u5904\u4e8e\u8d85\u8fc7\u5783\u573e\u56de\u6536\u9608\u503c\u7684\u72b6\u6001\uff0c\u4ece\u800cautovacuum \u4e0d\u65ad\u5524\u9192worker\u8fdb\u884c\u56de\u6536\u52a8\u4f5c\uff09\u3002 \u5f53\u4e3b\u5e93\u7684 autovacuum_naptime=\u5f88\u5c0f\u7684\u503c\uff0c\u540c\u65f6autovacuum_vacuum_scale_factor=\u5f88\u5c0f\u7684\u503c\u65f6\uff0c\u5c24\u4e3a\u660e\u663e\u3002</p> <p>\u4ee3\u4ef73\uff0c\u5982\u679c\u671f\u95f4\u53d1\u751f\u5927\u91cf\u5783\u573e\uff0c\u5783\u573e\u7248\u672c\u53ef\u80fd\u4f1a\u5728\u4e8b\u52a1\u5230\u8fbe\u5e76\u89e3\u7981\u540e\uff0c\u7206\u70b8\u6027\u7684\u88ab\u56de\u6536\uff0c\u4ea7\u751f\u5927\u91cf\u7684WAL\u65e5\u5fd7\uff0c\u4ece\u800c\u9020\u6210WAL\u7684\u5199IO\u5c16\u523a\u3002</p>"},{"location":"postgres/install/pgstattuple/#reindex","title":"reindex","text":"<p>\u4ece\u65b0\u5efa\u7acb\u7d22\u5f15\uff0c\u4e0d\u8981\u5ffd\u7565\u8868\u81a8\u80c0\u4e2d\u7d22\u5f15\u7684\u5f71\u54cd\uff0c\u901a\u5e38\u6765\u8bf4\u7d22\u5f15\u6240\u5360\u7684\u7a7a\u95f4\u548c\u7ef4\u62a4\u6210\u672c\u8981\u9ad8\u4e8e\u6570\u636e\u8868\u3002</p>"},{"location":"postgres/install/pgstattuple/#analyze","title":"ANALYZE","text":"<p>\u5904\u7406\u5b8c\u6bd5\u540e\u9700\u8981\u91cd\u65b0\u751f\u6210\u7edf\u8ba1\u4fe1\u606f</p>"},{"location":"postgres/install/pgstattuple/#maintenance_work_mem","title":"maintenance_work_mem","text":"<p>\u5728\u6267\u884c\u4ee5\u4e0a\u64cd\u4f5c\u65f6\u5efa\u8bae\u8bbe\u7f6e</p> <pre><code>set maintenance_work_mem = '10GB';\n</code></pre>"},{"location":"postgres/install/pgstattuple/#_5","title":"\u76d1\u63a7\u8868\u7a7a\u95f4\u81a8\u80c0","text":""},{"location":"postgres/install/pgstattuple/#pgstattuple","title":"pgstattuple","text":"<p>pgstattuple \u63d0\u4f9b\u4e86pgstatetuple()\u548cpgstatindex()\u4e24\u4e2a\u7edf\u8ba1\u8868\u548c\u7d22\u5f15\u7684\u65b9\u6cd5\uff0c\u8f83PostgreSQL\u7cfb\u7edf\u8868pg_class\u7684\u8868\u7edf\u8ba1\u4fe1\u606f\uff0cpgstatetuple()\u8fd8\u7edf\u8ba1\u4e86\u8868\u4e2d\u7684dead tuples\u3002</p> <p>https://www.postgresql.org/docs/current/pgstattuple.html</p> <p>\u521b\u5efa\u62d3\u5c55</p> <pre><code>create extension pgstattuple ;\n</code></pre> <pre><code>\u8868\ntest=&gt; SELECT * FROM pgstattuple('tablename');\n-[ RECORD 1 ]------+-------\ntable_len          | 458752\ntuple_count        | 1470\ntuple_len          | 438896\ntuple_percent      | 95.67\ndead_tuple_count   | 11\ndead_tuple_len     | 3157\ndead_tuple_percent | 0.69\nfree_space         | 8932\nfree_percent       | 1.95\n</code></pre> <p>\u5b57\u6bb5\u8bf4\u660e</p> <p>table_len   bigint  Physical relation length in bytes \u7b49\u4ef7\u4e8e pg_relation_size()</p> <p>tuple_count bigint  Number of live tuples </p> <p>tuple_len   bigint  Total length of live tuples in bytes</p> <p>tuple_percent   float8  Percentage of live tuples</p> <p>dead_tuple_count    bigint  Number of dead tuples</p> <p>dead_tuple_len  bigint  Total length of dead tuples in bytes</p> <p>dead_tuple_percent  float8  Percentage of dead tuples</p> <p>free_space  bigint  Total free space in bytes</p> <p>free_percent    float8  Percentage of free space</p> <p>\u4e09\u90e8\u5206 live(\u5b58\u6d3btuple) dead(\u88ab\u6807\u8bb0\u5220\u9664tuple) free(\u5269\u4f59\u7a7a\u95f4 \u5e94\u8be5\u662fdead tuple ,vacuum \u540e\u88ab\u91ca\u653e\u7684, filltor \u8bbe\u7f6e)</p> <p>\u6240\u6709\u8868</p> <pre><code>select tablename, (x).* from pg_tables ,\nLATERAL (select * from pgstattuple(tablename)) as X \nwhere schemaname = 'public' order by tuple_percent asc;\n</code></pre> <p>\u7d22\u5f15</p> <pre><code>test=&gt; SELECT * FROM pgstatindex('index_name');\n-[ RECORD 1 ]------+------\nversion            | 2\ntree_level         | 0\nindex_size         | 16384\nroot_block_no      | 1\ninternal_pages     | 0\nleaf_pages         | 1\nempty_pages        | 0\ndeleted_pages      | 0\navg_leaf_density   | 54.27 (fillfator \u9ed8\u8ba490 \uff0c\u8be5\u503c\u63a5\u8fd190\u6bd4\u8f83\u6b63\u5e38)\nleaf_fragmentation | 0\n</code></pre> <p>\u5b57\u6bb5\u8bf4\u660e</p> <p>version integer B-tree version number</p> <p>tree_level  integer Tree level of the root page</p> <p>index_size  bigint  Total index size in bytes</p> <p>root_block_no   bigint  Location of root page (zero if none)</p> <p>internal_pages  bigint  Number of \u201cinternal\u201d (upper-level) pages</p> <p>leaf_pages  bigint  Number of leaf pages</p> <p>empty_pages bigint  Number of empty pages</p> <p>deleted_pages   bigint  Number of deleted pages</p> <p>avg_leaf_density    float8  Average density of leaf pages</p> <p>leaf_fragmentation  float8  Leaf page fragmentation</p>"},{"location":"postgres/install/pgstattuple/#_6","title":"\u7b80\u5355\u4f7f\u7528","text":"<pre><code>--- \u751f\u6210\u6d4b\u8bd5\u6570\u636e\n\ntest=# create  table tb3(id integer,name character varying);\nCREATE TABLE\ntest=# \\d+ tb3 \n                                  \u6570\u636e\u8868 \"public.tb3\"\n \u680f\u4f4d |       \u7c7b\u578b        | Collation | Nullable | Default |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0 \n------+-------------------+-----------+----------+---------+----------+----------+------\n id   | integer           |           |          |         | plain    |          | \n name | character varying |           |          |         | extended |          | \n\ntest=#  alter table tb3 add primary key(id);\nALTER TABLE\ntest=# \\d+ tb3 \n                                  \u6570\u636e\u8868 \"public.tb3\"\n \u680f\u4f4d |       \u7c7b\u578b        | Collation | Nullable | Default |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0 \n------+-------------------+-----------+----------+---------+----------+----------+------\n id   | integer           |           | not null |         | plain    |          | \n name | character varying |           |          |         | extended |          | \n\u7d22\u5f15\uff1a\n    \"tb3_pkey\" PRIMARY KEY, btree (id)\n\ntest=# insert into tb3 select generate_series(1,1000000),md5(random()::text);\nINSERT 0 1000000\n\n--- \u521b\u5efa\u62d3\u5c55\n\ntest=# create extension pgstattuple ;\nCREATE EXTENSION\ntest=# select * from pgstattuple('tb3');\n-[ RECORD 1 ]------+---------\ntable_len          | 68272128\ntuple_count        | 1000000\ntuple_len          | 61000000\ntuple_percent      | 89.35\ndead_tuple_count   | 0\ndead_tuple_len     | 0\ndead_tuple_percent | 0\nfree_space         | 38776\nfree_percent       | 0.06\n\ntest=# select * from pgstatindex('tb3_pkey');\n-[ RECORD 1 ]------+---------\nversion            | 2\ntree_level         | 2\nindex_size         | 22487040\nroot_block_no      | 412\ninternal_pages     | 11\nleaf_pages         | 2733\nempty_pages        | 0\ndeleted_pages      | 0\navg_leaf_density   | 90.06\nleaf_fragmentation | 0\n\ntest=# delete from tb3 where id%5=0;\nDELETE 200000\ntest=# select * from pgstatindex('tb3_pkey');\n-[ RECORD 1 ]------+---------\nversion            | 2\ntree_level         | 2\nindex_size         | 22487040\nroot_block_no      | 412\ninternal_pages     | 11\nleaf_pages         | 2733\nempty_pages        | 0\ndeleted_pages      | 0\navg_leaf_density   | 90.06\nleaf_fragmentation | 0\n\ntest=# select * from pgstattuple('tb3');\n-[ RECORD 1 ]------+---------\ntable_len          | 68272128\ntuple_count        | 800000\ntuple_len          | 48800000\ntuple_percent      | 71.48\ndead_tuple_count   | 200000\ndead_tuple_len     | 12200000\ndead_tuple_percent | 17.87\nfree_space         | 38776\nfree_percent       | 0.06\n\ntest=#  vacuum tb3;\nVACUUM\ntest=# select * from pgstattuple('tb3');\n-[ RECORD 1 ]------+---------\ntable_len          | 68272128\ntuple_count        | 800000\ntuple_len          | 48800000\ntuple_percent      | 71.48\ndead_tuple_count   | 0\ndead_tuple_len     | 0\ndead_tuple_percent | 0\nfree_space         | 12838776\nfree_percent       | 18.81\n\ntest=# select * from pgstatindex('tb3_pkey');\n-[ RECORD 1 ]------+---------\nversion            | 2\ntree_level         | 2\nindex_size         | 22487040\nroot_block_no      | 412\ninternal_pages     | 11\nleaf_pages         | 2733\nempty_pages        | 0\ndeleted_pages      | 0\navg_leaf_density   | 72.11\nleaf_fragmentation | 0\n\ntest=# select * from pgstattuple('tb3');\n-[ RECORD 1 ]------+---------\ntable_len          | 68272128\ntuple_count        | 800000\ntuple_len          | 48800000\ntuple_percent      | 71.48\ndead_tuple_count   | 0\ndead_tuple_len     | 0\ndead_tuple_percent | 0\nfree_space         | 12838776\nfree_percent       | 18.81\n\ntest=# vacuum full tb3;\nVACUUM\ntest=# select * from pgstattuple('tb3');\n-[ RECORD 1 ]------+---------\ntable_len          | 54616064\ntuple_count        | 800000\ntuple_len          | 48800000\ntuple_percent      | 89.35\ndead_tuple_count   | 0\ndead_tuple_len     | 0\ndead_tuple_percent | 0\nfree_space         | 29388\nfree_percent       | 0.05\n\n\n</code></pre>"},{"location":"postgres/install/pgstattuple/#pg_freespacemap","title":"pg_freespacemap","text":"<p>\u67e5\u770b\u6bcf\u4e00\u9875\u7684\u7a7a\u95f4\u5229\u7528</p> <p>\u521b\u5efa\u62d3\u5c55</p> <pre><code>create extension pg_freespacemap;\n\n</code></pre> <p>\u67e5\u770b\u6bcf\u4e2a\u9875\u7684\u7a7a\u95f4\u5229\u7528 </p> <pre><code>select * from pg_freespace('tablename');\n</code></pre> <p>\u67e5\u770b\u8868\u7684\u7a7a\u95f4\u5229\u7528</p> <pre><code>select count(*) as \"number of pages\", pg_size_pretty(cast(avg(avail) as bigint)) as \"freespace size \", round(100* avg(avail)/8192,2) as \"freespace ratio\" \nfrom pg_freespace('tablename');\n</code></pre> <p>\u5b9e\u6218</p>"},{"location":"postgres/install/pgstattuple/#_7","title":"\u8868\u7a7a\u95f4\u6570\u636e\u81a8\u80c0\u76d1\u63a7","text":"<p>\u5728\u5b9e\u9645\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u7531\u4e8e\u6570\u636e\u91cf\u975e\u5e38\u5927\uff0c\u4f20\u7edf\u65b9\u5f0f\u7edf\u8ba1\u8868\u7a7a\u95f4\u7684\u81a8\u80c0\u7387\u975e\u5e38\u8017\u65f6\u8017\u8d44\u6e90\u3002</p> <p>\u7ed3\u5408\u7edf\u8ba1\u60c5\u51b5\uff0c\u8fdb\u884c\u8bc4\u4f30</p> <pre><code>-- CREATE SCHEMA \n\nCREATE SCHEMA IF NOT EXISTS monitor;\nCREATE EXTENSION IF NOT EXISTS pg_repack WITH SCHEMA monitor;\n\n-- Table bloat estimate\nCREATE OR REPLACE VIEW monitor.pg_table_bloat AS\n    SELECT CURRENT_CATALOG AS datname, nspname, relname , bs * tblpages AS size,\n           CASE WHEN tblpages - est_tblpages_ff &gt; 0 THEN (tblpages - est_tblpages_ff)/tblpages::FLOAT ELSE 0 END AS ratio\n    FROM (\n             SELECT ceil( reltuples / ( (bs-page_hdr)*fillfactor/(tpl_size*100) ) ) + ceil( toasttuples / 4 ) AS est_tblpages_ff,\n                    tblpages, fillfactor, bs, tblid, nspname, relname, is_na\n             FROM (\n                      SELECT\n                          ( 4 + tpl_hdr_size + tpl_data_size + (2 * ma)\n                              - CASE WHEN tpl_hdr_size % ma = 0 THEN ma ELSE tpl_hdr_size % ma END\n                              - CASE WHEN ceil(tpl_data_size)::INT % ma = 0 THEN ma ELSE ceil(tpl_data_size)::INT % ma END\n                              ) AS tpl_size, (heappages + toastpages) AS tblpages, heappages,\n                          toastpages, reltuples, toasttuples, bs, page_hdr, tblid, nspname, relname, fillfactor, is_na\n                      FROM (\n                               SELECT\n                                   tbl.oid AS tblid, ns.nspname , tbl.relname, tbl.reltuples,\n                                   tbl.relpages AS heappages, coalesce(toast.relpages, 0) AS toastpages,\n                                   coalesce(toast.reltuples, 0) AS toasttuples,\n                                   coalesce(substring(array_to_string(tbl.reloptions, ' ') FROM 'fillfactor=([0-9]+)')::smallint, 100) AS fillfactor,\n                                   current_setting('block_size')::numeric AS bs,\n                                   CASE WHEN version()~'mingw32' OR version()~'64-bit|x86_64|ppc64|ia64|amd64' THEN 8 ELSE 4 END AS ma,\n                                   24 AS page_hdr,\n                                   23 + CASE WHEN MAX(coalesce(s.null_frac,0)) &gt; 0 THEN ( 7 + count(s.attname) ) / 8 ELSE 0::int END\n                                       + CASE WHEN bool_or(att.attname = 'oid' and att.attnum &lt; 0) THEN 4 ELSE 0 END AS tpl_hdr_size,\n                                   sum( (1-coalesce(s.null_frac, 0)) * coalesce(s.avg_width, 0) ) AS tpl_data_size,\n                                   bool_or(att.atttypid = 'pg_catalog.name'::regtype)\n                                       OR sum(CASE WHEN att.attnum &gt; 0 THEN 1 ELSE 0 END) &lt;&gt; count(s.attname) AS is_na\n                               FROM pg_attribute AS att\n                                        JOIN pg_class AS tbl ON att.attrelid = tbl.oid\n                                        JOIN pg_namespace AS ns ON ns.oid = tbl.relnamespace\n                                        LEFT JOIN pg_stats AS s ON s.schemaname=ns.nspname AND s.tablename = tbl.relname AND s.inherited=false AND s.attname=att.attname\n                                        LEFT JOIN pg_class AS toast ON tbl.reltoastrelid = toast.oid\n                               WHERE NOT att.attisdropped AND tbl.relkind = 'r' AND nspname NOT IN ('pg_catalog','information_schema')\n                               GROUP BY 1,2,3,4,5,6,7,8,9,10\n                           ) AS s\n                  ) AS s2\n         ) AS s3\n    WHERE NOT is_na;\n\n-- Index bloat estimate\nCREATE OR REPLACE VIEW monitor.pg_index_bloat AS\n    SELECT CURRENT_CATALOG AS datname, nspname, idxname AS relname, relpages::BIGINT * bs AS size,\n           COALESCE((relpages - ( reltuples * (6 + ma - (CASE WHEN index_tuple_hdr % ma = 0 THEN ma ELSE index_tuple_hdr % ma END)\n                                                   + nulldatawidth + ma - (CASE WHEN nulldatawidth % ma = 0 THEN ma ELSE nulldatawidth % ma END))\n                                      / (bs - pagehdr)::FLOAT  + 1 )), 0) / relpages::FLOAT AS ratio\n    FROM (\n             SELECT nspname,\n                    idxname,\n                    reltuples,\n                    relpages,\n                    current_setting('block_size')::INTEGER                                                               AS bs,\n                    (CASE WHEN version() ~ 'mingw32' OR version() ~ '64-bit|x86_64|ppc64|ia64|amd64' THEN 8 ELSE 4 END)  AS ma,\n                    24                                                                                                   AS pagehdr,\n                    (CASE WHEN max(COALESCE(pg_stats.null_frac, 0)) = 0 THEN 2 ELSE 6 END)                               AS index_tuple_hdr,\n                    sum((1.0 - COALESCE(pg_stats.null_frac, 0.0)) *\n                        COALESCE(pg_stats.avg_width, 1024))::INTEGER                                                     AS nulldatawidth\n             FROM pg_attribute\n                      JOIN (\n                 SELECT pg_namespace.nspname,\n                        ic.relname                                                   AS idxname,\n                        ic.reltuples,\n                        ic.relpages,\n                        pg_index.indrelid,\n                        pg_index.indexrelid,\n                        tc.relname                                                   AS tablename,\n                        regexp_split_to_table(pg_index.indkey::TEXT, ' ') :: INTEGER AS attnum,\n                        pg_index.indexrelid                                          AS index_oid\n                 FROM pg_index\n                          JOIN pg_class ic ON pg_index.indexrelid = ic.oid\n                          JOIN pg_class tc ON pg_index.indrelid = tc.oid\n                          JOIN pg_namespace ON pg_namespace.oid = ic.relnamespace\n                          JOIN pg_am ON ic.relam = pg_am.oid\n                 WHERE pg_am.amname = 'btree' AND ic.relpages &gt; 0 AND nspname NOT IN ('pg_catalog', 'information_schema')\n             ) ind_atts ON pg_attribute.attrelid = ind_atts.indexrelid AND pg_attribute.attnum = ind_atts.attnum\n                      JOIN pg_stats ON pg_stats.schemaname = ind_atts.nspname\n                 AND ((pg_stats.tablename = ind_atts.tablename AND pg_stats.attname = pg_get_indexdef(pg_attribute.attrelid, pg_attribute.attnum, TRUE))\n                     OR (pg_stats.tablename = ind_atts.idxname AND pg_stats.attname = pg_attribute.attname))\n             WHERE pg_attribute.attnum &gt; 0\n             GROUP BY 1, 2, 3, 4, 5, 6\n         ) est\n    LIMIT 512;\n\n-- index bloat overview\nCREATE OR REPLACE VIEW monitor.pg_table_bloat_human AS\n    SELECT nspname || '.' || relname AS name,\n           pg_size_pretty(size)      AS size,\n           pg_size_pretty((size * ratio)::BIGINT) AS wasted,\n           round(100 * ratio::NUMERIC, 2)  as ratio\n    FROM monitor.pg_table_bloat ORDER BY wasted DESC NULLS LAST;\n\nCREATE OR REPLACE VIEW monitor.pg_index_bloat_human AS\n    SELECT nspname || '.' || relname              AS name,\n           pg_size_pretty(size)                   AS size,\n           pg_size_pretty((size * ratio)::BIGINT) AS wasted,\n           round(100 * ratio::NUMERIC, 2)         as ratio\n    FROM monitor.pg_index_bloat;\n</code></pre>"},{"location":"postgres/install/pgstattuple/#_8","title":"\u4e3b\u8981\u539f\u56e0\u5206\u6790\u53ca\u76d1\u63a7\u63aa\u65bd","text":""},{"location":"postgres/install/pgstattuple/#_9","title":"\u957f\u4e8b\u52a1","text":"<pre><code>-- \u8de8\u4e8b\u52a1\nSELECT pid, datname, usename, state, backend_xmin\nFROM pg_stat_activity\nWHERE backend_xmin IS NOT NULL\nORDER BY age(backend_xmin) DESC;\n</code></pre> <pre><code>-- \u8de8\u65f6\u95f4\nselect * from pg_stat_activity \nwhere state&lt;&gt;'idle' and pg_backend_pid()!=pid and (backend_xid is not null or backend_xmin is not null) and \nextract(epoch from(now()-xact_start))&gt;6 \norder by xact_start;\n</code></pre>"},{"location":"postgres/install/pgstattuple/#_10","title":"\u5e9f\u5f03\u7684\u590d\u5236\u69fd","text":"<pre><code>SELECT slot_name, slot_type, database, xmin\nFROM pg_replication_slots\nORDER BY age(xmin) DESC;\n</code></pre>"},{"location":"postgres/install/pgstattuple/#_11","title":"\u4e24\u9636\u6bb5\u63d0\u4ea4","text":"<pre><code>SELECT gid, prepared, owner, database, transaction AS xmin\nFROM pg_prepared_xacts\nORDER BY age(transaction) DESC;\n</code></pre>"},{"location":"postgres/install/pgstattuple/#_12","title":"\u7a7a\u95f4\u6574\u7406","text":"<p>\u4e3a\u4e86\u907f\u514d\u9501\u8868\u7684\u5f71\u54cd</p> <ul> <li>pg_squeeze,\u4f7f\u7528\u903b\u8f91\u590d\u5236\u3002</li> <li>pg_repack\uff0c\u4f7f\u7528\u4e86\u89e6\u53d1\u5668\uff0c\u5f71\u54cd\u4e1a\u52a1\u7684\u6027\u80fd\u3002</li> <li>pgcompacttable\uff0c\u5229\u7528\u6570\u636e\u5e93\u81ea\u8eab\u7279\u6027 MVCC</li> </ul>"},{"location":"postgres/install/pgstattuple/#_13","title":"\u5b9e\u6218","text":"<pre><code>create table pgtest(id int primary key, col1 text);\ninsert into pgtest select n, md5(random()::text) || n from generate_series(1, 5000000) as n;\ndelete from pgtest where id%2 = 1; \nvacuum pgtest;\nselect pg_size_pretty(pg_total_relation_size('pgtest'));\n pg_size_pretty \n----------------\n 472 MB\n</code></pre>"},{"location":"postgres/install/pgstattuple/#pg_repack","title":"pg_repack","text":"<p>\u5b89\u88c5 </p> <pre><code>apt-get install postgresql-xx-repack\n</code></pre> <p>\u5b89\u88c5\u62d3\u5c55</p> <pre><code>create extension pg_repack ; \n</code></pre> <p>\u6d4b\u8bd5\u8fd0\u884c</p> <pre><code>pg_repack -h localhost -d postgres -U postgres -t pgtest -e -N\n</code></pre> <p>\u6b63\u5f0f\u8fd0\u884c</p> <pre><code>pg_repack -h localhost -d postgres -U postgres -t pgtest -e \n</code></pre> <p>\u67e5\u770b\u7ed3\u679c</p> <pre><code>select pg_size_pretty(pg_total_relation_size('pgtest'));\n pg_size_pretty \n----------------\n 236 MB\n\n</code></pre>"},{"location":"postgres/install/pgstattuple/#pgcompacttable","title":"pgcompacttable","text":"<p>\u5b89\u88c5</p> <pre><code>apt-get install libdbi-perl libdbd-pg-perl\n\ngit clone https://github.com/dataegret/pgcompacttable.git\n</code></pre> <p>\u8fd0\u884c</p> <pre><code>bin/pgcompacttable ./pgcompacttable  -U postgres -d postgres -t pgtest -v \n</code></pre>"},{"location":"postgres/install/pgstattuple/#pg_squeeze","title":"pg_squeeze","text":"<p>\u5b89\u88c5</p> <pre><code>apt-get install postgresql-xx-squeeze;\n</code></pre> <p>\u914d\u7f6e</p> <pre><code>wal_level = logical\nmax_replication_slots = 1 # ... or add 1 to the current value.\nshared_preload_libraries = 'pg_squeeze' # ... or add the library to the existing ones.\n</code></pre> <p>\u521b\u5efa\u62d3\u5c55</p> <pre><code> CREATE EXTENSION pg_squeeze;\n</code></pre> <p>\u624b\u52a8\u6267\u884c</p> <pre><code>SELECT squeeze.squeeze_table('public', 'pgtest');\n</code></pre> <p>\u5728\u6bcf\u5468\u4e09\u548c\u5468\u4e94\u768422:30\uff0c\u81ea\u52a8\u6e05\u7406public schema\u4e0b\u7684\u8868pgtest</p> <pre><code>INSERT INTO squeeze.tables (\n    tabschema,\n    tabname,\n    schedule,\n    free_space_extra,\n    vacuum_max_age,\n    max_retry\n)\nVALUES (\n    'public',\n    'pgtest',\n    ('{30}', '{22}', NULL, NULL, '{3, 5}'),\n    30,\n    '2 hours',\n    2\n);\n\nSELECT squeeze.start_worker();  -- \u5f00\u542f\nSELECT squeeze.stop_worker();   -- \u5173\u95ed\n</code></pre>"},{"location":"postgres/install/postgres12/","title":"postgres 12","text":""},{"location":"postgres/install/postgres12/#_1","title":"\u5b89\u88c5&amp;\u542f\u52a8","text":"<pre><code>#\u4e0b\u8f7d\u6e90\nyum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm\n#\u5b89\u88c5\u670d\u52a1\nyum install postgresql12 postgresql12-server postgresql12-contrib\n#\u521d\u59cb\u5316\n/usr/pgsql-12/bin/postgresql-12-setup initdb\n#\u542f\u52a8\u670d\u52a1\nsystemctl enable postgresql-12\nsystemctl start postgresql-12\n</code></pre>"},{"location":"postgres/install/postgres12/#_2","title":"\u6d41\u590d\u5236","text":"<pre><code>#\u4ece\u673a \u5efa\u7acb\u4ece\u5e93\npg_basebackup -h 10.1.30.13 -U postgres -F p -P -R -D /var/lib/pgsql/12/data/ --checkpoint=fast -l postgresback\n#\u4ece\u5e93\u5347\u7ea7\u4e3a\u4e3b\u5e93\nsudo su postgres -c  \"/usr/pgsql-12/bin/pg_ctl promote -D /var/lib/pgsql/12/data/\"\n</code></pre> <ul> <li>recovery.conf \u914d\u7f6e\u6587\u4ef6\u4e0d\u518d\u652f\u6301\uff0c\u6b64\u6587\u4ef6\u4e2d\u7684\u53c2\u6570\u5408\u5e76\u5230 postgresql.conf(postgresql.auto.conf) Recovery Target, \u82e5 recovery.conf \u5b58\u5728\uff0c\u6570\u636e\u5e93\u65e0\u6cd5\u542f\u52a8</li> <li>\u65b0\u589e recovery.signal \u6807\u8bc6\u6587\u4ef6\uff0c\u8868\u793a\u6570\u636e\u5e93\u5904\u4e8e recovery \u6a21\u5f0f</li> <li>\u65b0\u589e\u52a0 standby.signal \u6807\u8bc6\u6587\u4ef6\uff0c\u8868\u793a\u6570\u636e\u5e93\u5904\u4e8e standby \u6a21\u5f0f</li> <li>trigger_file \u53c2\u6570\u66f4\u540d\u4e3a promote_trigger_file</li> <li>standby_mode \u53c2\u6570\u4e0d\u518d\u652f\u6301</li> </ul> <p>\u5728postgres 12 \u7248\u672c\u4e2d\u65b0\u589e\u4e00\u4e2a\u6fc0\u6d3b\u4ece\u5e93\u4e3a\u4e3b\u5e93\u7684\u65b9\u5f0f\u3002pg_promote \u51fd\u6570\uff0c\u76f8\u6bd4\u539f\u6709\u7684\u4e24\u79cd\u65b9\u5f0f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u7684\u4f18\u70b9\u5728\u4e8e\u4e0d\u9700\u8981\u767b\u9646\u5230\u5b9e\u4f53\u673a\u4e0a\uff0c\u53ef\u8fdc\u7a0b\u901a\u8fc7sql\u8fdb\u884c\u64cd\u4f5c\u3002 pg_promote() \u51fd\u6570\u6709\u4e24\u4e2a\u53c2\u6570:</p> <ul> <li>wait: \u8868\u793a\u662f\u5426\u7b49\u5f85\u5907\u5e93\u7684 promotion \u5b8c\u6210\u6216\u8005 wait_seconds \u79d2\u4e4b\u540e\u8fd4\u56de\u6210\u529f\uff0c\u9ed8\u8ba4\u503c\u4e3a true\u3002</li> <li>wait_seconds: \u7b49\u5f85\u65f6\u95f4\uff0c\u5355\u4f4d\u79d2\uff0c\u9ed8\u8ba4 60</li> </ul> <p>\u6d41\u590d\u5236\u4e3b\u5907\u5207\u6362\u4e3b\u8981\u6b65\u9aa4\u5982\u4e0b:</p> <p>\u6b65\u9aa41 \u5173\u95ed\u4e3b\u5e93  </p> <p>\u6b65\u9aa42 \u6fc0\u6d3b\u5907\u5e93: \u4e09\u79cd\u65b9\u5f0f\u4efb\u9009\u4e00\u79cd: 1) pg_ctl promote \u547d\u4ee4\u65b9\u5f0f; 2) \u521b\u5efa\u89e6\u53d1\u5668\u6587\u4ef6\u65b9\u5f0f; 3) pg_promote()\u51fd\u6570\u65b9\u5f0f\u3002</p> <p>\u6b65\u9aa43 \u8001\u4e3b\u5e93\u89d2\u8272\u8f6c\u6362\u6210\u5907\u5e93: \u5728\u8001\u4e3b\u5e93\u4e3b\u673a pghost1 \u7684 $PGDATA \u76ee\u5f55\u4e0b\u521b\u5efa standby.signal \u6807\u8bc6\u6587\u4ef6,postgresql.auto.conf \u7c7b\u4f3c\u4e8e\u4ee5\u524d\u7248\u672c\u7684recovery.conf\u3002</p> <p>\u6b65\u9aa44 \u542f\u52a8\u8001\u4e3b\u5e93\u5e76\u9a8c\u8bc1</p> <p>\u5177\u4f53\u64cd\u4f5c</p>"},{"location":"postgres/install/postgres12/#_3","title":"\u5206\u533a\u8868","text":"<p>\u652f\u6301\u7c7b\u578b </p> <ul> <li>Range  </li> <li>List  </li> <li>Hash  </li> </ul> <p>\u521b\u5efa\u8868</p> <pre><code>CREATE TABLE measurement (\n    city_id         int not null,\n    logdate         date not null,\n    peaktemp        int,\n    unitsales       int\n) PARTITION BY RANGE (logdate);\n</code></pre> <p>\u521b\u5efa\u5206\u533a</p> <pre><code>CREATE TABLE measurement_y2006m02 PARTITION OF measurement\n    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01');\n\nCREATE TABLE measurement_y2006m03 PARTITION OF measurement\n    FOR VALUES FROM ('2006-03-01') TO ('2006-04-01');\n\n--- \u9ed8\u8ba4\u5206\u533a\nCREATE TABLE measurement_y2006m02 PARTITION OF measurement\n    default;\n</code></pre> <p>\u63d2\u5165\u6570\u636e</p> <pre><code>select  cast(random()*10 as integer), date'2006-02-01'  + (id||' hour')::interval,cast(random()*30 as integer),cast(random()*10000 as integer) \n    from generate_series(1,2000) t(id);\n</code></pre> <p>\u521b\u5efa\u7d22\u5f15,\u4e0e\u4ee5\u524d\u7248\u672c\u7684\u533a\u522b\u53ef\u4ee5\u5728\u7236\u8868\u4e0a\u7edf\u4e00\u521b\u5efa\u7d22\u5f15\u3002\u4e5f\u53ef\u4ee5\u5728\u6bcf\u4e2a\u5b50\u8868\u4e0a\u6839\u636e\u9700\u6c42\u5206\u522b\u521b\u5efa\u7d22\u5f15\u3002\u66f4\u7075\u6d3b\u3002 \u5efa\u8bae\u5728\u5206\u533a\u5217\u4e0a\u521b\u5efa\u7d22\u5f15\uff0c\u5229\u7528\u5206\u533a\u88c1\u526a\uff08enable_partition_pruning\uff09\u63d0\u9ad8\u6548\u7387\u3002</p> <pre><code>CREATE INDEX ON measurement (logdate);\n</code></pre> <p>\u7ef4\u62a4\u5206\u533a\u8868</p> <pre><code>--- \u5220\u9664\u5206\u533a\u8868,\u4f1a\u9501\u4e3b\u8868\nDROP TABLE measurement_y2006m02;\n--- \u901a\u5e38\u65b9\u5f0f\uff0c\u5c06\u5206\u533a\u8868\u8131\u79bb\u51fa\u4e3b\u8868\uff0c\u7136\u540e\u5728\u5bf9\u5206\u533a\u8868\u8fdb\u884c\u64cd\u4f5c\nALTER TABLE measurement DETACH PARTITION measurement_y2006m02;\n\n--- \u5c06\u5df2\u6709\u8868\u4f5c\u4e3a\u5206\u533a\u8868\u52a0\u5165\u5230\u4e3b\u8868\u4e2d, \u76f4\u63a5\u52a0\u5165\u4f1a\u9501\u4e3b\u8868\nALTER TABLE measurement ATTACH PARTITION measurement_y2008m02\n    FOR VALUES FROM ('2008-02-01') TO ('2008-03-01' );\n\n--- \u901a\u5e38\u505a\u6cd5\uff0c\u5bf9\u9700\u8981\u5bf9\u52a0\u5165\u7684\u5206\u533a\u8868\u52a0\u68c0\u67e5\u7ea6\u675f\uff0c\u7136\u540e\u5728\u5c06\u5206\u533a\u8868\u52a0\u5165\u5230\u4e3b\u8868\u4e2d\n\nALTER TABLE measurement_y2008m02 ADD CONSTRAINT y2008m02\n   CHECK ( logdate &gt;= DATE '2008-02-01' AND logdate &lt; DATE '2008-03-01' );\n\nALTER TABLE measurement ATTACH PARTITION measurement_y2008m02\n    FOR VALUES FROM ('2008-02-01') TO ('2008-03-01' );\n</code></pre> <p>\u5206\u533a\u8868\u53ef\u4ee5\u5b58\u5728\u4e8e\u4e0d\u540c\u7684\u8868\u7a7a\u95f4\u4e2d\uff0c\u8fd9\u6837\u7684\u7279\u6027\u65b9\u4fbf\u6570\u636e\u7684\u51b7\u70ed\u533a\u5206\u5904\u7406\u3002</p> <p>\u5bf9\u7d22\u5f15\u7684\u7ba1\u7406</p> <p>\u901a\u5e38\u60c5\u51b5\u4e0b\u5982\u679c\u5bf9\u4e00\u5f20\u8868\u52a0\u5165\u7d22\u5f15\u4f1a\u5835\u585e\u8be5\u8868\u7684dml\u64cd\u4f5c\uff0c\u7279\u522b\u662f\u5bf9\u4e00\u5f20\u5927\u8868\u7684\u64cd\u4f5c\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u5728\u4e3b\u8868\u4e2d\u52a0\u5165\u4e00\u4e2a\u7d22\u5f15\uff0c\u8be5\u7d22\u5f15\u4e5f\u4f1a\u52a0\u5165\u5230\u7d22\u5f15\u7684\u5b50\u8868\u4e2d\uff0c\u65e0\u8bba\u662f\u73b0\u6709\u7684\u5b50\u8868\u8fd8\u662f\u5c06\u6765\u65b0\u52a0\u5165\u7684\u5b57\u8868\u3002\u8fd9\u6837\u6781\u5927\u7684\u65b9\u4fbf\u4e86\u5bf9\u5206\u533a\u8868\u7684\u7ef4\u62a4\u3002\u76ee\u524d\u5728\u5206\u533a\u8868\u4e0a\u5efa\u7acb\u7d22\u5f15\u65f6\u4e0d\u652f\u6301CONCURRENTLY</p> <p>\u4f46\u662f\u8003\u8651\u7684\u5bf9\u5728\u7ebf\u4e1a\u52a1\u7684\u5f71\u54cd\uff0c\u5728\u5206\u533a\u8868\u4e2d\u5efa\u8bae\u7684\u64cd\u4f5c\u6d41\u7a0b\u3002 </p> <p>\u9996\u5148\u5728\u4e3b\u8868\u4e0a\u4f7f\u7528 create index on only \u8bed\u53e5\u521b\u5efa\u7d22\u5f15\uff0c\u7136\u540e\u5206\u522b\u5728\u5b50\u8868\u4e0a\u521b\u5efa\u7d22\u5f15\u3002\u5f53\u6240\u6709\u5b50\u8868\u4e0a\u7684\u7d22\u5f15\u90fd\u5efa\u7acb\u5b8c\u6bd5\u540e\u4e3b\u8868\u4e0a\u7684\u7d22\u5f15\u88ab\u6fc0\u6d3b\u3002</p> <p>\u8be5\u65b9\u5f0f\u4e5f\u9002\u7528\u4e8e\u5176\u4ed6\uff08\u7ea6\u675f\uff09\u7b49</p> <pre><code>CREATE INDEX measurement_usls_idx ON ONLY measurement (unitsales);\n\nCREATE INDEX measurement_usls_200602_idx\n    ON measurement_y2006m02 (unitsales);\nALTER INDEX measurement_usls_idx\n    ATTACH PARTITION measurement_usls_200602_idx;\n\n</code></pre>"},{"location":"postgres/install/postgres12/#_4","title":"\u5176\u4ed6","text":"<p>https://yq.aliyun.com/articles/720247?spm=a2c4e.11153940.0.0.48cf2f79tPuOrL</p> <p>https://github.com/digoal/blog/blob/0ef02248fe7419c55a98a425feefd2421ad25537/201906/20190624_02.md</p>"},{"location":"postgres/install/postgresql-howto/","title":"howto \u7cfb\u5217","text":""},{"location":"postgres/install/postgresql-howto/#explain-analyze-buffers","title":"explain analyze buffers \u7406\u89e3","text":"<p>hit buffers \u7684\u5177\u4f53\u542b\u4e49\u3002 \u4e0d\u662f\u8868\u9762\u4e0a\u7406\u89e3\u7684\u547d\u4e2d\u7f13\u5b58\u5757\u7684\u6570\u91cf\uff0c\u800c\u662f\u6b21\u6570\u3002</p>"},{"location":"postgres/install/postgresql-howto/#_1","title":"\u5f71\u54cd\u6570\u636e\u5e93\u5173\u95ed\u7684\u4e8b\u4ef6","text":"<p>\u5f53\u6570\u636e\u5e93\u6267\u884c\u5173\u95ed\u64cd\u4f5c\u65f6\uff0c\u9700\u8981\u957f\u65f6\u95f4\u7684\u5904\u7406\u95ee\u9898\u5206\u6790</p> <ul> <li>\u957f\u4e8b\u52a1</li> <li>\u5185\u5b58\u810f\u6570\u636e</li> <li>\u672a\u5b8c\u6210\u7684\u5f52\u6863\uff0c\u4ece\u5e93\u5ef6\u8fdfwal\u65e5\u5fd7</li> </ul> <p>\u4e09\u79cd \u5173\u95ed\u6a21\u5f0f - Smart  \u7981\u6b62\u65b0\u8fde\u63a5\uff0c\u7136\u540e\u7b49\u5f85\u6240\u6709\u73b0\u6709\u5ba2\u6237\u7aef\u65ad\u5f00\u8fde\u63a5 - Fast \uff08\u9ed8\u8ba4\uff09 \u4e0d\u4f1a\u7b49\u5f85\u5ba2\u6237\u7aef\u65ad\u5f00\u8fde\u63a5\u3002\u6240\u6709\u6d3b\u52a8\u4e8b\u52a1\u90fd\u4f1a\u56de\u6eda\uff0c\u5ba2\u6237\u7aef\u4f1a\u88ab\u5f3a\u5236\u65ad\u5f00\u8fde\u63a5\uff0c\u7136\u540e\u670d\u52a1\u5668\u5c31\u4f1a\u5173\u95ed - Immediate \u7acb\u5373\u5173\u95ed\u3002\u4e0d\u6267\u884ccheckpoint , \u5728\u4e0b\u6b21\u91cd\u542f\u7684\u65f6\u5019\u6267\u884c\u6062\u590d\u3002</p>"},{"location":"postgres/install/postgresql-howto/#_2","title":"\u6570\u636e\u5e93\u542f\u52a8\u7b49\u5f85\u8fc7\u7a0b\u5206\u6790","text":"<p>\u5f53\u6570\u636e\u5e93\u542f\u52a8\u65f6\u95f4\u8fc7\u957f\uff0c\u5982\u4f55\u5206\u6790\u6570\u636e\u5e93\u6b63\u5728\u6267\u884c\u60c5\u51b5\uff0c\u5728\u505a\u4ec0\u4e48\uff0c\u54ea\u4e2a\u9636\u6bb5\uff0c\u8fd8\u6709\u591a\u4e45\u7b49</p> <p>\u65e5\u5fd7\u5185\u5bb9\u901a\u5e38\u5982\u4e0b</p> <pre><code>FATAL: the database system is starting up\n</code></pre> <p>1 \u901a\u8fc7\u8fdb\u7a0b\u5206\u6790 \u5f53\u524d\u6062\u590d\u8fdb\u5ea6</p> <pre><code>ps ax | grep 'startup recovering'\n98786   ??  Us     0:15.81 postgres: startup recovering 000000010000004100000018\n</code></pre> <p>2 pg_controldata -D $PGDATA \u67e5\u770b\u6570\u636e\u5e93\u5143\u6570\u636e\u8fdb\u884c\u5206\u6790</p> <p>\u7ed3\u5408\u6570\u636e\u5e93\u6062\u590d\u91cf\u5f00\u59cb\u3001\u5f53\u524d\u5df2\u6062\u590d\u3001\u76ee\u6807\u3001\u5206\u6790\u8fdb\u5ea6</p> <pre><code>select pg_size_pretty(pg_lsn '4A/E0FFE518' - pg_lsn '45/58000000');\n</code></pre> <p>3 PG15 \u4e2d\u5f15\u5165\u7684 log_startup_progress_interval</p>"},{"location":"postgres/install/postgresql-howto/#ctid","title":"ctid \u9875\u5730\u5740","text":"<p>\u4e86\u89e3\u6570\u636e\u9875\u7269\u7406\u5206\u5e03\uff0c\u6570\u636e\u7a00\u758f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd`</p> <pre><code>explain select ctid, * from t1 where  ctid = '(1, 12)';\n</code></pre>"},{"location":"postgres/install/postgresql-howto/#pg_stat_statements","title":"\u5229\u7528pg_stat_statements\u8fdb\u884c\u5b8f\u89c2\u4f18\u5316","text":"<ul> <li>\u65f6\u95f4\u505a\u5fae\u5206\uff0cQPS \u5b8f\u89c2\u4f18\u5316\u65e8\u5728\u51cf\u5c11\u8d44\u6e90\u6d88\u8017 </li> <li>\u6b21\u6570\u505a\u5fae\u5206\uff0c\u5ef6\u8fdf \u5b8f\u89c2\u4f18\u5316\u65e8\u5728\u6539\u5584\u7528\u6237\u4f53\u9a8c </li> <li>\u767e\u5206\u6bd4\uff0cTop-N  \u5b8f\u89c2\u4f18\u5316\u65e8\u5728\u5e73\u8861\u5de5\u4f5c\u91cf </li> </ul>"},{"location":"postgres/install/postgresql-howto/#pg_dump-pg_restore","title":"pg_dump pg_restore","text":"<p>\u4ee5\u524d\u7684\u901a\u7528\u505a\u6cd5</p> <pre><code>\u5907\u4efd\uff1apg_dump -U postgres -v -F c -Z 4 -f ***.backup dbname  9\u538b\u7f29\u7387\u6700\u72e0\n\u6062\u590d\uff1apg_restore -U postgres -v -j 8 -d dbname ***.backup   8\u662f\u91c7\u75288\u4e2a\u7ebf\u7a0b\n</code></pre> <p>\u4f46\u662f -F c \u4fdd\u5b58\u5728\u4e00\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e0d\u80fd\u5e76\u53d1\u6267\u884c\u3002 -F d \u4e3a\u4e00\u4e2a\u76ee\u5f55\u6587\u4ef6\uff0c\u53ef\u4ee5\u5e76\u884c </p> <pre><code>time pg_dump -Fd -j8 -f ./test_dump test\n</code></pre> <p>\u4e0d\u843d\u76d8\u6570\u636e\u8fc1\u79fb pg_dump |  pg_restore , \u8fd9\u79cd\u4e0d\u80fd\u5e76\u884c\u3002 pgcopydb \u5de5\u5177\u5c31\u662f\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5305\u62ec\u4e00\u4e2a\u5927\u8868\u7684\u5e76\u884c\u5904\u7406\u3002</p>"},{"location":"postgres/install/postgresql-howto/#_3","title":"\u7d22\u5f15\u521b\u5efa\u8fdb\u5ea6","text":"<p>PG12+ , \u4f9d\u8d56 pg_stat_progress_create_index</p> <pre><code>select\n   now(),\n   query_start as started_at,\n   now() - query_start as query_duration,\n   format('[%s] %s', a.pid, a.query) as pid_and_query,\n   index_relid::regclass as index_name,\n   relid::regclass as table_name,\n   (pg_size_pretty(pg_relation_size(relid))) as table_size,\n   nullif(wait_event_type, '') || ': ' || wait_event as wait_type_and_event,\n   phase,\n   format(\n           '%s (%s of %s)',\n           coalesce((round(100 * blocks_done::numeric / nullif(blocks_total, 0), 2))::text || '%', 'N/A'),\n           coalesce(blocks_done::text, '?'),\n           coalesce(blocks_total::text, '?')\n   ) as blocks_progress,\n   format(\n           '%s (%s of %s)',\n           coalesce((round(100 * tuples_done::numeric / nullif(tuples_total, 0), 2))::text || '%', 'N/A'),\n           coalesce(tuples_done::text, '?'),\n           coalesce(tuples_total::text, '?')\n   ) as tuples_progress,\n   current_locker_pid,\n   (select nullif(left(query, 150), '') || '...' from pg_stat_activity a where a.pid = current_locker_pid) as current_locker_query,\n   format(\n           '%s (%s of %s)',\n           coalesce((round(100 * lockers_done::numeric / nullif(lockers_total, 0), 2))::text || '%', 'N/A'),\n           coalesce(lockers_done::text, '?'),\n           coalesce(lockers_total::text, '?')\n   ) as lockers_progress,\n   format(\n           '%s (%s of %s)',\n           coalesce((round(100 * partitions_done::numeric / nullif(partitions_total, 0), 2))::text || '%', 'N/A'),\n           coalesce(partitions_done::text, '?'),\n           coalesce(partitions_total::text, '?')\n   ) as partitions_progress,\n   (\n      select\n         format(\n                 '%s (%s of %s)',\n                 coalesce((round(100 * n_dead_tup::numeric / nullif(reltuples::numeric, 0), 2))::text || '%', 'N/A'),\n                 coalesce(n_dead_tup::text, '?'),\n                 coalesce(reltuples::int8::text, '?')\n         )\n      from pg_stat_all_tables t, pg_class tc\n      where t.relid = p.relid and tc.oid = p.relid\n   ) as table_dead_tuples\nfrom pg_stat_progress_create_index p\n        left join pg_stat_activity a on a.pid = p.pid\norder by p.index_relid\n; -- in psql, use \"\\watch 5\" instead of semicolon\n</code></pre>"},{"location":"postgres/install/postgresql-howto/#_4","title":"\u907f\u5751","text":""},{"location":"postgres/install/postgresql-howto/#nulls","title":"NULLs","text":"<p>\u4e0d\u8981\u4f7f\u7528 WHERE NOT IN (SELECT ...) \u2014 \u4f7f\u7528 NOT EXISTS \u4ee3\u66ff</p> <pre><code>CREATE TABLE test (\n    id INT PRIMARY KEY,\n    col INT\n);\n\nINSERT INTO test (id, col) VALUES\n(1, 2),  \n(2, 1),  \n(3, NULL),\n(4, 3);\n\nSELECT * FROM test WHERE col NOT IN (1, NULL);\n id | col \n----+-----\n(0 \u884c\u8bb0\u5f55)\n</code></pre>"},{"location":"postgres/install/postgresql-howto/#int4","title":"int4 \u4e3b\u952e","text":""},{"location":"postgres/install/postgresql-howto/#cpu-postgresql","title":"CPU \u5185\u5b58\u5bf9\u9f50\u4e0e PostgreSQL \u5bf9\u9f50\u586b\u5145\u8be6\u89e3","text":""},{"location":"postgres/install/postgresql-howto/#1","title":"1. \u5bf9\u9f50\u586b\u5145\u7684\u6838\u5fc3\u89c4\u5219","text":"<ul> <li>\u5b57\u957f\uff08Word Size\uff09\u5bf9\u9f50\uff1aCPU \u8bbf\u95ee\u5185\u5b58\u65f6\uff0c\u901a\u5e38\u4ee5\u5b57\u957f\uff08\u4f8b\u5982 8 \u5b57\u8282\uff09\u4e3a\u5355\u4f4d\u3002\u6570\u636e\u672a\u5bf9\u9f50\u65f6\u53ef\u80fd\u5bfc\u81f4\u591a\u6b21\u5185\u5b58\u64cd\u4f5c\uff0c\u6027\u80fd\u4e0b\u964d\u3002</li> <li>\u5b57\u6bb5\u8d77\u59cb\u5730\u5740\u89c4\u5219\uff1a\u5b57\u6bb5\u7684\u8d77\u59cb\u5730\u5740\u5fc5\u987b\u662f\u5176\u81ea\u8eab\u5927\u5c0f\u7684\u6574\u6570\u500d\u3002</li> <li><code>INT4</code>\uff084 \u5b57\u8282\uff09 \u2192 \u8d77\u59cb\u5730\u5740\u4e3a <code>4</code> \u7684\u500d\u6570\uff08\u5982 <code>0x00</code>, <code>0x04</code>, <code>0x08</code>\uff09\u3002</li> <li><code>TIMESTAMPTZ</code>\uff088 \u5b57\u8282\uff09 \u2192 \u8d77\u59cb\u5730\u5740\u4e3a <code>8</code> \u7684\u500d\u6570\uff08\u5982 <code>0x00</code>, <code>0x08</code>, <code>0x10</code>\uff09\u3002</li> </ul>"},{"location":"postgres/install/postgresql-howto/#2-id-int4-created_at-timestamptz","title":"2. \u8868\u7ed3\u6784 <code>(id INT4, created_at TIMESTAMPTZ)</code> \u7684\u5b58\u50a8\u5e03\u5c40","text":"\u5b57\u6bb5\u540d \u7c7b\u578b \u5b9e\u9645\u5360\u7528 \u5bf9\u9f50\u586b\u5145 \u603b\u5360\u7528 <code>id</code> <code>INT4</code> 4 \u5b57\u8282 4 \u5b57\u8282 8 \u5b57\u8282 <code>created_at</code> <code>TIMESTAMPTZ</code> 8 \u5b57\u8282 0 \u5b57\u8282 8 \u5b57\u8282 \u5bf9\u9f50\u586b\u5145\u539f\u56e0\uff1a - <code>created_at</code> \u9700\u8981\u4ece <code>8 \u5b57\u8282\u5bf9\u9f50\u5730\u5740</code> \u5f00\u59cb\u3002 - <code>id</code> \u4ec5\u5360\u7528 4 \u5b57\u8282\uff0c\u9700\u5728\u672b\u5c3e\u586b\u5145 4 \u5b57\u8282\u7a7a\u767d\uff0c\u4f7f <code>created_at</code> \u7684\u8d77\u59cb\u5730\u5740\u6ee1\u8db3 <code>0x08</code>\uff08\u5047\u8bbe <code>id</code> \u8d77\u59cb\u4e8e <code>0x00</code>\uff09\u3002 --- ####  3. \u8f6c\u6362\u4e3a <code>(id INT8, created_at TIMESTAMPTZ)</code> \u540e\u7684\u5b58\u50a8\u5e03\u5c40 \u5b57\u6bb5\u540d \u7c7b\u578b \u5b9e\u9645\u5360\u7528 \u5bf9\u9f50\u586b\u5145 \u603b\u5360\u7528 -------------- --------------- ---------- ---------- -------- <code>id</code> <code>INT8</code> 8 \u5b57\u8282 0 \u5b57\u8282 8 \u5b57\u8282 <code>created_at</code> <code>TIMESTAMPTZ</code> 8 \u5b57\u8282 0 \u5b57\u8282 8 \u5b57\u8282 \u5173\u952e\u53d8\u5316\uff1a - <code>id</code> \u5347\u7ea7\u4e3a <code>INT8</code>\uff088 \u5b57\u8282\uff09\uff0c\u76f4\u63a5\u6ee1\u8db3 <code>8 \u5b57\u8282\u5bf9\u9f50</code>\uff0c\u65e0\u9700\u586b\u5145\u3002 - <code>created_at</code> \u8d77\u59cb\u5730\u5740\u81ea\u52a8\u5bf9\u9f50\u5230 <code>0x08</code>\uff08\u7d27\u8ddf <code>id</code> \u7684\u7ed3\u675f\u5730\u5740 <code>0x08</code>\uff09\u3002 - \u603b\u78c1\u76d8\u7a7a\u95f4\u4e0d\u53d8\uff1a\u6bcf\u884c\u4ecd\u5360\u7528 16 \u5b57\u8282\uff08<code>8 + 8</code>\uff09\u3002 --- ####  4. \u5bf9\u9f50\u586b\u5145\u7684\u610f\u4e49 - \u6027\u80fd\u4f18\u5316\uff1a\u901a\u8fc7\u727a\u7272\u5c11\u91cf\u7a7a\u95f4\uff0c\u907f\u514d CPU \u591a\u6b21\u8bbf\u95ee\u5185\u5b58\uff0c\u63d0\u5347\u6570\u636e\u8bfb\u5199\u6548\u7387\u3002 - \u7a7a\u95f4\u6743\u8861\uff1a\u5728\u793a\u4f8b\u4e2d\uff0c<code>INT4 \u2192 INT8</code> \u7684\u5b57\u6bb5\u5347\u7ea7\u5e76\u672a\u589e\u52a0\u603b\u7a7a\u95f4\uff0c\u56e0\u4e3a\u539f\u6709\u586b\u5145\u5df2\u88ab\u9884\u7559\u3002"},{"location":"postgres/install/tablespace/","title":"tablespace \u8868\u7a7a\u95f4","text":"<p>\u539f\u6587</p> <p>\u6ce8\u610f\u4e3b\u4ece\u67b6\u6784\u65f6\uff0c\u4e3b\u4ece\u8f6f\u8fde\u63a5\u4f4d\u7f6e\u9700\u8981\u5bf9\u5e94\u4e00\u81f4\u3002</p> <p>\u601d\u8003\uff1a \u51b7\u70ed\u6570\u636e\u5206\u79bb \u51b7\u6570\u636e\u5bf9\u70ed\u6570\u636e\u7684\u5f71\u54cd\uff0c\u5783\u573e\u56de\u6536\u673a\u5236\u3002</p>"},{"location":"postgres/install/toast/","title":"TOAST \u6280\u672f","text":"<p>\u539f\u6587</p>"},{"location":"postgres/maintenance/archive/","title":"Archive wal\u5f52\u6863","text":""},{"location":"postgres/maintenance/archive/#_1","title":"\u4ecb\u7ecd","text":"<p>\u6240\u8c13WAL\u65e5\u5fd7\u5f52\u6863\uff0c\u5176\u5b9e\u5c31\u662f\u628a\u5728\u7ebf\u7684WAL\u65e5\u5fd7\u5907\u4efd\u51fa\u6765\u3002</p>"},{"location":"postgres/maintenance/archive/#_2","title":"\u914d\u7f6e","text":"<p>vi postgresql.conf</p> <pre><code>wal_level='replica'\n\n# - Archiving -\n\narchive_mode = on               # enables archiving; off, on, or always\n                                # (change requires restart)\narchive_command = 'test ! -f /mnt/backup/%f &amp;&amp; cp %p /mnt/backup/%f'\n                                # command to use to archive a logfile segment\n                                # placeholders: %p = path of file to archive\n                                #               %f = file name only\n                                # e.g. 'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'\n#archive_timeout = 0            # force a logfile segment switch after this\n                                # number of seconds; 0 disables\n\n</code></pre>"},{"location":"postgres/maintenance/archive/#_3","title":"\u53c2\u6570\u8bf4\u660e","text":"<ul> <li>wal_level archive \u6216\u66f4\u9ad8\u7ea7\u522b</li> <li>archive_mode on \u5f00\u542f\u5f52\u6863\u6a21\u5f0f\uff0calways \u4e3b\u4ece\u6a21\u5f0f\u65f6\uff0c\u4ece\u5e93\u4e5f\u5f00\u542f\u5f52\u6863\u6a21\u5f0f\u3002\u9700\u8981\u91cd\u542f\u6570\u636e\u5e93</li> <li>archive_command \u5f52\u6863\u65f6\u89e6\u53d1\u7684\u547d\u4ee4\u6216\u811a\u672c\uff0c \u4e0d\u9700\u8981\u91cd\u65b0\u542f\u52a8\u6570\u636e\u5e93\u3002 systemctl reload postgresql-10 \u5373\u53ef\u3002</li> <li>archive_timeout \u53ef\u4ee5\u7406\u89e3\u4e3a\u8d85\u8fc7\u6307\u5b9a\u65f6\u95f4\u5f3a\u5236\u6267\u884c  select pg_switch_wal(); \u573a\u666f\uff0c \u6570\u636e\u5e93\u4e0d\u662f\u5f88\u6d3b\u8dc3\uff0c\u6570\u636e\u5e93wal\u65e5\u5fd7\u4ea7\u751f\u7684\u8fc7\u6162\u65f6\u3002</li> </ul>"},{"location":"postgres/maintenance/archive/#_4","title":"\u5f52\u6863\u89e6\u53d1\u6761\u4ef6\u8bf4\u660e\uff1a","text":"<p>1 \u624b\u52a8\u6267\u884c select pg_switch_wal(); 2 WAL \u65e5\u5fd7\u5199\u6ee1\u540e\u89e6\u53d1\u5f52\u6863 WAL \u65e5\u5fd7\u6587\u4ef6\u9ed8\u8ba4\u4e3a 16MB\uff0c\u8fd9\u4e2a\u503c\u53ef\u4ee5\u5728\u7f16\u8bd1 PostgreSQL \u65f6\u901a\u8fc7\u53c2\u6570 \u201c\u2013with-wal-segsize\u201d \u66f4\u6539\uff0c\u7f16\u8bd1\u540e\u4e0d\u80fd\u4fee\u6539\u3002     3 \u5982\u679c\u8bbe\u7f6e archive_timeout\uff0c \u8d85\u65f6\u89e6\u53d1\u3002   </p>"},{"location":"postgres/maintenance/archive/#_5","title":"\u5f52\u6863\u5907\u4efd\u8bf4\u660e\uff1a","text":"<p>\u5728\u6570\u636e\u5e93data\u76ee\u5f55\u7684pg_wal\u6587\u4ef6\u5939\u4e2d\u5b58\u653e\u7740\u6211\u4eec\u9700\u8981\u5907\u4efd\u7684wal\u6587\u4ef6\uff0c \u5176\u4e2d archive_status\u6587\u4ef6\u5939\u91cc\u9762\u5b58\u653e\u7684\u662f\u72b6\u6001\u6587\u4ef6\uff0c\u53ef\u4ee5\u5f52\u6863\u7684\u6807\u8bb0\u4e3aready\uff0c\u5f52\u6863\u540e\u4e3adone</p>"},{"location":"postgres/maintenance/archive/#_6","title":"\u7b80\u5355\u5c1d\u8bd5","text":"<p>\u521b\u5efa\u5907\u4efd\u5b58\u50a8\u76ee\u5f55</p> <pre><code>mkdir /mnt/backup/\nchown postgres:postgres /mnt/backup/\nchmod 0700 /mnt/backup/\n</code></pre> <p>\u914d\u7f6e\u6570\u636e\u5e93</p> <pre><code>wal_level='replica'\narchive_mode = on\narchive_command = 'test ! -f /mnt/backup/%f &amp;&amp; cp %p /mnt/backup/%f'\n</code></pre> <p>\u91cd\u542f\u6216reload \u4f7f\u914d\u7f6e\u751f\u6548</p> <p>\u624b\u52a8\u89e6\u53d1,\u67e5\u770b\u7ed3\u679c  select pg_switch_wal(); </p> <p>\u5982\u679c\u9047\u5230\u95ee\u9898\u7ed3\u5408\u67e5\u770b\u6570\u636e\u5e93\u65e5\u5fd7</p> <p>\u67e5\u770b\u5f52\u6863\u72b6\u6001</p> <pre><code>postgres=# select * from pg_stat_archiver ;  \n archived_count |    last_archived_wal     |      last_archived_time       | failed_count |     last_failed_wal      |       last_failed_time        |         stats_reset          \n----------------+--------------------------+-------------------------------+--------------+--------------------------+-------------------------------+------------------------------\n             64 | 00000001000000C3000000A6 | 2019-03-15 09:23:46.991612+08 |           27 | 00000001000000C30000006B | 2019-03-14 14:05:04.921754+08 | 2019-03-07 10:08:45.58083+08\n</code></pre>"},{"location":"postgres/maintenance/archive/#_7","title":"\u5b9e\u9645\u5e94\u7528","text":"<p>\u76ee\u6807\uff1a\u6309\u65e5\u671f\u5b58\u653ewal\u65e5\u5fd7\u5230/mnt/archdir/</p> <p>\u5f52\u6863\u811a\u672c</p> <pre><code>vi archive.sh     \n#!/bin/bash    \n\nexport LANG=en_US.utf8    \nexport DATE=`date +\"%Y%m%d\"`    \n\nBASEDIR=\"/mnt/archdir\"    \n\nif [ ! -d $BASEDIR/$DATE ]; then    \n  mkdir -p $BASEDIR/$DATE    \n  if [ ! -d $BASEDIR/$DATE ]; then    \n    echo \"error mkdir -p $BASEDIR/$DATE\"    \n    exit 1    \n  fi    \nfi    \n\ncp $1 $BASEDIR/$DATE/$2    \nif [ $? -eq 0 ]; then    \n  exit 0    \nelse    \n  echo -e \"cp $1 $BASEDIR/$DATE/$2 error\"    \n  exit 1    \nfi    \n\necho -e \"backup failed\"    \nexit 1    \n</code></pre> <p>\u6743\u9650</p> <pre><code>chmod 700 archive.sh  \n</code></pre> <p>\u914d\u7f6e\u8c03\u7528\u547d\u4ee4</p> <pre><code>archive_command = 'archive.sh %p %f'  \n</code></pre> <p>\u91cd\u65b0\u52a0\u8f7d\u751f\u6548</p> <pre><code>systemctl reload postgresql-10\n</code></pre>"},{"location":"postgres/maintenance/archive/#_8","title":"\u6269\u5c55\u9605\u8bfb","text":"<p>\u5982\u4f55\u5220\u9664wal\u6587\u4ef6</p> <pre><code>#\u5207\u6362\u5230\u6570\u636e\u5b58\u653e\u76ee\u5f55\ncd /var/lib/pgsql/10/data/\n#\u67e5\u770b\u6570\u636e\u5e93\u5f53\u524d\u72b6\u6001\n/usr/pgsql-10/bin/pg_controldata .\n#\u6839\u636e\u5f53\u524d\u72b6\u6001\u5220\u9664\u65e0\u7528wal\n/usr/pgsql-10/bin/pg_archivecleanup -d pg_wal/ 00000001000000C30000006D\n</code></pre>"},{"location":"postgres/maintenance/compile_kylin/","title":"kylin\u7cfb\u7edfpostgresql\u7f16\u8bd1\u5b89\u88c5","text":""},{"location":"postgres/maintenance/compile_kylin/#_1","title":"\u80cc\u666f","text":"<p>\u9e92\u9e9f\u7cfb\u7edf\u9ed8\u8ba4\u81ea\u5e26postgresql10.5</p> <p>\u5b89\u88c5\u8fc7\u7a0b\u4e0ecentos\u57fa\u672c\u76f8\u540c ,</p> <p>\u6ce8\u610f\u4e8b\u9879 </p> <p>1 \u5b89\u88c5postgresql-dev </p> <p>2 \u7f16\u8bd1 postgis \u65f6./configure --with-pgconfig=/usr/bin/pg_config </p> <p>\u4f46\u662f\u5982\u679c\u60f3\u5b89\u88c5\u5176\u4ed6\u7248\u672c\u7684postgres \u9700\u4e00\u756a\u5468\u6298</p> <p>\u9996\u5148\u7b2c\u4e00\u4e2a\u95ee\u9898\u9e92\u9e9f\u7cfb\u7edf\u5bf9openssl\u8fc7\u8fdb\u884c\u6539\u9020\u3002\u5728\u7f16\u8bd1postgres\u652f\u6301ssl\u65f6\u4e0d\u80fd\u901a\u8fc7\u3002</p> <p>\u5176\u6b21\u5b89\u88c5postgres\u5176\u4ed6\u62d3\u5c55\u4e5f\u9700\u8981\u89e3\u51b3\u597d\u5404\u4e2a\u5b89\u88c5\u5305\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u7f16\u8bd1\u7684\u8fc7\u7a0b\u4e5f\u6bd4\u8f83\u6f2b\u957f\u3002</p>"},{"location":"postgres/maintenance/compile_kylin/#v10postgresql125","title":"\u94f6\u6cb3\u9e92\u9e9fV10\u7f16\u8bd1\u5b89\u88c5postgresql12.5","text":""},{"location":"postgres/maintenance/compile_kylin/#openssl","title":"\u5b89\u88c5openssl","text":"<p>\u9e92\u9e9fv10 \u7248\u64cd\u4f5c\u7cfb\u7edfopenssl \u88ab\u6307\u5b9a\u4e49\u5b89\u88c5\u5728\u5185\u6838\u4e2d\u3002\u5728\u5b89\u88c5postgresql\u65f6\u652f\u6301openssl\u7f16\u8bd1\u4e0d\u80fd\u901a\u8fc7\u3002</p> <p>\u89e3\u51b3\u601d\u8def\uff0c\u72ec\u7acb\u5b89\u88c5openssl,postgres\u5bf9ssl \u7684\u4f9d\u8d56\u6307\u5411\u72ec\u7acb\u5b89\u88c5\u7684openssl</p> <pre><code>\u67e5\u770b\u539f\u6709\u7248\u672c\nopenssl version\n\n\u4e0b\u8f7d\u5e76\u5b89\u88c5\u5bf9\u5e94\u7248\u672c\u7684openssl\nwget https://www.openssl.org/source/openssl-1.1.1d.tar.gz\ntar -zxf openssl-1.1.1d.tar.gz \ncd openssl-1.1.1d/\n./config --prefix=/usr/local/openssl no-zlib \n</code></pre>"},{"location":"postgres/maintenance/compile_kylin/#_2","title":"\u4f9d\u8d56\u5305\u5b89\u88c5","text":"<pre><code>yum install openldap-devel\nyum install systemd-devel -y\n\n</code></pre>"},{"location":"postgres/maintenance/compile_kylin/#postgres","title":"\u5b89\u88c5postgres","text":"<pre><code>tar -zxf postgresql-12.5.tar.gz \n\n\u6307\u5b9aopenssl \u8def\u5f84\n./configure --with-openssl --with-includes=/usr/local/openssl/include/openssl --with-libraries=/usr/local/openssl/lib/ --with-systemd\n\n./configure '--enable-rpath' '--prefix=/usr/pgsql-12' '--includedir=/usr/pgsql-12/include' '--libdir=/usr/pgsql-12/lib' '--mandir=/usr/pgsql-12/share/man' '--datadir=/usr/pgsql-12/share' '--with-icu' '--with-llvm' '--with-perl' '--with-python' '--with-tcl' '--with-tclconfig=/usr/lib64' '--with-openssl' '--with-pam' '--with-gssapi' '--with-includes=/usr/include:/usr/local/openssl/include/openssl' '--with-libraries=/usr/lib64:/usr/local/openssl/lib' '--enable-nls' '--enable-dtrace' '--with-uuid=e2fs' '--with-libxml' '--with-libxslt' '--with-ldap' '--with-selinux' '--with-systemd' '--with-system-tzdata=/usr/share/zoneinfo' '--sysconfdir=/etc/sysconfig/pgsql' '--docdir=/usr/pgsql-12/doc' '--htmldir=/usr/pgsql-12/doc/html' 'CFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic' 'LDFLAGS=-Wl,--as-needed' 'LLVM_CONFIG=/usr/lib64/llvm5.0/bin/llvm-config' 'CLANG=/opt/rh/llvm-toolset-7/root/usr/bin/clang' 'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig' 'PYTHON=/usr/bin/python2'\n\n./configure '--enable-rpath' '--prefix=/usr/pgsql-12' '--includedir=/usr/pgsql-12/include' '--libdir=/usr/pgsql-12/lib' '--mandir=/usr/pgsql-12/share/man' '--datadir=/usr/pgsql-12/share'  '--with-perl' '--with-python' '--with-openssl' '--with-pam' '--with-gssapi' '--with-includes=/usr/include:/usr/local/openssl/include/openssl' '--with-libraries=/usr/lib64:/usr/local/openssl/lib' '--enable-nls' '--enable-dtrace' '--with-uuid=e2fs' '--with-ldap' '--with-selinux' '--with-systemd' '--with-system-tzdata=/usr/share/zoneinfo' \n</code></pre>"},{"location":"postgres/maintenance/compile_kylin/#postgis","title":"\u5b89\u88c5postgis","text":"<pre><code>http://postgis.net/source/  \n\nYou will also need to install and/or build GEOS, Proj, GDAL, LibXML2 and JSON-C.\n</code></pre> <p>yum install libxml2 libxml2-devel.aarch64  yum install proj-devel yum install sqlite yum install sqlite-devel.aarch64  -y yum install curl-devel</p> <p>make proj-6</p> <p>yum erase proj # \u5c06\u539f\u6765\u7cfb\u7edf\u81ea\u5e26\u7684\u5220\u9664</p> <pre><code>\n</code></pre> <p>gdal-3.1.4</p> <pre><code>wget http://download.osgeo.org/geos/geos-3.8.1.tar.bz2\ntar -jxf geos-3.8.1.tar.bz2\ncd geos-3.8.1\nmake\nmake install\n</code></pre> <p>wget https://download.osgeo.org/postgis/source/postgis-3.0.2.tar.gz</p> <p>./configure --with-pgconfig=/usr/pgsql-12/bin/pg_config --with-geosconfig=/usr/local/bin/geos-config</p> <pre><code>-------------- Dependencies -------------- \n  GEOS config:          /usr/local/bin/geos-config\n  GEOS version:         3.8.1\n  GDAL config:          /usr/local/bin/gdal-config\n  GDAL version:         3.1.4\n  PostgreSQL config:    /usr/pgsql-12/bin/pg_config\n  PostgreSQL version:   PostgreSQL 12.5\n  PROJ4 version:        63\n  Libxml2 config:       /usr/bin/xml2-config\n  Libxml2 version:      2.9.8\n  JSON-C support:       no\n  protobuf support:     no\n  PCRE support:         yes\n  Perl:                 /usr/bin/perl\n  Wagyu:                no\n\n</code></pre> <p>\u95ee\u9898</p> <pre><code>ldd /usr/pgsql-12/lib/postgis-3.so\n    linux-vdso.so.1 (0x0000fffdf6fa0000)\n    libgeos_c.so.1 =&gt; not found\n    libproj.so.15 =&gt; not found\n    libxml2.so.2 =&gt; /lib64/libxml2.so.2 (0x0000fffdf6cc0000)\n    libz.so.1 =&gt; /lib64/libz.so.1 (0x0000fffdf6c80000)\n    liblzma.so.5 =&gt; /lib64/liblzma.so.5 (0x0000fffdf6c30000)\n    libm.so.6 =&gt; /lib64/libm.so.6 (0x0000fffdf6b60000)\n    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x0000fffdf6b30000)\n    libc.so.6 =&gt; /lib64/libc.so.6 (0x0000fffdf69a0000)\n    /lib/ld-linux-aarch64.so.1 (0x0000fffdf6fb0000)\n    libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x0000fffdf6960000)\n</code></pre> <p>\u89e3\u51b3</p> <pre><code>#\u65b0\u5efa\u6587\u4ef6\nvi /etc/ld.so.conf.d/postgis.conf\n#\u6dfb\u52a0\n/usr/local/lib\n\u751f\u6548\nldconfig \n</code></pre> <p>\u67e5\u770b</p> <pre><code>ldd /usr/pgsql-12/lib/postgis-3.so\n    linux-vdso.so.1 (0x0000fffdd96a0000)\n    libgeos_c.so.1 =&gt; /usr/local/lib/libgeos_c.so.1 (0x0000fffdd94f0000)\n    libproj.so.15 =&gt; /usr/local/lib/libproj.so.15 (0x0000fffdd9230000)\n    libxml2.so.2 =&gt; /lib64/libxml2.so.2 (0x0000fffdd90a0000)\n    libz.so.1 =&gt; /lib64/libz.so.1 (0x0000fffdd9060000)\n    liblzma.so.5 =&gt; /lib64/liblzma.so.5 (0x0000fffdd9010000)\n    libm.so.6 =&gt; /lib64/libm.so.6 (0x0000fffdd8f40000)\n    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x0000fffdd8f10000)\n    libc.so.6 =&gt; /lib64/libc.so.6 (0x0000fffdd8d80000)\n    libgeos-3.8.1.so =&gt; /usr/local/lib/libgeos-3.8.1.so (0x0000fffdd8b90000)\n    libstdc++.so.6 =&gt; /lib64/libstdc++.so.6 (0x0000fffdd89e0000)\n    libgcc_s.so.1 =&gt; /lib64/libgcc_s.so.1 (0x0000fffdd89a0000)\n    libsqlite3.so.0 =&gt; /lib64/libsqlite3.so.0 (0x0000fffdd8870000)\n    libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x0000fffdd8830000)\n    /lib/ld-linux-aarch64.so.1 (0x0000fffdd96b0000)\n</code></pre>"},{"location":"postgres/maintenance/compile_kylin/#pipelinedb","title":"pipelinedb","text":"<p>\u7f16\u8bd1\u5b89\u88c5zeromq</p> <pre><code>#!/bin/bash                                                                       \n\n\n      # pkg-config may not be necessary to install on all systems  \n      sudo apt-get install -y wget libtool autoconf automake pkg-config  \n\n\n      wget https://github.com/zeromq/libzmq/releases/download/v4.2.5/zeromq-4.2.5.tar.gz &amp;&amp; \\  \n          tar -xvf zeromq-4.2.5.tar.gz &amp;&amp; \\  \n          cd zeromq-4.2.5/ &amp;&amp; \\  \n          ./autogen.sh &amp;&amp; \\  \n          ./configure CPPFLAGS=-DPIC CFLAGS=-fPIC CXXFLAGS=-fPIC LDFLAGS=-fPIC --prefix=/usr &amp;&amp; \\  \n          make &amp;&amp; \\  \n          make install\n</code></pre>"},{"location":"postgres/maintenance/log/","title":"\u6570\u636e\u5e93\u65e5\u5fd7","text":""},{"location":"postgres/maintenance/log/#_1","title":"\u4ecb\u7ecd","text":"<p>PostgreSQL\u67093\u79cd\u65e5\u5fd7\uff0c\u5206\u522b\u662fpg_log\uff08\u6570\u636e\u5e93\u8fd0\u884c\u65e5\u5fd7\uff09\u3001pg_xlog\uff08WAL \u65e5\u5fd7\uff0c\u5373\u91cd\u505a\u65e5\u5fd7\uff09\u3001pg_clog\uff08\u4e8b\u52a1\u63d0\u4ea4\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u4e8b\u52a1\u7684\u5143\u6570\u636e\uff09 postgres 10 \u7248\u672c\u5c06\u6587\u4ef6\u76ee\u5f55\u7ed3\u6784\u6539\u4e3a log\uff0cpg_wal\uff0cpg_xact log\u9ed8\u8ba4\u662f\u5173\u95ed\u7684\uff0c\u9700\u8981\u8bbe\u7f6e\u5176\u53c2\u6570\u3002wal\u548cxact\u90fd\u662f\u5f3a\u5236\u6253\u5f00\u7684\uff0c\u65e0\u6cd5\u5173\u95ed\u3002 \u672c\u6587\u4e3b\u8981\u4ecb\u7ecd\u3000log \u80fd</p>"},{"location":"postgres/maintenance/log/#_2","title":"\u914d\u7f6e","text":"<p>\u8bed\u6cd5:   \u4fee\u6539\u3000ALTER SYSTEM SET \u53c2\u6570=\u503c;   \u67e5\u770b\u3000show \u53c2\u6570; \u91cd\u65b0\u542f\u52a8\u6570\u636e\u5e93\u751f\u6548;  </p> <p>\u542f\u7528pg_log\u5e76\u914d\u7f6e\u65e5\u5fd7\u53c2\u6570</p> <pre><code>ALTER SYSTEM SET\n log_destination = 'csvlog';\nALTER SYSTEM SET\n logging_collector = on;\nALTER SYSTEM SET\n log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log';\nALTER SYSTEM SET\n log_rotation_age = '1d';\nALTER SYSTEM SET\n log_rotation_size = '100MB';\nALTER SYSTEM SET\n log_min_messages = 'info';\n</code></pre> <p>\u8bb0\u5f55\u65e5\u5fd7\u4fe1\u606f</p> <pre><code>ALTER SYSTEM SET\n log_checkpoints = on;\nALTER SYSTEM SET\n log_connections = on;\nALTER SYSTEM SET\n log_disconnections = on;\nALTER SYSTEM SET\n log_duration = on;\nALTER SYSTEM SET\n log_line_prefix = '%m';\n</code></pre>"},{"location":"postgres/maintenance/log/#sql","title":"\u8bb0\u5f55\u6267\u884c\u6162\u7684SQL","text":"<p>\u8bb0\u5f55\u8d85\u8fc7\u8be5\u65f6\u957f\u7684\u6240\u6709SQL\uff0c\u5bf9\u627e\u51fa\u5f53\u524d\u6570\u636e\u5e93\u7684\u6162\u67e5\u8be2\u5f88\u6709\u6548\u3002\u65f6\u95f4\u5355\u4f4dms</p> <p>\u5168\u5c40\u7ea7</p> <pre><code>ALTER SYSTEM SET\n log_min_duration_statement = 60;\n</code></pre> <p>\u6570\u636e\u5e93\u7ea7</p> <pre><code>ALTER DATABASE test SET log_min_duration_statement TO 60;\n</code></pre> <p>\u6d4b\u8bd5</p> <pre><code>postgres=# select now(), pg_sleep(66);\n</code></pre>"},{"location":"postgres/maintenance/log/#_3","title":"\u76d1\u63a7\u6570\u636e\u5e93\u4e2d\u957f\u65f6\u95f4\u7684\u9501","text":"<p>\u6570\u636e\u5e93\u7684\u9501\u901a\u5e38\u53ef\u4ee5\u5728pg_locks\u8fd9\u4e2a\u7cfb\u7edf\u8868\u91cc\u627e\uff0c\u4f46\u8fd9\u53ea\u662f\u5f53\u524d\u7684\u9501\u8868/\u884c\u4fe1\u606f\uff0c\u5982\u679c\u4f60\u60f3\u770b\u4e00\u5929\u5185\u6709\u591a\u5c11\u4e2a\u8d85\u8fc7\u6b7b\u9501\u65f6\u95f4\u7684\u9501\u53d1\u751f\uff0c\u53ef\u4ee5\u5728\u65e5\u5fd7\u91cc\u8bbe\u7f6e\u5e76\u67e5\u770b\uff0clog_lock_waits \u9ed8\u8ba4\u662foff\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u5f00\u542f\u3002\u8fd9\u4e2a\u53ef\u4ee5\u533a\u5206SQL\u6162\u662f\u8d44\u6e90\u7d27\u5f20\u8fd8\u662f\u9501\u7b49\u5f85\u7684\u95ee\u9898\u3002</p> <pre><code>ALTER SYSTEM SET\n log_lock_waits = on;\n</code></pre> <p>\u6d4b\u8bd5</p> <pre><code>postgres=# show log_lock_waits ;\n log_lock_waits \n----------------\n on\n(1 row)\n\npostgres=# show deadlock_timeout ;\n deadlock_timeout \n------------------\n 1s\n(1 row)\n\n--\u6a21\u62df\u9501\npostgres=# begin;\nBEGIN\npostgres=# SELECT * FROM t_ken_yon ;\n id \n----\n 11\n(1 row)\n\npostgres=# delete from t_ken_yon ;\nDELETE 1\n\n--\u53e6\u4e00\u4e2asession\npostgres=# begin;\nBEGIN\npostgres=# delete from t_ken_yon;\n\n</code></pre>"},{"location":"postgres/maintenance/log/#_4","title":"\u5ba1\u8ba1","text":"<p>postgres\u65e5\u5fd7\u91cc\u5206\u6210\u4e863\u7c7b\uff0c\u901a\u8fc7\u53c2\u6570pg_statement\u6765\u63a7\u5236\uff0c</p> <ul> <li>\u9ed8\u8ba4\u7684pg_statement\u53c2\u6570\u503c\u662fnone\uff0c\u5373\u4e0d\u8bb0\u5f55  </li> <li>\u53ef\u4ee5\u8bbe\u7f6eddl(\u8bb0\u5f55create,drop\u548calter)  </li> <li>mod(\u8bb0\u5f55ddl+insert,delete,update\u548ctruncate)\u548call(mod+select)</li> </ul> <pre><code>ALTER SYSTEM SET\n log_statement = 'ddl';\n</code></pre>"},{"location":"postgres/maintenance/log/#_5","title":"\u5c06\u65e5\u5fd7\u5bfc\u5165\u5230\u6570\u636e\u5e93\u8868\u4e2d\u5e76\u8fdb\u884c\u67e5\u8be2\u5206\u6790","text":"<p>\u521b\u5efa\u6570\u636e\u5e93\u8868</p> <pre><code>CREATE TABLE postgres_log\n(\n  log_time timestamp(3) with time zone,\n  user_name text,\n  database_name text,\n  process_id integer,\n  connection_from text,\n  session_id text,\n  session_line_num bigint,\n  command_tag text,\n  session_start_time timestamp with time zone,\n  virtual_transaction_id text,\n  transaction_id bigint,\n  error_severity text,\n  sql_state_code text,\n  message text,\n  detail text,\n  hint text,\n  internal_query text,\n  internal_query_pos integer,\n  context text,\n  query text,\n  query_pos integer,\n  location text,\n  application_name text,\n  PRIMARY KEY (session_id, session_line_num)\n);\n</code></pre> <p>\u5c06\u65e5\u5fd7\u6587\u4ef6\u5bfc\u5165\u6570\u636e\u5e93\u8868\u4e2d</p> <pre><code>COPY postgres_log FROM 'log/postgresql-2018-12-05_103141.csv' WITH csv;\n</code></pre> <p>\u67e5\u8be2\u5206\u6790</p> <p>\u81ea\u7531\u53d1\u6325</p> <p>\u65e5\u5fd7\u5206\u6790\u62a5\u8868 PGBADGER</p> <p>\u62d3\u5c55 pgaudit</p> <p>\u53c2\u8003\u5b66\u4e60</p>"},{"location":"postgres/maintenance/thinking_in_db_fd/","title":"\u6570\u636e\u5e93\u4f18\u5316\u601d\u8003 - \u7ed3\u6784\u8bbe\u8ba1","text":"","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#db-app","title":"DB \u4e0e APP \u7684\u4e0d\u540c","text":"","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_1","title":"\u6709\u65e0\u72b6\u6001","text":"<p>\u65e0\u72b6\u6001\u5e94\u7528\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u63d0\u4f9b\u7684\u670d\u52a1\u90fd\u662f\u7b49\u4ef7\u3001\u5bf9\u7b49\u7684\u3002APP \u5e94\u7528\u4e3a\u65e0\u72b6\u6001\u5e94\u7528\uff0cDB\u5e94\u7528\u4e3a\u6709\u72b6\u6001\u5e94\u7528\u3002</p> <p>\u6570\u636e\u5e93\u6b63\u662f\u56e0\u4e3a\u6709\u72b6\u6001\uff0c\u6240\u4ee5\u7ef4\u62a4\u8d77\u6765\u66f4\u6709\u6311\u6218\u3002</p> <p>APP \u5728\u9762\u5bf9\u5927\u91cf\u9ad8\u5e76\u53d1\u8bf7\u6c42\u65f6\u53ef\u4ee5\u65e0\u6240\u987e\u53ca\u7684\u589e\u52a0\u5b9e\u4f8b\uff0c\u52a0\u673a\u5668\u8fdb\u884c\u6269\u5bb9\u3002\u5904\u7406\u80fd\u91cc\u4e5f\u4f1a\u5c06\u5f97\u5230\u7ebf\u6027\u63d0\u5347\u3002\u7b80\u5355\u7c97\u66b4\u53c8\u6709\u6548\u3002</p> <p>DB \u9762\u5bf9\u540c\u6837\u7684\u538b\u529b\u6311\u6218\u65f6\u6b63\u56e0\u4e3a\u5176\u6709\u72b6\u6001\uff0c\u6269\u5bb9\u8d77\u6765\u5c31\u6ca1\u6709\u90a3\u4e48\u4ece\u5bb9\u3002\u56e0\u4e3a\u5f53\u524d\u7684\u8bf7\u6c42\u643a\u5e26\u7684\u4fe1\u606f\u9700\u8981\u4e0e\u5df2\u6709\u7684\u6570\u636e\u8fdb\u884c\u878d\u5408\u7d2f\u79ef\u3002</p> <p>\u72b6\u6001\u4e0d\u4ec5\u8981\u8003\u8651\u5f53\u524d\u72b6\u6001\uff0c\u8fd8\u9700\u8981\u8003\u8651\u5386\u53f2\u72b6\u6001\u3002\u56e0\u4e3a\u6570\u636e\u662f\u7d2f\u79ef\u7684\u3002</p> <ul> <li>\u5f53\u524d\u72b6\u6001</li> <li>\u5386\u53f2\u72b6\u6001</li> </ul> <p>\u5982\u4ea4\u6613\u8ba2\u5355\uff0c\u5f53\u524d\u8ba2\u5355\u4fe1\u606f\uff0c\u7d2f\u79ef\u8d26\u5355\u4fe1\u606f</p> <p>\u540c\u6837\u9762\u4e34\u7684\u6311\u6218\u8fd8\u6709\u6bd4\u5982\u9ad8\u53ef\u7528\uff08\u5f53\u524d\u72b6\u6001\uff09\uff0c\u8fc1\u79fb\uff08\u5386\u53f2\u72b6\u6001\uff09\u3002\u5728\u7ebf\u6269\u5bb9\u3001\u4e0d\u505c\u673a\u8fc1\u79fb\uff0c\u5347\u7ea7,\u7ef4\u62a4\uff08\u5f53\u524d\u72b6\u6001+\u5386\u53f2\u72b6\u6001\uff09\u3002 </p> <p>\u6bd4\u5982\u7535\u8111\u65b0\u88c5\u7cfb\u7edf\u3001\u65b0\u8d2d\u7f6e\u624b\u673a\uff0c\u6709\u4e00\u4e2a\u987e\u8651\u5c31\u662f\u91cc\u9762\u7684\u6570\u636e\u9700\u8981\u62f7\u8d1d\u5230\u65b0\u7cfb\u7edf\u91cc\u3002\u642c\u5bb6\u5934\u75bc\u7684\u4e5f\u662f\u4e1c\u897f\u592a\u591a\u4e86\u3002</p> <p>\u7efc\u4e0a\u6240\u8ff0\uff0c\u7531\u4e8eDB\u5e94\u7528\u5177\u6709\u5f53\u524d\u72b6\u6001\u3001\u5386\u53f2\u72b6\u6001\u5c5e\u6027\uff0cDB\u5728\u9ad8\u538b\u4e0b\u9762\u4e34\u7684\u771f\u6b63\u6311\u6218\uff0c</p> <p>\u53ef\u5f52\u7ed3\u4e3a\u541e\u5410\u91cf\uff08QPS\uff09\u6311\u6218\uff0c\u5b58\u50a8\u91cf\uff08SIZE\uff09\u6311\u6218\u3002</p> <p>\u8ba4\u6e05DB\u771f\u6b63\u9762\u5bf9\u7684\u6311\u6218 QPS\uff08QPS+TPS\uff09 +  SIZE (\u5386\u53f2\u7d2f\u79ef + \u589e\u957f\u901f\u5ea6)\u3002\u8981\u7f13\u89e3\u6570\u636e\u5e93\u538b\u529b\uff0c\u4e0b\u9762\u5c06\u4eceqps\u3001size\u4e24\u4e2a\u65b9\u9762\u6765\u8fdb\u4e00\u6b65\u601d\u8003\u89e3\u51b3\u4e4b\u9053\u3002</p> <p>\u8fdb\u4e00\u6b65\u601d\u8003\uff0cQPS \u4e0e SIZE \u4e4b\u95f4\u4ea6\u76f8\u4e92\u5f71\u54cd\u3002</p> <p>tps \u52a0\u901fSIZE \u589e\u957f</p> <p>SIZE \u589e\u5927QPS\u4e0b\u964d </p> <p>\u53d6\u820d\u7b56\u7565\uff1a \u65f6\u95f4\u6362\u7a7a\u95f4\uff0c\u7a7a\u95f4\u6362\u65f6\u95f4\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#master","title":"\u591aMaster\u65b9\u6848","text":"<p>\u591amaster\uff0c\u5373\u53ef\u591a\u5199\u3002\u80fd\u591f\u89e3\u51b3\u4ee5\u4e0a\u4e24\u4e2a\u95ee\u9898\u5417\uff1f</p> <p>tps \u8868\u9762\u6765\u770b\u5c06\u5199\u7684\u538b\u529b\u5206\u6563\u5230\u591a\u4e2a\u5b9e\u4f8b\u6765\u5904\u7406\uff0c\u5206\u62c5\u4e86\u603b\u4f53\u538b\u529b\u3002\u4f46\u662f\u8981\u4fdd\u6301\u591a\u4e2a\u5b9e\u4f8b\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u5f3a\u4e00\u81f4\u6027\u4e0b\u591a\u4e2a\u5b9e\u4f8b\u90fd\u8981\u5904\u7406\u5b8c\u6210\u624d\u8fd4\u56de\u7ed3\u679c\u3002</p> <p>tps\u7684\u89d2\u5ea6\u6765\u5206\u6790\uff0c\u5355\u4e2a\u5b9e\u4f8b\u7684\u5904\u7406\u91cf\u5e76\u6ca1\u6709\u51cf\u5c11\uff0c\u53cd\u800c\u53ef\u80fd\u4ea7\u751f\u76f8\u4e92\u7b49\u5f85\u3002\u5373\u4f7f\u662f\u6700\u7ec8\u4e00\u81f4\u6027\uff0ctps\u603b\u91cf\u4e5f\u6ca1\u6709\u6ca1\u51cf\u5c11\u3002</p> <p>\u53ef\u4ee5\u964d\u4f4e\u7684\u662f\u5355\u673a\u6240\u627f\u62c5\u7684qps\u3002</p> <p>\u53ef\u80fd\u591a\u4e2a\u5b9e\u4f8b\u4e4b\u95f4\u7531\u534f\u8bae\u6765\u5b8c\u6210\u5b9e\u4f8b\u95f4\u7684\u6570\u636e\u540c\u6b65\uff0c\u4f46\u662f\u5bf9tps\u6027\u80fd\u6765\u8bf4\u5f71\u54cd\u4e5f\u662f\u8d1f\u9762\u7684\u3002\u5bf9size\u6765\u8bf4\u4e5f\u6ca1\u5e26\u6765\u597d\u5904\u3002</p> <p>\u591amaster\u5e26\u6765\u7684\u4f18\u52bf\u66f4\u591a\u7684\u662f\u9ad8\u53ef\u7528\uff0c\u6216\u7c7b\u4f3cCDN\u591a\u673a\u623f\u672c\u5730\u4f18\u5148\u5904\u7406\u3002</p> <p>\u603b\u7ed3\uff1a \u591amaster\u65b9\u6848 \u5728tps\u548csize \u4e24\u4e2a\u65b9\u9762\u90fd\u4e0d\u80fd\u505a\u5230\u7f13\u89e3\u670d\u52a1\u538b\u529b\u7684\u4f5c\u7528</p> <p>\u4f2a\u547d\u9898\u3002\u968f\u7740\u673a\u5668\u589e\u52a0\u590d\u6742\u96be\u5ea6\u6307\u6570\u4e0a\u5347\u3002mysql \u6700\u65b08.0 \u591amaster\u65b9\u6848\u5b98\u65b9\u4e0d\u5efa\u8bae\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\u3002</p> <p>\u73b0\u6709\u65b9\u6848\uff1a bucardo \u540c\u6b65\u901a\u8fc7\u89e6\u53d1\u5668\u6765\u8bb0\u5f55\u53d8\u5316 \u3001 \u81ea\u8eab\u903b\u8f91\u590d\u5236\u3002</p> <p>\u6ce8\u610f\u95ee\u9898\uff0c\u591a\u5199\u9020\u6210\u591a\u5b9e\u4f8b\u4e4b\u95f4\u7684\u5199\u5faa\u73af\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_2","title":"\u8bfb\u5199\u5206\u79bb","text":"<p>\u8bfb\u5199\u5206\u79bb\u7684\u6838\u5fc3\u662f\u5c06\u8bfb\u8bf7\u6c42\u4e0e\u5199\u8bf7\u6c42\u5206\u5f00\u6765\u5904\u7406\uff0c\u8bf7\u6c42=qps+tps\u3002master\u53ea\u5904\u7406\u5199\u8bf7\u6c42\uff0c\u7531slave\u6765\u5904\u7406\u8bfb\u8bf7\u6c42\u3002</p> <p>\u901a\u5e38\u5728\u73b0\u5b9e\u7684TP\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u8bfb\u8bf7\u6c42\u5f80\u5f80\u662f\u5199\u8bf7\u6c42\u7684\u6570\u500d\u6216\u6570\u5341\u500d\u3002\u8fd9\u6837\u901a\u8fc7\u4e00\u4e3b\u591a\u4ece\u7684\u65b9\u5f0f\u53ef\u4ee5\u975e\u5e38\u6709\u6548\u7684\u5c06\u8bf7\u6c42\u5206\u6563\u5230\u591a\u4e2a\u5b9e\u4f8b\uff0c\u589e\u52a0\u4ece\u5e93\u4e5f\u6bd4\u8f83\u5bb9\u6613\u5b9e\u73b0\u3002</p> <p>\u5c06\u6570\u636e\u5e93\u7684\u8bfb\u8bf7\u6c42\u5206\u79bb\u5f00\u6765\u5bf9\u5199\u7684\u5f71\u54cd\u4e5f\u4f1a\u4ea7\u751f\u79ef\u6781\u7684\u4f5c\u7528\uff0c\u56e0\u4e3a\u8bfb\u5199\u90fd\u4f1a\u5360\u6709IO\u8d44\u6e90\uff0cCPU\u8d44\u6e90\u3002\u5c06\u8bfb\u8bf7\u6c42\u5206\u5230\u5176\u4ed6\u5b9e\u4f8b\uff0c\u8d44\u6e90\u5b8c\u5168\u4ea4\u7ed9\u5199\u5904\u7406\uff0c\u5199\u7684\u6027\u80fd\u8fdb\u800c\u4f1a\u5f97\u5230\u6781\u5927\u7684\u63d0\u5347\u3002</p> <p>\u603b\u7ed3\uff1a \u8bfb\u5199\u5206\u79bb\u89e3\u51b3\u7684\u662f\u5e76\u53d1\u8bf7\u6c42\u91cfqps\uff0c\u5bf9SIZE\u65b9\u9762\u7684\u95ee\u9898\u6ca1\u6709\u5f97\u5230\u89e3\u51b3</p> <p>\u73b0\u6709\u65b9\u6848\uff1a \u6570\u636e\u5e93\u6d41\u590d\u5236\uff0c\u5e94\u7528\u5c42\u901a\u5e38\u6846\u67b6\u81ea\u5e26\u8bfb\u5199\u8def\u7531\u529f\u80fd\u3002 \u5982jdbc\u4e0d\u4ec5\u6709\u8def\u7531\u529f\u80fd\uff0c\u8fd8\u53ef\u4ee5\u81ea\u52a8\u8bc6\u522b\u4e3b\u4ece</p> <p>\u6ce8\u610f\u95ee\u9898\uff1a \u4e3b\u4ece\u4e4b\u95f4\u7684\u540c\u6b65\uff0c\u5ef6\u8fdf\u95ee\u9898\u3002\u4ece\u5e93\u5bf9\u957f\u4e8b\u52a1\u5bf9\u4e3b\u5e93gc\u5f71\u54cd\uff0c\u4e3b\u5e93wal\u65e5\u5fd7\u4fdd\u7559\u7b56\u7565\u7b49\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_3","title":"\u4e1a\u52a1\u5265\u79bb","text":"<p>DB \u7684\u6838\u5fc3\u4e1a\u52a1\u80fd\u529b\u662fACID\u5904\u7406\u3002\u901a\u8fc7\u524d\u9762APP\u4e0eDB\u7684\u5bf9\u6bd4\u53ef\u77e5\uff0cDB\u7684\u7ef4\u62a4\u6210\u672c\uff0c\u590d\u6742\u7a0b\u5ea6\u901a\u5e38\u8981\u9ad8\u4e8e\u5176\u4ed6\u5e94\u7528\u3002\u5982\u679c\u4e1a\u52a1\u7684\u9700\u8981\u6ca1\u6709ACID\u8981\u6c42\u5c3d\u91cf\u4e0d\u4f7f\u7528DB\u6765\u5904\u7406\uff0c\u505a\u5230\u4e14\u7528\u4e14\u73cd\u60dc\uff01</p> <ul> <li>\u65e5\u5fd7\u7c7b \u6ca1\u6709\u4e8b\u52a1\u8981\u6c42</li> <li>\u4e34\u65f6\u72b6\u6001\u7c7b \u6ca1\u6709\u6301\u4e45\u6027\u8981\u6c42\uff08ttl\uff09</li> <li>\u9891\u7e41\u66f4\u65b0 \u7c7b\u4f3c\u4e34\u65f6\u72b6\u6001</li> <li>\u8ba1\u7b97\u7c7b \u601d\u8003\u95ee\u9898\u4e0d\u8981\u7528\u811a\uff0capp\u6bd4\u6570\u636e\u5e93\u66f4\u7075\u6d3b\u66f4\u9ad8\u6548</li> <li>\u7ea6\u675f\u7c7b \u6570\u636e\u5e93\u63d0\u4f9b\u7ea6\u675f\u529f\u80fd\uff0c\u4f46\u662f\u53ea\u4f5c\u4e3a\u515c\u5e95\u4fdd\u969c\uff0c\u5916\u952e\u662f\u4e00\u5b9a\u8981\u53bb\u6389\u7684\u3002\u9a8c\u8bc1\u5c3d\u529b\u9760\u524d\uff0c\u5982\u5728\u524d\u7aef\u9875\u9762\u9a8c\u8bc1\u4f18\u4e8eapp\u9a8c\u8bc1\u4f18\u4e8eDB\u9a8c\u8bc1\u3002</li> </ul> <p>\u603b\u7ed3: \u5c06\u975e\u5fc5\u8981\u4e1a\u52a1\u4e0d\u7531DB\u6765\u5904\u7406\u662f\u6700\u7b80\u5355\u6709\u6548\u7684\uff0c\u65e0\u8bba\u662fqps\u8fd8\u662fsize</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_4","title":"\u4e2d\u95f4\u5c42\u4ee3\u7406","text":"<p>\u6709\u7684\u4e1a\u52a1\u5fc5\u987b\u8981\u843d\u76d8\u5230DB\uff0c\u4f46\u662f\u53c8\u5b58\u5728\u5176\u7279\u6b8a\u6027\u3002</p> <p>\u8bfb\u7279\u522b\u9891\u7e41\uff0c\u5199\u4e0d\u662f\u5f88\u5927\u3002\u53ef\u91c7\u7528\u9884\u52a0\u8f7d\uff0c\u7f13\u5b58\u7b49\u5c06\u8bfb\u8bf7\u6c42\u62e6\u622a\u5728DB\u524d\u3002\u56e0\u4e3a\u8fd9\u79cd\u7f13\u5b58\u7c7b\u4e2d\u95f4\u4ef6\u7684\u6027\u80fd\u5f80\u5f80\u8981\u9ad8\u4e8eDB\u6570\u4e2a\u7b49\u7ea7\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\u9891\u7e41IO\uff0c\u4e0d\u9700\u8981\u8003\u8651\u4e8b\u52a1\uff0c\u9501\u7b49\u3002 </p> <p>\u5bf9\u6570\u636e\u5b9e\u65f6\u53ef\u9760\u6027\u8981\u6c42\u4e0d\u9ad8\u7684\u5927\u5e76\u53d1\u5199\uff0c\u53ef\u91c7\u7528\u7f13\u5b58\u5408\u5e76\u591a\u6b21\u5199\uff0c\u6700\u7ec8\u4e00\u8d77\u843d\u76d8\u3002</p> <p>\u4e1a\u52a1\u5cf0\u8c37\u7279\u5f81\u660e\u663e\uff0c\u5cf0\u65f6\u5b9e\u65f6\u8981\u6c42\u53ef\u5ef6\u8fdf\u3002\u901a\u5e38\u4f1a\u8003\u8651\u4f7f\u7528\u961f\u5217\u524a\u5cf0\u586b\u8c37\u3001\u89e3\u8026\u3002\u4e5f\u53ef\u4ee5\u7ed3\u5408\u91c7\u7528\u6d88\u8d39\u7aef\u591a\u6b21\u5199\u5408\u5e76\u7684\u65b9\u5f0f\u8fdb\u4e00\u6b65\u7f13\u89e3\u5199\u8bf7\u6c42\u3002</p> <p>\u603b\u7ed3\uff1a\u66ff\u4ee3\u5927\u90e8\u5206qps\uff0c\u7f13\u89e3tps</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_5","title":"\u591a\u673a\u65b9\u6848","text":"<p>\u6570\u636e\u7684\u62c6\u5206\uff0c\u5c06\u6570\u636e\u5206\u6563\u5230\u591a\u4e2a\u4e3b\u673a\u4e0a\u3002\u964d\u4f4e\u5355\u4e3b\u673a\u627f\u62c5\u7684qps\u3001size</p> <p>\u6570\u636e\u7684\u7ec4\u6210 </p> <ul> <li>\u5355\u5b9e\u4f8b\u591a\u9879\u76ee</li> <li>\u4e00\u4e2a\u9879\u76ee\u591a\u4e2a\u72ec\u7acb\u6a21\u5757</li> <li>\u4e00\u4e2a\u6a21\u5757\u591a\u4e2a\u8868</li> <li>\u5355\u8868\u4e2d\u591a\u5217\u3001\u884c</li> </ul> <p>\u63a5\u4e0b\u6765\u6309\u7167\u6570\u636e\u7684\u7ec4\u6210\u7ed3\u6784\u4ece\u4e0a\u81f3\u4e0b\u5f00\u59cb\u62c6</p> <p>\u5355\u5b9e\u4f8b\u591a\u4e2a\u9879\u76ee\uff0c\u7531\u4e8e\u9879\u76ee\u521d\u671f\u6216\u6570\u636e\u8f7b\u91cf\u7ea7\u9879\u76ee\u3002\u591a\u4e2adatabase\u4f7f\u7528\u4e00\u4e2aDB\u5b9e\u4f8b\u3002\u5f53\u67d0\u4e2a\u9879\u76ee\u6570\u636e\u91cf\u589e\u5230\u53ef\u4ee5\u72ec\u7acb\u62e5\u6709\u4e00\u4e2a\u5b9e\u4f8b\u7684\u65f6\u5019\u5c06\u8fd9\u4e2a\u9879\u76ee\u4ece\u4e2d\u5265\u79bb\u51fa\u6765\uff0c\u4e0e\u5176\u4ed6\u9879\u76ee\u4e0d\u5728\u76f8\u4e92\u6253\u6270\u3002</p> <p>\u591a\u4e2a\u9879\u76ee\u4e4b\u95f4\u8bbf\u95ee\u662f\u901a\u8fc7API\u6765\u5b9e\u73b0\uff0c\u9879\u76ee\u5728\u6570\u636e\u5e93\u5c42\u6ca1\u6709\u76f4\u63a5\u7684\u4f9d\u8d56\u3002\u62c6\u5206\u5f88\u5bb9\u6613</p> <p>\u4e00\u4e2a\u9879\u76ee\u591a\u4e2a\u6a21\u5757\u4e4b\u95f4\u7c7b\u4f3c\u4e8e\u591a\u4e2a\u9879\u76ee\uff0c\u4f46\u662f\u4e4b\u95f4\u7684\u76f8\u5173\u6027\u66f4\u5f3a\uff0c\u8026\u5408\u5ea6\u76f8\u5bf9\u8981\u9ad8\u3002\u4f46\u5728\u6570\u636e\u5c42\u5e76\u4e0d\u4e00\u5b9a\u5b58\u5728join\u591a\u8868\u5173\u8054\uff0c\u62c6\u5206\u8d77\u6765\u95ee\u9898\u4e5f\u4e0d\u662f\u5f88\u5927\u3002</p> <p>\u4ee5\u4e0a\u7684\u62c6\u5206\u7684\u5173\u952e\u8bcd\u662f\u76f8\u5173\u6027\u3002\u4e0d\u540c\u7684\u6570\u636e\u6ca1\u6709\u76f4\u63a5\u7684\u8054\u7cfb\u53ef\u5929\u7136\u7684\u8fdb\u884c\u62c6\u5206\u3002\u5728\u8def\u7531\u5c42\u5373\u53ef\u5b8c\u6210\u3002\u5982\u4e0d\u540c\u7684model\u8def\u7531\u5230\u4e0d\u540c\u7684DB\u5b9e\u4f8b\u3002\u7c7b\u4f3c\u4e8eapp\u7684\u62c6\u5206\uff0c\u5fae\u670d\u52a1\u4e4b\u7c7b\u3002</p> <p>\u4ee5\u4e0b\u7684\u62c6\u5206\u7684\u5173\u952e\u8bcd\u662f\u4eb2\u548c\u6027\uff0c\u4e3b\u8981\u662f\u6d89\u53ca\u5230\u591a\u8868\u7684\u8054\u5408join\u67e5\u8be2\uff0c\u591a\u8868\u4e4b\u95f4\u76f4\u63a5\u4f9d\u8d56\u3002\u4e3a\u6ee1\u8db3\u4e8b\u52a1\u8981\u6c42\u591a\u4e2a\u8868\u5fc5\u987b\u8981\u843d\u5728\u4e00\u4e2aDB\u5b9e\u4f8b\u4e2d\u3002</p> <p>\u4eb2\u548c\u6027\u7684\u7406\u89e3\u5c31\u662f\u76f8\u5173\u7684\u6570\u636e\u653e\u5230\u4e00\u8d77\u3002\u5177\u4f53\u4e0e\u4e1a\u52a1\u903b\u8f91\u5bc6\u5207\u76f8\u5173\uff0c\u5982A\u7528\u6237\u7684\u8ba2\u5355\u4e0eB\u7528\u6237\u7684\u8ba2\u5355\u901a\u5e38\u6ca1\u6709\u76f4\u63a5\u7684\u5f3a\u8026\u5408\uff0c\u90a3\u4e48A\uff0cB\u6570\u636e\u5c31\u53ef\u5b58\u653e\u5728\u4e0d\u540c\u7684DB\u5b9e\u4f8b\u4e2d\u3002\u8fd9\u5c31\u662f\u6240\u8c13\u7684\u591a\u79df\u6237\u5e94\u7528\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_6","title":"\u8868\u7684\u62c6\u5206","text":"<ul> <li>\u5782\u76f4\u62c6\u5206 (\u6309\u5217\u62c6\u5206\uff0c\u4e0d\u540c\u7684\u5217\u96c6\u5212\u5206\u4e3a\u4e00\u4e2a\u5904\u7406\u5355\u5143)</li> <li>\u6c34\u5e73\u62c6\u5206 (range,hash,list)\uff08\u6309\u884c\u62c6\u5206\uff0c\u4e0d\u540c\u7684\u884c\u96c6\u5212\u5206\u4e3a\u4e00\u4e2a\u5904\u7406\u5355\u5143\uff09</li> </ul> <p>\u5782\u76f4\u62c6\u5206\u4e3b\u8981\u6839\u636e\u6570\u636e\u5e93\u8868\u8bbe\u8ba1\u8303\u5f0f\u7684\u8981\u6c42</p> <p>\u6c34\u5e73\u62c6\u5206\u4e3b\u8981\u5e94\u7528\u8868\u4e4b\u95f4\u7684\u7ee7\u627f\u5173\u7cfb\uff0c\u5982\u6839\u636e\u65f6\u95f4\u5212\u5206\uff0c\u5219\u53ef\u8fdb\u884c\u5386\u53f2\u6570\u636e\u5f52\u6863\u7b49\u3002\u89e3\u51b3size\u95ee\u9898</p> <p>\u8868\u7684\u62c6\u5206\u66f4\u591a\u7684\u5c5e\u4e8e\u8868\u8bbe\u8ba1\u8303\u7574\u3002\u8fd8\u6709\u4e2a\u5c31\u662f\u7d22\u5f15\u7684\u8bbe\u8ba1\u3002\u5408\u7406\u7684\u8868\u8bbe\u8ba1\u76f4\u63a5\u5f71\u54cd\u63a5\u4e0b\u6765\u7684\u8868\u5206\u7247\u3002</p> <p>\u8868\u62c6\u5206\u4ee3\u4ef7\u53ca\u6ce8\u610f\u4e8b\u9879, \u5916\u952e\uff0c\u5168\u5c40\u552f\u4e00\u6027\uff0c\u8054\u5408\u67e5\u8be2\uff0c\u751a\u81f3\u8de8\u5e93\u4e8b\u52a1\u7b49\u7279\u6027\u7684\u652f\u6301,\u67e5\u8be2\u6761\u4ef6\u4e0b\u63a8\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_7","title":"\u51b7\u70ed\u5206\u79bb","text":"<p>\u51b7\u70ed\u5206\u79bb\u4f5c\u4e3a\u8868\uff08\u65f6\u95f4\u7ef4\u5ea6range\uff09\u62c6\u5206\u540e\u7684\u4e00\u4e2a\u5177\u4f53\u5e94\u7528\u3002\u6839\u636e\u6570\u636e\u8bbf\u95ee\u70ed\u5ea6\u8fdb\u884c\u5212\u5206\u3002</p> <p>\u901a\u5e38\u6309\u65f6\u95f4\u7ef4\u5ea6\u8fdb\u884c\u5212\u5206\uff0c\u6bd4\u5982\u6700\u8fd1N\u4e2a\u6708\u4e4b\u5185\u6570\u636e\u5b58\u653e\u5728\u6027\u80fd\u8f83\u4f18\u7684ssd\uff0c\u5386\u53f2\u6570\u636e\u653e\u5728\u666e\u901a\u5927\u5bb9\u91cfsata\u76d8\u3002</p> <p>\u8fdb\u4e00\u6b65\u53ef\u5bf9\u5386\u53f2\u6570\u636e\u538b\u7f29,\u5f52\u6863</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_8","title":"\u8868\u7684\u5206\u7247","text":"<p>\u90fd\u5230\u8868\u7684\u5206\u7247(hash,list\u62c6\u5206)\u8fd9\u6b65\u4e86\uff0c\u5c3d\u91cf\u8981\u6c42\u8868\u7684\u7ed3\u6784\u80fd\u4e0d\u52a8\u5c31\u522b\u6298\u817e\u4e86\uff0c\u5305\u62ec\u7d22\u5f15\u7b49\u4efb\u4f55ddl</p> <p>\u5206\u7247\u7684\u5173\u952e\u8bcd\u5206\u5e03\u952e\uff0c\u5206\u5e03\u952e\u7684\u9009\u53d6\u81f3\u5173\u91cd\u8981\u3002</p> <p>\u5982\u4f55\u5c3d\u91cf\u5c06\u6570\u636e\u6253\u6563\uff0c\u5747\u5300\u7684\u5206\u6563\u5230\u591a\u4e2a\u5b9e\u4f8b\u4e2d\uff0c\u907f\u514d\u6570\u636e\u503e\u659c</p> <p>\u4eb2\u548c\u6027\u7684\u8981\u6c42\uff0c\u591a\u4e2a\u76f8\u5173\u8868\u7684\u5206\u5e03\u952e\u9700\u8981\u4e00\u81f4\u3002</p> <p>\u8868\u5206\u7247\u7684\u672c\u8d28\u5c31\u662f\u5728\u8868\u7ea7\u522b\u5c06\u6570\u636e\u5206\u6563\u5230\u591a\u5b9e\u4f8b\u4e2d\uff0c\u4e0d\u4ec5\u7f13\u89e3\u4e86\u5355\u673a\u7684qps\u4e5f\u7f13\u89e3\u7684\u5355\u673a\u7684size\u538b\u529b\u3002</p> <p>\u73b0\u6709\u65b9\u6848\uff1a pgxl,pgxc, citus</p> <p>\u6ce8\u610f\u95ee\u9898\uff1a \u5206\u5e03\u952e\u7684\u9009\u62e9\uff0c\u591a\u5b9e\u4f8b\u4e4b\u95f4\u7f51\u7edc\u7684\u5ef6\u8fdf\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_9","title":"\u603b\u7ed3","text":"<p>\u964d\u4f4e\u5355\u5b9e\u4f8b\u7684\u538b\u529b\u4e3b\u8981\u662f\u4eceqps\uff0csize\u4e24\u4e2a\u7ef4\u5ea6\u6765\u8003\u8651\u3002</p> <p>\u4e3b\u8981\u624b\u6bb5\u5c31\u662f\u62c6\u3001\u62c6\u3001\u62c6 </p> <p>\u4ee5\u4e0a\u4ece\u5f00\u59cb\u5230\u6700\u540e\u7684\u62c6\u5206\uff0c\u8d8a\u5411\u4e0b\u62c6\u5206\u96be\u5ea6\u8d8a\u5927\uff0c\u7ef4\u62a4\u96be\u5ea6\u589e\u52a0\uff0c\u53cd\u800c\u5f97\u5230\u7684\u6536\u76ca\u8d8a\u4e0d\u660e\u663e\u3002</p> <p>\u5982\u679c\u524d\u9762\u7684\u65b9\u6848\u80fd\u591f\u89e3\u51b3\u5c3d\u91cf\u4e0d\u91c7\u7528\u540e\u9762\u7684\u65b9\u6848\u3002</p> <p>\u5316\u7e41\u4e3a\u7b80\u7684\u601d\u8def\u4f18\u4e8e\u5177\u4f53\u7684\u6280\u672f\u3002\u52a1\u8981\u4ee5\u4e1a\u52a1\u4e3a\u6838\u5fc3\u3002\u6280\u672f\u56f4\u7ed5\u4e1a\u52a1\u9700\u6c42\uff0c\u5207\u83ab\u672c\u672b\u5012\u7f6e\u3002\u6362\u53e5\u6765\u8bf4\u4e1a\u52a1\u80fd\u89e3\u51b3\u7684\u4e0d\u7528\u6280\u672f\u6765\u89e3\u51b3\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/maintenance/thinking_in_db_fd/#_10","title":"\u6269\u5c55 \u5206\u5e03\u5f0f\u6570\u636e\u5e93","text":"<ul> <li>\u5171\u4eab\u5b58\u50a8 </li> <li>no sharing 2pc \u6bd4\u5982greenplum</li> <li>gmt \u96c6\u4e2d\u4e8b\u52a1\u6bd4\u5982 pgxc</li> <li> <p>fdw \u5916\u5b58\u50a8</p> </li> <li> <p>\u5206\u5e03\u5f0f\u8ba1\u7b97\u5b58\u50a8</p> </li> <li>\u5206\u5e03\u5f0f\u8ba1\u7b97</li> <li>\u5206\u5e03\u5f0f\u5b58\u50a8</li> <li>\u5206\u5e03\u5f0f\u4e8b\u52a1 </li> </ul>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/FunctionsandOperators/","title":"\u65b9\u6cd5\u548c\u51fd\u6570","text":""},{"location":"postgres/performance/FunctionsandOperators/#_1","title":"\u6761\u4ef6\u8868\u8fbe\u5f0f","text":"<p>https://www.postgresql.org/docs/10/functions-conditional.html</p> <p>postgresql\u652f\u6301CASE,COALESCE,NULLIF,GREATEST,LEAST\u6761\u4ef6\u8868\u8fbe\u5f0f\uff0c\u4f7f\u7528\u5b83\u4eec\u6709\u65f6\u5019\u53ef\u4ee5\u7b80\u5316\u8bb8\u591a\u529f\u80fd\u5b9e\u73b0\u3002</p>"},{"location":"postgres/performance/FunctionsandOperators/#case","title":"CASE","text":"<p>CASE\u7c7b\u4f3c\u5176\u4ed6\u8bed\u8a00\u4e2d\u7684if/else\u7b49\uff0c\u5f53\u7b26\u5408\u4e0d\u540c\u6761\u4ef6\u65f6\u5219\u8fdb\u884c\u4e0d\u540c\u7684\u8fd0\u7b97</p> <p>tbl_001\u8868</p> <pre><code>create table tbl_001(id int,name varchar(32),sex varchar(1));\n\ninsert into tbl_001 values(1,'\u5f20\u4e09','m'),(2,'\u674e\u56db','m'),(3,'\u738b\u4e94','f');\n</code></pre> <p>\u6d4b\u8bd5</p> <pre><code>\u7b80\u5355\u5e94\u7528\npostgres=# select case when sex = 'm' then '\u7537' when sex = 'f' then '\u5973' else 'O'  end as sex from tbl_001 ;\n sex \n-----\n \u7537\n \u7537\n \u5973\n(3 rows)\n\n\u7edf\u8ba1\u7537\u5973\u4eba\u6570\npostgres=# select count(sex) as \u7537 from tbl_001 where sex = 'm';\n \u7537 \n----\n  2\n(1 row)\n\npostgres=# select count(sex) as \u5973 from tbl_001 where sex = 'f';\n \u5973 \n----\n  1\n(1 row)\n\n\u4f7f\u7528case \u4e00\u6761\u641e\u5b9a\nselect sum(case when sex = 'm' then 1 else 0 end) as \u7537, sum(case when sex = 'f' then 1 else 0 end) as \u5973 from tbl_001 ;\n \u7537 | \u5973 \n----+----\n  2 |  1\n(1 row)\n\n</code></pre>"},{"location":"postgres/performance/FunctionsandOperators/#coalesce","title":"COALESCE","text":"<pre><code>COALESCE(value [, ...])\n</code></pre> <p>\u8fd4\u56de\u7b2c\u4e00\u4e2a\u975enull</p> <pre><code>postgres=# select coalesce(null,null,1,2,3);\n coalesce \n----------\n        1\n(1 row)\n\npostgres=# select coalesce(null,null,'a','b','c');\n coalesce \n----------\n a\n(1 row)\n\n\nselect coalesce(extract(epoch from max(age(now(), query_start))), 0) from pg_stat_activity where wait_event is not null;\n\n</code></pre>"},{"location":"postgres/performance/FunctionsandOperators/#nullif","title":"NULLIF","text":"<pre><code>NULLIF(value1, value2)\n</code></pre> <p>value1 \u548c value2 \u76f8\u7b49\u8fd4\u56denull \u5426\u5219\u8fd4\u56de value1</p> <pre><code>postgres=# select nullif(1,1),nullif(1,2);\n nullif | nullif \n--------+--------\n        |      1\n(1 row)\n</code></pre>"},{"location":"postgres/performance/FunctionsandOperators/#greatest-and-least","title":"GREATEST and LEAST","text":"<p>\u5206\u522b\u8fd4\u56de\u6700\u5927\u548c\u6700\u5c0f\u503c</p> <pre><code>postgres=# select greatest(1,2,3),greatest('a','b','c');\n greatest | greatest \n----------+----------\n        3 | c\n(1 row)\n\npostgres=# select least(1,2,3),least('a','b','c');\n least | least \n-------+-------\n     1 | a\n(1 row)\n</code></pre>"},{"location":"postgres/performance/FunctionsandOperators/#_2","title":"\u65f6\u95f4\u7c7b\u578b","text":"<p>\u7eaa\u5143\uff0cutc\u65f6\u95f4epoch</p> <pre><code># t\npostgres=# select extract(epoch from now());\n    date_part     \n------------------\n 1586846074.40049\n(1 row)\n\npostgres=# select extract(epoch from timestamp without time zone '1970-01-01 01:00:00');\n date_part \n-----------\n      3600\n(1 row)\n\npostgres=# SELECT TIMESTAMP WITH TIME ZONE 'epoch' + 1586846074.40049 * INTERVAL '1 second' as tsp;\n             tsp              \n------------------------------\n 2020-04-14 14:34:34.40049+08\n(1 row)\n</code></pre> <p>\u65f6\u533a</p> <pre><code>#\u5f53\u524d\u65f6\u533a\npostgres=# show timezone;\n TimeZone \n----------\n PRC\n(1 row)\n\n#\u7cfb\u7edf\u652f\u6301\u7684\u65f6\u533a\npostgres=# select * from pg_timezone_names; \n\n#\u65f6\u533a\npostgres=# select now()::timestamp with time zone, now()::timestamp without time zone;\n              now              |            now             \n-------------------------------+----------------------------\n 2020-04-14 15:44:39.501691+08 | 2020-04-14 15:44:39.501691\n(1 row)\n\n#\u65f6\u533a\u8f6c\u6362\npostgres=# select '2020-04-14 09:07:30.816885+08' at time zone 'prc';\n          timezone          \n----------------------------\n 2020-04-14 09:07:30.816885\n(1 row)\n\npostgres=# select '2016-02-03 09:07:30.816885+08' at time zone 'pst';\n          timezone          \n----------------------------\n 2016-02-02 17:07:30.816885\n</code></pre> <p>\u6ca1\u6709\u65f6\u533a\u4ee3\u8868\u7684\u662f\u7edd\u5bf9\u65f6\u95f4\uff0cabsolute timestamp\uff0c\u5373 UTC (UTC+0) \u65f6\u95f4\u3002</p> <p>\u5e26\u7740\u65f6\u533a\u7684\u4ee3\u8868\u76f8\u5bf9\u65f6\u95f4\uff0crelative timestamp\uff0c\u5373\u5f53\u5730\u65f6\u95f4\uff0c\u5982\u5317\u4eac\u7684\u5f53\u5730\u65f6\u95f4\u662f UTC+8 \u7684\u65f6\u95f4\u3002</p> <p>\u4f7f\u7528\u7684\u4e00\u4e2a\u6700\u4f73\u5b9e\u8df5\u662f\u65f6\u95f4\u7c7b\u578b\u90fd\u8bbe\u4e3a timestamp with time zone \u7c7b\u578b\uff0c\u53ea\u6709\u5728\u6839\u636e timestamp \u8fdb\u884c partition \u65f6\u624d\u4f7f\u7528 timestamp without time zone \u7c7b\u578b\uff0c</p> <p>\u56e0\u4e3a partition \u5fc5\u987b\u4f7f\u7528 immutable \u6570\u636e (\u5373\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u6570\u636e\u53d6\u51fa\u6765\u90fd\u4e00\u6837)\uff0c\u800c timestamp with time zone \u7684\u6570\u636e\u503c\u4e0e postgres \u914d\u7f6e\u7684 timezone \u6709\u5173\u3002</p> <p>\u8fd9\u4e24\u79cd\u6570\u636e\u7c7b\u578b\u7684\u533a\u522b\u662f:</p> <p>\u4ee5\u5f53\u5730\u65f6\u95f4\u5b58\u50a8\u6570\u636e\u5230 timestamp with time zone \u7c7b\u578b\u7684\u5b57\u6bb5\u65f6\uff0cpostgres \u5e95\u5c42\u4f1a\u4ee5 UTC \u65f6\u95f4\u5b58\u50a8\uff0c\u5c55\u793a\u6570\u636e\u65f6\u4f1a\u6839\u636e postgres \u8bbe\u7f6e\u7684 timezone \u663e\u793a\u4e3a\u5f53\u65f6\u65f6\u95f4\u3002</p> <p>\u4ee5\u5f53\u5730\u65f6\u95f4\u5b58\u50a8\u6570\u636e\u5230 timestamp without time zone \u7c7b\u578b\u7684\u5b57\u6bb5\u65f6\uff0cpostgres \u5e95\u5c42\u4ee5\u8f93\u5165\u7684\u6570\u636e\u8fdb\u884c\u5b58\u50a8\uff0c\u5c55\u793a\u65f6\u4f1a\u539f\u6837\u5c55\u793a\uff0c\u4e0e postgres \u8bbe\u7f6e\u7684\u65f6\u533a\u65e0\u5173\u3002</p> <p>\u65f6\u95f4\u6233\u52a0\u51cf</p> <pre><code>postgres=# select date '2016-02-02 10:00:00'+ interval '10 minutes'; \n</code></pre> <p>\u65f6\u95f4\u6233\u683c\u5f0f\u5316</p> <pre><code>postgres=# select to_char(now(),'YYYY-MM-DD hh24:mi:ss');\n       to_char       \n---------------------\n 2020-04-14 16:14:29\n(1 row)\n\npostgres=# select to_timestamp('2020-04-14 16:14:29','YYYY-MM-DD hh24:mi:ss');\n      to_timestamp      \n------------------------\n 2020-04-14 16:14:29+08\n(1 row)\n</code></pre> <p>\u65f6\u95f4\u6bd4\u8f83</p> <pre><code>select current_date &lt;= to_date('2018-03-12 18:47:35','yyyy-MM-dd hh24:mi:ss');\n\nselect current_timestamp &lt;= to_timestamp('2018-03-12 18:47:35','yyyy-MM-dd hh24:mi:ss');\n</code></pre> <pre><code>--\u521b\u5efa\u968f\u673a\u65e5\u671f\u65f6\u95f4\u51fd\u6570       \nCREATE OR REPLACE FUNCTION rand_date_time(start_date date, end_date date)\n RETURNS TIMESTAMP AS $$  \nDECLARE  \n    interval_days integer;  \n    random_seconds integer;  \n    random_dates integer;  \n    random_date date;  \n    random_time time;\nBEGIN  \n    interval_days := end_date - start_date;  \n    random_dates:= trunc(random()*interval_days);\n    random_date := start_date + random_dates; \n    random_seconds:= trunc(random()*3600*24); \n    random_time:=' 00:00:00'::time+(random_seconds || ' second')::INTERVAL;\n    RETURN random_date +random_time;  \nEND;   \n$$  \nLANGUAGE plpgsql;\n</code></pre>"},{"location":"postgres/performance/FunctionsandOperators/#json","title":"JSON \u7c7b\u578b","text":"<p>postgresql\u652f\u6301\u4e24\u79cdjson\u6570\u636e\u7c7b\u578b\uff1ajson\u548cjsonb\uff0c\u800c\u4e24\u8005\u552f\u4e00\u7684\u533a\u522b\u5728\u4e8e\u6548\u7387,json\u662f\u5bf9\u8f93\u5165\u7684\u5b8c\u6574\u62f7\u8d1d\uff0c\u4f7f\u7528\u65f6\u518d\u53bb\u89e3\u6790\uff0c\u6240\u4ee5\u5b83\u4f1a\u4fdd\u7559\u8f93\u5165\u7684\u7a7a\u683c\uff0c\u91cd\u590d\u952e\u4ee5\u53ca\u987a\u5e8f\u7b49\u3002</p> <p>\u800cjsonb\u662f\u89e3\u6790\u8f93\u5165\u540e\u4fdd\u5b58\u7684\u4e8c\u8fdb\u5236\uff0c\u5b83\u5728\u89e3\u6790\u65f6\u4f1a\u5220\u9664\u4e0d\u5fc5\u8981\u7684\u7a7a\u683c\u548c\u91cd\u590d\u7684\u952e\uff0c\u987a\u5e8f\u548c\u8f93\u5165\u53ef\u80fd\u4e5f\u4e0d\u76f8\u540c\u3002\u4f7f\u7528\u65f6\u4e0d\u7528\u518d\u6b21\u89e3\u6790\u3002</p> <p>\u4e24\u8005\u5bf9\u91cd\u590d\u952e\u7684\u5904\u7406\u90fd\u662f\u4fdd\u7559\u6700\u540e\u4e00\u4e2a\u952e\u503c\u5bf9\u3002\u6548\u7387\u7684\u5dee\u522b\uff1ajson\u7c7b\u578b\u5b58\u50a8\u5feb\uff0c\u4f7f\u7528\u6162\uff0cjsonb\u7c7b\u578b\u5b58\u50a8\u7a0d\u6162\uff0c\u4f7f\u7528\u8f83\u5feb\u3002</p> <pre><code>postgres=#  SELECT '{\"bar\": \"baz\", \"balance\":      7.77, \"active\":false}'::json;\n                         json                         \n------------------------------------------------------\n {\"bar\": \"baz\", \"balance\":      7.77, \"active\":false}\n(1 row)\n\npostgres=#  SELECT '{\"bar\": \"baz\", \"balance\":      7.77, \"active\":false}'::jsonb;\n                      jsonb                       \n--------------------------------------------------\n {\"bar\": \"baz\", \"active\": false, \"balance\": 7.77}\n(1 row)\n\n</code></pre> <p>\u6d4b\u8bd5\u8868</p> <pre><code>create table api(jdoc jsonb);\n\ninsert into api values('{\n\"guid\": \"9c36adc1-7fb5-4d5b-83b4-90356a46061a\",\n\"name\": \"Angela Barton\",\n\"is_active\": true,\n\"company\": \"Magnafone\",\n\"address\": \"178 Howard Place, Gulf, Washington, 702\",\n\"registered\": \"2009-11-07T08:53:22 +08:00\",\n\"latitude\": 19.793713,\n\"longitude\": 86.513373,\n\"tags\": [\n\"enim\",\n\"aliquip\",\n\"qui\"\n]}');\n</code></pre> <pre><code>postgres=# SELECT jdoc-&gt;'guid', jdoc-&gt;'name' FROM api WHERE jdoc @&gt; '{\"company\": \"Magnafone\"}';\n                ?column?                |    ?column?     \n----------------------------------------+-----------------\n \"9c36adc1-7fb5-4d5b-83b4-90356a46061a\" | \"Angela Barton\"\n</code></pre> <p>jsonb\u7f3a\u7701\u7684GIN\u64cd\u4f5c\u7b26\u7c7b\u652f\u6301\u4f7f\u7528@&gt;\u3001?\u3001?&amp;\u548c?|\u64cd\u4f5c\u7b26\u67e5\u8be2\uff0c\u5728api\u7684jdoc\u4e0a\u521b\u5efa\u4e00\u4e2agin\u7d22\u5f15\u3002</p> <pre><code>test=# CREATE INDEX idxgin ON api USING gin (jdoc);\nCREATE INDEX\n</code></pre> <p>json\u548cjsonb\u7684\u64cd\u4f5c\u7b26</p> <p>https://www.postgresql.org/docs/9.6/functions-json.html</p>"},{"location":"postgres/performance/FunctionsandOperators/#_3","title":"\u6570\u7ec4\u51fd\u6570\u548c\u64cd\u4f5c\u7b26","text":"<p>http://postgres.cn/docs/11/functions-array.html</p>"},{"location":"postgres/performance/fillfactor/","title":"fillfactor \u586b\u5145\u56e0\u5b50","text":""},{"location":"postgres/performance/fillfactor/#_1","title":"\u4ecb\u7ecd","text":"<p>PostgreSQL\u6bcf\u4e2a\u8868\u548c\u7d22\u5f15\u7684\u6570\u636e\u90fd\u662f\u7531\u5f88\u591a\u4e2a\u56fa\u5b9a\u5c3a\u5bf8\u7684\u9875\u9762\u5b58\u50a8\uff08\u901a\u5e38\u662f 8kB\uff0c\u4e0d\u8fc7\u5728\u7f16\u8bd1\u670d\u52a1\u5668\u65f6[\u2013with-blocksize]\u53ef\u4ee5\u9009\u62e9\u5176\u4ed6\u4e0d\u540c\u7684\u5c3a\u5bf8\uff09       \u4e00\u4e2a\u8868\u7684\u586b\u5145\u56e0\u5b50(fillfactor)\u662f\u4e00\u4e2a\u4ecb\u4e8e 10 \u548c 100 \u4e4b\u95f4\u7684\u767e\u5206\u6570\u3002100(\u5b8c\u5168\u586b\u5145)\u662f\u9ed8\u8ba4\u503c\u3002\u5982\u679c\u6307\u5b9a\u4e86\u8f83\u5c0f\u7684\u586b\u5145\u56e0\u5b50\uff0cINSERT \u64cd\u4f5c\u4ec5\u6309\u7167\u586b\u5145\u56e0\u5b50\u6307\u5b9a\u7684\u767e\u5206\u7387\u586b\u5145\u8868\u9875\u3002\u6bcf\u4e2a\u9875\u4e0a\u7684\u5269\u4f59\u7a7a\u95f4\u5c06\u7528\u4e8e\u5728\u8be5\u9875\u4e0a\u66f4\u65b0\u884c\uff0c\u8fd9\u5c31\u4f7f\u5f97 UPDATE \u6709\u673a\u4f1a\u5728\u540c\u4e00\u9875\u4e0a\u653e\u7f6e\u540c\u4e00\u6761\u8bb0\u5f55\u7684\u65b0\u7248\u672c\uff0c\u8fd9\u6bd4\u628a\u65b0\u7248\u672c\u653e\u7f6e\u5728\u5176\u5b83\u9875\u4e0a\u66f4\u6709\u6548\u3002\u5bf9\u4e8e\u4e00\u4e2a\u4ece\u4e0d\u66f4\u65b0\u7684\u8868\u5c06\u586b\u5145\u56e0\u5b50\u8bbe\u4e3a 100 \u662f\u6700\u4f73\u9009\u62e9\uff0c\u4f46\u662f\u5bf9\u4e8e\u9891\u7e41\u66f4\u65b0\u7684\u8868\uff0c\u8f83\u5c0f\u7684\u586b\u5145\u56e0\u5b50\u5219\u66f4\u52a0\u6709\u6548\u3002</p> <p>PostgresSQL \u4f7f\u7528Heap-Only Tuple \u6280\u672f \u4f1a\u5728\u65e7\u884c\u4e0e\u65b0\u884c\u4e4b\u95f4\u5efa\u7acb\u4e00\u4e2a\u94fe\u8868\uff0c\u8fd9\u6837\u4e00\u6765\u5c31\u4e0d\u9700\u8981\u66f4\u65b0\u7d22\u5f15\u4e86\uff0c\u7d22\u5f15\u9879\u4ecd\u4f1a\u6307\u5411\u65e7\u884c\uff0c\u901a\u8fc7\u94fe\u8868\u53ef\u4ee5\u627e\u5230\u65b0\u884c\u3002\u56e0\u6b64Heap-Only Tuple \u7684\u94fe\u8868\u4e0d\u80fd\u8de8\u6570\u636e\u5757\u3002</p>"},{"location":"postgres/performance/fillfactor/#_2","title":"\u793a\u4f8b","text":"<pre><code>create table t_fillfactor01(id int ,name varchar  , blog text ) WITH (fillfactor=70);\nCREATE TABLE\nnew_test=# \\d+ t_fillfactor01\n                         Table \"public.t_fillfactor01\"\n Column |       Type        | Modifiers | Storage  | Stats target | Description \n--------+-------------------+-----------+----------+--------------+-------------\n id     | integer           |           | plain    |              | \n name   | character varying |           | extended |              | \n blog   | text              |           | extended |              | \nOptions: fillfactor=70\n</code></pre>"},{"location":"postgres/performance/fillfactor/#_3","title":"\u6d4b\u8bd5","text":"<pre><code>/****************************************************************************************\n    \u521b\u5efa\u6d4b\u8bd5\u8868\n    test1\u8bbe\u7f6efillfactor=100\n    test2\u8bbe\u7f6efillfactor=80\n    drop table if exists  test1;\n    drop table if exists  test2;\n****************************************************************************************/ \ncreate table test1(\n    objectid bigserial not null,                --\u552f\u4e00\u7f16\u53f7\uff0c\u4e3b\u952e\n    name text not null,                         --\u540d\u79f0\n    describe text,                              --\u5907\u6ce8\n    generate timestamptz default now() not null,--\u521b\u5efa\u65e5\u671f\n    constraint pk_test1_objectid primary key(objectid)\n)with (fillfactor=100); \n\ncreate table test2(\n    objectid bigserial not null,                --\u552f\u4e00\u7f16\u53f7\uff0c\u4e3b\u952e\n    name text not null,                         --\u540d\u79f0\n    describe text,                              --\u5907\u6ce8\n    generate timestamptz default now() not null,--\u521b\u5efa\u65e5\u671f\n    constraint pk_test2_objectid primary key(objectid)\n)with (fillfactor=80); \n\n/****************************************************************************************\n    \u521b\u5efa\u968f\u673a\u751f\u6210\u4e2d\u6587\u5b57\u7b26\u51fd\u6570\ndrop function if exists gen_random_zh(int,int);\n****************************************************************************************/ \n\ncreate or replace function gen_random_zh(int,int)\n    returns text\nas $$\n    select string_agg(chr((random()*(20901-19968)+19968 )::integer) , '')  from generate_series(1,(random()*($2-$1)+$1)::integer); $$ language sql; \n\n/****************************************************************************************\n    \u5bfc\u5165\u6d4b\u8bd5\u6570\u636e\n****************************************************************************************/ \ninsert into test1(name)\n  select gen_random_zh(8,32) from generate_series(1,10000); \n\ninsert into test2(name)\n    select gen_random_zh(8,32) from generate_series(1,10000);\n\n/****************************************************************************************\n    \u67e5\u770btest1\u6570\u636e\u5728\u9875\u4e2d\u7684\u5e03\u5c40\n****************************************************************************************/\n\nselect ctid,objectid from test1 limit 500;\n\u7565\n\nselect ctid,objectid from test2 limit 500;\n\u7565\n\n---test1 --- fillfactor = 100\n select ctid from test1 where objectid = 93;\n ctid \n-------- \n(1,18) (1 row) \nupdate test1 set name=gen_random_zh(8,32) where objectid = 93; \nselect ctid from test1 where objectid = 93; \nctid \n---------- \n(133,31) (1 row) \n\n--test2 --- fillfactor = 80 \nselect ctid from test2 where objectid = 93;\nctid \n-------- \n(1,32) (1 row)\nupdate test2 set name=gen_random_zh(8,32) where objectid = 93;\nselect ctid from test2 where objectid = 93; \nctid \n-------- \n(1,58) (1 row)\n\n--------------------- \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230test1\u4e2d\u56e0\u4e3a\u586b\u5145\u7387\u4e3a100%,update\u540e\u7b2c\u4e00\u9875\u4e2d\u6ca1\u6709\u4f4d\u7f6e\u5b58\u50a8\u65b0\u7684\u6570\u636e\u4e86,\u6240\u4ee5\u68c0\u67e5\u6700\u5927\u7684\u9875\u6587\u4ef6\u662f\u5426\u8fd8\u6709\u4f4d\u7f6e,\u5982\u679c\u6709\u76f4\u63a5\u63d2\u5165,\u5982\u679c\u6ca1\u6709\u5219\u518d\u65b0\u5efa\u4e00\u9875\u540e\u63d2\u5165,\u5728\u672c\u4f8b\u4e2d\u8df3\u8fc7\u4e86132\u4e2a\u9875\u6587\u4ef6.</p> <p>test2\u4e2d\u56e0\u4e3a\u586b\u5145\u7387\u4e3a80%,\u8fd8\u670920%\u7684\u7a7a\u95f4\u53ef\u4ee5\u5b58\u50a8\u6570\u636e,\u56e0\u6b64update\u540e\u76f4\u63a5\u5728\u5386\u53f2\u6570\u636e\u6240\u5728\u7684\u9875\u540e\u9762\u63d2\u5165\u6570\u636e.</p>"},{"location":"postgres/performance/fillfactor/#fillfactor","title":"fillfactor \u7684\u8bbe\u7f6e","text":"<p>fillfactor \u7684\u8bbe\u7f6e\u53ef\u76f4\u63a5\u5f71\u54cdhotupdate\u7684\u6bd4\u4f8b\uff0c \u901a\u8fc7wal\u65e5\u5fd7\u7684\u89e3\u6790\u53ef\u4ee5\u67e5\u770bhotupdate\u7684\u60c5\u51b5 checkpoint</p>"},{"location":"postgres/performance/high_level_sql/","title":"\u9ad8\u7ea7SQL","text":"<ul> <li>\u5206\u7ec4\u96c6</li> <li>\u6392\u5e8f\u96c6</li> <li>\u5047\u8c61\u96c6</li> <li>\u7a97\u53e3\u51fd\u6570</li> <li>\u9012\u5f52</li> </ul>"},{"location":"postgres/performance/high_level_sql/#_1","title":"\u9012\u5f52\u5e94\u7528","text":"<p>\u9012\u5f52\u52a0\u901fcount(distint) \u67e5\u8be2\u3002 \u4f7f\u7528\u573a\u666f\uff0c\u6570\u636e\u5206\u5e03\uff1a\u5927\u6570\u636e\u96c6\u4f46\u5176\u4e2d\u7684\u7c7b\u578b\u5374\u5f88\u5c11</p> <pre><code>-- \u521b\u5efa\u8868\ntest1=# create table recurive_t(user_id int,free float,info text);\nCREATE TABLE\n-- \u52a0\u5165\u6570\u636e\ntest1=# insert into recurive_t select 1 ,generate_series(0,1000000),'user 1 pay !!!';\ntest1=# insert into recurive_t select 2 ,generate_series(0,2000000),'user 2 pay !!!';\ntest1=# insert into recurive_t select 3 ,generate_series(0,3000000),'user 3 pay !!!';\ntest1=# insert into recurive_t select 4 ,generate_series(0,4000000),'user 4 pay !!!';\ntest1=# insert into recurive_t select 5 ,generate_series(0,4000000),'user 5 pay !!!';\ntest1=# analyze recurive_t ;\nANALYZE\n</code></pre> <pre><code>-- count(distinct()) \u67e5\u8be2\ntest1=# explain analyze select count(distinct(user_id)) from recurive_t ;\n                                                                  QUERY PLAN                                                                   \n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Aggregate  (cost=10000412944.36..10000412944.37 rows=1 width=8) (actual time=2793.108..2793.108 rows=1 loops=1)\n   -&gt;  Seq Scan on recurive_t  (cost=10000000000.00..10000377992.29 rows=13980829 width=4) (actual time=0.006..1065.338 rows=14000005 loops=1)\n Planning time: 0.054 ms\n Execution time: 2793.144 ms\n(4 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a2793.548 ms (00:02.794)\n</code></pre> <pre><code>-- group by \u67e5\u8be2\ntest1=# explain analyze select user_id from recurive_t group by user_id;\n                                                                                      QUERY PLAN                                                                                      \n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Group  (cost=1000.46..511742.60 rows=5 width=4) (actual time=8.073..1119.549 rows=5 loops=1)\n   Group Key: user_id\n   -&gt;  Gather Merge  (cost=1000.46..511742.57 rows=10 width=4) (actual time=8.072..1138.226 rows=15 loops=1)\n         Workers Planned: 2\n         Workers Launched: 2\n         -&gt;  Group  (cost=0.43..510741.40 rows=5 width=4) (actual time=0.053..845.258 rows=5 loops=3)\n               Group Key: user_id\n               -&gt;  Parallel Index Only Scan using recurive_t_user_id_idx on recurive_t  (cost=0.43..496178.03 rows=5825345 width=4) (actual time=0.050..694.273 rows=4666668 loops=3)\n                     Heap Fetches: 1803282\n Planning time: 0.133 ms\n Execution time: 1138.276 ms\n(11 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a1139.009 ms (00:01.139)\n</code></pre> <pre><code>-- \u6dfb\u52a0\u7d22\u5f15\uff0c\u5bf9\u4f18\u5316\u6ca1\u6709\u6548\u679c\ntest1=# create index ON recurive_t (user_id );\nCREATE INDEX\n\u65f6\u95f4\uff1a5990.992 ms (00:05.991)\ntest1=# explain analyze select count(distinct(user_id)) from recurive_t ;\n                                                                             QUERY PLAN                                                                             \n--------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Aggregate  (cost=613020.52..613020.53 rows=1 width=8) (actual time=3180.517..3180.517 rows=1 loops=1)\n   -&gt;  Index Only Scan using recurive_t_user_id_idx on recurive_t  (cost=0.43..578020.51 rows=14000005 width=4) (actual time=0.089..1531.050 rows=14000005 loops=1)\n         Heap Fetches: 14000005\n Planning time: 0.288 ms\n Execution time: 3180.570 ms\n(5 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a3181.520 ms (00:03.182)\n</code></pre> <pre><code>--- \u753b\u91cd\u70b9\uff0c\u5229\u7528\u9012\u5f52\u67e5\u8be2\u3002\u6548\u679c\u60ca\u4eba\ntest1=# explain analyze with recursive skip as(\n    (\n      select min(t.user_id) as user_id from recurive_t t\n    )\n    union\n    (\n      select (select min(t.user_id) from recurive_t t where t.user_id &gt; s.user_id )\n         from skip s\n    )\n)\nselect count(*) from skip;\n                                                                                       QUERY PLAN                                                                                        \n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Aggregate  (cost=54.94..54.95 rows=1 width=8) (actual time=0.271..0.271 rows=1 loops=1)\n   CTE skip\n     -&gt;  Recursive Union  (cost=0.47..52.67 rows=101 width=4) (actual time=0.051..0.256 rows=6 loops=1)\n           -&gt;  Result  (cost=0.47..0.48 rows=1 width=4) (actual time=0.048..0.048 rows=1 loops=1)\n                 InitPlan 3 (returns $1)\n                   -&gt;  Limit  (cost=0.43..0.47 rows=1 width=4) (actual time=0.043..0.044 rows=1 loops=1)\n                         -&gt;  Index Only Scan using recurive_t_user_id_idx on recurive_t t_1  (cost=0.43..525904.40 rows=15394398 width=4) (actual time=0.042..0.042 rows=1 loops=1)\n                               Index Cond: (user_id IS NOT NULL)\n                               Heap Fetches: 1\n           -&gt;  WorkTable Scan on skip s  (cost=0.00..5.02 rows=10 width=4) (actual time=0.031..0.032 rows=1 loops=6)\n                 SubPlan 2\n                   -&gt;  Result  (cost=0.47..0.48 rows=1 width=4) (actual time=0.028..0.028 rows=1 loops=6)\n                         InitPlan 1 (returns $3)\n                           -&gt;  Limit  (cost=0.43..0.47 rows=1 width=4) (actual time=0.027..0.027 rows=1 loops=6)\n                                 -&gt;  Index Only Scan using recurive_t_user_id_idx on recurive_t t  (cost=0.43..188135.76 rows=5131466 width=4) (actual time=0.025..0.025 rows=1 loops=6)\n                                       Index Cond: ((user_id IS NOT NULL) AND (user_id &gt; s.user_id))\n                                       Heap Fetches: 4\n   -&gt;  CTE Scan on skip  (cost=0.00..2.02 rows=101 width=0) (actual time=0.054..0.263 rows=6 loops=1)\n Planning time: 0.415 ms\n Execution time: 0.373 ms\n(20 \u884c\u8bb0\u5f55)\n\n\u65f6\u95f4\uff1a1.872 ms\n</code></pre>"},{"location":"postgres/performance/high_level_sql/#with","title":"WITH","text":"<p>\u5229\u7528with as \u4e0d\u9700\u8981\u4fee\u6539\u7d22\u5f15\uff0c\u6307\u5b9a\u67e5\u8be2\u8ba1\u5212</p> <pre><code>select * from T where A=1 and B = 2;\n\n\u6267\u884c\u8ba1\u5212\u53ef\u80fd\u4f7f\u7528A\u7d22\u5f15\uff0c\u4e5f\u53ef\u80fd\u8d70B\u7d22\u5f15\n\nWITH T_a as (\n select * from T where A = 1;\n)\nselect * from T_a where B = 1;\n\n\u6267\u884c\u8ba1\u5212\u8d70A \u7d22\u5f15 \n</code></pre> <p>\u66f4\u591a\u53c2\u8003</p> <p>https://www.jianshu.com/p/50292ad0d7eb</p>"},{"location":"postgres/performance/hotupdate/","title":"hot update","text":""},{"location":"postgres/performance/hotupdate/#what-is-hot","title":"What is HOT","text":"<p>HOT\u662f\u201cHeap Only Tuple\u201d\uff08\u4ec5\u5143\u7ec4\u5806\uff09\u7684\u7f29\u5199, \u7528\u6765\u63d0\u9ad8update\u6548\u7387\u3002</p> <p>\u884c\u7684\u65b0\u7248\u672c\u548c\u65e7\u7248\u672c\u4f4d\u4e8e\u540c\u4e00\u5757\u4e2d\u65f6\uff0c\u8be5\u884c\u7684\u5916\u90e8\u5730\u5740\uff08\u539f\u59cb\u884c\u6307\u9488\uff09\u4fdd\u6301\u4e0d\u53d8\uff0c\u5229\u7528hot link\u6307\u9488\u8fdb\u884c\u8f6c\u53d1\u5730\u5740\u3002\u7d22\u5f15\u4e0d\u9700\u8981\u4efb\u4f55\u6539\u52a8\u3002</p>"},{"location":"postgres/performance/hotupdate/#_1","title":"\u524d\u63d0\u6761\u4ef6","text":"<ul> <li> <p>\u5305\u542b\u66f4\u65b0\u884c\u7684\u5757\u4e2d\u5fc5\u987b\u6709\u8db3\u591f\u7684\u7a7a\u95f4</p> </li> <li> <p>\u5728\u5df2\u4fee\u6539\u503c\u7684\u4efb\u4f55\u5217\u4e0a\u5747\u672a\u5b9a\u4e49\u7d22\u5f15</p> </li> </ul>"},{"location":"postgres/performance/hotupdate/#_2","title":"\u751f\u4ea7\u5e94\u7528","text":"<p>\u4f7f\u7528fillfactor\u4ee5\u83b7\u53d6HOT\u66f4\u65b0</p>"},{"location":"postgres/performance/hotupdate/#_3","title":"\u4f8b\u5b50","text":"<p>\u5efa\u8868</p> <pre><code>CREATE TABLE mytable (\n   id  integer PRIMARY KEY,\n   val integer NOT NULL\n) WITH (autovacuum_enabled = off);\n\nINSERT INTO mytable\nSELECT *, 0\nFROM generate_series(1, 235) AS n; \n\n</code></pre> <p>8k page \u7269\u7406\u5206\u5e03</p> <pre><code>SELECT ctid, id, val\nFROM mytable;\n  ctid   | id  | val \n---------+-----+-----\n (0,1)   |   1 |   0\n (0,2)   |   2 |   0\n (0,3)   |   3 |   0\n (0,4)   |   4 |   0\n (0,5)   |   5 |   0\n...\n (0,224) | 224 |   0\n (0,225) | 225 |   0\n (0,226) | 226 |   0\n (1,1)   | 227 |   0\n (1,2)   | 228 |   0\n (1,3)   | 229 |   0\n (1,4)   | 230 |   0\n (1,5)   | 231 |   0\n (1,6)   | 232 |   0\n (1,7)   | 233 |   0\n (1,8)   | 234 |   0\n (1,9)   | 235 |   0\n(235 rows)\n</code></pre> <p>\u9875\u5185\u65e0\u8db3\u591f\u5269\u4f59\u7a7a\u95f4,\u8de8\u9875\u66f4\u65b0</p> <pre><code>postgres=# update mytable set val = 100 where id = 5;\nUPDATE 1\npostgres=# select ctid,* from mytable where id = 5;\n  ctid  | id | val \n--------+----+-----\n (1,10) |  5 | 100\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# select  n_tup_upd, n_tup_hot_upd from pg_stat_all_tables where relname = 'mytable';\n n_tup_upd | n_tup_hot_upd \n-----------+---------------\n         1 |             0\n(1 \u884c\u8bb0\u5f55)\n\n</code></pre> <p>\u9875\u5185\u6709\u8db3\u591f\u5269\u4f59\u7a7a\u95f4\uff0c\u9875\u5185hot \u66f4\u65b0</p> <pre><code>postgres=# update mytable set val = 100 where id = 230;\nUPDATE 1\npostgres=# select ctid,* from mytable where id = 230;\n  ctid  | id  | val \n--------+-----+-----\n (1,11) | 230 | 100\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# select  n_tup_upd, n_tup_hot_upd from pg_stat_all_tables where relname = 'mytable';\n n_tup_upd | n_tup_hot_upd \n-----------+---------------\n         2 |             1\n(1 \u884c\u8bb0\u5f55)\n</code></pre> <p>\u9875\u5185\u6709\u8db3\u591f\u7a7a\u95f4\uff0c\u4f46\u662f\u66f4\u65b0\u7684\u5b57\u6bb5\u5305\u542b\u7d22\u5f15\u7684\u60c5\u51b5,\u6ca1\u6709\u53d1\u751fhot \u66f4\u65b0</p> <pre><code>postgres=# create index ON mytable (val );\nCREATE INDEX\npostgres=# update mytable set val = 100 where id = 231;\nUPDATE 1\npostgres=# select ctid,* from mytable where id = 231;\n  ctid  | id  | val \n--------+-----+-----\n (1,12) | 231 | 100\n(1 \u884c\u8bb0\u5f55)\n\npostgres=# select  n_tup_upd, n_tup_hot_upd from pg_stat_all_tables where relname = 'mytable';\n n_tup_upd | n_tup_hot_upd \n-----------+---------------\n         3 |             1\n(1 \u884c\u8bb0\u5f55)\n\n</code></pre> <p>more</p>"},{"location":"postgres/performance/params/","title":"\u6570\u636e\u5e93\u53c2\u6570","text":"","tags":[]},{"location":"postgres/performance/params/#_1","title":"\u6027\u80fd\u53c2\u6570","text":"<p>pgtune pgconfig cybertec </p>","tags":[]},{"location":"postgres/performance/params/#_2","title":"\u65e5\u5fd7\u53c2\u6570","text":"","tags":[]},{"location":"postgres/performance/params/#_3","title":"\u66f4\u591a\u53c2\u6570\u8be6\u89e3","text":"","tags":[]},{"location":"postgres/performance/params/#_4","title":"\u7ba1\u7406","text":"<pre><code>listen_addresses = \"*\"             # \u8fde\u63a5\u8bbf\u95ee\u63a7\u5236\uff0c\u54ea\u4e9bip\u53ef\u4ee5\u8bbf\u95ee\uff0c * \u5168\u90e8\u3002 \u7ed3\u5408pg_hba.conf , iptables\u8bbe\u7f6e\u3002\nsuperuser_reserved_connections = 3 # \u9884\u7559\u7ed9\u8d85\u7ea7\u7ba1\u7406\u5458\u7684\u8fde\u63a5\u6570\u3002\nport = 5432                        # \u9ed8\u8ba4\u8bbf\u95ee\u7aef\u53e3\nwal_keep_segments = 1024           # wal \u65e5\u5fd7\u4fdd\u5b58\u6570\u91cf\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#wal","title":"wal\u65e5\u5fd7","text":"<pre><code>wal_log_hints = on \nfull_page_writes = on\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#_5","title":"\u6210\u672c\u56e0\u5b50","text":"<pre><code># - Planner Cost Constants -\n#seq_page_cost = 1.0                    # measured on an arbitrary scale \u987a\u5e8f\u626b\u63cf\nrandom_page_cost = 1.1                  # same scale as above            \u968f\u673a\u626b\u63cf\u3002HDD 4 ;SSD 1.1; \u7531\u4e8eSSD\u6ca1\u6709\u78c1\u76d8\u5bfb\u9053\u65f6\u95f4\uff0c\u987a\u5e8f\u626b\u63cf\u548c\u968f\u673a\u626b\u63cf\u7684\u5dee\u8ddd\u4e0d\u662f\u90a3\u4e48\u5927\u3002\u6bd4\u4f8b\u8bbe\u7f6e\u7684\u76f8\u8fd1\u5373\u53ef\u3002 \n#cpu_tuple_cost = 0.01                  # same scale as above\n#cpu_index_tuple_cost = 0.005           # same scale as above\n#cpu_operator_cost = 0.0025             # same scale as above\n#parallel_tuple_cost = 0.1              # same scale as above\n#parallel_setup_cost = 1000.0   # same scale as above\n#min_parallel_table_scan_size = 8MB\n#min_parallel_index_scan_size = 512kB\neffective_cache_size = 666666          # \u7cfb\u7edf\u603b\u5185\u5b58\u51cf\u53bb\u6570\u636e\u5e93shared_buffer\u51cf\u53bb\u5176\u4ed6\u5e94\u7528\u5360\u6709\u7684\u5185\u5b58\u3002 \u7406\u89e3\u4e3a\u6570\u636e\u53ef\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u5927\u5c0f\u3002\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#tcp","title":"TCP \u8fde\u63a5","text":"<p>Linux \u4e2dtcp\u9ed8\u8ba4\u8fde\u63a5\u8d85\u65f6\u65f6\u95f42\u5c0f\u65f6,\u5982\u679c2\u4e2a\u5c0f\u65f6\u6ca1\u6709\u6570\u636e\u5305\u5219\u8ba4\u4e3a\u8be5\u8fde\u63a5\u4e3a\u7a7a\u95f2\u72b6\u6001\uff0c\u7cfb\u7edf\u81ea\u52a8\u5173\u95ed\u3002</p> <pre><code># - TCP Keepalives -\n# see \"man 7 tcp\" for details\n\n#tcp_keepalives_idle = 60                # TCP_KEEPIDLE, in seconds;\n                                        # 0 selects the system default\n#tcp_keepalives_interval = 10            # TCP_KEEPINTVL, in seconds;  \u53d1\u4e2a\u5fc3\u8df3\u6570\u636e\u5305\uff0c\u544a\u8bc9\u7cfb\u7edf\u6211\u6ca1\u6709\u7a7a\u95f2\n                                        # 0 selects the system default\n#tcp_keepalives_count = 6               # TCP_KEEPCNT;\n                                        # 0 selects the system default\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#checkpoint","title":"\u68c0\u67e5\u70b9checkpoint","text":"<p>\u5177\u4f53\u6839\u636e\u78c1\u76d8\u7684\u541e\u5410\u91cf\u8fdb\u884c\u8bbe\u7f6e https://yq.aliyun.com/articles/582847</p> <pre><code>shared_buffers = 64GB                  # 1/4 \u5185\u5b58 \u5982\u679c\u4e0d\u4f7f\u7528huge page\u5efa\u8bae\u4e0d\u8981\u8d85\u8fc732GB   \ncheckpoint_timeout = 30min              # range 30s-1d  \nmax_wal_size = 124GB          # 2*shared_buffers  \nmin_wal_size = 32GB           # shared_buffers * 1/2  \ncheckpoint_completion_target = 0.9 \n</code></pre>","tags":[]},{"location":"postgres/performance/params/#autovacuum","title":"\u5783\u573e\u56de\u6536autovacuum","text":"<pre><code>autovacuum_work_mem = -1 # autovacuum\u6240\u80fd\u4f7f\u7528\u7684\u5185\u5b58\u5927\u5c0f\uff0c\u5f53\u5176\u4e3a-1\u65f6\uff0c\u4f7f\u7528maintenance_work_mem\u53c2\u6570\u7684\u503c\uff0c\u503c\u8d8a\u5927\uff0c\u4f7f\u7528\u7684\u5185\u5b58\u8d8a\u591a\nautovacuum = on # \u662f\u5426\u6253\u5f00autovacuum\nautovacuum_max_workers =3 # \u6700\u591a\u80fd\u591f\u6709\u591a\u5c11\u4e2aautovaccum\u8fdb\u7a0b\u8fd0\u884c\uff0c\u503c\u8d8a\u5927\uff0c\u4f7f\u7528\u7684\u5185\u5b58\u8d8a\u591a\nautovacuum_naptime = 1min  # autovacuum\u8fdb\u7a0b\u95f4\u9694\u591a\u957f\u65f6\u95f4\u5bf9\u8868\u8fdb\u884c\u662f\u5426\u9700\u8981autovacuum\u64cd\u4f5c\nautovacuum_vacuum_threshold = 50 # \u5f53\u8868\u4e0adml\u64cd\u4f5c\u8fbe\u5230\u591a\u5c11\u884c\u65f6\u6267\u884cautovacuum\u64cd\u4f5c\nautovacuum_analyze_threshold = 50  # \u5f53\u8868\u4e0adml\u64cd\u4f5c\u8fbe\u5230\u591a\u5c11\u884c\u65f6\u6267\u884cautovacuum analyze\u64cd\u4f5c\nautovacuum_vacuum_scale_factor = 0.2 # \u5f53\u8868\u4e0adml\u64cd\u4f5c\u8fbe\u5230\u591a\u5c11\u6bd4\u4f8b\u65f6\u6267\u884cautovacuum\u64cd\u4f5c\nautovacuum_analyze_scale_factor = 0.1  # \u5f53\u8868\u4e0adml\u64cd\u4f5c\u8fbe\u5230\u591a\u5c11\u6bd4\u4f8b\u65f6\u6267\u884cautovacuum analyze\u64cd\u4f5c\nautovacuum_vacuum_cost_limit = -1  # autovacuum \u7684cost\u8d85\u8fc7\u6b64\u503c\u65f6\uff0cvacuum\u4f1asleep\u4e00\u6bb5\u65f6\u95f4\uff0c\u4f7f\u7528vacuum_cost_limit\u53c2\u6570\u7684\u503c\uff0c\u503c\u8d8a\u5927\u5bf9\u7cfb\u7edfIO\u538b\u529b\u8d8a\u5927\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#_6","title":"\u5e76\u884c\u8ba1\u7b97","text":"<pre><code>1. \u63a7\u5236\u6574\u4e2a\u6570\u636e\u5e93\u96c6\u7fa4\u540c\u65f6\u80fd\u5f00\u542f\u591a\u5c11\u4e2awork process\uff0c\u5fc5\u987b\u8bbe\u7f6e\u3002\nmax_worker_processes = 128              # (change requires restart)  \n\n2. \u63a7\u5236\u4e00\u4e2a\u5e76\u884c\u7684EXEC NODE\u6700\u591a\u80fd\u5f00\u542f\u591a\u5c11\u4e2a\u5e76\u884c\u5904\u7406\u5355\u5143\uff0c\u540c\u65f6\u8fd8\u9700\u8981\u53c2\u8003\u8868\u7ea7\u53c2\u6570parallel_workers\uff0c\u6216\u8005PG\u5185\u6838\u5185\u7f6e\u7684\u7b97\u6cd5\uff0c\u6839\u636e\u8868\u7684\u5927\u5c0f\u8ba1\u7b97\u9700\u8981\u5f00\u542f\u591a\u5c11\u548c\u5e76\u884c\u5904\u7406\u5355\u5143\u3002  \n\u5b9e\u9645\u53d6\u5c0f\u7684\u3002\nmax_parallel_workers_per_gather = 16    # taken from max_worker_processes\n\n3. \u8ba1\u7b97\u5e76\u884c\u5904\u7406\u7684\u6210\u672c\uff0c\u5982\u679c\u6210\u672c\u9ad8\u4e8e\u975e\u5e76\u884c\uff0c\u5219\u4e0d\u4f1a\u5f00\u542f\u5e76\u884c\u5904\u7406\u3002\n#parallel_tuple_cost = 0.1              # same scale as above\n#parallel_setup_cost = 1000.0   # same scale as above\n\n4. \u5c0f\u4e8e\u8fd9\u4e2a\u503c\u7684\u8868\uff0c\u4e0d\u4f1a\u5f00\u542f\u5e76\u884c\u3002\n#min_parallel_relation_size = 8MB\n\n5. \u544a\u8bc9\u4f18\u5316\u5668\uff0c\u5f3a\u5236\u5f00\u542f\u5e76\u884c\u3002\n#force_parallel_mode = off\n\n6. \u8868\u7ea7\u53c2\u6570\uff0c\u4e0d\u901a\u8fc7\u8868\u7684\u5927\u5c0f\u8ba1\u7b97\u5e76\u884c\u5ea6\uff0c\u800c\u662f\u76f4\u63a5\u544a\u8bc9\u4f18\u5316\u5668\u8fd9\u4e2a\u8868\u9700\u8981\u5f00\u542f\u591a\u5c11\u4e2a\u5e76\u884c\u8ba1\u7b97\u5355\u5143\u3002\nparallel_workers (integer)\n\nalter table t_table set(parallel_workers = 4)\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#synchronous_commit","title":"\u540c\u6b65\u63d0\u4ea4synchronous_commit","text":"<p>\u540c\u6b65\u63d0\u4ea4\u53c2\u6570, \u63a7\u5236\u4e8b\u52a1\u63d0\u4ea4\u540e\u8fd4\u56de\u5ba2\u6237\u7aef\u662f\u5426\u6210\u529f\u7684\u7b56\u7565  \u53ef\u9009\u503c\u4e3a:on, remote_write, local, off</p> <p>on</p> <pre><code>1 \u4e3aon\u4e14\u6ca1\u6709\u5f00\u542f\u540c\u6b65\u5907\u5e93\u7684\u65f6\u5019,\u4f1a\u5f53wal\u65e5\u5fd7\u771f\u6b63\u5237\u65b0\u5230\u78c1\u76d8\u6c38\u4e45\u5b58\u50a8\u540e\u624d\u4f1a\u8fd4\u56de\u5ba2\u6237\u7aef\u4e8b\u52a1\u5df2\u63d0\u4ea4\u6210\u529f, \n2 \u5f53\u4e3aon\u4e14\u5f00\u542f\u4e86\u540c\u6b65\u5907\u5e93\u7684\u65f6\u5019(\u8bbe\u7f6e\u4e86synchronous_standby_names),\u5fc5\u987b\u8981\u7b49\u4e8b\u52a1\u65e5\u5fd7\u5237\u65b0\u5230\u672c\u5730\u78c1\u76d8,\u5e76\u4e14\u8fd8\u8981\u7b49\u8fdc\u7a0b\u5907\u5e93\u4e5f\u63d0\u4ea4\u5230\u78c1\u76d8\u624d\u80fd\u8fd4\u56de\u5ba2\u6237\u7aef\u5df2\u7ecf\u63d0\u4ea4.\n</code></pre> <p>off</p> <pre><code>\u5199\u5230\u7f13\u5b58\u4e2d\u5c31\u4f1a\u5411\u5ba2\u6237\u7aef\u8fd4\u56de\u63d0\u4ea4\u6210\u529f\uff0c\u4f46\u4e5f\u4e0d\u662f\u4e00\u76f4\u4e0d\u5237\u5230\u78c1\u76d8\uff0c\u5ef6\u8fdf\u5199\u5165\u78c1\u76d8,\u5ef6\u8fdf\u7684\u65f6\u95f4\u4e3a\u6700\u59273\u500d\u7684wal_writer_delay\u53c2\u6570\u7684(\u9ed8\u8ba4200ms)\u7684\u65f6\u95f4,\u6240\u6709\u5982\u679c\u5373\u4f7f\u5173\u95edsynchronous_commit,\n\u4e5f\u53ea\u4f1a\u9020\u6210\u6700\u591a600ms\u7684\u4e8b\u52a1\u4e22\u5931,\u6b64\u4e8b\u52a1\u751a\u81f3\u5305\u62ec\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\uff08\u4f1a\u4e22\u6570\u636e\uff09,\u4f46\u6570\u636e\u5e93\u786e\u53ef\u4ee5\u5b89\u5168\u542f\u52a8,\u4e0d\u4f1a\u53d1\u751f\u5757\u6298\u65ad,\u53ea\u662f\u4e22\u5931\u4e86\u90e8\u5206\u6570\u636e,\u4f46\u5bf9\u9ad8\u5e76\u53d1\u7684\u5c0f\u4e8b\u52a1\u7cfb\u7edf\u6765\u8bf4,\u6027\u80fd\u6765\u8bf4\u63d0\u5347\u8f83\u5927\u3002\n</code></pre> <p>remote_write</p> <pre><code>\u5f53\u4e8b\u52a1\u63d0\u4ea4\u65f6,\u4e0d\u4ec5\u8981\u628awal\u5237\u65b0\u5230\u78c1\u76d8,\u8fd8\u9700\u8981\u7b49wal\u65e5\u5fd7\u53d1\u9001\u5230\u5907\u5e93\u64cd\u4f5c\u7cfb\u7edf(\u4f46\u4e0d\u7528\u7b49\u5907\u5e93\u5237\u65b0\u5230\u78c1\u76d8),\u56e0\u6b64\u5982\u679c\u5907\u5e93\u6b64\u65f6\u53d1\u751f\u5b9e\u4f8b\u4e2d\u65ad\u4e0d\u4f1a\u6709\u6570\u636e\u4e22\u5931,\u56e0\u4e3a\u6570\u636e\u8fd8\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a,\n\u800c\u5982\u679c\u64cd\u4f5c\u7cfb\u7edf\u6545\u969c,\u5219\u6b64\u90e8\u5206wal\u65e5\u5fd7\u8fd8\u6ca1\u6709\u6765\u5f97\u53ca\u5199\u5165\u78c1\u76d8\u5c31\u4f1a\u4e22\u5931,\u5907\u5e93\u542f\u52a8\u540e\u8fd8\u9700\u8981\u60f3\u4e3b\u5e93\u7d22\u53d6wal\u65e5\u5fd7\u3002\n</code></pre> <p>local</p> <pre><code>\u5f53\u4e8b\u52a1\u63d0\u4ea4\u65f6,\u4ec5\u5199\u5165\u672c\u5730\u78c1\u76d8\u5373\u53ef\u8fd4\u56de\u5ba2\u6237\u7aef\u4e8b\u52a1\u63d0\u4ea4\u6210\u529f,\u800c\u4e0d\u7ba1\u662f\u5426\u6709\u540c\u6b65\u5907\u5e93\n\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u540c\u6b65\u5907\u5e93,\u5219 on/remote_write/local\u90fd\u662f\u4e00\u6837\u7684,\u4ec5\u7b49\u5f85\u4e8b\u52a1\u5237\u65b0\u5230\u672c\u5730\u78c1\u76d8.\n</code></pre> <p>\u6b64\u53c2\u6570\u8fd8\u53ef\u4ee5\u5c40\u90e8\u8bbe\u7f6e,\u5f53\u6709\u4e34\u65f6\u6279\u91cf\u4efb\u52a1\u65f6\u53ef\u4ee5\u8fd9\u6837\u8bbe\u7f6e: </p> <pre><code>SET LOCAL synchronous_commit TO OFF; \n</code></pre> <p>\u8fd9\u6837\u5c40\u90e8\u4e8b\u52a1\u53ef\u5411\u5907\u5e93\u5f02\u6b65\u7684\u65b9\u5f0f\u540c\u6b65\uff0c\u800c\u5176\u4ed6\u91cd\u8981\u7684\u4e8b\u52a1\u4ee5\u540c\u6b65\u7684\u65b9\u5f0f\u5411\u5907\u5e93\u540c\u6b65\u3002</p>","tags":[]},{"location":"postgres/performance/params/#_7","title":"\u4fee\u6539","text":"<pre><code>postgresql.conf \u670d\u52a1\u5668\u542f\u52a8\u65f6\u9ed8\u8ba4\u8bfb\u53d6\u7684\u914d\u7f6e\n\npostgresql.auto.conf \u4f18\u5148\u7ea7\u9ad8\u4e8epostgresql.conf 9.4\u540e\u5f15\u5165,\u5bf9\u6807oracle sfile pfile \u3002\u3000\u6587\u4ef6\u4e0d\u80fd\u4fee\u6539,\u9700\u8981\u901a\u8fc7ALTER SYSTE\u3000\u4fee\u6539\uff0cALTER SYSTE\u3000RESET | DEFAULT \u5220\u9664\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#_8","title":"\u7b56\u7565","text":"<pre><code>postgresql.conf \u53c2\u6570\u4e3a\u9ed8\u8ba4\u503c,\u4e0d\u505a\u4fee\u6539\uff0c\u4f18\u5316\u53c2\u6570\u901a\u8fc7\u3000postgresql.auto.conf \u4fee\u6539\uff0c\u4e00\u76ee\u4e86\u7136\u3002(\u4e2a\u4eba\u4e60\u60ef)\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#_9","title":"\u67e5\u770b","text":"<pre><code>SELECT name,setting,vartype,boot_val,min_val,max_val,reset_val FROM pg_settings;\n\nshow all;\n</code></pre>","tags":[]},{"location":"postgres/performance/params/#work_mem","title":"work_mem","text":"<p>\u8fd9\u4e9b\u5185\u5b58\u5927\u5c0f\u88ab\u7528\u6765\u5b8c\u6210\u5185\u90e8\u6392\u5e8f\u4e0e\u54c8\u5e0c\u8868\u64cd\u4f5c\u3002 \u5982\u679c\u672a\u5206\u914d\u8db3\u591f\u5185\u5b58\uff0c\u4f1a\u5bfc\u81f4\u7269\u7406I/O\u3002 work_mem\u8fd9\u4e2a\u503c\u662f\u9488\u5bf9\u6bcf\u4e2asession\u7684\uff0c\u6240\u4ee5\u4e0d\u80fd\u8bbe\u7f6e\u7684\u8fc7\u5927\u3002</p>","tags":[]},{"location":"postgres/performance/params/#_10","title":"\u5b9e\u9a8c","text":"<pre><code>\u521b\u5efa\u6d4b\u8bd5\u8868\npostgres=# create table myt (id serial);  \nCREATE TABLE\n\n\u63d2\u5165\u6d4b\u8bd5\u6570\u636e  \npostgres=# insert into myt select generate_series(1,1000000);  \nINSERT 0 1000000  \n\n\u8bbe\u7f6e\u5f53\u524dsession work_mem\n\npostgres=#set work_me '64kb';\nSET  \npostgres=# show work_mem;  \n work_mem  \n----------  \n 64kB  \n(1 row)\n\n\u67e5\u770b\u4e34\u65f6\u6587\u4ef6\u5360\u7528\u60c5\u51b5\nselect temp_files, temp_bytes from pg_stat_database\n temp_files | temp_bytes  \n------------+------------  \n          0 |          0  \n(1 row)  \n\n\u6267\u884c\u6d4b\u8bd5\nselect * from (select * from myt order by id) t limit 1000; \n\n\u518d\u6b21\u67e5\u770b\u4e34\u65f6\u6587\u4ef6\u5360\u7528\u60c5\u51b5\nselect temp_files, temp_bytes from pg_stat_database\n temp_files | temp_bytes\n------------+------------\n          1 |   14016512 \n(1 row)\n\n\u8bbe\u7f6e\u5f53\u524dsession work_mem\n\npostgres=#set work_mem = '16MB';  \nSET\n\n\u6267\u884c\u6d4b\u8bd5\nselect * from (select * from myt order by id) t limit 1000;\n\n\u518d\u6b21\u67e5\u770b\u4e34\u65f6\u6587\u4ef6\u5360\u7528\u60c5\u51b5\nselect temp_files, temp_bytes from pg_stat_database\n temp_files | temp_bytes\n------------+------------\n          1 |   14016512\n</code></pre> <p>\u6ca1\u6709\u65b0\u589e\u4e34\u65f6\u6587\u4ef6 , \u8bf4\u660ework_mem\u5145\u8db3</p>","tags":[]},{"location":"postgres/performance/params/#maintainance_work_mem","title":"maintainance_work_mem","text":"<p>\u4e3b\u8981\u7528\u4e8eanalyzing\uff0cvacuum\uff0ccreate index, reindex\u7b49\u3002</p> <p>\u5982\u9700\u8fdb\u884c\u5982\u4e0a\u64cd\u4f5c\u65f6\u8bf7\u9002\u5f53\u8c03\u6574maintainance_work_mem \u503c\uff0c\u63d0\u9ad8\u6548\u7387</p>","tags":[]},{"location":"postgres/performance/params/#_11","title":"\u5b9e\u9a8c","text":"<p>\u65b9\u6cd5\u4e0e\u4e0a\u9762\u7c7b\u4f3c\uff0c\u5728\u7edf\u8ba1\u8868\u4e2d\u89c2\u5bdf\u4e34\u65f6\u6587\u4ef6\u4f7f\u7528\u60c5\u51b5\u3002</p>","tags":[]},{"location":"postgres/performance/stat/","title":"Postgresql\u6307\u6807\u67e5\u770b&stat\u7edf\u8ba1\u4fe1\u606f","text":"<ul> <li>\u5f53\u524d\u8fde\u63a5\u6570</li> </ul> <pre><code>SELECT count(*) FROM pg_stat_activity WHERE NOT pid=pg_backend_pid();\n count \n-------\n     3\n(1 row)\n\n</code></pre> <ul> <li>\u6570\u636e\u5e93\u5360\u7528\u7a7a\u95f4</li> </ul> <pre><code>select pg_size_pretty(pg_database_size('postgres'));\n pg_size_pretty \n----------------\n 14 MB\n(1 row)\n\nor\n\n\\l+\n\n</code></pre> <ul> <li>\u6570\u636e\u5e93\u8868(\u4e0d\u5305\u62ec\u7d22\u5f15)\u6216\u5355\u6761\u7d22\u5f15\u5360\u7528\u7a7a\u95f4</li> </ul> <pre><code>select pg_size_pretty(pg_relation_size('t_name'));\n pg_size_pretty \n----------------\n 24 kB\n(1 \u884c\u8bb0\u5f55)\n\nor\n\n\\d+\n</code></pre> <ul> <li>\u8868\u4e2d\u6240\u6709\u7d22\u5f15\u5360\u6709\u7684\u7a7a\u95f4</li> </ul> <pre><code>select pg_size_pretty(pg_indexes_size('t_name'));\n pg_size_pretty \n----------------\n 280 kB\n(1 \u884c\u8bb0\u5f55)\n</code></pre> <ul> <li>\u8868\u4e2d\u7d22\u5f15\u5360\u7528\u7684\u7a7a\u95f4\u5927\u5c0f\u6392\u5e8f</li> </ul> <pre><code>select indexname ,  pg_size_pretty(pg_relation_size(indexname::regclass)) ,indexdef \nfrom pg_indexes where tablename = 't_name' \norder by pg_relation_size(indexname::regclass) desc limit 10;\n</code></pre> <ul> <li>\u8868\u548c\u7d22\u5f15\u5360\u7528\u603b\u7a7a\u95f4</li> </ul> <pre><code>select pg_size_pretty(pg_total_relation_size('t_name'));\n pg_size_pretty\n----------------\n 380 kB\n(1 \u884c\u8bb0\u5f55)\n</code></pre> <ul> <li>\u67e5\u770b\u4e00\u6761\u6570\u636e\u5728\u6570\u636e\u5e93\u5360\u7528\u7684\u7a7a\u95f4</li> </ul> <pre><code>select pg_column_size('Let us go !!!');\n pg_column_size \n----------------\n             14\n(1 \u884c\u8bb0\u5f55)\n\n</code></pre> <ul> <li>\u67e5\u51fa\u6240\u6709\u8868\uff08\u5305\u542b\u7d22\u5f15\uff09\u5e76\u6392\u5e8f</li> </ul> <pre><code>SELECT table_schema || '.' || table_name AS table_full_name, pg_size_pretty(pg_total_relation_size('\"' || table_schema || '\".\"' || table_name || '\"')) AS size\nFROM information_schema.tables\nORDER BY\npg_total_relation_size('\"' || table_schema || '\".\"' || table_name || '\"') DESC limit 10;\n</code></pre> <ul> <li>\u67e5\u51fa\u8868\u5927\u5c0f\u6309\u5927\u5c0f\u6392\u5e8f\u5e76\u5206\u79bbdata\u4e0eindex</li> </ul> <pre><code>SELECT\ntable_name,\npg_size_pretty(table_size) AS table_size,\npg_size_pretty(indexes_size) AS indexes_size,\npg_size_pretty(total_size) AS total_size\nFROM (\nSELECT\ntable_name,\npg_table_size(table_name) AS table_size,\npg_indexes_size(table_name) AS indexes_size,\npg_total_relation_size(table_name) AS total_size\nFROM (\nSELECT ('\"' || table_schema || '\".\"' || table_name || '\"') AS table_name\nFROM information_schema.tables\n) AS all_tables\nORDER BY total_size DESC\n) AS pretty_sizes;\n</code></pre> <ul> <li>\u5176\u4ed6</li> </ul> <pre><code>pg_stat_database\npg_stat_all_tables\npg_stat_sys_tables\npg_stat_user_tables\npg_stat_all_indexes\npg_stat_sys_indexes\npg_stat_user_indexes\n</code></pre> <pre><code>postgres=# select * from pg_stat_database where datname='postgres';\n-[ RECORD 1 ]-----+------------------------------\ndatid             | 13510                 #\u6570\u636e\u5e93oid\ndatname           | postgres              #\u6570\u636e\u5e93\u540d\nnumbackends       | 98                    #\u8bbf\u95ee\u5f53\u524d\u6570\u636e\u5e93\u8fde\u63a5\u6570\u91cf\nxact_commit       | 14291309              #\u8be5\u6570\u636e\u5e93\u4e8b\u52a1\u63d0\u4ea4\u603b\u91cf\nxact_rollback     | 0                     #\u8be5\u6570\u636e\u5e93\u4e8b\u52a1\u56de\u6eda\u603b\u91cf\nblks_read         | 536888                #\u603b\u78c1\u76d8\u7269\u7406\u8bfb\u7684\u5757\u6570\uff0c\u8fd9\u91ccread\u4e5f\u53ef\u80fd\u662f\u4ecepage cache\u8bfb\u53d6\uff0c\u5982\u679c\u8fd9\u91cc\u5f88\u9ad8\u9700\u8981\u7ed3\u5408blk_read_time\u770b\u662f\u5426\u771f\u7684\u5b58\u5728\u5f88\u591a\u5b9e\u9645\u4ece\u78c1\u76d8\u8bfb\u53d6\u7684\u60c5\u51b5\u3002\nblks_hit          | 261717850             #\u5728shared_buffer\u547d\u4e2d\u7684\u5757\u6570\ntup_returned      | 58521416              #\u5bf9\u4e8e\u8868\u6765\u8bf4\u662f\u5168\u8868\u626b\u63cf\u7684\u884c\u6570\uff0c\u5bf9\u4e8e\u7d22\u5f15\u662f\u901a\u8fc7\u7d22\u5f15\u65b9\u6cd5\u8fd4\u56de\u7684\u7d22\u5f15\u884c\u6570\uff0c\u5982\u679c\u8fd9\u4e2a\u503c\u6570\u91cf\u660e\u663e\u5927\u4e8etup_fetched\uff0c\u8bf4\u660e\u5f53\u524d\u6570\u636e\u5e93\u5b58\u5728\u5927\u91cf\u5168\u8868\u626b\u63cf\u7684\u60c5\u51b5\u3002\ntup_fetched       | 57193639              #\u6307\u901a\u8fc7\u7d22\u5f15\u8fd4\u56de\u7684\u884c\u6570\ntup_inserted      | 14293061              #\u63d2\u5165\u7684\u884c\u6570\ntup_updated       | 42868451              #\u66f4\u65b0\u7684\u884c\u6570\ntup_deleted       | 98                    #\u5220\u9664\u7684\u884c\u6570\nconflicts         | 0                     #\u4e0e\u6062\u590d\u51b2\u7a81\u53d6\u6d88\u7684\u67e5\u8be2\u6b21\u6570(\u53ea\u4f1a\u5728\u5907\u5e93\u4e0a\u53d1\u751f)\ntemp_files        | 0                     #\u4ea7\u751f\u4e34\u65f6\u6587\u4ef6\u7684\u6570\u91cf\uff0c\u5982\u679c\u8fd9\u4e2a\u503c\u5f88\u9ad8\u8bf4\u660ework_mem\u9700\u8981\u8c03\u5927\ntemp_bytes        | 0                     #\u4e34\u65f6\u6587\u4ef6\u7684\u5927\u5c0f\ndeadlocks         | 0                     #\u6b7b\u9501\u7684\u6570\u91cf\uff0c\u5982\u679c\u8fd9\u4e2a\u503c\u5f88\u5927\u8bf4\u660e\u4e1a\u52a1\u903b\u8f91\u6709\u95ee\u9898\nblk_read_time     | 0                     #\u6570\u636e\u5e93\u4e2d\u82b1\u8d39\u5728\u8bfb\u53d6\u6587\u4ef6\u7684\u65f6\u95f4\uff0c\u8fd9\u4e2a\u503c\u8f83\u9ad8\u8bf4\u660e\u5185\u5b58\u8f83\u5c0f\uff0c\u9700\u8981\u9891\u7e41\u7684\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u6570\u636e\u6587\u4ef6\nblk_write_time    | 0                     #\u6570\u636e\u5e93\u4e2d\u82b1\u8d39\u5728\u5199\u6570\u636e\u6587\u4ef6\u7684\u65f6\u95f4\uff0cpg\u4e2d\u810f\u9875\u4e00\u822c\u90fd\u5199\u5165page cache\uff0c\u5982\u679c\u8fd9\u4e2a\u503c\u8f83\u9ad8\uff0c\u8bf4\u660epage cache\u8f83\u5c0f\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684page cache\u9700\u8981\u66f4\u79ef\u6781\u7684\u5199\u5165\u3002\nstats_reset       | 2019-04-09 14:06:53.416473+08 #\u7edf\u8ba1\u4fe1\u606f\u91cd\u7f6e\u7684\u65f6\u95f4\n</code></pre> <p>\u901a\u8fc7pg_stat_database\u6211\u4eec\u5c31\u53ef\u4ee5\u5927\u6982\u4e86\u89e3\u6570\u636e\u5e93\u7684\u5386\u53f2\u60c5\u51b5\uff0c\u6bd4\u5982\u770b\u5230tup_returned\u503c\u8fdc\u5927\u4e8etup_fetched\uff0c\u8bf4\u660e\u6570\u636e\u5e93\u5386\u53f2\u6267\u884c\u7684sql\u5f88\u591a\u90fd\u662f\u5168\u8868\u626b\u63cf\uff0c\u8bf4\u660e\u5b58\u5728\u5f88\u591a\u6ca1\u6709\u8d70\u7d22\u5f15\u7684sql\uff0c\u8fd9\u65f6\u5019\u53ef\u4ee5\u7ed3\u5408pg_stat_statments\u6765\u67e5\u627e\u6162sql\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7pg_stat_user_tables\u627e\u5230\u5168\u8868\u626b\u63cf\u6b21\u6570\u548c\u884c\u6570\u6700\u591a\u7684\u8868\u3002\u901a\u8fc7\u770b\u5230tup_updated\u5f88\u9ad8\u8bf4\u660e\u6570\u636e\u5e93\u6709\u5f88\u9891\u7e41\u7684\u66f4\u65b0\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u5173\u6ce8\u4e00\u4e0bvacuum\u76f8\u5173\u7684\u6307\u6807\u548c\u957f\u4e8b\u52a1\uff0c\u5982\u679c\u6ca1\u6709\u53ca\u65f6\u8fdb\u884c\u5783\u573e\u56de\u6536\u4f1a\u9020\u6210\u6570\u636e\u81a8\u80c0\u7684\u6bd4\u8f83\u5389\u5bb3\u3002\u5982\u679ctemp_files\u8f83\u9ad8\u7684\u8bdd\u8bf4\u660e\u5b58\u5728\u5f88\u591a\u7684\u6392\u5e8f\uff0chash\uff0c\u6216\u8005\u805a\u5408\u8fd9\u79cd\u64cd\u4f5c\uff0c\u53ef\u4ee5\u901a\u8fc7\u589e\u5927work_mem\u51cf\u5c11\u4e34\u65f6\u6587\u4ef6\u7684\u4ea7\u751f\uff0c\u5e76\u4e14\u540c\u65f6\u8fd9\u4e9b\u64cd\u4f5c\u7684\u6027\u80fd\u4e5f\u4f1a\u6709\u8f83\u5927\u7684\u63d0\u5347\u3002</p> <p>https://yq.aliyun.com/articles/697692?spm=5176.10695662.1996646101.searchclickresult.28b6528caEAf7X</p>"},{"location":"postgres/performance/thinking_in_db_performance/","title":"\u6570\u636e\u5e93\u4f18\u5316\u601d\u8003-\u6027\u80fd\u4f18\u5316","text":"","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_performance/#_1","title":"\u4e3a\u4ec0\u4e48\u8981\u4f18\u5316","text":"<p>\u9996\u5148\u4e86\u89e3\u4e00\u4e2a\u6982\u5ff5\uff0c\u4ec0\u4e48\u662f\u00b7\u71b5\u589e\u00b7</p> <p>\u7269\u7406\u5b9a\u4e49\uff1a\u71b5\u589e\u8fc7\u7a0b\u662f\u4e00\u4e2a\u81ea\u53d1\u7684\u7531\u6709\u5e8f\u5411\u65e0\u5e8f\u53d1\u5c55\u7684\u8fc7\u7a0b(Bortz, 1986; Roth, 1993)</p> <p>\u5728\u4e00\u4e2a\u5b64\u7acb\u7684\u7cfb\u7edf\u91cc\uff0c\u5982\u679c\u6ca1\u6709\u5916\u529b\u505a\u5de5\uff0c\u5176\u603b\u6df7\u4e71\u5ea6\uff08\u5373\u71b5\uff09\u4f1a\u4e0d\u65ad\u589e\u5927\uff0c\u76f4\u81f3\u7cfb\u7edf\u5f7b\u5e95\u53d8\u5f97\u65e0\u5e8f</p> <p>\u4ece\u7cfb\u7edf\u8f6f\u4ef6\u7684\u89d2\u5ea6\uff1a \u4ece\u5e94\u7528\u7cfb\u7edf\u4e0a\u7ebf\u90a3\u4e00\u523b\u5f00\u59cb\uff0c\u968f\u7740\u7528\u6237\u91cf\u7684\u589e\u52a0\u3001\u4e1a\u52a1\u529f\u80fd\u7684\u6301\u7eed\u8fed\u4ee3\uff0c\u7cfb\u7edf\u4f1a\u9762\u4e34\u5404\u79cd\u4e0d\u540c\u7a0b\u5ea6\u7684\u6311\u6218\uff0c\u5982\u679c\u4e0d\u53ca\u65f6\u91c7\u53d6\u4f18\u5316\u63aa\u65bd\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u8bf8\u591a\u95ee\u9898</p> <p>\u6bd4\u5982\uff1a\u7cfb\u7edf\u600e\u4e48\u8d8a\u6765\u8d8a\u6162\u4e86\uff0c\u6d41\u91cf\u4e00\u9ad8\u7cfb\u7edf\u5c31\u5361\u987f\u3001\u751a\u81f3\u5b95\u673a\u7b49\u7b49\u3002</p> <p>\u53ef\u4ee5\u8bf4\uff0c\u6027\u80fd\u4f18\u5316\u662f\u8d2f\u7a7f\u5728\u6574\u4e2a\u8f6f\u4ef6\u751f\u547d\u5468\u671f\u4e4b\u4e2d\u7684</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_performance/#_2","title":"\u901a\u5e38\u6709\u54ea\u4e9b\u4f18\u5316\u65b9\u6cd5","text":"<ul> <li>\u7ed3\u6784\u4f18\u5316</li> <li>\u6027\u80fd\u4f18\u5316</li> <li>\u6a21\u5757\u4f18\u5316</li> </ul> <p>\u5728\u7b97\u6cd5\u9886\u57df\uff0c\u8bc4\u4ef7\u4e00\u4e2a\u7b97\u6cd5\u7684\u6548\u7387\u5982\u4f55\uff0c\u4e3b\u8981\u4f1a\u770b\u5b83\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u548c\u7a7a\u95f4\u590d\u6742\u5ea6\u60c5\u51b5\u3002</p> <p>\u5f15\u7528\u5728\u6570\u636e\u5e93\u7684\u4f18\u5316\u4e2d\uff0c</p> <p>\u65f6\u95f4\u590d\u6742\u5ea6\uff1a \u7740\u91cd\u8003\u91cf\u7684\u662f\u65f6\u95f4\u6210\u672c\uff0c\u6548\u7387\u3002 \u901a\u5e38\u7406\u89e3\u6210\u6027\u80fd\u4f18\u5316\uff0c\u5982\u4f55\u8ba9\u6211\u7684\u8bbf\u95ee\u66f4\u5feb</p> <p>\u7a7a\u95f4\u590d\u6742\u5ea6\uff1a \u7740\u91cd\u8003\u91cf\u7684\u662f\u8d44\u6e90\u6210\u672c\u3002\u53ef\u5bf9\u5e94\u7ed3\u6784\u4f18\u5316\uff0c\u5982\u679c\u7ec4\u7ec7\u6570\u636e\u7684\u5b58\u653e\u3002</p> <p>\u90a3\u4e48\uff0c\u5728\u505a\u4f18\u5316\u65f6\uff0c\u672c\u8d28\u4e0a\u4e5f\u662f\u4ece\u201c\u4f18\u5316\u65f6\u95f4\u201d\u3001\u201c\u4f18\u5316\u7a7a\u95f4\u201d\u3001\u201c\u65f6\u7a7a\u4e92\u6362\uff08\u7528\u65f6\u95f4\u6362\u7a7a\u95f4\u6216\u7528\u7a7a\u95f4\u6362\u65f6\u95f4\uff09\u201d\u4e09\u4e2a\u65b9\u5411\u53bb\u601d\u8003\uff0c\u7136\u540e\u5728\u7a7a\u95f4\u3001\u65f6\u95f4\u4e0a\u4e0d\u505c\u5730\u505a\u53d6\u820d\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_performance/#_3","title":"\u4f18\u5316\u8861\u91cf\u6307\u6807","text":"<p>\u7cfb\u7edf\u4f18\u5316\u7684\u76ee\u6807\u63d0\u9ad8\u7cfb\u7edf\u7684\u541e\u5410\u91cf\uff1a\u5355\u4f4d\u65f6\u95f4\u5185\u80fd\u591f\u5904\u7406\u7684\u8bf7\u6c42\u6570\u91cf</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\u3002\u628a\u7cfb\u7edf\u6bd4\u4f5c\u4e00\u4e2a\u94f6\u884c\u8425\u4e1a\u7f51\u70b9\u3002 \u6709\u591a\u4e2a\u7a97\u53e3\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002 \u5982\u4f55\u80fd\u591f\u63d0\u9ad8\u6574\u4f53\u7684\u5904\u7406\u91cf\u5462\uff1f</p> <ul> <li> <p>\u7a7a\u95f4 \u589e\u52a0\u8425\u4e1a\u7a97\u53e3  </p> </li> <li> <p>\u65f6\u95f4 \u63d0\u9ad8\u6bcf\u4e2a\u7a97\u53e3\u7684\u6548\u7387</p> </li> </ul> <p>\u5173\u4e8e\u7a7a\u95f4\u7684\u4f18\u5316\u53c2\u89c1\u6570\u636e\u5e93\u4f18\u5316\u601d\u8003 - \u7ed3\u6784\u8bbe\u8ba1, \u672c\u7bc7\u66f4\u591a\u601d\u8003\u7684\u662f\u6027\u80fd\uff08\u65f6\u95f4\uff09\u7684\u4f18\u5316\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_performance/#_4","title":"\u6027\u80fd\u4f18\u5316\u7684\u8861\u91cf\u6307\u6807","text":"<p>\u54cd\u5e94\u65f6\u95f4(RT), \u5305\u62ec</p> <ul> <li>\u5e73\u5747\u54cd\u5e94\u65f6\u95f4(AVG)</li> </ul> <p>\u63a5\u53e3\u7684\u5e73\u5747\u5904\u7406\u80fd\u529b\uff0c \u4f46\u4ec0\u4e48\u4e1c\u897f\u4e00\u5e73\u5747\u5f88\u591a\u5c31\u88ab\u5e73\u5747\u4e86\uff0c\u5982\u4eba\u5747\u6536\u5165\uff01\ud83d\ude13\u3002 \u4e0d\u80fd\u5f88\u597d\u53cd\u5e94\u771f\u5b9e\u60c5\u51b5\u3002\u53e6\u4e00\u79cd\u7c7b\u4f3c\u4e2d\u4f4d\u6570\u7684\u6307\u6807\u3002</p> <ul> <li>\u767e\u5206\u4f4d\u6570(Top Percentile) </li> </ul> <p>\u4e00\u79cd\u7edf\u8ba1\u5b66\u672f\u8bed\uff0c\u53cd\u6620\u7684\u662f\u8d85\u8fc7n%\u7684\u8bf7\u6c42\u90fd\u5728m\u65f6\u95f4\u5185\u8fd4\u56de\uff0c\u4e00\u822c\u7528TPn=m\u6765\u63cf\u8ff0\uff0c\u6bd4\u5982\uff1aTP99=5\uff0c\u8868\u793a\u8d85\u8fc799%\u7684\u8bf7\u6c42\u90fd\u80fd\u57285ms\u5185\u8fd4\u56de\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_performance/#_5","title":"\u4f18\u5316\u5982\u4f55\u5177\u4f53\u505a","text":"<p>\u5f00\u53d1\u7aef\uff1a </p> <ul> <li> <p>\u5b9e\u73b0\u65b9\u6cd5 \u6761\u6761\u5927\u8def\u901a\u7f57\u9a6c\uff0c\u5b9e\u73b0\u7684\u529f\u80fd\u662f\u5426\u53ea\u6ee1\u8db3\u4e1a\u52a1\u529f\u80fd\u7684\u9700\u6c42\uff0c\u800c\u6ca1\u6709\u8003\u8651\u6027\u80fd\u3002</p> </li> <li> <p>\u7d22\u5f15 \u7d22\u5f15\u7528\u7684\u597d\uff0c\u6027\u80fd\u6ca1\u70e6\u607c\u3002\u5927\u90e8\u5206\u5e94\u7528\u7aef\u7684\u6027\u80fd\u95ee\u9898\u90fd\u53ef\u4ee5\u901a\u8fc7\u7d22\u5f15\u6765\u6539\u5584\u3002</p> </li> </ul> <p>\u7d22\u5f15\u672c\u8eab\u4e5f\u662f\u4e00\u79cd\u7a7a\u95f4\u6362\u65f6\u95f4\u7684\u624b\u6bb5\u3002\u7d22\u5f15\u672c\u8eab\u4e5f\u662f\u9700\u8981\u989d\u5916\u7684\u4ee3\u4ef7\u3002</p> <ul> <li>\u9501\u7b49\u5f85 \u6700\u6f2b\u957f\u7684\u83ab\u8fc7\u4e8e\u7b49\u5f85\u3002</li> </ul> <p>\u8fd0\u7ef4\u7aef\uff1a </p> <p>\u901a\u8fc7\u6027\u80fd\u6307\u6807\u76d1\u63a7\u9a8c\u8bc1\u4f18\u5316\u6210\u679c\uff0c\u5982</p> <ul> <li>TPS</li> <li>\u6162sql</li> <li>\u7f13\u5b58\u547d\u4e2d\u7387</li> <li>\u9891\u7e41sql- top10</li> <li>\u4e0d\u7a33\u5b9asql - top10</li> <li>\u7d22\u5f15\u5229\u7528\u7387</li> <li>TPn</li> </ul> <p>DBA\uff1a </p> <p>\u901a\u8fc7\u6267\u884c\u8ba1\u5212\u5bf9\u5177\u4f53sql\u8fdb\u884c\u8c03\u4f18</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/","title":"\u6570\u636e\u5e93\u4f18\u5316\u601d\u8003 - \u6a21\u5757\u8c03\u4f18","text":"","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#_1","title":"\u5f00\u59cb\u4e71\u8bf4","text":"<p>\u4e3b\u8981\u662f\u7ed3\u5408postgres\u6570\u636e\u5e93\u81ea\u8eab\u7279\u70b9\uff0c\u6839\u636e\u5177\u4f53\u7684\u4e1a\u52a1\u573a\u666f\uff0c\u4f5c\u51fa\u76f8\u5e94\u8c03\u6574\uff0c\u4f7f\u5176\u66f4\u52a0\u5408\u7406\u3002</p> <p>\u6570\u636e\u5e93\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u5355\u662f\u5176\u5185\u90e8\u662f\u7531\u4e0d\u540c\u7684\u529f\u80fd\u6a21\u5757\u7ec4\u6210\uff0c\u76f8\u4e92\u534f\u8c03\u6765\u5171\u540c\u5b8c\u6210\u4efb\u52a1\u3002</p> <p>\u5404\u4e2a\u529f\u80fd\u6a21\u5757\u5b8c\u6210\u4e0d\u540c\u7684\u529f\u80fd\uff0c\u6bcf\u4e2a\u6a21\u5757\u7684\u7279\u70b9\u4e5f\u4e0d\u540c\uff0c\u5728\u8c03\u6574\u7684\u65f6\u5019\u81f3\u5c11\u9700\u8981\u7406\u89e3\u5404\u4e2a\u6a21\u5757\u5b9e\u73b0\u7684\u57fa\u672c\u539f\u7406\uff08\u5c5e\u4e8e\u5185\u529f\u9700\u4fee\u70bc\uff09\u624d\u597d\u4e0b\u624b\u3002</p> <p>\u5404\u4e2a\u529f\u80fd\u6a21\u5757\u53c8\u76f8\u4e92\u5f71\u54cd\uff0c\u5171\u4eab\u8d44\u6e90\uff0c\u4e5f\u5c31\u662f\u4ed6\u4eec\u4e4b\u95f4\u4f1a\u5b58\u5728\u7ade\u4e89\u8d44\u6e90\u3002\u6bd4\u5982\u5f53\u7cfb\u7edf\u53d1\u751fgc\u65f6\u5bf9\u51e0\u4e4e\u5404\u4e2a\u6a21\u5757\u90fd\u4f1a\u4ea7\u751f\u5f71\u54cd\u3002</p> <p>\u6709\u4e9b\u95ee\u9898\u53ef\u80fd\u662f\u591a\u4e2a\u6a21\u5757\u5171\u540c\u4ea7\u751f\u7684\u3002 \u6700\u5e38\u89c1\u7684\u5982\u4e00\u6761\u6162sql\uff0c\u53ef\u80fd\u5f15\u8d77\u7684\u539f\u56e0\u53ef\u80fd\u662f\u7d22\u5f15\u4e0d\u5408\u7406\uff0c\u6267\u884c\u8ba1\u5212\u8dd1\u504f\uff0csql\u672c\u8eab\u95ee\u9898\uff0clock, \u5f53\u65f6\u7cfb\u7edf\u6b63\u5728gc\u3002\u7b49\u7b49\u3002</p> <p>\u6570\u636e\u5e93\u4f5c\u4e3a\u4e00\u4e2a\u4ea7\u54c1\uff0c\u4e3a\u4e86\u9002\u5e94\u66f4\u5e7f\u6cdb\u7684\u573a\u666f\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\u9ed8\u8ba4\u8bbe\u7f6e\u90fd\u6bd4\u8f83\u4fdd\u5b88\u3002\u9ed8\u8ba4\u7684\u8bbe\u7f6e\u80fd\u591f\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u6ee1\u8db3\u7684\u7684\u9700\u6c42\uff0c\u4f46\u662f\u5728\u5bf9\u6027\u80fd\u7528\u6240\u8981\u6c42\u7684\u751f\u4ea7\u73af\u5883\u4e0b\u9700\u5fc5\u8981\u7684\u8c03\u6574\uff0c\u751a\u81f3\u4f1a\u79c1\u4eba\u5b9a\u5236\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#_2","title":"\u4e0d\u540c\u573a\u666f\u533a\u522b\u5bf9\u5f85","text":"<p>\u573a\u666f\u4e3b\u8981\u5206\u4e3aTP\u3001AP\u4e24\u79cd\u573a\u666f\u3002</p> <p>\u4e0d\u540c\u7684\u4f7f\u7528\u573a\u666f\u4f18\u5316\u7684\u65b9\u5411\u5e94\u8be5\u662f\u4e0d\u540c\u7684\uff0c\u4fa7\u91cd\u70b9\u4e5f\u4f1a\u4e0d\u540c\u3002</p> <p>TP \u5f3a\u8c03\u7684\u77ed\u5e73\u5feb\uff0c\u6ce8\u91cdTPS\u3002\u76f8\u5f53\u4e8e\u8dd1\u8f66\u8ffd\u6c42\u901f\u5ea6\uff0c\u6548\u7387\u3002</p> <p>AP \u5f3a\u8c03\u7684\u541e\u5410\u91cf\uff0c\u76f8\u5f53\u4e8e\u5927\u5361\u8f66\u3002</p> <p>\u9488\u5bf9\u4e0d\u540c\u8f66\u8f86\u8bbe\u8ba1\u4e0d\u540c\u7684\u9053\u8def\u624d\u5408\u7406\u3002</p> <p>\u5728\u8dd1\u8f66\u7684\u8d5b\u9053\u4e0a\u5f00\u6765\u4e00\u8f86\u5927\u5361\u8f66\uff0c\u5f7c\u6b64\u4f24\u5bb3\u3002TP\u5982\u679c\u4e0d\u5e78\u5c31\u6b64\u6302\u6389\uff0c\u771f\u7684\u4e0d\u80fd\u8bf4\u662f\u7cfb\u7edf\u4e0d\u591f\u5065\u58ee\u3002</p> <p>\u8865\u5145\uff1a \u6162Sql\u53ef\u89c6\u4e3aTP\u7cfb\u7edf\u6027\u80fd\u4e0a\u7684bug , \u9ad8\u901f\u8fd0\u884c\u7684\u5217\u8f66\uff0c\u98de\u673a\u4efb\u4f55\u78b0\u649e\u90fd\u662f\u81f4\u547d\u7684\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#tp-sql","title":"TP \u7cfb\u7edf\u4e2d\u4e00\u6761\u6162Sql\u7684\u4f24\u5bb3","text":"<ul> <li>\u4f24\u78c1\u76d8IO</li> <li>\u4f24\u7cfb\u7edfCUP</li> <li>\u4f24\u7cfb\u7edf\u5185\u5b58</li> <li>\u4f24\u6570\u636e\u5e93MVCC LOCK VACUUM</li> <li>\u4f24\u7cfb\u7edf\u7edf\u8ba1\u4fe1\u606f\u3001temp</li> <li>\u4f24\u6570\u636e\u5e93\u7f13\u5b58</li> <li>\u4f24\u6570\u636e\u5e93\u8fde\u63a5\u6570</li> </ul>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#_3","title":"\u76d1\u6d4b\u5f88\u91cd\u8981","text":"<p>\u4f60\u662f\u6211\u7684\u773c \ud83d\udc40</p> <p>\u4f5c\u7528</p> <ul> <li> <p>\u65e9\u671f\u53d1\u73b0\u95ee\u9898</p> </li> <li> <p>\u8bc4\u4f30\u8c03\u6574\u540e\u6548\u679c</p> </li> </ul> <p>\u5de5\u5177</p> <ul> <li> <p>\u76d1\u63a7\u7cfb\u7edf</p> </li> <li> <p>\u65e5\u5fd7\u7cfb\u7edf</p> </li> </ul>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#_4","title":"\u529f\u80fd\u6a21\u5757\u6982\u89c8","text":"<ul> <li>vacuum</li> </ul> <p>\u907f\u514d\u5728\u9ad8\u5cf0\u65f6\u53d1\u751f\uff0c\u53c8\u80fd\u53ca\u65f6\u5904\u7406\uff0c\u907f\u514d\u8868\u81a8\u80c0\u3002\u8c03\u6574\u89e6\u53d1\u6761\u4ef6\u53ca\u624b\u52a8\u89e6\u53d1</p> <ul> <li>checkpoint</li> </ul> <p>\u9891\u7387\uff0cIO\u5e73\u6ed1\u5ea6</p> <ul> <li>sql</li> </ul> <p>\u6ee1\u8db3\u529f\u80fd\u540c\u65f6\u662f\u5426\u8003\u8651\u6027\u80fd</p> <ul> <li>wal</li> </ul> <p>\u8f93\u51fa\u91cf\uff0cFPI</p> <ul> <li>hotupdate </li> </ul> <p>\u70ed\u66f4\u65b0\u6bd4\u4f8b \u8c03\u6574fillfactor</p> <ul> <li>\u7f13\u5b58 buffer </li> </ul> <p>\u547d\u4e2d\u7387 \u662f\u5426\u4ea7\u751ftempfile</p> <ul> <li>\u7d22\u5f15 index</li> </ul> <p>\u5229\u7528\u7387\uff0c\u9700\u8981\u52a0\uff0c\u6ca1\u5fc5\u8981\u7684\u5220</p> <ul> <li>\u9501 lock</li> </ul> <p>\u9501\u7b49\u5f85,\u6b7b\u9501</p> <ul> <li>SQL</li> </ul> <p>\u4f7f\u7528\u662f\u5426\u5408\u7406</p> <p></p> <p>\u4e00\u53f0\u5e94\u7528\u7684\u6574\u4f53\u63d0\u4f9b\u670d\u52a1\u7684\u80fd\u529b\u540c\u6837\u53d6\u51b3\u4e8e\u6700\u77ed\u7684\u90a3\u5757\u677f\u5b50\uff0c\u5c06\u6700\u77ed\u7684\u90a3\u5757\u677f\u5b50\u6027\u80fd\u63d0\u5347\u5c06\u4f1a\u63d0\u5347\u6574\u4e2a\u5e94\u7528\u7684\u670d\u52a1\u80fd\u529b\u3002</p> <p>\u521d\u671f\u901a\u5e38\u5c40\u90e8\u7684\u4f18\u5316\u6548\u679c\u4f18\u4e8e\u52a0\u4e00\u4e2a\u540c\u6837\u914d\u7f6e\u7684\u670d\u52a1\u5668\u3002</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#_5","title":"\u5177\u4f53\u4f18\u5316\u63aa\u65bd","text":"","tags":["\u4f18\u5316"]},{"location":"postgres/performance/thinking_in_db_tune/#_6","title":"\u5927\u91cf\u5199\u573a\u666f","text":"<ul> <li>\u5220\u9664 \u65e0\u7528\u7684index</li> </ul> <p>\u7d22\u5f15\u7684\u7ef4\u62a4\u9700\u8981\u989d\u5916\u7684\u4ee3\u4ef7</p> <ul> <li>\u529b\u4e89 hotupdate </li> </ul> <p>\u65b0\u65e7\u6570\u636e\u5728\u4e00\u4e2apage\u4e2d</p> <ul> <li>\u8c03\u6574 fillfactor</li> </ul> <p>\u589e\u52a0hotupdate\u6bd4\u4f8b</p> <ul> <li>\u53ea\u66f4\u65b0\u53d8\u5316\u7684\u5217</li> </ul> <p>\u964d\u4f4eIO\uff0c\u7f51\u7edc\uff0cwal\u65e5\u5fd7\u7684\u4f53\u91cf</p> <ul> <li>\u6279\u91cf\u66f4\u65b0\uff0c\u4e00\u4e2a\u4e8b\u52a1\u66f4\u65b0\u591a\u6761\u8bb0\u5f55</li> </ul> <p>\u6279\u64cd\u4f5c\uff0c\u51cf\u5c11\u8fde\u63a5\u4e8b\u52a1\u5f00\u9500</p> <ul> <li>\u9501</li> </ul> <p>\u4e8b\u52a1\u4e4b\u95f4\u76f8\u4e92\u7b49\u5f85\uff0c\u76f8\u4e92\u8e29\u8e0f</p> <ul> <li>where \u6761\u4ef6\u7d22\u5f15\u5229\u7528\u60c5\u51b5\uff0c\u66f4\u65b0\u524d\u9700\u8981\u67e5\u627e\u5177\u4f53\u8bb0\u5f55</li> </ul> <p>\u5feb\u901f\u5b9a\u4f4d\u76ee\u6807\u6570\u636e\u6240\u5728\u7684\u4f4d\u7f6e</p> <ul> <li>\u76d1\u63a7\u8868\u7a7a\u95f4\u81a8\u80c0</li> </ul> <p>\u66f4\u65b0\u4f7f\u7528\u4e86mvcc \u6280\u672f\uff0c\u5229\u7528\u7a7a\u95f4\u6765\u8282\u7701\u65f6\u95f4\u3002\u540c\u65f6\u5e26\u6765\u4e86\u7a7a\u95f4\u81a8\u80c0\u3002\u95f2\u65f6\u5904\u7406</p> <ul> <li>checkpoint</li> </ul> <p>\u964d\u4f4echeckpoint\u53d1\u751f\u9891\u7387\u53ca\u5267\u70c8\u7a0b\u5ea6\u3002\u51cf\u5c11FPI</p> <ul> <li>\u9891\u7e41\u66f4\u65b0\u4e1a\u52a1</li> </ul> <p>\u9891\u7e41\u66f4\u65b0\uff0c\u6307\u7684\u662f\u540c\u4e00\u6761\u8bb0\u5f55\u7684\u66f4\u65b0\u3002\u6bd4\u5982\u72b6\u6001\u4fe1\u606f\u3002\u4f4d\u7f6e\u4fe1\u606f\u7b49\u3002\u63a8\u8350\u4f7f\u7528\u5176\u4ed6\u6570\u636e\u5e93 \u5982redis</p> <ul> <li>\u591a\u5199</li> </ul> <p>\u5728\u5355\u8282\u70b9\u4e0a\u7684\u4f18\u5316\u505a\u597d\u4e86\u518d\u8003\u8651\u591a\u5199</p> <p>\u603b\u7ed3\u7684\u5f88\u5168\u9762\u7684\u5173\u4e8e\u5f00\u53d1\u4eba\u5458\u5982\u4f55\u4f18\u5316\u6570\u636e https://www.modb.pro/db/26031?xzs=</p>","tags":["\u4f18\u5316"]},{"location":"postgres/performance/vacuum/","title":"vacuum \u5783\u573e\u56de\u6536\u5668","text":""},{"location":"postgres/performance/vacuum/#_1","title":"\u4ecb\u7ecd","text":"<p>\u6570\u636e\u5e93\u603b\u662f\u4e0d\u65ad\u5730\u5728\u6267\u884c\u5220\u9664\uff0c\u66f4\u65b0\u7b49\u64cd\u4f5c\u3002\u826f\u597d\u7684\u7a7a\u95f4\u7ba1\u7406\u975e\u5e38\u91cd\u8981\uff0c\u80fd\u591f\u5bf9\u6027\u80fd\u5e26\u6765\u5927\u5e45\u63d0\u9ad8\u3002\u5728postgresql\u4e2d\u7528\u4e8e\u7ef4\u62a4\u6570\u636e\u5e93\u78c1\u76d8\u7a7a\u95f4\u7684\u5de5\u5177\u662fVACUUM\uff0c\u5176\u91cd\u8981\u7684\u4f5c\u7528\u662f\u5220\u9664\u90a3\u4e9b\u5df2\u7ecf\u6807\u793a\u4e3a\u5220\u9664\u7684\u6570\u636e\u5e76\u91ca\u653e\u7a7a\u95f4\u3002 postgresql\u4e2d\u6267\u884cdelete,update\u64cd\u4f5c\u540e\uff0c\u8868\u4e2d\u7684\u8bb0\u5f55\u53ea\u662f\u88ab\u6807\u793a\u4e3a\u5220\u9664\u72b6\u6001\uff0c\u5e76\u6ca1\u6709\u91ca\u653e\u7a7a\u95f4\uff0c\u5728\u4ee5\u540e\u7684update\u6216insert\u64cd\u4f5c\u4e2d\u8be5\u90e8\u5206\u7684\u7a7a\u95f4\u662f\u4e0d\u80fd\u591f\u88ab\u91cd\u7528\u7684\u3002\u7ecf\u8fc7vacuum\u6e05\u7406\u540e\uff0c\u7a7a\u95f4\u624d\u80fd\u5f97\u5230\u91ca\u653e\u3002</p>"},{"location":"postgres/performance/vacuum/#_2","title":"\u610f\u4e49","text":"<p>PostgreSQL\u6bcf\u4e2a\u8868\u548c\u7d22\u5f15\u7684\u6570\u636e\u90fd\u662f\u7531\u5f88\u591a\u4e2a\u56fa\u5b9a\u5c3a\u5bf8\u7684\u9875\u9762\u5b58\u50a8\uff08\u901a\u5e38\u662f 8kB\uff0c\u4e0d\u8fc7\u5728\u7f16\u8bd1\u670d\u52a1\u5668\u65f6[\u2013with-blocksize]\u53ef\u4ee5\u9009\u62e9\u5176\u4ed6\u4e0d\u540c\u7684\u5c3a\u5bf8\uff09</p> <p>PostgreSQL\u4e2d\u6570\u636e\u64cd\u4f5c\u6c38\u8fdc\u662fAppend\u64cd\u4f5c,\u5177\u4f53\u542b\u4e49\u5982\u4e0b:</p> <ul> <li>insert \u65f6\u5411\u9875\u4e2d\u6dfb\u52a0\u4e00\u6761\u6570\u636e</li> <li>update \u5c06\u5386\u53f2\u6570\u636e\u6807\u8bb0\u4e3a\u65e0\u6548,\u7136\u540e\u5411\u9875\u4e2d\u6dfb\u52a0\u65b0\u6570\u636e</li> <li>delete \u5c06\u5386\u53f2\u6570\u636e\u6807\u8bb0\u4e3a\u65e0\u6548  </li> </ul> <p>\u56e0\u4e3a\u8fd9\u4e2a\u7279\u6027,\u6240\u4ee5\u9700\u8981\u5b9a\u671f\u5bf9\u6570\u636e\u5e93vacuum,\u5426\u5219\u4f1a\u5bfc\u81f4\u6570\u636e\u5e93\u81a8\u80c0,\u5efa\u8bae\u6253\u5f00autovacuum.</p>"},{"location":"postgres/performance/vacuum/#_3","title":"\u6587\u6cd5","text":"<pre><code>VACUUM [ ( { FULL | FREEZE | VERBOSE | ANALYZE | DISABLE_PAGE_SKIPPING } [, ...] ) ] [ table_name [ (column_name [, ...] ) ] ]\nVACUUM [ FULL ] [ FREEZE ] [ VERBOSE ] [ table_name ]\nVACUUM [ FULL ] [ FREEZE ] [ VERBOSE ] ANALYZE [ table_name [ (column_name [, ...] ) ] ]\n</code></pre>"},{"location":"postgres/performance/vacuum/#_4","title":"\u53c2\u6570","text":""},{"location":"postgres/performance/vacuum/#full","title":"FULL","text":"<p>Selects \u201cfull\u201d vacuum, which can reclaim more space, but takes much longer and exclusively locks the table. This method also requires extra disk space, since it writes a new copy of the table and doesn't release the old copy until the operation is complete. Usually this should only be used when a significant amount of space needs to be reclaimed from within the table.</p> <p>\u5927\u62db\uff0c\u9700\u8981\u66f4\u591a\u7684\u78c1\u76d8\u7a7a\u95f4\uff0c\u7a7a\u95f4\u5c06\u4f1a\u88ab\u91cd\u65b0\u6574\u7406\u3002\u3000auto vacumm \u53ea\u5220\u9664\u7a7a\u95f4\uff0c\u5e76\u6ca1\u6709\u6574\u7406\u4f7f\u7a7a\u95f4\u66f4\u7d27\u51d1\u3002</p>"},{"location":"postgres/performance/vacuum/#verbose","title":"VERBOSE","text":"<p>Prints a detailed vacuum activity report for each table. \u6253\u5370\u56de\u6536\u65f6\u6bcf\u4e2atable \u6267\u884c\u7ec6\u8282</p>"},{"location":"postgres/performance/vacuum/#analyze","title":"ANALYZE","text":"<p>Updates statistics used by the planner to determine the most efficient way to execute a query.</p> <p>\u7edf\u8ba1\u5e93</p>"},{"location":"postgres/performance/vacuum/#_5","title":"\u4f8b\u5b50","text":"<p>\u53ef\u4ee5\u7cbe\u786e\u6307\u5b9a\u9700\u8981\u6267\u884c\u7684table, \u5982\u679c\u4e0d\u6307\u5b9a\u88ab\u56de\u6536\u7684\u5bf9\u8c61\uff0c\u9ed8\u8ba4\u4e3a\u5f53\u524ddatabase \u4e0b\u6240\u6709 table   </p> <pre><code>VACUUM (FULL,VERBOSE, ANALYZE) table_name;\n</code></pre> <p>\u5c06\u6267\u884c\u8fc7\u7a0b\u7ec6\u8282\u6253\u5370\u5230\u6587\u4ef6\u4e2d</p> <pre><code>psql -U user -d database  -c \"vacuum FULL VERBOSE ANALYZE table\"  &gt; vacuum-01.log 2&gt;&amp;1\n</code></pre>"},{"location":"postgres/performance/vacuum/#vacuum-full","title":"\u6d4b\u8bd5 vacuum full","text":"<p>ctid (0,59) \u8868\u793a\u6570\u636e\u5b58\u653e\u4f4d\u7f6e\u4e3a\u7b2c0\u4e2a\u9875\u9762\u7684\u7b2c59\u884c</p> <p>\u521b\u5efa\u6d4b\u8bd5\u8868</p> <pre><code>create table test_vacuum(\n    objectid bigserial not null,                --\u552f\u4e00\u7f16\u53f7\uff0c\u4e3b\u952e\n    name text not null,                         --\u540d\u79f0\n    describe text,                              --\u5907\u6ce8\n    generate timestamptz default now() not null,--\u521b\u5efa\u65e5\u671f\n    constraint pk_test1_objectid primary key(objectid)\n); \n</code></pre> <p>\u521b\u5efa\u968f\u673a\u751f\u6210\u4e2d\u6587\u5b57\u7b26\u51fd\u6570</p> <pre><code>drop function if exists gen_random_zh(int,int);\ncreate or replace function gen_random_zh(int,int)\n    returns text\nas $$\n    select string_agg(chr((random()*(20901-19968)+19968 )::integer) , '')  from generate_series(1,(random()*($2-$1)+$1)::integer); $$ language sql; \n</code></pre> <p>\u5bfc\u5165\u6d4b\u8bd5\u6570\u636e</p> <pre><code>insert into test_vacuum(name)\n  select gen_random_zh(8,32) from generate_series(1,10000); \n</code></pre> <p>\u67e5\u770b\u6570\u636e\u5e03\u5c40</p> <pre><code>select ctid,objectid from test_vacuum limit 500;\nctid,objectid\n--------\n ....\n(1,17) 92\n(1,18) 93\n(1,19) 94\n(1,20) 95 \n ....\n</code></pre> <p>\u66f4\u65b0\u8868\u4e2d\u6570\u636e</p> <pre><code>update test2 set name=gen_random_zh(8,32) where objectid = 93;\n</code></pre> <p>\u66f4\u65b0\u540e\u8868\u4e2d\u6570\u636e\u5e03\u5c40</p> <pre><code>select ctid,objectid from test_vacuum limit 500;\nctid,objectid\n--------\n ....\n(1,17) 92\n(1,19) 94\n(1,20) 95 \n ....\n</code></pre> <p>\u6267\u884c vacuum FULL </p> <pre><code>vacuum FULL test_vacuum\n\nselect ctid,objectid from test_vacuum limit 500;\nctid,objectid\n--------\n ....\n(1,17) 92\n(1,18) 94\n(1,29) 95 \n ....\n\n</code></pre> <p>\u6570\u636e\u5e03\u5c40\u53d8\u7684\u66f4\u7d27\u51d1\uff0c\u3000\u53ea\u6267\u884cvacuum \u6570\u636e\u4e0d\u4f1a\u79fb\u52a8</p>"},{"location":"postgres/performance/vacuum/#_6","title":"\u6269\u5c55\u9605\u8bfb","text":"<p>1.\u56de\u6536\u7a7a\u95f4</p> <p>\u8fd9\u4e2a\u901a\u5e38\u662f\u5927\u5bb6\u6700\u5bb9\u6613\u60f3\u8d77\u6765\u7684\u529f\u80fd\u3002\u56de\u6536\u7a7a\u95f4\uff0c\u5c06dead tuple\u6e05\u7406\u6389\u3002\u4f46\u662f\u5df2\u7ecf\u5206\u914d\u7684\u7a7a\u95f4\uff0c\u4e00\u822c\u4e0d\u4f1a\u91ca\u653e\u6389\u3002\u9664\u975e\u505avacuum full\uff0c\u4f46\u662f\u9700\u8981exclusive lock\u3002\u4e00\u822c\u4e0d\u592a\u5efa\u8bae\uff0c\u56e0\u4e3a\u5982\u679c\u8868\u6700\u7ec8\u8fd8\u662f\u4f1a\u6da8\u5230 \u8fd9\u4e2a\u9ad8\u6c34\u4f4d\u4e0a\uff0c\u7ecf\u5e38\u505avacuum full\u610f\u4e49\u4e0d\u662f\u975e\u5e38\u5927\u3002\u4e00\u822c\u5408\u7406\u8bbe\u7f6evacuum\u53c2\u6570\uff0c\u8fdb\u884c\u5e38\u89c4vacuum\u4e5f\u5c31\u591f\u4e86\u3002</p> <p>2.\u51bb\u7ed3tuple\u7684xid</p> <p>PG\u4f1a\u5728\u6bcf\u6761\u8bb0\u5f55\uff08tuple\uff09\u7684header\u4e2d\uff0c\u5b58\u653exmin,xmax\u4fe1\u606f(\u589e\u5220\u6539\u4e8b\u52a1ID)\u3002transactionID\u7684\u6700\u5927\u503c\u4e3a2\u768432\u6b21\uff0c\u5373\u65e0\u7b26\u6574\u5f62\u6765\u8868\u793a\u3002\u5f53transactionID\u8d85\u8fc7\u6b64\u6700\u5927\u503c\u540e\uff0c\u4f1a\u5faa\u73af\u4f7f\u7528\u3002 \u8fd9\u4f1a\u5e26\u6765\u4e00\u4e2a\u95ee\u9898\uff1a\u5c31\u662f\u6700\u65b0\u4e8b\u52a1\u7684transactionID\u4f1a\u5c0f\u4e8e\u8001\u4e8b\u52a1\u7684transactionID\u3002\u5982\u679c\u8fd9\u79cd\u60c5\u51b5\u53d1\u751f\u540e\uff0cPG\u5c31\u6ca1\u6709\u529e\u6cd5\u6309transactionID\u6765\u533a\u5206\u4e8b\u52a1\u7684\u5148\u540e\uff0c\u4e5f\u6ca1\u6709\u529e\u6cd5\u5b9e\u73b0MVCC\u4e86\u3002\u56e0\u6b64PG\u7528vacuum\u540e\u53f0\u8fdb\u7a0b\uff0c \u6309\u4e00\u5b9a\u7684\u5468\u671f\u548c\u7b97\u6cd5\u89e6\u53d1vacuum\u52a8\u4f5c\uff0c\u5c06\u8fc7\u8001\u7684tuple\u7684header\u4e2d\u7684\u4e8b\u52a1ID\u8fdb\u884c\u51bb\u7ed3\u3002\u51bb\u7ed3\u4e8b\u52a1ID\uff0c\u5373\u5c06\u4e8b\u52a1ID\u8bbe\u7f6e\u4e3a\u201c2\u201d\uff08\u201c0\u201d\u8868\u793a\u65e0\u6548\u4e8b\u52a1ID\uff1b\u201c1\u201d\u8868\u793abootstrap\uff0c\u5373\u521d\u59cb\u5316\uff1b\u201c3\u201d\u8868\u793a\u6700\u5c0f\u7684\u4e8b\u52a1ID\uff09\u3002PG\u8ba4\u4e3a\u88ab\u51bb\u7ed3\u7684\u4e8b\u52a1ID\u6bd4\u4efb\u4f55\u4e8b\u52a1\u90fd\u8981\u8001\u3002\u8fd9\u6837\u5c31\u4e0d\u4f1a\u51fa\u73b0\u4e0a\u9762\u7684\u8fd9\u79cd\u60c5\u51b5\u4e86\u3002</p> <p>3.\u66f4\u65b0\u7edf\u8ba1\u4fe1\u606f</p> <p>vacuum analyze\u65f6\uff0c\u4f1a\u66f4\u65b0\u7edf\u8ba1\u4fe1\u606f\uff0c\u8ba9PG\u7684planner\u80fd\u591f\u7b97\u51fa\u66f4\u51c6\u786e\u7684\u6267\u884c\u8ba1\u5212\u3002autovacuum_analyze_threshold\u548cautovacuum_analyze_scale_factor\u53c2\u6570\u53ef\u4ee5\u63a7\u5236analyze\u7684\u89e6\u53d1\u7684\u9891\u7387\u3002</p> <p>4.\u66f4\u65b0visibility map</p> <p>\u5728PG\u4e2d\uff0c\u6709\u4e00\u4e2avisibility map\u7528\u6765\u6807\u8bb0\u90a3\u4e9bpage\u4e2d\u662f\u6ca1\u6709dead tuple\u7684\u3002\u8fd9\u6709\u4e24\u4e2a\u597d\u5904\uff0c\u4e00\u662f\u5f53vacuum\u8fdb\u884cscan\u65f6\uff0c\u76f4\u63a5\u53ef\u4ee5\u8df3\u8fc7\u8fd9\u4e9bpage\u3002\u4e8c\u662f\u8fdb\u884cindex-only scan\u65f6\uff0c\u53ef\u4ee5\u5148\u68c0\u67e5\u4e0bvisibility map\u3002\u8fd9\u6837\u51cf\u5c11fetch tuple\u65f6\u7684\u53ef\u89c1\u6027\u5224\u65ad\uff0c\u4ece\u800c\u51cf\u5c11IO\u64cd\u4f5c\uff0c\u63d0\u9ad8\u6027\u80fd\u3002\u53e6\u5916visibility map\u76f8\u5bf9\u6574\u4e2arelation\uff0c\u8fd8\u662f\u5c0f\u5f88\u591a\uff0c\u53ef\u4ee5cache\u5230\u5185\u5b58\u4e2d\u3002</p>"},{"location":"postgres/performance/vacuum/#vacuum","title":"vacuum\u53c2\u6570\u4ecb\u7ecd","text":""},{"location":"postgres/performance/vacuum/#autovacuum","title":"autovacuum \u89e6\u53d1\u6761\u4ef6\uff0c\u5927\u81f4\u6709\u4ee5\u4e0b\u51e0\u4e2a\uff1a","text":"<pre><code>autovacuum\uff1a\u9ed8\u8ba4\u4e3aon\uff0c\u8868\u793a\u662f\u5426\u5f00\u8d77autovacuum\u3002\u9ed8\u8ba4\u5f00\u8d77\u3002\u7279\u522b\u7684\uff0c\u5f53\u9700\u8981\u51bb\u7ed3xid\u65f6\uff0c\u5c3d\u7ba1\u6b64\u503c\u4e3aoff\uff0cPG\u4e5f\u4f1a\u8fdb\u884cvacuum\u3002\nautovacuum_naptime\uff1a\u4e0b\u4e00\u6b21vacuum\u7684\u65f6\u95f4\uff0c\u9ed8\u8ba41min\u3002 \u8fd9\u4e2anaptime\u4f1a\u88abvacuum launcher\u5206\u914d\u5230\u6bcf\u4e2aDB\u4e0a\u3002autovacuum_naptime/num of db\u3002\nlog_autovacuum_min_duration\uff1a\u8bb0\u5f55autovacuum\u52a8\u4f5c\u5230\u65e5\u5fd7\u6587\u4ef6\uff0c\u5f53vacuum\u52a8\u4f5c\u8d85\u8fc7\u6b64\u503c\u65f6\u3002 \u201c-1\u201d\u8868\u793a\u4e0d\u8bb0\u5f55\u3002\u201c0\u201d\u8868\u793a\u6bcf\u6b21\u90fd\u8bb0\u5f55\u3002\nautovacuum_max_workers\uff1a\u6700\u5927\u540c\u65f6\u8fd0\u884c\u7684worker\u6570\u91cf\uff0c\u4e0d\u5305\u542blauncher\u672c\u8eab\u3002\nautovacuum_vacuum_threshold:\u9ed8\u8ba450\u3002\u4e0eautovacuum_vacuum_scale_factor\u914d\u5408\u4f7f\u7528\uff0c autovacuum_vacuum_scale_factor\u9ed8\u8ba4\u503c\u4e3a20%\u3002\n                          \u5f53update,delete\u7684tuples\u6570\u91cf\u8d85\u8fc7autovacuum_vacuum_scale_factor*table_size+autovacuum_vacuum_threshold\u65f6\uff0c\u8fdb\u884cvacuum\u3002\u5982\u679c\u8981\u4f7fvacuum\u5de5\u4f5c\u52e4\u594b\u70b9\uff0c\u5219\u5c06\u6b64\u503c\u6539\u5c0f\u3002\nautovacuum_analyze_threshold:\u9ed8\u8ba450\u3002\u4e0eautovacuum_analyze_scale_factor\u914d\u5408\u4f7f\u7528, autovacuum_analyze_scale_factor\u9ed8\u8ba410%\u3002\n                          \u5f53update,insert,delete\u7684tuples\u6570\u91cf\u8d85\u8fc7autovacuum_analyze_scale_factor*table_size+autovacuum_analyze_threshold\u65f6\uff0c\u8fdb\u884canalyze\u3002\nautovacuum_freeze_max_age\u548cautovacuum_multixact_freeze_max_age\uff1a\u524d\u9762\u4e00\u4e2a200 million,\u540e\u9762\u4e00\u4e2a400 million\u3002\u79bb\u4e0b\u4e00\u6b21\u8fdb\u884cxid\u51bb\u7ed3\u7684\u6700\u5927\u4e8b\u52a1\u6570\u3002\nautovacuum_vacuum_cost_delay\uff1a\u5982\u679c\u4e3a-1\uff0c\u53d6vacuum_cost_delay\u503c\u3002\nautovacuum_vacuum_cost_limit\uff1a\u5982\u679c\u4e3a-1\uff0c\u5230vacuum_cost_limit\u7684\u503c\uff0c\u8fd9\u4e2a\u503c\u662f\u6240\u6709worker\u7684\u7d2f\u52a0\u503c\u3002\n</code></pre>"},{"location":"postgres/performance/vacuum/#vacuum_1","title":"\u57fa\u4e8e\u4ee3\u4ef7\u7684vacuum\u53c2\u6570:","text":"<pre><code>vacuum_cost_delay \uff1a\u8ba1\u7b97\u6bcf\u4e2a\u6beb\u79d2\u7ea7\u522b\u6240\u5141\u8bb8\u6d88\u8017\u7684\u6700\u5927IO\uff0cvacuum_cost_limit/vacuum_cost_dely\u3002 \u9ed8\u8ba4vacuum_cost_delay\u4e3a20\u6beb\u79d2\u3002\nvacuum_cost_page_hit \uff1avacuum\u65f6\uff0cpage\u5728buffer\u4e2d\u547d\u4e2d\u65f6\uff0c\u6240\u82b1\u7684\u4ee3\u4ef7\u3002\u9ed8\u8ba4\u503c\u4e3a1\u3002\nvacuum_cost_page_miss\uff1avacuum\u65f6\uff0cpage\u4e0d\u5728buffer\u4e2d\uff0c\u9700\u8981\u4ece\u78c1\u76d8\u4e2d\u8bfb\u5165\u65f6\u7684\u4ee3\u4ef7\u9ed8\u8ba4\u4e3a10\u3002 vacuum_cost_page_dirty\uff1a\u5f53vacuum\u65f6\uff0c\u4fee\u6539\u4e86clean\u7684page\u3002\u8fd9\u8bf4\u660e\u9700\u8981\u989d\u5916\u7684IO\u53bb\u5237\u810f\u5757\u5230\u78c1\u76d8\u3002\u9ed8\u8ba4\u503c\u4e3a20\u3002\nvacuum_cost_limit\uff1a\u5f53\u8d85\u8fc7\u6b64\u503c\u65f6\uff0cvacuum\u4f1asleep\u3002\u9ed8\u8ba4\u503c\u4e3a200\u3002\n\u628a\u4e0a\u9762\u6bcf\u4e2acost\u503c\u8c03\u6574\u7684\u5c0f\u70b9\uff0c\u7136\u540e\u628alimit\u503c\u8c03\u7684\u5927\u4e9b\uff0c\u53ef\u4ee5\u5ef6\u957f\u6bcf\u6b21vacuum\u7684\u65f6\u95f4\u3002\u8fd9\u6837\u505a\uff0c\u5982\u679c\u5728\u9ad8\u8d1f\u8f7d\u7684\u7cfb\u7edf\u5f53\u4e2d\uff0c\u53ef\u80fdIO\u4f1a\u6709\u6240\u5f71\u54cd\uff0c\u56e0vacuum\u3002\u4f46\u662f\u5bf9\u4e8e\u8868\u7269\u7406\u5b58\u50a8\u7a7a\u95f4\u7684\u589e\u957f\u4f1a\u6709\u6240\u51cf\u7f13\u3002\n</code></pre> <p>\u53c2\u89c1</p>"},{"location":"postgres/performance/vacuum/#_7","title":"\u6269\u5c55\u9605\u8bfb","text":"<p>Autovacuum \u57fa\u7840\u8c03\u4f18 \u4e2d\u6587 \u82f1\u6587</p>"},{"location":"postgres/performance/vacuum/#_8","title":"\u5b9e\u6218","text":"<p>autovacuum \u5728\u8fbe\u5230\u89e6\u53d1\u6761\u4ef6\u65f6\u5c31\u4f1a\u6267\u884c\u3002\u5982\u679c\u89e6\u53d1\u5728\u4e1a\u52a1\u9ad8\u5cf0\u65f6\u53d1\u751f\uff0c\u5bf9\u7ebf\u4e0a\u7684\u4e1a\u52a1\u6027\u80fd\u4f1a\u5e26\u6765\u5f71\u54cd\u3002\u5e94\u907f\u514d\u3002</p> <p>\u6570\u636e\u5e93\u7684vacuum \u4e3a\u53ef\u63a7\u7684\uff0c\u907f\u514dautovacuum\u5bf9\u7ebf\u4e0a\u6570\u636e\u5e93\u5728\u8fd0\u884c\u9ad8\u5cf0\u65f6\u7684\u5f71\u54cd\u3002</p> <p>\u5728\u5fc5\u8981\u65f6\u8fdb\u884c\u624b\u52a8\u6267\u884cvacuum ,\u5728\u4e1a\u52a1\u4f4e\u5cf0\u671f\u6267\u884c\u3002 </p> <p>\u76d1\u63a7\u6570\u636e\u5e93\u7684autovacuum \uff0c\u4f7f\u5176\u5728\u8fbe\u5230\u89e6\u53d1\u6761\u4ef6\u524d\u88ab\u53ca\u65f6\u53d1\u73b0\u3002</p>"},{"location":"postgres/performance/vacuum/#dba","title":"DBA \u7ef4\u62a4","text":"<ul> <li>\u53c2\u8003\u8868\u7a7a\u95f4\u81a8\u80c0\u7387\u8ba1\u7b97\u6267\u884c\u9884\u671f\u6548\u679c</li> <li>\u6267\u884c\u524d\u8bbe\u7f6e maintenance_work_mem \u589e\u52a0\u4e34\u65f6\u4f7f\u7528\u5185\u5b58</li> <li>\u6267\u884c\u524d\u8bbe\u7f6e vacuum_cost_delay , vacuum_cost_limit \u8c03\u6574\u5904\u7406\u901f\u5ea6</li> <li>\u6267\u884cvacuum VERVOSE ANALYZE</li> <li>\u6267\u884canalyze \u66f4\u65b0\u7edf\u8ba1\u4fe1\u606f</li> <li>\u8fdb\u5ea6\u67e5\u770b  select * from pg_stat_progress_vacuum ; </li> <li>\u6ce8\u610fwal \u751f\u6210\u901f\u7387\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u4ece\u5e93\u843d\u540e\u8fc7\u591a\u3002wal\u627e\u4e0d\u5230\u9519\u8bef\u3002\u4ece\u5e93\u9700\u8981\u91cd\u65b0\u62c9\u53d6</li> <li>\u6ce8\u610f\u4e1a\u52a1\u5cf0\u503c\u671f\u5bf9\u4e1a\u52a1\u7684\u9020\u6210\u5f71\u54cd</li> <li>\u7cfb\u7edfIO\uff0c\u4e3b\u4ece\u4e3b\u673a\u5e26\u5bbd</li> </ul>"},{"location":"postgres/performance/vacuum/#_9","title":"\u8fdb\u5ea6\u67e5\u770b","text":"<p>\\ watch 1</p> <pre><code>with table_opts as (\n  select\n    pg_class.oid,\n    relname,\n    nspname,\n    array_to_string(reloptions, '') as relopts\n  from pg_class\n  join pg_namespace ns on relnamespace = ns.oid\n), vacuum_settings as (\n  select\n    oid,\n    relname,\n    nspname,\n    case\n      when relopts like '%autovacuum_vacuum_threshold%' then\n        regexp_replace(relopts, '.*autovacuum_vacuum_threshold=([0-9.]+).*', e'\\\\1')::int8\n      else current_setting('autovacuum_vacuum_threshold')::int8\n    end as autovacuum_vacuum_threshold,\n    case\n      when relopts like '%autovacuum_vacuum_scale_factor%'\n        then regexp_replace(relopts, '.*autovacuum_vacuum_scale_factor=([0-9.]+).*', e'\\\\1')::numeric\n      else current_setting('autovacuum_vacuum_scale_factor')::numeric\n    end as autovacuum_vacuum_scale_factor,\n    case\n      when relopts ~ 'autovacuum_enabled=(false|off)' then false\n      else true\n    end as autovacuum_enabled\n  from table_opts\n), p as (\n  select *\n  from pg_stat_progress_vacuum\n)\nselect\n  coalesce(\n    coalesce(nullif(vacuum_settings.nspname, 'public') || '.', '') || vacuum_settings.relname, -- current DB\n    format('[something in \"%I\"]', p.datname) -- another DB\n  ) as relation,\n  round((100 * psat.n_dead_tup::numeric / nullif(pg_class.reltuples, 0))::numeric, 2) as dead_tup_pct,\n  pg_class.reltuples::numeric,\n  psat.n_dead_tup,\n  format (\n    'vt: %s, vsf: %s, %s', -- 'vt' \u2013 vacuum_threshold, 'vsf' - vacuum_scale_factor\n    vacuum_settings.autovacuum_vacuum_threshold,\n    vacuum_settings.autovacuum_vacuum_scale_factor,\n    (case when autovacuum_enabled then 'DISABLED' else 'enabled' end)\n  ) as effective_settings,\n  case\n    when last_autovacuum &gt; coalesce(last_vacuum, '0001-01-01') then left(last_autovacuum::text, 19) || ' (auto)'\n    when last_vacuum is not null then left(last_vacuum::text, 19) || ' (manual)'\n    else null\n  end as last_vacuumed,\n  coalesce(p.phase, '~~~ in queue ~~~') as status,\n  p.pid as pid,\n  case\n    when a.query ~ '^autovacuum.*to prevent wraparound' then 'wraparound' \n    when a.query ~ '^vacuum' then 'user'\n    when a.pid is null then null\n    else 'regular'\n  end as mode,\n  case\n    when a.pid is null then null\n    else coalesce(wait_event_type || '.' || wait_event, 'f')\n  end as waiting,\n  round(100.0 * p.heap_blks_scanned / nullif(p.heap_blks_total, 0), 1) as scanned_pct,\n  round(100.0 * p.heap_blks_vacuumed / nullif(p.heap_blks_total, 0), 1) as vacuumed_pct,\n  p.index_vacuum_count,\n  case \n    when psat.relid is not null and p.relid is not null then\n      (select count(*) from pg_index where indrelid = psat.relid)\n    else null\n  end as index_count\nfrom pg_stat_all_tables psat\njoin pg_class on psat.relid = pg_class.oid\nleft join vacuum_settings on pg_class.oid = vacuum_settings.oid\nfull outer join p on p.relid = psat.relid and p.datname = current_database()\nleft join pg_stat_activity a using (pid)\nwhere\n  psat.relid is null\n  or p.phase is not null\n  or (\n    autovacuum_vacuum_threshold\n      + (autovacuum_vacuum_scale_factor::numeric * pg_class.reltuples)\n    &lt; psat.n_dead_tup\n  )\norder by status, relation\n</code></pre>"},{"location":"postgres/performance/vacuum_limit/","title":"vacuum \u9650\u6d41","text":"","tags":[]},{"location":"postgres/performance/vacuum_limit/#_1","title":"\u9650\u6d41\u76ee\u7684","text":"<p>\u6e05\u7406\u662f\u5728\u540e\u53f0\u8fd0\u884c\u7684\u7ef4\u62a4\u4efb\u52a1\uff0c\u5bf9\u7528\u6237\u67e5\u8be2\u7684\u5f71\u54cd\u6700\u5c0f\u3002\u4e0d\u5e94\u8be5\u6d88\u8017\u592a\u591a\u7684\u8d44\u6e90(CPU\u548c\u78c1\u76d8I/O)\u3002</p>","tags":[]},{"location":"postgres/performance/vacuum_limit/#_2","title":"\u6e05\u7406\u6210\u672c\u8ba1\u7b97","text":"<p>\u6e05\u7406\u8fc7\u7a0b\u76f8\u5f53\u7b80\u5355\uff0c\u5b83\u4ece\u6570\u636e\u6587\u4ef6\u4e2d\u8bfb\u53d6\u9875\u9762(8kB\u7684\u6570\u636e\u5757)\uff0c\u5e76\u68c0\u67e5\u662f\u5426\u9700\u8981\u6e05\u7406\u3002\u5982\u679c\u6ca1\u6709dead tuples\uff0c\u9875\u9762\u5c06\u88ab\u7b80\u5355\u5730\u4e22\u5f03\uff0c\u800c\u4e0d\u8fdb\u884c\u4efb\u4f55\u66f4\u6539\u3002\u5426\u5219\uff0c\u5b83\u5c06\u88ab\u6e05\u7406(\u5220\u9664dead tuples)\uff0c\u88ab\u6807\u8bb0\u4e3a\u201c\u810f\u7684\u201d\uff0c\u5e76\u6700\u7ec8\u88ab\u5199\u51fa\u6765</p> <p>\u6210\u672c\u8ba1\u7b97\u662f\u57fa\u4e8e\u4ee5\u4e0b\u4e09\u4e2a\u57fa\u672c\u64cd\u4f5c\u7684\u6210\u672c\u5b9a\u4e49</p> <pre><code>vacuum_cost_page_hit = 1\nvacuum_cost_page_miss = 10\nvacuum_cost_page_dirty = 20\n</code></pre> <p>\u4eceshared_buffers\u8bfb\u53d6\u9875\u9762\uff0c\u5219\u8ba1\u6570\u4e3a1\u3002</p> <p>\u5982\u679cshared_buffers\u4e2d\u6ca1\u6709\u627e\u5230\u5b83\u800c\u9700\u8981\u4ece\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8bfb\u53d6\uff0c\u8ba1\u6570\u4e3a10(\u5b83\u53ef\u80fd\u4ecd\u7136\u7531RAM\u63d0\u4f9b\uff0c\u4f46\u6211\u4eec\u4e0d\u77e5\u9053)\u3002</p> <p>\u6700\u540e\uff0c\u5982\u679c\u9875\u9762\u88ab\u6e05\u7406\u5f04\u810f\u4e86\uff0c\u5219\u8ba1\u6570\u4e3a20</p>","tags":[]},{"location":"postgres/performance/vacuum_limit/#_3","title":"\u6210\u672c\u9650\u5236","text":"<p>\u901a\u8fc7\u9650\u5236\u4e00\u6b21\u6027\u5b8c\u6210\u7684\u5de5\u4f5c\u91cf(\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a200)\u6765\u5b9e\u73b0\u9650\u6d41\uff0c\u6bcf\u6b21\u6e05\u7406\u5de5\u4f5c\u5b8c\u6210\u8fd9\u4e48\u591a\u5de5\u4f5c(\u8ba1\u6570\u8fbe\u5230autovacuum_vacuum_cost_limit )\uff0c\u5b83\u5c31\u4f1a\u4f11\u772020\u6beb\u79d2\u3002</p> <pre><code>autovacuum_vacuum_cost_delay = 20ms\nautovacuum_vacuum_cost_limit = 200\n</code></pre>","tags":[]},{"location":"postgres/performance/vacuum_limit/#_4","title":"\u8fdb\u7a0b\u6570","text":"<pre><code>autovacum_max_workers\n</code></pre> <p>\u589e\u52a0\u6e05\u7406\u7684\u8fdb\u7a0b\u6570\u636e\u662f\u5426\u53ef\u4ee5\u63d0\u9ad8\u6e05\u7406\u6548\u7387\u3002\u4e0d</p> <p>\u6210\u672c\u9650\u5236\u662f\u5168\u5c40\u7ea7\u522b\u7684\uff0c\u7531\u6240\u6709\u7684autovacuum\u8fdb\u7a0b\u5171\u540c\u627f\u62c5\u3002\u6bcf\u4e2a\u8fdb\u7a0b\u53ea\u4f1a\u5f97\u5230\u603b\u6210\u672c\u9650\u5236\u76841/ autovacum_max_workers\uff0c\u56e0\u6b64\u589e\u52a0\u8fdb\u7a0b\u6570\u91cf\u53ea\u4f1a\u8ba9\u4ed6\u4eec\u8d70\u5f97\u66f4\u6162\u3002</p>","tags":[]},{"location":"postgres/performance/vacuum_limit/#_5","title":"\u8868\u7ea7\u9650\u5236\u8bbe\u7f6e","text":"<pre><code>ALTER TABLE t SET (autovacuum_vacuum_cost_limit = 1000);\nALTER TABLE t SET (autovacuum_vacuum_cost_delay = 10);\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/","title":"\u903b\u8f91\u590d\u5236","text":"","tags":[]},{"location":"postgres/replication/logical-replication/#_1","title":"\u903b\u8f91\u590d\u5236","text":"<p>Postgres 10 \u7248\u672c\u5f00\u59cb\uff0c \u5728\u5185\u6838\u5c42\u9762\u652f\u6301\u57fa\u4e8eREDO\u6d41\u7684\u903b\u8f91\u590d\u5236\u3002</p> <p>\u63a7\u5236\u7c92\u5ea6\u4e3a\u8868\u7ea7\u522b</p> <p>\u7269\u7406\u590d\u5236\u76f8\u540c\u90fd\u662f\u57fa\u4e8ewal </p> <p>\u53ef\u6307\u5b9a\u591a\u4e2a\u4e0a\u6e38\u6570\u636e\u6e90</p> <p>\u4e0b\u6e38\u6570\u636e\u53ef\u8bfb\u53ef\u5199</p> <p>\u53ef\u7528\u4e8e\u6570\u636e\u6c47\u603b\uff0c\u65e0\u505c\u670d\u6570\u636e\u8fc1\u79fb,\u5927\u7248\u672c\u5347\u7ea7\u7b49\u3002</p>","tags":[]},{"location":"postgres/replication/logical-replication/#_2","title":"\u57fa\u672c\u6982\u5ff5","text":"<ul> <li>\u53d1\u5e03\u8005\uff08publication\uff09\uff0c \u4e0a\u6e38\u6570\u636e</li> <li>\u8ba2\u9605\u8005 (subscrition)\uff0c \u4e0b\u6e38\u6570\u636e</li> <li>\u590d\u5236\u69fd (slot), \u4fdd\u5b58\u903b\u8f91\u590d\u5236\u7684\u4fe1\u606f</li> </ul>","tags":[]},{"location":"postgres/replication/logical-replication/#_3","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u6570\u636e\u5e93\u6a21\u5f0f\u548cDDL\u547d\u4ee4\u4e0d\u4f1a\u88ab\u590d\u5236</li> <li>\u5e8f\u5217\u6570\u636e\u4e0d\u88ab\u590d\u5236</li> <li>\u5206\u533a\u8868,\u9700\u8981\u53d1\u5e03\u5b50\u8868 </li> </ul>","tags":[]},{"location":"postgres/replication/logical-replication/#_4","title":"\u5e38\u7528\u65b9\u5f0f\u603b\u7ed3","text":"","tags":[]},{"location":"postgres/replication/logical-replication/#_5","title":"\u53d1\u5e03\u7aef","text":"<ul> <li>\u903b\u8f91\u590d\u5236\u7684\u524d\u63d0\u662f\u5c06\u6570\u636e\u5e93 wal_level \u53c2\u6570\u8bbe\u7f6e\u6210 logical\uff1b</li> <li>\u6e90\u5e93\u4e0a\u903b\u8f91\u590d\u5236\u7684\u7528\u6237\u5fc5\u987b\u5177\u6709 replicatoin \u6216 superuser \u89d2\u8272\uff1b</li> <li>\u903b\u8f91\u590d\u5236\u76ee\u524d\u4ec5\u652f\u6301\u6570\u636e\u5e93\u8868\u903b\u8f91\u590d\u5236\uff0c\u5176\u5b83\u5bf9\u8c61\u4f8b\u5982\u51fd\u6570\u3001\u89c6\u56fe\u4e0d\u652f\u6301\uff1b</li> <li>\u903b\u8f91\u590d\u5236\u652f\u6301DML(UPDATE\u3001INSERT\u3001DELETE)\u64cd\u4f5c\uff0cTRUNCATE \u548c DDL \u64cd\u4f5c\u4e0d\u652f\u6301\uff1b</li> <li>\u9700\u8981\u53d1\u5e03\u903b\u8f91\u590d\u5236\u7684\u8868\uff0c\u987b\u914d\u7f6e\u8868\u7684 REPLICA IDENTITY \u7279\u6027\uff1b</li> <li>\u4e00\u4e2a\u6570\u636e\u5e93\u4e2d\u53ef\u4ee5\u6709\u591a\u4e2apublication\uff0c\u901a\u8fc7 pg_publication \u67e5\u770b\uff1b</li> <li>\u5141\u8bb8\u4e00\u6b21\u53d1\u5e03\u6240\u6709\u8868\uff0c\u8bed\u6cd5\uff1a CREATE PUBLICATION alltables FOR ALL TABLES;</li> </ul>","tags":[]},{"location":"postgres/replication/logical-replication/#_6","title":"\u8ba2\u9605\u7aef","text":"<ul> <li>\u8ba2\u9605\u8282\u70b9\u9700\u8981\u6307\u5b9a\u53d1\u5e03\u8005\u7684\u8fde\u63a5\u4fe1\u606f\uff1b</li> <li>\u4e00\u4e2a\u6570\u636e\u5e93\u4e2d\u53ef\u4ee5\u6709\u591a\u4e2a\u8ba2\u9605\u8005\uff1b</li> <li>\u53ef\u4ee5\u4f7f\u7528enable/disable\u542f\u7528/\u6682\u505c\u8be5\u8ba2\u9605\uff1b</li> <li>\u53d1\u5e03\u8282\u70b9\u548c\u8ba2\u9605\u8282\u70b9\u8868\u7684\u6a21\u5f0f\u540d\u3001\u8868\u540d\u5fc5\u987b\u4e00\u81f4\uff0c\u8ba2\u9605\u8282\u70b9\u5141\u8bb8\u8868\u6709\u989d\u5916\u5b57\u6bb5\uff1b</li> <li>\u53d1\u5e03\u8282\u70b9\u589e\u52a0\u8868\u540d\uff0c\u8ba2\u9605\u8282\u70b9\u9700\u8981\u6267\u884c\uff1a ALTER SUBSCRIPTION sub1 REFRESH PUBLICATION</li> </ul>","tags":[]},{"location":"postgres/replication/logical-replication/#_7","title":"\u590d\u5236\u6807\u8bc6","text":"<p>\u4e3a\u4e86\u80fd\u591f\u590d\u5236UPDATE\u548cDELETE\u64cd\u4f5c\uff0c\u88ab\u53d1\u5e03\u7684\u8868\u5fc5\u987b\u914d\u7f6e\u6709\u4e00\u4e2a\u201c\u590d\u5236\u6807\u8bc6\u201d\u3002 \u8fd9\u6837\u5728\u8ba2\u9605\u8005\u90a3\u4e00\u7aef\u624d\u80fd\u6807\u8bc6\u5bf9\u4e8e\u66f4\u65b0\u6216\u5220\u9664\u5408\u9002\u7684\u884c\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u590d\u5236\u6807\u8bc6\u5c31\u662f\u4e3b\u952e\uff08\u5982\u679c\u6709\u4e3b\u952e\uff09\u3002\u4e5f\u53ef\u4ee5\u5728\u590d\u5236\u6807\u8bc6\u4e0a\u8bbe\u7f6e\u53e6\u4e00\u4e2a\u552f\u4e00\u7d22\u5f15\uff08\u6709\u7279\u5b9a\u7684\u989d\u5916\u8981\u6c42\uff09\u3002\u5982\u679c\u8868\u6ca1\u6709\u5408\u9002\u7684\u952e\uff0c\u90a3\u4e48\u53ef\u4ee5\u8bbe\u7f6e\u6210\u590d\u5236\u6807\u8bc6\u201cfull\u201d\uff0c\u5b83\u8868\u793a\u6574\u4e2a\u884c\u4e3a\u952e\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u590d\u5236\u6807\u8bc6\uff0c\u8ba2\u9605\u7aef\u7684UPDATE\u548cDELETE\u64cd\u4f5c\u5c06\u53d1\u751f\u9519\u8bef\u3002INSERT\u53ef\u4ee5\u6267\u884c\u3002</p> <p>\u67e5\u770b\u590d\u5236\u6807\u8bc6</p> <pre><code>select relreplident from pg_class where relname = ' xxx ';\n\nd \u9ed8\u8ba4\nn \u65e0\nf \u6240\u6709\u5217\ni \u7d22\u5f15\n</code></pre> <p>\u4fee\u6539\u590d\u5236\u6807\u8bc6</p> <pre><code>alter table xxx replica identity using index xx_idx;\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_8","title":"\u51b2\u7a81","text":"<p>\u8df3\u8fc7\u51b2\u7a81\u4e8b\u52a1</p> <pre><code>pg_replication_origin_advance()\n</code></pre> <p>\u67e5\u770b\u51b2\u7a81\u65f6\u7684\u4f4d\u7f6e</p> <pre><code>pg_replication_origin_status\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_9","title":"\u7b80\u5355\u5b9e\u8df5","text":"<p>\u5c06PG10\u4e2d\u7684\u4e00\u5f20\u8868\u540c\u6b65\u5230PG12\u4e2d</p>","tags":[]},{"location":"postgres/replication/logical-replication/#_10","title":"\u53d1\u5e03\u8005\u670d\u52a1\u5668\u914d\u7f6e","text":"<p>postgresql.conf</p> <pre><code>wal_level = logical\nmax_replication_slots = 10 # \u6bcf\u4e2aslot \u9700\u8981\u4e00\u4e2a\nmax_wal_senders = 10 # \u6bcf\u4e2aslot \u9700\u8981\u4e00\u4e2a\nmax_worker_processes = 128 \n\n</code></pre> <p>pg_hba.conf</p> <pre><code>host replication postgres 10.1.0.0/16 md5\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_11","title":"\u8ba2\u9605\u8005\u670d\u52a1\u5668\u914d\u7f6e","text":"<p>postgresql.conf</p> <pre><code>max_replication_slots = 10 # \u6bcf\u4e2aslot \u9700\u8981\u4e00\u4e2a\nmax_logical_replication_workers = 10 # \u6bcf\u4e2aslot \u9700\u8981\u4e00\u4e2a\nmax_worker_processes = 128\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_12","title":"\u5728\u53d1\u5e03\u7aef\u521b\u5efa\u53d1\u5e03","text":"<pre><code>create publication test01 for table test01 ;\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_13","title":"\u5728\u8ba2\u9605\u7aef\u521b\u5efa\u8868\u7ed3\u6784","text":"<p>pg_dump --schema-only </p> <pre><code>pg_dump -U s -t test01 pglogicaltestdb\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_14","title":"\u5728\u8ba2\u9605\u7aef\u521b\u5efa\u8ba2\u9605","text":"<pre><code>create subscription sub1 connection 'host=10.1.7.55 port=25432 dbname=pglogicaltestdb password=123456' publication test01;\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_15","title":"\u5e38\u7528\u89c6\u56fe\u67e5\u770b","text":"","tags":[]},{"location":"postgres/replication/logical-replication/#_16","title":"\u53d1\u5e03\u7aef\u89c6\u56fe","text":"<pre><code> select * from pg_stat_replication ;\n\n select * from pg_publication;\n\n select * from pg_publication_tables ;\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#_17","title":"\u8ba2\u9605\u7aef\u89c6\u56fe","text":"<pre><code> select * from pg_stat_subscription;\n\n select * from pg_subscription\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication/#-","title":"\u5e94\u7528\u6848\u4f8b - \u5347\u7ea7\u6570\u636e\u5e93\u7248\u672c","text":"","tags":[]},{"location":"postgres/replication/logical-replication/#_18","title":"\u66f4\u591a\u601d\u8003","text":"<p>\u591a\u4e3b\u65b9\u6848\uff0c DBR</p> <p>\u4f8b\u5b50 https://cdn.modb.pro/db/48200</p> <p>\u5bf9DDL\u652f\u6301 https://github.com/enova/pgl_ddl_deploy</p>","tags":[]},{"location":"postgres/replication/logical-replication_failover/","title":"\u903b\u8f91\u590d\u5236\u6545\u969c\u8f6c\u79fb","text":"","tags":[]},{"location":"postgres/replication/logical-replication_failover/#_1","title":"\u903b\u8f91\u590d\u5236\u6545\u969c\u8f6c\u79fb","text":"<ul> <li>\u4e3b\u5e93 10.10.2.11</li> <li>\u7269\u7406\u4ece\u5e93 10.10.2.12</li> <li>\u903b\u8f91\u4ece\u5e93 10.10.2.13</li> </ul>","tags":[]},{"location":"postgres/replication/logical-replication_failover/#_2","title":"\u6d4b\u8bd5\u4efb\u52a1","text":"<p>\u5f53\u4e3b\u5e93\u53d1\u751f\u6545\u969c\uff0c\u7269\u7406\u590d\u5236\u4ece\u5e93\u53d8\u4e3a\u65b0\u4e3b\u5e93\u3002\u903b\u8f91\u4ece\u5e93\u5c06\u8ba2\u9605\u5730\u5740\u53d8\u66f4\u4e3a\u65b0\u4e3b\u5e93\u3002</p> <p></p>","tags":[]},{"location":"postgres/replication/logical-replication_failover/#_3","title":"\u5f00\u59cb\u6d4b\u8bd5","text":"<p>\u73af\u5883\u642d\u5efa\u53c2\u8003</p> <ul> <li>\u7269\u7406\u590d\u5236</li> <li>\u903b\u8f91\u590d\u5236</li> </ul> <p>\u72b6\u6001\u67e5\u770b \u590d\u5236\u5173\u7cfb</p> <pre><code> select * from pg_stat_replication ;\n-[ RECORD 1 ]----+------------------------------\npid              | 2628\nusesysid         | 24576\nusename          | repuser\napplication_name | sub1\nclient_addr      | 10.10.2.13\nclient_hostname  | \nclient_port      | 40230\nbackend_start    | 2022-11-23 05:46:59.50291+00\nbackend_xmin     | \nstate            | streaming\nsent_lsn         | 0/21000140\nwrite_lsn        | 0/21000140\nflush_lsn        | 0/21000140\nreplay_lsn       | 0/21000140\nwrite_lag        | \nflush_lag        | \nreplay_lag       | \nsync_priority    | 0\nsync_state       | async\n-[ RECORD 2 ]----+------------------------------\npid              | 2757\nusesysid         | 24576\nusename          | repuser\napplication_name | walreceiver\nclient_addr      | 10.10.2.12\nclient_hostname  | \nclient_port      | 37698\nbackend_start    | 2022-11-23 06:05:19.818834+00\nbackend_xmin     | \nstate            | streaming\nsent_lsn         | 0/21000140\nwrite_lsn        | 0/21000140\nflush_lsn        | 0/21000140\nreplay_lsn       | 0/21000140\nwrite_lag        | \nflush_lag        | \nreplay_lag       | \nsync_priority    | 0\nsync_state       | async\n</code></pre> <p>\u590d\u5236\u69fd</p> <pre><code>select * from pg_replication_slots ;\n slot_name |  plugin  | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn \n-----------+----------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------\n node14    |          | physical  |        |          | f         | f      |            |      |              | 0/1F0005B8  | \n sub1      | pgoutput | logical   |  12953 | postgres | f         | t      |       2628 |      |          570 | 0/21000108  | 0/21000140\n(2 rows)\n</code></pre> <p>\u903b\u8f91\u8ba2\u9605\u8868</p> <pre><code>select * from pg_publication_tables ;\n pubname | schemaname | tablename \n---------+------------+-----------\n test01  | public     | test01\n(1 row)\n</code></pre> <p>\u8868\u6570\u636e</p> <pre><code> select * from test01 ;\n id \n----\n  1\n  2\n  3\n  4\n(4 rows)\n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication_failover/#_4","title":"\u4e3b\u4ece\u5207\u6362","text":"<p>\u5173\u95ed\u4e3b\u5e93 </p> <pre><code>systemctl stop postgresql\n</code></pre> <p>\u62f7\u8d1d\u903b\u8f91\u590d\u5236\u69fd, \u5c06\u4e3b\u5e93pg_replsolt\u76ee\u5f55\u4e0b\u7684\u903b\u8f91\u590d\u5236\u69fd\u62f7\u8d1d\u5230\u4ece\u5e93\u5bf9\u5e94\u76ee\u5f55\u4e0b. \u6ce8\u610f\u5bf9\u5e94\u7684\u7528\u6237\u53ca\u7528\u6237\u7ec4\u3002</p> <pre><code>scp -r pg_replslot/sub1/ 10.10.2.12:$PGDATA/data/pg_replslot/\n</code></pre> <p>\u5c06\u4ece\u5e93\u5347\u7ea7\u4e3a\u4e3b\u5e93\u5e76\u91cd\u65b0\u542f\u52a8\u52a0\u8f7dslot</p> <pre><code>pg_ctl promote \nwaiting for server to promote.... done\nserver promoted\n</code></pre> <pre><code>systemctl stop postgresql\n</code></pre> <p>\u67e5\u770b\u590d\u5236\u69fd\u52a0\u8f7d\u60c5\u51b5</p> <pre><code>select * from pg_replication_slots ;\n slot_name |  plugin  | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn \n-----------+----------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------\n sub1      | pgoutput | logical   |  12953 | postgres | f         | f      |            |      |          570 | 0/210001B8  | 0/210001B8\n(1 row)\n\n</code></pre> <p>\u6b64\u65f6\u590d\u5236\u5173\u7cfb,\u65e0\u6570\u636e</p> <pre><code>select * from pg_stat_replication ;\n</code></pre> <p>\u5728\u903b\u8f91\u590d\u5236\u4ece\u5e93\u67e5\u770b\u8ba2\u9605\u4fe1\u606f</p> <pre><code>select * from pg_subscription;\n subdbid | subname | subowner | subenabled |                              subconninfo                               | subslotname | subsynccommit | subpublications \n---------+---------+----------+------------+------------------------------------------------------------------------+-------------+---------------+-----------------\n   12953 | sub1    |       10 | t          | host=10.10.2.11 port=5432 dbname=postgres user=repuser password=123456 | sub1        | off           | {test01}\n\n</code></pre> <p>\u4fee\u6539\u8ba2\u9605\u4fe1\u606f</p> <pre><code>postgres=# alter subscription sub1 connection 'host=10.10.2.12 port=5432 dbname=postgres user=repuser password=123456';\nALTER SUBSCRIPTION\npostgres=# select * from pg_subscription;\n subdbid | subname | subowner | subenabled |                              subconninfo                               | subslotname | subsynccommit | subpublications \n---------+---------+----------+------------+------------------------------------------------------------------------+-------------+---------------+-----------------\n   12953 | sub1    |       10 | t          | host=10.10.2.12 port=5432 dbname=postgres user=repuser password=123456 | sub1        | off           | {test01}\n(1 row)\n\n</code></pre> <p>\u67e5\u770b\u590d\u5236\u5173\u7cfb 10.10.2.12</p> <pre><code>select * from pg_stat_replication ;\n-[ RECORD 1 ]----+------------------------------\npid              | 3938\nusesysid         | 24576\nusename          | repuser\napplication_name | sub1\nclient_addr      | 10.10.2.13\nclient_hostname  | \nclient_port      | 42330\nbackend_start    | 2022-11-23 07:10:27.604722+00\nbackend_xmin     | \nstate            | streaming\nsent_lsn         | 0/210004F8\nwrite_lsn        | 0/210004F8\nflush_lsn        | 0/210004F8\nreplay_lsn       | 0/210004F8\nwrite_lag        | \nflush_lag        | \nreplay_lag       | \nsync_priority    | 0\nsync_state       | async\n\n</code></pre> <p>\u65b0\u4e3b\u5e93\u63d2\u5165\u6570\u636e\u67e5\u770b\u903b\u8f91\u590d\u5236\u60c5\u51b5</p> <pre><code>insert INTO test01 values (5);\n</code></pre> <p>\u903b\u8f91\u4ece\u5e93\u67e5\u770b\u7ed3\u679c</p> <pre><code>select * from test01 \n</code></pre>","tags":[]},{"location":"postgres/replication/logical-replication_failover/#_5","title":"\u81ea\u52a8\u5316\u57fa\u7840","text":"<ul> <li>\u62f7\u8d1drepslot \u76ee\u5f55</li> <li>\u91cd\u542f\u65b0\u4ece\u5e93\u52a0\u8f7d repslot</li> </ul> <p>Postgres 11 \u7248\u672c\u540e\uff0c\u65b0\u589e\u52a0\u51fd\u6570  pg_replication_slot_advance</p>","tags":[]},{"location":"postgres/replication/logical-replication_failover/#patroni-failover","title":"patroni \u81ea\u52a8 failover\u914d\u7f6e","text":"","tags":[]},{"location":"postgres/replication/replication01/","title":"\u4e3b\u4ece\u6d41\u590d\u5236","text":"<p>\u5386\u53f2\u6f14\u53d8</p> <p>replication</p>"},{"location":"postgres/replication/replication01/#_1","title":"\u4e3b\u5e93\u914d\u7f6e","text":"<pre><code>\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u5206\u914d\u6d41\u590d\u5236\u6743\u9650\nvi pg_hba.conf\n\nhost replication all 10.2.0.0/0 trust\n</code></pre> <pre><code>vi postgresql.conf\n\nmax_wal_senders = 10\nwal_level = logical # minimal, replica, or logical\n\nhot_standby = on # \u6b63\u5e38\u5728\u4ece\u5e93\u914d\u7f6e\uff0c\u5982\u679c\u5728\u4e3b\u5e93\u914d\u7f6e\u5b8c\u6bd5\uff0c\u56e0\u4e3a\u4ece\u5e93\u590d\u5236\u4e3b\u5e93\u914d\u7f6e\u4e0d\u9700\u8981\u518d\u4fee\u6539\u4ece\u5e93\u914d\u7f6e\u3002\n\nwal_log_hints = on\n</code></pre>"},{"location":"postgres/replication/replication01/#_2","title":"\u4ece\u5e93\u914d\u7f6e","text":""},{"location":"postgres/replication/replication01/#_3","title":"\u6570\u636e\u5e93\u5b89\u88c5","text":""},{"location":"postgres/replication/replication01/#_4","title":"\u4ece\u4e3b\u5e93\u590d\u5236\u6570\u636e","text":"<pre><code>pg_basebackup -h 10.2.0.14 -U postgres -F p -P -R -D /var/lib/pgsql/10/data/ --checkpoint=fast -l postgresback20181219\n</code></pre> <p>pg_basebackup\u652f\u6301\u4e24\u79cd\u5168\u91cf\u5907\u4efd\u7684\u65b9\u5f0f\uff0c</p> <ul> <li> <p>\u4ee5fetch\u7684\u65b9\u5f0f\uff0c\u5148\u5907\u4efd\u6570\u636e\u5728\u5907\u4efd\u65e5\u5fd7 </p> </li> <li> <p>\u4ee5stream\u7684\u65b9\u5f0f\uff0c\u5e76\u884c\u7684\u5907\u4efd\u6570\u636e\u548c\u65e5\u5fd7 </p> </li> </ul> <p>pg_basebackup\u5bf9\u4e8e\u5168\u91cf\u5907\u4efd\u7684\u6570\u636e\u548c\u65e5\u5fd7\uff0c\u63d0\u4f9b\u4e86\u4e32\u884c\u5907\u4efd\u548c\u5e76\u884c\u5907\u4efd\u7684\u65b9\u5f0f\u3002fetch\u6a21\u5f0f\u4e5f\u5c31\u662f\u4e32\u884c\u5907\u4efd\u9700\u8981\u4fdd\u8bc1\u5728\u5907\u4efd\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5907\u4efd\u5f00\u59cb\u65f6\u523b\u7684\u65e5\u5fd7\u9700\u8981\u4e00\u76f4\u4fdd\u5b58\u4e0b\u6765\uff0c \u4e5f\u5c31\u8bf4pg\u7684wal_keep_segments\u9700\u8981\u8db3\u591f\u5927\u53bb\u4fdd\u5b58\u65e5\u5fd7\u6587\u4ef6\uff0c\u5982\u679c\u5907\u4efd\u6570\u636e\u671f\u95f4\uff0c\u65e5\u5fd7\u5f00\u59cb\u65f6\u523b\u7684\u65e5\u5fd7\u5df2\u7ecf\u88ab\u79fb\u9664\uff0c\u90a3\u4e48\u5907\u4efd\u5c31\u4f1a\u5931\u8d25\u3002\u800cstream\u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u5e76\u884c\u5907\u4efd\u8fc7\u7a0b\u4e2dwal_max_sender\u5fc5\u987b\u4fdd\u8bc1\u4e0d\u5c0f\u4e8e2\u3002 \u800cstream\u6a21\u5f0f\u4e0d\u652f\u6301\uff0c\u5c06\u6570\u636e\u548c\u65e5\u5fd7\u4ee5\u6d41\u7684\u65b9\u5f0f\u8f93\u51fa\u5230\u6807\u51c6\u8f93\u51fa</p> <p>\u9650\u901f\uff0c\u5728\u751f\u4ea7\u7cfb\u7edf\u4e2d\u9632\u6b62\u5bf9\u6b63\u5e38\u4e1a\u52a1\u7684\u5f71\u54cd</p> <pre><code>-r, --max-rate=RATE    maximum transfer rate to transfer data directory\n                         (in kB/s, or use suffix \"k\" or \"M\")\n</code></pre> <p>\u6ce8\u610f\u65b0\u62f7\u8d1d\u6570\u636e\u7684\u6743\u9650</p> <pre><code>chown postgres:postgres data/ -R\nchmod 0700 data \n</code></pre> <p>\u67e5\u770b\u6570\u636e</p> <pre><code>ll data\n\u603b\u7528\u91cf 88\n-rw-------. 1 postgres postgres   203 12\u6708 19 13:45 backup_label.old\ndrwx------. 7 postgres postgres    67 12\u6708 19 14:12 base\n-rw-------. 1 postgres postgres    44 12\u6708 19 14:28 current_logfiles\ndrwx------. 2 postgres postgres  4096 12\u6708 19 14:28 global\ndrwx------. 2 postgres postgres  4096 12\u6708 19 14:28 log\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_commit_ts\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_dynshmem\n-rw-------. 1 postgres postgres  4340 12\u6708 19 13:45 pg_hba.conf\n-rw-------. 1 postgres postgres  1636 12\u6708 19 13:45 pg_ident.conf\ndrwx------. 4 postgres postgres    68 12\u6708 19 15:08 pg_logical\ndrwx------. 4 postgres postgres    36 12\u6708 19 13:45 pg_multixact\ndrwx------. 2 postgres postgres    18 12\u6708 19 14:28 pg_notify\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_replslot\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_serial\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_snapshots\ndrwx------. 2 postgres postgres     6 12\u6708 19 14:28 pg_stat\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_stat_tmp\ndrwx------. 2 postgres postgres    18 12\u6708 19 13:45 pg_subtrans\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_tblspc\ndrwx------. 2 postgres postgres     6 12\u6708 19 13:45 pg_twophase\n-rw-------. 1 postgres postgres     3 12\u6708 19 13:45 PG_VERSION\ndrwx------. 3 postgres postgres 12288 12\u6708 19 15:09 pg_wal\ndrwx------. 2 postgres postgres    18 12\u6708 19 13:45 pg_xact\ndrwx------. 3 postgres postgres    17 12\u6708 19 13:45 pipeline\n-rw-------. 1 postgres postgres    88 12\u6708 19 13:45 postgresql.auto.conf\n-rw-------. 1 postgres postgres 22748 12\u6708 19 14:28 postgresql.conf\n-rw-------. 1 postgres postgres    58 12\u6708 19 14:28 postmaster.opts\n-rw-------. 1 postgres postgres    95 12\u6708 19 14:28 postmaster.pid\n-rw-r--r--. 1 postgres postgres   262 12\u6708 19 13:45 recovery.conf\n</code></pre> <p>\u67e5\u770b recovery.conf</p> <pre><code>cat recovery.conf\nstandby_mode = 'on'\nprimary_conninfo = 'user=postgres host=10.2.0.14 port=5432 sslmode=disable sslcompression=1'\n\n\n</code></pre>"},{"location":"postgres/replication/replication01/#_5","title":"\u4ece\u5e93\u914d\u7f6e","text":"<p>\u542f\u52a8\u4ece\u5e93</p> <pre><code>systemctl start postgresql-10.service\nsystemctl enable postgresql-10.service\n</code></pre> <pre><code>#recovery.conf\n\nrecovery_target_timeline='latest'\nrecovery_min_apply_delay = 5min   #\u5ef6\u8fdf\u591a\u5c11\u5206\u949f\u5e94\u7528\ntrigger_file = '/home/postgres.trigger' #\u4ece\u5e93\u53d8\u4e3b\u5e93\u65f6\u5e94\u7528\n</code></pre>"},{"location":"postgres/replication/replication01/#_6","title":"\u9a8c\u8bc1","text":"<pre><code>\u4e3b\u5e93\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5e93\npsql -U postgres \npostgres=# create database testreplication;\n\n\u4ece\u5e93\u67e5\u770b\u7ed3\u679c\npsql -U postgres\npostgres=#\\l\n                                                  \u6570\u636e\u5e93\u5217\u8868\n       \u540d\u79f0        |     \u62e5\u6709\u8005     | \u5b57\u5143\u7f16\u7801 |  \u6821\u5bf9\u89c4\u5219   |    Ctype    |             \u5b58\u53d6\u6743\u9650              \n-------------------+----------------+----------+-------------+-------------+-----------------------------------\n postgres          | postgres       | UTF8     | en_US.UTF-8 | en_US.UTF-8 | \n template0         | postgres       | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres                      +\n                   |                |          |             |             | postgres=CTc/postgres\n template1         | postgres       | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres                      +\n                   |                |          |             |             | postgres=CTc/postgres\n testreplication   | postgres       | UTF8     | en_US.UTF-8 | en_US.UTF-8 | \n(5 \u884c\u8bb0\u5f55)\n</code></pre> <p>\u72b6\u6001\u67e5\u770b</p> <p>WAL Sender \u4fe1\u606f\u8bf4\u660e</p> <pre><code>\u4e3b\u5e93 \u67e5\u770b\u540c\u6b65\u72b6\u6001\npostgres=# select * from pg_stat_replication ;\n-[ RECORD 1 ]----+------------------------------\npid              | 21092\nusesysid         | 10\nusename          | postgres\napplication_name | walreceiver\nclient_addr      | 10.1.0.15\nclient_hostname  | \nclient_port      | 14703\nbackend_start    | 2018-12-19 14:28:15.220479+08\nbackend_xmin     | \nstate            | streaming\nsent_lsn         | 2/B1BDC000\nwrite_lsn        | 2/B1B3C000\nflush_lsn        | 2/B1B3C000\nreplay_lsn       | 2/B1B3A3B0\nwrite_lag        | 00:44:13.27416\nflush_lag        | 00:44:13.27416\nreplay_lag       | 00:44:13.274217\nsync_priority    | 0\nsync_state       | async\n\n\u4ece\u5e93 \u67e5\u770bwal receiver\u7684\u7edf\u8ba1\u4fe1\u606f\nselect * from pg_stat_wal_receiver ;\n-[ RECORD 1 ]---------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\npid                   | 9329\nstatus                | streaming\nreceive_start_lsn     | 0/3000000\nreceive_start_tli     | 1\nreceived_lsn          | 2/DA5FC000\nreceived_tli          | 1\nlast_msg_send_time    | 2018-12-19 15:25:43.662966+08\nlast_msg_receipt_time | 2018-12-19 15:25:43.846309+08\nlatest_end_lsn        | A/D09F1758\nlatest_end_time       | 2018-12-19 15:25:40.694523+08\nslot_name             | node_a_slot\nconninfo              | user=postgres passfile=/root/.pgpass dbname=replication host=10.1.0.14 port=5432 fallback_application_name=walreceiver sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any\n\n-- \u6682\u505cWAL\u7684\u5e94\u7528\uff0c\u4f8b\u5982\u8981\u505a\u4e00\u4e9b\u6392\u9519\u65f6  \nselect pg_wal_replay_pause();  \n-[ RECORD 1 ]-------+-  \npg_wal_replay_pause |   \n\n-- \u67e5\u770b\u72b6\u6001  \nselect pg_is_wal_replay_paused();  \n-[ RECORD 1 ]-----------+--  \npg_is_wal_replay_paused | t  \n\n-- \u6062\u590dwal \nselect pg_wal_replay_resume();  \n-[ RECORD 1 ]--------+-  \npg_wal_replay_resume |   \n\n-- \u67e5\u770b\u72b6\u6001\nselect pg_is_wal_replay_paused();  \n-[ RECORD 1 ]-----------+--  \npg_is_wal_replay_paused | f  \n\n</code></pre>"},{"location":"postgres/replication/replication01/#wal","title":"wal \u65e5\u5fd7\u4fdd\u6301\u65f6\u6548","text":"<p>PostgreSQL 9.4 \u65b0\u589e\u7684\u4e00\u4e2a\u7279\u6027, replication slot,  -  \u53ef\u4ee5\u88ab\u6d41\u590d\u5236\u7684sender\u8282\u70b9\u7528\u4e8e\u81ea\u52a8\u8bc6\u522b\u5b83xlog\u4e2d\u7684\u6570\u636e\u5728\u4e0b\u9762\u7684standby\u4e2d\u662f\u5426\u8fd8\u9700\u8981(\u4f8b\u5982, standby\u65ad\u5f00\u8fde\u63a5\u540e, \u8fd8\u672a\u63a5\u6536\u5230\u7684XLOG), \u5982\u679c\u8fd8\u9700\u8981\u7684\u8bdd, \u90a3\u4e48\u8fd9\u4e9bXLOG\u5c06\u4e0d\u4f1a\u88ab\u5220\u9664. -  \u5bf9\u4e8etuples, \u5982\u679cstandby \u914d\u7f6e\u4e86hot_standby_feedback=on, \u90a3\u4e48\u53d1\u751f\u51b2\u7a81\u7684tuples\u5c06\u4e0d\u4f1a\u5728sender\u7aef\u88abvacuum\u56de\u6536. \u7528\u4e8e\u89c4\u907f\u51b2\u7a81.</p> <p>\u914d\u7f6e\u6bd4\u8f83\u7b80\u5355, \u9700\u8981\u5728sender\u7aef\u4f7f\u7528\u51fd\u6570\u521b\u5efaslot, \u5728receiver\u7aef\u914d\u7f6e\u5bf9\u5e94\u7684slot name\u5373\u53ef.</p> <p>\u4e3b\u5e93\uff1a</p> <pre><code>postgres=# SELECT * FROM pg_create_physical_replication_slot('node_a_slot');\n  slotname   | xlog_position\n-------------+---------------\n node_a_slot |\n\npostgres=# SELECT * FROM pg_replication_slots;\n  slot_name  | slot_type | datoid | database | active | xmin | restart_lsn\n-------------+-----------+--------+----------+--------+------+-------------\n node_a_slot | physical  |      0 |          | f      |    \n</code></pre> <pre><code>\u4ece\u5e93 \ncat recovery.conf \n\nprimary_slot_name = 'node_a_slot'\n</code></pre> <p>\u6d41\u590d\u5236\u534f\u8bae\u4e5f\u505a\u4e86\u76f8\u5e94\u7684\u6539\u8fdb : </p> <p>\u4f7f\u7528slot\u7684\u597d\u5904 :    </p> <ul> <li>\u5728\u6ca1\u6709replication slot\u8fd9\u4e2a\u7279\u6027\u4ee5\u524d, \u6709\u4e24\u79cd\u65b9\u6cd5\u6765\u4fdd\u6301standby\u9700\u8981\u7684xlog, wal keep\u6216\u8005\u5f52\u6863, \u56e0\u4e3a\u4e3b\u8282\u70b9\u4e0d\u77e5\u9053standby\u5230\u5e95\u9700\u8981\u54ea\u4e9bXLOG\u4fe1\u606f, \u914d\u7f6e\u4e00\u822c\u9700\u8981\u8f83\u5927\u7684\u4f59\u91cf. slot\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u6d6a\u8d39sender\u7aef\u5b58\u50a8wal\u7a7a\u95f4\u7684\u95ee\u9898, \u56e0\u4e3asender\u53ef\u4ee5\u505a\u5230\u4fdd\u7559\u66f4\u7cbe\u51c6\u7684wal\u4fe1\u606f.</li> <li>\u914d\u5408standby\u8282\u70b9\u7684feedback\u4f7f\u7528, \u53ef\u4ee5\u907f\u514dvacuum\u5e26\u6765\u7684\u51b2\u7a81.</li> </ul>"},{"location":"postgres/replication/replication01/#vs","title":"\u540c\u6b65\u590d\u5236VS\u5f02\u6b65\u590d\u5236","text":"<p>PostgreSql\u7684\u6d41\u590d\u5236\u662f\u5f02\u6b65\u7684\uff0c\u7f3a\u70b9\u662fStandby\u4e0a\u7684\u6570\u636e\u843d\u540e\u4e8e\u4e3b\u5e93\u4e0a\u7684\u6570\u636e\uff0c\u5982\u679c\u4f7f\u7528Hot Standby\u505a\u8bfb\u5199\u5206\u79bb\uff0c\u5c31\u4f1a\u5b58\u5728\u6570\u636e\u4e00\u81f4\u6027\u7684\u95ee\u9898\u3002PostgreSql9.1\u7248\u672c\u540e\u63d0\u4f9b\u4e86\u540c\u6b65\u6d41\u590d\u5236\u7684\u67b6\u6784\u3002\u540c\u6b65\u590d\u5236\u7684\u8981\u6c42\u5728\u6570\u636e\u5199\u5165Standby\u6570\u636e\u5e93\u540e\uff0c\u4e8b\u52a1commit\u624d\u8fd4\u56de\u3002 \u5b58\u5728\u95ee\u9898\uff1a\u5f53Standby\u6570\u636e\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u5e93\u88abhang\u4f4f\u3002 \u89e3\u51b3\u65b9\u6cd5\uff1a\u542f\u52a8\u4e24\u4e2a\u6216\u4e24\u4e2a\u4ee5\u4e0a\u7684Standby\u6570\u636e\u5e93\u3002</p> <p>\u914d\u7f6e\u65b9\u6cd5\uff0c\u5728\u4e3b\u4ece\u914d\u7f6e\u57fa\u7840\u4e0a</p> <p>\u4e3b\u5e93synchronous_standby_names \u53c2\u6570\u6307\u5b9a\u591a\u4e2aStandby\u7684\u540d\u79f0\uff0c\u5404\u4e2a\u540d\u79f0\u901a\u8fc7\u9017\u53f7\u5206\u5272\uff0c\u800cStandby\u8fde\u63a5\u5230\u4e3b\u5e93\u7531application_name \u53c2\u6570\u6307\u5b9a</p> <p>\u4e3b\u5e93</p> <pre><code>vi postgresql.conf\nsynchronous_standby_names = 'standby01,standby02'\n</code></pre> <p>\u4ece\u5e93</p> <pre><code>cat recovery.conf \nstandby_mode = 'on'\nprimary_conninfo = 'application_name=standby02 user=postgres host=10.2.0.14 port=5432 sslmode=disable sslcompression=1'\n</code></pre> <p>\u4e3b\u5e93\u67e5\u770b\u7ed3\u679c</p> <pre><code>psql -U postgres\npostgres=# select sync_priority,sync_state from pg_stat_replication ;\n</code></pre> <p>sync_priority,sync_priority \u72b6\u6001\u8bf4\u660e</p>"},{"location":"postgres/replication/replication01/#_7","title":"\u4ece\u53d8\u4e3b","text":""},{"location":"postgres/replication/replication01/#_8","title":"\u7b80\u5355\u6709\u6548\u7684\u65b9\u5f0f","text":"<p>\u5728\u4ece\u5e93\u4e2d\u914d\u7f6e cat recovery.conf</p> <pre><code>trigger_file = '/home/postgres.trigger'\n</code></pre> <p>\u91cd\u542f\u4ece\u5e93</p> <p>\u5c06\u4ece\u5e93\u53d8\u6210\u4e3b\u5e93</p> <pre><code>touch /home/postgres.trigger\n</code></pre>"},{"location":"postgres/replication/replication01/#pg_ctl-promote","title":"pg_ctl promote","text":"<pre><code>pg_ctl promote -D $PGDATA\nserver promoting\n</code></pre>"},{"location":"postgres/replication/replication01/#pg_rewind","title":"pg_rewind","text":""},{"location":"postgres/replication/replication01/#_9","title":"\u4ece\u5e93\u6709\u67e5\u8be2\u4e1a\u52a1\u65f6\u6ce8\u610f\u4e8b\u9879","text":"<pre><code> 1. \u5982\u679c\u5907\u5e93\u6709LONG query\uff0c\u540c\u65f6\u9700\u8981\u5b9e\u65f6\u6027\uff0c\u53ef\u4ee5\u8bbe\u7f6ehot_standby_feedback=on\uff0c\u540c\u65f6\u5efa\u8bae\u5c06\u4e3b\u5e93\u7684autovacuum_naptime\uff0cautovacuum_vacuum_scale_factor\u8bbe\u7f6e\u4e3a\u8f83\u5927\u503c\uff08\u4f8b\u598260\u79d2\uff0c0.1\uff09\uff0c\n    \u4e3b\u5e93\u7684\u5783\u573e\u56de\u6536\u5524\u9192\u95f4\u9694\u4f1a\u957f\u4e00\u70b9\uff0c\u5982\u679c\u7a81\u7136\u4ea7\u751f\u5f88\u591a\u5783\u573e\uff0c\u53ef\u80fd\u4f1a\u9020\u6210\u4e00\u5b9a\u7684\u81a8\u80c0\u3002\n 2. \u5982\u679c\u5907\u5e93\u6709LONG QUERY\uff0c\u5e76\u4e14\u6ca1\u6709\u5f88\u9ad8\u7684\u5b9e\u65f6\u6027\u8981\u6c42\uff0c\u5efa\u8bae\u8bbe\u7f6e\u8bbe\u7f6ehot_standby_feedback=off, \u540c\u65f6\u8bbe\u7f6e\u8f83\u5927\u7684max_standby_archive_delay\uff0c max_standby_streaming_delay\u3002\n</code></pre>"},{"location":"postgres/replication/replication01/#_10","title":"\u6269\u5c55\u9605\u8bfb","text":"<ul> <li> <p>PostgreSQL 10\u52a0\u5165\u4e86quorum based\u7684\u540c\u6b65\u590d\u5236\u529f\u80fd\uff0c\u7528\u6237\u53ef\u4ee5\u914d\u7f6e\u82e5\u5e72standby\u8282\u70b9\uff0c\u5e76\u914d\u7f6e\u9700\u8981\u5c06WAL\u53d1\u9001\u591a\u5c11\u4efd\u624d\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u4e8b\u52a1\u7ed3\u675f\u7684\u6d88\u606f\u3002</p> </li> <li> <p>\u6027\u80fd </p> </li> </ul>"},{"location":"postgres/replication/replication01/#_11","title":"\u51b2\u7a81\u53ca\u89e3\u51b3","text":""},{"location":"postgres/replication/replication01/#_12","title":"\u51b2\u7a81","text":"<pre><code>FATAL:  terminating connection due to conflict with recovery  \nDETAIL:  User query might have needed to see row versions that must be removed.  \nHINT:  In a moment you should be able to reconnect to the database and repeat your command. \n</code></pre>"},{"location":"postgres/replication/replication01/#_13","title":"\u539f\u56e0","text":"<p>\u62a5\u9519\u662f\u5907\u5e93\u4e8b\u52a1\u6216\u8005\u5355SQL\u67e5\u8be2\u65f6\u95f4\u957f\uff0c\u548c\u5907\u5e93\u7684\u65e5\u5fd7apply\u53d1\u751f\u51b2\u7a81\uff0c\u5982\u679c\u4e1a\u52a1\u4e0a\u6709\u957f\u4e8b\u52a1\u3001\u957f\u67e5\u8be2\uff0c\u4e3b\u5e93\u4e0a\u53c8\u518d\u4fee\u6539\u540c\u4e00\u884c\u6570\u636e\uff0c\u5f88\u5bb9\u6613\u9020\u6210\u5907\u5e93\u7684wal\u65e5\u5fd7\u65e0\u6cd5apply\u3002</p> <p>wal\u65e0\u6cd5apply\u6570\u636e\u5e93\u6709\u4e24\u4e2a\u7b56\u7565\uff1a</p> <ul> <li> <p>\u5907\u5e93\u544a\u8bc9\u4e3b\u5e93\u9700\u8981\u54ea\u4e9b\u7248\u672c\uff0c\u8ba9\u4e3b\u5e93\u4fdd\u7559\uff0c\u5907\u5e93\u67e5\u8be2\u59cb\u7ec8\u80fd\u62ff\u5230\u9700\u8981\u7684\u7248\u672c\uff0c\u4e0d\u963b\u585eapply\uff0c\u56e0\u4e3a\u5907\u5e93\u603b\u80fd\u62ff\u5230\u9700\u8981\u7684\u7248\u672c</p> </li> <li> <p>\u5907\u5e93apply\u8fdb\u5165\u7b49\u5f85\uff0c\u76f4\u5230\u5907\u5e93\u51b2\u7a81\u67e5\u8be2\u7ed3\u675f\uff0c\u7ee7\u7eedapply\u3002\u53ef\u4ee5\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\u3002max_standby_streaming_delay</p> </li> </ul>"},{"location":"postgres/replication/replication01/#_14","title":"\u5bf9\u5e94\u89e3\u51b3\u65b9\u6cd5","text":"<p>\u65b9\u6cd5\u4e00</p> <pre><code>vacuum_defer_cleanup_age &gt; 0\n\u6216\nhot_standby_feedback=on\n\n</code></pre> <p>\u4ee3\u4ef71\uff0c\u4e3b\u5e93\u81a8\u80c0\uff0c\u56e0\u4e3a\u5783\u573e\u7248\u672c\u8981\u5ef6\u8fdf\u82e5\u5e72\u4e2a\u4e8b\u52a1\u540e\u624d\u80fd\u88ab\u56de\u6536\u3002</p> <p>\u4ee3\u4ef72\uff0c\u91cd\u590d\u626b\u63cf\u5783\u573e\u7248\u672c\uff0c\u91cd\u590d\u8017\u8d39\u5783\u573e\u56de\u6536\u8fdb\u7a0b\u7684CPU\u8d44\u6e90\u3002\uff08n_dead_tup\u4f1a\u4e00\u76f4\u5904\u4e8e\u8d85\u8fc7\u5783\u573e\u56de\u6536\u9608\u503c\u7684\u72b6\u6001\uff0c\u4ece\u800cautovacuum \u4e0d\u65ad\u5524\u9192worker\u8fdb\u884c\u56de\u6536\u52a8\u4f5c\uff09\u3002</p> <p>\u4ee3\u4ef73\uff0c\u5982\u679c\u671f\u95f4\u53d1\u751f\u5927\u91cf\u5783\u573e\uff0c\u5783\u573e\u7248\u672c\u53ef\u80fd\u4f1a\u5728\u4e8b\u52a1\u5230\u8fbe\u5e76\u89e3\u7981\u540e\uff0c\u7206\u70b8\u6027\u7684\u88ab\u56de\u6536\uff0c\u4ea7\u751f\u5927\u91cf\u7684WAL\u65e5\u5fd7\uff0c\u4ece\u800c\u9020\u6210WAL\u7684\u5199IO\u5c16\u523a\u3002</p> <p>\u65b9\u6cd5\u4e8c</p> <pre><code>max_standby_streaming_delay\n\nmax_standby_archive_delay\u548cmax_standby_streaming_delay\n</code></pre> <p>\u4ee3\u4ef7\uff0c\u5982\u679c\u5907\u5e93\u7684QUERY\u4e0eAPPLY\uff08\u6062\u590d\u8fdb\u7a0b\uff09\u51b2\u7a81\uff0c\u90a3\u4e48\u5907\u5e93\u7684apply\u4f1a\u51fa\u73b0\u5ef6\u8fdf\uff0c\u4e5f\u8bb8\u4ece\u5907\u5e93\u8bfb\u5230\u7684\u662fN\u79d2\u4ee5\u524d\u7684\u6570\u636e\u3002</p> <p>12 pg 12 \u53d8\u66f4</p> <ul> <li> <p>recovery.conf \u4e2d\u7684\u914d\u7f6e\u5185\u5bb9\u4f4d\u7f6e\u53d8\u66f4\u5230postgresql.auto.conf</p> </li> <li> <p>trigger_file -&gt; promte_trigger_file</p> </li> <li> <p>\u589e\u52a0 standby.signal recovery.signal</p> </li> </ul> <p>13 \u865a\u62df\u5907\u5e93</p> <pre><code>pg_receivewal\n</code></pre> <p>\u5907\u4efd\u589e\u91cfwal\u65e5\u5fd7\uff0c\u5e76\u53ef\u538b\u7f29\u5907\u4efd\u3002\u7ed3\u5408wal-g \u505a\u6570\u636e\u5907\u4efd</p>"},{"location":"postgres/replication/replication01/#_15","title":"\u4e3b\u4ece\u5ef6\u8fdf\u67e5\u770b","text":"<p>\u4e3b\u5e93\u67e5\u770b/\u5b57\u8282\u5927\u5c0f</p> <pre><code>#\u6570\u636e\u5ef6\u8fdf\nselect pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(),replay_lsn)) as latency from pg_stat_replication ;\n\n#wal \u4e0d\u540c\u9636\u6bb5\u5ef6\u8fdf\nselect pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(),sent_lsn)) as sent_latency, pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(),write_lsn)) as write_latency ,pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(),flush_lsn)) as flush_latency,pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(),replay_lsn)) as replay_latency from pg_stat_replication ;\n\n</code></pre> <p>\u4ece\u5e93\u67e5\u770b/\u65f6\u95f4</p> <pre><code>select now() - pg_last_xact_replay_timestamp();\n</code></pre>"},{"location":"postgres/replication/replication02/","title":"\u6d41\u590d\u5236\u540c\u6b65\u7ea7\u522b","text":""},{"location":"postgres/replication/replication02/#_1","title":"\u6d41\u590d\u5236\u8fc7\u7a0b","text":"<pre><code>synchronous_commit = on  \uff09              # synchronization level;  on default \n                                        # off, local, remote_write, or on  \n</code></pre>"},{"location":"postgres/replication/replication02/#_2","title":"\u540c\u6b65\u7ea7\u522b","text":"<ul> <li> <p>remote_apply\uff1a\u4e8b\u52a1commit\u6216rollback\u65f6\uff0c\u7b49\u5f85\u5176redo\u5728primary\u3001\u4ee5\u53ca\u540c\u6b65standby(s)\u5df2\u6301\u4e45\u5316\uff0c\u5e76\u4e14\u5176redo\u5728\u540c\u6b65 standby(s)\u5df2apply\u3002</p> </li> <li> <p>on\uff1a\u4e8b\u52a1commit\u6216rollback\u65f6\uff0c\u7b49\u5f85\u5176redo\u5728primary\u3001\u4ee5\u53ca\u540c\u6b65standby(s)\u5df2\u6301\u4e45\u5316\u3002</p> </li> <li> <p>remote_write\uff1a\u4e8b\u52a1commit\u6216rollback\u65f6\uff0c\u7b49\u5f85\u5176redo\u5728primary\u5df2\u6301\u4e45\u5316; \u5176redo\u5728\u540c\u6b65standby(s)\u5df2\u8c03\u7528write\u63a5\u53e3(\u5199\u5230 OS, \u4f46\u662f\u8fd8\u6ca1\u6709\u8c03\u7528\u6301\u4e45\u5316\u63a5\u53e3\u5982fsync)\u3002</p> </li> <li> <p>local\uff1a\u4e8b\u52a1commit\u6216rollback\u65f6\uff0c\u7b49\u5f85\u5176redo\u5728primary\u5df2\u6301\u4e45\u5316;</p> </li> <li> <p>off\uff1a\u4e8b\u52a1commit\u6216rollback\u65f6\uff0c\u7b49\u5f85\u5176redo\u5728primary\u5df2\u5199\u5165wal buffer\uff0c\u4e0d\u9700\u8981\u7b49\u5f85\u5176\u6301\u4e45\u5316;</p> </li> </ul> <p>\u5b89\u5168\u7b49\u7ea7\u4e0e\u6027\u80fd\u5f71\u54cd\u7efc\u5408\u8003\u91cf</p> <p>\u4ece\u4e0a\u5230\u4e0b\uff1a \u5b89\u5168\u7b49\u7ea7\u964d\u4f4e\u3002</p> <p>\u4ece\u4e0b\u5230\u4e0a\uff1a \u6027\u80fd\u5f71\u54cd\u589e\u52a0\u3002</p>"},{"location":"postgres/security/login_nopasswd/","title":"\u6570\u636e\u5e93\u514d\u5bc6\u7801\u767b\u9646","text":"","tags":[]},{"location":"postgres/security/login_nopasswd/#_1","title":"\u514d\u5bc6\u767b\u9646","text":"<p>\u4ee5\u4e0b\u51e0\u79cdPG\u914d\u7f6e\u514d\u5bc6\u7684\u65b9\u6cd5\u3002</p>","tags":[]},{"location":"postgres/security/login_nopasswd/#pg_habconf-trust","title":"\u65b9\u6cd5\u4e00\uff1a\u8bbe\u7f6epg_hab.conf \u8ba4\u8bc1\u65b9\u5f0f\u4e3atrust","text":"<pre><code>#Type database user address method\nhost all postgres 127.0.0.1/32 trust\n</code></pre> <p>\u8be5\u65b9\u5f0f\u6700\u4e0d\u5b89\u5168\uff0c\u5bfc\u81f4\u901a\u8fc7\u6307\u5b9aIP\u8fde\u63a5\u6570\u636e\u5e93\u7684\u8fde\u63a5\u90fd\u53ef\u4ee5\u4efb\u610f\u767b\u5f55\u6570\u636e\uff0c\u6beb\u65e0\u5b89\u5168\u4fdd\u969c\u3002\u7981\u6b62\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u3002</p>","tags":[]},{"location":"postgres/security/login_nopasswd/#pgpgpassword","title":"\u65b9\u6cd5\u4e8c\uff1a\u8bbe\u7f6ePG\u73af\u5883\u53d8\u91cfPGPASSWORD","text":"<p>PGPASSWORD\u662fPostgreSQL\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\uff0c\u5728\u5ba2\u6237\u7aef\u8bbe\u7f6e\u540e\u518d\u8fdc\u7a0b\u8fde\u63a5\u6570\u636e\u5e93\u65f6\uff0c\u5c06\u4f18\u5148\u4f7f\u7528\u8fd9\u4e2a\u5bc6\u7801\u3002</p> <pre><code>[postgres@PG-1 ~]$ export PGPASSWORD=root\n[postgres@PG-1 ~]$ psql -U postgres -h 127.0.0.1 -p 5432\nTiming is on.\nBorder style is 2.\nNull display is \"NULL\".\npsql (13.2)\nType \"help\" for help.\n</code></pre> <p>\u6b64\u65f6\u6570\u636e\u5e93\u767b\u5f55\u65f6\uff0c\u4e0d\u5728\u63d0\u793a\u8f93\u5165\u7528\u6237\u5bc6\u7801</p>","tags":[]},{"location":"postgres/security/login_nopasswd/#pgservice","title":"\u65b9\u6cd5\u4e09\uff1a\u8bbe\u7f6e\u73af\u5883\u53d8\u91cfPGSERVICE","text":"<p>pg_service.conf \u901a\u8fc7\u5b9a\u4e49\u670d\u52a1\u6587\u4ef6\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u5bf9\u591a\u4e2a\u6570\u636e\u5e93\u8fdb\u884c\u514d\u5bc6\u767b\u5f55\u3002</p> <pre><code>\nvi /home/postgres/.pg_service.conf\n[backup]\nhostaddr=127.0.0.1\nport=5432\nuser=postgres\ndbname=postgres\npassword=root\nconnect_timeout=10\n[postgres@PG-1 ~]$ export PGSERVICE=backup\n[postgres@PG-1 ~]$ psql -h 127.0.0.1 -p 5432 -U postgres\nTiming is on.\nBorder style is 2.\nNull display is \"NULL\".\npsql (13.2)\nType \"help\" for help.\n</code></pre> <p>\u5b9a\u4e49pg_service.conf\u6587\u4ef6\uff0c\u8be5\u6587\u4ef6\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u6a21\u5757\uff0c\u6bcf\u4e2a\u6a21\u5757\u4ee3\u8868\u4e00\u4e2a\u8fde\u63a5\u3002</p>","tags":[]},{"location":"postgres/security/login_nopasswd/#pgpass","title":"\u65b9\u6cd5\u56db\uff1a\u8bbe\u7f6e.pgpass\u6587\u4ef6","text":"<p>\u6539\u6587\u4ef6\u9ed8\u8ba4\u5728/home/postgres/\uff0c\u4e14\u8be5\u6587\u4ef6\u7684\u6743\u9650\u8981\u4e3a600\uff0c\u5982\u679c\u6587\u4ef6\u6743\u9650\u4e0d\u5bf9\uff0c\u5219\u5728\u767b\u5f55\u4f1a\u6709\u76f8\u5e94\u7684\u544a\u8b66\u8f93\u51fa\uff0c\u5e76\u8981\u6c42\u8f93\u5165\u7528\u6237\u5bc6\u7801\u3002</p> <pre><code>WARNING: password file \"/home/postgres/.pgpass\" has group or world access; permissions should be u=rw (0600) or less\nPassword for user postgres:\n</code></pre> <p>\u5185\u5bb9\u683c\u5f0f\uff1a</p> <pre><code>host:port:dbname:username:password\n</code></pre> <pre><code>[postgres@PG-1 ~]$ cat .pgpass\n127.0.0.1:5432:postgres:postgres:root\nlocalhost:5432:postgres:postgres:root\n</code></pre> <p>\u6587\u4ef6\u6743\u9650\uff1a</p> <pre><code>[postgres@PG-1 ~]$ ll -h .pgpass\n-rw------- 1 postgres postgres 76 2\u6708 24 19:26 .pgpass\n</code></pre> <p>\u767b\u5f55\uff1a</p> <pre><code>[postgres@PG-1 ~]$ psql -U postgres -h 127.0.0.1 -p 5432\nTiming is on.\nBorder style is 2.\nNull display is \"NULL\".\npsql (13.2)\nType \"help\" for help.\n</code></pre>","tags":[]},{"location":"postgres/security/login_nopasswd/#pg_habconf-ident-peer","title":"\u65b9\u6cd5\u4e94\uff1a \u8bbe\u7f6epg_hab.conf \u4e3a ident \u6216 peer","text":"<p>peer \u65b9\u5f0f\u4e00 </p> <pre><code>local   all    all       peer\n</code></pre> <p>peer \u65b9\u5f0f\u4e8c</p> <pre><code>local   all    all       peer map=t\n</code></pre> <p>\u518d\u914d\u7f6epg_ident.conf</p> <pre><code>#mapping name      os user name      db user name\nt                  os_user           postgres\n</code></pre> <p>ident \u65b9\u5f0f</p> <pre><code>host   all    all       ident map=t\n</code></pre> <p>\u518d\u914d\u7f6epg_ident.conf</p> <pre><code>#mapping name      os user name      db user name\nt                  os_user           postgres\n</code></pre> <p>peer \u548c ident \u533a\u522b</p> <ul> <li> <p>\u90fd\u662f\u57fa\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\u8ba4\u8bc1\uff0c\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\u6620\u5c04\u6570\u636e\u5e93\u7528\u6237\u8fdb\u884c\u8ba4\u8bc1\uff0cpeer\u65b9\u5f0f\u6570\u636e\u5e93\u8bbf\u95ee\u5ba2\u6237\u7aef\u4e0e\u6570\u636e\u5e93\u670d\u52a1\u5668\u5fc5\u987b\u5728\u540c\u4e00\u53f0\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0cident\u65b9\u5f0f\u5219\u4e0d\u662f\u3002   peer\u4f7f\u7528unix socket\u4f1a\u8bdd\uff0cpsql\u8bbf\u95ee\u65f6\u4e0d\u6307\u5b9a-h \u6216\u8005-h localhost \u6216\u8005-h $PGDATA</p> </li> <li> <p>ident\u4f7f\u7528tcp\u4f1a\u8bdd\uff0cpsql\u8bbf\u95ee\u65f6-h 127.0.0.1 \u6216host</p> </li> </ul>","tags":[]},{"location":"postgres/security/prepare/","title":"\u4f7f\u7528prepare\u9884\u7f16\u8bd1SQL","text":"","tags":[]},{"location":"postgres/security/prepare/#_1","title":"\u4f7f\u7528\u9884\u7f16\u8bd1\u4f18\u52bf\u4ecb\u7ecd","text":"<p>\u5728\u6267\u884c\u4e00\u4e2aSQL\u65f6\uff0c\u9996\u5148\u751f\u6210\u6267\u884c\u8ba1\u5212\uff08\u8fdb\u884c\u8bed\u4e49\u5206\u6790\u3001\u8bcd\u6cd5\u89e3\u6790\u3001\u903b\u8f91\u4f18\u5316\u3001\u7269\u7406\u4f18\u5316\uff09\u3001\u6267\u884c\u3001\u7ed3\u679c\u4f20\u8f93\u7b49\u64cd\u4f5c\u3002 \u5982\u679c\u4e00\u4e2aSQL\u5728\u5e94\u7528\u4e2d\u53cd\u590d\u4f7f\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u6b64SQL\u53c2\u6570\u5316\uff0c\u53ea\u505a\u4e00\u6b21prepare\uff0c\u540e\u9762\u6267\u884c\u65f6\u5c31\u4e0d\u9700\u8981\u8fdb\u884c\u524d\u9762\u6267\u884c\u8ba1\u5212\u7684\u751f\u6210\u64cd\u4f5c\uff0c\u76f4\u63a5\u4f7f\u7528prepare\u597d\u7684\u6267\u884c\u8ba1\u5212\u3002</p> <p>\u5bf9\u4e8e\u6bd4\u8f83\u957f\u7684SQL\u3001\u53c2\u6570\u8f83\u56fa\u5b9a\u7684SQL\uff0c\u53ef\u4ee5\u4f7f\u7528prepare\uff0c</p> <p>\u7279\u70b9\uff1a 1) Prepared\u8bed\u53e5\u53ea\u5728session\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\u5b58\u5728\uff0c\u4e00\u65e6session\u7ed3\u675f\uff0cPrepared\u8bed\u53e5\u4e5f\u4e0d\u5b58\u5728\u4e86\u3002\u5982\u679c\u4e0b\u6b21\u518d\u4f7f\u7528\u9700\u91cd\u65b0\u521b\u5efa\u3002 2) Prepared\u8bed\u53e5\u4e0d\u80fd\u5728\u591a\u4e2a\u5e76\u53d1\u7684client\u4e2d\u5171\u6709\u3002 3) prepared\u8bed\u53e5\u53ef\u4ee5\u901a\u8fc7DEALLOCATE\u547d\u4ee4\u6e05\u9664\u3002 4) \u5f53\u524dsession\u7684prepared\u8bed\u53e5\uff1apg_prepared_statements</p> <pre><code>-- \u521b\u5efa\nPREPARE test_pre(id, name) AS select id,name t where id = $1;\n\n-- \u4f7f\u7528\nexplain analyze EXECUTE test_pre(1);\n Index Scan using t_pkey on t  (cost=0.29..2.51 rows=1 width=16) (actual time=0.019..0.021 rows=1 loops=1)\n   Index Cond: (id = $1)\n Planning Time: 0.015 ms\n Execution Time: 0.049 ms\n</code></pre> <p>\u770b\u89c1 $1  \u8bf4\u660e\u7b26\u5408\u9884\u671f</p>","tags":[]},{"location":"postgres/security/readonly/","title":"\u521b\u5efa\u53ea\u8bfb\u7528\u6237","text":""},{"location":"postgres/security/readonly/#readonly","title":"\u521b\u5efa\u53ea\u8bfb\u7528\u6237readonly","text":"<pre><code>1.\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u540d\u4e3areadonly\u5bc6\u7801\u4e3aropass\u7684\u7528\u6237\nCREATE USER readonly WITH ENCRYPTED PASSWORD 'ropass';\n\n2.\u7528\u6237\u53ea\u8bfb\u4e8b\u52a1\nalter user readonly set default_transaction_read_only=on;\n\n3.\u628a\u6240\u6709\u5e93\u7684\u8bed\u8a00\u7684USAGE\u6743\u9650\u7ed9\u5230readonly\nGRANT USAGE ON SCHEMA public to readonly;      \n\n4.\u6388\u4e88select\u6743\u9650(\u8fd9\u53e5\u8981\u8fdb\u5165\u5177\u4f53\u6570\u636e\u5e93\u64cd\u4f5c\u5728\u54ea\u4e2adb\u73af\u5883\u6267\u884c\u5c31\u6388\u4e88\u90a3\u4e2adb\u7684\u6743)\n grant select on all tables in schema public to readonly;\n\n</code></pre>"},{"location":"postgres/security/readonly/#_1","title":"\u67e5\u770b\u8868\u5bf9\u8c61\u5bf9\u5e94\u7684\u7528\u6237\u6743\u9650","text":"<pre><code>SELECT n.nspname as \"Schema\",\n  c.relname as \"Name\",\n  CASE c.relkind WHEN 'r' THEN 'table' WHEN 'v' THEN 'view' WHEN 'm' THEN 'materialized view' WHEN 'S' THEN 'sequence' WHEN 'f' THEN 'foreign table' END as \"Type\",\n  pg_catalog.array_to_string(c.relacl, E'\\n') AS \"Access privileges\",\n  pg_catalog.array_to_string(ARRAY(\n    SELECT attname || E':\\n  ' || pg_catalog.array_to_string(attacl, E'\\n  ')\n    FROM pg_catalog.pg_attribute a\n    WHERE attrelid = c.oid AND NOT attisdropped AND attacl IS NOT NULL\n  ), E'\\n') AS \"Column privileges\",\n  pg_catalog.array_to_string(ARRAY(\n    SELECT polname\n    || CASE WHEN polcmd != '*' THEN\n           E' (' || polcmd || E'):'\n       ELSE E':' \n       END\n    || CASE WHEN polqual IS NOT NULL THEN\n           E'\\n  (u): ' || pg_catalog.pg_get_expr(polqual, polrelid)\n       ELSE E''\n       END\n    || CASE WHEN polwithcheck IS NOT NULL THEN\n           E'\\n  (c): ' || pg_catalog.pg_get_expr(polwithcheck, polrelid)\n       ELSE E''\n       END    || CASE WHEN polroles &lt;&gt; '{0}' THEN\n           E'\\n  to: ' || pg_catalog.array_to_string(\n               ARRAY(\n                   SELECT rolname\n                   FROM pg_catalog.pg_roles\n                   WHERE oid = ANY (polroles)\n                   ORDER BY 1\n               ), E', ')\n       ELSE E''\n       END\n    FROM pg_catalog.pg_policy pol\n    WHERE polrelid = c.oid), E'\\n')\n    AS \"Policies\"\nFROM pg_catalog.pg_class c\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\nWHERE c.relkind IN ('r', 'v', 'm', 'S', 'f')\n  AND n.nspname !~ '^pg_' AND pg_catalog.pg_table_is_visible(c.oid)\nORDER BY 1, 2;\n</code></pre>"},{"location":"postgres/security/role-manager/","title":"\u6743\u9650\u7ba1\u7406","text":""},{"location":"postgres/security/role-manager/#_1","title":"\u521b\u5efa\u7528\u6237","text":"<pre><code># user \u4e0e role \u533a\u522b \uff0c user \u5177\u6709login\u6743\u9650\npostgres=# create user tester with password '123456';\nCREATE ROLE\n</code></pre>"},{"location":"postgres/security/role-manager/#_2","title":"\u521b\u5efa\u6570\u636e\u5e93,\u5e76\u5173\u8054\u6240\u6709\u8005","text":"<pre><code>postgres=# create database test owner tester ;\nCREATE DATABASE\n</code></pre>"},{"location":"postgres/security/role-manager/#_3","title":"\u53d8\u66f4\u6570\u636e\u5e93\u7528\u6237\u6240\u6709\u8005","text":"<pre><code>postgres=# alter database test owner to tester;\nALTER DATABASE\n</code></pre>"},{"location":"postgres/security/role-manager/#_4","title":"\u4fee\u6539\u7528\u6237&amp;\u6570\u636e\u5e93","text":"<pre><code>#\u7528\u6237\u8fde\u63a5\u6570\npostgres=# alter user tester connection limit 100;\nALTER ROLE\n#\u6570\u636e\u5e93\u8fde\u63a5\u6570\npostgres=# alter database test connection limit 100;\nALTER DATABASE\n\n#\u7528\u6237\u5176\u4ed6\u5c5e\u6027\u4fee\u6539\npostgres=# alter user tester \nBYPASSRLS           CREATEDB            ENCRYPTED PASSWORD  LOGIN               NOCREATEDB          NOINHERIT           NOREPLICATION       PASSWORD            REPLICATION         SET                 VALID UNTIL         \nCONNECTION LIMIT    CREATEROLE          INHERIT             NOBYPASSRLS         NOCREATEROLE        NOLOGIN             NOSUPERUSER         RENAME TO           RESET               SUPERUSER           WITH \n\n#\u6570\u636e\u5e93\u5176\u4ed6\u5c5e\u6027\u4fee\u6539\npostgres=# alter database test \nALLOW_CONNECTIONS  CONNECTION LIMIT   IS_TEMPLATE        OWNER TO           RENAME TO          RESET              SET \n</code></pre>"},{"location":"postgres/security/role-manager/#sqltableviewowner","title":"sql\u6279\u91cf\u4fee\u6539table/view\u7684owner","text":"<pre><code>DO $$DECLARE r record;\nBEGIN\nFOR r IN SELECT tablename/viewname FROM pg_tables/pg_views WHERE schemaname = 'public'\nLOOP\n    EXECUTE 'alter table '|| r.tablename/r.viewname ||' owner to new_owner;';\nEND LOOP;\nEND$$;\n</code></pre> <pre><code>DO $$DECLARE r record;\nBEGIN\nFOR r IN SELECT \n  c.relname as Name \nFROM pg_catalog.pg_class c\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\nWHERE c.relkind IN ('r','p','v','m','S','f','')\n      AND n.nspname &lt;&gt; 'pg_catalog'\n      AND n.nspname &lt;&gt; 'information_schema'\n      AND n.nspname !~ '^pg_toast'\n  AND pg_catalog.pg_table_is_visible(c.oid) \n  AND  pg_catalog.pg_get_userbyid(c.relowner) = 'postgres'\n  and n.nspname = 'public'\nLOOP\nEXECUTE 'alter table '|| r.Name ||' owner to new_owner;';\nEND LOOP;\nEND$$;\n</code></pre>"},{"location":"postgres/security/role-manager/#_5","title":"\u67e5\u770b\u7528\u6237&amp;\u6570\u636e\u5e93","text":"<pre><code>#\u67e5\u770b\u6570\u636e\u5e93\npostgres=# \\l+ test \n                                         \u6570\u636e\u5e93\u5217\u8868\n \u540d\u79f0 | \u62e5\u6709\u8005 | \u5b57\u5143\u7f16\u7801 |  \u6821\u5bf9\u89c4\u5219   |    Ctype    | \u5b58\u53d6\u6743\u9650 | \u5927\u5c0f  |   \u8868\u7a7a\u95f4   | \u63cf\u8ff0 \n------+--------+----------+-------------+-------------+----------+-------+------------+------\n test | tester | UTF8     | en_US.UTF-8 | en_US.UTF-8 |          | 14 MB | pg_default | \n(1 \u884c\u8bb0\u5f55)\n\n#\u67e5\u770b\u8868\n\npostgres=# \\d+\n\n#\u67e5\u770b\u7528\u6237\npostgres=# \\dg\n                                 \u89d2\u8272\u5217\u8868\n     \u89d2\u8272\u540d\u79f0     |                    \u5c5e\u6027                    | \u6210\u5458\u5c5e\u4e8e \n------------------+--------------------------------------------+----------\n postgres         | \u8d85\u7ea7\u7528\u6237, \u5efa\u7acb\u89d2\u8272, \u5efa\u7acb DB, \u590d\u5236, \u7ed5\u8fc7RLS | {}\n tester           | 10\u4e2a\u8fde\u63a5                                   | {}\n</code></pre>"},{"location":"postgres/security/role-manager/#_6","title":"\u6743\u9650\u5206\u914d","text":"<p>\u8bed\u6cd5</p> <p>grant \u6743\u9650 on \u6570\u636e\u5bf9\u8c61 to \u7528\u6237</p> <p>revoke \u6743\u9650 on \u6570\u636e\u5bf9\u8c61 from \u7528\u6237</p> <pre><code>grant SELECT on ALL tables in schema public TO dbuser;\n\nrevoke SELECT on ALL tables in schema public from dbuser;\n</code></pre> <p>\u66f4\u591a\u5185\u5bb9</p> <p>https://github.com/digoal/blog/blob/master/201605/20160510_01.md</p>"},{"location":"postgres/security/ssl/","title":"\u6570\u636e\u5e93 ssl\u8ba4\u8bc1","text":""},{"location":"postgres/security/ssl/#sslssl","title":"SSL\u53cc\u5411\u8ba4\u8bc1\u548cSSL\u5355\u5411\u8ba4\u8bc1\u7684\u533a\u522b","text":"<p>\u53cc\u5411\u8ba4\u8bc1 SSL \u534f\u8bae\u8981\u6c42\u670d\u52a1\u5668\u548c\u7528\u6237\u53cc\u65b9\u90fd\u6709\u8bc1\u4e66\u3002\u5355\u5411\u8ba4\u8bc1 SSL \u534f\u8bae\u4e0d\u9700\u8981\u5ba2\u6237\u62e5\u6709CA\u8bc1\u4e66\uff0c\u670d\u52a1\u5668\u7aef\u4e0d\u4f1a\u9a8c\u8bc1\u5ba2\u6237\u8bc1\u4e66\uff0c\u4ee5\u53ca\u5728\u534f\u5546\u5bf9\u79f0\u5bc6\u7801\u65b9\u6848\uff0c\u5bf9\u79f0\u901a\u8bdd\u5bc6\u94a5\u65f6\uff0c\u670d\u52a1\u5668\u53d1\u9001\u7ed9\u5ba2\u6237\u7684\u662f\u6ca1\u6709\u52a0\u8fc7\u5bc6\u7684(\u8fd9\u5e76\u4e0d\u5f71\u54cd SSL \u8fc7\u7a0b\u7684\u5b89\u5168\u6027)\u5bc6\u7801\u65b9\u6848\u3002</p> <p>\u8fd9\u6837\uff0c\u53cc\u65b9\u5177\u4f53\u7684\u901a\u8baf\u5185\u5bb9\uff0c\u90fd\u662f\u52a0\u8fc7\u5bc6\u7684\u6570\u636e\uff0c\u5982\u679c\u6709\u7b2c\u4e09\u65b9\u653b\u51fb\uff0c\u83b7\u5f97\u7684\u53ea\u662f\u52a0\u5bc6\u7684\u6570\u636e\uff0c\u7b2c\u4e09\u65b9\u8981\u83b7\u5f97\u6709\u7528\u7684\u4fe1\u606f\uff0c\u5c31\u9700\u8981\u5bf9\u52a0\u5bc6\u7684\u6570\u636e\u8fdb\u884c\u89e3\u5bc6\uff0c\u8fd9\u65f6\u5019\u7684\u5b89\u5168\u5c31\u4f9d\u8d56\u4e8e\u5bc6\u7801\u65b9\u6848\u7684\u5b89\u5168\u3002</p> <p>\u800c\u5e78\u8fd0\u7684\u662f\uff0c\u76ee\u524d\u6240\u7528\u7684\u5bc6\u7801\u65b9\u6848\uff0c\u53ea\u8981\u901a\u8baf\u5bc6\u94a5\u957f\u5ea6\u8db3\u591f\u7684\u957f\uff0c\u5c31\u8db3\u591f\u7684\u5b89\u5168\u3002\u8fd9\u4e5f\u662f\u6211\u4eec\u5f3a\u8c03\u8981\u6c42\u4f7f\u7528128\u4f4d\u52a0\u5bc6\u901a\u8baf\u7684\u539f\u56e0\u3002</p> <p>\u4e00\u822cWeb\u5e94\u7528\u90fd\u662f\u91c7\u7528SSL\u5355\u5411\u8ba4\u8bc1\u7684\uff0c\u539f\u56e0\u5f88\u7b80\u5355\uff0c\u7528\u6237\u6570\u76ee\u5e7f\u6cdb\uff0c\u4e14\u65e0\u9700\u5728\u901a\u8baf\u5c42\u5bf9\u7528\u6237\u8eab\u4efd\u8fdb\u884c\u9a8c\u8bc1\uff0c\u4e00\u822c\u90fd\u5728\u5e94\u7528\u903b\u8f91\u5c42\u6765\u4fdd\u8bc1\u7528\u6237\u7684\u5408\u6cd5\u767b\u5165\u3002\u4f46\u5982\u679c\u662f\u4f01\u4e1a\u5e94\u7528\u5bf9\u63a5\uff0c\u60c5\u51b5\u5c31\u4e0d\u4e00\u6837\uff0c\u53ef\u80fd\u4f1a\u8981\u6c42\u5bf9\u5ba2\u6237\u7aef(\u76f8\u5bf9\u800c\u8a00)\u505a\u8eab\u4efd\u9a8c\u8bc1\u3002\u8fd9\u65f6\u5c31\u9700\u8981\u505aSSL\u53cc\u5411\u8ba4\u8bc1\u3002</p> <p>\u7531\u4e8e\u5355\u5411\u8ba4\u8bc1\u548c\u53cc\u5411\u8ba4\u8bc1\u7684\u533a\u522b\u4ec5\u5728\u4e8e\u521b\u5efa\u8fde\u63a5\u9636\u6bb5\uff0c\u6570\u636e\u7684\u4f20\u8f93\u5747\u4e3a\u52a0\u5bc6\u7684\uff0c\u56e0\u6b64\u5ba2\u6237\u7aef\u4e0ePG\u670d\u52a1\u7aef\u7684\u8fde\u63a5\u91c7\u53d6SSL\u5355\u5411\u8ba4\u8bc1\u5373\u53ef\uff0c\u5373\u4ec5\u5728PG Server\u7aef\u914d\u7f6eSSL\u8bc1\u4e66\u3002</p>"},{"location":"postgres/security/ssl/#_1","title":"\u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66","text":"<ul> <li>server.key \u2013 \u79c1\u94a5</li> <li>server.crt \u2013 \u670d\u52a1\u5668\u8bc1\u4e66</li> <li>root.crt \u2013 \u53d7\u4fe1\u4efb\u7684\u6839\u8bc1\u4e66</li> </ul> <pre><code>\u521b\u5efa\u79c1\u94a5 \uff0c \u9700\u8981\u5bc6\u7801\uff0c\u968f\u610f\u8f93\u5165\nopenssl genrsa -des3 -out server.key 1024\n\n\u5220\u9664\u5bc6\u7801\nopenssl rsa -in server.key -out server.key\n\n\u4fee\u6539\u6743\u9650\nchmod 400 server.key\n</code></pre> <pre><code>\u521b\u5efa\u57fa\u4e8eserver.key\u6587\u4ef6\u7684\u670d\u52a1\u5668\u8bc1\u4e66 \u6709\u6548\u671f\u5341\u5e74\nopenssl req -new -key server.key -days 3650 -out server.crt -x509\n\n</code></pre> <pre><code>\u67e5\u770b\u8bc1\u4e66\nopenssl x509 -in server.crt -text -noout\n</code></pre> <pre><code>\u4e3a\u4e86\u5f97\u5230\u81ea\u5df1\u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u628a\u751f\u6210\u7684\u670d\u52a1\u5668\u8bc1\u4e66\u4f5c\u4e3a\u53d7\u4fe1\u4efb\u7684\u6839\u8bc1\u4e66\uff0c\u53ea\u9700\u8981\u590d\u5236\u5e76\u53d6\u4e00\u4e2a\u5408\u9002\u7684\u540d\u5b57\n\ncp server.crt root.crt\n</code></pre>"},{"location":"postgres/security/ssl/#_2","title":"\u6570\u636e\u5e93\u914d\u7f6e","text":"<p>\u5c06\u4ee5\u4e0a\u751f\u6210\u7684\u8bc1\u4e66\u6587\u4ef6\u62f7\u8d1d\u5230\u6570\u636e\u5e93\u7684data\u76ee\u5f55\u4e0b</p> <p>\u4fee\u6539\u6240\u6709\u8005\u53ca\u8bbf\u95ee\u5c5e\u6027</p> <pre><code>chown postgres:postgres server.key\nchown postgres:postgres server.crt\nchown postgres:postgres root.crt\n\nchmod 400 server.key \nchmod 400 server.crt\nchmod 400 root.crt \n</code></pre> <p>\u4fee\u6539\u6570\u636e\u5e93\u914d\u7f6e postgresql.conf</p> <pre><code>ssl = on\nssl_ca_file = 'root.crt'\n</code></pre> <p>\u4fee\u6539 pg_hba.conf</p> <pre><code>host all all 0.0.0.0/0 md5\n\n# \"host\" is either a plain or SSL-encrypted TCP/IP socket,\n# \"hostssl\" is an SSL-encrypted TCP/IP socket, \n# and \"hostnossl\" is a plain TCP/IP socket.\n</code></pre> <p>\u53ef\u5bf9\u4e0d\u540c\u7684database \u5206\u522b\u8bbe\u7f6e</p> <p>\u91cd\u65b0\u52a0\u8f7d\u751f\u6548</p> <pre><code>systemctl reload postgresql-10\n</code></pre>"},{"location":"postgres/security/ssl/#pgbouncer","title":"pgbouncer \u914d\u7f6e","text":"<p>\u4fee\u6539\u8bbf\u95ee\u6743\u9650</p> <pre><code>chmod 644 server.key \nchmod 644 server.crt\nchmod 644 root.crt\n</code></pre> <p>\u4fee\u6539 pgbouncer </p> <pre><code>;;;\n;;; TLS settings for accepting clients\n;;;\n\n;; disable, allow, require, verify-ca, verify-full\nclient_tls_sslmode = require\n\n;; Path to file that contains trusted CA certs\nclient_tls_ca_file = /etc/pgbouncer/ssl/root.crt\n\n;; Private key and cert to present to clients.\n;; Required for accepting TLS connections from clients.\nclient_tls_key_file = /etc/pgbouncer/ssl/server.key\nclient_tls_cert_file = /etc/pgbouncer/ssl/server.crt\n</code></pre> <p>\u91cd\u65b0\u52a0\u8f7d\u751f\u6548</p> <pre><code>systemctl reload pgbouncer\n</code></pre>"},{"location":"postgres/security/ssl/#_3","title":"\u5ba2\u6237\u7aef\u8fde\u63a5","text":"<pre><code># psq -U postgres -p 5432 -h xxxx  \nSSL \u8fde\u63a5\uff08\u534f\u8bae\uff1aTLSv1.2\uff0c\u5bc6\u7801\uff1aECDHE-RSA-AES256-GCM-SHA384\uff0c\u5bc6\u94a5\u4f4d\uff1a256\uff0c\u538b\u7f29\uff1a\u5173\u95ed)\n\u8f93\u5165 \"help\" \u6765\u83b7\u53d6\u5e2e\u52a9\u4fe1\u606f.\n</code></pre>"},{"location":"postgres/tools/dba/","title":"DBA \u65e5\u5e38","text":""},{"location":"postgres/tools/dba/#_1","title":"\u5907\u4efd \u6062\u590d","text":"<p>\u65f6\u65f6\u70ed\u5907 \u5b9a\u671f\u51b7\u5907 </p>"},{"location":"postgres/tools/dba/#_2","title":"\u5347\u7ea7","text":"<p>\u6bcf\u5e74\u5927\u7248\u672c\u5c0f\u7248\u672c\u5347\u7ea7\uff0c\u65b0\u7279\u6027\u8c03\u7814\uff0c\u6027\u80fd\u6d4b\u8bd5\uff0c\u7a33\u5b9a\u6027\u3002 \u53ef\u7528\u5f53\u524d\u6700\u65b0\u7684\u4e0a\u4e00\u4e2a\u7248\u672c\u3002</p>"},{"location":"postgres/tools/dba/#ha","title":"HA","text":"<p>\u624b\u52a8 \u81ea\u52a8  </p> <p>\u8bfb\u5199\u5206\u79bb sharding \u591a\u526f\u672c</p>"},{"location":"postgres/tools/dba/#_3","title":"\u5b89\u5168","text":"<p>\u6743\u9650\u7ba1\u7406  \u8d44\u6e90\u9694\u79bb </p>"},{"location":"postgres/tools/dba/#_4","title":"\u5ba1\u8ba1","text":"<p>ddl \u6162sql \u9501\u957f\u65f6\u95f4\u5360\u7528     </p>"},{"location":"postgres/tools/dba/#_5","title":"\u5de1\u68c0","text":"<p>\u5b9a\u671f\u5de1\u68c0 awr \u62a5\u544a   </p>"},{"location":"postgres/tools/dba/#_6","title":"\u76d1\u63a7","text":"<p>\u7cfb\u7edf \u6570\u636e\u5e93  </p>"},{"location":"postgres/tools/dba/#_7","title":"\u8bca\u65ad \u4f18\u5316","text":""},{"location":"postgres/tools/dba/#_8","title":"\u80cc\u666f","text":"<p>\u5e94\u7528\u7a0b\u5e8f\u7684\u91ce\u86ee\u751f\u957f\uff0c\u7531\u4ea7\u54c1\u4e3a\u9a71\u52a8\u7684\u5f00\u53d1\uff0c\u4e00\u5207\u4ee5\u5feb\u901f\u4e0a\u7ebf\u4e3a\u76ee\u6807\uff0c\u5728\u5feb\u901f\u8fed\u4ee3\u7684\u8f93\u51fa\u4e2d\u5f88\u96be\u6709\u8d28\u91cf\u7684\u4fdd\u8bc1\u3002</p> <p>\u8fd0\u7ef4\u4eba\u5458\u548cdba\u5f80\u5f80\u4f1a\u5145\u5f53\u6551\u706b\u961f\u5458\uff0c\u8fdb\u5165\u6076\u6027\u5faa\u73af\u3002\u7a0b\u5e8f\u6216\u67b6\u6784\u8bbe\u8ba1\u4e0d\u5408\u7406\uff0c\u5bfc\u81f4\u6570\u636e\u5e93\u4f7f\u7528\u6027\u80fd\u4e0d\u4f73\uff0c\u7a0d\u5fae\u6765\u70b9\u4e1a\u52a1\u91cf\u5c31\u5bfc\u81f4\u6570\u636e\u5e93\u8d1f\u8f7d\u5347\u9ad8\u5f71\u54cd\u4e1a\u52a1\u3002</p>"},{"location":"postgres/tools/dba/#_9","title":"\u600e\u4e48\u529e","text":""},{"location":"postgres/tools/dba/#_10","title":"\u68b3\u7406\u8d23\u4efb\u5212\u5206","text":"<p>\u5fc5\u987b\u6709\u660e\u786e\u7684\u8d23\u4efb\u5212\u5206\uff0c\u5e76\u4e0d\u662f\u7a0b\u5e8f\u4e0a\u7ebf\u540e\u9664\u4e86\u95ee\u9898\u5168\u90e8\u90fd\u662f\u8fd0\u7ef4\u4eba\u5458\u7684\u8d23\u4efb\uff0c\u5982\u679c\u662f\u7a0b\u5e8f\u7684\u95ee\u9898\u5bfc\u81f4\u7684\u6545\u969c\uff0c\u5e94\u8be5\u5c06\u8d23\u4efb\u8ffd\u7a76\u5230\u7814\u53d1\u56e2\u961f\u3002</p> <p>\u8ffd\u8d23\u53ef\u4ee5\u4f5c\u4e3a\u7814\u53d1\u4e0e\u8fd0\u7ef4\u7684\u5171\u540cKPI\u8003\u6838\u6307\u6807\uff0c\u8fd9\u6837\u7814\u53d1\u624d\u6709\u52a8\u529b\u628a\u7a0b\u5e8f\u5f00\u53d1\u597d\uff0c\u800c\u4e0d\u662f\u91ce\u86ee\u778e\u641e\u3002</p>"},{"location":"postgres/tools/dba/#_11","title":"\u5efa\u7acb\u7a0b\u5e8f\u4ea4\u4ed8\u6807\u51c6","text":"<p>\u5fc5\u987b\u5efa\u7acb\u5e94\u7528\u4ea4\u4ed8\u7ed9\u8fd0\u7ef4\u7684\u4ea4\u4ed8\u6807\u51c6\uff0c\u7a0b\u5e8f\u4e0a\u7ebf\u524d\uff0c\u5fc5\u987b\u8981\u7b26\u5408\u8fd0\u884c\u4ea4\u4ed8\u6807\u51c6\u624d\u5141\u8bb8\u4e0a\u7ebf\u3002</p>"},{"location":"postgres/tools/dba/#_12","title":"\u5fc5\u987b\u5305\u62ec\u8bd5\u8fd0\u884c","text":"<p>\u5546\u7528\u524d\uff0c\u5fc5\u987b\u6709\u8bd5\u8fd0\u884c\u9636\u6bb5\u3002\u5efa\u7acb\u7ea6\u675f\u673a\u5236\uff0c\u4f8b\u5982\u8bd5\u8fd0\u884c\u9636\u6bb5\u5982\u679c\u6709N\u6b21\u5e94\u7528\u5f15\u8d77\u7684\u6545\u969c\u6216\u5df2\u53d1\u73b0\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u7684\u7a0b\u5e8fBUG\uff0c\u7814\u53d1\u5fc5\u987b\u5168\u90e8\u89e3\u51b3\u540e\uff0c\u624d\u5141\u8bb8\u5546\u7528\u3002</p>"},{"location":"postgres/tools/dba/#_13","title":"\u53d8\u66f4\u5236\u5ea6","text":"<p>\u5efa\u7acb\u53d8\u66f4\u5236\u5ea6\uff0c\u64cd\u4f5c\u89c4\u8303\uff0c\u5c3d\u91cf\u907f\u514d\u53d8\u66f4\u5e26\u6765\u7684\u95ee\u9898\u3002</p>"},{"location":"postgres/tools/dba/#_14","title":"\u5f00\u53d1\u89c4\u7ea6","text":"<p>\u4e8b\u524d\u9632\u8303\uff0c\u5efa\u7acb\u5f00\u53d1\u89c4\u7ea6\uff0c\u907f\u514d\u5f00\u53d1\u9636\u6bb5\u5f15\u5165\u7684\u95ee\u9898\u3002</p>"},{"location":"postgres/tools/dba/#_15","title":"\u57f9\u8bad","text":"<p>\u7ecf\u5e38\u7ed9\u5f00\u53d1\u57f9\u8bad\uff0c\u8ba9\u4ed6\u4eec\u719f\u6089\u6570\u636e\u5e93\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u907f\u514d\u8e29\u5751\u3002</p>"},{"location":"postgres/tools/dba/#sql","title":"SQL\u5ba1\u6838\u673a\u5236","text":"<p>\u5efa\u7acb\u81ea\u52a8\u5316\u6216\u4eba\u4e3a\u7684\u5ba1\u6838\u673a\u5236\uff0c\u6d89\u53ca\u6570\u636e\u5e93\u53d8\u66f4\uff0c\u65b0\u589eSQL\u90fd\u5fc5\u987b\u7ecf\u8fc7\u5ba1\u6838\u3002</p>"},{"location":"postgres/tools/dba/#_16","title":"\u6570\u636e\u5e93\u751f\u547d\u5468\u671f\u7ba1\u7406","text":"<p>\u5efa\u7acb\u5065\u5168\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u5236\u5ea6\u3002</p>"},{"location":"postgres/tools/lock_wait/","title":"\u9501\u7b49\u5f85","text":""},{"location":"postgres/tools/lock_wait/#_1","title":"\u9501\u7b49\u5f85\u573a\u666f","text":"<p>\u4e00\u4e2a\u4e8b\u52a1\u5c1a\u672a\u6267\u884c\u63d0\u4ea4\u65f6\u6301\u6709\u9501\uff0c\u5f53\u53e6\u4e00\u4e2a\u4e8b\u52a1\u9700\u8981\u6301\u6709\u6539\u884c\u7684\u9501\u65f6\u5219\u9700\u8981\u7b49\u5f85\u3002</p> <p>Session 1</p> <pre><code>postgres=# \\d+ wt\n                                     Table \"public.wt\"\n Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description \n--------+---------+-----------+----------+---------+----------+--------------+-------------\n id     | integer |           |          |         | plain    |              | \n t      | text    |           |          |         | extended |              | \n\npostgres=# begin;\nBEGIN\npostgres=# update wt set t = 'aaaa' where id = 1;\nUPDATE 1\npostgres=# select pg_backend_pid();\n pg_backend_pid \n----------------\n          20034\n(1 row)\n</code></pre> <p>Session 2 </p> <pre><code>postgres=# begin ;\nBEGIN\npostgres=# update wt set t = 'bbbb' where id = 1;\n</code></pre> <p>Session 3</p> <pre><code>select * from pg_stat_activity;\n\n-[ RECORD 3 ]----+----------------------------------------\ndatid            | 436980\ndatname          | postgres\npid              | 20476\nusesysid         | 10\nusename          | postgres\napplication_name | psql\nclient_addr      | \nclient_hostname  | \nclient_port      | -1\nbackend_start    | 2020-03-27 16:40:50.706409+08\nxact_start       | 2020-03-27 16:40:55.515366+08\nquery_start      | 2020-03-27 16:41:09.139546+08\nstate_change     | 2020-03-27 16:41:09.13955+08\nwait_event_type  | Lock\nwait_event       | transactionid\nstate            | active\nbackend_xid      | 22112130\nbackend_xmin     | 22112129\nquery            | update wt set t = 'bbbb' where id = 1;\nbackend_type     | client backend\n-[ RECORD 4 ]----+----------------------------------------\ndatid            | 436980\ndatname          | postgres\npid              | 20034\nusesysid         | 10\nusename          | postgres\napplication_name | psql\nclient_addr      | 192.168.6.78\nclient_hostname  | \nclient_port      | 56464\nbackend_start    | 2020-03-27 16:33:27.223241+08\nxact_start       | 2020-03-27 16:39:46.160577+08\nquery_start      | 2020-03-27 16:40:41.602471+08\nstate_change     | 2020-03-27 16:40:41.603281+08\nwait_event_type  | Client\nwait_event       | ClientRead\nstate            | idle in transaction\nbackend_xid      | 22112129\nbackend_xmin     | \nquery            | update wt set t = 'aaaa' where id = 1;\nbackend_type     | client backend\n\n</code></pre> <p>\u7b2c\u4e8c\u4e2aSession\u4e2d\u7684\u4e8b\u52a1\u5728\u7b49\u5f85\u7740\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u7684\u63d0\u4ea4\u3002</p> <p>\u672a\u63d0\u4ea4\u4e8b\u52a1\u7279\u70b9 wait_event = idle in transaction</p> <p>\u7b49\u5f85\u4e8b\u52a1\u7279\u70b9 wait_event_type = Lock ,wait_event = transactionid ,state=active</p>"},{"location":"postgres/tools/lock_wait/#_2","title":"\u67e5\u770b\u6570\u636e\u5e93\u4e2d\u7684\u9501\u7b49\u5f85","text":"<pre><code>with      \nt_wait as      \n(      \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and not a.granted     \n),     \nt_run as     \n(     \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and a.granted     \n),     \nt_overlap as     \n(     \n  select r.* from t_wait w join t_run r on     \n  (     \n    r.locktype is not distinct from w.locktype and     \n    r.database is not distinct from w.database and     \n    r.relation is not distinct from w.relation and     \n    r.page is not distinct from w.page and     \n    r.tuple is not distinct from w.tuple and     \n    r.virtualxid is not distinct from w.virtualxid and     \n    r.transactionid is not distinct from w.transactionid and     \n    r.classid is not distinct from w.classid and     \n    r.objid is not distinct from w.objid and     \n    r.objsubid is not distinct from w.objsubid and     \n    r.pid &lt;&gt; w.pid     \n  )      \n),      \nt_unionall as      \n(      \n  select r.* from t_overlap r      \n  union all      \n  select w.* from t_wait w      \n)      \nselect locktype,datname,relation::regclass,page,tuple,virtualxid,transactionid::text,classid::regclass,objid,objsubid,     \nstring_agg(     \n'Pid: '||case when pid is null then 'NULL' else pid::text end||chr(10)||     \n'Lock_Granted: '||case when granted is null then 'NULL' else granted::text end||' , Mode: '||case when mode is null then 'NULL' else mode::text end||' , FastPath: '||case when fastpath is null then 'NULL' else fastpath::text end||' , VirtualTransaction: '||case when virtualtransaction is null then 'NULL' else virtualtransaction::text end||' , Session_State: '||case when state is null then 'NULL' else state::text end||chr(10)||     \n'Username: '||case when usename is null then 'NULL' else usename::text end||' , Database: '||case when datname is null then 'NULL' else datname::text end||' , Client_Addr: '||case when client_addr is null then 'NULL' else client_addr::text end||' , Client_Port: '||case when client_port is null then 'NULL' else client_port::text end||' , Application_Name: '||case when application_name is null then 'NULL' else application_name::text end||chr(10)||      \n'Xact_Start: '||case when xact_start is null then 'NULL' else xact_start::text end||' , Query_Start: '||case when query_start is null then 'NULL' else query_start::text end||' , Xact_Elapse: '||case when (now()-xact_start) is null then 'NULL' else (now()-xact_start)::text end||' , Query_Elapse: '||case when (now()-query_start) is null then 'NULL' else (now()-query_start)::text end||chr(10)||      \n'SQL (Current SQL in Transaction): '||chr(10)||    \ncase when query is null then 'NULL' else query::text end,      \nchr(10)||'--------'||chr(10)      \norder by      \n  (  case mode      \n    when 'INVALID' then 0     \n    when 'AccessShareLock' then 1     \n    when 'RowShareLock' then 2     \n    when 'RowExclusiveLock' then 3     \n    when 'ShareUpdateExclusiveLock' then 4     \n    when 'ShareLock' then 5     \n    when 'ShareRowExclusiveLock' then 6     \n    when 'ExclusiveLock' then 7     \n    when 'AccessExclusiveLock' then 8     \n    else 0     \n  end  ) desc,     \n  (case when granted then 0 else 1 end)    \n) as lock_conflict    \nfrom t_unionall     \ngroup by     \nlocktype,datname,relation,page,tuple,virtualxid,transactionid::text,classid,objid,objsubid ;\n</code></pre> <pre><code>-- \u67e5\u770b\u963b\u585e\u5173\u7cfb\u6811\uff08PG 10+\uff09\nSELECT pid, \n       pg_blocking_pids(pid) AS blocked_by,\n       query AS blocked_query\nFROM pg_stat_activity\nWHERE cardinality(pg_blocking_pids(pid)) &gt; 0;\n</code></pre>"},{"location":"postgres/tools/lock_wait/#_3","title":"\u6d88\u9664\u9501\u7b49\u5f85","text":"<pre><code>select pg_cancel_backend(pid);\n\n\nselect pg_terminate_backend(pid);\n</code></pre>"},{"location":"postgres/tools/lock_wait/#_4","title":"\u76d1\u63a7\u65b9\u6848","text":"<p>\u957f\u4e8b\u52a1\u76d1\u63a7</p> <pre><code>select extract(epoch from max(age(now(), query_start))) from pg_stat_activity where state &lt;&gt; 'idle' and (backend_xid is not null or backend_xmin is not null);\n</code></pre> <p>\u957f\u4e8b\u52a1\u67e5\u770b</p> <pre><code>select * from pg_stat_activity  pg_stat_activity where state &lt;&gt; 'idle' and (backend_xid is not null or backend_xmin is not null) order by query_start asc limit 1;\n\nselect * from pg_stat_activity  pg_stat_activity where state &lt;&gt; 'idle' and (backend_xid is not null or backend_xmin is not null) and backend_type = 'client backend' order by query_start asc limit 1;\n</code></pre> <p>2pc</p> <pre><code>select * from pg_prepared_statements;\n</code></pre>"},{"location":"postgres/tools/lock_wait/#_5","title":"\u65e5\u5fd7\u8bb0\u5f55","text":"<p>\u5f53\u5835\u585e\u65f6\u95f4\u5927\u4e8edeadlock (1s) \u65f6</p> <p>\u5168\u5c40</p> <pre><code> set log_lock_waits TO ON;\n</code></pre> <p>\u6307\u5b9a\u6570\u636e\u5e93</p> <pre><code> alter database dbname set log_lock_waits TO ON;\n</code></pre> <p>\u65e5\u5fd7\u5185\u5bb9\u5982\u4e0b</p> <pre><code>2020-03-31 09:16:32.704 CST,\"postgres\",\"postgres\",25436,\"[local]\",5e8299b7.635c,5,\"UPDATE waiting\",2020-03-31 09:15:35 CST,4/52140,22112144,LOG,00000,\"process 25436 still waiting for ShareLock on transaction 22112143 after 1000.162 ms\",\"Process holding the lock: 24758. Wait queue: 25436.\",,,,\"while updating tuple (0,39) in relation \"\"wt\"\"\",\"update wt set t = 'bbbb' where id = 1;\",,,\"psql\"\n2020-03-31 09:18:25.946 CST,\"postgres\",\"postgres\",25436,\"[local]\",5e8299b7.635c,6,\"UPDATE waiting\",2020-03-31 09:15:35 CST,4/52140,22112144,LOG,00000,\"process 25436 acquired ShareLock on transaction 22112143 after 114242.016 ms\",,,,,\"while updating tuple (0,39) in relation \"\"wt\"\"\",\"update wt set t = 'bbbb' where id = 1;\",,,\"psql\"\n2020-03-31 09:18:25.946 CST,\"postgres\",\"postgres\",25436,\"[local]\",5e8299b7.635c,7,\"UPDATE\",2020-03-31 09:15:35 CST,4/52140,22112144,LOG,00000,\"duration: 114244.352 ms\",,,,,,,,,\"psql\"\nplate_number\n</code></pre> <p>25436 \u88ab 24758 \u5835\u585e</p>"},{"location":"postgres/tools/lock_wait/#_6","title":"\u67e5\u770b\u8c01\u5835\u585e\u4e86\u8c01","text":"<pre><code>pg_blocking_pids(pid)\n</code></pre>"},{"location":"postgres/tools/monitor-sql/","title":"\u67e5\u770b\u6570\u636e\u4fe1\u606f\u5e38\u7528sql\u6574\u7406","text":"","tags":[]},{"location":"postgres/tools/monitor-sql/#_1","title":"\u5e93\u5185\u5b58\u547d\u4e2d\u7387","text":"<pre><code>SELECT  \n'index hit rate' AS name,\n(sum(idx_blks_hit)) / nullif(sum(idx_blks_hit + idx_blks_read),0) AS ratio\nFROM pg_statio_user_indexes\nUNION ALL\nSELECT\n'table hit rate' AS name,\nsum(heap_blks_hit) / nullif(sum(heap_blks_hit) + sum(heap_blks_read),0) AS ratio\nFROM pg_statio_user_tables;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_2","title":"\u8868\u5185\u5b58\u547d\u4e2d\u7387","text":"<pre><code>SELECT relname AS relation, heap_blks_read AS heap_read, heap_blks_hit AS heap_hit,\n((heap_blks_hit*100) / NULLIF((heap_blks_hit + heap_blks_read), 0)) AS ratio \nFROM pg_statio_user_tables order by ratio;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#io","title":"\u8bfbIO\u5185\u5b58\u5360\u6bd4","text":"<p>\u78c1\u76d8\u4e2d\u8bfb\u53d6\u548c\u5728\u5185\u5b58\u4e2d\u76f4\u63a5\u8bfb\u53d6\u4e4b\u95f4\u7684\u6570\u5b57\u548c\u6bd4</p> <pre><code>SELECT relname AS \"relation\", heap_blks_read AS heap_read, heap_blks_hit AS heap_hit, \n( (heap_blks_hit*100) / NULLIF((heap_blks_hit + heap_blks_read), 0)) AS ratioFROM pg_statio_user_tables;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_3","title":"\u8868\u4e2d\u7d22\u5f15\u547d\u4e2d\u7387","text":"<pre><code>SELECT relname, \nCASE idx_scan\nWHEN 0 THEN NULL\nELSE round(100.0 * idx_scan / (seq_scan + idx_scan), 5)\nEND percent_of_times_index_used,\nn_live_tup rows_in_table\nFROM\npg_stat_user_tables\nORDER BY\nn_live_tup DESC;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_4","title":"\u7d22\u5f15\u5229\u7528\u7387","text":"<pre><code>SELECT  \nschemaname || '.' || relname AS table,\nindexrelname AS index,\npg_size_pretty(pg_relation_size(i.indexrelid)) AS index_size,\nidx_scan as index_scans\nFROM pg_stat_user_indexes ui\nJOIN pg_index i ON ui.indexrelid = i.indexrelid\nWHERE NOT indisunique\nAND idx_scan &lt; 50\nAND pg_relation_size(relid) &gt; 5 * 8192\nORDER BY pg_relation_size(i.indexrelid) / nullif(idx_scan, 0) DESC NULLS FIRST,\npg_relation_size(i.indexrelid) DESC;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_5","title":"\u8868\u7a7a\u95f4\u5927\u5c0f","text":"<pre><code>SELECT\ntable_name,\npg_size_pretty(table_size) AS table_size,\npg_size_pretty(indexes_size) AS indexes_size,\npg_size_pretty(total_size) AS total_size\nFROM (\nSELECT\ntable_name,\npg_table_size(table_name) AS table_size,\npg_indexes_size(table_name) AS indexes_size,\npg_total_relation_size(table_name) AS total_size\nFROM (\nSELECT ('\"' || table_schema || '\".\"' || table_name || '\"') AS table_name\nFROM information_schema.tables\n) AS all_tables\nORDER BY total_size DESC\n) AS pretty_sizes;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_6","title":"\u8868\u81a8\u80c0\u7387","text":"<pre><code>-- Table bloat estimate\nCREATE OR REPLACE VIEW monitor.pg_table_bloat AS\n    SELECT CURRENT_CATALOG AS datname, nspname, relname , bs * tblpages AS size,\n           CASE WHEN tblpages - est_tblpages_ff &gt; 0 THEN (tblpages - est_tblpages_ff)/tblpages::FLOAT ELSE 0 END AS ratio\n    FROM (\n             SELECT ceil( reltuples / ( (bs-page_hdr)*fillfactor/(tpl_size*100) ) ) + ceil( toasttuples / 4 ) AS est_tblpages_ff,\n                    tblpages, fillfactor, bs, tblid, nspname, relname, is_na\n             FROM (\n                      SELECT\n                          ( 4 + tpl_hdr_size + tpl_data_size + (2 * ma)\n                              - CASE WHEN tpl_hdr_size % ma = 0 THEN ma ELSE tpl_hdr_size % ma END\n                              - CASE WHEN ceil(tpl_data_size)::INT % ma = 0 THEN ma ELSE ceil(tpl_data_size)::INT % ma END\n                              ) AS tpl_size, (heappages + toastpages) AS tblpages, heappages,\n                          toastpages, reltuples, toasttuples, bs, page_hdr, tblid, nspname, relname, fillfactor, is_na\n                      FROM (\n                               SELECT\n                                   tbl.oid AS tblid, ns.nspname , tbl.relname, tbl.reltuples,\n                                   tbl.relpages AS heappages, coalesce(toast.relpages, 0) AS toastpages,\n                                   coalesce(toast.reltuples, 0) AS toasttuples,\n                                   coalesce(substring(array_to_string(tbl.reloptions, ' ') FROM 'fillfactor=([0-9]+)')::smallint, 100) AS fillfactor,\n                                   current_setting('block_size')::numeric AS bs,\n                                   CASE WHEN version()~'mingw32' OR version()~'64-bit|x86_64|ppc64|ia64|amd64' THEN 8 ELSE 4 END AS ma,\n                                   24 AS page_hdr,\n                                   23 + CASE WHEN MAX(coalesce(s.null_frac,0)) &gt; 0 THEN ( 7 + count(s.attname) ) / 8 ELSE 0::int END\n                                       + CASE WHEN bool_or(att.attname = 'oid' and att.attnum &lt; 0) THEN 4 ELSE 0 END AS tpl_hdr_size,\n                                   sum( (1-coalesce(s.null_frac, 0)) * coalesce(s.avg_width, 0) ) AS tpl_data_size,\n                                   bool_or(att.atttypid = 'pg_catalog.name'::regtype)\n                                       OR sum(CASE WHEN att.attnum &gt; 0 THEN 1 ELSE 0 END) &lt;&gt; count(s.attname) AS is_na\n                               FROM pg_attribute AS att\n                                        JOIN pg_class AS tbl ON att.attrelid = tbl.oid\n                                        JOIN pg_namespace AS ns ON ns.oid = tbl.relnamespace\n                                        LEFT JOIN pg_stats AS s ON s.schemaname=ns.nspname AND s.tablename = tbl.relname AND s.inherited=false AND s.attname=att.attname\n                                        LEFT JOIN pg_class AS toast ON tbl.reltoastrelid = toast.oid\n                               WHERE NOT att.attisdropped AND tbl.relkind = 'r' AND nspname NOT IN ('pg_catalog','information_schema')\n                               GROUP BY 1,2,3,4,5,6,7,8,9,10\n                           ) AS s\n                  ) AS s2\n         ) AS s3\n    WHERE NOT is_na;\n\nCREATE OR REPLACE VIEW monitor.pg_table_bloat_human AS\n    SELECT nspname || '.' || relname AS name,\n           pg_size_pretty(size)      AS size,\n           pg_size_pretty((size * ratio)::BIGINT) AS wasted,\n           round(100 * ratio::NUMERIC, 2)  as ratio\n    FROM monitor.pg_table_bloat ORDER BY wasted DESC NULLS LAST;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_7","title":"\u7d22\u5f15\u81a8\u80c0\u7387","text":"<pre><code>CREATE OR REPLACE VIEW monitor.pg_index_bloat AS\n    SELECT CURRENT_CATALOG AS datname, nspname, idxname AS relname, relpages::BIGINT * bs AS size,\n           COALESCE((relpages - ( reltuples * (6 + ma - (CASE WHEN index_tuple_hdr % ma = 0 THEN ma ELSE index_tuple_hdr % ma END)\n                                                   + nulldatawidth + ma - (CASE WHEN nulldatawidth % ma = 0 THEN ma ELSE nulldatawidth % ma END))\n                                      / (bs - pagehdr)::FLOAT  + 1 )), 0) / relpages::FLOAT AS ratio\n    FROM (\n             SELECT nspname,\n                    idxname,\n                    reltuples,\n                    relpages,\n                    current_setting('block_size')::INTEGER                                                               AS bs,\n                    (CASE WHEN version() ~ 'mingw32' OR version() ~ '64-bit|x86_64|ppc64|ia64|amd64' THEN 8 ELSE 4 END)  AS ma,\n                    24                                                                                                   AS pagehdr,\n                    (CASE WHEN max(COALESCE(pg_stats.null_frac, 0)) = 0 THEN 2 ELSE 6 END)                               AS index_tuple_hdr,\n                    sum((1.0 - COALESCE(pg_stats.null_frac, 0.0)) *\n                        COALESCE(pg_stats.avg_width, 1024))::INTEGER                                                     AS nulldatawidth\n             FROM pg_attribute\n                      JOIN (\n                 SELECT pg_namespace.nspname,\n                        ic.relname                                                   AS idxname,\n                        ic.reltuples,\n                        ic.relpages,\n                        pg_index.indrelid,\n                        pg_index.indexrelid,\n                        tc.relname                                                   AS tablename,\n                        regexp_split_to_table(pg_index.indkey::TEXT, ' ') :: INTEGER AS attnum,\n                        pg_index.indexrelid                                          AS index_oid\n                 FROM pg_index\n                          JOIN pg_class ic ON pg_index.indexrelid = ic.oid\n                          JOIN pg_class tc ON pg_index.indrelid = tc.oid\n                          JOIN pg_namespace ON pg_namespace.oid = ic.relnamespace\n                          JOIN pg_am ON ic.relam = pg_am.oid\n                 WHERE pg_am.amname = 'btree' AND ic.relpages &gt; 0 AND nspname NOT IN ('pg_catalog', 'information_schema')\n             ) ind_atts ON pg_attribute.attrelid = ind_atts.indexrelid AND pg_attribute.attnum = ind_atts.attnum\n                      JOIN pg_stats ON pg_stats.schemaname = ind_atts.nspname\n                 AND ((pg_stats.tablename = ind_atts.tablename AND pg_stats.attname = pg_get_indexdef(pg_attribute.attrelid, pg_attribute.attnum, TRUE))\n                     OR (pg_stats.tablename = ind_atts.idxname AND pg_stats.attname = pg_attribute.attname))\n             WHERE pg_attribute.attnum &gt; 0\n             GROUP BY 1, 2, 3, 4, 5, 6\n         ) est\n    LIMIT 512;\n\nCREATE OR REPLACE VIEW monitor.pg_index_bloat_human AS\n    SELECT nspname || '.' || relname              AS name,\n           pg_size_pretty(size)                   AS size,\n           pg_size_pretty((size * ratio)::BIGINT) AS wasted,\n           round(100 * ratio::NUMERIC, 2)         as ratio\n    FROM monitor.pg_index_bloat;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_8","title":"\u8868\u4e2d\u9501\u72b6\u6001","text":"<pre><code>SELECT count(pg_stat_activity.pid) AS number_of_queries, \n  substring(trim(LEADING FROM regexp_replace(pg_stat_activity.query, '[\\n\\r]+'::text,' '::text, 'g'::text))\n                FROM 0 FOR 200) AS query_name,  max(age(CURRENT_TIMESTAMP, query_start))\n       AS max_wait_time, wait_event, usename, locktype, mode, granted \n                FROM pg_stat_activity LEFT JOIN pg_locks ON pg_stat_activity.pid = pg_locks.pid \n                   WHERE query != '&lt;IDLE&gt;' AND query NOT ILIKE '%pg_%' AND query NOT ILIKE '%application_name%'\n                      AND query NOT ILIKE '%inet%' AND age(CURRENT_TIMESTAMP, query_start) &gt; '5 milliseconds'::interval\n  GROUP BY query_name,wait_event, usename, locktype, mode, granted  ORDER BY max_wait_time DESC;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_9","title":"\u88ab\u9501\u5835\u585e\u7684\u8bed\u53e5","text":"<pre><code>SELECT                                      \n    blocked_locks.pid AS blocked_pid,\n    blocked_activity.usename AS blocked_user,\n    now() - blocked_activity.query_start AS blocked_duration,\n    blocking_locks.pid AS blocking_pid,\n    blocking_activity.usename AS blocking_user,\n    now() - blocking_activity.query_start AS blocking_duration,\n    blocked_activity.query AS blocked_statement,\n    blocking_activity.query AS blocking_statement\nFROM                                                       \n    pg_catalog.pg_locks AS blocked_locks\n    JOIN pg_catalog.pg_stat_activity AS blocked_activity ON blocked_activity.pid = blocked_locks.pid\n    JOIN pg_catalog.pg_locks AS blocking_locks ON blocking_locks.locktype = blocked_locks.locktype\n        AND blocking_locks.DATABASE IS NOT DISTINCT FROM blocked_locks.DATABASE\n        AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation\n        AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page\n        AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple\n        AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid\n        AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid\n        AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid\n        AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid\n        AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid\n        AND blocking_locks.pid != blocked_locks.pid\n    JOIN pg_catalog.pg_stat_activity AS blocking_activity ON blocking_activity.pid = blocking_locks.pid\nWHERE\n    NOT blocked_locks.granted;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#_10","title":"\u8868\u4e2d\u9501\u7b49\u5f85","text":"<pre><code>with      \nt_wait as      \n(      \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and not a.granted     \n),     \nt_run as     \n(     \n  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     \n  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     \n  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     \n    from pg_locks a,pg_stat_activity b where a.pid=b.pid and a.granted     \n),     \nt_overlap as     \n(     \n  select r.* from t_wait w join t_run r on     \n  (     \n    r.locktype is not distinct from w.locktype and     \n    r.database is not distinct from w.database and     \n    r.relation is not distinct from w.relation and     \n    r.page is not distinct from w.page and     \n    r.tuple is not distinct from w.tuple and     \n    r.virtualxid is not distinct from w.virtualxid and     \n    r.transactionid is not distinct from w.transactionid and     \n    r.classid is not distinct from w.classid and     \n    r.objid is not distinct from w.objid and     \n    r.objsubid is not distinct from w.objsubid and     \n    r.pid &lt;&gt; w.pid     \n  )      \n),      \nt_unionall as      \n(      \n  select r.* from t_overlap r      \n  union all      \n  select w.* from t_wait w      \n)      \nselect locktype,datname,relation::regclass,page,tuple,virtualxid,transactionid::text,classid::regclass,objid,objsubid,     \nstring_agg(     \n'Pid: '||case when pid is null then 'NULL' else pid::text end||chr(10)||     \n'Lock_Granted: '||case when granted is null then 'NULL' else granted::text end||' , Mode: '||case when mode is null then 'NULL' else mode::text end||' , FastPath: '||case when fastpath is null then 'NULL' else fastpath::text end||' , VirtualTransaction: '||case when virtualtransaction is null then 'NULL' else virtualtransaction::text end||' , Session_State: '||case when state is null then 'NULL' else state::text end||chr(10)||     \n'Username: '||case when usename is null then 'NULL' else usename::text end||' , Database: '||case when datname is null then 'NULL' else datname::text end||' , Client_Addr: '||case when client_addr is null then 'NULL' else client_addr::text end||' , Client_Port: '||case when client_port is null then 'NULL' else client_port::text end||' , Application_Name: '||case when application_name is null then 'NULL' else application_name::text end||chr(10)||      \n'Xact_Start: '||case when xact_start is null then 'NULL' else xact_start::text end||' , Query_Start: '||case when query_start is null then 'NULL' else query_start::text end||' , Xact_Elapse: '||case when (now()-xact_start) is null then 'NULL' else (now()-xact_start)::text end||' , Query_Elapse: '||case when (now()-query_start) is null then 'NULL' else (now()-query_start)::text end||chr(10)||      \n'SQL (Current SQL in Transaction): '||chr(10)||    \ncase when query is null then 'NULL' else query::text end,      \nchr(10)||'--------'||chr(10)      \norder by      \n  (  case mode      \n    when 'INVALID' then 0     \n    when 'AccessShareLock' then 1     \n    when 'RowShareLock' then 2     \n    when 'RowExclusiveLock' then 3     \n    when 'ShareUpdateExclusiveLock' then 4     \n    when 'ShareLock' then 5     \n    when 'ShareRowExclusiveLock' then 6     \n    when 'ExclusiveLock' then 7     \n    when 'AccessExclusiveLock' then 8     \n    else 0     \n  end  ) desc,     \n  (case when granted then 0 else 1 end)    \n) as lock_conflict    \nfrom t_unionall     \ngroup by     \nlocktype,datname,relation,page,tuple,virtualxid,transactionid::text,classid,objid,objsubid ;\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor-sql/#auto-vacuum","title":"auto vacuum \u9884\u6d4b","text":"<pre><code>WITH table_opts AS (    \nSELECT\npg_class.oid, relname, nspname, array_to_string(reloptions, '') AS relopts\nFROM\npg_class INNER JOIN pg_namespace ns ON relnamespace = ns.oid\n), vacuum_settings AS (\nSELECT\noid, relname, nspname,\nCASE\nWHEN relopts LIKE '%autovacuum_vacuum_threshold%'\nTHEN substring(relopts, '.*autovacuum_vacuum_threshold=([0-9.]+).*')::integer\nELSE current_setting('autovacuum_vacuum_threshold')::integer\nEND AS autovacuum_vacuum_threshold,\nCASE\nWHEN relopts LIKE '%autovacuum_vacuum_scale_factor%'\nTHEN substring(relopts, '.*autovacuum_vacuum_scale_factor=([0-9.]+).*')::real\nELSE current_setting('autovacuum_vacuum_scale_factor')::real\nEND AS autovacuum_vacuum_scale_factor\nFROM\ntable_opts\n)\nSELECT\nvacuum_settings.relname AS table_name,\npg_size_pretty(pg_total_relation_size(pg_class.oid::regclass)) AS table_size,\nto_char(psut.last_vacuum, 'YYYY-MM-DD HH24:MI') AS last_vacuum,\nto_char(psut.last_autovacuum, 'YYYY-MM-DD HH24:MI') AS last_autovacuum,\nto_char(pg_class.reltuples, '9G999G999G999') AS rowcount,\nto_char(pg_class.reltuples / NULLIF(pg_class.relpages, 0), '999G999.99') AS rows_per_page,\nto_char(autovacuum_vacuum_threshold\n+ (autovacuum_vacuum_scale_factor::numeric * pg_class.reltuples), '9G999G999G999') AS autovacuum_vacuum_threshold,\npsut.n_dead_tup AS dead_rows,\nCASE\nWHEN autovacuum_vacuum_threshold + (autovacuum_vacuum_scale_factor::numeric * pg_class.reltuples) &lt; psut.n_dead_tup\nTHEN 'yes'\nELSE (autovacuum_vacuum_threshold + (autovacuum_vacuum_scale_factor::numeric * pg_class.reltuples) - psut.n_dead_tup)::varchar\nEND AS will_vacuum\nFROM\npg_stat_user_tables psut INNER JOIN pg_class ON psut.relid = pg_class.oid\nINNER JOIN vacuum_settings ON pg_class.oid = vacuum_settings.oid\nORDER BY 1\n</code></pre>","tags":[]},{"location":"postgres/tools/monitor/","title":"Postgres \u76d1\u63a7\u5e38\u7528\u5de5\u5177","text":""},{"location":"postgres/tools/monitor/#_1","title":"\u5404\u79cd\u76d1\u63a7\u65b9\u5f0f","text":"<ul> <li> <p>zabbix  Monitor PostgreSQL with Zabbix</p> </li> <li> <p>postgres_exporter  A PostgresSQL metric exporter for Prometheus</p> </li> <li> <p>pgwatch2 PostgreSQL metrics monitor/dashboard</p> </li> <li> <p>pgmetrics Collect and display information and stats from a running PostgreSQL server </p> </li> <li> <p>pgdash  (\u6536\u8d39)</p> </li> <li> <p>pganalyze PostgreSQL Performance Monitoring</p> </li> <li> <p>\u53c2\u8003\u81ea\u5df1\u5b9e\u73b0 </p> </li> </ul>"},{"location":"postgres/tools/monitor/#_2","title":"\u72b6\u6001\u67e5\u770b","text":"<p>pgcenter</p> <pre><code>pgcenter top\npgcenter: 2018-12-20 11:10:25, load average: 0.94, 0.84, 0.86                                                                         state [ok]: ::1:5432 postgres@postgres (ver: 10.6, up 8 days 19:57:54, recovery: f)\n    %cpu: 15.0 us,  3.7 sy,  0.0 ni, 75.3 id,  5.7 wa,  0.0 hi,  0.2 si,  0.0 st                                                        activity:  5/1000 conns,  0/0 prepared,  2 idle,  0 idle_xact,  3 active,  0 waiting,  0 others\n MiB mem:   7821 total,    162 free,    424 used,     7235 buff/cached                                                                autovacuum:  0/3 workers/max,  0 manual,  0 wraparound, 00:00:00 vac_maxtime\nMiB swap:   1023 total,    903 free,    120 used,      0/0 dirty/writeback                                                            statements: 1888 stmt/s, 2.330 stmt_avgtime, 00:00:00 xact_maxtime, 00:00:00 prep_maxtime      \n\npid     cl_addr      cl_port   datname       usename    appname    backend_type        wait_etype   wait_event     state    xact_age   query_age         change_age        query           \n27908   ::1          40204     postgres      postgres   pgcenter   client backend                                  active   00:00:00   00:00:00          00:00:00          SELECT pid, client_addr AS cl_addr, client_port AS cl_port, datname, usename, left(application\n27660   10.1.88.22   34224     timescaledb   postgres              client backend      LWLock       WALWriteLock   active   00:00:00   00:00:00          00:00:00          COMMIT                                                                                        \n27410   10.1.88.22   34058     timescaledb   postgres              client backend                                  active   00:00:00   00:00:00          00:00:00          COMMIT                 \n</code></pre> <p>pg_activity</p> <pre><code>pg_activity\n- postgres@localhost:5432/postgres - Ref.: 2s\n  Size:   60.54G -     0.00B/s        | TPS:        1243        | Active Connections:           2        | Duration mode:       query\n  Mem.:   24.40% -     4.51G/62.66G   | IO Max:      342/s\n  Swap:    2.10% -   515.50M/23.85G   | Read :      0.00B/s -      0/s\n  Load:    0.93 1.38 1.49             | Write:      0.00B/s -      0/s\n                                                                               RUNNING QUERIES\nPID    DATABASE                      APP             USER           CLIENT   CPU% MEM%   READ/s  WRITE/s     TIME+  W  IOW              state   Query\n33430  None                  walreceiver         postgres     10.1.80.6/32    1.0  0.0    0.00B    0.00B  0.000000  N    N             active\n</code></pre> <p>[pg_top]</p> <pre><code>pg_top\nlast pid: 15974;  load avg:  1.50,  1.79,  1.42;       up 508+22:42:20                                                                                                              10:03:51\n134 processes: 134 sleeping\nCPU states:  2.9% user,  0.0% nice,  0.7% system, 96.4% idle,  0.1% iowait\nMemory: 60G used, 2497M free, 4K buffers, 54G cached\nDB activity: 1272 tps,  0 rollbs/s,   0 buffer r/s, 100 hit%, 146256 row r/s, 2028 row w/s\nDB I/O:     0 reads/s,     1 KB/s,   238 writes/s,  4812 KB/s\nDB disk: 953.2 GB total, 694.9 GB free (27% used)\nSwap: 1853M used, 22G free, 363M cached\n\n  PID USERNAME PRI NICE  SIZE   RES STATE   TIME   WCPU    CPU COMMAND\n15790 postgres  20    0   11G   81M sleep   0:00  0.78%  4.56% postgres: k3s_cg k3s_cg 10.1.40.92(37422) idle\n29050 postgres  20    0   11G  122M sleep  41.6H  0.60%  3.18% postgres: zabbix zabbix ::1(55888) idle\n29020 postgres  20    0   11G  120M sleep  41.7H  0.50%  2.98% postgres: zabbix zabbix ::1(55860) idle\n29061 postgres  20    0   11G  120M sleep  41.7H  0.56%  2.98% postgres: zabbix zabbix ::1(55898) idle\n29059 postgres  20    0   11G  122M sleep  41.6H  0.48%  2.98% postgres: zabbix zabbix ::1(55896) idle\n29069 postgres  20    0   11G  120M sleep  41.6H  0.56%  2.98% postgres: zabbix zabbix ::1(55906) idle\n</code></pre> <p>monitoring-stats</p> <p>zabbix /var/lib/zabbix/postgresql/</p> <pre><code>wget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.bgwriter.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.bgwriter.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.cache.hit.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.config.hash.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.connections.prepared.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.connections.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.connections.sum.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.dbstat.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.dbstat.sum.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.discovery.db.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.frozenxid.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.locks.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.ping.time.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.query.time.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.replication.lag.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.replication.recovery_role.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.replication.status.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.scans.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.transactions.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.uptime.sql\nwget https://git.zabbix.com/projects/ZBX/repos/zabbix/raw/templates/db/postgresql/postgresql/pgsql.wal.stat.sql\n</code></pre> <p>https://git.zabbix.com/projects/ZBX/repos/zabbix/browse</p>"},{"location":"postgres/tools/monitor_explain/","title":"\u6570\u636e\u5e93\u76d1\u63a7\u6307\u6807","text":""},{"location":"postgres/tools/monitor_explain/#_1","title":"\u5b9e\u4f53\u673a","text":"<ul> <li>\u786c\u76d8\u7a7a\u95f4</li> <li>cup\u5229\u7528\u7387</li> <li>\u5185\u5b58\u5229\u7528\u7387</li> <li>IO</li> <li>\u7f51\u7edc\u5e26\u5bbd</li> <li>tcp\u8fde\u63a5\u60c5\u51b5</li> <li>\u6e29\u5ea6</li> </ul>"},{"location":"postgres/tools/monitor_explain/#_2","title":"\u6570\u636e\u5e93\u5e74\u9f84","text":"<pre><code> -- \u6570\u636e\u5e93database \u5e74\u9f84\n select datname,age(datfrozenxid),pg_size_pretty(pg_database_size(oid)) from pg_database order by age(datfrozenxid) desc limit 10 ;\n\n -- \u8868\u5e74\u9f84\n select relname,age(relfrozenxid), pg_size_pretty(pg_table_size(oid)) from pg_class where relkind in ('t','r') order by age(relfrozenxid) desc limit 10;\n\n\u8bf4\u660e\uff1a \u5f53age\u5230\u8fbe2\u4ebf\uff08\u9ed8\u8ba4\uff09\u65f6\u89e6\u53d1\u81ea\u52a8\u56de\u5377\uff0c\u671f\u95f4\u4f1a\u5927\u91cf\u5360\u7528\u7cfb\u7edf\u8d44\u6e90\u3002\u63d0\u524d\u505a\u597d\u76d1\u63a7\u907f\u514d\u5728\u4e1a\u52a1\u9ad8\u5cf0\u65f6\u53d1\u751f\u3002\u53ef\u5728\u5e93\u7ea7\u522b\u64cd\u4f5c\uff0c\u4e5f\u53ef\u5728\u8868\u57fa\u672c\u64cd\u4f5c\u3002\n\nVACUUM ANALYZE VERBOSE ;\n</code></pre>"},{"location":"postgres/tools/monitor_explain/#_3","title":"\u5783\u573e\u56de\u6536","text":"<pre><code>-- \u8868\u7a7a\u95f4\u81a8\u80c0\u7387, \u6b7b\u5143\u7ec4\nselect relname,size,ratio from monitor.pg_table_bloat;\n</code></pre> <p>\u89c6\u56fe\u5b9a\u4e49 -\u89c1</p> <pre><code>-- \u5783\u573e\u56de\u6536\u5f00\u59cb\u65f6\u95f4\u7ed3\u675f\u65f6\u95f4 \u8fdb\u7a0b\u6570\n\n</code></pre>"},{"location":"postgres/tools/monitor_explain/#wal","title":"WAL","text":"<pre><code>--- \u8fc7\u53bb5\u5206\u949f\u5185\u751f\u6210wal\u4e2a\u6570\nselect count(1) from pg_catalog.pg_ls_waldir() where modification &gt; CURRENT_TIMESTAMP - '5 minutes' :: INTERVAL ;\n\n--- wal\u5199\u5165\u901f\u7387\nSELECT CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - '0/0' as wal_lsn;\n</code></pre>"},{"location":"postgres/tools/monitor_explain/#checkpoint","title":"CheckPoint","text":"<pre><code>-- checkpoint  \u53d1\u751f\u9891\u7387\n</code></pre>"},{"location":"postgres/tools/monitor_explain/#_4","title":"\u8fde\u63a5\u6570","text":""},{"location":"postgres/tools/monitor_explain/#_5","title":"\u957f\u4e8b\u7269","text":"<pre><code>pg_stat_activity &gt; 2\u5c0f\u65f6\n</code></pre>"},{"location":"postgres/tools/monitor_explain/#2pc","title":"2pc \u672a\u63d0\u4ea4\u4e8b\u7269","text":"<pre><code>pg_prepared_xact() &gt; 5 \u5206\u949f\n</code></pre>"},{"location":"postgres/tools/monitor_explain/#_6","title":"\u590d\u5236\u69fd","text":""},{"location":"postgres/tools/monitor_explain/#_7","title":"\u4e3b\u4ece","text":"<pre><code>-- \u4e3b\u4ece\u6d41\u590d\u5236\u5ef6\u65f6\u65f6\u95f4 \uff08\u4ece\u5e93\u6267\u884c\uff09\n10 \u7248\u672c\u4ee5\u524d\nSELECT CASE WHEN pg_last_xlog_receive_location() = pg_last_xlog_replay_location() THEN 0 ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp()) END\n\n10 \u7248\u672c\u53ca\u4ee5\u540e\n\nSELECT CASE WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0 ELSE EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp()) END;\n</code></pre> <pre><code>-- \u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u5b57\u8282 (\u4e3b\u5e93\u6267\u884c)\n\nselect greatest(0,pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn)) from pg_stat_replication ; where client_addr = '\u4ece\u5e93IP'\n</code></pre>"},{"location":"postgres/tools/pg_activity/","title":"\u6570\u636e\u5e93\u5b9e\u65f6\u8fd0\u884c\u4fe1\u606f\u67e5\u770b","text":"","tags":[]},{"location":"postgres/tools/pg_activity/#_1","title":"\u4ecb\u7ecd","text":"<p>\u7c7b\u4f3cLinux top \u547d\u4ee4 \u67e5\u770b\u6570\u636e\u5b9e\u65f6\u8fd0\u884c\u60c5\u51b5</p> <p> https://github.com/dalibo/pg_activity</p>","tags":[]},{"location":"postgres/tools/pg_activity/#_2","title":"\u5b89\u88c5","text":"<p>\u6d4b\u8bd5\u73af\u5883centos7 postgresql10</p>","tags":[]},{"location":"postgres/tools/pg_activity/#pg","title":"\u67e5\u770b\u5df2\u5b89\u88c5\u7684PG\u7248\u672c","text":"<p>\u5982\u679c\u67099.2 \u7248\u672c\uff0c\u6e05\u7406,\u5982\u679c\u6ca1\u6709postgresql10-devel \u9700\u8981\u5b89\u88c5</p> <pre><code> yum list installed | grep postgres\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_activity/#_3","title":"\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf","text":"<pre><code>export PG_HOME=/usr/pgsql-10\nexport PATH=$PATH:$PG_HOME/bin/\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_activity/#pg_activity","title":"\u5b89\u88c5pg_activity","text":"<pre><code>python3 -m pip install pg_activity psycopg2-binary\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_activity/#_4","title":"\u4f7f\u7528","text":"<p>\u4e0epsql \u8fde\u63a5\u65b9\u5f0f\u76f8\u540c</p> <pre><code>pg_activity -U xxx -p xxx \n</code></pre>","tags":[]},{"location":"postgres/tools/pg_activity/#_5","title":"\u66f4\u591a\u8fde\u63a5\u53c2\u6570","text":"","tags":[]},{"location":"postgres/tools/pg_activity/#_6","title":"\u5b9e\u65f6\u754c\u9762 ,\u6309\u952e\u8bf4\u660e","text":"<pre><code>r   Sort by READ/s, descending\nw   Sort by WRITE/s, descending\nc   Sort by CPU%, descending\nm   Sort by MEM%, descending\nt   Sort by TIME+, descending\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_buffercache/","title":"pg_buffercache","text":"","tags":[]},{"location":"postgres/tools/pg_buffercache/#pg","title":"\u901a\u8fc7\u63d2\u4ef6\u67e5\u770bPG\u6570\u636e\u7f13\u5b58","text":"<pre><code>create extension pg_buffercache;\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_buffercache/#database","title":"\u67e5\u770b\u5f53\u524ddatabase\u7f13\u5b58\u4f7f\u7528\u60c5\u51b5","text":"<pre><code>select c.relname,relname,pg_size_pretty(pg_table_size(c.oid)),pg_size_pretty(count(*) * 8192) as buffered,\nround(100.0*count(*)/(select setting FROM pg_settings where name = 'shared_buffers')::integer,1) as buffer_percent,\nround(100.0 * count(*) *  8192/pg_table_size(c.oid)) as percent_of_table\nfrom pg_class c inner join pg_buffercache b on b.relfilenode = c.relfilenode inner join pg_database d on (b.reldatabase = d.oid and d.datname = current_database())                     \ngroup by c.oid ,c.relname order by 3 desc limit 10;\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_citus/","title":"citus \u6570\u636e\u5e93\u5206\u5e93","text":""},{"location":"postgres/tools/pg_citus/#_1","title":"\u6570\u636e\u5e93\u5206\u5e93\u8c03\u7814","text":"<ul> <li>Greenplum  \u66f4\u9002\u7528\u4e8eAP\u573a\u666f</li> <li>PGXL PGXC  \u793e\u533a\u4e0d\u6d3b\u8dc3\uff0c\u6c9f\u901a\u95ee\u9898\u53cd\u9988\u65f6\u95f4\u957f\u3002\u6ca1\u627e\u5230\u7528\u6237\u7fa4\u4f53. \u5728\u6b64\u57fa\u7840\u4e0a\u53d1\u5c55\u7684\u6709\u4e9a\u4fe1antdb\uff0c\u817e\u8baftbase\u3002\u6ca1\u6709\u90a3\u4e2a\u7814\u53d1\u5b9e\u529b\uff0c\u7b97\u4e86\u5427\u3002</li> <li>citus      \u63d2\u4ef6\u65b9\u5f0f\uff0c\u65e0\u4fb5\u5165\u3002\u5f88\u591a\u725bX\u7684\u7279\u6027\u4f01\u4e1a\u7248\u624d\u652f\u6301\u3002\u4e3b\u8981\u5f3a\u8c03\u591a\u79df\u6237\u3002 </li> <li>mycat      mysql\u652f\u6d3e\uff0c\u963f\u91cc\u5f00\u6e90\uff08\u629b\u5f03\uff09\u9879\u76ee\u3002\u4e3b\u8981\u662f\u5bf9sql\u8bed\u53e5\u7684\u62e6\u622a\uff0c\u9700\u8981\u5bf9\u4e1a\u52a1\u7406\u89e3\u900f\u5f7b\u53c8\u8981\u61c2mycat\uff0c\u5165\u4fb5\u592a\u5f3a\u3002</li> <li>bdr\u3002      2ndquadrant </li> <li>\u5176\u4ed6       \u7531\u6570\u636e\u5e93\u89e6\u53d1\u5668\u5b9e\u73b0\u7684\u76f4\u63a5\u7565\u8fc7</li> </ul> <p>citus \u5f00\u6e90\u793e\u533a\u7248\uff0c\u5982\u4f55\u5206\u5e93\u53ca\u6269\u5bb9\uff0cha</p> <p>\u4e3b\u8981\u601d\u8def\u662f\u901a\u8fc7\u4fee\u6539\u7cfb\u7edf\u7684\u5206\u533a\u8868\uff0c\u624b\u52a8\u8fdb\u884c\u5206\u5e93\u3002  ha \u6570\u636e\u5e93\u81ea\u8eab\u7684\u4e3b\u4ece\u6d41\u590d\u5236\u3002 </p>"},{"location":"postgres/tools/pg_citus/#_2","title":"\u5b9e\u9a8c\u76ee\u6807","text":"<ul> <li>\u52a0\u5165\u6570\u636e\u5e93\u51e0\u70b9\u8fdb\u884c\u6269\u5bb9</li> <li>\u5220\u9664\u6570\u636e\u5e93\u8282\u70b9\u8fdb\u884c\u7f29\u5bb9</li> <li>\u6a21\u62df\u4efb\u610f\u8282\u70b9\u5b95\u673a\u89c2\u5bdfha\u7279\u6027</li> <li>\u538b\u529b\u6d4b\u8bd5\u5224\u65ad\u589e\u52a0\u4e3b\u673a\u8282\u70b9\u4e0e\u6570\u636e\u5e93\u6574\u4f53\u5904\u7406\u80fd\u529b\u4e4b\u95f4\u7684\u7ebf\u5f62\u5173\u7cfb</li> </ul>"},{"location":"postgres/tools/pg_elk/","title":"\u6570\u636e\u5e93\u65e5\u5fd7\u5206\u6790","text":"","tags":[]},{"location":"postgres/tools/pg_elk/#_1","title":"\u6570\u636e\u5e93\u65e5\u5fd7\u5206\u6790","text":"<p>\u6574\u4f53\u67b6\u6784</p> <p>filebeat -&gt; logstash -&gt; elasticseach -&gt; kibana</p> <ul> <li>filebeat \u6536\u96c6\u65e5\u5fd7</li> <li>logstash \u4e2d\u8f6c\u53ca\u65e5\u5fd7\u89c4\u5219\u5339\u914d\u8fc7\u6ee4</li> <li>elasticsearch \u65e5\u5fd7\u5b58\u50a8\u68c0\u7d22\u5e93</li> <li>kibana \u67e5\u770b\u754c\u9762</li> </ul>","tags":[]},{"location":"postgres/tools/pg_elk/#postgresql","title":"postgresql","text":"<pre><code>log_destination = 'csvlog'\nlogging_collector = 'on'\nlog_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'\nlog_rotation_age = '1d'\nlog_rotation_size = '100MB'\nlog_min_messages = 'info'\nlog_min_duration_statement = '1000'\nlog_statement = 'ddl'\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_elk/#filebeat","title":"filebeat","text":"<pre><code>filebeat.inputs:\n- type: log\n  enabled: true\n  paths:\n    - /var/lib/pgsql/***/postgresql-*.csv\n  fields:\n    log_topics: postgresql\n\n  multiline.pattern: '^[[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3} [A-Z]{3}'\n  multiline.negate: true\n  multiline.match: after\nfilebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: false\nsetup.template.settings:\n  index.number_of_shards: 1\ntags: [\"postgesql\"]\nsetup.kibana:\noutput.logstash:\n  hosts: [\"*.*.*.*:5044\"]\nprocessors:\n  - add_host_metadata: ~\n  - add_cloud_metadata: ~\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_elk/#logstash","title":"logstash","text":"<pre><code>#\n# this config is use for version logstash 7.3.1\n#\n\ninput {\n  beats {\n    port =&gt; 5044\n  }\n\n  #sdtin{\n  #\n  #}\n\n}\n\n\n# The filter part of this file is commented out to indicate that it\n# is optional.\n\n# use csv plugin against pglog , pglog neet set log format to csv first.\nfilter {\n  csv {\n    columns =&gt; [\n      \"log_time\",\n      \"user_name\",\n      \"database_name\",\n      \"process_id\",\n      \"connection_from\",\n      \"session_id\",\n      \"session_line_num\",\n      \"command_tag\",\n      \"session_start_time\",\n      \"virtual_transaction_id\",\n      \"transaction_id\",\n      \"error_severity\",\n      \"sql_state_code\",\n      \"message\",\n      \"detail\",\n      \"hint\",\n      \"internal_query\",\n      \"internal_query_pos\",\n      \"context\",\n      \"query\",\n      \"query_pos\",\n      \"location\",\n      \"application_name\"\n    ]\n  }\n}\n\n#\n# different log type out put different log format\n# 1. log duration log\n# 2. norm log statment\n# 3. checkpint log\n# 4. other\nfilter {\n if [message] =~ /duration: [0-9]{1,8}[.]{0,1}[0-9]{1,5} ms/ {\n     mutate {\n         split =&gt; { \"message\" =&gt; \"statement:\" }\n         add_field =&gt; {\"duration\" =&gt; \"%{[message][0]}\"}\n         add_field =&gt; {\"statement\" =&gt; \"%{[message][1]}\"}\n     }\n    mutate { gsub =&gt; [ \"duration\", \"duration: \", \"\" ] }\n    mutate { gsub =&gt; [ \"duration\", \" ms\", \"\" ] }\n    mutate { convert =&gt; { \"duration\" =&gt; \"float\" } }\n    mutate {\n      add_field =&gt; {\"sqltype\" =&gt;  \"slowsql\" }\n      remove_field =&gt; \"message\"\n   }\n  } else if [message] =~ /statement: / {\n    mutate { gsub =&gt; [ \"message\", \"statement: \", \"\" ] }\n    mutate { rename =&gt; {\"message\" =&gt; \"statement\"}}\n    mutate {add_field =&gt; { \"sqltype\" =&gt; \"statementsql\" } }\n  } else if [message] =~ /checkpoint / {\n    mutate {add_field =&gt; { \"sqltype\" =&gt; \"checkpoint\" } }\n    mutate { rename =&gt; {\"message\" =&gt; \"statement\"}}\n  } else{\n    mutate {add_field =&gt; { \"sqltype\" =&gt; \"other\" } }\n  }\n\n  mutate { remove_field =&gt; [\n    \"connection_from\",\n    \"session_line_num\",\n    \"command_tag\",\n    \"session_start_time\",\n    \"virtual_transaction_id\",\n    \"transaction_id\",\n    \"error_severity\",\n    \"sql_state_code\",\n    \"detail\",\n    \"hint\",\n    \"internal_query\",\n    \"internal_query_pos\",\n    \"context\",\n    \"query\",\n    \"query_pos\",\n    \"location\",\n    \"application_name\",\n    \"source\",\n    \"input_type\"\n  ] }\n}\n\noutput {\n# file {\n#   path =&gt; \"/etc/logstash/pg.log\"\n#   codec =&gt; line { format =&gt; \"custom format: %{message}\"}\n# }\n\n#   for debug\n\n#    stdout {\n#        codec =&gt; rubydebug\n#    }\n\n\n elasticsearch {\n   hosts =&gt; \"*.*.*.*:9200\"\n#   manage_template =&gt; false\n   template_name =&gt; \"postgres_template\"\n   index =&gt; \"%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}\"\n   #user =&gt; \"elastic\"\n   #password =&gt; \"123456\"\n }\n}\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_lock/","title":"\u9501\u673a\u5236","text":"<p>https://blog.csdn.net/pg_hgdb/article/details/79403651</p> <p>https://habr.com/en/company/postgrespro/blog/500714/</p> <p>\u8868\u9501 https://www.modb.pro/db/26462</p> <pre><code>\u67e5\u770b\u88ab\u5835\u585e\u7684\u4efb\u52a1\nselect * from pg_locks where not granted;\n locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pid | mode | granted | fastpath \n----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----+------+---------+----------\n(0 \u884c\u8bb0\u5f55)\n\n\u67e5\u770b\u7b49\u5f85\u9501\u4fe1\u606f\uff0c\u662f\u88ab\u8c01\u5835\u585e\u4e86\nselect pg_blocking_pids(pid);\n pg_blocking_pids \n------------------\n {}\n\n\u7ec8\u6b62\u8fdb\u7a0b\n\nselect pg_cancel_backend(pid);  # select \n\nselect pg_terminate_backend(pid); # update insert delete \n</code></pre>"},{"location":"postgres/tools/pg_lock/#_1","title":"\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b","text":"<p>Postgres \u6570\u636e\u5e93\u5171\u6709\u4e09\u79cd\u6570\u636e\u9694\u79bb\u7ea7\u522b\u3002</p> <ul> <li>Read Commit \u8bfb\u770b\u63d0\u4ea4  \u9ed8\u8ba4\u7ea7\u522b \u5728\u8bfb\u5f00\u59cb\u7684\u65f6\u5019\u5efa\u7acb\u6570\u636e\u5feb\u7167</li> <li>Repeat Read \u53ef\u91cd\u590d\u8bfb\u3002\u5728\u4e8b\u52a1\u5f00\u59cb\u7684\u65f6\u5019\u5efa\u7acb\u6570\u636e\u5feb\u7167</li> <li>SSI Serializable \u5e8f\u5217\u5316 \u7406\u89e3\u4e3a\u53ea\u6709\u4e00\u4e2a\u7528\u6237\u4f7f\u7528\u7684\u60c5\u51b5</li> </ul> <p>\u4f7f\u7528\u4e3e\u4f8b</p> <pre><code>postgres=# \\h lock\nCommand:     LOCK\nDescription: lock a table\nSyntax:\nLOCK [ TABLE ] [ ONLY ] name [ * ] [, ...] [ IN lockmode MODE ] [ NOWAIT ]\n\nwhere lockmode is one of:\n\n    ACCESS SHARE | ROW SHARE | ROW EXCLUSIVE | SHARE UPDATE EXCLUSIVE\n    | SHARE | SHARE ROW EXCLUSIVE | EXCLUSIVE | ACCESS EXCLUSIVE\n</code></pre> <p>\u9501\u5b9a\u4e00\u5f20\u8868</p> <pre><code>postgres=# begin ;\nBEGIN\npostgres=# lock TABLE wt IN access exclusive mode ;\nLOCK TABLE\n\n</code></pre>"},{"location":"postgres/tools/pg_pathman/","title":"pg_pathman \u5206\u533a\u8868","text":"","tags":[]},{"location":"postgres/tools/pg_pathman/#_1","title":"\u4ecb\u7ecd","text":"<p>\u5206\u533a\u8868\u7684\u8bc9\u6c42\u5728\u73b0\u5b9e\u7684\u751f\u6210\u4e2d\u7684\u610f\u4e49\u4e0d\u5fc5\u591a\u8bf4\uff0cpg\u4ee5\u524d\u7684\u5b9e\u73b0\u65b9\u5f0f\u591a\u91c7\u7528\u89e6\u53d1\u5668\uff0crules\u5b9e\u73b0\u3002\u6570\u636e\u91cf\u4e0a\u6765\u65f6\u6027\u80fd\u660e\u663e\u4e0d\u5c3d\u5982\u610f\u3002  \u867d\u7136pg10 \uff0c11 \u7248\u672c\u5728\u5206\u533a\u8868\u7684\u7279\u6027\u4e0a\u4e0d\u65ad\u53d1\u529b\u3002\u4f46\u662f\u6027\u80fd\u5565\u8fd8\u662f\u4e0d\u591f\u7ed9\u529b\u3002  pg_pathman \u5206\u533a\u8868\u529f\u80fd\u5728\u76ee\u524d\u7684pg\u7248\u672c10.6 \u4e2d\u4f18\u52bf\u8fd8\u662f\u975e\u5e38\u660e\u663e\u7684\u3002   </p> <p>\u5728\u671f\u5f85pg\u81ea\u8eab\u5206\u533a\u8868\u7279\u6027\u7684\u540c\u65f6\uff0c\u5f53\u524d\u7684pg10\u4e2d\u8fd8\u662f\u4f7f\u7528pg_pathman\u6765\u5b9e\u73b0\u5206\u533a\u529f\u80fd\u5427\u3002</p>","tags":[]},{"location":"postgres/tools/pg_pathman/#pathmanpg11","title":"pathman\u4e0epg11 \u5bf9\u6bd4","text":"<p>\u4f18\u70b9: \u652f\u6301HASH\u548cRANGE\u5206\u533a\uff0c\u540e\u7eed\u4f1a\u652f\u6301LIST\u5206\u533a \u652f\u6301\u81ea\u52a8\u548c\u624b\u52a8\u7684\u5206\u533a\u7ef4\u62a4 \u4e3a\u5206\u533a\u8868\u751f\u6210\u66f4\u6709\u6548\u7684\u6267\u884c\u8ba1\u5212 \u901a\u8fc7\u5f15\u5165\u4e24\u4e2a\u81ea\u5b9a\u4e49\u7684\u6267\u884c\u8ba1\u5212\u8282\u70b9RuntimeAppend &amp; RuntimeMergeAppend\uff0c \u5b9e\u73b0\u8fd0\u884c\u65f6\u52a8\u6001\u6dfb\u52a0\u5206\u533a\u5230\u6267\u884c\u8ba1\u5212\u4e2d \u4e3a\u65b0\u63d2\u5165\u6570\u636e\u81ea\u52a8\u521b\u5efa\u5206\u533a(\u53ea\u5bf9RANGE\u5206\u533a) \u63d0\u4f9b\u7528\u6237callbacks\u63a5\u53e3\u5904\u7406\u521b\u5efa\u5206\u533a\u4e8b\u4ef6\u3002   \u63d0\u4f9b\u5728\u7ebf\u5206\u533a\u5b9e\u65bd(\u5728\u7ebf\u91cd\u5b9a\u4e49)\uff0c\u7236\u8868\u6570\u636e\u8fc1\u79fb\u5230\u5b50\u8868\uff0c\u62c6\u5206\uff0c \u5408\u5e76\u5206\u533a</p> <p>\u4e0d\u8db3:  \u4e0d\u652f\u6301list\u5206\u533a;\u4e0d\u652f\u6301\u4e8c\u7ea7\u5206\u533a;\u6743\u9650\uff0c\u7d22\u5f15\uff0ctrigger\u7b49\u65e0\u6cd5\u7ee7\u627f; \u4fee\u6539\u4e3b\u952e\u9ed8\u8ba4\u7684seq\u9700\u8981\u91cd\u5efa\u5206\u533a\u3002    </p> <p>PG11\u5185\u7f6e\u5206\u533a  \u4f18\u70b9:  \u652f\u6301hash\uff0crange\uff0clist\u5206\u533a \u652f\u6301\u591a\u5b57\u6bb5\u7ec4\u5408\u5206\u533a\uff0c\u652f\u6301\u8868\u8fbe\u5f0f\u5206\u533a \u652f\u6301\u521b\u5efa\u4e3b\u952e\uff0c\u5916\u952e\uff0c\u7d22\u5f15\uff0c\u5206\u533a\u8868\u81ea\u52a8\u7ee7\u627f\u3002 \u652f\u6301update\u5206\u533a\u952e \u652f\u6301\u5206\u533a\u8868DETACH\uff0cATTACH\uff0c\u652f\u6301\u4e8c\u7ea7\u5206\u533a \u5206\u533a\u81ea\u52a8\u521b\u5efa  Default partition Partition improvements   </p> <p>\u4e0d\u8db3:   </p> <p>\u5728\u4e3b\u8868\u6dfb\u52a0\u6743\u9650\uff0c\u7d22\u5f15\uff0ctrigger\u7b49\u65e0\u6cd5\u7ee7\u627f \u5206\u533a\u8868\u4e0d\u53ef\u4ee5\u4f5c\u4e3a\u5176\u4ed6\u8868\u7684\u5916\u952e\u4e3b\u8868   </p>","tags":[]},{"location":"postgres/tools/pg_pathman/#_2","title":"\u5206\u533a\u8868\u6570\u91cf\u5bf9\u63d2\u5165\u6570\u636e\u7684\u5f71\u54cd","text":"<p>https://www.jianshu.com/p/1cba77d18694</p>","tags":[]},{"location":"postgres/tools/pg_pathman/#pathman","title":"pathman \u5206\u533a\u8868 \u8f6c\u6362\u4e3a\u539f\u751f\u5206\u533a\u8868","text":"<p>https://github.com/digoal/blog/blob/master/201911/20191113_01.md</p> <p>\u4e3b\u8981\u601d\u8def</p> <p>1 \u521b\u5efa\u4e00\u4e2a\u4e0e\u539f\u6765\u5206\u533a\u8868\u4e00\u6837\u7684\u4e3b\u8868\u5305\u62ec\u5206\u533a\u65b9\u5f0f \u3002</p> <p>2 \u5c06\u539f\u6765\u7684\u4e3b\u8868\u4e0a\u7684\u5206\u533a\u90fd\u5378\u8f7d\u4e3a\u666e\u901a\u8868\uff0c\u5728\u91cd\u65b0\u6309\u7167\u539f\u751f\u5206\u533a\u8868\u7684\u65b9\u5f0f\u6302\u8f7d\u4e0a\u53bb\u3002</p> <p>\u76f4\u63a52 \u4e5f\u884c</p> <p>\u62d3\u5c55\u601d\u8003\u3002 \u5206\u533a\u6570\u636e\u8fc1\u79fb\u4f7f\u7528pg_pathman\uff0c\u8fc1\u79fb\u540e\u518d\u8f6c\u6362\u5230\u539f\u751f\u8868\u3002</p>","tags":[]},{"location":"postgres/tools/pg_pathman/#_3","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u9700\u8981\u5c06pg_pathman\u653e\u5728\u540e\u9762\u6ce8\u518c\uff0c\u5982pg_stat_statements\u3002</p> <pre><code>shared_preload_libraries = 'pg_stat_statements,pg_pathman'\n</code></pre> <p>\u521b\u5efa\u62d3\u5c55</p> <pre><code>CREATE SCHEMA pathman;\nGRANT USAGE ON SCHEMA pathman TO PUBLIC;\nCREATE EXTENSION pg_pathman WITH SCHEMA pathman;\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_pathman/#_4","title":"\u53c2\u8003","text":"<p>https://github.com/postgrespro/pg_pathman</p> <p>https://github.com/digoal/blog/blob/362b84417ca8b7aaf1add31fe7689c347642bb9a/201610/20161024_01.md</p>","tags":[]},{"location":"postgres/tools/pg_pathman/#_5","title":"\u5e38\u89c1\u9519\u8bef","text":"<pre><code>FATAL:  could not load library \"/usr/pgsql-12/lib/pg_pathman.so\": /usr/pgsql-12/lib/pg_pathman.so: undefined symbol: expandTableLikeClause\npostgres \u7248\u672c\u95ee\u9898\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_pathman/#_6","title":"\u7b80\u5355\u5e94\u7528","text":"<p>1 \u521b\u5efa\u8868\u5206\u533a\uff0c\u7981\u6b62\u6570\u636e\u8fc1\u79fb</p> <p>2 \u5e76\u884c\u8fc1\u79fb\u6570\u636e</p> <p>3 \u7981\u6b62\u4e3b\u8868</p> <p>\u8868 log  \u5fc5\u9700\u6ee1\u8db3</p> <ul> <li> <p>\u5b57\u6bb5 created_time not null</p> </li> <li> <p>\u65e0\u5916\u952e\u7ea6\u675f </p> </li> </ul> <p>\u6309\u6708\u5206\u8868,\u540e\u7eed\u6570\u636e\u8d85\u51fa\u8303\u56f4\u4f1a\u81ea\u52a8\u521b\u5efa\u5206\u533a\uff08\u9ed8\u8ba4\uff09</p> <p>\u67e5\u770b\u8868\u4e2d\u6700\u65e9\u65e5\u671f</p> <pre><code>select min(created_time) from log;\n---\n2018-05-18 00:00:00\n</code></pre> <p>\u5206\u8868 false \u8868\u793a\u7981\u6b62\u6570\u636e\u79fb\u52a8</p> <pre><code>select create_range_partitions('log'::regclass,'created_time','2018-05-18 00:00:00'::timestamp,interval '1 month', null,false);\n</code></pre> <p>\u67e5\u770b\u5206\u533a\u8868</p> <pre><code>select * from pathman_partition_list where parent = 'log'::regclass;\n</code></pre> <p>\u5e76\u884c\u8fc1\u79fb\u6570\u636e</p> <pre><code>select partition_table_concurrently('log'::regclass,10000,1.0);\n</code></pre> <p>\u67e5\u770b\u8fc1\u79fb\u72b6\u6001</p> <pre><code>select * from pathman_concurrent_part_tasks ;\n</code></pre> <p>\u7981\u4e3b\u8868</p> <pre><code>select set_enable_parent('log'::regclass,false);\n</code></pre> <p>\u67e5\u770b\u6570\u636e</p> <pre><code>select count(1) from only log;\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_pathman/#_7","title":"\u5206\u533a\u8868\u5e38\u7528\u7ba1\u7406","text":"<p>\u5c06\u4e00\u4e2a\u5206\u533a\u62c6\u5206\u4e3a\u4e24\u4e2a\u5206\u533a</p> <pre><code>split_range_partition(partition_relid REGCLASS,\n                      split_value     ANYELEMENT,\n                      partition_name  TEXT DEFAULT NULL,\n                      tablespace      TEXT DEFAULT NULL)\n</code></pre> <p>\u5408\u5e76\u591a\u4e2a\u8fde\u7eed\u5206\u533a,\u6570\u636e\u5c06\u5230\u7b2c\u4e00\u4e2a\u5206\u533a</p> <pre><code>merge_range_partitions(variadic partitions REGCLASS[])\n</code></pre> <p>\u5411\u540e\u8ffd\u52a0\u4e00\u4e2a\u5206\u533a,\u5206\u533a\u95f4\u9694\u9ed8\u8ba4</p> <pre><code>append_range_partition(parent_relid   REGCLASS,\n                       partition_name TEXT DEFAULT NULL,\n                       tablespace     TEXT DEFAULT NULL)\n</code></pre> <p>\u5411\u524d\u8ffd\u52a0\u4e00\u4e2a\u5206\u533a\uff0c\u5206\u533a\u95f4\u9694\u9ed8\u8ba4</p> <pre><code>prepend_range_partition(parent_relid   REGCLASS,\n                        partition_name TEXT DEFAULT NULL,\n                        tablespace     TEXT DEFAULT NULL)\n</code></pre> <p>\u6dfb\u52a0\u4e00\u4e2a\u81ea\u5b9a\u4e49\u95f4\u9694\u5206\u533a: \u5982\u52a0\u4e00\u4e2a</p> <pre><code>add_range_partition(parent_relid   REGCLASS,\n                    start_value    ANYELEMENT,\n                    end_value      ANYELEMENT,\n                    partition_name TEXT DEFAULT NULL,\n                    tablespace     TEXT DEFAULT NULL)\n</code></pre> <p>\u5220\u9664\u4e00\u4e2a\u5206\u533a\uff0c\u53ca\u6570\u636e\u662f\u5426\u5220\u9664. \u4e0d\u5220\u9664\u6570\u636e\u5c06\u5165\u4e3b\u8868</p> <pre><code>drop_range_partition(partition TEXT, delete_data BOOLEAN DEFAULT TRUE)\n</code></pre> <p>\u5378\u8f7d\u5206\u533a\u4e3a\u666e\u901a\u8868</p> <pre><code>detach_range_partition(partition_relid REGCLASS)\n</code></pre> <p>\u6302\u8f7d\u666e\u901a\u8868\u4e3a\u5206\u533a\u8868</p> <pre><code>attach_range_partition(parent_relid    REGCLASS,\n                       partition_relid REGCLASS,\n                       start_value     ANYELEMENT,\n                       end_value       ANYELEMENT)\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_pathman/#_8","title":"\u53c2\u6570","text":"<p>\u4fee\u6539\u9ed8\u8ba4\u5206\u533a\u95f4\u9694</p> <pre><code>set_interval(relation REGCLASS, value ANYELEMENT)\n</code></pre> <p>\u662f\u5426\u7981\u7528\u4e3b\u8868,\u7981\u7528\u540e\u6267\u884c\u8ba1\u5212\u5c06\u4e0d\u5728\u8d70\u4e3b\u8868</p> <pre><code>set_enable_parent(relation REGCLASS, value BOOLEAN)\n</code></pre> <p>\u662f\u5426\u81ea\u52a8\u521b\u5efa\u5206\u533a. \u5f00\u542f\u540e\u6ce8\u610f\u4e8b\u9879\uff0c \u5982\u679c\u6709\u4e00\u6761\u6570\u636e\u7684\u65f6\u95f4\u5f02\u5e38\uff0c\u4f1a\u521b\u5efa\u5927\u91cf\u7684\u5206\u533a\u8868\u3002\u707e\u96be</p> <pre><code>set_auto(relation REGCLASS, value BOOLEAN)\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_pathman/#_9","title":"\u9057\u7559\u95ee\u9898","text":"<p>1 \u539f\u8868\u5206\u533a\u540e\u6570\u636e\u78c1\u76d8\u5360\u7528\u589e\u52a0\u8fd1\u4e00\u500d\uff0c\u9700\u8981vacuum full \u89e3\u51b3. \u4e3b\u8868\u6b8b\u7559</p> <p>\u6570\u636e\u5168\u90e8\u5206\u533a\u540e vacuum \u901f\u5ea6\u4e5f\u5f88\u5feb</p> <p>2 \u5206\u533a\u540e\u5bf9\u7236\u8868\u6dfb\u52a0\u6216\u5220\u9664\u7d22\u5f15\u64cd\u4f5c\u5bf9\u73b0\u6709\u5206\u533a\u8868\u4e0d\u4ea7\u751f\u4f5c\u7528\uff0c\u4ec5\u5bf9\u65b0\u751f\u6210\u7684\u5206\u533a\u6709\u6548\u3002How do I create indexes?</p>","tags":[]},{"location":"postgres/tools/pg_pathman/#_10","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5bf9\u5df2\u7ecf\u5206\u533a\u7684\u8868\u4f7f\u7528copy \u65b9\u5f0f\u5bfc\u5165\u6570\u636e\u540e\u6570\u636e\u53ea\u5b58\u5728\u4e8e\u7236\u8868\u4e2d\uff0c\u6b64\u65f6\u6267\u884cpartition_table_concurrently \u65e0\u6548\u679c</p> <p>\u89e3\u51b3</p> <pre><code> 1 set_enable_parent('log'::regclass, true)\n</code></pre> <pre><code> 2 \u521b\u5efa\u5206\u533a\u8868 \u5982\u63d2\u5165\u4e00\u6761\u6570\u636e \uff0c \u65f6\u95f4\u6bd4\u6700\u5c0f\u65f6\u95f4\u8fd8\u5c0f\uff0cselect min(create) from only log\n</code></pre> <pre><code> 3 partition_table_concurrently\n</code></pre> <p>\u5206\u533a\u8868\u4e0e\u539f\u751f\u8868\u6bd4\u8f83\u3002\u7ba1\u7406\u4e0a\u5e26\u6765\u4e86\u5f88\u5927\u7684\u4fbf\u5229\uff0c\u5c24\u5176\u662f\u6570\u636e\u7684\u5f52\u6863\u6574\u7406\u3002</p> <p>\u6027\u80fd\u4e0a\u53cd\u800c\u53ef\u80fd\u4f1a\u53d8\u5f97\u66f4\u5dee\uff0c\u67e5\u8be2\u6761\u4ef6\u4e00\u5b9a\u8981\u5e26\u4e0a\u5206\u533a\u5065\uff0c\u5426\u5219\u4f1a\u626b\u63cf\u6240\u6709\u5b50\u8868\u3002</p> <p>\u5f53\u5355\u4e2a\u7d22\u5f15\u7684\u5927\u5c0f\u8d85\u8fc7\u7269\u7406\u5185\u5b58\u7684\u4e00\u534a\u65f6\u8003\u8651\u5206\u8868</p>","tags":[]},{"location":"postgres/tools/pg_pathman/#_11","title":"\u9047\u89c1\u8fc7\u7684\u9519\u8bef","text":"<pre><code>ERROR:  unrecognized node type: 369\n\u80cc\u666f:  SQL statement \"select public.create_single_range_partition\n</code></pre> <p>\u89e3\u51b3\uff1a https://github.com/postgrespro/pg_pathman/issues/224</p> <p>\u5c06 1.5.11 \u5347\u7ea7\u81f3 1.5.12 </p>","tags":[]},{"location":"postgres/tools/pg_prewarm/","title":"\u6570\u636e\u9884\u52a0\u8f7d","text":"<p>https://blog.csdn.net/Hehuyi_In/article/details/102653909</p>"},{"location":"postgres/tools/pg_repack/","title":"pg_repack","text":"<p>pg_repack \u662f PostgreSQL \u7684\u4e00\u4e2a\u6269\u5c55\u5de5\u5177\uff0c\u7528\u4e8e\u5728\u7ebf\u91cd\u7ec4\u8868\u548c\u7d22\u5f15\uff0c\u89e3\u51b3\u8868\u81a8\u80c0\u95ee\u9898\uff0c\u800c\u65e0\u9700\u9501\u5b9a\u6574\u4e2a\u8868\u3002</p>"},{"location":"postgres/tools/pg_repack/#_1","title":"\u4f5c\u7528","text":"<ul> <li>Online CLUSTER (ordered by cluster index)</li> <li>Ordered by specified columns</li> <li>Online VACUUM FULL (packing rows only)</li> <li>Rebuild or relocate only the indexes of a table</li> </ul> <p>\u5b9e\u9645\u751f\u4ea7\u4e2d\u91cd\u8981\u662f\u7528\u6765\u4ee3\u66ff vacuum full \u8fdb\u884c\u5b58\u50a8\u7a7a\u95f4\u6574\u7406\uff0c\u8ba9\u6570\u636e\u66f4\u7d27\u51d1\u6709\u5e8f\u3002\u5e76\u4e14\u91ca\u653e\u5b58\u50a8\u7a7a\u95f4\u7ed9\u78c1\u76d8\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u9501\u8868\u6216\u957f\u65f6\u95f4\u963b\u585e\u4e1a\u52a1\u64cd\u4f5c\u3002</p>"},{"location":"postgres/tools/pg_repack/#_2","title":"\u539f\u7406","text":"<p>pg_repack \u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8868\u7ed3\u6784\uff0c\u5c06\u539f\u8868\u6570\u636e\u6309\u987a\u5e8f\u590d\u5236\u5230\u65b0\u8868\u4e2d\uff0c\u7136\u540e\u901a\u8fc7\u539f\u5b50\u6027\u7684\u91cd\u547d\u540d\u64cd\u4f5c\u66ff\u6362\u539f\u8868\uff0c\u4ece\u800c\u5b9e\u73b0\u5728\u7ebf\u91cd\u7ec4\u3002\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>create a log table to record changes made to the original table</li> <li>add a trigger onto the original table, logging INSERTs, UPDATEs and DELETEs into our log table</li> <li>create a new table containing all the rows in the old table</li> <li>build indexes on this new table</li> <li>apply all changes which have accrued in the log table to the new table</li> <li>swap the tables, including indexes and toast tables, using the system catalogs</li> <li>drop the original table</li> </ol>"},{"location":"postgres/tools/pg_repack/#_3","title":"\u5e94\u7528","text":""},{"location":"postgres/tools/pg_repack/#_4","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>Only superusers or owners of tables and indexes can use the utility. To run pg_repack as an owner you need to use the option --no-superuser-check.</li> <li>Target table must have a PRIMARY KEY, or at least a UNIQUE total index on a NOT NULL column.</li> </ul>"},{"location":"postgres/tools/pg_repack/#_5","title":"\u5b89\u88c5","text":"<p>\u5bf9\u5e94\u6570\u636e\u5e93\u7248\u672c\uff0c\u76f4\u63a5\u5b89\u88c5\u5c31\u53ef\u4ee5\u3002</p> <pre><code># Ubuntu/Debian\nsudo apt-get update\nsudo apt-get install postgresql-17-repack  # \u6839\u636e\u5b9e\u9645PostgreSQL\u7248\u672c\u8c03\u6574\n\n# CentOS/RHEL\nsudo yum install pg_repack_17  # \u6839\u636e\u5b9e\u9645PostgreSQL\u7248\u672c\u8c03\u6574\n\n</code></pre>"},{"location":"postgres/tools/pg_repack/#_6","title":"\u4f7f\u7528\u65b9\u6cd5","text":"<pre><code># \u5728\u9700\u8981\u8fdb\u884crepack \u7684database\u4e2d \u521b\u5efa\u62d3\u5c55\ncreate extentions pg_repack\n</code></pre> <pre><code># \u57fa\u672c\u8bed\u6cd5\npg_repack [OPTION]... [DBNAME]\n\n</code></pre> <pre><code># \u5e38\u7528\u9009\u9879\npg_repack -d database_name -t table_name    # \u91cd\u7ec4\u6307\u5b9a\u8868\npg_repack -d database_name -c schema_name   # \u91cd\u7ec4\u6307\u5b9a\u6a21\u5f0f\u4e0b\u7684\u6240\u6709\u8868    ```bash\npg_repack -d database_name -a                  # \u91cd\u7ec4\u6570\u636e\u5e93\u4e2d\u7684\u6240\u6709\u8868\npg_repack -d database_name --tablespace=ts_name # \u5c06\u91cd\u7ec4\u540e\u7684\u8868\u79fb\u52a8\u5230\u6307\u5b9a\u8868\u7a7a\u95f4\n</code></pre>"},{"location":"postgres/tools/pg_repack/#_7","title":"\u5e38\u7528\u53c2\u6570","text":"<pre><code>\n# \u6d4b\u8bd5\uff0c\u4e0d\u5b9e\u9645\u6267\u884c\n-N, --dry-run print what would have been repacked\n\n# \u6253\u5370\u6267\u884c\u8fc7\u7a0b\u7684\u8be6\u7ec6\u4fe1\u606f\n-e, --echo echo queries\n</code></pre>"},{"location":"postgres/tools/pg_repack/#_8","title":"\u62d3\u5c55\u5e94\u7528\u6848\u4f8b","text":""},{"location":"postgres/tools/pg_repack/#_9","title":"\u6570\u636e\u8fc1\u79fb","text":"<p>\u5c06\u8868\u6570\u636e\u4ece\u4e00\u4e2a\u76ee\u5f55\u4e2d\u8fc1\u79fb\u5230\u53e6\u4e00\u4e2a\u5de5\u4f5c\u76ee\u5f55,</p> <p>\u6ce8\u610f\u4e8b\u9879\uff0c\u5982\u679c\u662f\u4e3b\u4ece\u67b6\u6784\u3002\u5404\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u7684\u591a\u4e2a\u76ee\u5f55\u7ed3\u6784\u8981\u4fdd\u6301\u4e00\u81f4\uff0c\u8fd9\u662f\u8868\u7a7a\u95f4\u7684\u8981\u6c42\u3002</p> <pre><code>  -s, --tablespace=TBLSPC            move repacked tables to a new tablespace\n  -S, --moveidx                      move repacked indexes to TBLSPC too\n\n</code></pre>"},{"location":"postgres/tools/pg_repack/#1-2","title":"\u5728 \u4e3b\u5e93\u3001\u5907\u5e93 1\u3001\u5907\u5e93 2 \u4e0a\u5206\u522b\u6267\u884c\uff1a","text":"<p>sudo mkdir -p /data/pgdata/pg_tblspc/new_fast_ssd</p>"},{"location":"postgres/tools/pg_repack/#postgresql-postgres","title":"\u786e\u4fdd\u76ee\u5f55\u5c5e\u4e3b\u4e3a\u8fd0\u884c PostgreSQL \u7684\u7528\u6237\uff08\u901a\u5e38\u662f postgres\uff09","text":"<p>sudo chown postgres:postgres /data/pgdata/pg_tblspc/new_fast_ssd sudo chmod 700 /data/pgdata/pg_tblspc/new_fast_ssd</p>"},{"location":"postgres/tools/pg_repack/#_10","title":"\u53ea\u4fdd\u7559\u90e8\u5206\u6570\u636e","text":"<p>\u539f\u59cb\u65b9\u5f0f\uff0c\u6839\u636e\u9700\u6c42\u5220\u9664\u8868\u4e2d\u975e\u4fdd\u7559\u6570\u636e\u3002 \u7136\u540e\u5229\u7528 pg_repack \u8fdb\u884c\u7a7a\u95f4\u6574\u7406\u3002</p> <p>\u7f3a\u70b9\uff1a \u5220\u9664\u8fc7\u7a0b\u8017\u65f6\u8017\u529b\uff0c\u5bf9\u6570\u636e\u5e93\u7684\u6027\u80fd\u5f71\u54cd\u4e5f\u8f83\u5927\uff0c\u5e76\u4f1a\u4ea7\u751f\u5927\u91cf\u7684 WAL \u65e5\u5fd7\u548c\u9501\u7b49\u5f85\u3002 \u5c24\u5176\u662f\u4fdd\u7559\u6570\u636e\u7684\u5360\u6bd4\u53ea\u662f\u4e00\u5c0f\u90e8\u5206\u7684\u65f6\u5019\uff0c\u9700\u8981\u5220\u9664\u5927\u91cf\u6570\u636e\u3002</p> <p>\u6539\u8fdb\u65b9\u6cd5:</p> <p>\u5206\u6790 pg_repack \u6e90\u4ee3\u7801\u3002 \u4ee3\u7801\u7ed3\u6784\u6709\u4e24\u90e8\u5206 bin \u76ee\u5f55\u4e3a\u5ba2\u6237\u7aef\uff0clib \u76ee\u5f55\u4e0b\u4e3a\u670d\u52a1\u7aef\u4ee3\u7801\u3002</p> <p>\u4e3b\u8981\u662f\u5bf9\u4e8e\u4fee\u6539\u8fd9\u6b65\u7684\u903b\u8f91</p> <ol> <li>create a new table containing all the rows in the old table</li> </ol> <p>\u5bf9\u5e94\u7684\u4ee3\u7801\u4f4d\u7f6e\u4e3a <code>lib/pg_repack.sql.in</code> \u5b89\u88c5\u540e\u5177\u4f53\u4f4d\u7f6e /usr/share/postgresql/17/extension/pg_repack--1.5.2.sql</p> <pre><code>'INSERT INTO repack.table\\_' || R.oid || ' SELECT ' || repack.get_columns_for_create_as(R.oid) || ' FROM ONLY ' || repack.oid2text(R.oid) AS copy_data,\n</code></pre> <p>\u8fd9\u662f\u5c06\u539f\u59cb\u6570\u636e\u5bfc\u5165\u5230\u65b0\u8868\u4e2d\u3002</p> <p>\u4fee\u6539\u5bf9\u4e8e sql \u52a0\u5165 where \u8fc7\u6ee4\u6761\u4ef6 \u5982: \u6839\u636e metric_time \u5b57\u6bb5\u4fdd\u7559 \u65f6\u95f4 2025-10-23 \u4e4b\u540e\u7684\u6570\u636e\u3002</p> <pre><code>'INSERT INTO repack.table_' || R.oid || ' SELECT ' || repack.get_columns_for_create_as(R.oid) || ' FROM  ' || repack.oid2text(R.oid) || format(' WHERE metric_time &gt; %L', '2025-10-23 00:00:00'::timestamp)  AS copy_data,\n\n</code></pre> <p>\u786e\u4fdd\u975e\u4fdd\u7559\u6570\u636e\u4e0d\u5728\u53d8\u52a8\uff0c\u5426\u5219\u6570\u636e\u91cd\u653e\u9636\u6bb5\u53ef\u80fd\u51fa\u95ee\u9898\uff0c\u627e\u4e0d\u5230\u66f4\u65b0\u7684\u6570\u636e\u3002\uff08\u5f85\u9a8c\u8bc1\uff09</p>"},{"location":"postgres/tools/pg_rewind/","title":"pg_rewind \u65f6\u95f4\u7ebf\u5bf9\u9f50","text":"<p>pg_rewind requires that the target server either has the wal_log_hints option enabled in postgresql.conf or data checksums enabled when the cluster was initialized with initdb. Neither of these are currently on by default. full_page_writes must also be set to on, but is enabled by default.</p> <p>wal_log_hints</p>"},{"location":"postgres/tools/pg_rewind/#_1","title":"\u4f7f\u7528\u573a\u666f","text":"<p>\u5728\u6570\u636e\u5e93\u4e3b\u4ece\u7ed3\u6784\u4e2d\uff0c\u4ece\u53d8\u6210\u4e3b\u6613\u3002\u4f46\u662f\u7531\u4e3b\u53d8\u4e3a\u4ece\u5374\u9700\u8981\u4e00\u756a\u5468\u6298\u3002 \u5982\u679c\u662f\u6570\u636e\u91cf\u5c11\u65f6\u91cd\u65b0\u4f7f\u7528pg_backup\u62c9\u4e00\u4efd\u4ece\u5373\u53ef\uff0c\u4f46\u662f\u5982\u679c\u6570\u636e\u91cf\u5927\u65f6\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u975e\u5e38\u7684\u8017\u65f6\u8017\u80fd\u3002\u5bf9\u7ebf\u4e0a\u4e1a\u52a1\u4e5f\u4f1a\u6709\u5f71\u54cd\u3002     \u5728\u5b9e\u9645\u7684\u573a\u666f\u4e2d\u4e3b\u4ece\u4e4b\u95f4\u7684\u6570\u636e\u7edd\u5927\u90e8\u5206\u65f6\u4e00\u81f4\u7684\uff0c\u53ea\u6709\u975e\u5e38\u5c11\u91cf\u7684\u8fd1\u671f\u4ea7\u751f\u7684\u6570\u636e\u662f\u4e0d\u4e00\u81f4\u7684\u3002 \u6709\u6ca1\u6709\u4ec0\u4e48\u65b9\u5f0f\u53ef\u4ee5\u5229\u7528\u5df2\u6709\u7684\u6570\u636e\uff0c\u5145\u5206\u5229\u7528\u5df2\u6709\u7684\u6570\u636e\u5462\uff1f pg_rewind\u767b\u573a \u544a\u522b\u4e00\u4e0b\u56de\u5230\u89e3\u653e\u524d\u3002</p>"},{"location":"postgres/tools/pg_rewind/#_2","title":"\u57fa\u672c\u539f\u7406","text":"<p>\u6570\u636e\u5e93\u6bcf\u6b21\u7684\u4e3b\u4ece\u5207\u6362\u65f6\uff0ctimeLine\u4f1a\u589e\u52a01\u3002 \u65b0\u8001\u6570\u636e\u5e93\u5728\u4e0d\u540c\u7684\u65f6\u95f4\u7ebf\u4e0a\u8fd0\u884c\u3002 \u4f7f\u7528pg_rewind \u5c06\u6570\u636e\u62c9\u56de\u5230\u65f6\u95f4\u7ebf(timeLine)\u4ea7\u751f\u5206\u88c2\u7684\u90a3\u4e2a\u70b9\u4e0a\u3002\u91cd\u65b0\u9009\u62e9\u65f6\u95f4\u7ebf\uff0c\u91cd\u653e\u65b0\u65f6\u95f4\u7ebf\u4e0a\u7684wal\u65e5\u5fd7\uff0c\u4f7f\u4e24\u4e2a\u6570\u636e\u5e93\u91cd\u65b0\u56de\u5230\u4e00\u4e2a\u65f6\u95f4\u7ebf\uff0c\u5e76\u4e14\u6570\u636e\u4e00\u81f4\u3002  </p>"},{"location":"postgres/tools/pg_rewind/#_3","title":"\u5f00\u59cb\u5b9e\u9a8c","text":"<p>\u80cc\u666f: </p> <p>\u4e3b\u4ece\u6570\u636e\u5e93\u7ed3\u6784</p> <p>10.1.88.71 \u4e3b\u5e93 10.1.88.72 \u4ece\u5e93</p> <p>\u76ee\u6807</p> <p>\u6570\u636e\u5e93\u4e3b\u4ece\u5151\u6362\uff0c \u4e3b\u964d\u4e3a\u4ece\u65f6\u4f7f\u7528pg_rewind\u6821\u5bf9\u65f6\u95f4\u7ebf</p>"},{"location":"postgres/tools/pg_rewind/#_4","title":"\u5b9e\u9645\u64cd\u4f5c","text":"<p>\u6ce8\u610f\u4e8b\u9879 : </p> <ul> <li>\u5fc5\u987b\u5f00\u542ffull_page_writes \u9ed8\u8ba4\u5f00\u542f</li> <li>\u5fc5\u987b\u5f00\u542fwal_log_hints \u4fee\u6539\u540e\u9700\u8981\u91cd\u542f \u6216\u8005data block checksum \u6570\u636e\u5e93\u521d\u59cb\u5316\u65f6\u8bbe\u7f6e</li> </ul> <p>\u5982\u679c\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\u6ca1\u6709\u5f00\u542fchecksum ,\u5728version 12 \u53ca\u4ee5\u540e\u7684\u7248\u672c\u4e2d\u53ef\u4ee5\u4f7f\u7528 pg_checksum \u91cd\u65b0\u8bbe\u7f6e  </p> <p>1 \u5c0610.1.88.72\u4ece\u5e93\u53d8\u6210\u4e3b\u5e93</p> <pre><code>#\u4ece\u53d8\u4e3b\ntouch /home/postgres.trigger\n#\u67e5\u770b\u65e5\u5fd7\n2019-03-15 14:15:02.608 CST [7831] LOG:  trigger file found: /home/postgres.trigger\n2019-03-15 14:15:02.608 CST [7831] LOG:  redo done at 0/2000130\n2019-03-15 14:15:02.608 CST [7831] LOG:  selected new timeline ID: 2\n2019-03-15 14:15:02.608 CST [7828] LOG:  database system is ready to accept read only connections\n2019-03-15 14:15:02.686 CST [7831] LOG:  archive recovery complete\n2019-03-15 14:15:02.703 CST [7828] LOG:  database system is ready to accept connections\n#\u6b64\u65f6\u4e24\u4e2a\u6570\u636e\u5e93\u90fd\u53ef\u5199\n</code></pre> <p>2 \u6a21\u62df\u5411\u4e24\u4e2a\u6570\u636e\u5e93\u4e2d\u5199\u6570\u636e</p> <p>3 \u5c06\u6570\u636e\u5e93\u539f\u4e3b\u5e93\uff0810.1.88.71\uff09\u53d8\u4e3a\u4ece\u5e93</p>"},{"location":"postgres/tools/pg_rewind/#_5","title":"\u4e00\u4e0b\u6b65\u9aa4\u5fc5\u987b\u6309\u7167\u987a\u5e8f\u6267\u884c\uff0c\u5e76\u4e14\u4e2d\u95f4\u4e0d\u8981\u64cd\u4f5c\u5931\u8bef\uff01\uff01\uff01","text":"<p>a \u505c\u5e93</p> <pre><code>  systemctl stop postgresql-10\n</code></pre> <p>b \u5207\u6362\u5230postgres\u7528\u6237 \u8fdb\u884c\u65f6\u95f4\u7ebf\u5bf9\u9f50</p> <pre><code># \u5207\u7528\u6237\nsudo su - postgres \n# \u6d4b\u8bd5 -n\n/usr/pgsql-10/bin/pg_rewind -n -D /var/lib/pgsql/10/data/ --source-server=\"hostaddr=10.1.88.72 user=postgres port=5432\"\n# \u6b63\u5f0f\u6267\u884c\n/usr/pgsql-10/bin/pg_rewind -D /var/lib/pgsql/10/data/ --source-server=\"hostaddr=10.1.88.72 user=postgres port=5432\" -P\n</code></pre> <p>c \u4fee\u6539 recovery.conf</p> <pre><code>mv recovery.done recovery.conf\n</code></pre> <p>vi recovery.conf</p> <pre><code>recovery_target_timeline='latest'\nstandby_mode = 'on'\nprimary_conninfo = 'user=postgres passfile=''/root/.pgpass'' host=10.1.88.72 port=5432 sslmode=prefer sslcompression=1 krbsrvname=postgres target_session_attrs=any'\n</code></pre>"},{"location":"postgres/tools/pg_rewind/#_6","title":"\u6ce8\u610f\u4e8b\u9879:","text":"<p>host \u6307\u5411\u65b0\u4e3b\u5e93\u5730\u5740</p> <p>\u4ee5\u4e0a\u8fc7\u7a0b\u4e2d\u4fdd\u6301\u6570\u636e\u5e93\u662f\u5173\u95ed\u72b6\u6001!!!! \uff0c \u5982\u679c\u51fa\u73b0\u6570\u636e\u5e93\u4ee5\u4e3b\u5e93\u7684\u5f62\u5f0f\u8fd0\u884c\u7684\u60c5\u51b5\uff0cpg_stat_replication \u4e2d\u7684 flush_lsn , replay_lsn \u4e0d\u5728\u66f4\u65b0\u3002\u53ca\u4e3b\u4ece\u6570\u636e\u4e0d\u66f4\u65b0\u3002 \u53ea\u80fd\u91cd\u65b0\u62c9\u53d6\u3002 </p> <p>pg_rewind \u4f1a\u5c06 recovery.conf \u4f1a\u88ab recovery.done\u3002\u590d\u5236\u8fc7\u7a0b\u4f1a\uff0c\u5982\u679c\u4e3b\u5e93\u6709\u7684recovery.done\u6587\u4ef6\uff0c\u5219\u4f1a\u590d\u5236\u5230\u5907\u5e93\u5e76\u8986\u76d6\u6587\u4ef6\u3002\u6b64\u65f6\u91cd\u65b0\u4fee\u6539recovery.done\u5e76\u91cd\u547d\u540d\u4e3arecovery.conf</p> <p>\u8c28\u8bb0\uff0c\u5728\u542f\u52a8\u6570\u636e\u524d\u4ed4\u7ec6\u68c0\u6d4b recovery.conf \u6587\u4ef6\u3002\u786e\u4fdd\u6570\u636e\u5e93\u4ee5\u4ece\u5e93\u5f62\u5f0f\u8fd0\u884c\u3002</p> <p>4 \u542f\u52a8\u6570\u636e\u5e93\uff0c\u5e76\u9a8c\u8bc1</p>"},{"location":"postgres/tools/pg_rewind/#_7","title":"\u5907\u6ce8","text":"<p>\u4ee5\u524d\u64cd\u4f5c\u65f6\uff0c\u4e3b\u4ece\u5207\u6362\u540e\uff0c\u4e3b\u4ece\u72b6\u6001\u662f\u5bf9\u7684\uff0c\u4f46\u662f\u5411\u4e3b\u5e93\u5199\u6570\u636e\uff0c\u4ece\u5e93\u6ca1\u6709\u540c\u6b65\u3002\uff08\u539f\u56e0\u4e0d\u8be6\uff09   \u4eca\u5929\u6309\u7167\u4e0a\u9762\u7684\u64cd\u4f5c\uff0c\u6d4b\u8bd5\u7684\u591a\u6b21\u90fd\u6210\u529f\u4e86\uff01\uff01\uff01</p>"},{"location":"postgres/tools/pg_rewind/#_8","title":"\u6269\u5c55","text":"<p>\u67e5\u770b\u6570\u636e\u5e93timeline \u7b49\u4fe1\u606f</p> <pre><code># \u5728\u6570\u636e\u6240\u5728\u4f4d\u7f6e\u6267\u884c\n/usr/pgsql-10/bin/pg_controldata .\n</code></pre>"},{"location":"postgres/tools/pg_rewind/#_9","title":"\u66f4\u591a","text":"<p>https://github.com/digoal/blog/blob/master/201901/20190128_02.md</p>"},{"location":"postgres/tools/pg_rewind/#_10","title":"\u5e94\u7528","text":"<p>\u5178\u578b\u5e94\u7528\u573a\u666f\uff0c\u5728\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u540e\uff0c\u539f\u4e3b\u5e93\u91cd\u65b0\u52a0\u5165\u96c6\u7fa4\u4e2d\u3002</p>"},{"location":"postgres/tools/pg_rewind/#_11","title":"\u539f\u7406","text":"<p>\u57fa\u672c\u601d\u60f3\u662f\u5c06\u6240\u6709\u6587\u4ef6\u7cfb\u7edf\u7ea7\u7684\u53d8\u5316\u4ece\u6e90\u96c6\u7fa4\u590d\u5236\u5230\u76ee\u6807\u96c6\u7fa4\u3002</p> <p>1 \u8fde\u63a5\u5230\u6e90\u7aef\u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u5bf9\u6bd4\u627e\u5230\u672c\u5730\u6570\u636e\u5e93\u5206\u53c9\u70b9\u4e4b\u524d\u6700\u540e\u4e00\u6b21checkpoint\u7684\u5728wal\u65e5\u5fd7\u4e2d\u4f4d\u7f6e\uff0c\u89e3\u6790\u5206\u53c9\u70b9\u540e\u7684WAL\uff0c\u8bb0\u5f55\u8fd9\u4e9b\u4e8b\u52a1\u4fee\u6539\u4e86\u54ea\u4e9b\u6570\u636e\u5757</p> <p>2 \u5bf9\u4e8e\u6570\u636e\u6587\u4ef6\uff0c\u53ea\u4ece\u65b0\u4e3b\u62c9\u53d6\u88ab\u65e7\u4e3b\u4fee\u6539\u4e86\u7684\u6570\u636e\u5757\uff0c\u5e76\u8986\u76d6\u65e7\u4e3b\u6570\u636e\u6587\u4ef6\u4e2d\u5bf9\u5e94\u7684\u6570\u636e\u5757</p> <p>3 \u62f7\u8d1dWAL segments, <code>pg_xact</code>,  \u53ca\u914d\u7f6e\u6587\u4ef6\uff0c \u5ffd\u7565 <code>pg_dynshmem/</code>, <code>pg_notify/</code>, <code>pg_replslot/</code>, <code>pg_serial/</code>, <code>pg_snapshots/</code>, <code>pg_stat_tmp/</code>, and <code>pg_subtrans/</code> </p> <p>4 \u628a\u65e7\u4e3b\u6539\u6210\u6062\u590d\u6a21\u5f0f\uff0c\u6062\u590d\u7684\u8d77\u70b9\u5219\u8bbe\u7f6e\u4e3a\u5206\u53c9\u70b9\u524d\u7684\u6700\u8fd1\u4e00\u6b21checkpoint</p> <p>5 \u5f53\u542f\u52a8\u65e7\u4e3b\u5e93\u540e\uff0c\u81ea\u52a8\u91cd\u653ewal\u65e5\u5fd7\u5373\u53ef\u5b8c\u6210\u6570\u636e\u7684\u540c\u6b65</p> <p>\u53c2\u52a0\u5b98\u65b9\u6587\u6863 https://www.postgresql.org/docs/14/app-pgrewind.html</p>"},{"location":"postgres/tools/pg_rewind/#rewind","title":"\u521b\u5efarewind \u7528\u6237","text":"<pre><code>CREATE USER {{ REWIND_USER }} ENCRYPTED PASSWORD '{{ REWIND_PASSWORD }}';\nGRANT EXECUTE ON function pg_catalog.pg_ls_dir(text, boolean, boolean) TO {{ REWIND_USER }};\nGRANT EXECUTE ON function pg_catalog.pg_stat_file(text, boolean) TO {{ REWIND_USER }};\nGRANT EXECUTE ON function pg_catalog.pg_read_binary_file(text) TO {{ REWIND_USER }};\nGRANT EXECUTE ON function pg_catalog.pg_read_binary_file(text, bigint, bigint, boolean) TO {{ REWIND_USER }};\n</code></pre>"},{"location":"postgres/tools/pg_rewrite/","title":"pg_rewrite","text":"","tags":[]},{"location":"postgres/tools/pg_rewrite/#_1","title":"\u5728\u7ebf\u5206\u533a\u8868","text":"<p>https://github.com/cybertec-postgresql/pg_rewrite</p>","tags":[]},{"location":"postgres/tools/pg_rewrite/#_2","title":"\u4f7f\u7528\u6d4b\u8bd5","text":"<p>PostgreSQL server version 13 or later is required.</p>","tags":[]},{"location":"postgres/tools/pg_stat_kcache/","title":"pg_stat_kcache","text":"<p><code>pg_stat_kcache</code> is an extension for PostgreSQL that provides statistics about the kernel's cache usage by PostgreSQL queries. It helps in monitoring and optimizing the performance of your PostgreSQL database by giving insights into the cache hit ratio and other related metrics.</p>"},{"location":"postgres/tools/pg_stat_kcache/#installation","title":"Installation","text":"<p>To install the <code>pg_stat_kcache</code> extension, follow these steps:</p> <ol> <li> <p>Connect to your PostgreSQL database:     <code>sh     psql -U your_username -d your_database</code></p> </li> <li> <p>Install the extension:     <code>sql     CREATE EXTENSION pg_stat_kcache;</code></p> </li> </ol>"},{"location":"postgres/tools/pg_stat_kcache/#usage","title":"Usage","text":"<p>Once installed, you can query the <code>pg_stat_kcache</code> view to get statistics about cache usage. Here is an example query:</p> <pre><code>SELECT * FROM pg_stat_kcache;\n</code></pre>"},{"location":"postgres/tools/pg_stat_kcache/#example-query","title":"Example Query","text":"<p>To get detailed statistics for a specific query, you can use the following example:</p> <pre><code>SELECT\n    query,\n    calls,\n    total_time,\n    read_time,\n    write_time,\n    user_time,\n    system_time\nFROM\n    pg_stat_kcache\nJOIN\n    pg_stat_statements\nON\n    pg_stat_kcache.queryid = pg_stat_statements.queryid\nORDER BY\n    total_time DESC\nLIMIT 10;\n</code></pre> <p>This query will return the top 10 queries by total execution time, along with their cache usage statistics.</p>"},{"location":"postgres/tools/pg_stat_kcache/#references","title":"References","text":"<p>For more information, refer to the official documentation: - pg_stat_kcache GitHub Repository - PostgreSQL Documentation</p>"},{"location":"postgres/tools/pg_stat_statements/","title":"pg_stat_statements \u6570\u636e\u5e93\u7edf\u8ba1\u4fe1\u606f","text":"","tags":[]},{"location":"postgres/tools/pg_stat_statements/#pg_stat_statements","title":"pg_stat_statements \u6269\u5c55","text":"","tags":[]},{"location":"postgres/tools/pg_stat_statements/#_1","title":"\u5b89\u88c5","text":"<pre><code>yum install postgresql10-contrib.x86_64\n\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_stat_statements/#_2","title":"\u4fee\u6539\u914d\u7f6e\u53c2\u6570","text":"<pre><code>vi $PGDATA/postgresql.conf  \n\nshared_preload_libraries='pg_stat_statements'  # \u52a0\u8f7d\u6a21\u5757\u3000\u9700\u8981\u91cd\u542f , \u8fd1\u671f\u6d4b\u8bd5\u4e0d\u9700\u8981\u6dfb\u52a0\u4e5f\u53ef\u4ee5\u3002\u81ea\u5e26\u6269\u5c55\n\ntrack_io_timing = on  # \u8ddf\u8e2aIO\u8017\u65f6 (\u53ef\u9009)\n\ntrack_activity_query_size = 2048 # \u8bbe\u7f6e\u5355\u6761SQL\u7684\u6700\u957f\u957f\u5ea6\uff0c\u8d85\u8fc7\u88ab\u622a\u65ad\u663e\u793a\uff08\u53ef\u9009)\n\npg_stat_statements.max = 10000  #\u5728pg_stat_statements\u4e2d\u6700\u591a\u4fdd\u7559\u591a\u5c11\u6761\u7edf\u8ba1\u4fe1\u606f\uff0c\u901a\u8fc7LRU\u7b97\u6cd5\uff0c\u8986\u76d6\u8001\u7684\u8bb0\u5f55\u3002\n\npg_stat_statements.track = all  # all - (\u6240\u6709SQL\u5305\u62ec\u51fd\u6570\u5185\u5d4c\u5957\u7684SQL), top - \u76f4\u63a5\u6267\u884c\u7684SQL(\u51fd\u6570\u5185\u7684sql\u4e0d\u88ab\u8ddf\u8e2a), none - (\u4e0d\u8ddf\u8e2a)\n\npg_stat_statements.track_utility = off  #\u662f\u5426\u8ddf\u8e2a\u975eDML\u8bed\u53e5 (\u4f8b\u5982DDL\uff0cDCL)\uff0con\u8868\u793a\u8ddf\u8e2a, off\u8868\u793a\u4e0d\u8ddf\u8e2a \n\npg_stat_statements.save = on #\u91cd\u542f\u540e\u662f\u5426\u4fdd\u7559\u7edf\u8ba1\u4fe1\u606f  \n\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_stat_statements/#_3","title":"\u91cd\u542f\u6570\u636e\u5e93","text":"<pre><code>systemctl restart postgresql-10\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_stat_statements/#_4","title":"\u521b\u5efa\u6269\u5c55","text":"<pre><code>create extension pg_stat_statements;\n\n\\d pg_stat_statements\n                    View \"public.pg_stat_statements\"\n       Column        |       Type       | Collation | Nullable | Description \n---------------------+------------------+-----------+----------+---------\n userid              | oid              |           |          | \u6267\u884c\u8be5\u8bed\u53e5\u7684\u7528\u6237\u7684 OID\n dbid                | oid              |           |          | \u5728\u5176\u4e2d\u6267\u884c\u8be5\u8bed\u53e5\u7684\u6570\u636e\u5e93\u7684 OID\n queryid             | bigint           |           |          | \u5185\u90e8\u54c8\u5e0c\u7801\uff0c\u4ece\u8bed\u53e5\u7684\u89e3\u6790\u6811\u8ba1\u7b97\u5f97\u6765 \n query               | text             |           |          | \u8bed\u53e5\u7684\u6587\u672c\u5f62\u5f0f \n calls               | bigint           |           |          | \u88ab\u6267\u884c\u7684\u6b21\u6570 \n total_time          | double precision |           |          | \u5728\u8be5\u8bed\u53e5\u4e2d\u82b1\u8d39\u7684\u603b\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u8ba1 \n min_time            | double precision |           |          | \u5728\u8be5\u8bed\u53e5\u4e2d\u82b1\u8d39\u7684\u6700\u5c0f\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u8ba1 \n max_time            | double precision |           |          | \u5728\u8be5\u8bed\u53e5\u4e2d\u82b1\u8d39\u7684\u6700\u5927\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u8ba1\n mean_time           | double precision |           |          | \u5728\u8be5\u8bed\u53e5\u4e2d\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u8ba1 \n stddev_time         | double precision |           |          | \u5728\u8be5\u8bed\u53e5\u4e2d\u82b1\u8d39\u65f6\u95f4\u7684\u603b\u4f53\u6807\u51c6\u504f\u5dee\uff0c\u4ee5\u6beb\u79d2\u8ba1 \n rows                | bigint           |           |          | \u8be5\u8bed\u53e5\u68c0\u7d22\u6216\u5f71\u54cd\u7684\u884c\u603b\u6570 \n shared_blks_hit     | bigint           |           |          | \u8be5\u8bed\u53e5\u9020\u6210\u7684\u5171\u4eab\u5757\u7f13\u51b2\u547d\u4e2d\u603b\u6570 \n shared_blks_read    | bigint           |           |          | \u8be5\u8bed\u53e5\u8bfb\u53d6\u7684\u5171\u4eab\u5757\u7684\u603b\u6570 \n shared_blks_dirtied | bigint           |           |          | \u8be5\u8bed\u53e5\u5f04\u810f\u7684\u5171\u4eab\u5757\u7684\u603b\u6570 \n shared_blks_written | bigint           |           |          | \n local_blks_hit      | bigint           |           |          | \n local_blks_read     | bigint           |           |          | \u8be5\u8bed\u53e5\u8bfb\u53d6\u7684\u672c\u5730\u5757\u7684\u603b\u6570 \n local_blks_dirtied  | bigint           |           |          | \u8be5\u8bed\u53e5\u5f04\u810f\u7684\u672c\u5730\u5757\u7684\u603b\u6570 \n local_blks_written  | bigint           |           |          | \u8be5\u8bed\u53e5\u5199\u5165\u7684\u672c\u5730\u5757\u7684\u603b\u6570 \n temp_blks_read      | bigint           |           |          | \n temp_blks_written   | bigint           |           |          | \n blk_read_time       | double precision |           |          | \u8be5\u8bed\u53e5\u82b1\u5728\u8bfb\u53d6\u5757\u4e0a\u7684\u603b\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u8ba1\uff08\u5982\u679ctrack_io_timing\u88ab\u542f\u7528\uff0c\u5426\u5219\u4e3a\u96f6) \n blk_write_time      | double precision |           |          | \u8be5\u8bed\u53e5\u82b1\u5728\u5199\u5165\u5757\u4e0a\u7684\u603b\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u8ba1\uff08\u5982\u679ctrack_io_timing\u88ab\u542f\u7528\uff0c\u5426\u5219\u4e3a\u96f6) \n\n</code></pre> <p>\u5728\u6570\u636e\u5e93\u4e2d\u751f\u6210\u4e86\u4e00\u4e2a\u540d\u4e3a pg_stat_statements \u7684\u89c6\u56fe,\u5bf9\u6570\u636e\u5e93\u7684\u8ddf\u8e2a\u4e5f\u662f\u57fa\u4e8e\u8fd9\u4e2a\u89c6\u56fe\u5c55\u5f00\u3002</p>","tags":[]},{"location":"postgres/tools/pg_stat_statements/#top-sql","title":"\u5206\u6790TOP SQL","text":"<p>\u6700\u8017IO SQL</p> <p>\u5355\u6b21\u8c03\u7528\u6700\u8017IO SQL TOP 5</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by (blk_read_time+blk_write_time)/calls desc limit 5;  \n</code></pre> <p>\u603b\u6700\u8017IO SQL TOP 5</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by (blk_read_time+blk_write_time) desc limit 5;  \n</code></pre> <p>\u6700\u8017\u65f6 SQL</p> <p>\u5355\u6b21\u8c03\u7528\u6700\u8017\u65f6 SQL TOP 5</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by mean_time desc limit 5;  \n</code></pre> <p>\u603b\u6700\u8017\u65f6 SQL TOP 5</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by total_time desc limit 5;  \n</code></pre> <p>\u54cd\u5e94\u65f6\u95f4\u6296\u52a8\u6700\u4e25\u91cd SQL</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by stddev_time desc limit 5;  \n</code></pre> <p>\u6700\u8017\u5171\u4eab\u5185\u5b58 SQL</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by (shared_blks_hit+shared_blks_dirtied) desc limit 5;  \n</code></pre> <p>\u6700\u8017\u4e34\u65f6\u7a7a\u95f4 SQL</p> <pre><code>select userid::regrole, dbid, query from pg_stat_statements order by temp_blks_written desc limit 5;  \n</code></pre> <p>\u6700\u8bbf\u95ee\u9891\u7e41 SQL </p> <pre><code>select userid::regrole, dbid, query ,calls from pg_stat_statements order by calls desc limit 5;\n</code></pre>","tags":[]},{"location":"postgres/tools/pg_stat_statements/#_5","title":"\u91cd\u7f6e\u7edf\u8ba1\u4fe1\u606f","text":"<p>pg_stat_statements\u662f\u7d2f\u79ef\u7684\u7edf\u8ba1\uff0c\u5982\u679c\u8981\u67e5\u770b\u67d0\u4e2a\u65f6\u95f4\u6bb5\u7684\u7edf\u8ba1\uff0c\u9700\u8981\u6253\u5feb\u7167</p> <pre><code>\u5efa\u5feb\u7167\u8868\ncreate table stat_pg_stat_statements as select log_time ,* from pg_stat_statements where 1=2;\n\u63d2\u5165\u6570\u636e\ninsert into stat_pg_stat_statements select now() ,* from pg_stat_statements;\n</code></pre> <p>\u7528\u6237\u4e5f\u53ef\u4ee5\u5b9a\u671f\u6e05\u7406\u5386\u53f2\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u901a\u8fc7\u8c03\u7528\u5982\u4e0bSQL</p> <pre><code>select pg_stat_statements_reset();  \n</code></pre>","tags":[]},{"location":"postgres/tools/pg_stat_statements/#_6","title":"pg_stat_statements \u6570\u636e\u5e93\u7edf\u8ba1\u4fe1\u606f","text":"<p>https://github.com/cybertec-postgresql/pgwatch2</p> <p>https://github.com/wrouesnel/postgres_exporter</p>","tags":[]},{"location":"postgres/tools/pgage/","title":"\u6570\u636e\u5e93\u5e74\u9f84","text":""},{"location":"postgres/tools/pgage/#_1","title":"\u80cc\u666f","text":"<p>\u6570\u636e\u5e93\u7684\u4e8b\u52a1\u6807\u8bc6\u7b26\u4f7f\u7528\u7684\u662f32\u4f4d\u7684,\u6700\u5927\u53ef\u8868\u793a42\u4e2a\u4ebf\u3002\u5f53\u524d\u4e8b\u52a1\u7684\u6570\u636e\u572820\u4ebf\u4e2a\u4e8b\u52a1\u4e4b\u540e\u5c06\u53d8\u7684\u4e0d\u53ef\u89c1\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff08\u56de\u5377\uff09\uff0cPostgres\u5f15\u5165\u4e86\u4e00\u4e2a\u51bb\u7ed3\u4e8b\u52a1\u6807\u8bc6\u7684\u6982\u5ff5\u3002 \u5e76\u5b9e\u73b0\u4e86\u540d\u4e3afreeze\u7684\u51bb\u7ed3\u8fc7\u7a0b\u3002</p>"},{"location":"postgres/tools/pgage/#_2","title":"\u51bb\u7ed3\u8fc7\u7a0b","text":"<p>\u4e24\u79cd\u6a21\u5f0f</p> <ul> <li> <p>\u60f0\u6027\u6a21\u5f0f</p> </li> <li> <p>\u8feb\u5207\u6a21\u5f0f</p> </li> </ul> <p>\u60f0\u6027\u6a21\u5f0f\u56de\u8df3\u8fc7\u9875\u4e2d\u6240\u6709\u7684\u6570\u636e\u90fd\u4f4d\u53ef\u89c1\u7684\u6570\u636e\u5e93\u5757\uff08\u7531\u6570\u636e\u5e93\u4e2d\u7684vm\u53ef\u89c1\u6027\u6620\u5c04\uff09</p> <p>\u8feb\u5207\u6a21\u5f0f\u4f1a\u626b\u63cf\u6240\u6709\u7684\u9875\uff0c\u68c0\u67e5\u8868\u4e2d\u7684\u6240\u6709\u5143\u7ec4\u3002\u5e76\u53ef\u80fd\u5220\u9664\u4e0d\u5fc5\u8981\u7684clog\u6587\u4ef6\u4e0e\u9875\u9762\u3002</p> <p>\u6539\u8fdb\u7684\u8feb\u5207\u6a21\u5f0f\uff0c\u4f1a\u8df3\u8fc7\u9875\u9762\u4e2d\u6240\u6709\u7684\u5143\u7ec4\u90fd\u5df2\u88ab\u51bb\u7ed3\u8fc7\u7684\u9875\u9762</p> <p>\u9996\u5148\u4ecb\u7ecd\u51e0\u4e2a\u6570\u636e\u5e93\u503c</p> <pre><code> -- \u5f53\u524d\u4e8b\u52a1\u53f7\n select txid_current();\n\n -- \u8bb0\u5f55\u4e8b\u52a1\u53f7\n select xmax,xmin ,* from table_name where xxxx;\n\n -- \u8868\u5e74\u9f84\uff0c \u8868\u4e2d\u6700\u8001\u884c\u7684\u4e8b\u52a1\u53f7\n select age(relfrozenxid) from pg_class where relname = table_name;\n\n -- database \u5e74\u9f84\n select datname , age(datfrozenxid) from pg_database ;\n\n -- \u6570\u636e\u914d\u7f6e\n show vacuum_freeze_min_age ; -- \u9ed8\u8ba4\u503c5\u5343\u4e07\n\n show vacuum_freeze_table_age ; -- \u9ed8\u8ba4\u503c1.5\u4ebf\n\n show autovacuum_freeze_max_age ; -- \u9ed8\u8ba4\u503c2\u4ebf\n\n show autovacuum_naptime ; -- \u9ed8\u8ba4\u503c1 \u5206\u949f\n</code></pre>"},{"location":"postgres/tools/pgage/#_3","title":"\u89e6\u53d1\u6761\u4ef6","text":"<p>\u5f53\u524d\u5e74\u9f84\u5927\u4e8e5\u5343\u4e07\u65f6 \u60f0\u6027\u6a21\u5f0f \u5f53\u524d\u5e93\u5e74\u9f84\u5927\u4e8e1.5\u4ebf\u65f6 \u8feb\u5207\u6a21\u5f0f</p> <p>\u51bb\u7ed3\u540e\u4fee\u6539\u8868\u548c\u5e93\u7684 relfrozenxid\uff0cdatfrozenxid \u503c\u3002</p>"},{"location":"postgres/tools/pgage/#_4","title":"\u624b\u52a8\u51bb\u7ed3","text":"<pre><code> vacuum freeze \n</code></pre> <p>\u7531\u4e8e\u51bb\u7ed3\u7684\u8fc7\u7a0b\u4f1a\u5360\u7528\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u8d44\u6e90\u3002\u53ef\u6839\u636e\u5f53\u524d\u6570\u636e\u7684\u5e74\u9f84\u5728\u4e1a\u52a1\u4f4e\u5cf0\u671f\u8fdb\u884c\u624b\u52a8\u51bb\u7ed3\uff0c\u964d\u4f4e\u5bf9\u4e1a\u52a1\u7684\u5f71\u54cd\u3002</p>"},{"location":"postgres/tools/pgbench/","title":"pgbench \u538b\u529b\u6d4b\u8bd5","text":""},{"location":"postgres/tools/pgbench/#_1","title":"\u4ecb\u7ecd","text":"<p>pgbench\u662f\u4e00\u79cd\u5728PostgreSQL\u4e0a\u8fd0\u884c\u57fa\u51c6\u6d4b\u8bd5\u7684\u7b80\u5355\u7a0b\u5e8f\u3002 \u5b98\u65b9\u6587\u6863 </p> <ul> <li>\u9ed8\u8ba4\u6d4b\u8bd5</li> <li>\u81ea\u5b9a\u4e49\u6d4b\u8bd5</li> </ul>"},{"location":"postgres/tools/pgbench/#_2","title":"\u9ed8\u8ba4\u6d4b\u8bd5","text":"<p>pgbench\u4e2d\u9ed8\u8ba4\u81ea\u5e26\u4e00\u5957\u6d4b\u8bd5\u6570\u636e\u5e93\u548c\u6d4b\u8bd5sql\u811a\u672c\u3002</p>"},{"location":"postgres/tools/pgbench/#_3","title":"\u521d\u59cb\u5316\u9ed8\u8ba4\u6570\u636e\u5e93","text":"<pre><code>\u4f7f\u7528 -i \u521d\u59cb\u5316\u6570\u636e\u5e93\n\n#pgbench -U postgres -i -s 10 pgbenchdb\nNOTICE:  table \"pgbench_history\" does not exist, skipping\nNOTICE:  table \"pgbench_tellers\" does not exist, skipping\nNOTICE:  table \"pgbench_accounts\" does not exist, skipping\nNOTICE:  table \"pgbench_branches\" does not exist, skipping\ncreating tables...\n100000 of 1000000 tuples (10%) done (elapsed 0.14 s, remaining 1.23 s)\n200000 of 1000000 tuples (20%) done (elapsed 0.27 s, remaining 1.06 s)\n300000 of 1000000 tuples (30%) done (elapsed 0.42 s, remaining 0.99 s)\n400000 of 1000000 tuples (40%) done (elapsed 0.51 s, remaining 0.77 s)\n500000 of 1000000 tuples (50%) done (elapsed 0.72 s, remaining 0.72 s)\n600000 of 1000000 tuples (60%) done (elapsed 0.87 s, remaining 0.58 s)\n700000 of 1000000 tuples (70%) done (elapsed 0.97 s, remaining 0.42 s)\n800000 of 1000000 tuples (80%) done (elapsed 1.15 s, remaining 0.29 s)\n900000 of 1000000 tuples (90%) done (elapsed 1.30 s, remaining 0.14 s)\n1000000 of 1000000 tuples (100%) done (elapsed 1.46 s, remaining 0.00 s)\nset primary keys...\ndone.\n\n\u53c2\u6570\u8bf4\u660e\uff1a\n-i --initialize \u8868\u793a\u521d\u59cb\u5316\u6570\u636e,\u6ce8\u610f\u539f\u6765\u7684\u6570\u636e\u5982\u679c\u5b58\u5728\u5c06\u88ab\u8986\u76d6\u3002\n-s scale_factor \u89c4\u6a21\u56e0\u5b50 \u6570\u636e\u91cf\u89c4\u6a21\n\n\u67e5\u770b\u521d\u59cb\u5316\u540e\u7684\u6570\u636e\u5e93\n\npsql -U postgres -d pgbenchdb\npgbenchdb=# \\d+\n                               \u5173\u8054\u5217\u8868\n \u67b6\u6784\u6a21\u5f0f |        \u540d\u79f0        |  \u7c7b\u578b  |  \u62e5\u6709\u8005  |    \u5927\u5c0f    | \u63cf\u8ff0 \n----------+--------------------+--------+----------+------------+------\n public   | pg_stat_statements | \u89c6\u56fe   | postgres | 0 bytes    | \n public   | pgbench_accounts   | \u6570\u636e\u8868 | postgres | 128 MB     | \n public   | pgbench_branches   | \u6570\u636e\u8868 | postgres | 8192 bytes | \n public   | pgbench_history    | \u6570\u636e\u8868 | postgres | 0 bytes    | \n public   | pgbench_tellers    | \u6570\u636e\u8868 | postgres | 8192 bytes | \n(5 \u884c\u8bb0\u5f55)\n\n</code></pre>"},{"location":"postgres/tools/pgbench/#_4","title":"\u5f00\u59cb\u6d4b\u8bd5","text":"<pre><code>pgbench -M prepared -r -n -c 100 -j 100 -T 100 -U postgres   pgbenchdb \ntransaction type: &lt;builtin: TPC-B (sort of)&gt;\nscaling factor: 10\nquery mode: prepared\nnumber of clients: 100\nnumber of threads: 100\nduration: 100 s\nnumber of transactions actually processed: 375474\nlatency average = 26.667 ms\ntps = 3749.964314 (including connections establishing)\ntps = 3754.003534 (excluding connections establishing)\nscript statistics:\n - statement latencies in milliseconds:\n         0.002  \\set aid random(1, 100000 * :scale)\n         0.000  \\set bid random(1, 1 * :scale)\n         0.000  \\set tid random(1, 10 * :scale)\n         0.000  \\set delta random(-5000, 5000)\n         0.252  BEGIN;\n         0.299  UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;\n         0.199  SELECT abalance FROM pgbench_accounts WHERE aid = :aid;\n        13.609  UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;\n         9.879  UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;\n         0.252  INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);\n         2.100  END;\n\n\u53c2\u6570\u8bf4\u660e\uff1a\n-M \u6a21\u5f0f simple extended prepared\n-r \u6bcf\u4e00\u4e2a\u8bed\u53e5\u82b1\u8d39\u7684\u4e8b\u52a1\u65f6\u95f4\n-n \u8fd0\u884c\u524d\u4e0d\u6267\u884cvaccumun ,\u81ea\u5b9a\u4e49\u7684\u811a\u672c\u8fd0\u884c\u4e2d\u5fc5\u987b\u8981\u4f7f\u7528\n-c \u5ba2\u6237\u7aef\u6570\u91cf\n-j \u7ebf\u7a0b\u6570\u91cf \u5ba2\u6237\u7aef\u5171\u7528\u6240\u6709\u7684\u7ebf\u7a0b -j &lt;= -c \n-T \u8fd0\u884c\u7684\u65f6\u95f4 \u5355\u4f4d\u79d2 \u3002 \u65f6\u95f4\u592a\u77ed\u4f1a\u5bfc\u81f4\u7ed3\u679c\u4e0d\u662f\u5f88\u51c6\u786e\uff0c\u81f3\u5c11\u8981\u8fd0\u884c\u51e0\u5206\u949f\uff0c\u6d88\u9664\u566a\u58f0\u5bf9\u7ed3\u679c\u7684\u5f71\u54cd\u3002\n-t \u8fd0\u884c\u7684\u4e8b\u52a1\u6570 \u6bcf\u4e2a\u5ba2\u6237\u7aef\n</code></pre>"},{"location":"postgres/tools/pgbench/#_5","title":"\u7ed3\u679c\u89e3\u8bfb","text":"<p>\u7565 \uff0c\u4e00\u770b\u5c31\u61c2</p>"},{"location":"postgres/tools/pgbench/#_6","title":"\u81ea\u5b9a\u4e49\u6d4b\u8bd5","text":"<p>\u793a\u4f8b\u8bf4\u660e</p> <pre><code>pgbench -M prepared -n -r -c 32 -j 32 -P 5 -C -f ./test.sql -U postgres pgbenchdb -T 300\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879: pgbench\u4e0epg\u4e0d\u8981\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a</p> <p>\u5404\u79cd\u573a\u666f\u538b\u529b\u6d4b\u8bd5 https://github.com/digoal/blog/blob/362b84417ca8b7aaf1add31fe7689c347642bb9a/201706/20170601_02.md</p>"},{"location":"postgres/tools/pgbench/#_7","title":"\u9047\u89c1\u95ee\u9898","text":"<p>\u6d4b\u8bd5 -C \u53c2\u6570\u65f6 \u4f7f\u7528\u7684pgbouncer\u4f5c\u4e3a\u8fde\u63a5\u6c60\u51fa\u73b0\u5982\u4e0b\u9519\u8bef</p> <pre><code>Cannot assign requested address\n</code></pre> <p>\u539f\u56e0\u5ba2\u6237\u7aef\u9891\u7e41\u7684\u8fde\u670d\u52a1\u5668\uff0c\u7531\u4e8e\u6bcf\u6b21\u8fde\u63a5\u90fd\u5728\u5f88\u77ed\u7684\u65f6\u95f4\u5185\u7ed3\u675f\uff0c\u5bfc\u81f4\u5f88\u591a\u7684TIME_WAIT\uff0c\u4ee5\u81f3\u4e8e\u7528\u5149\u4e86\u53ef\u7528\u7684\u7aef\u53e3\u53f7\uff0c\u6240\u4ee5\u65b0\u7684\u8fde\u63a5\u6ca1\u529e\u6cd5\u7ed1\u5b9a\u7aef\u53e3\uff0c\u5373\u201cCannot assign requested address\u201d\u3002 \u662f\u5ba2\u6237\u7aef\u7684\u95ee\u9898\u4e0d\u662f\u670d\u52a1\u5668\u7aef\u7684\u95ee\u9898\u3002\u901a\u8fc7netstat\uff0c\u7684\u786e\u770b\u5230\u5f88\u591aTIME_WAIT\u72b6\u6001\u7684\u8fde\u63a5\u3002 </p> <p>client\u7aef\u9891\u7e41\u5efa\u7acb\u8fde\u63a5\uff0c\u800c\u7aef\u53e3\u91ca\u653e\u8f83\u6162\uff0c\u5bfc\u81f4\u5efa\u7acb\u65b0\u8fde\u63a5\u65f6\u65e0\u53ef\u7528\u7aef\u53e3\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <p>\u6267\u884c\u547d\u4ee4\u4fee\u6539\u5982\u4e0b2\u4e2a\u5185\u6838\u53c2\u6570 \uff08\u9700\u8981root\u6743\u9650\uff09 sysctl -w net.ipv4.tcp_timestamps=1  \u5f00\u542f\u5bf9\u4e8eTCP\u65f6\u95f4\u6233\u7684\u652f\u6301,\u82e5\u8be5\u9879\u8bbe\u7f6e\u4e3a0\uff0c\u5219\u4e0b\u9762\u4e00\u9879\u8bbe\u7f6e\u4e0d\u8d77\u4f5c\u7528  sysctl -w net.ipv4.tcp_tw_recycle=1  \u8868\u793a\u5f00\u542fTCP\u8fde\u63a5\u4e2dTIME-WAIT sockets\u7684\u5feb\u901f\u56de\u6536   </p>"},{"location":"postgres/tools/pgwatch2/","title":"pgwatch2 \u6570\u636e\u5e93\u6307\u6807\u76d1\u63a7\u67e5\u770b","text":""},{"location":"postgres/tools/pgwatch2/#_1","title":"\u4ecb\u7ecd","text":"<p>pgwatch2\u5b98\u65b9</p> <p>\u5b98\u65b9\u6f14\u793a\u793a\u4f8b</p> <p>\u67b6\u6784 agent server</p> <ul> <li> <p>agent \u5728\u88ab\u76d1\u63a7\u7684pg\u4e0a\u81ea\u5b9a\u4e49\u65b9\u6cd5\uff0c\u7528\u4e8e\u6536\u96c6\u6570\u636e\u5e93\u4fe1\u606f\u3002\u8fd9\u4e9b\u81ea\u5b9a\u4e49\u7684\u65b9\u6cd5\u9700\u8981\u4f9d\u8d56\u9700\u8981\u6570\u636e\u5e93\u6269\u5c55\u5982pg_stat_statements,plpythonu.</p> </li> <li> <p>server \u8d1f\u8d23\u5b58\u50a8\u6536\u96c6\u8fc7\u6765\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u5b58\u653e\u5728postgres\u6216influxdb\u4e2d. \u5e76\u5c06\u6536\u96c6\u7684\u4fe1\u606f\u8fdb\u884c\u5c55\u793agrafana.</p> </li> </ul>"},{"location":"postgres/tools/pgwatch2/#_2","title":"\u5b89\u88c5","text":"<p>\u5ba2\u6237\u7aef</p> <p>\u4f9d\u8d56\u7684\u62d3\u5c55</p> <pre><code>yum install postgresql10-plpython.x86_64 -y\n\n</code></pre> <p>\u914d\u7f6e\u6570\u636e\u5e93,\u9700\u8981\u91cd\u542f\u6570\u636e\u5e93\u751f\u6548\uff0c\u591a\u4e2a\u62d3\u5c55\u4e4b\u95f4\u7528,\u53f7\u5206\u5272\u3002</p> <pre><code>shared_preload_libraries = 'pg_stat_statements'              \n</code></pre> <p>\u8fde\u63a5\u5230\u5bf9\u5e94\u7684\u6570\u636e\u5e93\uff0c\u521b\u5efa\u62d3\u5c55</p> <pre><code>CREATE EXTENSION pg_stat_statements;\nCREATE EXTENSION plpythonu;\n</code></pre> <p>\u521b\u5efa\u81ea\u5b9a\u4e49\u65b9\u6cd5, \u4f7f\u7528supper user \u7528\u6237\u6267\u884c\u5982\u4e0bsql. \u6ce8\u610f\u5c06\u4e0b\u9762\u7684pql \u4fe1\u606f\u4e2d\u7684\u7528\u6237\u4fe1\u606f\u66ff\u6362\u6210\u81ea\u5df1\u7684\u6570\u636e\u5e93\u8fde\u63a5\u7528\u6237\u3002</p> <pre><code>\u8be5\u76ee\u5f55\u4e0b\u4e3a\u6240\u6709\u7684\u81ea\u5b9a\u4e49\u65b9\u6cd5\nhttps://github.com/cybertec-postgresql/pgwatch2/tree/master/pgwatch2/sql/metric_fetching_helpers\n\nhttps://github.com/cybertec-postgresql/pgwatch2/blob/master/pgwatch2/sql/metric_fetching_helpers/stat_statements_wrapper.sql\n\nhttps://github.com/cybertec-postgresql/pgwatch2/blob/master/pgwatch2/sql/metric_fetching_helpers/cpu_load_plpythonu.sql\n</code></pre> <p>\u670d\u52a1\u7aef</p> <p>\u4f7f\u7528docker-compose \u6765\u7ba1\u7406\u670d\u52a1\uff0c\u5207\u90fd\u53d8\u5f97\u90a3\u4e48easy\uff01</p> <pre><code>cat docker-compose.yaml \nversion: '2'\nservices:\n  pgw2:\n    restart: unless-stopped\n    image: cybertec/pgwatch2\n    container_name: pw2\n    ports:\n      - 3000:3000 \n      - 8080:8080 \n    volumes:\n      - ./data/pg:/var/lib/postgresql\n      - ./data/influx:/var/lib/influxdb\n      - ./data/grafana:/var/lib/grafana\n      - ./data/pw2:/pgwatch2/persistent-config\n#    environment:\n#      - NOTESTDB=1 \n</code></pre> <p>\u8bf4\u660e\uff1a \u7aef\u53e3 3000 grafana\u754c\u9762\u5c55\u793a\u7aef\u53e3 , 8080 \u540e\u53f0\u7ba1\u7406\u7aef\u53e3 \u6570\u636e\u5377 data \u6302\u5728\u5230\u5b9e\u4f53\u4e3b\u673a\u7684\u4f4d\u7f6e\u3002</p>"},{"location":"postgres/tools/pgwatch2/#_3","title":"\u914d\u7f6e","text":"<p>\u8bbf\u95ee8080\u7aef\u53e3\u8fdb\u884c\u540e\u53f0\u914d\u7f6e\uff0c</p> <p>DBs \u6570\u636e\u5e93\u76d1\u63a7\u8fde\u63a5\u4fe1\u606f Metrics \u5ea6\u91cf Logs \u65e5\u5fd7\u4fe1\u606f\uff0c \u914d\u7f6e\u540e\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff0c\u591a\u6570\u4e3a\u7f3a\u5c11\u81ea\u5b9a\u4e49\u7684\u65b9\u6cd5\uff0c\u5728\u88ab\u76d1\u63a7\u7684\u6570\u636e\u5e93\u4e2d\u5b9a\u4e49\u5c31\u597d\u3002</p> <p>\u8bbf\u95ee 3000 \u7aef\u53e3\uff0c\u67e5\u770b\u6570\u636e\u5e93\u6307\u6807\u3002</p>"},{"location":"postgres/tools/pgxnclient/","title":"pgxnclient","text":"<p>A command line client for the PostgreSQL Extension Network</p>"},{"location":"postgres/tools/postgis/","title":"postgis \u5b89\u88c5","text":""},{"location":"postgres/tools/postgis/#_1","title":"\u7248\u672c\u5bf9\u5e94\u5173\u7cfb\u77e9\u9635","text":"<p>3.3 \u5bf9\u5e94 pg 17 \u5b9e\u8df5\u6709\u95ee\u9898 https://trac.osgeo.org/postgis/wiki/UsersWikiPostgreSQLPostGIS</p> <p>export POSTGIS_VERSION=3.4.0 curl -sSL \"https://download.osgeo.org/postgis/source/postgis-${POSTGIS_VERSION}.tar.gz\" | tar -xz &amp;&amp; \\  cd postgis-\"${POSTGIS_VERSION}\" &amp;&amp; \\     ./configure \\     --prefix=\"/opt/drycc/postgresql/${PG_MAJOR}/postgis/${POSTGIS_VERSION}\" \\     --with-pgconfig=/opt/drycc/postgresql/\"${PG_MAJOR}\"/bin/pg_config</p> <p>sudo apt install build-essential cmake sudo apt-get install postgresql-server-dev-all \\  libgdal-dev \\  libgeos-dev \\  libjson-c-dev \\  libproj-dev \\  libprotobuf-c-dev \\  protobuf-c-compiler</p>"},{"location":"postgres/tools/postgis/#_2","title":"\u7f16\u8bd1\u5b89\u88c5\uff0c \u524d\u9762\u7684\u4e0d\u6210\u529f\u5c31\u653e\u5f03\u5427\uff01\uff01\uff01","text":""},{"location":"postgres/tools/postgis/#_3","title":"\u524d\u671f\u51c6\u5907","text":""},{"location":"postgres/tools/postgis/#proj-49","title":"proj 4.9","text":"<p>https://download.osgeo.org/proj/</p>"},{"location":"postgres/tools/postgis/#geos-37","title":"GEOS 3.7","text":"<p>https://download.osgeo.org/geos/</p> <p>tar -xjvf geos-3.9.6.tar.bz2</p> <p>mkdir build &amp;&amp; cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=Release ..</p>"},{"location":"postgres/tools/postgis/#gdal-19","title":"gdal 1.9","text":"<p>https://gdal.org/en/stable/download_past.html#download-past</p> <p>export CXXFLAGS=\"-fpermissive\"</p>"},{"location":"postgres/tools/postgis/#postgis_1","title":"postgis \u51c6\u5907","text":"<p>\u4e0b\u8f7d\u5b89\u88c5\u5305 wget https://download.osgeo.org/postgis/source/postgis-2.4.9.tar.gz</p> <p>sudo apt-get install libgeos-dev</p> <p>sudo apt-get install libpq-dev \\  libxml2-dev \\</p> <p>geos-config --version geos-config --libs</p>"},{"location":"postgres/tools/postgis/#ubuntu-2024-postgersql10-postgis25","title":"Ubuntu 2024 + postgersql10 + postgis2.5","text":"<p>wget https://download.osgeo.org/postgis/source/postgis-2.5.0.tar.gz ./configure --with-pgconfig=/usr/lib/postgresql/10/bin/pg_config</p> <p>configure: error: could not find proj_api.h - you may need to specify the directory of a PROJ.4 installation using --with-projdir</p> <p>\u91cd\u8981\u63d0\u793a\u5173\u4e8e PROJ \u7248\u672c:</p> <p>PROJ 6.0+: \u4ece PROJ 6.0 \u5f00\u59cb\uff0cprojapi.h\uff08\u65e7\u7684 C API\uff09\u5df2\u88ab\u5b8c\u5168\u79fb\u9664\uff0c\u5e76\u7531\u65b0\u7684 C++ API \u66ff\u4ee3\u3002 \u8f6f\u4ef6\u517c\u5bb9\u6027: \u5982\u679c\u4f60\u6b63\u5728\u7f16\u8bd1\u4e00\u4e2a \u9700\u8981\u65e7\u7248 PROJ API (proj_api.h) \u7684\u8f6f\u4ef6\uff08\u901a\u5e38\u662f\u4f9d\u8d56\u4e8e GDAL &lt;3.x \u6216\u76f4\u63a5\u96c6\u6210\u65e7 PROJ API \u7684\u8f6f\u4ef6\uff09\uff0c\u4f60\u9700\u8981\u5b89\u88c5 PROJ 5.x \u6216\u66f4\u65e9\u7248\u672c\u3002\u8f6f\u4ef6\u672c\u8eab\u7684\u6e90\u4ee3\u7801\u901a\u5e38\u9700\u8981\u80fd\u591f\u517c\u5bb9\u3002 \u8f83\u65b0\u7684\u8f6f\u4ef6\uff08GDAL 3.x+\uff09\u4e0d\u518d\u4f9d\u8d56 proj_api.h\uff0c\u800c\u662f\u4f7f\u7528\u65b0\u7684 proj.h\u3002\u5982\u679c\u4f60\u7684\u8f6f\u4ef6\u8f83\u65b0\u4f46\u4ecd\u7136\u63d0\u793a\u627e\u4e0d\u5230 proj_api.h\uff0c\u53ef\u80fd\u662f\u8f6f\u4ef6\u7684 configure \u811a\u672c\u6709\u70b9\u65e7\u6216\u8005\u6709\u4f9d\u8d56\u5173\u7cfb\u6ca1\u5904\u7406\u597d\u3002\u8fd9\u65f6\u5b89\u88c5 libproj-dev \u901a\u5e38\u4e5f\u8db3\u591f\u4e86\u3002 \u786e\u8ba4\u7248\u672c: \u5b89\u88c5\u540e\u8fd0\u884c proj \u547d\u4ee4\uff08\u5982\u679c\u5b89\u88c5\u4e86\u547d\u4ee4\u884c\u5de5\u5177\uff09\u901a\u5e38\u663e\u793a\u7248\u672c\u4fe1\u606f\u3002 \u6216\u8005\u67e5\u770b\u5e93\u6587\u4ef6\u8def\u5f84\uff1als /usr/lib/libproj. \u6216 /usr/local/lib/libproj._\uff0c\u7248\u672c\u53ef\u80fd\u5305\u542b\u5728\u6587\u4ef6\u540d\u4e2d\u3002</p> <p>apt list libproj-dev Listing... Done libproj-dev/noble,now 9.4.0-1build2 amd64 [installed]</p> <p>sudo apt update \u6dfb\u52a0\u65e7\u7248\u672c\u8f6f\u4ef6\u6e90\uff08\u5982\u9002\u7528\u4e8e Ubuntu Focal 20.04\uff09\uff1a \u6ce8\u610f\uff1a \u6df7\u7528\u4e0d\u540c\u7248\u672c\u6e90\u7684\u8f6f\u4ef6\u5305\u6709\u98ce\u9669\uff0c\u53ef\u80fd\u5bfc\u81f4\u5176\u4ed6\u4f9d\u8d56\u95ee\u9898\u3002\u901a\u5e38\u7528\u4e8e\u4e34\u65f6\u7f16\u8bd1\u3002 \u5728 /etc/apt/sources.list \u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e00\u884c\uff1a  deb http://archive.ubuntu.com/ubuntu focal universe"},{"location":"postgres/tools/postgis/#_4","title":"\u5982\u679c\u53ea\u7528\u4e8e\u5b89\u88c5\u6307\u5b9a\u5305\uff0c\u53ef\u4ee5\u521b\u5efa\u4e34\u65f6\u6587\u4ef6\uff1a","text":"<p>sudo sh -c 'echo \"deb http://archive.ubuntu.com/ubuntu focal universe\" &gt; /etc/apt/sources.list.d/focal-proj.list'</p> <p>sudo apt update sudo apt install libproj-dev/focal</p>"},{"location":"postgres/tools/postgis/#_5","title":"\u53ef\u80fd\u4f1a\u63d0\u793a\u786e\u8ba4\uff0c\u63a5\u53d7\u5373\u53ef","text":"<p>dpkg -l libproj-dev</p> <p>wget https://download.osgeo.org/proj/proj-4.9.3.tar.gz tar xf proj-4.9.3.tar.gz cd proj-4.9.3 ./configure &amp;&amp; make -j$(nproc) sudo make install sudo ldconfig</p>"},{"location":"postgres/tools/postgis/#_6","title":"\u5b89\u88c5\u7f16\u8bd1\u4f9d\u8d56","text":"<p>sudo apt install libxml2-dev libgeos-dev libgdal-dev</p>"},{"location":"postgres/tools/postgis/#postgis_2","title":"\u7f16\u8bd1\u5b89\u88c5 PostGIS","text":"<p>wget https://download.osgeo.org/postgis/source/postgis-2.5.0.tar.gz tar xf postgis-2.5.0.tar.gz cd postgis-2.5.0 ./configure \\  --with-pgconfig=/usr/lib/postgresql/10/bin/pg_config \\  --with-projdir=/usr/local make -j$(nproc) sudo make install</p>"},{"location":"postgres/tools/timescaledb_demo01/","title":"\u5173\u4e8e\u65f6\u5e8f\u6570\u636e\u5e93\u7684\u4e00\u4e2a\u793a\u4f8b-\u7528\u6237\u8bbf\u95ee\u7edf\u8ba1\u5206\u6790","text":""},{"location":"postgres/tools/timescaledb_demo01/#_1","title":"\u9700\u6c42\u5206\u6790","text":"<ul> <li>\u7528\u6237\u8bbf\u95ee\u4fe1\u606f\u8868\u5305\u62ec\uff1a  \u8bbf\u95ee\u65f6\u95f4,\u7528\u6237ID ,\u5e74\u9f84 ,\u8bbe\u5907\u7c7b\u578b ('\u624b\u673a', '\u7535\u8111'),\u8bbf\u95ee\u6765\u6e90 (\u5982\uff1a'\u641c\u7d22\u5f15\u64ce', '\u76f4\u63a5\u8bbf\u95ee')\uff0c \u7528\u6237\u6240\u5728\u7701\u4efd\uff0c \u7528\u6237\u7c7b\u578b (\u5982: '\u65b0\u7528\u6237', '\u8001\u7528\u6237')</li> <li>\u8d85\u8868\u7c92\u5ea6\uff1a \u6bcf\u5c0f\u65f6</li> <li>\u7edf\u8ba1\u5206\u6790\uff1a \u4e94\u5206\u949f\uff0c \u5c0f\u65f6\uff0c \u5929\uff0c\u5468</li> <li>\u5206\u6790\u7c7b\u578b\uff1a \u4e94\u5206\u949f \uff0c\u5c0f\u65f6\u4e3a\u5b9e\u65f6\u5206\u6790 \u3002 \u5929\uff0c\u5468\uff0c\u6301\u7eed\u805a\u5408</li> <li>\u66f4\u65b0\u7b56\u7565\uff1a \u4e94\u5206\u949f-\u8de8\u5ea6 5-30 \u5206\u949f\uff0c\u9891\u73875\u5206\u949f\u3002 \u5c0f\u65f6-\u8de8\u5ea6 1 - 2 \u5c0f\u65f6\uff0c\u9891\u73871\u5c0f\u65f6 \u3002 \u5929 - \u6bcf\u5929\u51cc\u6668\u4e00\u70b9\u7edf\u8ba1\uff0c\u5468\u6bcf\u5468\u4e00\u51cc\u6668\u4e24\u70b9\u7edf\u8ba1\u3002</li> <li>\u6570\u636e\u4fdd\u7559\uff1a \u8d85\u8868 \u4e00\u5929\uff0c \u89c6\u56fe\u4e00\u4e2a\u6708</li> </ul>"},{"location":"postgres/tools/timescaledb_demo01/#sql","title":"SQL","text":""},{"location":"postgres/tools/timescaledb_demo01/#_2","title":"\u8868\u7ed3\u6784","text":"<pre><code>-- \u542f\u7528TimescaleDB\u6269\u5c55\nCREATE EXTENSION IF NOT EXISTS timescaledb;\n\n-- \u521b\u5efa\u7528\u6237\u8bbf\u95ee\u8bb0\u5f55\u8868\nCREATE TABLE user_visits (\n    time TIMESTAMPTZ NOT NULL,      -- \u8bbf\u95ee\u65f6\u95f4\n    user_id INT,                    -- \u7528\u6237ID\n    age INT CHECK (age BETWEEN 1 AND 100),  -- \u5e74\u9f84\n    device VARCHAR(10) CHECK (device IN ('\u624b\u673a', '\u7535\u8111')),  -- \u8bbe\u5907\u7c7b\u578b\n    source VARCHAR(20),             -- \u8bbf\u95ee\u6765\u6e90 (\u5982: '\u641c\u7d22\u5f15\u64ce', '\u76f4\u63a5\u8bbf\u95ee')\n    province VARCHAR(20),           -- \u7528\u6237\u6240\u5728\u7701\u4efd\n    user_type VARCHAR(10)           -- \u7528\u6237\u7c7b\u578b (\u5982: '\u65b0\u7528\u6237', '\u8001\u7528\u6237')\n);\n-- \u8f6c\u6362\u4e3a\u8d85\u8868\uff0c\u6309\u5c0f\u65f6\u5206\u5757\nSELECT create_hypertable(\n    'user_visits',\n    'time',\n    chunk_time_interval =&gt; INTERVAL '1 hour',\n    if_not_exists =&gt; TRUE\n);\n</code></pre>"},{"location":"postgres/tools/timescaledb_demo01/#_3","title":"\u89c6\u56fe","text":"<pre><code>-- \u521b\u5efa\u89c6\u56fe\n-- \u4e94\u5206\u949f\u805a\u5408\nCREATE MATERIALIZED VIEW visits_5min\nWITH (timescaledb.continuous) AS\nSELECT\n    time_bucket('5 minutes', time) AS bucket,\n    province,\n    device,\n    COUNT(*) AS visit_count\nFROM user_visits\nGROUP BY bucket, province, device;\n\n-- \u5f00\u542f\u5b9e\u65f6\u805a\u5408\nALTER MATERIALIZED VIEW visits_5min set (timescaledb.materialized_only = false);\n\n-- \u5c0f\u65f6\u805a\u5408\nCREATE MATERIALIZED VIEW visits_hourly\nWITH (timescaledb.continuous) AS\nSELECT\n    time_bucket('1 hour'::interval, bucket) as bucket,\n    province,\n    device,\n    SUM(visit_count) AS visit_count \nFROM visits_5min\nGROUP BY 1, 2, 3;\n\n\n-- \u5f00\u542f\u5b9e\u65f6\u805a\u5408\nALTER MATERIALIZED VIEW visits_hourly set (timescaledb.materialized_only = false);\n\n-- \u5929\u805a\u5408\nCREATE MATERIALIZED VIEW visits_daily\nWITH (timescaledb.continuous) AS\nSELECT\n    time_bucket('1 day', bucket) AS bucket,\n    province,\n    device,\n    SUM(visit_count) AS visit_count\nFROM visits_hourly\nGROUP BY 1, 2, 3;\n\n-- \u5468\u805a\u5408\nCREATE MATERIALIZED VIEW visits_weekly\nWITH (timescaledb.continuous) AS\nSELECT\n    time_bucket('1 week', bucket) AS bucket,\n    province,\n    device,\n    SUM(visit_count) AS visit_count\nFROM visits_daily\nGROUP BY 1, 2, 3;\n</code></pre>"},{"location":"postgres/tools/timescaledb_demo01/#_4","title":"\u5237\u65b0\u7b56\u7565","text":"<pre><code>-- 5\u5206\u949f\u805a\u5408\uff1a\u5ef6\u8fdf5\u5206\u949f\u5237\u65b0\nSELECT add_continuous_aggregate_policy(\n    'visits_5min',\n    start_offset =&gt; INTERVAL '15 minutes',\n    end_offset =&gt; INTERVAL '5 minutes',\n    schedule_interval =&gt; INTERVAL '5 minutes'\n);\n\n-- \u5c0f\u65f6\u805a\u5408\uff1a\u5ef6\u8fdf1\u5c0f\u65f6\u5237\u65b0\nSELECT add_continuous_aggregate_policy(\n    'visits_hourly',\n    start_offset =&gt; INTERVAL '3 hours',\n    end_offset =&gt; INTERVAL '1 hour',\n    schedule_interval =&gt; INTERVAL '1 hour'\n);\n\n-- \u5929/\u5468\u805a\u5408\uff1a\u6bcf\u5929\u51cc\u6668\u5237\u65b0\nSELECT add_continuous_aggregate_policy(\n    'visits_daily',\n    start_offset =&gt; INTERVAL '25 days',\n    end_offset =&gt; INTERVAL '1 hour',\n    schedule_interval =&gt; INTERVAL '24 hours',\n    initial_start =&gt; '2023-01-01 01:00:00'\n);\n\nSELECT add_continuous_aggregate_policy(\n    'visits_weekly',\n    start_offset =&gt; INTERVAL '8 days',     -- \u786e\u4fdd\u8986\u76d6\u5b8c\u6574\u5468+1\u5929\u7f13\u51b2\n    end_offset =&gt; INTERVAL '1 day',        -- \u5f53\u524d\u65f6\u95f4-1\u5929=\u5468\u65e5\u5348\u591c\n    schedule_interval =&gt; INTERVAL '1 week', -- \u6bcf\u5468\u6267\u884c\u4e00\u6b21\n    initial_start =&gt; '2023-01-02 01:00:00+08' -- \u6307\u5b9a\u5468\u65e5\u51cc\u66681\u70b9\u6267\u884c\uff08\u5e26\u65f6\u533a\uff09\n);\n</code></pre>"},{"location":"postgres/tools/timescaledb_demo01/#_5","title":"\u538b\u7f29\u7b56\u7565","text":"<pre><code>-- \u538b\u7f29\u7b56\u7565\uff1a1\u5929\u524d\u7684\u6570\u636e\u8f6c\u4e3a\u5217\u5b58\nALTER TABLE user_visits SET (\n    timescaledb.compress,\n    timescaledb.compress_segmentby = 'province, device',\n    timescaledb.compress_orderby = 'time DESC'\n);\n\nSELECT add_compression_policy(\n    'user_visits',\n    compress_after =&gt; INTERVAL '1 day'\n);\n\n-- \u6570\u636e\u4fdd\u7559\u7b56\u7565\uff1a\u8d85\u8868\u4fdd\u75597\u5929\uff0c\u7269\u5316\u89c6\u56fe\u4fdd\u755930\u5929\nSELECT add_retention_policy('user_visits', INTERVAL '7 days');\nSELECT add_retention_policy('visits_5min', INTERVAL '30 days');\nSELECT add_retention_policy('visits_hourly', INTERVAL '30 days');\nSELECT add_retention_policy('visits_daily', INTERVAL '30 days');\nSELECT add_retention_policy('visits_weekly', INTERVAL '30 days');\n</code></pre> <p>\u624b\u52a8\u5237\u65b0\u7b56\u7565</p> <pre><code>call refresh_continuous_aggregate('visits_5min',);\n\nSELECT refresh_continuous_aggregate('visits_hourly');\n\nSELECT refresh_continuous_aggregate('visits_daily','2025-03-30 17:00:00+08','2025-04-30 17:00:00+08'); \n</code></pre>"},{"location":"postgres/tools/tpch/","title":"tpch AP\u6d4b\u8bd5","text":""},{"location":"postgres/tools/tpch/#_1","title":"\u80cc\u666f\u4ecb\u7ecd","text":"<p>24sql</p>"},{"location":"postgres/tools/tpch/#tpc-h","title":"TPC-H \u57fa\u51c6\u6d4b\u8bd5","text":""},{"location":"postgres/tools/tpch/#_2","title":"\u4e0b\u8f7d\u5b89\u88c5","text":"<p>tpch-tools\u5b89\u88c5\u5305</p> <p>\u4fee\u6539makefile.suite \u6a21\u7248</p> <pre><code>CC=gcc \nDATABASE-TDAT\nMACHINE=LINUX\nWORKLOAD=TPCH\n</code></pre> <p>\u6267\u884c make \u8fdb\u884c\u7f16\u8bd1</p>"},{"location":"postgres/tools/tpch/#_3","title":"\u751f\u6210\u6d4b\u8bd5\u6570\u636e","text":"<p>\u751f\u621020G\u6d4b\u8bd5\u6570\u636e</p> <pre><code>./dbgen -s 20\nls -lrth *.tbl\n</code></pre> <p>\u81ea\u52a8\u751f\u6210\u7684\u6d4b\u8bd5\u6570\u636e\u6bcf\u884c\u7684\u7ed3\u5c3e\u591a\u4f59\u4e00\u4e2a '|' \u9700\u8981\u5904\u7406</p> <pre><code>for i in `ls *.tbl`; do sed 's/|$//' $i &gt; ${i/tbl/csv}; echo $i; done;\n</code></pre>"},{"location":"postgres/tools/tpch/#_4","title":"\u521b\u5efa\u8868\u53ca\u7d22\u5f15","text":"<p>\u5728\u4e0b\u9762\u7684\u6587\u4ef6\u4e2d\u5206\u522b\u662f\u521b\u5efa\u8868\u548c\u5bf9\u5e94\u7d22\u5f15\u7684sql</p> <p>dss.ddl     dss.ri</p>"},{"location":"postgres/tools/tpch/#_5","title":"\u5bfc\u5165\u6570\u636e","text":"<pre><code>copy customer from '/opt/tpch-tools/dbgen/customer.csv' with DELIMITER '|';\ncopy lineitem from '/opt/tpch-tools/dbgen/lineitem.csv' with DELIMITER '|';\ncopy nation from '/opt/tpch-tools/dbgen/nation.csv' with DELIMITER '|';\ncopy orders from '/opt/tpch-tools/dbgen/orders.csv' with DELIMITER '|';\ncopy partsupp from '/opt/tpch-tools/dbgen/partsupp.csv' with DELIMITER '|';\ncopy region from '/opt/tpch-tools/dbgen/region.csv' with DELIMITER '|';\ncopy supplier from '/opt/tpch-tools/dbgen/supplier.csv' with DELIMITER '|';\n</code></pre>"},{"location":"postgres/tools/tpch/#_6","title":"\u57fa\u51c6\u6d4b\u8bd5","text":"<p>\u5728queries \u76ee\u5f55\u4e0b\u5b58\u653e\u7684\u662f24\u6761sql</p>"},{"location":"postgres/tools/view_pg_stat_activity/","title":"\u6570\u636e\u5e93\u89c6\u56fe\u4e4b pg_stat_activity","text":""},{"location":"postgres/tools/view_pg_stat_activity/#_1","title":"\u4ecb\u7ecd","text":"<p>\u5f53\u9700\u8981\u4e86\u89e3\u6570\u636e\u5e93\u5f53\u524d\u8fd0\u884c\u72b6\u6001\u6216\u9700\u8981\u6392\u67e5\u95ee\u9898\u65f6\uff0c\u9996\u5148\u9700\u8981\u67e5\u770b\u7684\u5c31\u662fpg_stat_activity\u3002\u8be5\u89c6\u56fe\u4e2d\u5305\u542b\u4e86\u4f60\u60f3\u77e5\u9053\u7684\u6570\u636e\u5e93\u8fde\u63a5\u4fe1\u606f\uff0c\u6b63\u5728\u6267\u884c\u7684\u6709\u54ea\u4e9bsql\uff0c\u5e76\u5904\u4e8e\u4f55\u72b6\u6001\u3002</p> <p>One row per server process, showing information related to the current activity of that process, such as state and current query.</p> <p>\u6bcf\u4e00\u884c\u90fd\u8868\u793a\u4e00\u4e2a\u7cfb\u7edf\u8fdb\u7a0b\uff0c\u663e\u793a\u4e0e\u5f53\u524d\u4f1a\u8bdd\u7684\u6d3b\u52a8\u8fdb\u7a0b\u7684\u4e00\u4e9b\u4fe1\u606f\uff0c\u6bd4\u5982\u5f53\u524d\u56de\u8bdd\u7684\u72b6\u6001\u548c\u67e5\u8be2\u7b49\u3002</p>"},{"location":"postgres/tools/view_pg_stat_activity/#_2","title":"\u5b57\u6bb5\u89e3\u8bfb","text":"Column Type Description datid oid OID of the database this backend is connected to datname name Name of the database this backend is connected to pid integer Process ID of this backend usesysid oid OID of the user logged into this backend usename name Name of the user logged into this backend application_name text Name of the application that is connected to this backend client_addr inet IP address of the client connected to this backend. If this field is null, itindicates(\u8868\u660e) either that the client is connected via a Unixsocket(\u63d2\u5ea7) on the server machine or that this is aninternal(\u5185\u90e8\u7684) process such as autovacuum. client_hostname text Host name of the connected client, as reported by a reverse(\u76f8\u53cd) DNS lookup(\u67e5\u627e) of client_addr. This field will only be non-null for IP connections, and only whenlog_hostname is enabled. client_port integer TCP port number that the client is using for communication with this backend, or-1 if a Unixsocket(\u63d2\u5ea7) is used backend_start timestamp(\u65f6\u95f4\u6233) with time zone Time when this process was started, i.e., when the client connected to the server xact_start timestamp with time zone Time when this process' current transaction(\u4ea4\u6613) was started, or null if no transaction is active. If the current query is the first of its transaction, this column is equal to the query_start column. query_start timestamp with time zone Time when the currently active query was started, or if state is not active, when the last query was started state_change timestamp(\u65f6\u95f4\u6233) with time zone Time when the state was last changed waiting boolean True if this backend is currently waiting on a lock state text query text Text of this backend's most recent query. Ifstate isactive this field shows the currently executing query. In all other states, it shows the last query that was executed."},{"location":"postgres/tools/view_pg_stat_activity/#state","title":"state \u5b57\u6bb5\u8be6\u89e3","text":"<ul> <li>active: The backend isexecuting(\u5b9e\u884c) a query. \u6b63\u5728\u6267\u884c\u4e2d</li> <li>idle: The backend is waiting for a new client command. \u8fde\u63a5\u5df2\u7ecf\u5efa\u7acb\u7b49\u5f85\u5ba2\u6237\u7aef\u547d\u4ee4</li> <li>idle in transaction: The backend is in atransaction(\u4ea4\u6613), but is not currentlyexecuting(\u5b9e\u884c) a query. \u4e8b\u52a1\u5df2\u7ecfbegin \u5c1a\u672acommit</li> <li>idle\u00a0in transaction (aborted): This state is similar toidle in transaction, except one of thestatements(\u58f0\u660e) in the transaction caused an error. \u4e8b\u52a1\u4e2d\u65ad</li> <li>fastpath function call: The backend is executing a fast-path function. </li> <li>disabled: This state is reported iftrack_activities is disabled in this backend.</li> </ul>"},{"location":"postgres/tools/view_pg_stat_activity/#_3","title":"\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u67e5\u8be2\u6240\u5904\u7684\u72b6\u6001","text":"<pre><code>select datname, count(*) AS open,count(*) FILTER (WHERE state = 'active') AS active,\n                count(*) FILTER(WHERE state = 'idle') AS idle ,\n                count(*) FILTER(WHERE state = 'idle in transaction') AS idle_in_trans\n                FROM pg_stat_activity GROUP BY ROLLUP(1);\n</code></pre>"},{"location":"postgres/tools/view_pg_stat_activity/#idle-in-transaction","title":"\u4e00\u76f4\u6709\u8fde\u63a5\u957f\u65f6\u95f4\u5904\u4e8eidle in transaction\u7684\u95ee\u9898","text":"<p>\u914d\u7f6epostgresql.conf</p> <pre><code>idle_in_transaction_session_timeout=30000\n</code></pre>"},{"location":"postgres/tools/view_pg_stat_activity/#query","title":"query \u5185\u5bb9\u663e\u793a\u4e0d\u5168","text":"<p>\u914d\u7f6epostgresql.conf</p> <pre><code>track_activity_query_size=32768\n</code></pre>"},{"location":"postgres/tools/view_pg_stat_activity/#_4","title":"\u6740\u6b7b\u5df2\u6302\u6389\u7684\u8fde\u63a5","text":"<pre><code>select pg_terminate_backend(pid)\n</code></pre>"},{"location":"postgres/tools/view_pg_stat_activity/#sql-pid-sql","title":"\u53d6\u6d88\u6b63\u5728\u6267\u884c\u7684sql pid (\u4e0d\u4f1a\u91ca\u653e\u8fde\u63a5\uff0c\u53ea\u4f1a\u53d6\u6d88sql\u67e5\u8be2\u8bed\u53e5)","text":"<pre><code>SELECT pg_cancel_backend(pid);\n</code></pre>"},{"location":"postgres/tools/view_pg_stat_activity/#_5","title":"\u8fdb\u4e00\u6b65\u529f\u80fd\u6269\u5c55","text":"<p>https://github.com/pgsentinel/pgsentinel</p> <ul> <li>postgresql extension providing Active session history</li> </ul> <p>\u7c7b\u4f3c Oracle\u4e2d\u7684ASH(Active Session History)\uff0cASH\u901a\u8fc7\u6bcf\u79d2\u949f\u62bd\u53d6\u6d3b\u52a8\u4f1a\u8bdd\u6837\u672c\uff0c\u4e3a\u5206\u6790\u5728\u6700\u8fd1\u65f6\u523b\u7684\u6027\u80fd\u95ee\u9898\u63d0\u4f9b\u6700\u76f4\u63a5\u6709\u6548\u7684\u4f9d\u636e\u3002</p> <p>\u5e94\u7528\u573a\u666f\uff1a \u5f53\u76d1\u63a7\u663e\u793a\uff0c\u67d0\u4e2a\u77ac\u95f4\u6570\u636e\u5e93\u8fde\u63a5\u6570\u8d85\u8fc7\u9600\u503c\u3002 \u67e5\u770b\u65e5\u5fd7\u663e\u793atoo many connentions \u3002 \u4f7f\u7528pg_stat_activity \u89c6\u56fe\u65f6\u53ea\u80fd\u67e5\u770b\u5f53\u524d\u7684\u6d3b\u52a8\u8fde\u63a5\u3002\u6545\u969c\u77ac\u95f4\u6293\u53d6\u4e0d\u5230\u3002</p> <p>pgsentinel \u8bb0\u5f55\u4e86\u5386\u53f2\u6d3b\u52a8\u72b6\u6001\uff0c\u5e2e\u52a9\u5bf9\u5386\u53f2\u95ee\u9898\u7684\u8ffd\u6eaf\u3002</p>"},{"location":"postgres/tools/view_pg_stat_activity/#pg_top","title":"pg_top","text":"<p>\u7c7b\u4f3c Linux top</p> <p>\u5b89\u88c5</p> <pre><code>yum install pg_top\n</code></pre> <p>\u4f7f\u7528 (\u672c\u673a &amp; \u8fdc\u7a0b)</p> <pre><code>#pg_top -U postgres -h **** \n\nlast pid: 55852;  load avg:  1.55,  1.25,  0.93;       up 0+23:44:48                                                                                                                09:17:30\n7 processes: 5 sleeping, 2 uninterruptable\nCPU states:  1.1% user,  0.0% nice,  0.5% system, 96.8% idle,  1.6% iowait\nMemory: 125G used, 561M free, 240K buffers, 117G cached\nDB activity: 242 tps, 12 rollbs/s,  12 buffer r/s, 99 hit%,  82120 row r/s,    0 row w/s\nDB I/O:     0 reads/s,     0 KB/s,     0 writes/s,     0 KB/s\nDB disk: 7450.0 GB total, 7055.5 GB free (5% used)\nSwap: 4096M free\n\n  PID USERNAME PRI NICE  SIZE   RES STATE   TIME   WCPU    CPU COMMAND\n40030 postgres  20    0   17G 5624K sleep   0:07  0.68%  0.60% postmaster\n40022 postgres  20    0   17G  946M sleep   0:05  0.42%  0.40% postmaster\n40023 postgres  20    0   17G 1061M sleep   0:02  0.25%  0.00% postmaster\n54528 postgres  20    0   17G 1220M disk    0:01  1.38%  0.00% postmaster\n54963 postgres  20    0   17G  747M disk    0:01  1.27%  0.00% postmaster\n40024 postgres  20    0   17G  130M sleep   0:00  0.03%  0.00% postmaster\n55853 postgres  20    0   17G 6900K sleep   0:00  0.00%  0.00% postmaster\n</code></pre>"},{"location":"postgres/tools/view_pg_stat_bgwriter/","title":"\u6570\u636e\u5e93\u8bd5\u56fe\u4e4b pg_stat_bgwriter","text":"","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#_1","title":"\u4ecb\u7ecd","text":"<p>\u53ef\u67e5\u770b backgroud writer\uff0c checkpoint \uff0cbackend \u8fdb\u7a0b\u5237\u5199 Shared buffer \u60c5\u51b5\u89c6\u56fe</p> <p>pg\u6570\u636e\u5e93\u5728\u5199\u5165\u65f6\u5148\u5728\u5185\u5b58\u4e2d\u66f4\u65b0shared buffer \uff0c\u7136\u540e\u6709checkpoint\u673a\u5236\u5c06\u810f\u6570\u636e\u5237\u5199\u5230\u78c1\u76d8\u3002</p>","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#_2","title":"\u89c6\u56fe","text":"<pre><code> select * from pg_stat_bgwriter ;\n-[ RECORD 1 ]---------+------------------------------\ncheckpoints_timed     | 64017\ncheckpoints_req       | 458\ncheckpoint_write_time | 9608302902\ncheckpoint_sync_time  | 1189286\nbuffers_checkpoint    | 578367652\nbuffers_clean         | 329022\nmaxwritten_clean      | 2353\nbuffers_backend       | 29802728\nbuffers_backend_fsync | 0\nbuffers_alloc         | 83826180\nstats_reset           | 2020-08-20 19:41:20.491551+08\n</code></pre> <p>\u8d1f\u8d23\u5c06shared buffer \u4e2d\u7684\u5185\u5bb9\u5237\u65b0\u5230\u78c1\u76d8\u4e3b\u8981\u6709\u4e09\u4e2a\u8fdb\u7a0b\u5b8c\u6210</p> <ul> <li>checkpoint </li> <li>bgwriter</li> <li>backend</li> </ul> <p>\u89c6\u56fe\u5185\u5bb9\u4e3b\u8981\u4e5f\u662f\u9488\u5bf9\u8fd9\u4e09\u4e2a\u8fdb\u7a0b\u7684\u7edf\u8ba1\u4fe1\u606f</p>","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#checkpoint","title":"checkpoint","text":"<pre><code>checkpoints_timed \u5468\u671f\u6027\u8fdb\u884ccheckpoint\u7684\u6b21\u6570    \ncheckpoints_req   \u5468\u671f\u4ee5\u5916\u53d1\u751fcheckpoint\u7684\u6b21\u6570\ncheckpoint_write_time \u5237\u5199\u8017\u65f6\ncheckpoint_sync_time  \u540c\u6b65\u8017\u65f6\nbuffers_checkpoint \u5199\u5165\u91cf\n</code></pre>","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#bgwriter","title":"bgwriter","text":"<pre><code>buffers_clean bgwriter \u5199\u5165\u91cf\nmaxwritten_clean bgwriter \u4e00\u6b21\u5199\u5165\u91cf\u8d85\u8fc7bgwriter_lru_maxpages\u505c\u6b62\u6b21\u6570\n</code></pre>","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#_3","title":"\u6570\u636e\u5e93\u8bd5\u56fe\u4e4b pg_stat_bgwriter","text":"<pre><code>buffers_backend       backend \u5199\u5165\u91cf\nbuffers_backend_fsync \u540c\u6b65\u5199\u5165\u6b21\u6570\n</code></pre>","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#_4","title":"\u6570\u636e\u5e93\u8bd5\u56fe\u4e4b pg_stat_bgwriter","text":"<p>buffer \u7531 \u4e09\u90e8\u5206\u5b9e\u73b0\u843d\u76d8\uff0c bgwriter </p> <pre><code>buffers_checkpoint\uff1a\u7531checkpointer\u6e05\u7406\u7684\u810f\u5757\uff1b\nbuffers_clean\uff1a\u7531bgwriter\u6e05\u7406\u7684\u810f\u5757\u6570\u91cf\uff1b\nbuffers_backend\uff1a\u7531backend\u6e05\u7406\u7684\u810f\u5757\u6570\u91cf\n</code></pre>","tags":[]},{"location":"postgres/tools/view_pg_stat_bgwriter/#_5","title":"\u7406\u60f3\u72b6\u6001","text":"<p>\u5927\u90e8\u5206\u7684\u810f\u6570\u636e\u90fd\u662fbgwriter\u5199\u56de\u5b58\u50a8\u7684\uff0c\u5c11\u91cf\u7684\u810f\u6570\u636e\u662fcheckpointer\u5199\u5165\u7684\uff0c\u66f4\u5c11\u7684\u6570\u636e\u662fbackend\u5199\u5165\u7684\u3002\u56e0\u4e3abackend\u5199\u5165\u6570\u636e\u6210\u672c\u975e\u5e38\u9ad8\u3002</p> <p>checkpoint \u7684\u5199\u5165\u57fa\u672c\u90fd\u662f\u5468\u671f\u6027\u7684\u5199\u5165\u3002</p> <p>\u66f4\u591a\u7ec6\u8282</p> <p>https://www.modb.pro/db/47188</p>","tags":[]},{"location":"postgres/troubleshooting/auto_vacuum_trigger/","title":"auto vacuum \u89e6\u53d1\u673a\u5236","text":""},{"location":"postgres/troubleshooting/auto_vacuum_trigger/#_1","title":"\u6570\u636e\u5e93\u81ea\u52a8\u5783\u573e\u56de\u6536\u89e6\u53d1\u6761\u4ef6\u5206\u6790","text":"<p>\u5728postgres \u4e2d \u5783\u573e\u56de\u6536\u7684\u91cd\u8981\u610f\u4e49\u53ca\u5728\u6267\u884c\u5783\u573e\u56de\u6536\u65f6\u5177\u4f53\u90fd\u505a\u4e86\u4e9b\u4ec0\u4e48\u5f88\u591a\u5730\u65b9\u90fd\u6709\u4ecb\u7ecd\u3002</p> <p>\u4f46\u662f\u4f55\u65f6\u89e6\u53d1\u5783\u573e\u56de\u6536\uff0c\u5373\u5783\u573e\u56de\u6536\u7684\u89e6\u53d1\u6761\u4ef6\u662f\u4ec0\u4e48\u3002</p> <p>\u5b98\u7f51\u7684\u4ecb\u7ecd\u4e00\u822c\u662f\u6709\u5982\u4e0b\u51e0\u4e2a\u53c2\u6570\u51b3\u5b9a</p> <pre><code>#autovacuum = on                        # Enable autovacuum subprocess?  'on'\n#autovacuum_vacuum_threshold = 50       # min number of row updates before vacuum\n#autovacuum_analyze_threshold = 50      # min number of row updates before analyze\n#autovacuum_vacuum_scale_factor = 0.2   # fraction of table size before vacuum\n#autovacuum_analyze_scale_factor = 0.1  # fraction of table size before analyze\n#autovacuum_freeze_max_age = 200000000 # maximum XID age before forced vacuum\n</code></pre> <p>\u5927\u6982\u610f\u601d \u5f53\u8868\u4e2d\u7684\u6570\u636e\u66f4\u65b0\u4e3a\u603b\u6570\u91cf\u768420% \u662f\u89e6\u53d1\u5783\u573e\u56de\u6536\uff0c\u4f46\u662f\u5f53\u8868\u4e2d\u603b\u6570\u91cf\u5c0f\u4e8e50\u7684\u65f6\u501920%\u6765\u7684\u592a\u5bb9\u6613\u4e86\uff0c</p> <p>\u8fd9\u6837\u5c31\u4f1a\u8fc7\u4e8e\u9891\u7e41\u7684\u6ee1\u8db3\u89e6\u53d1\u6761\u4ef6\u3002\u4e8e\u662f50\u5c31\u76f8\u5f53\u4e8e\u4e00\u4e2a\u6700\u4f4e\u95e8\u69db\u3002\u8868\u4e2d\u603b\u6570\u91cf\u572850\u4ee5\u5185\u7684\u5c31\u6682\u65f6\u4e0d\u89e6\u53d1\u5783\u573e\u56de\u6536\u4e86\u3002</p> <ul> <li>threshold = pg_class.reltuples*autovacuum_vacuum_scale_factor+autovacuum_vacuum_threshold</li> </ul> <p>\u5373\uff1aif (\u5f53\u524d\u8868\u66f4\u65b0\u6570&gt; \u89e6\u53d1\u9600\u503c) do ...</p>"},{"location":"postgres/troubleshooting/auto_vacuum_trigger/#_2","title":"\u7b49\u53f7\u53f3\u8fb9\u7684\u7406\u89e3","text":"<pre><code>-- \u89e6\u53d1\u81ea\u52a8analyze\npg_class.reltuples*autovacuum_analyze_scale_factor+autovacuum_analyze_threshold\n-- \u89e6\u53d1\u81ea\u52a8autovacuum\npg_class.reltuples*autovacuum_vacuum_scale_factor+autovacuum_vacuum_threshold\n</code></pre> <p>\u4e24\u4e2a\u516c\u5f0f\u76f8\u4f3c\u3002\u5176\u4e2d\u7684\u503c\u90fd\u9664\u4e86pg_class.reltuples \u4ee5\u5916\u90fd\u662f\u6765\u81ea\u4e8e\u914d\u7f6e</p> <p>pg_class.reltuples \u6765\u81ea\u7cfb\u7edf\u7edf\u8ba1\u8868\uff0c\u5728analyze \u540e\u66f4\u65b0\u3002</p> <p>\u6240\u4ee5\u901a\u5e38\u914d\u7f6e\u89e6\u53d1\u53c2\u6570\u65f6\uff0c\u5c3d\u91cf\u5c06analyze \u89e6\u53d1\u6761\u4ef6\u8981\u66f4\u654f\u611f\u6027\u3002</p> <p>\u6d4b\u8bd5\u53c2\u8003</p>"},{"location":"postgres/troubleshooting/auto_vacuum_trigger/#_3","title":"\u601d\u8003\u7684\u662f\u7b49\u53f7\u5de6\u8fb9\u7684\u4e8b\u60c5","text":"<p>\u6570\u636e\u5e93\u662f\u5982\u4f55\u77e5\u9053\u5f53\u524d\u66f4\u65b0\u7684\u6570\u91cf, \u6309\u7167\u5df2\u6709\u7684\u7ecf\u9a8c\uff08\u7ecf\u9a8c\u4e0d\u8db3\uff09\u3002</p> <p>\u4e00\u822c\u6570\u636e\u5e93\u4e2d\u8fd9\u79cd\u4fe1\u606f\u662f\u5b58\u5728\u7684\u7edf\u8ba1\u7c7b\u4fe1\u606f\u4e2d\u3002\u4f46\u662f\u7edf\u8ba1\u4fe1\u606f\u901a\u5e38\u662f\u5728analyze\u540e\u66f4\u65b0\u7684\u3002\u6839\u636e\u4e0a\u9762\u7684\u516c\u5f0f\u89e6\u53d1analyze\u7684\u6761\u4ef6\u53c8\u662f\u7531\u5f53\u524d\u8868\u66f4\u65b0\u6570\u6709\u5173\u3002</p> <p>\u4e8e\u662f\u4e4e\u5c31\u9677\u5165\u4e86\u4e00\u79cd\u5faa\u73af\u267b\ufe0f   \u3002</p> <p>1 \u8868\u66f4\u65b0\u6570\u91cf -&gt; analyze</p> <p>2 analyze  \u2014&gt; \u7edf\u8ba1\u4fe1\u606f </p> <p>3 \u7edf\u8ba1\u4fe1\u606f -&gt; \u8868\u66f4\u65b0\u6570\u91cf  </p> <p>\u90a3\u662f\u5148\u6709\u9e21\u8fd8\u662f\u5148\u6709\u86cb\u5462\uff1f</p> <p>\u53ea\u6709\u7ee7\u7eed\u601d\u8003\u624d\u80fd\u627e\u5230\u4e8b\u60c5\u7684\u771f\u76f8\u3002\u3002\u3002</p> <p>\u9996\u5148\u8868\u4e2d\u66f4\u65b0\u7684\u6570\u636e\u91cf\u7edf\u8ba1\u5e94\u8be5\u662f\u4e00\u4e2a\u5f88\u8f7b\u91cf\u5feb\u901f\u7684\u65b9\u6cd5\u3002\u7c7b\u4f3c\u4e8e\u8ba1\u6570\u5668\u5b9e\u73b0,\u5e76\u4e14\u72ec\u7acb\u4e8e\u4f20\u7edf\u7684\u7edf\u8ba1\u4fe1\u606f\u3002\u63a5\u4e0b\u6765\u5728\u6570\u636e\u5e93\u5f00\u59cb\u5bfb\u627e\u8fd9\u79cd\u8ba1\u6570\u5668\u3002</p>"},{"location":"postgres/troubleshooting/auto_vacuum_trigger/#_4","title":"\u771f\u76f8","text":"<p>\u2018\u8ba1\u6570\u5668\u2019 \u662f\u6709stats collector \u8fdb\u7a0b\u6765\u7ef4\u62a4\u3002 \u5f53\u6570\u636e\u5e93\u8fdb\u884cdml\u64cd\u4f5c\u65f6\uff0cstats collector \u8fdb\u884c\u5b9e\u65f6\u8ba1\u6570\u7edf\u8ba1\u3002\u8be5\u503c\u5b58\u5728\u4e8epg_stat_all_table \u4e2d</p> <p>\u67e5\u770bpg_stats_all_table \u8868\u5b9a\u4e49</p> <pre><code>postgres=# \\d+ pg_stat_all_tables \n                           \u89c6\u56fe \"pg_catalog.pg_stat_all_tables\"\n        \u680f\u4f4d         |           \u7c7b\u578b           | \u6821\u5bf9\u89c4\u5219 | \u53ef\u7a7a\u7684 | \u9884\u8bbe | \u5b58\u50a8  | \u63cf\u8ff0 \n---------------------+--------------------------+----------+--------+------+-------+------\n relid               | oid                      |          |        |      | plain | \n schemaname          | name                     |          |        |      | plain | \n relname             | name                     |          |        |      | plain | \n seq_scan            | bigint                   |          |        |      | plain | \n seq_tup_read        | bigint                   |          |        |      | plain | \n idx_scan            | bigint                   |          |        |      | plain | \n idx_tup_fetch       | bigint                   |          |        |      | plain | \n n_tup_ins           | bigint                   |          |        |      | plain | \n n_tup_upd           | bigint                   |          |        |      | plain | \n n_tup_del           | bigint                   |          |        |      | plain | \n n_tup_hot_upd       | bigint                   |          |        |      | plain | \n n_live_tup          | bigint                   |          |        |      | plain | \n n_dead_tup          | bigint                   |          |        |      | plain | \n n_mod_since_analyze | bigint                   |          |        |      | plain | \n last_vacuum         | timestamp with time zone |          |        |      | plain | \n last_autovacuum     | timestamp with time zone |          |        |      | plain | \n last_analyze        | timestamp with time zone |          |        |      | plain | \n last_autoanalyze    | timestamp with time zone |          |        |      | plain | \n vacuum_count        | bigint                   |          |        |      | plain | \n autovacuum_count    | bigint                   |          |        |      | plain | \n analyze_count       | bigint                   |          |        |      | plain | \n autoanalyze_count   | bigint                   |          |        |      | plain | \n\u89c6\u56fe\u5b9a\u4e49:\n SELECT c.oid AS relid,\n    n.nspname AS schemaname,\n    c.relname,\n    pg_stat_get_numscans(c.oid) AS seq_scan,\n    pg_stat_get_tuples_returned(c.oid) AS seq_tup_read,\n    sum(pg_stat_get_numscans(i.indexrelid))::bigint AS idx_scan,\n    sum(pg_stat_get_tuples_fetched(i.indexrelid))::bigint + pg_stat_get_tuples_fetched(c.oid) AS idx_tup_fetch,\n    pg_stat_get_tuples_inserted(c.oid) AS n_tup_ins,\n    pg_stat_get_tuples_updated(c.oid) AS n_tup_upd,\n    pg_stat_get_tuples_deleted(c.oid) AS n_tup_del,\n    pg_stat_get_tuples_hot_updated(c.oid) AS n_tup_hot_upd,\n    pg_stat_get_live_tuples(c.oid) AS n_live_tup,\n    pg_stat_get_dead_tuples(c.oid) AS n_dead_tup,\n    pg_stat_get_mod_since_analyze(c.oid) AS n_mod_since_analyze,\n    pg_stat_get_last_vacuum_time(c.oid) AS last_vacuum,\n    pg_stat_get_last_autovacuum_time(c.oid) AS last_autovacuum,\n    pg_stat_get_last_analyze_time(c.oid) AS last_analyze,\n    pg_stat_get_last_autoanalyze_time(c.oid) AS last_autoanalyze,\n    pg_stat_get_vacuum_count(c.oid) AS vacuum_count,\n    pg_stat_get_autovacuum_count(c.oid) AS autovacuum_count,\n    pg_stat_get_analyze_count(c.oid) AS analyze_count,\n    pg_stat_get_autoanalyze_count(c.oid) AS autoanalyze_count\n   FROM pg_class c\n     LEFT JOIN pg_index i ON c.oid = i.indrelid\n     LEFT JOIN pg_namespace n ON n.oid = c.relnamespace\n  WHERE c.relkind = ANY (ARRAY['r'::\"char\", 't'::\"char\", 'm'::\"char\"])\n  GROUP BY c.oid, n.nspname, c.relname;\n</code></pre> <p>\u539f\u6765\u662f\u8868oid\u4e0a\u5404\u79cd\u7ef4\u5ea6\u7684\u8ba1\u6570\u5668\uff0c</p> <p>\u67e5\u770bpg_class \u7ed3\u6784</p> <pre><code>postgres=# \\d+ pg_class\n                                 \u6570\u636e\u8868 \"pg_catalog.pg_class\"\n        \u680f\u4f4d         |     \u7c7b\u578b     | \u6821\u5bf9\u89c4\u5219 |  \u53ef\u7a7a\u7684  | \u9884\u8bbe |   \u5b58\u50a8   | \u7edf\u8ba1\u76ee\u6807 | \u63cf\u8ff0 \n---------------------+--------------+----------+----------+------+----------+----------+------\n relname             | name         |          | not null |      | plain    |          | \n relnamespace        | oid          |          | not null |      | plain    |          | \n reltype             | oid          |          | not null |      | plain    |          | \n reloftype           | oid          |          | not null |      | plain    |          | \n relowner            | oid          |          | not null |      | plain    |          | \n relam               | oid          |          | not null |      | plain    |          | \n relfilenode         | oid          |          | not null |      | plain    |          | \n reltablespace       | oid          |          | not null |      | plain    |          | \n relpages            | integer      |          | not null |      | plain    |          | \n reltuples           | real         |          | not null |      | plain    |          | \n relallvisible       | integer      |          | not null |      | plain    |          | \n reltoastrelid       | oid          |          | not null |      | plain    |          | \n relhasindex         | boolean      |          | not null |      | plain    |          | \n relisshared         | boolean      |          | not null |      | plain    |          | \n relpersistence      | \"char\"       |          | not null |      | plain    |          | \n relkind             | \"char\"       |          | not null |      | plain    |          | \n relnatts            | smallint     |          | not null |      | plain    |          | \n relchecks           | smallint     |          | not null |      | plain    |          | \n relhasoids          | boolean      |          | not null |      | plain    |          | \n relhaspkey          | boolean      |          | not null |      | plain    |          | \n relhasrules         | boolean      |          | not null |      | plain    |          | \n relhastriggers      | boolean      |          | not null |      | plain    |          | \n relhassubclass      | boolean      |          | not null |      | plain    |          | \n relrowsecurity      | boolean      |          | not null |      | plain    |          | \n relforcerowsecurity | boolean      |          | not null |      | plain    |          | \n relispopulated      | boolean      |          | not null |      | plain    |          | \n relreplident        | \"char\"       |          | not null |      | plain    |          | \n relispartition      | boolean      |          | not null |      | plain    |          | \n relfrozenxid        | xid          |          | not null |      | plain    |          | \n relminmxid          | xid          |          | not null |      | plain    |          | \n relacl              | aclitem[]    |          |          |      | extended |          | \n reloptions          | text[]       |          |          |      | extended |          | \n relpartbound        | pg_node_tree |          |          |      | extended |          | \n\u7d22\u5f15\uff1a\n    \"pg_class_oid_index\" UNIQUE, btree (oid)\n    \"pg_class_relname_nsp_index\" UNIQUE, btree (relname, relnamespace)\n    \"pg_class_tblspc_relfilenode_index\" btree (reltablespace, relfilenode)\n\u6709 OIDs:yes\n</code></pre> <p>pg_class \u4e2d\u7684\u4fe1\u606f\u662fanalyze \u64cd\u4f5c\u540e\u66f4\u65b0\uff0c\u800c\u8ba1\u6570\u5668\u662foid\u4e0a\u4e0d\u540c\u7ef4\u5ea6\u7684\u7edf\u8ba1\u3002</p> <p>\u7edf\u8ba1\u7ef4\u5ea6\u8bbe\u7f6e</p> <pre><code>#------------------------------------------------------------------------------\n# STATISTICS\n#------------------------------------------------------------------------------\n\n# - Query and Index Statistics Collector -\n\n#track_activities = on\n#track_counts = on\n#track_io_timing = off\n#track_functions = none                 # none, pl, all\n#track_activity_query_size = 1024       # (change requires restart)\n#stats_temp_directory = 'pg_stat_tmp  \u7edf\u8ba1\u4fe1\u606f\u5b58\u653e\u4f4d\u7f6e\n</code></pre> <pre><code>tree pg_stat_tmp/\npg_stat_tmp/\n\u251c\u2500\u2500 db_0.stat\n\u251c\u2500\u2500 db_14187.stat\n\u251c\u2500\u2500 db_16384.stat\n\u251c\u2500\u2500 db_20579.stat\n\u2514\u2500\u2500 global.stat\n</code></pre> <p>\u601d\u8003-&gt;\u8ff7\u60d1-&gt;\u5bfb\u627e\u7b54\u6848-&gt;\u65e5\u6e10\u6e05\u6670 \uff0c\u65e5\u8fdb\u4e00\u6b65</p> <p>pg_statistic \u91cc\u9762\u7684\u5185\u5bb9\u592a\u4e30\u5bcc\u4e86...</p>"},{"location":"postgres/troubleshooting/awsome-postgres/","title":"\u5de5\u4f5c\u4e2d\u6240\u4f7f\u7528\u7684postgres","text":"<p>Postgres \u5b9e\u9645\u5e94\u7528\u6982\u89c8</p> <ul> <li>MVCC \u591a\u7248\u672c\u63a7\u5236 </li> </ul> <p>\u4e00\u4e2a\u7ed5\u4e0d\u5f00\u7684\u8bdd\u9898\uff0c \u4e3b\u8981\u662f\u5bf9\u6297\u8868\u7a7a\u95f4\u7684\u81a8\u80c0\u3002\u89e3\u51b3\u5783\u573e\u56de\u6536\u95ee\u9898\uff0c\u4e3b\u4ece\u5e93\u4e4b\u95f4\u4ece\u5e93\u67e5\u8be2\u51b2\u7a81\u95ee\u9898\u3002</p> <p>\u76ee\u524d\u65b9\u6cd5\u6bcf\u65e5\u4f4e\u5cf0\u671f\u5b9a\u65f6 vaccum \uff0cgocron\u81ea\u5b9a\u5b9a\u65f6\u4efb\u52a1 \u3002 \u6839\u636epgstattuple\u5bf9\u78c1\u76d8\u7a7a\u95f4\u5229\u7528\u7387\u8fdb\u884c\u5206\u6790\u3002\u51b3\u5b9a\u662f\u5426vaccum full ,pg_repack</p> <ul> <li>\u6d41\u590d\u5236</li> </ul> <p>\u4e3b\u4ece\u590d\u5236\uff0c\u8bfb\u5199\u5206\u79bb\u7684\u57fa\u7840\u3002\u4e94\u79cd\u540c\u6b65\u65b9\u5f0f</p> <ul> <li>\u903b\u8f91\u8ba2\u9605</li> </ul> <p>\u5927\u7248\u672c\u5347\u7ea7\uff0c\u6570\u636e\u5e76\u5f52\u3002\u8fc1\u79fb</p> <ul> <li>\u6267\u884c\u8ba1\u5212\u8c03\u4f18</li> </ul> <p>\u8c03\u8282\u6210\u672c\u56e0\u5b50\u6bd4\u4f8b\uff0c\u5982\u4e0d\u540c\u7684\u78c1\u76d8\u7c7b\u578b\u6bd4\u4f8b\u6709\u6240\u533a\u522b</p> <ul> <li>\u53c2\u6570\u8c03\u4f18</li> </ul> <p>\u4e3b\u673a \u548c \u670d\u52a1</p> <ul> <li>\u5206\u533a\u8868</li> </ul> <p>\u91c7\u7528pg_pathman ,\u56e0\u4e3a\u90fd\u662f\u6839\u636e\u4e1a\u52a1\u6570\u636e\u91cf\u6765\u51b3\u5b9a\u662f\u5426\u5206\u533a\u3002pg_pathman \u80fd\u591f\u4e0d\u505c\u670d\u7684\u524d\u63d0\u4e0b\u81ea\u52a8\u5206\u533a\u6570\u636e\u3002</p> <ul> <li>\u9ad8\u53ef\u7528</li> </ul> <p>patroni</p> <ul> <li>\u5206\u8868</li> </ul> <p>citus \u6ce8\u610f\u4eb2\u548c\u6027 \u548c\u8868\u4e4b\u95f4\u7684join ddl \u7b49\u9650\u5236\u3002</p> <ul> <li>\u76d1\u63a7\uff0c\u65e5\u5fd7</li> </ul> <p>promethues \u5957\u4ef6\uff0c\u81ea\u5b9a\u4e49\u76d1\u63a7\u9879 \u3002 filebeat elasticsearch kibana \u65e5\u5fd7\u6536\u96c6</p> <ul> <li>\u7edf\u8ba1</li> </ul> <p>\u7ed3\u5408\u6570\u636e\u5e93\u81ea\u5e26\u7684\u7edf\u8ba1\u4fe1\u606f\u53capg_stat_statements \u63d2\u4ef6\u751f\u4ea7\u62a5\u8868</p> <ul> <li>\u538b\u6d4b</li> </ul> <p>pg_bench ,\u81ea\u5b9a\u4e49sql</p> <ul> <li>\u5907\u4efd\u6062\u590d</li> </ul> <p>wal-g \u5168\u91cf\u548c\u5b9e\u65f6\u589e\u91cf</p> <ul> <li>\u8fde\u63a5\u6c60</li> </ul> <p>pgbounch \u4e3b\u8981\u7528\u4e8e\u5206\u8868\u4e2d\u5404\u4e2a\u670d\u52a1\u4e4b\u95f4</p> <ul> <li>FDW</li> </ul>"},{"location":"postgres/troubleshooting/debezium/","title":"\u5229\u7528debezium \u5b9e\u73b0\u6570\u636e\u53d8\u66f4\u6355\u83b7","text":"<p>\u6574\u4e2a\u5b9e\u73b0\u4ee5\u529f\u80fd\u6f14\u793a\u4e3a\u76ee\u6807\uff0c\u4fbf\u4e8e\u6d41\u7a0b\u7684\u68b3\u7406\u548c\u7406\u89e3\u3002\u4e0d\u9002\u5408\u6b63\u5f0f\u751f\u6210\u73af\u5883\u4f7f\u7528\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#debezium","title":"debezium\u7684\u51e0\u79cd\u4f7f\u7528\u65b9\u5f0f","text":"<ul> <li>\u5355\u72ec\u90e8\u7f72 \u4e0b\u6e38\u6570\u636e\u4f20\u8f93\u5230cloud\uff0c\u5b98\u65b9\u76ee\u524d\u4e0d\u63a8\u8350</li> <li>\u4e0ekafka\u8054\u5408\u4f7f\u7528 \u4e0b\u6e38\u6570\u636e\u4f20\u8f93\u5230kafka</li> <li>\u5d4c\u5165\u5f0f \u4f8b\u5982Flink\u4f7f\u7528\u7684debezium\u4f5c\u4e3a\u6570\u636e\u7684source connetor\u6a21\u5757\u4f7f\u7528\uff0c\u5c06\u6570\u636e\u63a5\u5165\u5230Flink\u4e2d</li> </ul> <p>\u8fd9\u91cc\u4f7f\u7528\u4e0ekafka\u8054\u5408\u4f7f\u7528\u7684\u65b9\u5f0f\uff0c\u5c06\u6e90\u7aef\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u53ca\u53d8\u66f4\u5bfc\u5165\u5230kafka\u4e2d\uff0c\u6765\u63d0\u4f9b\u4e0b\u6e38\u4f7f\u7528\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#mysql-cdc","title":"mysql cdc","text":"<p>\u6e90\u7aef\u6570\u636e\u5e93\u4e3amysql\uff0c \u5229\u7528Debezium \u6355\u83b7mysql\u6570\u636e\u53ca\u53d8\u5316\uff0c\u5e76\u5b9e\u65f6\u5bfc\u5165\u5230kafka\u4e2d\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#topology","title":"Topology","text":"<pre><code>                   +-------------+\n                   |             |\n                   |    MySQL    |\n                   |             |\n                   +------+------+\n                          |\n                          |\n                          |\n          +---------------v------------------+\n          |                                  |\n          |           Kafka Connect          |\n          |  (Debezium, JDBC connectors)     |\n          |                                  |\n          +---------------+------------------+\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_1","title":"\u542f\u52a8\u670d\u52a1","text":"<pre><code>-- \u542f\u52a8zk\ndocker run -it --rm --name zookeeper -p 2181:2181 -p 2888:2888 -p 3888:3888 quay.io/debezium/zookeeper:1.9\n\n-- \u542f\u52a8kafka\ndocker run -it --rm --name kafka -p 9092:9092 --link zookeeper:zookeeper quay.io/debezium/kafka:1.9\n\n-- \u542f\u52a8mysql\ndocker run -it --rm --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=debezium -e MYSQL_USER=mysqluser -e MYSQL_PASSWORD=mysqlpw quay.io/debezium/example-mysql:1.9\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_2","title":"\u8bbf\u95ee\u6e90\u6570\u636e\u5e93","text":"<pre><code>-- \u5229\u7528mysql client \u767b\u5f55mysql\u6570\u636e\u5e93\ndocker run -it --rm --name mysqlterm --link mysql --rm mysql:8.0 sh -c 'exec mysql -h\"$MYSQL_PORT_3306_TCP_ADDR\" -P\"$MYSQL_PORT_3306_TCP_PORT\" -uroot -p\"$MYSQL_ENV_MYSQL_ROOT_PASSWORD\"'\nmysql&gt; use inventory;\nmysql&gt; show tables;\n+---------------------+\n| Tables_in_inventory |\n+---------------------+\n| addresses           |\n| customers           |\n| geom                |\n| orders              |\n| products            |\n| products_on_hand    |\n+---------------------+\nmysql&gt; SELECT * FROM customers;\n+------+------------+-----------+-----------------------+\n| id   | first_name | last_name | email                 |\n+------+------------+-----------+-----------------------+\n| 1001 | Sally      | Thomas    | sally.thomas@acme.com |\n| 1002 | George     | Bailey    | gbailey@foobar.com    |\n| 1003 | Edward     | Walker    | ed@walker.com         |\n| 1004 | Anne       | Kretchmar | annek@noanswer.org    |\n+------+------------+-----------+-----------------------+\n4 rows in set (0.00 sec)\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#kafka-connect","title":"\u542f\u52a8kafka connect","text":"<pre><code>\u542f\u52a8\ndocker run -it --rm --name connect -p 8083:8083 -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses --link zookeeper:zookeeper --link kafka:kafka --link mysql:mysql quay.io/debezium/connect:1.9\n\u9a8c\u8bc1\ncurl -H \"Accept:application/json\" localhost:8083/\n{\"version\":\"3.2.0\",\"commit\":\"cb8625948210849f\"} \n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#mysql-source-connector","title":"\u6ce8\u518c MySQL source connector","text":"<pre><code>-- \u6ce8\u518c\n$ curl -i -X POST -H \"Accept:application/json\" -H \"Content-Type:application/json\" localhost:8083/connectors/ -d '{ \"name\": \"inventory-connector\", \"config\": { \"connector.class\": \"io.debezium.connector.mysql.MySqlConnector\", \"tasks.max\": \"1\", \"database.hostname\": \"mysql\", \"database.port\": \"3306\", \"database.user\": \"debezium\", \"database.password\": \"dbz\", \"database.server.id\": \"184054\", \"database.server.name\": \"dbserver1\", \"database.include.list\": \"inventory\", \"database.history.kafka.bootstrap.servers\": \"kafka:9092\", \"database.history.kafka.topic\": \"dbhistory.inventory\" } }'\n\n-- \u67e5\u770b\u6ce8\u518c\u7684connector \u60c5\u51b5\n$ curl -H \"Accept:application/json\" localhost:8083/connectors/\n$ curl -H  \"Content-Type:application/json\" http://localhost:8083/connectors/inventory-connector | jq\n$ curl -H  \"Content-Type:application/json\" http://localhost:8083/connectors/inventory-connector/status | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#change-events","title":"\u89c2\u5bdf change events","text":"<p>\u200b       \u8fd9\u91cc\u53ef\u4ee5\u5bf9mysql\u6570\u636e\u8fdb\u884cdml\u64cd\u4f5c\uff0c\u5b9e\u65f6\u89c2\u5bdf\u6570\u636e\u53d8\u66f4\u6355\u83b7\u60c5\u51b5</p> <pre><code>$ docker run -it --rm --name watcher --link zookeeper:zookeeper --link kafka:kafka quay.io/debezium/kafka:1.9 watch-topic -a -k dbserver1.inventory.customers\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#postgres-cdc","title":"postgres cdc","text":"<p>\u6e90\u7aef\u6570\u636e\u5e93\u4e3apostgres\uff0c \u5229\u7528Debezium \u6355\u83b7postgres\u6570\u636e\u53ca\u53d8\u5316\uff0c\u5e76\u5b9e\u65f6\u5bfc\u5165\u5230kafka\u4e2d\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#topology_1","title":"Topology","text":"<pre><code>                   +-------------+\n                   |             |\n                   |    MySQL    |\n                   |             |\n                   +------+------+\n                          |\n                          |\n                          |\n          +---------------v------------------+\n          |                                  |\n          |           Kafka Connect          |\n          |  (Debezium, JDBC connectors)     |\n          |                                  |\n          +---------------+------------------+\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_3","title":"\u914d\u7f6e\u6587\u4ef6\u51c6\u5907","text":"<p>\u8fd9\u91cc\u5229\u7528docker-compose \u4e00\u952e\u542f\u52a8\u6240\u6709\u670d\u52a1</p> <ul> <li>docker-compost-postgres.yaml</li> <li>register-postgres.json </li> </ul> <p>docker-compost-postgres.yaml</p> <pre><code>version: '2'\nservices:\n  zookeeper:\n    image: quay.io/debezium/zookeeper:${DEBEZIUM_VERSION}\n    ports:\n     - 2181:2181\n     - 2888:2888\n     - 3888:3888\n  kafka:\n    image: quay.io/debezium/kafka:${DEBEZIUM_VERSION}\n    ports:\n     - 9092:9092\n    links:\n     - zookeeper\n    environment:\n     - ZOOKEEPER_CONNECT=zookeeper:2181\n  postgres:\n    image: quay.io/debezium/example-postgres:${DEBEZIUM_VERSION}\n    ports:\n     - 5432:5432\n    environment:\n     - POSTGRES_USER=postgres\n     - POSTGRES_PASSWORD=postgres\n  connect:\n    image: quay.io/debezium/connect:${DEBEZIUM_VERSION}\n    ports:\n     - 8083:8083\n    links:\n     - kafka\n#     - postgres\n    environment:\n     - BOOTSTRAP_SERVERS=kafka:9092\n     - GROUP_ID=1\n     - CONFIG_STORAGE_TOPIC=my_connect_configs\n     - OFFSET_STORAGE_TOPIC=my_connect_offsets\n     - STATUS_STORAGE_TOPIC=my_connect_statuses\n# For testing newer connector versions, unpack the connector archive into this\n# directory and uncomment the lines below\n#    volumes:\n#     - ./debezium-connector-postgres:/kafka/connect/debezium-connector-postgres\n</code></pre> <p>\u200b      register-postgres.json</p> <pre><code>{\n    \"name\": \"inventory-connector\",\n    \"config\": {\n        \"connector.class\": \"io.debezium.connector.postgresql.PostgresConnector\",\n        \"tasks.max\": \"1\",\n        \"database.hostname\": \"postgres\",\n        \"database.port\": \"5432\",\n        \"database.user\": \"postgres\",\n        \"database.password\": \"postgres\",\n        \"database.dbname\" : \"postgres\",\n        \"database.server.name\": \"dbserver1\",\n        \"schema.include.list\": \"inventory\"\n    }\n}\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_4","title":"\u5f00\u59cb\u6d4b\u8bd5","text":"<pre><code>export DEBEZIUM_VERSION=1.9\n# \u4e00\u952e\u542f\u52a8\u6240\u6709\u670d\u52a1\ndocker-compose -f docker-compose-postgres.yaml up\n\n# Start Postgres connector\ncurl -i -X POST -H \"Accept:application/json\" -H  \"Content-Type:application/json\" http://localhost:8083/connectors/ -d @register-postgres.json\n\n# Consume messages from a Debezium topic\ndocker-compose -f docker-compose-postgres.yaml exec kafka /kafka/bin/kafka-console-consumer.sh \\\n    --bootstrap-server kafka:9092 \\\n    --from-beginning \\\n    --property print.key=true \\\n    --topic dbserver1.inventory.customers\n\n# Modify records in the database via Postgres client\ndocker-compose -f docker-compose-postgres.yaml exec postgres env PGOPTIONS=\"--search_path=inventory\" bash -c 'psql -U $POSTGRES_USER postgres'\n\n# Shut down the cluster\ndocker-compose -f docker-compose-postgres.yaml down\n\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#postgres-sourcer-connetor","title":"postgres sourcer connetor","text":"<p>\u533a\u522b\u4e0e\u5b98\u65b9\u63d0\u4f9b\u7684pg docker \u955c\u50cf</p> <p>\u200b   \u5b98\u65b9\u4e2d\u7684pg\u955c\u50cf\u903b\u8f91\u89e3\u7801\u4f7f\u7528\u7684\u662fdecoderbufs\uff0cwal2jon\u3002\u5bf9\u4e8epg\u7248\u672c10+ \u66f4\u63a8\u8350\u4f7f\u7528 logical \u3002\u5e76\u5229\u7528pgoutput\u8fdb\u884c\u89e3\u6790 </p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_5","title":"\u914d\u7f6e\u7ba1\u7406","text":"<p>pg</p> <pre><code>wal_level = logical\n</code></pre> <p>\u200b      \u62e5\u6709repication \u6743\u9650\u8bbf\u95ee\u6570\u636e\u5e93\u7684\u7528\u6237\uff0c\u8fd9\u91cc\u4f7f\u7528\u8d85\u7ea7\u7528\u6237postgres </p> <p>docker-compose-postgres.yaml</p> <p>\u52a0\u5165kakfa-ui \u8bbf\u95eeIP:8080 </p> <p>``` version: '2' services:   zookeeper:     image: quay.io/debezium/zookeeper:${DEBEZIUM_VERSION}     ports:      - 2181:2181      - 2888:2888      - 3888:3888   kafka:     image: quay.io/debezium/kafka:${DEBEZIUM_VERSION}     ports:      - 9092:9092     links:      - zookeeper     environment:      - ZOOKEEPER_CONNECT=zookeeper:2181   kafka-ui:     image: provectuslabs/kafka-ui:latest      ports:      - 8080:8080     links:      - kafka:kakfa     environment:      - KAFKA_CLUSTERS_0_NAME=mykafka      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092   connect:     image: quay.io/debezium/connect:${DEBEZIUM_VERSION}     ports:      - 8083:8083     links:      - kafka     environment:      - BOOTSTRAP_SERVERS=kafka:9092      - GROUP_ID=1      - CONFIG_STORAGE_TOPIC=my_connect_configs      - OFFSET_STORAGE_TOPIC=my_connect_offsets      - STATUS_STORAGE_TOPIC=my_connect_statuses</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#for-testing-newer-connector-versions-unpack-the-connector-archive-into-this","title":"For testing newer connector versions, unpack the connector archive into this","text":"","tags":[]},{"location":"postgres/troubleshooting/debezium/#directory-and-uncomment-the-lines-below","title":"directory and uncomment the lines below","text":"","tags":[]},{"location":"postgres/troubleshooting/debezium/#volumes","title":"volumes:","text":"","tags":[]},{"location":"postgres/troubleshooting/debezium/#-debezium-connector-postgreskafkaconnectdebezium-connector-postgres","title":"- ./debezium-connector-postgres:/kafka/connect/debezium-connector-postgres","text":"<p>```</p> <p>register-postgres.json</p> <pre><code>{\n    \"name\": \"inventory-connector\",\n    \"config\": {\n        \"connector.class\": \"io.debezium.connector.postgresql.PostgresConnector\",\n        \"database.hostname\": \"postgres\",\n        \"database.port\": \"5432\",\n        \"database.user\": \"postgres\",\n        \"database.password\": \"postgres\",\n        \"database.dbname\": \"postgres\",\n        \"database.server.name\": \"debezium\",\n        \"slot.name\": \"inventory_slot\",\n        \"table.include.list\": \"inventory.orders,inventory.products\",\n        \"publication.name\": \"dbz_inventory_connector\",\n        \"publication.autocreate.mode\": \"all_tables\",\n        \"plugin.name\": \"pgoutput\",  \n            \"topic.creation.default.replication.factor\": 3,\n            \"topic.creation.default.partitions\": 10,\n            \"topic.creation.default.cleanup.policy\": \"delete\",\n            \"topic.creation.default.compression.type\": \"lz4\"\n    }\n}\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u8bf4\u660e</p> <p>https://debezium.io/documentation/reference/1.9/connectors/postgresql.html#postgresql-required-configuration-properties</p> \u5b57\u6bb5\u540d\u79f0 \u63cf\u8ff0 connector.class connector\u7684\u5b9e\u73b0\u7c7b\uff0c\u672c\u6587\u4f7f\u7528\u7684\u662fio.debezium.connector.postgresql.PostgresConnector\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u6570\u636e\u5e93\u662fPostgreSQL database.hostname \u6570\u636e\u5e93\u670d\u52a1\u7684IP\u6216\u57df\u540d database.port \u6570\u636e\u5e93\u670d\u52a1\u7684\u7aef\u53e3 database.user \u8fde\u63a5\u6570\u636e\u5e93\u7684\u7528\u6237 database.password \u8fde\u63a5\u6570\u636e\u5e93\u7684\u5bc6\u7801 database.dbname \u6570\u636e\u5e93\u540d database.server.name \u6bcf\u4e2a\u88ab\u76d1\u63a7\u7684\u8868\u5728Kafka\u90fd\u4f1a\u5bf9\u5e94\u4e00\u4e2atopic\uff0ctopic\u7684\u547d\u540d\u89c4\u8303\u662f<code>&lt;database.server.name&gt;.&lt;schema&gt;.&lt;table&gt;</code> slot.name PostgreSQL\u7684\u590d\u5236\u69fd(Replication Slot)\u540d\u79f0 table.include.list \u5982\u679c\u8bbe\u7f6e\u4e86table.include.list\uff0c\u5373\u5728\u8be5list\u4e2d\u7684\u8868\u624d\u4f1a\u88abDebezium\u76d1\u63a7 plugin.name PostgreSQL\u670d\u52a1\u7aef\u5b89\u88c5\u7684\u89e3\u7801\u63d2\u4ef6\u540d\u79f0\uff0c\u53ef\u4ee5\u662fdecoderbufs, wal2json, wal2json_rds, wal2json_streaming, wal2json_rds_streaming \u548c  pgoutput\u3002\u5982\u679c\u4e0d\u6307\u5b9a\u8be5\u503c\uff0c\u5219\u9ed8\u8ba4\u4f7f\u7528decoderbufs\u3002   \u672c\u4f8b\u5b50\u4e2d\u4f7f\u7528\u4e86pgoutput\uff0c\u56e0\u4e3a\u5b83\u662fPostgreSQL 10+\u81ea\u5e26\u7684\u89e3\u7801\u5668\uff0c\u800c\u5176\u4ed6\u89e3\u7801\u5668\u90fd\u5fc5\u987b\u5728PostgreSQL\u670d\u52a1\u5668\u5b89\u88c5\u63d2\u4ef6\u3002 publication.name PostgreSQL\u7aef\u7684WAL\u53d1\u5e03(publication)\u540d\u79f0\uff0c\u6bcf\u4e2aConnector\u90fd\u5e94\u8be5\u5728PostgreSQL\u6709\u81ea\u5df1\u5bf9\u5e94\u7684publication\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u8be5\u53c2\u6570\uff0c\u90a3\u4e48publication\u7684\u540d\u79f0\u4e3adbz_publication publication.autocreate.mode \u8be5\u503c\u5728plugin.name\u8bbe\u7f6e\u4e3apgoutput\u624d\u4f1a\u6709\u6548\u3002\u6709\u4ee5\u4e0b\u4e09\u4e2a\u503c\uff1a  all_tables - debezium\u4f1a\u68c0\u67e5publication\u662f\u5426\u5b58\u5728\uff0c\u5982\u679cpublication\u4e0d\u5b58\u5728\uff0cconnector\u5219\u4f7f\u7528\u811a\u672cCREATE  PUBLICATION  FOR ALL  TABLES\u521b\u5efapublication\uff0c\u5373\u8be5\u53d1\u5e03\u8005\u4f1a\u76d1\u63a7\u6240\u6709\u8868\u7684\u53d8\u66f4\u60c5\u51b5\u3002  disabled - connector\u4e0d\u4f1a\u68c0\u67e5\u6709\u65e0publication\u5b58\u5728\uff0c\u5982\u679cpublication\u4e0d\u5b58\u5728\uff0c\u5219\u5728\u521b\u5efaconnector\u4f1a\u62a5\u9519.  filtered - \u4e0eall_tables\u4e0d\u540c\u7684\u662f\uff0cdebezium\u4f1a\u6839\u636econnector\u7684\u914d\u7f6e\u4e2d\u7684table.include.list\u751f\u6210\u751f\u6210\u521b\u5efapublication\u7684\u811a\u672c\uff1a <code>CREATE PUBLICATION &lt;publication_name&gt; FOR TABLE &lt;tbl1, tbl2, tbl3&gt;</code>\u3002\u4f8b\u5982\uff0c\u672c\u4f8b\u5b50\u4e2d\uff0c\u201ctable.include.list\"\u503c\u4e3a\"inventory.orders,inventory.products\u201d\uff0c\u5219publication\u53ea\u4f1a\u76d1\u63a7\u8fd9\u4e24\u4e2a\u8868\u7684\u53d8\u66f4\u60c5\u51b5\u3002","tags":[]},{"location":"postgres/troubleshooting/debezium/#_6","title":"\u5f00\u59cb\u6d4b\u8bd5","text":"<pre><code>export DEBEZIUM_VERSION=1.9\ndocker-compose -f docker-compose-postgres.yaml up\n\n# Start Postgres connector\ncurl -i -X POST -H \"Accept:application/json\" -H  \"Content-Type:application/json\" http://localhost:8083/connectors/ -d @register-postgres.json\n\n# Consume messages from a Debezium topic\ndocker-compose -f docker-compose-postgres.yaml exec kafka /kafka/bin/kafka-console-consumer.sh \\\n    --bootstrap-server kafka:9092 \\\n    --from-beginning \\\n    --property print.key=true \\\n    --topic dbserver1.inventory.orders\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_7","title":"\u6570\u636e\u5e93\u9a8c\u8bc1","text":"<pre><code>-- \u6570\u636e\u5e93\u4e2d\u6267\u884c\nselect * from pg_replication_slots where slot_name = 'inventory_slot';\n   slot_name    |  plugin  | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn | wal_status | safe_wal_size | two_phase \n----------------+----------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------+------------+---------------+-----------\n inventory_slot | pgoutput | logical   |  14486 | postgres | f         | t      |       3798 |      |          790 | 0/E7AAE90   | 0/E7AAEC8           | reserved   |               | f\n(1 row)\n\nselect * from pg_publication;\n  oid  |         pubname         | pubowner | puballtables | pubinsert | pubupdate | pubdelete | pubtruncate | pubviaroot \n-------+-------------------------+----------+--------------+-----------+-----------+-----------+-------------+------------\n 49187 | dbz_inventory_connector |       10 | f            | t         | t         | t         | t           | f\n(1 row)\n\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#postgres-sinker-connetor","title":"postgres sinker connetor","text":"","tags":[]},{"location":"postgres/troubleshooting/debezium/#topology_2","title":"Topology","text":"<pre><code>                   +-------------+\n                   |             |\n                   |   Postgres  |\n                   |             |\n                   +------+------+\n                          |\n                          |\n                          |\n          +---------------v------------------+\n          |                                  |\n          |           Kafka Connect          |\n          |  (Debezium, JDBC connectors)     |\n          |                                  |\n          +---------------+------------------+\n                          |\n                          |\n                          |\n                   +-------------+\n                   |             |\n                   |   Postgres  |\n                   |    citus    |\n                   +------+------+\n\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#docker-citus","title":"docker  citus","text":"<pre><code># run PostgreSQL with Citus on port 5500\ndocker run -d --name citus -p 5500:5432 -e POSTGRES_PASSWORD=mypassword citusdata/citus\n\n# connect using psql within the Docker container\ndocker exec -it citus psql -U postgres\n\n# set user postgres password 111111\nalter user postgres with encrypted password '111111';\n\n# or, connect using local psql\npsql -U postgres -d postgres -h localhost -p 5500\n</code></pre> <p>plugin \u4e0b\u8f7d\u5730\u5740\uff0c\u4e0b\u8f7d\u540e\u89e3\u538b\u5230connetor \u6587\u4ef6\u76ee\u5f55\u4e0b\u5e76\u91cd\u65b0\u542f\u52a8kafka connetor</p> <p>https://www.confluent.io/hub/</p> <p>https://d1i4a15mxbxib1.cloudfront.net/api/plugins/confluentinc/kafka-connect-jdbc/versions/10.5.1/confluentinc-kafka-connect-jdbc-10.5.1.zip</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_8","title":"\u5355\u5f20\u8868","text":"","tags":[]},{"location":"postgres/troubleshooting/debezium/#sink-postgresjson","title":"\u914d\u7f6e sink-postgres.json","text":"<pre><code>{\n    \"name\": \"test-jdbc-sink\",\n    \"config\": {\n        \"connector.class\": \"io.confluent.connect.jdbc.JdbcSinkConnector\",\n        \"tasks.max\": \"1\",\n        \"connection.url\": \"jdbc:postgresql://10.10.2.13:5432/test?user=postgres&amp;password=111\",\n        \"connection.user\":\"postgres\",\n        \"connection.password\":\"1111\",\n        \"topics\":\"debezium.public.tablename\",\n        \"dialect.name\":\"PostgreSqlDatabaseDialect\",\n        \"table.name.format\": \"public.tablename\",\n        \"auto.create\":\"true\",\n        \"auto.evolve\":\"true\",\n        \"insert.mode\":\"upsert\",\n        \"transforms\": \"unwrap\",\n        \"transforms.unwrap.type\": \"io.debezium.transforms.ExtractNewRecordState\",\n        \"transforms.unwrap.drop.tombstones\": \"false\",\n        \"pk.fields\":\"id\",\n        \"pk.mode\":\"record_key\",\n        \"delete.enabled\" : true\n    }\n}\n</code></pre> <p>\u8bf4\u660e:</p> <pre><code>name : connector \u540d\u79f0\nconnector.xxx : sink \u6570\u636e\u5e93\u8fde\u63a5\u4fe1\u606f\ntopics : kafka\u4e2d\u7684topic\ndialect.name: \u65b9\u8a00\ntable.name.format : sink \u7aef\u4e0etopic \u5bf9\u5e94\u7684\u8868\u540d\u79f0\u3002 \u8868\u540d\u9ed8\u8ba4\u4e3atopic\nauto.create : \u662f\u5426\u81ea\u52a8\u5efa\u8868\ninsert.mode : insert upsert update\ndelete.enabled\uff1a \u9ed8\u8ba4false \u4e0d\u652f\u6301\u5220\u9664\u548c\u66f4\u65b0\npk.fields \uff1a \u4e3b\u952e \npk.mode \uff1a \u4e3b\u952e\u7c7b\u578b\n</code></pre> <p>\u66f4\u591a\u9009\u9879\u8bf7\u53c2\u8003 https://docs.confluent.io/kafka-connect-jdbc/current/sink-connector/sink_config_options.html</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#sink","title":"\u6ce8\u518c sink","text":"<pre><code>curl -i -X POST -H \"Accept:application/json\" -H  \"Content-Type:application/json\" http://localhost:8083/connectors/ -d @sink-postgres.json\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_9","title":"\u591a\u8868","text":"<p>\u200b       \u9ed8\u8ba4\u60c5\u51b5table.name.format \u7684\u503c\u4e3a topics\uff0c</p> <p>\u200b        topics\u7684\u540d\u79f0\u4e3a source connection \u4e2d\u5b9a\u4e49\u7684database.server.name+schema+tablename</p> <p>\u200b       \u8fd9\u6837\u5c31\u4f1a\u5bf9source connection  \u5728\u5b9a\u4e49\u65f6\u6709\u6240\u8981\u6c42\u3002\u5373\u4e0b\u6e38\u7684dbname \u4e0e database.server.name \u5fc5\u987b\u4fdd\u6301\u4e00\u81f4</p> <p>\u200b       \u5426\u5219\u5728\u521b\u5efasink connection \u65f6\u5c06\u4f1a\u51fa\u73b0\u5982\u4e0b\u9519\u8bef</p> <p>\u200b       <code>ERROR:  cross-database references are not implemented</code></p> <p>\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u89e3\u9664\u8fd9\u79cd\u975e\u5fc5\u8981\u7684\u7ed1\u5b9a</p> <p>\u200b    \u81ea\u5b9a\u4e49topics\u3001  table.name.format \u3002\u6620\u5c04\u6e90\u8868\u4e0e\u76ee\u6807\u8868\u4e4b\u95f4\u7684\u5bf9\u5e94\u5173\u7cfb\u3002\u597d\u5904\u662f\u975e\u5e38\u7684\u7075\u6d3b\uff0c\u5f0a\u7aef\u6bcf\u4e2a\u8868\u4e4b\u95f4\u7684\u5173\u7cfb\u90fd\u9700\u8981\u5b9a\u4e49\u3002</p> <p>\u5982\u679c\u662f\u6e90\u8868\u4e0e\u76ee\u6807\u8868\u540d\u79f0\u5b8c\u5168\u4e00\u81f4\u6216\u5b58\u5728\u67d0\u79cd\u89c4\u5f8b\uff0c\u6bd4\u65b9\u52a0\u4e2a\u524d\u7f00\u7b49\u3002\u53ef\u901a\u8fc7\u5982\u4e0b\u65b9\u6cd5\u6279\u91cf\u5904\u7406\u3001\u975e\u5e38\u9002\u5408\u5c06\u6570\u636e\u5e93\u4ece\u4e00\u4e2a\u5e93\u5bfc\u5230\u53e6\u4e00\u4e2a\u5e93\u4e2d\u7684\u573a\u666f\u3002</p> <p>source connetor \u7aef\u4e0d\u9700\u8981\u4fee\u6539    \u3001\u53ea\u9700\u8981\u5728 sink connetor \u7aef\u505a\u5982\u4e0b\u5b9a\u4e49\u3002\u622a\u53d6topic\u7684\u524d\u7f00</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#sink-postgres-alltablesjson","title":"\u914d\u7f6e sink-postgres-alltables.json","text":"<pre><code>{\n    \"name\": \"test-jdbc-sink-alltables\",\n    \"config\": {\n        \"connector.class\": \"io.confluent.connect.jdbc.JdbcSinkConnector\",\n        \"tasks.max\": \"1\",\n        \"connection.url\": \"jdbc:postgresql://10.10.2.13:5432/test?user=postgres&amp;password=111\",\n        \"connection.user\":\"postgres\",\n    \"connection.password\":\"1111\",\n        \"topics.regex\": \"dbserver1.public(.*)\",\n        \"transforms\": \"dropPrefix,unwrap\",\n        \"transforms.dropPrefix.type\":\"org.apache.kafka.connect.transforms.RegexRouter\",\n        \"transforms.dropPrefix.regex\":\"dbserver1.public(.*)\",\n        \"transforms.dropPrefix.replacement\":\"$1\",\n        \"transforms.unwrap.type\": \"io.debezium.transforms.ExtractNewRecordState\",\n        \"transforms.unwrap.drop.tombstones\": \"false\",\n        \"dialect.name\":\"PostgreSqlDatabaseDialect\",\n        \"auto.create\":\"true\",\n        \"insert.mode\":\"upsert\",\n        \"pk.mode\":\"record_key\",\n        \"delete.enabled\" : \"true\"\n    }\n}\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#kafka-connect-rest-api","title":"Kafka Connect REST API","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u67e5\u770bjson \u5efa\u8bae\u5b89\u88c5jq </p> <p><code>yum install epel-release jq -y</code></p> <p>\u5b98\u65b9\u6587\u6863</p> <p>https://kafka.apache.org/documentation.html#connect_rest</p>","tags":[]},{"location":"postgres/troubleshooting/debezium/#connect","title":"\u83b7\u53d6 Connect \u96c6\u7fa4\u7684\u57fa\u672c\u4fe1\u606f","text":"<pre><code>curl -s -X GET localhost:8083/ | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#kafka-connect-worker","title":"\u5217\u51fa Kafka Connect Worker \u4e0a\u5b89\u88c5\u7684\u63d2\u4ef6","text":"<pre><code># curl -s -X GET localhost:8083/connector-plugins | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_10","title":"\u521b\u5efa\u4e00\u4e2a\u8fde\u63a5\u5668","text":"<pre><code>curl -i -X POST -H \"Accept:application/json\" -H \"Content-Type:application/json\" 192.168.0.40:8083/connectors/ -d @inventory-connector.json\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_11","title":"\u83b7\u53d6\u6240\u6709\u73b0\u6709\u7684\u8fde\u63a5\u5668\u540d\u79f0","text":"<pre><code># curl -s -X GET localhost:8083/connectors/ | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_12","title":"\u83b7\u53d6\u8fde\u63a5\u5668\u7684\u914d\u7f6e\u4fe1\u606f","text":"<pre><code># curl -s -X GET localhost:8083/connectors/inventory-connector | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_13","title":"\u83b7\u53d6\u8fde\u63a5\u5668\u7684\u72b6\u6001\u4fe1\u606f","text":"<pre><code># curl -s -X GET localhost:8083/connectors/inventory-connector/status | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_14","title":"\u83b7\u53d6\u5f53\u524d\u4e3a\u8fde\u63a5\u5668\u8fd0\u884c\u7684\u4efb\u52a1\u5217\u8868","text":"<pre><code># curl -s -X GET localhost:8083/connectors/inventory-connector/tasks | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_15","title":"\u83b7\u53d6\u4efb\u52a1\u7684\u5f53\u524d\u72b6\u6001","text":"<pre><code># curl -s -X GET localhost:8083/connectors/inventory-connector/tasks/0/status | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#topics","title":"\u83b7\u53d6\u8fde\u63a5\u5668\u4f7f\u7528\u7684\u4e3b\u9898(topics)\u5217\u8868","text":"<pre><code># curl -s -X GET localhost:8083/connectors/oracle-scott-connector/topics | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#topics_1","title":"\u6e05\u7a7a\u8fde\u63a5\u5668\u7684\u6d3b\u52a8\u4e3b\u9898(topics)\u5217\u8868","text":"<pre><code># curl -s -X PUT localhost:8083/connectors/oracle-scott-connector/topics/reset\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_16","title":"\u6682\u505c\u8fde\u63a5\u5668\u4efb\u52a1","text":"<pre><code># curl -s -X PUT localhost:8083/connectors/inventory-connector/pause\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_17","title":"\u6062\u590d\u8fde\u63a5\u5668\u4efb\u52a1","text":"<pre><code># curl -s -X PUT localhost:8083/connectors/inventory-connector/resume\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_18","title":"\u5220\u9664\u8fde\u63a5\u5668","text":"<pre><code># curl -s -X DELETE localhost:8083/connectors/inventory-connector\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#_19","title":"\u66f4\u65b0\u8fde\u63a5\u5668","text":"<pre><code># curl -i -X PUT -H \"Accept:application/json\" -H \"Content-Type:application/json\" localhost:8083/connectors/inventory-connector/config -d @inventory-connector.json\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/debezium/#tasks","title":"\u91cd\u542f\u8fde\u63a5\u5668\u548c\u4efb\u52a1(tasks)","text":"<ul> <li>\u8bed\u6cd5</li> </ul> <pre><code>POST /connectors/{name}/restart?includeTasks=&lt;true|false&gt;&amp;onlyFailed=&lt;true|false&gt;\n# \"includeTasks=true\": \u91cd\u65b0\u542f\u52a8\u8fde\u63a5\u5668\u5b9e\u4f8b\u548c\u4efb\u52a1\u5b9e\u4f8b\n# \"includeTasks=false\"(\u9ed8\u8ba4): \u4ec5\u91cd\u65b0\u542f\u52a8\u8fde\u63a5\u5668\u5b9e\u4f8b\n# \"onlyFailed=true\": \u4ec5\u91cd\u65b0\u542f\u52a8\u5177\u6709 FAILED \u72b6\u6001\u7684\u5b9e\u4f8b\n# \"onlyFailed=false\"(\u9ed8\u8ba4): \u91cd\u65b0\u6240\u6709\u5b9e\u4f8b\n</code></pre> <ul> <li>\u793a\u4f8b</li> </ul> <pre><code># curl -s -X POST localhost:8083/connectors/inventory-connector/restart\n</code></pre> <ul> <li>\u9ed8\u8ba4\u53ea\u91cd\u65b0\u542f\u52a8\u8fde\u63a5\u5668\u5e76\u4e0d\u4f1a\u91cd\u65b0\u542f\u52a8\u5176\u6240\u6709\u4efb\u52a1\u3002\u56e0\u6b64\uff0c\u60a8\u4e5f\u53ef\u4ee5\u91cd\u65b0\u542f\u52a8\u5931\u8d25\u7684\u5355\u4e2a\u4efb\u52a1\uff0c\u7136\u540e\u518d\u6b21\u83b7\u53d6\u5176\u72b6\u6001\uff1a</li> </ul> <pre><code># curl -s -X POST localhost:8083/connectors/inventory-connector/tasks/0/restart\n# curl -s -X GET localhost:8083/connectors/inventory-connector/tasks/0/status | jq\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/dts/","title":"DTS \u6570\u636e\u8fc1\u79fb\u670d\u52a1","text":"","tags":[]},{"location":"postgres/troubleshooting/dts/#_1","title":"\u5b9e\u73b0\u76ee\u6807","text":"<p>\u200b       \u5e73\u6ed1\u5c06\u73b0\u6709\u5728\u7ebf\u4e1a\u52a1\u6570\u636e\u5e93\u6570\u636e\u8fc1\u79fb\u5230\u65b0\u6570\u636e\u5e93\u4e2d\u3002</p> <p>\u200b        \u5982\u6570\u636e\u5e93\u5927\u7248\u672c\u5347\u7ea7\u3001\u539fpg\u6570\u636e\u5e93\u8fc1\u79fb\u5230citus\u96c6\u7fa4\u3001 \u591a\u6570\u636e\u6e90\u6c47\u603b\u7b49\u4e1a\u52a1\u573a\u666f\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/dts/#_2","title":"\u8fc1\u79fb\u524d\u539f\u5e93\u68c0\u67e5","text":"<ul> <li>\u914d\u7f6e\u68c0\u67e5</li> </ul> <p><code>-- \u6e90\u7aef   wal_level = logical   max_replication_slots = \u5927\u4e8e1    max_wal_senders =    max_worker_processes    -- \u76ee\u6807\u7aef   max_replication_slots\uff0c\u5927\u4e8e\u7b49\u4e8e\u8be5\u5b9e\u4f8b\u603b\u5171\u9700\u8981\u521b\u5efa\u7684\u8ba2\u9605\u6570   max_logical_replication_workers\uff0c\u5927\u4e8e\u7b49\u4e8e\u8be5\u5b9e\u4f8b\u603b\u5171\u9700\u8981\u521b\u5efa\u7684\u8ba2\u9605\u6570   max_worker_processes</code></p> <ul> <li>\u8868\u5fc5\u987b\u5b58\u5728\u4e3b\u952e\u6216\u552f\u4e00\u7ea6\u675f\uff0c\u4f5c\u4e3a\u590d\u5236\u6807\u8bc6\u3002</li> </ul> <p><code>-- \u6ca1\u6709\u4e3b\u952e\u6216\u7d22\u5f15\u7684\u8868   select relname as table_name from pg_stat_user_tables where relid not in (select pc.oid  from pg_class pc join pg_index pi  on pc.oid = pi.indrelid join pg_stat_user_tables psut on psut.relid = pc.oid  where indisunique = 't' and  indisprimary = 't');</code></p> <p><code>-- \u7279\u6b8a\u8868\u7684\u53d1\u5e03\u5904\u7406   alter table table_name       REPLICA IDENTITY { DEFAULT | USING INDEX index_name | FULL | NOTHING }</code></p> <ul> <li> <p>\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u907f\u514dDDL\u64cd\u4f5c</p> </li> <li> <p>\u539f\u5e93\u53d1\u751f\u6545\u969c\u5207\u6362\uff0c\u8fc1\u79fb\u5931\u8d25\u300211\u7248\u672c\u524d\u4e0d\u5177\u5907failover slot</p> </li> <li> <p>\u539f\u6570\u636e\u5fc5\u987b\u9884\u7559\u8db3\u591f\u7684\u78c1\u76d8\u7a7a\u95f4\u5b58\u50a8\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684wal\u65e5\u5fd7</p> </li> <li> <p>\u53d1\u5e03\u7aef\u9700\u4e3a\u6570\u636e\u5e93\u4e3b\u8282\u70b9</p> </li> <li> <p>\u6570\u636e\u5e93\u7528\u6237\u53ca\u6743\u9650</p> </li> <li> <p>\u6e90\u6570\u636e\u5e93\u8fde\u63a5</p> </li> </ul>","tags":[]},{"location":"postgres/troubleshooting/dts/#_3","title":"\u5176\u4ed6\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>Sequence\u4e0d\u4f1a\u6309\u7167\u6e90\u5e93\u7684Sequence\u6700\u5927\u503c\u4f5c\u4e3a\u521d\u59cb\u503c\u53bb\u9012\u589e\uff0c\u9700\u8981\u5728\u4e1a\u52a1\u5207\u6362\u524d\uff0c\u5728\u6e90\u5e93\u4e2d\u67e5\u8be2\u5bf9\u5e94Sequence\u7684\u6700\u5927\u503c\uff0c\u7136\u540e\u5728\u76ee\u6807\u5e93\u4e2d\u5c06\u5176\u4f5c\u4e3a\u5bf9\u5e94Sequence\u7684\u521d\u59cb\u503c\u3002</li> <li>FLOAT\u6216DOUBLE\u7684\u5217\u7684\u8fc1\u79fb\u7cbe\u5ea6\u662f\u5426\u7b26\u5408\u4e1a\u52a1\u9884\u671f</li> <li>\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u7684\u6570\u636e\u53d8\u66f4\u4ec5\u652f\u6301DML\uff0c\u5982 INSERT\u3001UPDATE\u3001DELETE\u64cd\u4f5c</li> <li>DDL \u64cd\u4f5c\u4e0d\u4f1a\u540c\u6b65\uff0c\u53ef\u4f7f\u7528\u89e6\u53d1\u5668\u5b8c\u6210</li> </ul>","tags":[]},{"location":"postgres/troubleshooting/dts/#_4","title":"\u8fc1\u79fb\u8fc7\u7a0b","text":"<ul> <li>\u6570\u636e\u7ed3\u6784\u8fc1\u79fb</li> </ul> <p>```   -- \u5907\u4efd\u51fa\u539f\u59cb\u6570\u636e\u7ed3\u6784   pg_dump \\      --format=plain \\      --no-owner \\      --schema-only \\      --file=schema.sql \\      --schema=target_schema \\      postgres://user:pass@host:5432/db</p> <p>-- \u5728\u76ee\u6807\u7aef\u521b\u5efa\u8868\u7ed3\u6784   \\i schema.sql   -- \u6839\u636e\u5b9e\u9645\u4e1a\u52a1\u8c03\u6574\u8868\u7ed3\u6784</p> <p>```</p> <ul> <li> <p>\u5b58\u91cf\u8fc1\u79fb</p> </li> <li> <p>\u589e\u91cf\u8fc1\u79fb</p> </li> </ul> <p>```   \u5728\u521b\u5efaslot\u65f6\uff0c\u5728\u6e90\u6570\u636e\u5e93\u7aef\u521b\u5efaSNAPSHOT\u5feb\u7167\uff0c\u57fa\u4e8e\u5feb\u7167\u5b8c\u6210\u5168\u91cf\u53ca\u589e\u91cf\u6570\u636e\u8fc1\u79fb   -- \u53d1\u5e03   select pg_create_logical_replication_slot('logical_slot_name001','pgoutput');   create publication pub1 for all tables   -- \u8be6\u7ec6\u8bed\u6cd5   CREATE PUBLICATION name       [ FOR TABLE [ ONLY ] table_name [ * ] [, ...]         | FOR ALL TABLES ]       [ WITH ( publication_parameter [= value] [, ... ] ) ]   URL: https://www.postgresql.org/docs/12/sql-createpublication.html</p> <p>-- \u8ba2\u9605   create  subscription sub1 connection 'hostaddr= xxx port=xxx user=xxx dbname=xxx'     publication pub1 with(create_slot='false',slot_name='logical_slot_name001');    -- \u8be6\u7ec6\u8bed\u6cd5   CREATE SUBSCRIPTION subscription_name       CONNECTION 'conninfo'       PUBLICATION publication_name [, ...]       [ WITH ( subscription_parameter [= value] [, ... ] ) ]</p> <p>\u53c2\u6570\u8bf4\u660e   subscription_parameter   copy_data :  The default is true ,\u5b58\u91cf\u6570\u636e\u662f\u5426\u8fc1\u79fb   create_slot: The default is true. \u521b\u5efaslot   enabled : The default is true \u662f\u5426\u9a6c\u4e0a\u5f00\u542f\u590d\u5236   slot_name: synchronous_commit (enum) The default value is off.   connect (boolean) :    URL: https://www.postgresql.org/docs/12/sql-createsubscription.html</p> <p>--\u7981\u6b62\u6216\u5f00\u542f\u8ba2\u9605   ALTER SUBSCRIPTION mysub DISABLE;   ALTER SUBSCRIPTION mysub ENABLE   ALTER SUBSCRIPTION name REFRESH PUBLICATION    -- \u5982\u679c\u53d1\u5e03\u7aef\u4fee\u6539\uff0c\u8ba2\u9605\u7aef\u5237\u65b0\u8ba2\u9605   ALTER SUBSCRIPTION name REFRESH PUBLICATION    ```</p>","tags":[]},{"location":"postgres/troubleshooting/dts/#_5","title":"\u8fc7\u7a0b\u76d1\u63a7","text":"","tags":[]},{"location":"postgres/troubleshooting/dts/#_6","title":"\u53d1\u5e03\u7aef","text":"<pre><code>-- \u53d1\u5e03\u7aef\nselect * from pg_stat_replication ;\nselect * from pg_replication_slots ;\nselect * from pg_publication;\nselect * from pg_publication_tables ;\nselect pg_size_pretty(pg_wal_location_diff(pg_current_wal_insert_location(), sent_location)), pg_size_pretty(pg_wal_location_diff(pg_current_wal_insert_location(), replay_location)), * from pg_stat_replication ;\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/dts/#_7","title":"\u8ba2\u9605\u7aef","text":"<pre><code>-- \u8ba2\u9605\u7aef\nselect * from pg_subscription ;\nselect * from pg_stat_subscription ;\nselect * from pg_replication_origin_status ;\nselect pg_size_pretty(pg_wal_location_diff(received_lsn, latest_end_lsn)), * from pg_stat_subscription ;\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/dts/#_8","title":"\u7ed3\u679c\u68c0\u9a8c","text":"<ul> <li>\u8868\u7ed3\u6784\uff0c\u8868\u6570\u91cf\uff0c\u7d22\u5f15\u6570\u91cf</li> <li>\u8868\u4e2d\u6570\u636e\u91cf\u3001\u6570\u636e\u6761\u6570</li> <li>\u6570\u636e\u5185\u5bb9</li> </ul>","tags":[]},{"location":"postgres/troubleshooting/dts/#_9","title":"\u8fc1\u79fb\u540e\u5904\u7406","text":"<ul> <li>\u65b0\u6570\u636e\u5e93\u5e8f\u5217\u5904\u7406\uff0c\u4e1a\u52a1\u5207\u5272\u524d\u5904\u7406</li> </ul> <p><code>-- sql \u53c2\u8003   do language plpgsql $$   declare     nsp name;     rel name;     val int8;   begin     for nsp,rel in select nspname,relname from pg_class t2 , pg_namespace t3 where t2.relnamespace=t3.oid and t2.relkind='S'     loop       execute format($_$select last_value from %I.%I$_$, nsp, rel) into val;       raise notice '%',       format($_$select setval('%I.%I'::regclass, %s);$_$, nsp, rel, val+1);     end loop;   end;   $$;</code></p> <ul> <li>\u5220\u9664\u903b\u8f91\u590d\u5236slot \uff0c\u53d1\u5e03\u8ba2\u9605\u3002\u4e1a\u52a1\u5207\u5272\u540e\u5904\u7406</li> </ul> <pre><code>DROP PUBLICATION mypublication;\nDROP SUBSCRIPTION mysub;\nselect pg_drop_replication_slot('myslot');\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/dts/#_10","title":"\u4e1a\u52a1\u5207\u5272","text":"<p>\u200b   \u7565</p>","tags":[]},{"location":"postgres/troubleshooting/dts/#_11","title":"\u5931\u8d25\u64a4\u56de","text":"<ul> <li>\u589e\u91cf\u56de\u6d41 </li> </ul> <p>\u4e3b\u8981\u662f\u8003\u8651\u5982\u679c\u65b0\u6570\u636e\u5e93\u9047\u5230\u95ee\u9898\u9700\u8981\u5207\u6362\u56de\u539f\u6765\u7684\u6570\u636e\u5e93\u573a\u666f\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/explain/","title":"Explain \u6267\u884c\u8ba1\u5212","text":""},{"location":"postgres/troubleshooting/explain/#_1","title":"\u6587\u6cd5","text":"<pre><code>EXPLAIN [ ( option [, ...] ) ] statement\nEXPLAIN [ ANALYZE ] [ VERBOSE ] statement\n\n\u8fd9\u91cc option\u53ef\u4ee5\u662f\uff1a\n\n    ANALYZE [ boolean ]\n    VERBOSE [ boolean ]\n    COSTS [ boolean ]\n    BUFFERS [ boolean ]\n    TIMING [ boolean ]\n    SUMMARY [ boolean ]\n    FORMAT { TEXT | XML | JSON | YAML }\n</code></pre>"},{"location":"postgres/troubleshooting/explain/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u8bb0\u4f4f\u5f53\u4f7f\u7528\u4e86ANALYZE\u9009\u9879\u65f6\u8bed\u53e5\u4f1a\u88ab\u5b9e\u9645\u6267\u884c. \u5982\u6267\u884cdml \u65f6\u5c06\u5bf9\u6570\u636e\u5e93\u8fdb\u884c\u5b9e\u9645\u7684\u64cd\u4f5c\u3002</p> <p>\u907f\u514d\u6c61\u67d3\u6570\u636e\u7684\u65b9\u5f0f</p> <pre><code>BEGIN;\nEXPLAIN ANALYZE ...;\nROLLBACK;\n</code></pre>"},{"location":"postgres/troubleshooting/explain/#_3","title":"\u4e00\u4e2a\u4f8b\u5b50","text":"<pre><code>postgres=# explain analyze select * from tbl;\n                                                    QUERY PLAN                                                    \n------------------------------------------------------------------------------------------------------------------\n Seq Scan on tbl  (cost=0.00..144248.48 rows=10000048 width=8) (actual time=0.091..780.145 rows=10000000 loops=1)\n Planning time: 0.124 ms\n Execution time: 1046.394 ms\n(3 rows)\n</code></pre> <p>Seq Scan \u987a\u5e8f\u626b\u63cf cost \u4ee3\u4ef7\u6210\u672c, \u542f\u52a8\u6210\u672c..\u603b\u6210\u672c actual \u5b9e\u9645\u503c  </p>"},{"location":"postgres/troubleshooting/explain/#cost","title":"cost\u8ba1\u7b97","text":"<p>cost\u7684\u8ba1\u7b97\u4f9d\u636e \u6570\u636e\u5e93\u4e2d\u7684\u7edf\u8ba1\u4fe1\u606f\u53ca\u6210\u672c\u56e0\u5b50\u76f8\u5173</p> <ul> <li>\u7edf\u8ba1\u4fe1\u606f select * from pg_stats;</li> <li>\u6210\u672c\u56e0\u5b50 </li> </ul> <pre><code># - Planner Cost Constants -\n\n#seq_page_cost = 1.0                    # measured on an arbitrary scale\nrandom_page_cost = 1.1                  # same scale as above\n#cpu_tuple_cost = 0.01                  # same scale as above\n#cpu_index_tuple_cost = 0.005           # same scale as above\n#cpu_operator_cost = 0.0025             # same scale as above\n#parallel_tuple_cost = 0.1              # same scale as above\n#parallel_setup_cost = 1000.0   # same scale as above\n#min_parallel_table_scan_size = 8MB\n#min_parallel_index_scan_size = 512kB\neffective_cache_size = 666666\n</code></pre>"},{"location":"postgres/troubleshooting/explain/#_4","title":"\u5f71\u54cd\u6267\u884c\u8ba1\u5212\u7684\u53c2\u6570\u8bbe\u7f6e","text":"<pre><code>\u5f00\u5173\nenable_bitmapscan\nenable_gathermerge\nenable_hashagg\nenable_hashjoin\nenable_indexonlyscan\nenable_indexscan\nenable_material\nenable_mergejoin\nenable_nestloop\nenable_seqscan\nenable_sort\nenable_tidscan\n\n\u5173\u8054\nfrom_collapse_limit \njoin_collapse_limit\ngeqo_threshold\n</code></pre> <p>\u8bbe\u7f6e</p> <ul> <li>session set enable_bitmapscan = default;</li> <li>\u5168\u5c40 postgresql.conf</li> <li>\u7528\u6237\u7ea7 alter user postgres set enable_bitmapscan = off;</li> <li>\u6570\u636e\u5e93\u7ea7\u522b alter database postgres set enable_bitmapscan = off;</li> </ul> <p>\u67e5\u770b </p> <ul> <li>session show enable_bitmapscan;</li> <li>\u7528\u6237\u7ea7\u522b select * from pg_user;</li> </ul>"},{"location":"postgres/troubleshooting/explain/#explain","title":"\u5728\u65e5\u5fd7\u4e2d\u8bb0\u5f55explain\u4fe1\u606f","text":"<p>\u901a\u8fc7auto_explain \u6269\u5c55\u53ef\u5728\u65e5\u5fd7\u4e2d\u8bb0\u5f55explain\u4fe1\u606f</p> <p>\u6587\u6863 \u5b98\u7f51 \u6587\u6863 \u4e2d\u6587</p>"},{"location":"postgres/troubleshooting/explain/#sql","title":"SQL \u5728\u7ebf\u5206\u6790\u5de5\u5177","text":"<p>https://explain.depesz.com</p> <p>https://explain.dalibo.com/</p>"},{"location":"postgres/troubleshooting/libpg/","title":"\u5ba2\u6237\u7aef\u6545\u969c\u8f6c\u79fb","text":"","tags":[]},{"location":"postgres/troubleshooting/libpg/#_1","title":"\u591a\u4e3b\u673a\u8fde\u63a5","text":"<p>PostgreSQL libpq \u662f\u6570\u636e\u5e93\u7684\u4e00\u4e2a\u8fde\u63a5\u9a71\u52a8\uff0c\u652f\u6301\u591a\u4e3b\u673a\u914d\u7f6e\uff0c\u540c\u65f6\u652f\u6301target_session_attrs \u4e3b\u673a\u89d2\u8272\u5224\u65ad\u914d\u7f6e\u3002</p> <p>\u5f53\u914d\u7f6e\u4e86\u591a\u4e2a\u4e3b\u673a\u65f6\uff0c\u4f1a\u6309\u987a\u5e8f\u5c1d\u8bd5\u8fde\u63a5\uff0c\u4e4b\u9053\u83b7\u53d6\u5230\u6210\u529f\u7684\u8fde\u63a5\u4e3a\u6b62\u3002</p> <p>\u5229\u7528libpq\u7684\u8fd9\u4e2a\u7279\u6027\uff0c\u7ed3\u5408\u6570\u636e\u5e93\u81ea\u52a8HA\u7684\u4e00\u4e9b\u8f6f\u4ef6\uff0c\u53ef\u4ee5\u5b9e\u73b0\u5728\u4e0d\u5f15\u5165VIP\u4ee5\u53ca\u4e2d\u95f4\u8def\u7531\u8282\u70b9\u7684\u60c5\u51b5\u4e0b\u5b9e\u73b0\u6570\u636e\u5e93\u5e94\u7528\u7cfb\u7edf\u5c42\u7ea7\u7684\u9ad8\u53ef\u7528\u3002</p>","tags":[]},{"location":"postgres/troubleshooting/libpg/#_2","title":"\u8fde\u63a5\u6210\u529f\u5224\u65ad","text":"<ul> <li>\u6210\u529f\u5efa\u7acb\u8fde\u63a5</li> <li>target_session_attrs\u914d\u7f6e</li> </ul> <pre><code> read-write \u542b\u4e49\u3002 \u8fde\u63a5\u5230\u7684\u8282\u70b9\u4e3a\u53ef\u8bfb\u5199\u3002\u5982\u679c\u8fde\u63a5\u7684\u662f\u4ece\u8282\u70b9\uff0c\u53ea\u5177\u5907\u53ef\u8bfb\u6027\u5219\u4e0d\u80fd\u8fde\u63a5\u6210\u529f\u3002\n\n \u6839\u636eshow transaction_read_only ; \u5224\u65ad\u8282\u70b9\u7684\u53ef\u8bfb\u5199\u6027\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/libpg/#_3","title":"\u5177\u4f53\u793a\u4f8b","text":"<p>psql</p> <pre><code>psql 'postgres://192.168.6.15:65432,192.168.6.16:65432/postgres?target_session_attrs=read-write'\n\n</code></pre> <p>python</p> <pre><code>import psycopg2\nconn = psycopg2.connect(database=\"postgres\",host=\"192.168.6.15,192.168.6.16\", user=\"postgres\", password=\"sqlite123\", port=\"5432\", target_session_attrs=\"read-write\")\ncur = conn.cursor()\ncur.execute(\"select pg_is_in_recovery(),now(),inet_server_addr()\")\nrow = cur.fetchone()\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/oom/","title":"\u6570\u636e\u5e93 OOM \u9884\u9632","text":"","tags":[]},{"location":"postgres/troubleshooting/oom/#oom-kill","title":"\u964d\u4f4e\u4e3b\u8fdb\u7a0b\u88abOOM kill \u6389\u7684\u98ce\u9669","text":"","tags":[]},{"location":"postgres/troubleshooting/oom/#restart_after_crash","title":"restart_after_crash","text":"<p>\u9ed8\u8ba4\u5d29\u6e83\u91cd\u542f</p> <pre><code>postgres=# show restart_after_crash;\n restart_after_crash \n---------------------\n on\n(1 row)\n\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/oom/#vmovercommit","title":"vm.overcommit","text":"<pre><code># vi /etc/sysctl.conf\n\n# 0 \u8868\u793a\u5185\u6838\u5c06\u68c0\u67e5\u662f\u5426\u6709\u8db3\u591f\u7684\u53ef\u7528\u5185\u5b58\u4f9b\u5e94\u7528\u8fdb\u7a0b\u4f7f\u7528\uff1b\u5982\u679c\u6709\u8db3\u591f\u7684\u53ef\u7528\u5185\u5b58\uff0c\u5185\u5b58\u7533\u8bf7\u5141\u8bb8\uff1b\u5426\u5219\uff0c\u5185\u5b58\u7533\u8bf7\u5931\u8d25\uff0c\u5e76\u628a\u9519\u8bef\u8fd4\u56de\u7ed9\u5e94\u7528\u8fdb\u7a0b \n# 1 \u8868\u793a\u5185\u6838\u5141\u8bb8\u5206\u914d\u6240\u6709\u7684\u7269\u7406\u5185\u5b58\uff0c\u800c\u4e0d\u7ba1\u5f53\u524d\u7684\u5185\u5b58\u72b6\u6001\u5982\u4f55 \n# 2 \u8868\u793a\u5185\u6838\u5141\u8bb8\u5206\u914d\u8d85\u8fc7\u6240\u6709\u7269\u7406\u5185\u5b58\u548c\u4ea4\u6362\u7a7a\u95f4\u603b\u548c\u7684\u5185\u5b58\nvm.overcommit_memory = 2\nvm.overcommit_ratio = 90 # overcommit_memory= 2 \u65f6\u751f\u6548\nvm.swappiness = 1 # \u4ea4\u6362\u5206\u533a\n\n# sysctl -p\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/oom/#oom_score_adj","title":"oom_score_adj","text":"<p>oom_score_adj \u7684\u53d6\u503c\u8303\u56f4\u4e3a -1000 \u5230 1000\uff0c\u503c\u8d8a\u5927\uff0c\u88abos\u5e72\u6389\u7684\u98ce\u9669\u8d8a\u5927\u3002</p> <p>\u542f\u52a8\u524d\u8bbe\u7f6e</p> <pre><code>#vi /usr/lib/systemd/system/postgresql-10.service\n# Disable OOM kill on the postmaster\nOOMScoreAdjust=-1000\nEnvironment=PG_OOM_ADJUST_FILE=/proc/self/oom_score_adj\nEnvironment=PG_OOM_ADJUST_VALUE=0\n</code></pre> <p>\u542f\u52a8\u540e\u8bbe\u7f6e</p> <pre><code>Pid=`head -n 1 /PATH/TO/postmaster.pid` &amp;&amp; echo -1000 &gt; /proc/$Pid/oom_score_adj\n</code></pre>","tags":[]},{"location":"postgres/troubleshooting/oom/#numa","title":"NUMA","text":"","tags":[]},{"location":"victorialogs/install/","title":"\u5355\u8282\u70b9\u5b89\u88c5","text":""},{"location":"victorialogs/install/#_2","title":"\u7b80\u4ecb","text":"<p>victorialogs \u662f\u4e00\u6b3e\u7528\u4e8e\u66ff\u4ee3elasticsearch \u7684\u65e5\u5fd7\u5b58\u50a8\u670d\u52a1\u3002  </p> <p>victorialogs \u4e13\u6ce8\u5904\u7406\u65e5\u5fd7\u6536\u96c6\u573a\u666f\uff0celasticsearch \u529f\u80fd\u4e30\u5bcc\uff0c\u5982\u5168\u6587\u68c0\u7d22\u7b49\u3002</p> <p>victorialogs \u5f00\u6e90\u534f\u8bae\u66f4\u52a0\u53cb\u597d\u3002 </p> <p>\u5728\u65e5\u5fd7\u6536\u96c6\u5b58\u50a8\u573a\u666f victorialogs\u53ef\u5927\u91cf\u8282\u7701\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u5305\u62ec\u5b58\u50a8\u538b\u7f29\uff0ccpu, \u5185\u5b58\u3002</p>"},{"location":"victorialogs/install/#victorialogs","title":"\u5b89\u88c5victorialogs","text":""},{"location":"victorialogs/install/#_3","title":"\u4e0b\u8f7d","text":"<pre><code>curl -L -O https://github.com/VictoriaMetrics/VictoriaLogs/releases/download/v1.28.0/victoria-logs-linux-amd64-v1.28.0.tar.gz\ntar xzf victoria-logs-linux-amd64-v1.28.0.tar.gz\nmv victoria-logs-prod /usr/local/bin/\n</code></pre>"},{"location":"victorialogs/install/#_4","title":"\u521b\u5efa\u4e13\u7528\u7528\u6237\u548c\u7528\u6237\u7ec4","text":"<pre><code>sudo groupadd --system victorialogs\nsudo useradd --system -g victorialogs -d /nonexistent -s /usr/sbin/nologin victorialogs\n</code></pre>"},{"location":"victorialogs/install/#_5","title":"\u521b\u5efa\u6570\u636e\u5b58\u50a8\u76ee\u5f55\u5e76\u8bbe\u7f6e\u6743\u9650","text":"<pre><code>sudo mkdir -p   /data/victorialogs\nsudo chown -R victorialogs:victorialogs   /data/victorialogs\nsudo chmod 750  /data/victorialogs\n</code></pre>"},{"location":"victorialogs/install/#_6","title":"\u914d\u7f6e\u6587\u4ef6\u7ba1\u7406","text":"<p>\u521b\u5efa\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u6587\u4ef6 /etc/victoria-logs.conf</p> <pre><code># Victoria Logs \u914d\u7f6e\nSTORAGE_PATH=\"/data/victorialogs\"\nRETEN_PERIOD=\"10y\"\nMAX_DISK_PERCENT=\"80\"\n</code></pre>"},{"location":"victorialogs/install/#systemd","title":"Systemd \u670d\u52a1\u5355\u5143\u6587\u4ef6","text":"<p>\u521b\u5efa /etc/systemd/system/victoria-logs.service</p> <pre><code>[Unit]\nDescription=Victoria Logs Production Server\nAfter=network.target\nDocumentation=https://docs.victoriametrics.com/victoria-logs/\n[Service]\nUser=victorialogs\nGroup=victorialogs\nEnvironmentFile=/etc/victoria-logs.conf\nWorkingDirectory=/var/lib\nExecStart=/usr/local/bin/victoria-logs-prod \\\n    -storageDataPath=${STORAGE_PATH} \\\n    -retentionPeriod=${RETEN_PERIOD} \\\n    -retention.maxDiskUsagePercent=${MAX_DISK_PERCENT}\nRestart=on-failure\nRestartSec=5\nStartLimitInterval=60\nStartLimitBurst=3\nLimitNOFILE=65535\nLimitNPROC=65535\nSyslogIdentifier=victoria-logs\n[Install]\nWantedBy=multi-user.target\n</code></pre>"},{"location":"victorialogs/install/#_7","title":"\u542f\u52a8\u670d\u52a1","text":"<pre><code># \u91cd\u8f7dsystemd\u914d\u7f6e\nsudo systemctl daemon-reload\n# \u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\nsudo systemctl enable victoria-logs\n# \u542f\u52a8\u670d\u52a1\nsudo systemctl start victoria-logs\n# \u68c0\u67e5\u72b6\u6001\nsudo systemctl status victoria-logs\n</code></pre>"},{"location":"victorialogs/install/#fluentbit","title":"\u5b89\u88c5 fluentbit","text":"<p>\u4f18\u52bfC \u5b9e\u73b0\uff0c\u591f\u8f7b\u91cf\u3002 \u5f00\u6e90\u534f\u8bae\u53cb\u597d\u3002</p> <p>\u652f\u6301\u65e5\u5fd7\u5206\u89e3\u5f88\u8be1\u5f02\uff0c\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\u63d0\u793a\u3002\u7701\u5fc3\u7684\u539f\u5219\u771f\u5fc3\u4e0d\u60f3\u7528\u3002\u901a\u8fc7\u5728fluentbit\u7684url\u4e2d\u8bbe\u7f6edebug\uff0c\u6ca1\u6709\u4efb\u4f55\u95ee\u9898\uff0c\u4f46\u662f\u5728vl\u4e2d\u5c31\u662f\u770b\u4e0d\u5230\u4efb\u4f55\u6570\u636e\uff0c\u800c\u4e14vl\u7684\u65e5\u5fd7\u7b49\u7ea7\u6ca1\u6709debug\u6700\u4f4e\u662finfo. \u95ee\u9898\u8c03\u67e5\u96be\u5ea6\u592a\u5927\u3002\u6323\u624e\u4e86\u51e0\u5929\u653e\u5f03\u4e86parser ,pg15\u7248\u672c\u65b0\u589e\u4e86 json\u683c\u5f0f\u7684\u65e5\u5fd7\u3002</p>"},{"location":"victorialogs/install/#ubuntu-2404","title":"Ubuntu 24.04","text":"<pre><code>sudo sh -c 'curl https://packages.fluentbit.io/fluentbit.key | gpg --dearmor &gt; /usr/share/keyrings/fluentbit-keyring.gpg'\necho \"deb [signed-by=/usr/share/keyrings/fluentbit-keyring.gpg] https://packages.fluentbit.io/ubuntu/noble noble main\" | sudo tee /etc/apt/sources.list.d/fluent-bit.list\n</code></pre> <pre><code>apt-get install fluent-bit -y\n</code></pre>"},{"location":"victorialogs/install/#centos7","title":"Centos7","text":"<p>cat /etc/yum.repos.d/fluent-bit.repo</p> <pre><code>[fluent-bit]\nname = Fluent Bit\n# Legacy server style\nbaseurl = https://packages.fluentbit.io/centos/$releasever/\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.fluentbit.io/fluentbit.key\nenabled=1\n</code></pre>"},{"location":"victorialogs/install/#_8","title":"\u914d\u7f6e","text":"<p>vim /etc/fluent-bit/fluent-bit.conf</p> <pre><code>[SERVICE]\n    Flush           5\n    Daemon          off\n    Log_Level       info\n    Parsers_File    parsers.conf\n    HTTP_Server     On\n    HTTP_Listen     0.0.0.0\n    HTTP_Port       2020\n# \u65e5\u5fd7\u8f93\u5165\uff08\u66ff\u6362\u5b9e\u9645\u8def\u5f84\uff09\n[INPUT]\n    Name              tail\n    Path              /var/log/postgresql/*.csv\n    Tag               postgres.log\n    Mem_Buf_Limit     50MB\n    Skip_Long_Lines   On\n    Read_from_Head    true\n    multiline.parser  multiline_postgres \n# \u65e5\u5fd7\u89e3\u6790\n[FILTER]\n    Name          parser\n    Match         postgres.log \n    Key_Name      log\n    Parser        postgres\n    Reserve_Data  On\n\n# \u63d0\u53d6SQL\u6267\u884c\u65f6\u95f4\uff08\u53ef\u9009\uff09\n# \u63d0\u53d6\u6267\u884c\u65f6\u95f4\uff08\u53ef\u9009\uff09\n[FILTER]\n    Name          rewrite_tag\n    Match         postgres.log \n    Rule          message /duration: (\\d+\\.\\d+) ms/ duration.$TAG false\n    Emitter_Name  re_emitted\n\n[Output]\n    Name http\n    Match postgres.log\n    host localhost\n    port 9428\n    uri /insert/jsonline?_stream_fields=stream&amp;_msg_field=log&amp;_time_field=date\n    format json_lines\n    json_date_format iso8601\n</code></pre> <p>cat /etc/fluent-bit/parsers.conf</p> <pre><code># PostgreSQL \u65e5\u5fd7\u5b57\u6bb5\u89e3\u6790\u5668\n[PARSER]\n    Name    postgres\n    Format  regex\n    Regex   ^(?&lt;log_time&gt;\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d{3} \\w+),(?&lt;user&gt;\\\"[^\\\"]+\\\"),(?&lt;database&gt;\\\"[^\\\"]+\\\"),(?&lt;pid&gt;\\d+),(?&lt;connection&gt;\\\"[^\\\"]+\\\"),(?&lt;session_id&gt;\\w+\\.[\\w]+),(?&lt;command_num&gt;\\d+),(?&lt;command&gt;\\\"[^\\\"]+\\\"),(?&lt;session_time&gt;\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2} \\w+),(?&lt;vtx_id&gt;[\\d\\/]+),(?&lt;tx_id&gt;\\d+),(?&lt;log_level&gt;\\w+),(?&lt;sql_state&gt;\\d+),\\\"(?&lt;message&gt;(?:[^\\\"]|\\\\\\\")*)\\\"\n    Time_Key      log_time\n    Time_Format   %Y-%m-%d %H:%M:%S.%L %Z\n    Time_Keep     On\n    Types         pid:integer command_num:integer tx_id:integer\n[MULTILINE_PARSER]\n    Name    multiline_postgres\n    Type    regex\n    key_content   log\n    flush_timeout       1000\n    Rule    \"start_state\" \"/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d{3} \\w+/\" \"cont\"\n    Rule    \"cont\"        \"/.*/\"  \"cont\"\n</code></pre>"},{"location":"victorialogs/install/#filebeat","title":"\u5b89\u88c5 filebeat (\u7565)","text":"<p>\u4e0d\u652f\u6301\u65e5\u5fd7\u5206\u89e3</p>"},{"location":"victorialogs/install/#apt","title":"APT \u73af\u5883","text":"<pre><code>wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -\n\nsudo apt-get install apt-transport-https\n&lt;!-- echo \"deb https://artifacts.elastic.co/packages/9.x/apt stable main\" | sudo tee -a /etc/apt/sources.list.d/elastic-9.x.list --&gt;\necho \"deb https://artifacts.elastic.co/packages/oss-9.x/apt stable main\" | sudo tee -a /etc/apt/sources.list.d/elastic-9.x.list\n\nsudo apt-get update &amp;&amp; sudo apt-get install filebeat\n\nsudo systemctl enable filebeat\n</code></pre>"},{"location":"victorialogs/install/#yum","title":"YUM \u73af\u5883","text":"<pre><code>sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch\n\n</code></pre> <p>vi /etc/yum.repos.d/elastic.repo</p> <pre><code>[elastic-9.x]\nname=Elastic repository for 9.x packages\nbaseurl=https://artifacts.elastic.co/packages/oss-9.x/yum\ngpgcheck=1\ngpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch\nenabled=1\nautorefresh=1\ntype=rpm-md\n</code></pre> <pre><code>sudo yum install filebeat\n\nsudo systemctl enable filebeat\n</code></pre>"},{"location":"victorialogs/install/#_9","title":"\u914d\u7f6e\u7ba1\u7406","text":"<p>\u4f7f\u7528modules ,\u597d\u5904\u662f\u5df2\u9884\u8bbe\u7f6e\u597dmulitlines. \u5373\u591a\u884c\u65e5\u5fd7\u89c4\u5219</p> <pre><code>filebeat.config.modules:\n  path: ${path.config}/modules.d/*.yml\n  reload.enabled: true\noutput.elasticsearch:\n  hosts: [\"http://vmlogs:9428/insert/elasticsearch/\"]\n  parameters:\n    _msg_field: \"message\"\n    _time_field: \"@timestamp\"\n    _stream_fields: \"host.hostname,log.file.path\"\n</code></pre> <p>\u5bf9\u5e94\u4fee\u6539 modules \u914d\u7f6e\u6587\u4ef6,\u4ee5 postgresql \u4e3a\u4f8b</p> <pre><code>- module: postgresql\n  log:\n    enabled: true\n    var.paths: [\"/var/lib/pgsql/14/data/log/*.csv\"]\n</code></pre> <p>\u5f00\u542f modules </p> <pre><code> # \u67e5\u770b module\n filebeat modules list\n # \u5f00\u542f postgresql module \n filebeat modules enable postgresql\n # \u68c0\u67e5\u914d\u7f6e\n filebeat test config \n filebeat test output\n</code></pre> <p>\u542f\u52a8\u670d\u52a1</p> <pre><code>systemctl start filebeat\nsystemctl enable filebeat\n</code></pre>"},{"location":"victorialogs/install/#logstash","title":"\u5b89\u88c5logstash (\u7565)","text":"<p>\u4f9d\u8d56java-jdk \u8017\u8d44\u6e90</p> <p>\u4f5c\u7528: \u5bf9\u65e5\u5fd7\u5b57\u6bb5\u8fdb\u884c\u63d0\u53d6\u5206\u5272</p>"},{"location":"victorialogs/install/#_10","title":"\u5b89\u88c5","text":"<pre><code>apt-get install logstash-oss\n</code></pre>"},{"location":"victorialogs/install/#_11","title":"\u914d\u7f6e","text":"<p>\u5e2e\u5199\u4e00\u4e2a\u5728github\u4e0a\u9762\u7684issue.</p> <p>\u6211\u5728\u4f7f\u7528fluent-bit\u6536\u96c6postgresql\u65e5\u5fd7\u5e76\u8fdb\u884cparser\u89e3\u6790\u540e\u5b58\u50a8\u5230victorialogs\u4e2d\u3002 </p> <p>\u5728fluent-bit \u4e2d\u7684\u914d\u7f6e</p> <pre><code>[Output]\n    Name http\n    Match postgres.log\n    host 10.1.80.54\n    port 9428\n    uri /insert/jsonline?_stream_fields=stream&amp;_msg_field=log&amp;_time_field=date&amp;debug=1\n    format json_lines\n    json_date_format iso8601\n</code></pre> <p>\u8fd9\u662f\u5728victorialogs\u67e5\u770b\u5230\u7684\u8fd0\u884c\u65e5\u5fd7</p> <pre><code>Aug 27 05:16:27 80-54 victoria-logs[1737902]: 2025-08-27T05:16:27.948Z        info        VictoriaLogs/app/vlinsert/insertutil/common_params.go:248        remoteAddr=\"10.1.80.87:39314\"; requestURI=/insert/jsonline?_stream_fields=stream&amp;_msg_field=log&amp;_time_field=date&amp;debug=1; ignoring log entry because of `debug` arg: {\"_msg\":\"2025-08-27 13:16:27.649 CST,\\\"postgres\\\",\\\"postgres\\\",2165,\\\"127.0.0.1:36508\\\",68ae94ab.875,22,\\\"SELECT\\\",2025-08-27 13:16:27 CST,2/58378,0,LOG,00000,\\\"duration: 5.969 ms  execute \\u003cunnamed&gt;: SELECT pg_database_size($1)\\\",\\\"parameters: $1 = \\u0027cloud_back\\u0027\\\",,,,,,,,\\\"\\\",\\\"client backend\\\",,0\",\"_stream\":\"{}\",\"_time\":\"2025-08-27T19:16:27.649Z\",\"command\":\"SELECT\",\"command_num\":\"22\",\"connection\":\"127.0.0.1:36508\",\"database\":\"postgres\",\"duration\":\"5.969\",\"extra\":\",\\\"parameters: $1 = \\u0027cloud_back\\u0027\\\",,,,,,,,\\\"\\\",\\\"client backend\\\",,0\",\"log_level\":\"LOG\",\"log_time\":\"2025-08-27 13:16:27.649 CST\",\"pid\":\"2165\",\"session_id\":\"68ae94ab.875\",\"session_time\":\"2025-08-27 13:16:27 CST\",\"sql_state\":\"00000\",\"tx_id\":\"0\",\"user\":\"postgres\",\"vtx_id\":\"2/58378\"}\nAug 27 05:16:35 80-54 victoria-logs[1737902]: 2025-08-27T05:16:35.030Z        info        VictoriaLogs/app/vlinsert/insertutil/common_params.go:248        remoteAddr=\"10.1.80.87:39986\"; requestURI=/insert/jsonline?_stream_fields=stream&amp;_msg_field=log&amp;_time_field=date&amp;debug=1; ignoring log entry because of `debug` arg: {\"_msg\":\"2025-08-27 13:16:33.704 CST,\\\"postgres\\\",\\\"postgres\\\",2228,\\\"127.0.0.1:37356\\\",68ae94b1.8b4,1,\\\"SELECT\\\",2025-08-27 13:16:33 CST,2/0,0,LOG,00000,\\\"duration: 2.198 ms  statement: select datname from pg_database where not datistemplate and datallowconn and datname!=\\u0027postgres\\u0027\\\",,,,,,,,,\\\"psql\\\",\\\"client backend\\\",,-4034325387031128140\",\"_stream\":\"{}\",\"_time\":\"2025-08-27T19:16:33.704Z\",\"command\":\"SELECT\",\"command_num\":\"1\",\"connection\":\"127.0.0.1:37356\",\"database\":\"postgres\",\"duration\":\"2.198\",\"extra\":\",,,,,,,,,\\\"psql\\\",\\\"client backend\\\",,-4034325387031128140\",\"log_level\":\"LOG\",\"log_time\":\"2025-08-27 13:16:33.704 CST\",\"pid\":\"2228\",\"session_id\":\"68ae94b1.8b4\",\"session_time\":\"2025-08-27 13:16:33 CST\",\"sql_state\":\"00000\",\"tx_id\":\"0\",\"user\":\"postgres\",\"vtx_id\":\"2/0\"}\n</code></pre> <p>\u6211\u628adebug=0</p> <pre><code>[Output]\n    Name http\n    Match postgres.log\n    host 10.1.80.54\n    port 9428\n    uri /insert/jsonline?_stream_fields=stream&amp;_msg_field=log&amp;_time_field=date&amp;debug=1\n    format json_lines\n    json_date_format iso8601\n</code></pre> <p>\u7136\u800c\u6211\u5e76\u6ca1\u6709\u5728victorialogs\u4e2d\u67e5\u770b\u5230\u65b0\u7684\u4fe1\u606f\u3002</p> <p>\u8fd9\u4e2a\u95ee\u9898\u56f0\u6270\u4e86\u6211\u5f88\u4e45\uff0c</p> <p>\u6211\u5c1d\u8bd5\u8fc7\u6e05\u7406\u6389victorialogs\u7684\u5b58\u50a8\u6570\u636e\u3002\u4e5f\u6ca1\u6709\u8d77\u4f5c\u7528 \u6211\u60f3\u5728victorialogs\u4e2d\u5f00\u542fdebug\u7b49\u7ea7\u7684\u8fd0\u884c\u65e5\u5fd7\uff0c\u4f46\u662f\u597d\u50cf\u6ca1\u6709\u3002 </p> <p>\u6211\u53d1\u73b0\u4e00\u4e2a\u5947\u602a\u7684\u73b0\u8c61\uff0c\u6709\u65f6\u5019\u96f6\u70b9\u8fc7\u540e\u770b\u7684\u65b0\u6570\u636e\u3002\u6211\u4e0d\u77e5\u9053\u8fd9\u662f\u4ec0\u4e48\u539f\u56e0\u3002\u6211\u73b0\u5728\u5728\u8c03\u8bd5\u8fd9\u4e2a\u95ee\u9898\u3002\u5e0c\u671b\u5f97\u5230\u5e2e\u52a9</p>"},{"location":"yugabytedb/deploy/","title":"Deploy","text":""},{"location":"yugabytedb/deploy/#_1","title":"\u90e8\u7f72\u96c6\u7fa4","text":""},{"location":"yugabytedb/deploy/#_2","title":"\u68c0\u6d4b\u5217\u8868","text":"<ul> <li>CPU: x86 and ARM (aarch64) </li> <li>\u64cd\u4f5c\u7cfb\u7edf:  AlmaLinux 8 and RHEL 8</li> <li>NTP &amp; Chrony</li> </ul>"},{"location":"yugabytedb/deploy/#_3","title":"\u8d44\u6e90\u9700\u6c42","text":"<ul> <li>\u6700\u5c0f\u9700\u6c42 2 cores  2GB RAM</li> <li>\u751f\u4ea7\u9700\u8981     YCQL - 16+ cores and 32GB+ RAM ,     YSQL - 16+ cores and 64GB+ RAM</li> </ul>"},{"location":"yugabytedb/deploy/#_4","title":"\u6307\u4ee4\u96c6","text":"<pre><code>grep -q sse4_2 /proc/cpuinfo &amp;&amp; echo \"true\" || echo \"false\"\n</code></pre>"},{"location":"yugabytedb/deploy/#_5","title":"\u786c\u76d8","text":"<ul> <li>SSD</li> <li>JBOD</li> <li>XFS</li> </ul>"},{"location":"yugabytedb/install/","title":"Install","text":""},{"location":"yugabytedb/install/#_1","title":"\u5355\u5b9e\u4f8b\u5b89\u88c5","text":""},{"location":"yugabytedb/install/#_2","title":"\u4e0b\u8f7d","text":"<pre><code> wget https://downloads.yugabyte.com/releases/2.21.1.0/yugabyte-2.21.1.0-b271-linux-x86_64.tar.gz\n\n tar xvfz yugabyte-2.21.1.0-b271-linux-x86_64.tar.gz &amp;&amp; cd yugabyte-2.21.1.0/\n</code></pre>"},{"location":"yugabytedb/install/#_3","title":"\u542f\u52a8","text":"<pre><code>./bin/post_install.sh\n./bin/yugabyted start\n./bin/yugabyted status \n</code></pre>"},{"location":"yugabytedb/install/#_4","title":"\u8fde\u63a5","text":"<pre><code>./bin/ysqlsh\n./bin/ycqlsh\n</code></pre> <p>\u8fc1\u79fb\u5de5\u5177</p> <p>YugabyteDB Voyager </p>"},{"location":"yugabytedb/install/#_5","title":"\u6e05\u7406","text":"<pre><code>./bin/yugabyted destroy\n</code></pre>"},{"location":"yugabytedb/install/#_6","title":"\u5355\u673a\u96c6\u7fa4\u90e8\u7f72","text":""},{"location":"yugabytedb/install/#_7","title":"\u7f51\u7edc\u6a21\u62df","text":"<pre><code>sudo ifconfig lo 127.0.0.2\nsudo ifconfig lo 127.0.0.3\n</code></pre>"},{"location":"yugabytedb/install/#_8","title":"\u542f\u52a8","text":"<pre><code>./bin/yugabyted start \\\n                --advertise_address=127.0.0.1 \\\n                --base_dir={$HOME}/var/node1 \\\n                --cloud_location=aws.us-east.us-east-1a\n\n./bin/yugabyted start \\\n                --advertise_address=127.0.0.2 \\\n                --base_dir={$HOME}/var/node2 \\\n                --cloud_location=aws.us-central.us-east-1b \\\n                --join=127.0.0.1\n\n./bin/yugabyted start \\\n                --advertise_address=127.0.0.3 \\\n                --base_dir={$HOME}/var/node3 \\\n                --cloud_location=aws.us-west.us-west-1c \\\n                --join=127.0.0.1\n\n./bin/yugabyted configure data_placement --base_dir={$HOME}/var/node1 --fault_tolerance=zone\n\n./bin/yugabyted status --base_dir={$HOME}/var/node1\n</code></pre>"},{"location":"yugabytedb/install/#_9","title":"\u538b\u6d4b","text":""},{"location":"yugabytedb/install/#_10","title":"\u4e0b\u8f7d","text":"<pre><code> install openjdk\n\n wget https://github.com/YugabyteDB-Samples/yb-workload-simulator/releases/download/v0.0.8/yb-workload-sim-0.0.8.jar\n</code></pre>"},{"location":"yugabytedb/install/#_11","title":"\u542f\u52a8","text":"<pre><code>java -jar \\\n    -Dnode=127.0.0.1 \\\n    ./yb-workload-sim-0.0.8.jar\n</code></pre> <p>http://localhost:8080/</p>"},{"location":"yugabytedb/install/#_12","title":"\u76d1\u63a7","text":""},{"location":"yugabytedb/install/#prometheus","title":"\u96c6\u6210 prometheus","text":"<pre><code>  - job_name: \"yugabytedb\"\n    metrics_path: /prometheus-metrics\n    relabel_configs:\n      - target_label: \"node_prefix\"\n        replacement: \"cluster-1\"\n    metric_relabel_configs:\n      # Save the name of the metric so we can group_by since we cannot by __name__ directly...\n      - source_labels: [\"__name__\"]\n        regex: \"(.*)\"\n        target_label: \"saved_name\"\n        replacement: \"$1\"\n      # The following basically retrofit the handler_latency_* metrics to label format.\n      - source_labels: [\"__name__\"]\n        regex: \"handler_latency_(yb_[^_]*)_([^_]*)_([^_]*)(.*)\"\n        target_label: \"server_type\"\n        replacement: \"$1\"\n      - source_labels: [\"__name__\"]\n        regex: \"handler_latency_(yb_[^_]*)_([^_]*)_([^_]*)(.*)\"\n        target_label: \"service_type\"\n        replacement: \"$2\"\n      - source_labels: [\"__name__\"]\n        regex: \"handler_latency_(yb_[^_]*)_([^_]*)_([^_]*)(_sum|_count)?\"\n        target_label: \"service_method\"\n        replacement: \"$3\"\n      - source_labels: [\"__name__\"]\n        regex: \"handler_latency_(yb_[^_]*)_([^_]*)_([^_]*)(_sum|_count)?\"\n        target_label: \"__name__\"\n        replacement: \"rpc_latency$4\"\n\n    static_configs:\n      - targets: [\"127.0.0.1:7000\", \"127.0.0.2:7000\", \"127.0.0.3:7000\"]\n        labels:\n          export_type: \"master_export\"\n\n      - targets: [\"127.0.0.1:9000\", \"127.0.0.2:9000\", \"127.0.0.3:9000\"]\n        labels:\n          export_type: \"tserver_export\"\n\n      - targets: [\"127.0.0.1:12000\", \"127.0.0.2:12000\", \"127.0.0.3:12000\"]\n        labels:\n          export_type: \"cql_export\"\n\n      - targets: [\"127.0.0.1:13000\", \"127.0.0.2:13000\", \"127.0.0.3:13000\"]\n        labels:\n          export_type: \"ysql_export\"\n\n      - targets: [\"127.0.0.1:11000\", \"127.0.0.2:11000\", \"127.0.0.3:11000\"]\n        labels:\n          export_type: \"redis_export\n</code></pre>"},{"location":"yugabytedb/install/#grafana","title":"grafana","text":"<p><code>12620</code></p>"},{"location":"yugabytedb/install/#_13","title":"\u538b\u6d4b","text":"<pre><code>wget https://github.com/yugabyte/yb-sample-apps/releases/download/v1.4.1/yb-sample-apps.jar -O yb-sample-apps.jar\n</code></pre> <pre><code>java -jar ./yb-sample-apps.jar \\\n    --workload CassandraKeyValue \\\n    --nodes 127.0.0.1:9042 \\\n    --num_threads_read 1 \\\n    --num_threads_write 1\n</code></pre>"},{"location":"yugabytedb/install/#_14","title":"\u6e05\u7406","text":"<pre><code>./bin/yugabyted destroy --base_dir={$HOME}/var/node1\n./bin/yugabyted destroy --base_dir={$HOME}/var/node2\n./bin/yugabyted destroy --base_dir={$HOME}/var/node3\n</code></pre>"}]}
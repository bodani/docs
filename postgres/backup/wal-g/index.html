<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Welcome to Shaun's rabbit hole. This site serves as a personal knowledge base for me to record my thoughts and ideas. It is also a place for me to share my knowledge and experience with the world. I hope you find something useful here."><meta name=author content=Eamon><link href=https://bodani.github.io/docs/postgres/backup/wal-g/ rel=canonical><link href=../pgbackrest/ rel=prev><link href=../pgcopydb/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.3"><title>WAL-G备份 - TeaLabs</title><link rel=stylesheet href=../../../assets/stylesheets/main.50c56a3b.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=../../../custom-style/custom-styles.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#wal-g class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=TeaLabs class="md-header__button md-logo" aria-label=TeaLabs data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> TeaLabs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> WAL-G备份 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=green data-md-color-accent=deep_orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../mysql/ class=md-tabs__link> MYSQL </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> PostgreSQL </a> </li> <li class=md-tabs__item> <a href=../../../middleware/ class=md-tabs__link> 中间件 </a> </li> <li class=md-tabs__item> <a href=../../../linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../maintenance/thinking_in_db_fd/ class=md-tabs__link> 数据库思考 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=TeaLabs class="md-nav__button md-logo" aria-label=TeaLabs data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> TeaLabs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <div class="md-nav__link md-nav__container"> <a href=../../../mysql/ class="md-nav__link "> <span class=md-ellipsis> MYSQL </span> </a> <label class="md-nav__link " for=__nav_1 id=__nav_1_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> MYSQL </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/install/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/PrivilegeManagement/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/users/ class=md-nav__link> <span class=md-ellipsis> 用户管理 </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_6> <div class="md-nav__link md-nav__container"> <a href=../../../mysql/replication/ class="md-nav__link "> <span class=md-ellipsis> 主从复制 </span> </a> <label class="md-nav__link " for=__nav_1_6 id=__nav_1_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_1_6> <span class="md-nav__icon md-icon"></span> 主从复制 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/replication/replication/ class=md-nav__link> <span class=md-ellipsis> 异步复制 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/replication/semisync/ class=md-nav__link> <span class=md-ellipsis> 半同步复制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_7> <label class=md-nav__link for=__nav_1_7 id=__nav_1_7_label tabindex> <span class=md-ellipsis> 高可用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_7_label aria-expanded=false> <label class=md-nav__title for=__nav_1_7> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/MGR/ class=md-nav__link> <span class=md-ellipsis> 组复制 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/myshellMGR/ class=md-nav__link> <span class=md-ellipsis> mysqlsh </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_8> <label class=md-nav__link for=__nav_1_8 id=__nav_1_8_label tabindex> <span class=md-ellipsis> 监控 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_8_label aria-expanded=false> <label class=md-nav__title for=__nav_1_8> <span class="md-nav__icon md-icon"></span> 监控 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/exporter/ class=md-nav__link> <span class=md-ellipsis> exporter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_9> <label class=md-nav__link for=__nav_1_9 id=__nav_1_9_label tabindex> <span class=md-ellipsis> 压测 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_9_label aria-expanded=false> <label class=md-nav__title for=__nav_1_9> <span class="md-nav__icon md-icon"></span> 压测 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/mysqlslap/ class=md-nav__link> <span class=md-ellipsis> mysqlslap </span> </a> </li> <li class=md-nav__item> <a href=https://bodani.github.io/mysql45 class=md-nav__link> <span class=md-ellipsis> mysql45 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> PostgreSQL </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> PostgreSQL </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> 安装与配置 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 安装与配置 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/install01/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../install/install02/ class=md-nav__link> <span class=md-ellipsis> 安装详解 </span> </a> </li> <li class=md-nav__item> <a href=../../install/install/ class=md-nav__link> <span class=md-ellipsis> 安装进阶 </span> </a> </li> <li class=md-nav__item> <a href=../../install/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> 高可用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ha/ha_fd/ class=md-nav__link> <span class=md-ellipsis> 设计分析 </span> </a> </li> <li class=md-nav__item> <a href=../../ha/patroni/ class=md-nav__link> <span class=md-ellipsis> Patroni集群 </span> </a> </li> <li class=md-nav__item> <a href=../../ha/patroni02/ class=md-nav__link> <span class=md-ellipsis> Patroni高级 </span> </a> </li> <li class=md-nav__item> <a href=../../ha/pgautofailover/ class=md-nav__link> <span class=md-ellipsis> PGAutofailover </span> </a> </li> <li class=md-nav__item> <a href=../../ha/repmgr/ class=md-nav__link> <span class=md-ellipsis> Repmgr </span> </a> </li> <li class=md-nav__item> <a href=../../ha/repmgrd/ class=md-nav__link> <span class=md-ellipsis> RepmgrD </span> </a> </li> <li class=md-nav__item> <a href=../../ha/adlock/ class=md-nav__link> <span class=md-ellipsis> 一致性 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <div class="md-nav__link md-nav__container"> <a href=../../index/ class="md-nav__link "> <span class=md-ellipsis> 索引与查询优化 </span> </a> <label class="md-nav__link " for=__nav_2_4 id=__nav_2_4_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 索引与查询优化 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index/index01/ class=md-nav__link> <span class=md-ellipsis> 索引类型及使用场景 </span> </a> </li> <li class=md-nav__item> <a href=../../index/index-invalid/ class=md-nav__link> <span class=md-ellipsis> 索引失效 </span> </a> </li> <li class=md-nav__item> <a href=../../index/index-bloom/ class=md-nav__link> <span class=md-ellipsis> Bloom索引 </span> </a> </li> <li class=md-nav__item> <a href=../../index/hypopg-index/ class=md-nav__link> <span class=md-ellipsis> 假设索引 </span> </a> </li> <li class=md-nav__item> <a href=../../index/partition/ class=md-nav__link> <span class=md-ellipsis> 表分区 </span> </a> </li> <li class=md-nav__item> <a href=../../index/partman/ class=md-nav__link> <span class=md-ellipsis> Partman插件 </span> </a> </li> <li class=md-nav__item> <a href=../../index/template/ class=md-nav__link> <span class=md-ellipsis> 模板表 </span> </a> </li> <li class=md-nav__item> <a href=../../index/unlogged_table/ class=md-nav__link> <span class=md-ellipsis> 未记录表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex> <span class=md-ellipsis> 性能优化 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 性能优化 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../performance/fillfactor/ class=md-nav__link> <span class=md-ellipsis> 填充因子 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/stat/ class=md-nav__link> <span class=md-ellipsis> 统计信息 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/params/ class=md-nav__link> <span class=md-ellipsis> 参数优化 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/high_level_sql/ class=md-nav__link> <span class=md-ellipsis> 高级SQL </span> </a> </li> <li class=md-nav__item> <a href=../../performance/FunctionsandOperators/ class=md-nav__link> <span class=md-ellipsis> 连接函数 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/vacuum/ class=md-nav__link> <span class=md-ellipsis> VACUUM操作 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/vacuum_limit/ class=md-nav__link> <span class=md-ellipsis> VACUUM限制 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/hotupdate/ class=md-nav__link> <span class=md-ellipsis> 冻结机制 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_performance/ class=md-nav__link> <span class=md-ellipsis> 性能优化思考 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_tune/ class=md-nav__link> <span class=md-ellipsis> 系统调优 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex> <span class=md-ellipsis> 数据维护 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 数据维护 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/toast/ class=md-nav__link> <span class=md-ellipsis> 事务管理 </span> </a> </li> <li class=md-nav__item> <a href=../../install/delete/ class=md-nav__link> <span class=md-ellipsis> 数据删除 </span> </a> </li> <li class=md-nav__item> <a href=../../install/checkpoint/ class=md-nav__link> <span class=md-ellipsis> 检查点 </span> </a> </li> <li class=md-nav__item> <a href=../../install/daily_management/ class=md-nav__link> <span class=md-ellipsis> 日常管理 </span> </a> </li> <li class=md-nav__item> <a href=../../install/bgwriter/ class=md-nav__link> <span class=md-ellipsis> BGWriter </span> </a> </li> <li class=md-nav__item> <a href=../../install/tablespace/ class=md-nav__link> <span class=md-ellipsis> 表空间 </span> </a> </li> <li class=md-nav__item> <a href=../../install/pgstattuple/ class=md-nav__link> <span class=md-ellipsis> 空间工具 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 id=__nav_2_7_label tabindex> <span class=md-ellipsis> 监控分析 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_7_label aria-expanded=false> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> 监控分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tools/monitor/ class=md-nav__link> <span class=md-ellipsis> 监控基础 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/monitor-sql/ class=md-nav__link> <span class=md-ellipsis> SQL监控 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/view_pg_stat_activity/ class=md-nav__link> <span class=md-ellipsis> STAT视图 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/view_pg_stat_bgwriter/ class=md-nav__link> <span class=md-ellipsis> 统计BGWriter </span> </a> </li> <li class=md-nav__item> <a href=../../tools/monitor_explain/ class=md-nav__link> <span class=md-ellipsis> Explain分析 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_activity/ class=md-nav__link> <span class=md-ellipsis> 活动视图 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/dba/ class=md-nav__link> <span class=md-ellipsis> 数据库监控 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex> <span class=md-ellipsis> 扩展模块 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> 扩展模块 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../extentions/citus01/ class=md-nav__link> <span class=md-ellipsis> Citus分布式 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/citus11/ class=md-nav__link> <span class=md-ellipsis> Citus高级 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/timescaledb/ class=md-nav__link> <span class=md-ellipsis> TimescaleDB </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pipelinedb01/ class=md-nav__link> <span class=md-ellipsis> PipelineDB </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pipelinedb02/ class=md-nav__link> <span class=md-ellipsis> PipelineDB实战 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pgpool2/ class=md-nav__link> <span class=md-ellipsis> PGPool-II </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pgbouncer/ class=md-nav__link> <span class=md-ellipsis> PGBouncer </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pg_rman/ class=md-nav__link> <span class=md-ellipsis> PGBackRMAN </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pg_fdw/ class=md-nav__link> <span class=md-ellipsis> FDW外部表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_9> <label class=md-nav__link for=__nav_2_9 id=__nav_2_9_label tabindex> <span class=md-ellipsis> 数据同步 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_9_label aria-expanded=false> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> 数据同步 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../replication/replication01/ class=md-nav__link> <span class=md-ellipsis> 流复制 </span> </a> </li> <li class=md-nav__item> <a href=../../replication/replication02/ class=md-nav__link> <span class=md-ellipsis> 复制原理 </span> </a> </li> <li class=md-nav__item> <a href=../../replication/logical-replication/ class=md-nav__link> <span class=md-ellipsis> 逻辑复制 </span> </a> </li> <li class=md-nav__item> <a href=../../replication/logical-replication_failover/ class=md-nav__link> <span class=md-ellipsis> 逻辑复制故障切换 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_rewind/ class=md-nav__link> <span class=md-ellipsis> pg_rewind </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_10 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> 备份与恢复 </span> </a> <label class="md-nav__link " for=__nav_2_10 id=__nav_2_10_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_10_label aria-expanded=true> <label class=md-nav__title for=__nav_2_10> <span class="md-nav__icon md-icon"></span> 备份与恢复 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../logical-backup/ class=md-nav__link> <span class=md-ellipsis> 逻辑备份 </span> </a> </li> <li class=md-nav__item> <a href=../physical-backup/ class=md-nav__link> <span class=md-ellipsis> 物理备份 </span> </a> </li> <li class=md-nav__item> <a href=../pgbackrest/ class=md-nav__link> <span class=md-ellipsis> pgBackRest </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> WAL-G备份 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> WAL-G备份 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#minio class=md-nav__link> <span class=md-ellipsis> 存储服务 minio </span> </a> </li> <li class=md-nav__item> <a href=#wal-g_1 class=md-nav__link> <span class=md-ellipsis> wal-g 下载 </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 设置环境变量 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 数据备份 </span> </a> <nav class=md-nav aria-label=数据备份> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 全量备份 </span> </a> </li> <li class=md-nav__item> <a href=#wal class=md-nav__link> <span class=md-ellipsis> wal 日志备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 恢复数据 </span> </a> <nav class=md-nav aria-label=恢复数据> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 查看所有全备份 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 下载一个全备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 管理存储 </span> </a> <nav class=md-nav aria-label=管理存储> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 清理存储 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#wal_1 class=md-nav__link> <span class=md-ellipsis> 将现有的所有 wal 上传 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 定期全备份及清理 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 注意事项 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 思考 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 其他有用脚本 </span> </a> </li> <li class=md-nav__item> <a href=#wal-g-30 class=md-nav__link> <span class=md-ellipsis> wal-g 3.0 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> <nav class=md-nav aria-label=安装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#centos-7 class=md-nav__link> <span class=md-ellipsis> centos 7 安装 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> <nav class=md-nav aria-label=配置> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 压缩 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 加密 </span> </a> <nav class=md-nav aria-label=加密> <ul class=md-nav__list> <li class=md-nav__item> <a href=#yandex-cloud-kms class=md-nav__link> <span class=md-ellipsis> 结合三方加密 Yandex Cloud KMS </span> </a> </li> <li class=md-nav__item> <a href=#libsodium class=md-nav__link> <span class=md-ellipsis> LIBSODIUM 加密算法 </span> </a> </li> <li class=md-nav__item> <a href=#openpgp class=md-nav__link> <span class=md-ellipsis> OpenPGP 加密 </span> </a> </li> <li class=md-nav__item> <a href=#envelope-pgp class=md-nav__link> <span class=md-ellipsis> Envelope PGP 混合加密 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#for-postgres class=md-nav__link> <span class=md-ellipsis> FOR postgres 配置 </span> </a> <nav class=md-nav aria-label="FOR postgres 配置"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#walg_disk_rate_limit class=md-nav__link> <span class=md-ellipsis> WALG_DISK_RATE_LIMIT </span> </a> </li> <li class=md-nav__item> <a href=#backup-fetch-wal-fetch class=md-nav__link> <span class=md-ellipsis> 下载并行 backup-fetch 或 wal-fetch </span> </a> </li> <li class=md-nav__item> <a href=#wal-push class=md-nav__link> <span class=md-ellipsis> 上传并行 wal-push </span> </a> </li> <li class=md-nav__item> <a href=#backup-push class=md-nav__link> <span class=md-ellipsis> 上传并行 backup-push </span> </a> </li> <li class=md-nav__item> <a href=#delta class=md-nav__link> <span class=md-ellipsis> DELTA 备份 </span> </a> </li> <li class=md-nav__item> <a href=#bundle class=md-nav__link> <span class=md-ellipsis> bundle 大小 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 使用 </span> </a> <nav class=md-nav aria-label=使用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 备份数据 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 恢复数据 </span> </a> </li> <li class=md-nav__item> <a href=#wal_2 class=md-nav__link> <span class=md-ellipsis> 备份 wal </span> </a> </li> <li class=md-nav__item> <a href=#wal_3 class=md-nav__link> <span class=md-ellipsis> 恢复 wal </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 删除归档 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 远程备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 实际应用 </span> </a> <nav class=md-nav aria-label=实际应用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 数据备份 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 数据恢复 </span> </a> </li> <li class=md-nav__item> <a href=#partial-restore-experimental class=md-nav__link> <span class=md-ellipsis> Partial restore (experimental) </span> </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 定时任务 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../pgcopydb/ class=md-nav__link> <span class=md-ellipsis> pgcopydb迁移 </span> </a> </li> <li class=md-nav__item> <a href=../reback/ class=md-nav__link> <span class=md-ellipsis> 数据恢复基础 </span> </a> </li> <li class=md-nav__item> <a href=../reback_supper_user/ class=md-nav__link> <span class=md-ellipsis> 超级用户恢复 </span> </a> </li> <li class=md-nav__item> <a href=../pitr/ class=md-nav__link> <span class=md-ellipsis> PITR备份恢复 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_11> <label class=md-nav__link for=__nav_2_11 id=__nav_2_11_label tabindex> <span class=md-ellipsis> 安全管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_11_label aria-expanded=false> <label class=md-nav__title for=__nav_2_11> <span class="md-nav__icon md-icon"></span> 安全管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../security/role-manager/ class=md-nav__link> <span class=md-ellipsis> 角色管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/PrivilegeManagement/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../security/login_nopasswd/ class=md-nav__link> <span class=md-ellipsis> 连接认证 </span> </a> </li> <li class=md-nav__item> <a href=../../security/ssl/ class=md-nav__link> <span class=md-ellipsis> SSL安全 </span> </a> </li> <li class=md-nav__item> <a href=../../security/prepare/ class=md-nav__link> <span class=md-ellipsis> 备用服务 </span> </a> </li> <li class=md-nav__item> <a href=../../security/readonly/ class=md-nav__link> <span class=md-ellipsis> 只读实例 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_12> <label class=md-nav__link for=__nav_2_12 id=__nav_2_12_label tabindex> <span class=md-ellipsis> 高级特性 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_12_label aria-expanded=false> <label class=md-nav__title for=__nav_2_12> <span class="md-nav__icon md-icon"></span> 高级特性 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../design/wal_lsn/ class=md-nav__link> <span class=md-ellipsis> WAL操作详解 </span> </a> </li> <li class=md-nav__item> <a href=../../design/wal_size/ class=md-nav__link> <span class=md-ellipsis> WAL配置大小 </span> </a> </li> <li class=md-nav__item> <a href=../../design/insert01/ class=md-nav__link> <span class=md-ellipsis> 高级插入技巧 </span> </a> </li> <li class=md-nav__item> <a href=../../design/upset/ class=md-nav__link> <span class=md-ellipsis> UPSERT </span> </a> </li> <li class=md-nav__item> <a href=../../design/hll/ class=md-nav__link> <span class=md-ellipsis> HLL统计 </span> </a> </li> <li class=md-nav__item> <a href=../../design/pg_json/ class=md-nav__link> <span class=md-ellipsis> JSON处理 </span> </a> </li> <li class=md-nav__item> <a href=../../design/pg_trgm/ class=md-nav__link> <span class=md-ellipsis> TRGM相似搜索 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_13> <label class=md-nav__link for=__nav_2_13 id=__nav_2_13_label tabindex> <span class=md-ellipsis> 数据库设计 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_13_label aria-expanded=false> <label class=md-nav__title for=__nav_2_13> <span class="md-nav__icon md-icon"></span> 数据库设计 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../design/normal-form/ class=md-nav__link> <span class=md-ellipsis> 范式理论 </span> </a> </li> <li class=md-nav__item> <a href=../../design/materialized/ class=md-nav__link> <span class=md-ellipsis> 物化视图 </span> </a> </li> <li class=md-nav__item> <a href=../../design/extention/ class=md-nav__link> <span class=md-ellipsis> 扩展功能 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_14> <label class=md-nav__link for=__nav_2_14 id=__nav_2_14_label tabindex> <span class=md-ellipsis> 工具集 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_14_label aria-expanded=false> <label class=md-nav__title for=__nav_2_14> <span class="md-nav__icon md-icon"></span> 工具集 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tools/pgbench/ class=md-nav__link> <span class=md-ellipsis> pgbench压测 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_elk/ class=md-nav__link> <span class=md-ellipsis> 集群扩展 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_pathman/ class=md-nav__link> <span class=md-ellipsis> pgpathman分片 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_prewarm/ class=md-nav__link> <span class=md-ellipsis> 预加载缓存 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_buffercache/ class=md-nav__link> <span class=md-ellipsis> 统计预缓存 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pgfincore/ class=md-nav__link> <span class=md-ellipsis> 模糊查询 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/lock_wait/ class=md-nav__link> <span class=md-ellipsis> 锁等待分析 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pgage/ class=md-nav__link> <span class=md-ellipsis> 行数统计 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pgwatch2/ class=md-nav__link> <span class=md-ellipsis> 监控系统 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_rewrite/ class=md-nav__link> <span class=md-ellipsis> 备份压缩 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_prewarm/ class=md-nav__link> <span class=md-ellipsis> 大页支持 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_lock/ class=md-nav__link> <span class=md-ellipsis> 读写分析 </span> </a> </li> <li class=md-nav__item> <a href=../../install/pgstattuple/ class=md-nav__link> <span class=md-ellipsis> 表分析 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_citus/ class=md-nav__link> <span class=md-ellipsis> CITUS扩展 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_15> <label class=md-nav__link for=__nav_2_15 id=__nav_2_15_label tabindex> <span class=md-ellipsis> 版本与历史 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_15_label aria-expanded=false> <label class=md-nav__title for=__nav_2_15> <span class="md-nav__icon md-icon"></span> 版本与历史 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/postgres12/ class=md-nav__link> <span class=md-ellipsis> 12版特性 </span> </a> </li> <li class=md-nav__item> <a href=../../install/postgresql-howto/ class=md-nav__link> <span class=md-ellipsis> 使用指南 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/tpch/ class=md-nav__link> <span class=md-ellipsis> TPC-H基准 </span> </a> </li> <li class=md-nav__item> <a href=../../maintenance/archive/ class=md-nav__link> <span class=md-ellipsis> 备份归档 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/citus01/ class=md-nav__link> <span class=md-ellipsis> 扩展目录 </span> </a> </li> <li class=md-nav__item> <a href=../../install/config/ class=md-nav__link> <span class=md-ellipsis> 配置文件目录 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/monitor/ class=md-nav__link> <span class=md-ellipsis> 监控目录 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_16> <label class=md-nav__link for=__nav_2_16 id=__nav_2_16_label tabindex> <span class=md-ellipsis> 架构与原理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_16_label aria-expanded=false> <label class=md-nav__title for=__nav_2_16> <span class="md-nav__icon md-icon"></span> 架构与原理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/cluster/ class=md-nav__link> <span class=md-ellipsis> 数据库架构 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/debezium/ class=md-nav__link> <span class=md-ellipsis> 系统分析 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/dts/ class=md-nav__link> <span class=md-ellipsis> 迁移与DTS </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/explain/ class=md-nav__link> <span class=md-ellipsis> 系统锁定分析 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/libpg/ class=md-nav__link> <span class=md-ellipsis> 登录处理流程 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_rewrite/ class=md-nav__link> <span class=md-ellipsis> 功能分析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_17> <label class=md-nav__link for=__nav_2_17 id=__nav_2_17_label tabindex> <span class=md-ellipsis> 故障排除与问题解决 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_17_label aria-expanded=false> <label class=md-nav__title for=__nav_2_17> <span class="md-nav__icon md-icon"></span> 故障排除与问题解决 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../troubleshooting/oom/ class=md-nav__link> <span class=md-ellipsis> OOM问题 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/auto_vacuum_trigger/ class=md-nav__link> <span class=md-ellipsis> 空间自动清理 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_prewarm/ class=md-nav__link> <span class=md-ellipsis> 数据预加载 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/awsome-postgres/ class=md-nav__link> <span class=md-ellipsis> 案例研究 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../middleware/ class="md-nav__link "> <span class=md-ellipsis> 中间件 </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 中间件 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <div class="md-nav__link md-nav__container"> <a href=../../../clickhouse/install/ class="md-nav__link "> <span class=md-ellipsis> ClickHouse </span> </a> <label class="md-nav__link " for=__nav_3_2 id=__nav_3_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> ClickHouse </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../clickhouse/install/install_single/ class=md-nav__link> <span class=md-ellipsis> 单机版 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/install/install_cluster/ class=md-nav__link> <span class=md-ellipsis> 集群版 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/ch-keeper/ class=md-nav__link> <span class=md-ellipsis> keeper </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/demo/ class=md-nav__link> <span class=md-ellipsis> 表引擎 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/compresstion/ class=md-nav__link> <span class=md-ellipsis> 压缩 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/restore/ class=md-nav__link> <span class=md-ellipsis> 恢复 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex> <span class=md-ellipsis> MongoDB </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> MongoDB </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mongodb/install/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/replication/ class=md-nav__link> <span class=md-ellipsis> 副本集 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/sharding/ class=md-nav__link> <span class=md-ellipsis> 分片集群 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/privilege/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> 监控系统 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> 监控系统 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../monitor/prometheus/ class=md-nav__link> <span class=md-ellipsis> Prometheus </span> </a> </li> <li class=md-nav__item> <a href=../../../monitor/grafana/ class=md-nav__link> <span class=md-ellipsis> Grafana </span> </a> </li> <li class=md-nav__item> <a href=../../../monitor/exporter/ class=md-nav__link> <span class=md-ellipsis> exporter </span> </a> </li> <li class=md-nav__item> <a href=../../../monitor/metrics/ class=md-nav__link> <span class=md-ellipsis> 监控指标 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> fluentbit </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> fluentbit </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../fluentbit/intro/ class=md-nav__link> <span class=md-ellipsis> 介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../fluentbit/problems/ class=md-nav__link> <span class=md-ellipsis> 问题排查 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../../linux/ class="md-nav__link "> <span class=md-ellipsis> Linux </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex> <span class=md-ellipsis> 工具与管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> 工具与管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/tools/ class=md-nav__link> <span class=md-ellipsis> 系统工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ddrescue/ class=md-nav__link> <span class=md-ellipsis> ddrescue 数据恢复 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/elfutil/ class=md-nav__link> <span class=md-ellipsis> ELF 工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/patch/ class=md-nav__link> <span class=md-ellipsis> 补丁管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/smartctl/ class=md-nav__link> <span class=md-ellipsis> 硬件管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ipmitool/ class=md-nav__link> <span class=md-ellipsis> 远程管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex> <span class=md-ellipsis> 虚拟化与容器 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> 虚拟化与容器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/kvm01/ class=md-nav__link> <span class=md-ellipsis> KVM 虚拟化 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/kuberctl/ class=md-nav__link> <span class=md-ellipsis> Kubernetes 工具 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex> <span class=md-ellipsis> 安全与管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> 安全与管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/webmanage/ class=md-nav__link> <span class=md-ellipsis> Web 安全管理 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> 数据库思考 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 数据库思考 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../maintenance/thinking_in_db_fd/ class=md-nav__link> <span class=md-ellipsis> 结构设计 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_performance/ class=md-nav__link> <span class=md-ellipsis> 性能优化 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_tune/ class=md-nav__link> <span class=md-ellipsis> 模块调优 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#minio class=md-nav__link> <span class=md-ellipsis> 存储服务 minio </span> </a> </li> <li class=md-nav__item> <a href=#wal-g_1 class=md-nav__link> <span class=md-ellipsis> wal-g 下载 </span> </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 设置环境变量 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 数据备份 </span> </a> <nav class=md-nav aria-label=数据备份> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 全量备份 </span> </a> </li> <li class=md-nav__item> <a href=#wal class=md-nav__link> <span class=md-ellipsis> wal 日志备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 恢复数据 </span> </a> <nav class=md-nav aria-label=恢复数据> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 查看所有全备份 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 下载一个全备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 管理存储 </span> </a> <nav class=md-nav aria-label=管理存储> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 清理存储 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#wal_1 class=md-nav__link> <span class=md-ellipsis> 将现有的所有 wal 上传 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 定期全备份及清理 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 注意事项 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 思考 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 其他有用脚本 </span> </a> </li> <li class=md-nav__item> <a href=#wal-g-30 class=md-nav__link> <span class=md-ellipsis> wal-g 3.0 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> <nav class=md-nav aria-label=安装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#centos-7 class=md-nav__link> <span class=md-ellipsis> centos 7 安装 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> <nav class=md-nav aria-label=配置> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 压缩 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 加密 </span> </a> <nav class=md-nav aria-label=加密> <ul class=md-nav__list> <li class=md-nav__item> <a href=#yandex-cloud-kms class=md-nav__link> <span class=md-ellipsis> 结合三方加密 Yandex Cloud KMS </span> </a> </li> <li class=md-nav__item> <a href=#libsodium class=md-nav__link> <span class=md-ellipsis> LIBSODIUM 加密算法 </span> </a> </li> <li class=md-nav__item> <a href=#openpgp class=md-nav__link> <span class=md-ellipsis> OpenPGP 加密 </span> </a> </li> <li class=md-nav__item> <a href=#envelope-pgp class=md-nav__link> <span class=md-ellipsis> Envelope PGP 混合加密 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#for-postgres class=md-nav__link> <span class=md-ellipsis> FOR postgres 配置 </span> </a> <nav class=md-nav aria-label="FOR postgres 配置"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#walg_disk_rate_limit class=md-nav__link> <span class=md-ellipsis> WALG_DISK_RATE_LIMIT </span> </a> </li> <li class=md-nav__item> <a href=#backup-fetch-wal-fetch class=md-nav__link> <span class=md-ellipsis> 下载并行 backup-fetch 或 wal-fetch </span> </a> </li> <li class=md-nav__item> <a href=#wal-push class=md-nav__link> <span class=md-ellipsis> 上传并行 wal-push </span> </a> </li> <li class=md-nav__item> <a href=#backup-push class=md-nav__link> <span class=md-ellipsis> 上传并行 backup-push </span> </a> </li> <li class=md-nav__item> <a href=#delta class=md-nav__link> <span class=md-ellipsis> DELTA 备份 </span> </a> </li> <li class=md-nav__item> <a href=#bundle class=md-nav__link> <span class=md-ellipsis> bundle 大小 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 使用 </span> </a> <nav class=md-nav aria-label=使用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 备份数据 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 恢复数据 </span> </a> </li> <li class=md-nav__item> <a href=#wal_2 class=md-nav__link> <span class=md-ellipsis> 备份 wal </span> </a> </li> <li class=md-nav__item> <a href=#wal_3 class=md-nav__link> <span class=md-ellipsis> 恢复 wal </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 删除归档 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 远程备份 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 实际应用 </span> </a> <nav class=md-nav aria-label=实际应用> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 数据备份 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 数据恢复 </span> </a> </li> <li class=md-nav__item> <a href=#partial-restore-experimental class=md-nav__link> <span class=md-ellipsis> Partial restore (experimental) </span> </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 定时任务 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=wal-g>利用 wal-g 管理数据库备份和恢复</h1> <h2 id=minio>存储服务 minio</h2> <p>设置用户名和密码</p> <pre><code>docker run -d -p 9000:9000 -e MINIO_ACCESS_KEY=xxxxx(changeme) -e MINIO_SECRET_KEY=kkkkk(changeme)  -v /data/minio/:/data  minio/minio server /data
</code></pre> <p>创建 bucket</p> <pre><code>mc mb local/buecket003
</code></pre> <h2 id=wal-g_1>wal-g 下载</h2> <pre><code>wget https://github.com/wal-g/wal-g/releases/download/v0.2.9/wal-g.linux-amd64.tar.gz

tar -zxvf wal-g.linux-amd64.tar.gz
</code></pre> <h2 id=_1>设置环境变量</h2> <p>minio</p> <p>cat wal-g.env</p> <pre><code>export PGDATA=/var/lib/pgsql/10/data/
export WALG_S3_PREFIX=s3://bucket003/
export PGPORT=5432
export PGUSER=postgres
export AWS_SECRET_ACCESS_KEY=xxxxx(changeme)
export AWS_REGION=us-east-1
export AWS_ACCESS_KEY_ID=kkkkk(changeme)
export AWS_ENDPOINT=http://localhost:9000
export AWS_S3_FORCE_PATH_STYLE=true
</code></pre> <p>swift</p> <pre><code>export PGDATA=
export WALG_SWIFT_PREFIX=swift://buckt003/
export PGPORT=
export PGUSER=
export OS_USERNAME=
export OS_PASSWORD=
export OS_AUTH_URL=http://ip:port/auth/v1.0
</code></pre> <h2 id=_2>数据备份</h2> <h3 id=_3>全量备份</h3> <p>定时任务，周期备份全量数据</p> <pre><code>source mydir/wal-g.env &amp;&amp;  wal-g  backup-push $PGDATA
</code></pre> <h3 id=wal>wal 日志备份</h3> <p>设置数据库配置文件，备份 wal 日志文件</p> <pre><code>archive_mode = on ## 从库 always
archive_command = 'source mydir/wal-g.env &amp;&amp;  wal-g wal-push %p'
archive_timeout = 60
</code></pre> <h2 id=_4>恢复数据</h2> <h3 id=_5>查看所有全备份</h3> <pre><code>wal-g backup-list
name                          last_modified        wal_segment_backup_start
base_000000020000001E000000CB 2019-11-07T01:34:08Z 000000020000001E000000CB
base_000000020000001E000000CD 2019-11-07T01:37:03Z 000000020000001E000000CD
base_000000020000001E000000CF 2019-11-07T02:23:34Z 000000020000001E000000CF
base_000000020000001E000000D1 2019-11-07T02:31:00Z 000000020000001E000000D1
base_000000020000001E000000D3 2019-11-07T02:38:29Z 000000020000001E000000D3
base_000000020000001E000000DA 2019-11-07T06:08:19Z 000000020000001E000000DA
base_000000020000001E000000DD 2019-11-07T06:30:24Z 000000020000001E000000DD
base_000000020000001E000000DF 2019-11-07T08:45:30Z 000000020000001E000000DF
</code></pre> <h3 id=_6>下载一个全备份</h3> <p>最近的一个全备份可用 LATEST 表示</p> <pre><code>wal-g backup-fetch /var/lib/pgsql/10/data-restore/ base_000000020000001E000000CB
</code></pre> <p>实时恢复</p> <p>cat recover.conf</p> <pre><code>restore_command = 'source mydir/wal-g.env &amp;&amp; wal-g wal-fetch %f %p'
recovery_target_time='2019-09-10 09:51:55.794813+08'
recovery_target_timeline='latest'
</code></pre> <p>关闭数据库 pause 状态</p> <pre><code>select pg_wal_replay_resume();
</code></pre> <h2 id=_7>管理存储</h2> <h3 id=_8>清理存储</h3> <p>保留最近的 10 个备份及 wal</p> <pre><code>wal-g delete  retain  FULL  10 (试删)

wal-g delete  retain  FULL  10  --confirm （真删）
</code></pre> <p>删除某个备份前的备份</p> <pre><code>wal-g delete before backup_name
</code></pre> <h2 id=wal_1>将现有的所有 wal 上传</h2> <p>cat wal-push-all.sh</p> <pre><code>#!/bin/bash
#print the directory and file

for file in $PGDATA/pg_wal/*
do
if [ -f &quot;$file&quot; ]
then
  wal-g wal-push $file
fi
done
</code></pre> <h2 id=_9>定期全备份及清理</h2> <p>cat /etc/cron.weekly/pg_backup_retain.sh 例如每周一个全备份，保留近半年数据</p> <pre><code>source mydir/wal-g.env &amp;&amp;  wal-g  backup-push $PGDATA
source mydir/wal-g.env &amp;&amp;  wal-g delete retain FULL 26 --confirm
</code></pre> <h2 id=_10>注意事项</h2> <p>1 需要先进行 wal 日志的备份再进行全备份。否则在恢复的时候可能会遗漏期间的 wal 日志。</p> <p>2 全备份需要等待当前 wal 日志发生切换才能完成。如果是写入慢或暂无写入数据库可执行 select pg_switch_wal() 进行手动触发。</p> <p>3 全备份不包括 pg_wal 目录下的 wal 日志文件</p> <h2 id=_11>思考</h2> <p>归档备份 wal 日志 会比生产系统的数据库滞后一个 wal 文件 。 是当 wal 日志写满或切换写新 wal 日志的时候触发的归档 。</p> <p>如果需要使用归档文件恢复数据库时需要考虑时候可以找到最近的 wal 日志文件，比如在从库中。</p> <h2 id=_12>其他有用脚本</h2> <p>下载一段连续范围内的 wal 日志文件 到目录 walbackup 目录中，防止下载过程中出现网络问题等。可重复多次执行</p> <p>cat refetch_wal.sh</p> <pre><code>walfiles=$(python calc_wal.py $1 $2)

source mydir/wal-g.env

for wal_seq in $walfiles; do
 if [[ ! -f walbackup/&quot;$wal_seq&quot; ]];then
   wal-g wal-fetch $wal_seq walbackup/$wal_seq
   echo &quot;fetch wal file &quot; $wal_seq
 fi
done
</code></pre> <p>cat calc_wal.py</p> <pre><code>import sys


def next_str(start):
    s_8 = start[:8]
    s_16 = start[8:16]
    s_24 = start[16:]
    if s_24.endswith('FF'):
        s_24 = hex(int('01',base=16))[2:].zfill(8)
        s_16 = hex(int(s_16, base=16) + 1)[2:].zfill(8)
    else:
        s_24 = hex(int(s_24, base=16) + 1)[2:].zfill(8)
    return ''.join([s_8, s_16, s_24]).upper()


def get_all(start, end):
    start = start.upper()
    end = end.upper()
    new_seq = None
    print(start)
    while new_seq != end:
        new_seq = next_str(new_seq if new_seq is not None else start)
        print(new_seq)


if __name__ == &quot;__main__&quot;:
    get_all(sys.argv[1], sys.argv[2])

</code></pre> <p>使用方法</p> <p>refetch_wal.sh wal 开始文件名 wal 结束文件名</p> <h2 id=wal-g-30>wal-g 3.0</h2> <h2 id=_13>安装</h2> <p>官方目前只提供 ubuntu 系统的编译文件，其他环境需要自己进行编译</p> <h3 id=centos-7>centos 7 安装</h3> <pre><code># 1. 安装基础依赖
sudo yum groupinstall &quot;Development Tools&quot; -y
sudo yum install epel-release -y
sudo yum install git wget cmake3 brotli-devel libsodium-devel -y
sudo ln -sf /usr/bin/cmake3 /usr/bin/cmake

# 2. 安装最新版 Go 编译器 (CentOS 7 默认 Go 版本过低)

GO_VERSION=1.25.2
# 根据需要调整版本
wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz

# 3. 配置 Go 环境变量
echo 'export PATH=$PATH:/usr/local/go/bin' &gt;&gt; ~/.bashrc
echo 'export GOPATH=$HOME/go' &gt;&gt; ~/.bashrc
source ~/.bashrc

# 4. 获取 WAL-G 源码
mkdir -p $GOPATH/src/github.com/wal-g
git clone https://github.com/wal-g/wal-g.git $GOPATH/src/github.com/wal-g/wal-g
cd $GOPATH/src/github.com/wal-g/wal-g
git checkout v3.0.5

# 5. 配置编译选项（启用压缩优化）
export USE_BROTLI=1
export USE_LIBSODIUM=1


# 6. 编译 PostgreSQL 版本
make deps            # 安装Go依赖
make pg_build        # 编译主程序

# 7. 验证安装
$GOPATH/src/github.com/wal-g/wal-g/main/pg/wal-g --version
</code></pre> <h2 id=_14>配置</h2> <p>提供两种配置管理方式</p> <ul> <li>环境变量</li> <li>配置文件</li> </ul> <h3 id=_15>压缩</h3> <p>WALG_COMPRESSION_METHOD</p> <ul> <li>lz4 默认， 最快</li> <li>lzma 压缩率最高约 6 倍 lz4，速度慢</li> <li>zstd</li> <li>brotli</li> </ul> <h3 id=_16>加密</h3> <h4 id=yandex-cloud-kms>结合三方加密 Yandex Cloud KMS</h4> <h4 id=libsodium>LIBSODIUM 加密算法</h4> <ul> <li>WALG_LIBSODIUM_KEY</li> <li>WALG_LIBSODIUM_KEY_PATH</li> <li>WALG_LIBSODIUM_KEY_TRANSFORM</li> </ul> <p><strong>三变量协同关系</strong></p> <p><strong>密钥来源</strong></p> <table> <thead> <tr> <th>变量</th> <th>作用</th> </tr> </thead> <tbody> <tr> <td><code>WALG_LIBSODIUM_KEY</code></td> <td><strong>直接赋值密钥</strong>（如 <code>export WALG_LIBSODIUM_KEY="d0b1e2..."</code>）</td> </tr> <tr> <td><code>WALG_LIBSODIUM_KEY_PATH</code></td> <td><strong>从文件读取密钥</strong>（文件内容自动去除空格/换行符）</td> </tr> </tbody> </table> <blockquote> <p>✅ <strong>优先级</strong>：若同时设置，<code>WALG_LIBSODIUM_KEY</code> 优先于 <code>WALG_LIBSODIUM_KEY_PATH</code></p> </blockquote> <p><strong>密钥格式转换 (<code>WALG_LIBSODIUM_KEY_TRANSFORM</code>)</strong></p> <p>密钥需精确 <strong>32 字节</strong>（256 位），用户输入的原始数据需转换：</p> <table> <thead> <tr> <th>转换类型</th> <th>操作方式</th> <th>适用场景</th> </tr> </thead> <tbody> <tr> <td><code>hex</code></td> <td>将<strong>十六进制字符串</strong>转换为二进制（如 <code>"1a2b3c"</code> → <code>0x1a 0x2b 0x3c...</code>）</td> <td><code>openssl rand -hex 32</code> 生成的密钥</td> </tr> <tr> <td><code>base64</code></td> <td>解码 <strong>Base64 字符串</strong>为二进制</td> <td><code>openssl rand -base64 32</code> 生成的密钥</td> </tr> <tr> <td><code>none</code> (默认)</td> <td><strong>不转换</strong>：<br> - 超长 → 截断前 32 字节<br> - 不足 → 补零至 32 字节</td> <td><strong>不推荐</strong>（安全隐患）</td> </tr> </tbody> </table> <p>应用示例</p> <pre><code class=language-bash># 方式 1：生成 HEX 格式密钥（需设 transform=hex）
openssl rand -hex 32  # 输出类似 deae5d7c7b34a3a5e4e...
export WALG_LIBSODIUM_KEY=&quot;deae5d7c7b34a3a5e4e...&quot;  # 64字符hex串
export WALG_LIBSODIUM_KEY_TRANSFORM=&quot;hex&quot;
</code></pre> <pre><code># 方式 2：生成 Base64 格式密钥（需设 transform=base64）
openssl rand -base64 32  # 输出类似 RvmrEXp9CqO8gU6Zq7b7vw==
echo &quot;RvmrEXp9CqO8gU6Zq7b7vw==&quot; &gt; /etc/walg.key
export WALG_LIBSODIUM_KEY_PATH=&quot;/etc/walg.key&quot;
export WALG_LIBSODIUM_KEY_TRANSFORM=&quot;base64&quot;
</code></pre> <h4 id=openpgp>OpenPGP 加密</h4> <ul> <li>WALG_PGP_KEY</li> <li>WALG_PGP_KEY_PATH</li> <li>WALG_PGP_KEY_PASSPHRASE</li> </ul> <p>与前面使用方式类似</p> <p>具体案例</p> <pre><code># 生成加密文件，根据提示填写
gpg --full-generate-key

# 列成key
gpg --list-keys
 8316E01F780D5E7FBCF722C3C4B51651B1B807F9
# 根据前面列出的key 导出 公钥和私钥
# 公钥
gpg --armor --export 8316E01F780D5E7FBCF722C3C4B51651B1B807F9 &gt; public.key
# 私钥
gpg --armor --export-secret-keys     --pinentry-mode loopback     --passphrase &quot;123&quot;     8316E01F780D5E7FBCF722C3C4B51651B1B807F9 &gt; private.key
</code></pre> <p>wal-push ，backup-push 上传时用公钥 wal-fetch ，backup-fetch 下载时候用私钥</p> <h4 id=envelope-pgp>Envelope PGP 混合加密</h4> <h3 id=for-postgres>FOR postgres 配置</h3> <h4 id=walg_disk_rate_limit>WALG_DISK_RATE_LIMIT</h4> <p>backup-push 磁盘读数据速率限制</p> <h4 id=backup-fetch-wal-fetch>下载并行 backup-fetch 或 wal-fetch</h4> <p>WALG_DOWNLOAD_CONCURRENCY</p> <h4 id=wal-push>上传并行 wal-push</h4> <p>WALG_UPLOAD_CONCURRENCY</p> <h4 id=backup-push>上传并行 backup-push</h4> <p>WALG_UPLOAD_DISK_CONCURRENCY</p> <h4 id=delta>DELTA 备份</h4> <p>WALG_DELTA_MAX_STEPS 默认 0</p> <h4 id=bundle>bundle 大小</h4> <p>WALG_TAR_SIZE_THRESHOLD</p> <h3 id=_17>使用</h3> <h4 id=_18>备份数据</h4> <p>backup-push $PGDATA</p> <h4 id=_19>恢复数据</h4> <p>backup-fetch</p> <h4 id=wal_2>备份 wal</h4> <p>wal-g wal-push</p> <h4 id=wal_3>恢复 wal</h4> <p>wal-g wal-fetch</p> <h4 id=_20>删除归档</h4> <p>wal-g delete</p> <h4 id=_21>远程备份</h4> <p>export PGPORT=xxxx export PGUSER=xxxx export PGPASSWORD=xxx export PGHOST=xxx</p> <p>执行的是 pg_basebackup, 需要 replication 权限</p> <p>只能全备份，不能 delta 备份</p> <p>POSTGER &gt;= 15 版本目前不能远程备份，存在问题</p> <pre><code>wal-g backup-push
</code></pre> <p>适合场景如 kubernets 中的 cronjobs</p> <h3 id=_22>实际应用</h3> <h4 id=_23>配置</h4> <p>/opt/wal-g.env</p> <pre><code>
export AWS_ACCESS_KEY_ID=&quot;xxx&quot;
export AWS_SECRET_ACCESS_KEY=&quot;xxxx&quot;
export WALG_S3_PREFIX=&quot;s3://xxx/&quot;
export AWS_ENDPOINT=&quot;http://xxxx:9000&quot;
export AWS_S3_FORCE_PATH_STYLE=&quot;true&quot;
export AWS_REGION=dx-1
export PGDATA=/var/lib/pgsql/14/data/
export PGPORT=xxx
export PGUSER=poxxstgres
export PGPASSWORD=xxxx
export PGHOST=xxxx
export WALG_TAR_SIZE_THRESHOLD=3221225472
export WALG_DELTA_MAX_STEPS=3
export WALG_UPLOAD_DISK_CONCURRENCY=3
</code></pre> <h4 id=_24>数据备份</h4> <p>主从数据库建议配置相同，单实际上只有主库生效</p> <pre><code># - Archiving -
archive_mode = on               # enables archiving; off, on, or always
                                # (change requires restart)
archive_command = 'source /opt/wal-g.env &amp;&amp;  wal-g wal-push %p'         # command to use to archive a logfile segment
                                # placeholders: %p = path of file to archive
                                #               %f = file name only
                                # e.g. 'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'
archive_timeout = 300           # force a logfile segment switch after thi
</code></pre> <p>从库执行数据完整和增量备份</p> <pre><code class=language-bash># 加载环境变量
source /opt/wal-g.env

# 执行全量备份
wal-g backup-push $PGDATA
</code></pre> <h4 id=_25>数据恢复</h4> <p>数据下载</p> <pre><code class=language-bash># 加载环境变量
source /opt/wal-g.env

# 执行全量备份
wal-g backup-fetch $PGDATA
</code></pre> <p>在启动前根据需求，全新的主库还是从库 配置 postgresql.auto.conf</p> <p>从库建议这两个都配置上，当恢复时使用的 wal 通过 restore_command 从远程恢复后会自动切换到通过 primary_conninfo 获取，当 primary_conninfo 失败是会尝试 restore_command 从远程获取。</p> <pre><code>primary_conninfo =
restore_command =
recovery_target_XXX =
</code></pre> <pre><code>touch $PGDATA/recovery.signal or $PGDATA/standby.signal
</code></pre> <h4 id=partial-restore-experimental>Partial restore (experimental)</h4> <p>部分恢复功能，试验阶段</p> <h4 id=_26>定时任务</h4> <p>cat /etc/cron.weekly/walg-backup-push.sh</p> <pre><code>source /opt/wal-g.env &amp;&amp;  wal-g  backup-push $PGDATA
source /opt/wal-g.env &amp;&amp;  wal-g delete retain FULL 4 --confirm

</code></pre> <p>TODO 如何 监控备份情况</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2026 | Eamon </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.d7c377c4.min.js></script> <script src=../../../custom-js/custom-js.js></script> <script src=../../../redirect-md.js></script> </body> </html>
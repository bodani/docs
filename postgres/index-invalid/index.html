<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Welcome to Shaun's rabbit hole. This site serves as a personal knowledge base for me to record my thoughts and ideas. It is also a place for me to share my knowledge and experience with the world. I hope you find something useful here. "><meta name=author content=Eamon><link href=https://bodani.github.io/docs/postgres/index-invalid/ rel=canonical><link href=../index01/ rel=prev><link href=../hypopg-index/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.3"><title>索引失效 - Tea</title><link rel=stylesheet href=../../assets/stylesheets/main.50c56a3b.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=Tea class="md-header__button md-logo" aria-label=Tea data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Tea </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 索引失效 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../mysql/install/ class=md-tabs__link> MYSQL </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../install01/ class=md-tabs__link> POSTGRES </a> </li> <li class=md-tabs__item> <a href=../../clickhouse/ class=md-tabs__link> ClickHouse </a> </li> <li class=md-tabs__item> <a href=../../middleware/etcd/ class=md-tabs__link> 中间件 </a> </li> <li class=md-tabs__item> <a href=../thinking_in_db_fd/ class=md-tabs__link> 数据库思考 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=Tea class="md-nav__button md-logo" aria-label=Tea data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Tea </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1 id=__nav_1_label tabindex> <span class=md-ellipsis> MYSQL </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> MYSQL </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mysql/install/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../mysql/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=../../mysql/PrivilegeManagement/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../mysql/users/ class=md-nav__link> <span class=md-ellipsis> 用户管理 </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_5> <div class="md-nav__link md-nav__container"> <a href=../../mysql/replication/ class="md-nav__link "> <span class=md-ellipsis> 主从复制 </span> </a> <label class="md-nav__link " for=__nav_1_5 id=__nav_1_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_1_5> <span class="md-nav__icon md-icon"></span> 主从复制 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mysql/replication/replication/ class=md-nav__link> <span class=md-ellipsis> 异步复制 </span> </a> </li> <li class=md-nav__item> <a href=../../mysql/replication/semisync/ class=md-nav__link> <span class=md-ellipsis> 半同步复制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_6> <label class=md-nav__link for=__nav_1_6 id=__nav_1_6_label tabindex> <span class=md-ellipsis> 高可用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_1_6> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mysql/MGR/ class=md-nav__link> <span class=md-ellipsis> 组复制 </span> </a> </li> <li class=md-nav__item> <a href=../../mysql/myshellMGR/ class=md-nav__link> <span class=md-ellipsis> mysqlsh </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_7> <label class=md-nav__link for=__nav_1_7 id=__nav_1_7_label tabindex> <span class=md-ellipsis> 监控 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_7_label aria-expanded=false> <label class=md-nav__title for=__nav_1_7> <span class="md-nav__icon md-icon"></span> 监控 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mysql/exporter/ class=md-nav__link> <span class=md-ellipsis> exporter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_8> <label class=md-nav__link for=__nav_1_8 id=__nav_1_8_label tabindex> <span class=md-ellipsis> 压测 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_8_label aria-expanded=false> <label class=md-nav__title for=__nav_1_8> <span class="md-nav__icon md-icon"></span> 压测 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mysql/mysqlslap/ class=md-nav__link> <span class=md-ellipsis> mysqlslap </span> </a> </li> <li class=md-nav__item> <a href=https://bodani.github.io/mysql45 class=md-nav__link> <span class=md-ellipsis> mysql45 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> POSTGRES </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> POSTGRES </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex> <span class=md-ellipsis> 安装维护 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 安装维护 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../install01/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../config.md class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=../replication01/ class=md-nav__link> <span class=md-ellipsis> 流复制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> 高可用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ha_fd.md class=md-nav__link> <span class=md-ellipsis> 设计分析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> 索引篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 索引篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index01/ class=md-nav__link> <span class=md-ellipsis> 索引类型及使用场景 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 索引失效 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 索引失效 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 简介 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 索引失效的场景 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 实例 </span> </a> <nav class=md-nav aria-label=实例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> <span class=md-ellipsis> 1.任何计算、函数、类型转换 </span> </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> <span class=md-ellipsis> 2.!= </span> </a> </li> <li class=md-nav__item> <a href=#3-not class=md-nav__link> <span class=md-ellipsis> 3. NOT </span> </a> </li> <li class=md-nav__item> <a href=#4 class=md-nav__link> <span class=md-ellipsis> 4.模糊查询通配符在开头 </span> </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> <span class=md-ellipsis> 5.索引字段在表中占比较高 </span> </a> </li> <li class=md-nav__item> <a href=#6btree class=md-nav__link> <span class=md-ellipsis> 6.多字段btree索引查询条件不包含第一列 </span> </a> </li> <li class=md-nav__item> <a href=#7or class=md-nav__link> <span class=md-ellipsis> 7.多字段索引查询条件使用OR（有时也会走索引扫描，但查询效率不高） </span> </a> </li> <li class=md-nav__item> <a href=#8 class=md-nav__link> <span class=md-ellipsis> 8.表中数据量少时 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 利用索引失效改变执行计划案例 </span> </a> <nav class=md-nav aria-label=利用索引失效改变执行计划案例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sql class=md-nav__link> <span class=md-ellipsis> sql 改写 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../hypopg-index/ class=md-nav__link> <span class=md-ellipsis> 假设索引 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex> <span class=md-ellipsis> 备份管理篇 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 备份管理篇 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../logical-backup/ class=md-nav__link> <span class=md-ellipsis> 逻辑备份 </span> </a> </li> <li class=md-nav__item> <a href=../physical-backup/ class=md-nav__link> <span class=md-ellipsis> 物理备份 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex> <span class=md-ellipsis> 数据管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 数据管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../delete/ class=md-nav__link> <span class=md-ellipsis> 删除 </span> </a> </li> <li class=md-nav__item> <a href=../pgstattuple/ class=md-nav__link> <span class=md-ellipsis> 表空间 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../clickhouse/ class="md-nav__link "> <span class=md-ellipsis> ClickHouse </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> ClickHouse </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <div class="md-nav__link md-nav__container"> <a href=../../clickhouse/install/ class="md-nav__link "> <span class=md-ellipsis> 安装 </span> </a> <label class="md-nav__link " for=__nav_3_2 id=__nav_3_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 安装 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../clickhouse/install/install_single/ class=md-nav__link> <span class=md-ellipsis> 单机版 </span> </a> </li> <li class=md-nav__item> <a href=../../clickhouse/install/install_cluster/ class=md-nav__link> <span class=md-ellipsis> 集群版 </span> </a> </li> <li class=md-nav__item> <a href=../../clickhouse/install/install_s3/ class=md-nav__link> <span class=md-ellipsis> 数仓版 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../clickhouse/ch-keeper/ class=md-nav__link> <span class=md-ellipsis> keeper </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> 表引擎 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> 表引擎 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../clickhouse/demo/ class=md-nav__link> <span class=md-ellipsis> Demo </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../clickhouse/compresstion/ class=md-nav__link> <span class=md-ellipsis> 压缩 </span> </a> </li> <li class=md-nav__item> <a href=../../clickhouse/restore/ class=md-nav__link> <span class=md-ellipsis> 恢复 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> 中间件 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 中间件 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../middleware/etcd/ class=md-nav__link> <span class=md-ellipsis> etcd </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex> <span class=md-ellipsis> YugabyteDB </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> YugabyteDB </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../yugabytedb/install/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../yugabytedb/deploy/ class=md-nav__link> <span class=md-ellipsis> 部署 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> 数据库思考 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 数据库思考 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../thinking_in_db_fd/ class=md-nav__link> <span class=md-ellipsis> 结构设计 </span> </a> </li> <li class=md-nav__item> <a href=../thinking_in_db_performance/ class=md-nav__link> <span class=md-ellipsis> 性能优化 </span> </a> </li> <li class=md-nav__item> <a href=../thinking_in_db_tune/ class=md-nav__link> <span class=md-ellipsis> 模块调优 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 简介 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 索引失效的场景 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 实例 </span> </a> <nav class=md-nav aria-label=实例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> <span class=md-ellipsis> 1.任何计算、函数、类型转换 </span> </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> <span class=md-ellipsis> 2.!= </span> </a> </li> <li class=md-nav__item> <a href=#3-not class=md-nav__link> <span class=md-ellipsis> 3. NOT </span> </a> </li> <li class=md-nav__item> <a href=#4 class=md-nav__link> <span class=md-ellipsis> 4.模糊查询通配符在开头 </span> </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> <span class=md-ellipsis> 5.索引字段在表中占比较高 </span> </a> </li> <li class=md-nav__item> <a href=#6btree class=md-nav__link> <span class=md-ellipsis> 6.多字段btree索引查询条件不包含第一列 </span> </a> </li> <li class=md-nav__item> <a href=#7or class=md-nav__link> <span class=md-ellipsis> 7.多字段索引查询条件使用OR（有时也会走索引扫描，但查询效率不高） </span> </a> </li> <li class=md-nav__item> <a href=#8 class=md-nav__link> <span class=md-ellipsis> 8.表中数据量少时 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 利用索引失效改变执行计划案例 </span> </a> <nav class=md-nav aria-label=利用索引失效改变执行计划案例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sql class=md-nav__link> <span class=md-ellipsis> sql 改写 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>索引失效</h1> <h2 id=_1>简介</h2> <p>索引的作用，加速检索，排序，分组。</p> <p>优点： 检索</p> <p>缺点： 新增，更新时需要维护索引，占磁盘空间，创建时锁表。</p> <p>维护： 根据统计表发生全表扫描次数，索引使用次数。合理添加删除索引。</p> <h2 id=_2>索引失效的场景</h2> <p>如果where过滤条件设置不合理，即使索引存在，且where过滤条件中包含索引列，也会导致全表扫描，索引不起作用。什么条件下会导致索引失效呢？</p> <p>1.任何计算、函数、类型转换</p> <p>2.!=</p> <p>3.NOT，相当于使用函数</p> <p>4.模糊查询通配符在开头</p> <p>5.索引字段在表中占比较高</p> <p>6.多字段btree索引查询条件不包含第一列</p> <p>7.多字段索引查询条件使用OR（有时也会走索引扫描，但查询效率不高）</p> <p>8.表中数据量太少时</p> <h2 id=_3>实例</h2> <p>测试表</p> <pre><code>创建表
postgres#=create table tbl_index(a bigint,b timestamp without time zone ,c varchar(12));

插入1kw数据，打开计时器 对比创建索引对数据插入的影响。

postgres=# \timing 
Timing is on.

postgres=# insert into tbl_index select generate_series(1,10000000),clock_timestamp()::timestamp without time zone,'zhang';
INSERT 0 10000000
Time: 25004.214 ms (00:25.004)

postgres=# create index tbl_index_a ON tbl_index using btree (a);
CREATE INDEX
Time: 4119.733 ms (00:04.120)

postgres=# create index tbl_index_b ON tbl_index using btree (b);
CREATE INDEX
Time: 6229.857 ms (00:06.230)

postgres=# insert into tbl_index select generate_series(1,10000000),clock_timestamp()::timestamp without time zone,'eamon';
INSERT 0 10000000
Time: 153963.850 ms (02:33.964)
</code></pre> <p>tips </p> <p>大量数据导入时建议先导入数据后创建索引</p> <p>更新频繁的字段不建议建索引，如update_time</p> <h4 id=1>1.任何计算、函数、类型转换</h4> <pre><code>#索引检索
postgres=# explain analyze select * from tbl_index where a = 100;
                                                       QUERY PLAN                                                        
-------------------------------------------------------------------------------------------------------------------------
 Index Scan using tbl_index_a on tbl_index  (cost=0.44..19.78 rows=4 width=22) (actual time=0.012..0.015 rows=2 loops=1)
   Index Cond: (a = 100)
 Planning time: 0.053 ms
 Execution time: 0.027 ms
(4 rows)

#计算
postgres=# explain analyze select * from tbl_index where a +1 = 100;
                                                           QUERY PLAN                                                           
--------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..263387.92 rows=99999 width=22) (actual time=0.495..478.375 rows=2 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Seq Scan on tbl_index  (cost=0.00..252388.02 rows=41666 width=22) (actual time=220.138..465.801 rows=1 loops=3)
         Filter: ((a + 1) = 100)
         Rows Removed by Filter: 6666666
 Planning time: 0.107 ms
 Execution time: 478.411 ms
(8 rows)
#解决方法
create index tbl_index_a_1 on tbl_index using btree ((a+1));

#类型转换
postgres=# explain analyze select * from tbl_index where a::varchar  = '100';
                                                           QUERY PLAN                                                           
--------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..284221.09 rows=99999 width=22) (actual time=0.529..724.035 rows=2 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Seq Scan on tbl_index  (cost=0.00..273221.19 rows=41666 width=22) (actual time=355.491..713.103 rows=1 loops=3)
         Filter: (((a)::character varying)::text = '100'::text)
         Rows Removed by Filter: 6666666
 Planning time: 0.168 ms
 Execution time: 724.075 ms
(8 rows)

postgres=# explain analyze select * from tbl_index where b::date = '2020-04-15';
                                                             QUERY PLAN                                                             
------------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..263387.92 rows=99999 width=22) (actual time=0.505..4764.531 rows=20000000 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Seq Scan on tbl_index  (cost=0.00..252388.02 rows=41666 width=22) (actual time=0.021..789.147 rows=6666667 loops=3)
         Filter: ((b)::date = '2020-04-15'::date)
 Planning time: 0.146 ms
 Execution time: 5182.919 ms
(7 rows)

Time: 5184.795 ms (00:05.185)

#解决方法 

create index tbl_index_a2str on tbl_index using btree ((a::varchar));
create index tbl_index_b2date on tbl_index using btree ((b::date));

select * from tbl_index where b &lt; '2020-04-16 00:00:00' and b &gt;= '2020-04-15 00:00:00';

</code></pre> <h4 id=2>2.!=</h4> <pre><code>postgres=# explain analyze select * from tbl_index where a != 100;
                                                        QUERY PLAN                                                        
--------------------------------------------------------------------------------------------------------------------------
 Seq Scan on tbl_index  (cost=0.00..377387.04 rows=19999839 width=22) (actual time=0.020..1384.726 rows=19999998 loops=1)
   Filter: (a &lt;&gt; 100)
   Rows Removed by Filter: 2
 Planning time: 0.132 ms
 Execution time: 1790.685 ms
(5 rows)

Time: 1792.412 ms (00:01.792)
</code></pre> <h4 id=3-not>3. NOT</h4> <pre><code>postgres=# explain analyze select * from tbl_index where a is null;
                                                       QUERY PLAN                                                       
------------------------------------------------------------------------------------------------------------------------
 Index Scan using tbl_index_a on tbl_index  (cost=0.44..8.21 rows=1 width=22) (actual time=0.022..0.022 rows=0 loops=1)
   Index Cond: (a IS NULL)
 Planning time: 0.123 ms
 Execution time: 0.055 ms
(4 rows)

Time: 1.694 ms
postgres=# explain analyze select * from tbl_index where a is not null;
                                                        QUERY PLAN                                                        
--------------------------------------------------------------------------------------------------------------------------
 Seq Scan on tbl_index  (cost=0.00..327389.00 rows=20000000 width=22) (actual time=0.025..1375.125 rows=20000000 loops=1)
   Filter: (a IS NOT NULL)
 Planning time: 0.121 ms
 Execution time: 1789.101 ms
(4 rows)

Time: 1790.625 ms (00:01.791)
</code></pre> <h4 id=4>4.模糊查询通配符在开头</h4> <p><a href=../postgres/pg_trgm/ >参见</a></p> <h4 id=5>5.索引字段在表中占比较高</h4> <pre><code>postgres=# create index tbl_index_c on tbl_index using btree (c);
CREATE INDEX
Time: 10552.062 ms (00:10.552)

postgres=# analyze tbl_index ;
ANALYZE
Time: 118.018 ms
postgres=# explain analyze select * from tbl_index where c = 'zhang';
                                                        QUERY PLAN                                                        
--------------------------------------------------------------------------------------------------------------------------
 Seq Scan on tbl_index  (cost=0.00..377389.90 rows=10034703 width=22) (actual time=0.021..1409.096 rows=10000000 loops=1)
   Filter: ((c)::text = 'zhang'::text)
   Rows Removed by Filter: 10000000
 Planning time: 0.562 ms
 Execution time: 1612.769 ms
(5 rows)

Time: 1615.034 ms (00:01.615)

postgres=# explain analyze select * from tbl_index where c = 'eamon';
                                                        QUERY PLAN                                                         
---------------------------------------------------------------------------------------------------------------------------
 Seq Scan on tbl_index  (cost=0.00..377389.90 rows=9965369 width=22) (actual time=616.952..1404.717 rows=10000000 loops=1)
   Filter: ((c)::text = 'eamon'::text)
   Rows Removed by Filter: 10000000
 Planning time: 0.066 ms
 Execution time: 1607.572 ms
(5 rows)

Time: 1609.019 ms (00:01.609)

postgres=# insert into tbl_index values(1,clock_timestamp()::timestamp without time zone,'zhangeamon');
INSERT 0 1
Time: 2.598 ms

postgres=# explain analyze select * from tbl_index where c = 'zhangeamon';
                                                       QUERY PLAN                                                        
-------------------------------------------------------------------------------------------------------------------------
 Index Scan using tbl_index_c on tbl_index  (cost=0.44..7.46 rows=1 width=22) (actual time=0.086..96.848 rows=1 loops=1)
   Index Cond: ((c)::text = 'zhangeamon'::text)
 Planning time: 0.157 ms
 Execution time: 96.881 ms
(4 rows)

Time: 98.464 ms
</code></pre> <h4 id=6btree>6.多字段btree索引查询条件不包含第一列</h4> <pre><code>#创建表
postgres=# create table tbl_indexes(a int ,b varchar,c varchar);
CREATE TABLE
Time: 6.942 ms

#插入数据
postgres=# insert into tbl_indexes select generate_series(1,5000000),substring(md5(random()::text),0,6),substring(md5(random()::text),0,6);
INSERT 0 5000000
Time: 15003.647 ms (00:15.004)

#创建多值索引
postgres=# create index tbl_indexes_a_b_c on tbl_indexes using btree (a,b,c);
CREATE INDEX
Time: 2207.480 ms (00:02.207)

postgres=# select * from tbl_indexes limit 10;
 a  |   b   |   c   
----+-------+-------
  1 | 0e7fb | d6370
  2 | e2eb1 | 51d3e
  3 | 93521 | 5f6b6
  4 | 5880d | 23527
  5 | 66f8e | f462f
  6 | 6ceb3 | c9beb
  7 | 18d44 | 11d64
  8 | f76a4 | edd04
  9 | 91975 | 4c79d
 10 | 56f26 | 09e16
(10 rows)


#走索引
postgres=# explain analyze select * from tbl_indexes where a = 10;
                                                           QUERY PLAN                                                           
--------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tbl_indexes  (cost=582.18..28488.04 rows=25000 width=68) (actual time=0.030..0.031 rows=1 loops=1)
   Recheck Cond: (a = 10)
   Heap Blocks: exact=1
   -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..575.93 rows=25000 width=0) (actual time=0.022..0.022 rows=1 loops=1)
         Index Cond: (a = 10)
 Planning time: 0.127 ms
 Execution time: 0.075 ms
(7 rows)

Time: 2.878 ms
postgres=# explain analyze select * from tbl_indexes where a = 10 and b = '91975';
                                                         QUERY PLAN                                                         
----------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tbl_indexes  (cost=5.71..482.09 rows=125 width=68) (actual time=0.025..0.025 rows=0 loops=1)
   Recheck Cond: ((a = 10) AND ((b)::text = '91975'::text))
   -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..5.68 rows=125 width=0) (actual time=0.022..0.022 rows=0 loops=1)
         Index Cond: ((a = 10) AND ((b)::text = '91975'::text))
 Planning time: 0.146 ms
 Execution time: 0.074 ms
(6 rows)

Time: 2.886 ms
postgres=# explain analyze select * from tbl_indexes where a = 10 and b = '91975' and c = '4c79d';
                                                             QUERY PLAN                                                              
-------------------------------------------------------------------------------------------------------------------------------------
 Index Only Scan using tbl_indexes_a_b_c on tbl_indexes  (cost=0.43..8.45 rows=1 width=68) (actual time=0.025..0.025 rows=0 loops=1)
   Index Cond: ((a = 10) AND (b = '91975'::text) AND (c = '4c79d'::text))
   Heap Fetches: 0
 Planning time: 0.158 ms
 Execution time: 0.067 ms
(5 rows)

Time: 3.136 ms
postgres=# explain analyze select * from tbl_indexes where a = 10  and c = '4c79d';
                                                          QUERY PLAN                                                          
------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tbl_indexes  (cost=638.46..1114.84 rows=125 width=68) (actual time=0.027..0.027 rows=0 loops=1)
   Recheck Cond: ((a = 10) AND ((c)::text = '4c79d'::text))
   -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..638.43 rows=125 width=0) (actual time=0.023..0.024 rows=0 loops=1)
         Index Cond: ((a = 10) AND ((c)::text = '4c79d'::text))
 Planning time: 0.178 ms
 Execution time: 0.077 ms
(6 rows)

Time: 2.917 ms

#不走索引
postgres=# explain analyze select * from tbl_indexes where b = '91975' and c = '4c79d';
                                                         QUERY PLAN                                                          
-----------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..59290.50 rows=125 width=68) (actual time=0.577..127.956 rows=1 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Seq Scan on tbl_indexes  (cost=0.00..58278.00 rows=52 width=68) (actual time=78.366..119.555 rows=0 loops=3)
         Filter: (((b)::text = '91975'::text) AND ((c)::text = '4c79d'::text))
         Rows Removed by Filter: 1666666
 Planning time: 0.154 ms
 Execution time: 127.993 ms
(8 rows)

Time: 130.603 ms

</code></pre> <h4 id=7or>7.多字段索引查询条件使用OR（有时也会走索引扫描，但查询效率不高）</h4> <pre><code>postgres=# explain analyze select * from tbl_indexes where a = 10  or c = '4c79d';
                                                           QUERY PLAN                                                           
--------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..64265.50 rows=49875 width=68) (actual time=0.520..138.035 rows=5 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Seq Scan on tbl_indexes  (cost=0.00..58278.00 rows=20781 width=68) (actual time=52.632..129.858 rows=2 loops=3)
         Filter: ((a = 10) OR ((c)::text = '4c79d'::text))
         Rows Removed by Filter: 1666665
 Planning time: 0.151 ms
 Execution time: 138.075 ms
(8 rows)

Time: 139.952 ms
postgres=# explain analyze select * from tbl_indexes where a = 10  or b = '4c79d';
                                                           QUERY PLAN                                                           
--------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=1000.00..64265.50 rows=49875 width=68) (actual time=0.513..131.024 rows=8 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Seq Scan on tbl_indexes  (cost=0.00..58278.00 rows=20781 width=68) (actual time=51.260..123.413 rows=3 loops=3)
         Filter: ((a = 10) OR ((b)::text = '4c79d'::text))
         Rows Removed by Filter: 1666664
 Planning time: 0.152 ms
 Execution time: 131.064 ms
(8 rows)

Time: 132.946 ms
postgres=# explain analyze select * from tbl_indexes where a = 10  or a = 11;
                                                              QUERY PLAN                                                              
--------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tbl_indexes  (cost=1176.80..29434.85 rows=49875 width=68) (actual time=0.034..0.036 rows=2 loops=1)
   Recheck Cond: ((a = 10) OR (a = 11))
   Heap Blocks: exact=1
   -&gt;  BitmapOr  (cost=1176.80..1176.80 rows=50000 width=0) (actual time=0.026..0.027 rows=0 loops=1)
         -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..575.93 rows=25000 width=0) (actual time=0.020..0.020 rows=1 loops=1)
               Index Cond: (a = 10)
         -&gt;  Bitmap Index Scan on tbl_indexes_a_b_c  (cost=0.00..575.93 rows=25000 width=0) (actual time=0.005..0.005 rows=1 loops=1)
               Index Cond: (a = 11)
 Planning time: 0.152 ms
 Execution time: 0.090 ms
(10 rows)

Time: 2.928 ms

如果检索条件为同一个字段 如a = 1 or a =2  转换为 a in (1,2) 会更优。
</code></pre> <p>如果多个字段为同一类型可使用数组化索引</p> <pre><code>indexdb=# CREATE TABLE tbloom AS
indexdb-#    SELECT
indexdb-#      (random() * 1000000)::int as i1,
indexdb-#      (random() * 1000000)::int as i2,
indexdb-#      (random() * 1000000)::int as i3,
indexdb-#      (random() * 1000000)::int as i4,
indexdb-#      (random() * 1000000)::int as i5,
indexdb-#      (random() * 1000000)::int as i6
indexdb-#    FROM
indexdb-#   generate_series(1,10000000);
SELECT 10000000

-- 创建bloom索引
indexdb=# CREATE index btreeidx ON tbloom (i1, i2, i3, i4, i5, i6);
CREATE INDEX

indexdb=# EXPLAIN ANALYZE SELECT * FROM tbloom WHERE i2 = 898732 OR i5 = 123451;
                                                                  QUERY PLAN                                                                  
----------------------------------------------------------------------------------------------------------------------------------------------
 Gather  (cost=249337.50..385507.50 rows=99750 width=24) (actual time=345.415..684.760 rows=19 loops=1)
   Workers Planned: 2
   Workers Launched: 2
   -&gt;  Parallel Bitmap Heap Scan on tbloom  (cost=248337.50..374532.50 rows=41562 width=24) (actual time=397.157..672.875 rows=6 loops=3)
         Filter: ((i2 = 898732) OR (i5 = 123451))
         Rows Removed by Filter: 3333327
         Heap Blocks: exact=21455
         -&gt;  Bitmap Index Scan on btreeidx  (cost=0.00..248312.56 rows=10000000 width=0) (actual time=331.686..331.686 rows=10000000 loops=1)
 Planning time: 0.165 ms
 Execution time: 684.813 ms
(10 rows)

-- 创建数组化索引
indexdb=# create index ON tbloom USING gin ( (array[i2,i5]));
CREATE INDEX

indexdb=# explain analyze select * from tbloom where (ARRAY[i2, i5]) &amp;&amp; array[898732] or (ARRAY[i2, i5]) &amp;&amp; array[123451];
                                                              QUERY PLAN                                                              
--------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on tbloom  (cost=991.87..68961.41 rows=99750 width=24) (actual time=0.068..0.174 rows=41 loops=1)
   Recheck Cond: ((ARRAY[i2, i5] &amp;&amp; '{898732}'::integer[]) OR (ARRAY[i2, i5] &amp;&amp; '{123451}'::integer[]))
   Heap Blocks: exact=41
   -&gt;  BitmapOr  (cost=991.87..991.87 rows=100000 width=0) (actual time=0.046..0.046 rows=0 loops=1)
         -&gt;  Bitmap Index Scan on tbloom_array_idx  (cost=0.00..471.00 rows=50000 width=0) (actual time=0.030..0.030 rows=23 loops=1)
               Index Cond: (ARRAY[i2, i5] &amp;&amp; '{898732}'::integer[])
         -&gt;  Bitmap Index Scan on tbloom_array_idx  (cost=0.00..471.00 rows=50000 width=0) (actual time=0.015..0.015 rows=18 loops=1)
               Index Cond: (ARRAY[i2, i5] &amp;&amp; '{123451}'::integer[])
 Planning time: 0.266 ms
 Execution time: 0.242 ms
(10 rows)

Time: 1.311 ms
</code></pre> <p>性能提升明显</p> <h4 id=8>8.表中数据量少时</h4> <pre><code>postgres=# create table tbl_index_less(a int);
CREATE TABLE

postgres=# create index tbl_index_less_a on tbl_index_less using btree (a);
CREATE INDEX

-- 加10条
postgres=# insert into tbl_index_less select generate_series(1,10);
INSERT 0 10

postgres=# analyze tbl_index_less ;
ANALYZE

postgres=# explain analyze select * from tbl_index_less where a = 4;
                                               QUERY PLAN                                               
--------------------------------------------------------------------------------------------------------
 Seq Scan on tbl_index_less  (cost=0.00..1.12 rows=1 width=4) (actual time=0.013..0.016 rows=1 loops=1)
   Filter: (a = 4)
   Rows Removed by Filter: 9
 Planning time: 0.276 ms
 Execution time: 0.054 ms
(5 rows)

-- 加100条
postgres=# insert into tbl_index_less select generate_series(10,100);
INSERT 0 91

postgres=# explain analyze select * from tbl_index_less where a = 4;
                                               QUERY PLAN                                               
--------------------------------------------------------------------------------------------------------
 Seq Scan on tbl_index_less  (cost=0.00..2.26 rows=1 width=4) (actual time=0.017..0.033 rows=1 loops=1)
   Filter: (a = 4)
   Rows Removed by Filter: 100
 Planning time: 0.236 ms
 Execution time: 0.062 ms
(5 rows)

-- 1000条
postgres=# insert into tbl_index_less select generate_series(100,1000);
INSERT 0 901

postgres=# analyze tbl_index_less ;
ANALYZE
postgres=# explain analyze select * from tbl_index_less where a = 4;
                                                              QUERY PLAN                                                              
--------------------------------------------------------------------------------------------------------------------------------------
 Index Only Scan using tbl_index_less_a on tbl_index_less  (cost=0.28..8.29 rows=1 width=4) (actual time=0.010..0.010 rows=1 loops=1)
   Index Cond: (a = 4)
   Heap Fetches: 1
 Planning time: 0.073 ms
 Execution time: 0.023 ms
(5 rows)

</code></pre> <p>tips </p> <p>数据库是如何知道表中的数据量及数据分布情况 ，主要是依赖统计信息 pg_class ,pg_stats。</p> <p>当表数据变更很大时，如批量导入数据或删除数据时。需要及时使用analyze更新统计信息。</p> <!--
索引在哪些情况下失效
https://www.cnblogs.com/alianbog/p/5648455.html

--> <p>关于 null https://yq.aliyun.com/articles/241219</p> <p>查看表顺序扫描和索引的次数</p> <pre><code>select * from pg_stat_all_tables where relname = 'tab_name';
select * from pg_stat_all_indexes where relname = 'tbl_name';
</code></pre> <p>创建索引 http://www.cnblogs.com/alianbog/p/5631505.html </p> <p>mysql 索引建议 参考 https://mp.weixin.qq.com/s/xdbo67F72a9eTV93TEuL6w</p> <p><a href=https://github.com/powa-team/pg_qualstats>索引利用统计</a></p> <pre><code>A PostgreSQL extension for collecting statistics about predicates, helping find what indices are missing
</code></pre> <h2 id=_4>利用索引失效改变执行计划案例</h2> <p>表定义&amp;数据分布</p> <pre><code>create table tb1(id int primary key,c1 int);
create index on tb1(c1);
insert into tb1 select id, id/10000 from generate_series(1,10000000)id;
</code></pre> <p>SQL&amp;执行计划</p> <pre><code>postgres=# explain analyze select * from tb1 where c1=999 order by id limit 10; QUERY PLAN
-------------------------------------------------------------------------------------------------------------------------------- Limit (cost=0.43..332.29 rows=10 width=8) (actual time=1571.315..1571.319 rows=10 loops=1)
-&gt; Index Scan using tb1_pkey on tb1 (cost=0.43..328935.03 rows=9912 width=8) (actual time=1571.314..1571.316 rows=10 loops=1)
Filter: (c1 = 999)
Rows Removed by Filter: 9989999 Planning Time: 0.112 ms
Execution Time: 1571.337 ms
(6 rows)
</code></pre> <p>上面Index Scan估算的行数和cost都比较准确，但评估LIMIT子句时，优化器假设数据分布是均匀的， 只需扫描主键索引的 10/9912即可找到10条匹配的记录，最终的估算代价也被LIMIT降到10/9921。但实际上满足条件的记录都集中在索引的尾部。</p> <h4 id=sql>sql 改写</h4> <p>SQL改写方法1:破坏索引排序</p> <pre><code>select * from tb1 where c1=999 order by id+0 limit 10;
</code></pre> <p>SQL改写方法2:物化子查询</p> <pre><code>WITH t AS MATERIALIZED(
select * from tb1 where c1=999 )
select * from t order by id limit 10
</code></pre> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2021-2025 | Eamon </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.d7c377c4.min.js></script> </body> </html>
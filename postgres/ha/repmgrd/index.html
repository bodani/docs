<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Welcome to Shaun's rabbit hole. This site serves as a personal knowledge base for me to record my thoughts and ideas. It is also a place for me to share my knowledge and experience with the world. I hope you find something useful here."><meta name=author content=Eamon><link href=https://bodani.github.io/docs/postgres/ha/repmgrd/ rel=canonical><link href=../repmgr/ rel=prev><link href=../adlock/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.3"><title>repmgrd介绍 - TeaLabs</title><link rel=stylesheet href=../../../assets/stylesheets/main.50c56a3b.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><link rel=stylesheet href=../../../custom-style/custom-styles.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#repmgrd class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=TeaLabs class="md-header__button md-logo" aria-label=TeaLabs data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> TeaLabs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> repmgrd介绍 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=green data-md-color-accent=deep_orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../mysql/ class=md-tabs__link> MYSQL </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> PostgreSQL </a> </li> <li class=md-tabs__item> <a href=../../../middleware/ class=md-tabs__link> 中间件 </a> </li> <li class=md-tabs__item> <a href=../../../kubernetes/sts_update/ class=md-tabs__link> 容器 </a> </li> <li class=md-tabs__item> <a href=../../../linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../maintenance/thinking_in_db_fd/ class=md-tabs__link> 数据库思考 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=TeaLabs class="md-nav__button md-logo" aria-label=TeaLabs data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> TeaLabs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <div class="md-nav__link md-nav__container"> <a href=../../../mysql/ class="md-nav__link "> <span class=md-ellipsis> MYSQL </span> </a> <label class="md-nav__link " for=__nav_1 id=__nav_1_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> MYSQL </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/install/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/PrivilegeManagement/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/users/ class=md-nav__link> <span class=md-ellipsis> 用户管理 </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_6> <div class="md-nav__link md-nav__container"> <a href=../../../mysql/replication/ class="md-nav__link "> <span class=md-ellipsis> 主从复制 </span> </a> <label class="md-nav__link " for=__nav_1_6 id=__nav_1_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_1_6> <span class="md-nav__icon md-icon"></span> 主从复制 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/replication/replication/ class=md-nav__link> <span class=md-ellipsis> 异步复制 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/replication/semisync/ class=md-nav__link> <span class=md-ellipsis> 半同步复制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_7> <label class=md-nav__link for=__nav_1_7 id=__nav_1_7_label tabindex> <span class=md-ellipsis> 高可用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_7_label aria-expanded=false> <label class=md-nav__title for=__nav_1_7> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/MGR/ class=md-nav__link> <span class=md-ellipsis> 组复制 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/myshellMGR/ class=md-nav__link> <span class=md-ellipsis> mysqlsh </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_8> <label class=md-nav__link for=__nav_1_8 id=__nav_1_8_label tabindex> <span class=md-ellipsis> 监控 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_8_label aria-expanded=false> <label class=md-nav__title for=__nav_1_8> <span class="md-nav__icon md-icon"></span> 监控 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/exporter/ class=md-nav__link> <span class=md-ellipsis> exporter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1_9> <label class=md-nav__link for=__nav_1_9 id=__nav_1_9_label tabindex> <span class=md-ellipsis> 压测 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_1_9_label aria-expanded=false> <label class=md-nav__title for=__nav_1_9> <span class="md-nav__icon md-icon"></span> 压测 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mysql/mysqlslap/ class=md-nav__link> <span class=md-ellipsis> mysqlslap </span> </a> </li> <li class=md-nav__item> <a href=https://bodani.github.io/mysql45 class=md-nav__link> <span class=md-ellipsis> mysql45 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> PostgreSQL </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> PostgreSQL </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex> <span class=md-ellipsis> 安装与配置 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 安装与配置 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/install01/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../install/install02/ class=md-nav__link> <span class=md-ellipsis> 安装详解 </span> </a> </li> <li class=md-nav__item> <a href=../../install/install/ class=md-nav__link> <span class=md-ellipsis> 安装进阶 </span> </a> </li> <li class=md-nav__item> <a href=../../install/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex> <span class=md-ellipsis> 高可用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=true> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ha_fd/ class=md-nav__link> <span class=md-ellipsis> 设计分析 </span> </a> </li> <li class=md-nav__item> <a href=../patroni/ class=md-nav__link> <span class=md-ellipsis> Patroni集群 </span> </a> </li> <li class=md-nav__item> <a href=../patroni02/ class=md-nav__link> <span class=md-ellipsis> Patroni高级 </span> </a> </li> <li class=md-nav__item> <a href=../pgautofailover/ class=md-nav__link> <span class=md-ellipsis> PGAutofailover </span> </a> </li> <li class=md-nav__item> <a href=../repmgr/ class=md-nav__link> <span class=md-ellipsis> Repmgr </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> RepmgrD </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> RepmgrD </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#repmgrd class=md-nav__link> <span class=md-ellipsis> repmgrd介绍 </span> </a> </li> <li class=md-nav__item> <a href=#repmgrd_1 class=md-nav__link> <span class=md-ellipsis> repmgrd 故障转移 </span> </a> <nav class=md-nav aria-label="repmgrd 故障转移"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 见证节点介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 添加见证节点 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 解决脑裂问题 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 主服务可见性共识 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 从节点断开连接 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 故障转移验证 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 级联复制 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 主节点检测从库连接 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 检测过程和标准 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 注意事项 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 配置参数 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 事件类型 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 查看事件 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#repmgrd_2 class=md-nav__link> <span class=md-ellipsis> repmgrd 配置 </span> </a> <nav class=md-nav aria-label="repmgrd 配置"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 必须设置的参数 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 可选参数 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 其他参数 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 日志自动切割 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#repmgrd_3 class=md-nav__link> <span class=md-ellipsis> repmgrd 操作 </span> </a> <nav class=md-nav aria-label="repmgrd 操作"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#repmgrd_4 class=md-nav__link> <span class=md-ellipsis> repmgrd 维护模式 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 降级模式 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 监控数据存储 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 选举流程简介 </span> </a> <nav class=md-nav aria-label=选举流程简介> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 总结 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 流程图 </span> </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 功能增强 </span> </a> <nav class=md-nav aria-label=功能增强> <ul class=md-nav__list> <li class=md-nav__item> <a href=#virtual-ip class=md-nav__link> <span class=md-ellipsis> Virtual IP </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 主节点异常后恢复处理 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 从节点故障及恢复 </span> </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 对外服务管理 </span> </a> <nav class=md-nav aria-label=对外服务管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_27 class=md-nav__link> <span class=md-ellipsis> 主要功能 </span> </a> </li> <li class=md-nav__item> <a href=#_28 class=md-nav__link> <span class=md-ellipsis> 可解决的问题 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_29 class=md-nav__link> <span class=md-ellipsis> 故障切换时间预估 </span> </a> </li> <li class=md-nav__item> <a href=#_30 class=md-nav__link> <span class=md-ellipsis> 只有两个节点 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../adlock/ class=md-nav__link> <span class=md-ellipsis> 一致性 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <div class="md-nav__link md-nav__container"> <a href=../../index/ class="md-nav__link "> <span class=md-ellipsis> 索引与查询优化 </span> </a> <label class="md-nav__link " for=__nav_2_4 id=__nav_2_4_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 索引与查询优化 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../index/index01/ class=md-nav__link> <span class=md-ellipsis> 索引类型及使用场景 </span> </a> </li> <li class=md-nav__item> <a href=../../index/index-invalid/ class=md-nav__link> <span class=md-ellipsis> 索引失效 </span> </a> </li> <li class=md-nav__item> <a href=../../index/index-bloom/ class=md-nav__link> <span class=md-ellipsis> Bloom索引 </span> </a> </li> <li class=md-nav__item> <a href=../../index/hypopg-index/ class=md-nav__link> <span class=md-ellipsis> 假设索引 </span> </a> </li> <li class=md-nav__item> <a href=../../index/partition/ class=md-nav__link> <span class=md-ellipsis> 表分区 </span> </a> </li> <li class=md-nav__item> <a href=../../index/partman/ class=md-nav__link> <span class=md-ellipsis> Partman插件 </span> </a> </li> <li class=md-nav__item> <a href=../../index/template/ class=md-nav__link> <span class=md-ellipsis> 模板表 </span> </a> </li> <li class=md-nav__item> <a href=../../index/unlogged_table/ class=md-nav__link> <span class=md-ellipsis> 未记录表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex> <span class=md-ellipsis> 性能优化 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 性能优化 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../performance/fillfactor/ class=md-nav__link> <span class=md-ellipsis> 填充因子 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/stat/ class=md-nav__link> <span class=md-ellipsis> 统计信息 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/params/ class=md-nav__link> <span class=md-ellipsis> 参数优化 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/high_level_sql/ class=md-nav__link> <span class=md-ellipsis> 高级SQL </span> </a> </li> <li class=md-nav__item> <a href=../../performance/FunctionsandOperators/ class=md-nav__link> <span class=md-ellipsis> 连接函数 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/vacuum/ class=md-nav__link> <span class=md-ellipsis> VACUUM操作 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/vacuum_limit/ class=md-nav__link> <span class=md-ellipsis> VACUUM限制 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/hotupdate/ class=md-nav__link> <span class=md-ellipsis> 冻结机制 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_performance/ class=md-nav__link> <span class=md-ellipsis> 性能优化思考 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_tune/ class=md-nav__link> <span class=md-ellipsis> 系统调优 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex> <span class=md-ellipsis> 数据维护 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> 数据维护 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/toast/ class=md-nav__link> <span class=md-ellipsis> 事务管理 </span> </a> </li> <li class=md-nav__item> <a href=../../install/delete/ class=md-nav__link> <span class=md-ellipsis> 数据删除 </span> </a> </li> <li class=md-nav__item> <a href=../../install/checkpoint/ class=md-nav__link> <span class=md-ellipsis> 检查点 </span> </a> </li> <li class=md-nav__item> <a href=../../install/daily_management/ class=md-nav__link> <span class=md-ellipsis> 日常管理 </span> </a> </li> <li class=md-nav__item> <a href=../../install/bgwriter/ class=md-nav__link> <span class=md-ellipsis> BGWriter </span> </a> </li> <li class=md-nav__item> <a href=../../install/tablespace/ class=md-nav__link> <span class=md-ellipsis> 表空间 </span> </a> </li> <li class=md-nav__item> <a href=../../install/pgstattuple/ class=md-nav__link> <span class=md-ellipsis> 空间工具 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_rewrite.md class=md-nav__link> <span class=md-ellipsis> 表迁移 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_pathman.md class=md-nav__link> <span class=md-ellipsis> pg_pathman </span> </a> </li> <li class=md-nav__item> <a href=../../maintenance/partition/ class=md-nav__link> <span class=md-ellipsis> 分区表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 id=__nav_2_7_label tabindex> <span class=md-ellipsis> 监控分析 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_7_label aria-expanded=false> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> 监控分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tools/monitor/ class=md-nav__link> <span class=md-ellipsis> 监控基础 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/monitor-sql/ class=md-nav__link> <span class=md-ellipsis> SQL监控 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/view_pg_stat_activity/ class=md-nav__link> <span class=md-ellipsis> STAT视图 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/view_pg_stat_bgwriter/ class=md-nav__link> <span class=md-ellipsis> 统计BGWriter </span> </a> </li> <li class=md-nav__item> <a href=../../tools/monitor_explain/ class=md-nav__link> <span class=md-ellipsis> Explain分析 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_activity/ class=md-nav__link> <span class=md-ellipsis> 活动视图 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/dba/ class=md-nav__link> <span class=md-ellipsis> 数据库监控 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex> <span class=md-ellipsis> 扩展模块 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> 扩展模块 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../extentions/citus01/ class=md-nav__link> <span class=md-ellipsis> Citus分布式 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/citus11/ class=md-nav__link> <span class=md-ellipsis> Citus高级 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/timescaledb/ class=md-nav__link> <span class=md-ellipsis> TimescaleDB </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pipelinedb01/ class=md-nav__link> <span class=md-ellipsis> PipelineDB </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pipelinedb02/ class=md-nav__link> <span class=md-ellipsis> PipelineDB实战 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pgpool2/ class=md-nav__link> <span class=md-ellipsis> PGPool-II </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pgbouncer/ class=md-nav__link> <span class=md-ellipsis> PGBouncer </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pg_rman/ class=md-nav__link> <span class=md-ellipsis> PGBackRMAN </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/pg_fdw/ class=md-nav__link> <span class=md-ellipsis> FDW外部表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_9> <label class=md-nav__link for=__nav_2_9 id=__nav_2_9_label tabindex> <span class=md-ellipsis> 数据同步 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_9_label aria-expanded=false> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> 数据同步 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../replication/replication01/ class=md-nav__link> <span class=md-ellipsis> 流复制 </span> </a> </li> <li class=md-nav__item> <a href=../../replication/replication02/ class=md-nav__link> <span class=md-ellipsis> 复制原理 </span> </a> </li> <li class=md-nav__item> <a href=../../replication/logical-replication/ class=md-nav__link> <span class=md-ellipsis> 逻辑复制 </span> </a> </li> <li class=md-nav__item> <a href=../../replication/logical-replication_failover/ class=md-nav__link> <span class=md-ellipsis> 逻辑复制故障切换 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_rewind/ class=md-nav__link> <span class=md-ellipsis> pg_rewind </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_10> <div class="md-nav__link md-nav__container"> <a href=../../backup/ class="md-nav__link "> <span class=md-ellipsis> 备份与恢复 </span> </a> <label class="md-nav__link " for=__nav_2_10 id=__nav_2_10_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_10_label aria-expanded=false> <label class=md-nav__title for=__nav_2_10> <span class="md-nav__icon md-icon"></span> 备份与恢复 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../backup/logical-backup/ class=md-nav__link> <span class=md-ellipsis> 逻辑备份 </span> </a> </li> <li class=md-nav__item> <a href=../../backup/physical-backup/ class=md-nav__link> <span class=md-ellipsis> 物理备份 </span> </a> </li> <li class=md-nav__item> <a href=../../backup/pgbackrest/ class=md-nav__link> <span class=md-ellipsis> pgBackRest </span> </a> </li> <li class=md-nav__item> <a href=../../backup/wal-g/ class=md-nav__link> <span class=md-ellipsis> WAL-G备份 </span> </a> </li> <li class=md-nav__item> <a href=../../backup/pgcopydb/ class=md-nav__link> <span class=md-ellipsis> pgcopydb迁移 </span> </a> </li> <li class=md-nav__item> <a href=../../backup/reback/ class=md-nav__link> <span class=md-ellipsis> 数据恢复基础 </span> </a> </li> <li class=md-nav__item> <a href=../../backup/reback_supper_user/ class=md-nav__link> <span class=md-ellipsis> 超级用户恢复 </span> </a> </li> <li class=md-nav__item> <a href=../../backup/pitr/ class=md-nav__link> <span class=md-ellipsis> PITR备份恢复 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_11> <label class=md-nav__link for=__nav_2_11 id=__nav_2_11_label tabindex> <span class=md-ellipsis> 安全管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_11_label aria-expanded=false> <label class=md-nav__title for=__nav_2_11> <span class="md-nav__icon md-icon"></span> 安全管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../security/role-manager/ class=md-nav__link> <span class=md-ellipsis> 角色管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../mysql/PrivilegeManagement/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../security/login_nopasswd/ class=md-nav__link> <span class=md-ellipsis> 连接认证 </span> </a> </li> <li class=md-nav__item> <a href=../../security/ssl/ class=md-nav__link> <span class=md-ellipsis> SSL安全 </span> </a> </li> <li class=md-nav__item> <a href=../../security/prepare/ class=md-nav__link> <span class=md-ellipsis> 备用服务 </span> </a> </li> <li class=md-nav__item> <a href=../../security/readonly/ class=md-nav__link> <span class=md-ellipsis> 只读 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_12> <label class=md-nav__link for=__nav_2_12 id=__nav_2_12_label tabindex> <span class=md-ellipsis> 高级特性 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_12_label aria-expanded=false> <label class=md-nav__title for=__nav_2_12> <span class="md-nav__icon md-icon"></span> 高级特性 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../design/wal_lsn/ class=md-nav__link> <span class=md-ellipsis> WAL操作详解 </span> </a> </li> <li class=md-nav__item> <a href=../../design/wal_size/ class=md-nav__link> <span class=md-ellipsis> WAL配置大小 </span> </a> </li> <li class=md-nav__item> <a href=../../design/insert01/ class=md-nav__link> <span class=md-ellipsis> 高级插入技巧 </span> </a> </li> <li class=md-nav__item> <a href=../../design/upset/ class=md-nav__link> <span class=md-ellipsis> UPSERT </span> </a> </li> <li class=md-nav__item> <a href=../../design/hll/ class=md-nav__link> <span class=md-ellipsis> HLL统计 </span> </a> </li> <li class=md-nav__item> <a href=../../design/pg_json/ class=md-nav__link> <span class=md-ellipsis> JSON处理 </span> </a> </li> <li class=md-nav__item> <a href=../../design/pg_trgm/ class=md-nav__link> <span class=md-ellipsis> TRGM相似搜索 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_13> <label class=md-nav__link for=__nav_2_13 id=__nav_2_13_label tabindex> <span class=md-ellipsis> 数据库设计 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_13_label aria-expanded=false> <label class=md-nav__title for=__nav_2_13> <span class="md-nav__icon md-icon"></span> 数据库设计 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../design/normal-form/ class=md-nav__link> <span class=md-ellipsis> 范式理论 </span> </a> </li> <li class=md-nav__item> <a href=../../design/materialized/ class=md-nav__link> <span class=md-ellipsis> 物化视图 </span> </a> </li> <li class=md-nav__item> <a href=../../design/extention/ class=md-nav__link> <span class=md-ellipsis> 扩展功能 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_14> <label class=md-nav__link for=__nav_2_14 id=__nav_2_14_label tabindex> <span class=md-ellipsis> 工具集 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_14_label aria-expanded=false> <label class=md-nav__title for=__nav_2_14> <span class="md-nav__icon md-icon"></span> 工具集 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tools/pgbench/ class=md-nav__link> <span class=md-ellipsis> pgbench压测 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_elk/ class=md-nav__link> <span class=md-ellipsis> 集群扩展 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_prewarm/ class=md-nav__link> <span class=md-ellipsis> 预加载缓存 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_buffercache/ class=md-nav__link> <span class=md-ellipsis> 统计预缓存 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pgfincore/ class=md-nav__link> <span class=md-ellipsis> 模糊查询 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/lock_wait/ class=md-nav__link> <span class=md-ellipsis> 锁等待分析 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pgage/ class=md-nav__link> <span class=md-ellipsis> 行数统计 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pgwatch2/ class=md-nav__link> <span class=md-ellipsis> 监控系统 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_prewarm/ class=md-nav__link> <span class=md-ellipsis> 数据预热 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_lock/ class=md-nav__link> <span class=md-ellipsis> 读写分析 </span> </a> </li> <li class=md-nav__item> <a href=../../install/pgstattuple/ class=md-nav__link> <span class=md-ellipsis> 表分析 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_citus/ class=md-nav__link> <span class=md-ellipsis> CITUS扩展 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_15> <label class=md-nav__link for=__nav_2_15 id=__nav_2_15_label tabindex> <span class=md-ellipsis> 版本与历史 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_15_label aria-expanded=false> <label class=md-nav__title for=__nav_2_15> <span class="md-nav__icon md-icon"></span> 版本与历史 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/postgres12/ class=md-nav__link> <span class=md-ellipsis> 12版特性 </span> </a> </li> <li class=md-nav__item> <a href=../../install/postgresql-howto/ class=md-nav__link> <span class=md-ellipsis> 使用指南 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/tpch/ class=md-nav__link> <span class=md-ellipsis> TPC-H基准 </span> </a> </li> <li class=md-nav__item> <a href=../../maintenance/archive/ class=md-nav__link> <span class=md-ellipsis> 备份归档 </span> </a> </li> <li class=md-nav__item> <a href=../../extentions/citus01/ class=md-nav__link> <span class=md-ellipsis> 扩展目录 </span> </a> </li> <li class=md-nav__item> <a href=../../install/config/ class=md-nav__link> <span class=md-ellipsis> 配置文件目录 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/monitor/ class=md-nav__link> <span class=md-ellipsis> 监控目录 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_16> <label class=md-nav__link for=__nav_2_16 id=__nav_2_16_label tabindex> <span class=md-ellipsis> 架构与原理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_16_label aria-expanded=false> <label class=md-nav__title for=__nav_2_16> <span class="md-nav__icon md-icon"></span> 架构与原理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../install/cluster/ class=md-nav__link> <span class=md-ellipsis> 数据库架构 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/debezium/ class=md-nav__link> <span class=md-ellipsis> 系统分析 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/dts/ class=md-nav__link> <span class=md-ellipsis> 迁移与DTS </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/explain/ class=md-nav__link> <span class=md-ellipsis> 系统锁定分析 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/libpg/ class=md-nav__link> <span class=md-ellipsis> 登录处理流程 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_rewrite.md class=md-nav__link> <span class=md-ellipsis> 功能分析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_17> <label class=md-nav__link for=__nav_2_17 id=__nav_2_17_label tabindex> <span class=md-ellipsis> 故障排除与问题解决 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_17_label aria-expanded=false> <label class=md-nav__title for=__nav_2_17> <span class="md-nav__icon md-icon"></span> 故障排除与问题解决 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../troubleshooting/oom/ class=md-nav__link> <span class=md-ellipsis> OOM问题 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/auto_vacuum_trigger/ class=md-nav__link> <span class=md-ellipsis> 空间自动清理 </span> </a> </li> <li class=md-nav__item> <a href=../../tools/pg_prewarm/ class=md-nav__link> <span class=md-ellipsis> 数据预加载 </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/awsome-postgres/ class=md-nav__link> <span class=md-ellipsis> 案例研究 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../middleware/ class="md-nav__link "> <span class=md-ellipsis> 中间件 </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 中间件 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <div class="md-nav__link md-nav__container"> <a href=../../../clickhouse/install/ class="md-nav__link "> <span class=md-ellipsis> ClickHouse </span> </a> <label class="md-nav__link " for=__nav_3_2 id=__nav_3_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> ClickHouse </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../clickhouse/install/install_single/ class=md-nav__link> <span class=md-ellipsis> 单机版 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/install/install_cluster/ class=md-nav__link> <span class=md-ellipsis> 集群版 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/ch-keeper/ class=md-nav__link> <span class=md-ellipsis> keeper </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/demo/ class=md-nav__link> <span class=md-ellipsis> 表引擎 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/compresstion/ class=md-nav__link> <span class=md-ellipsis> 压缩 </span> </a> </li> <li class=md-nav__item> <a href=../../../clickhouse/restore/ class=md-nav__link> <span class=md-ellipsis> 恢复 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex> <span class=md-ellipsis> MongoDB </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> MongoDB </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mongodb/install/ class=md-nav__link> <span class=md-ellipsis> 安装 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/config/ class=md-nav__link> <span class=md-ellipsis> 配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/replication/ class=md-nav__link> <span class=md-ellipsis> 副本集 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/sharding/ class=md-nav__link> <span class=md-ellipsis> 分片集群 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/privilege/ class=md-nav__link> <span class=md-ellipsis> 权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../mongodb/backup_restore/ class=md-nav__link> <span class=md-ellipsis> 备份恢复 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex> <span class=md-ellipsis> 监控系统 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> 监控系统 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../monitor/prometheus/ class=md-nav__link> <span class=md-ellipsis> Prometheus </span> </a> </li> <li class=md-nav__item> <a href=../../../monitor/grafana/ class=md-nav__link> <span class=md-ellipsis> Grafana </span> </a> </li> <li class=md-nav__item> <a href=../../../monitor/exporter/ class=md-nav__link> <span class=md-ellipsis> exporter </span> </a> </li> <li class=md-nav__item> <a href=../../../monitor/metrics/ class=md-nav__link> <span class=md-ellipsis> 监控指标 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5 id=__nav_3_5_label tabindex> <span class=md-ellipsis> fluentbit </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> fluentbit </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../fluentbit/intro/ class=md-nav__link> <span class=md-ellipsis> 介绍 </span> </a> </li> <li class=md-nav__item> <a href=../../../fluentbit/problems/ class=md-nav__link> <span class=md-ellipsis> 问题排查 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> 容器 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 容器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../kubernetes/sts_update/ class=md-nav__link> <span class=md-ellipsis> sts 滚动更新 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../../../linux/ class="md-nav__link "> <span class=md-ellipsis> Linux </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex> <span class=md-ellipsis> 基础工具与系统管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> 基础工具与系统管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/tools/ class=md-nav__link> <span class=md-ellipsis> 系统工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/process-comm/ class=md-nav__link> <span class=md-ellipsis> 进程管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/sysstat/ class=md-nav__link> <span class=md-ellipsis> 性能监控 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/meminfo/ class=md-nav__link> <span class=md-ellipsis> 内存管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/hard_store/ class=md-nav__link> <span class=md-ellipsis> 磁盘管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/findhidpid/ class=md-nav__link> <span class=md-ellipsis> 文件系统工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/time-cmd/ class=md-nav__link> <span class=md-ellipsis> 时间管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/mail/ class=md-nav__link> <span class=md-ellipsis> 邮件管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cpu_temp/ class=md-nav__link> <span class=md-ellipsis> 电源管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/syslog/ class=md-nav__link> <span class=md-ellipsis> 系统日志 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex> <span class=md-ellipsis> 命令详解与实用工具 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> 命令详解与实用工具 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/cmd-awk/ class=md-nav__link> <span class=md-ellipsis> awk命令详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cmd-gpasswd/ class=md-nav__link> <span class=md-ellipsis> gpasswd命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cmd-sed/ class=md-nav__link> <span class=md-ellipsis> sed命令详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cmd-vim/ class=md-nav__link> <span class=md-ellipsis> vim命令使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cmd-xargs/ class=md-nav__link> <span class=md-ellipsis> xargs命令使用 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/fu-cmd/ class=md-nav__link> <span class=md-ellipsis> 其他常用命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/install-cmd/ class=md-nav__link> <span class=md-ellipsis> 系统安装相关命令 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cmd-pstack/ class=md-nav__link> <span class=md-ellipsis> 安装相关脚本工具 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4> <label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex> <span class=md-ellipsis> 虚拟化与容器技术 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=false> <label class=md-nav__title for=__nav_5_4> <span class="md-nav__icon md-icon"></span> 虚拟化与容器技术 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/kvm01/ class=md-nav__link> <span class=md-ellipsis> KVM 虚拟化 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/kuberctl/ class=md-nav__link> <span class=md-ellipsis> K8s 管理工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/wind-run/ class=md-nav__link> <span class=md-ellipsis> 容器网络管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_5> <label class=md-nav__link for=__nav_5_5 id=__nav_5_5_label tabindex> <span class=md-ellipsis> 硬件与驱动管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5_5> <span class="md-nav__icon md-icon"></span> 硬件与驱动管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/smartctl/ class=md-nav__link> <span class=md-ellipsis> 硬件监控 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/dmidecode/ class=md-nav__link> <span class=md-ellipsis> 硬件信息查询 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/mdadm/ class=md-nav__link> <span class=md-ellipsis> 磁盘阵列管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/hdparm/ class=md-nav__link> <span class=md-ellipsis> 硬盘性能检测 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ipmitool/ class=md-nav__link> <span class=md-ellipsis> 远程硬件管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cpu_utilize/ class=md-nav__link> <span class=md-ellipsis> CPU温度与利用率 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_6> <label class=md-nav__link for=__nav_5_6 id=__nav_5_6_label tabindex> <span class=md-ellipsis> 安全与权限管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_6_label aria-expanded=false> <label class=md-nav__title for=__nav_5_6> <span class="md-nav__icon md-icon"></span> 安全与权限管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/webmanage/ class=md-nav__link> <span class=md-ellipsis> 系统安全管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/nice/ class=md-nav__link> <span class=md-ellipsis> 用户权限管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/wheel/ class=md-nav__link> <span class=md-ellipsis> 临时用户组 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/no-passwd/ class=md-nav__link> <span class=md-ellipsis> 免密登录配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/bmcpasswd/ class=md-nav__link> <span class=md-ellipsis> sudo配置与BMC </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/git-nopassword/ class=md-nav__link> <span class=md-ellipsis> Git免密配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/resetpasswd-centos7/ class=md-nav__link> <span class=md-ellipsis> 账户密码重置 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/at-crontab/ class=md-nav__link> <span class=md-ellipsis> 任务调度管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/terminal-reuse/ class=md-nav__link> <span class=md-ellipsis> 终端会话复用 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ln-s/ class=md-nav__link> <span class=md-ellipsis> SSH免密与连接 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/openvpn/ class=md-nav__link> <span class=md-ellipsis> 安全VPN管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_7> <label class=md-nav__link for=__nav_5_7 id=__nav_5_7_label tabindex> <span class=md-ellipsis> 系统配置与调优 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_7_label aria-expanded=false> <label class=md-nav__title for=__nav_5_7> <span class="md-nav__icon md-icon"></span> 系统配置与调优 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/linux_tunning/ class=md-nav__link> <span class=md-ellipsis> 系统参数调整 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cpu-affinity/ class=md-nav__link> <span class=md-ellipsis> 进程优先级与CPU亲和性 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/kworker/ class=md-nav__link> <span class=md-ellipsis> 内核后台进程 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/qos/ class=md-nav__link> <span class=md-ellipsis> 网络QoS管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/init-centos/ class=md-nav__link> <span class=md-ellipsis> 系统启动优化 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ubuntu2004-network/ class=md-nav__link> <span class=md-ellipsis> 网络配置Ubuntu </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/memtester/ class=md-nav__link> <span class=md-ellipsis> 系统内存大页 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ssdiotimeout/ class=md-nav__link> <span class=md-ellipsis> I/O超时处理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/backlog-config/ class=md-nav__link> <span class=md-ellipsis> Backlog队列管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_8> <label class=md-nav__link for=__nav_5_8 id=__nav_5_8_label tabindex> <span class=md-ellipsis> 存储与文件系统管理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_8_label aria-expanded=false> <label class=md-nav__title for=__nav_5_8> <span class="md-nav__icon md-icon"></span> 存储与文件系统管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/lvm/ class=md-nav__link> <span class=md-ellipsis> LVM存储管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/parted/ class=md-nav__link> <span class=md-ellipsis> 磁盘分区工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/fastdeletfiles/ class=md-nav__link> <span class=md-ellipsis> 系统空间清理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/nospace-device/ class=md-nav__link> <span class=md-ellipsis> 无空间设备处理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_9> <label class=md-nav__link for=__nav_5_9 id=__nav_5_9_label tabindex> <span class=md-ellipsis> 网络与协议分析 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_9_label aria-expanded=false> <label class=md-nav__title for=__nav_5_9> <span class="md-nav__icon md-icon"></span> 网络与协议分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/tcpdump/ class=md-nav__link> <span class=md-ellipsis> 网络抓包分析 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/iperf/ class=md-nav__link> <span class=md-ellipsis> 网络诊断工具 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/last/ class=md-nav__link> <span class=md-ellipsis> 网络状态监控 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/wget/ class=md-nav__link> <span class=md-ellipsis> 下载工具wget </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/stat/ class=md-nav__link> <span class=md-ellipsis> 系统资源统计 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_10> <label class=md-nav__link for=__nav_5_10 id=__nav_5_10_label tabindex> <span class=md-ellipsis> 数据恢复与备份 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_10_label aria-expanded=false> <label class=md-nav__title for=__nav_5_10> <span class="md-nav__icon md-icon"></span> 数据恢复与备份 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/ddrescue/ class=md-nav__link> <span class=md-ellipsis> 数据恢复ddrescue </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/fio/ class=md-nav__link> <span class=md-ellipsis> 磁盘性能测试fio </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/vm-config/ class=md-nav__link> <span class=md-ellipsis> VM性能配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/memtest/ class=md-nav__link> <span class=md-ellipsis> 内存测试 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/patch/ class=md-nav__link> <span class=md-ellipsis> 系统补丁管理 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_11> <label class=md-nav__link for=__nav_5_11 id=__nav_5_11_label tabindex> <span class=md-ellipsis> 调试与性能分析 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_11_label aria-expanded=false> <label class=md-nav__title for=__nav_5_11> <span class="md-nav__icon md-icon"></span> 调试与性能分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/perf/ class=md-nav__link> <span class=md-ellipsis> 性能分析工具perf </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/pmap/ class=md-nav__link> <span class=md-ellipsis> 内存映射分析pmap </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/pstack_strace/ class=md-nav__link> <span class=md-ellipsis> 进程调试 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/so/ class=md-nav__link> <span class=md-ellipsis> 符号表与共享库 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/cgroups/ class=md-nav__link> <span class=md-ellipsis> 硬件驱动分析 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_12> <label class=md-nav__link for=__nav_5_12 id=__nav_5_12_label tabindex> <span class=md-ellipsis> 安全增强工具 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_12_label aria-expanded=false> <label class=md-nav__title for=__nav_5_12> <span class="md-nav__icon md-icon"></span> 安全增强工具 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/elfutil/ class=md-nav__link> <span class=md-ellipsis> ELF工具详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/pid_m/ class=md-nav__link> <span class=md-ellipsis> 调试堆栈分析 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/lang/ class=md-nav__link> <span class=md-ellipsis> 软件包语言配置 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_13> <label class=md-nav__link for=__nav_5_13 id=__nav_5_13_label tabindex> <span class=md-ellipsis> 系统维护与问题解决 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_13_label aria-expanded=false> <label class=md-nav__title for=__nav_5_13> <span class="md-nav__icon md-icon"></span> 系统维护与问题解决 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/lightdm/ class=md-nav__link> <span class=md-ellipsis> 轻量桌面管理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/4k-wa/ class=md-nav__link> <span class=md-ellipsis> 硬盘4K对齐 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/repo/ class=md-nav__link> <span class=md-ellipsis> 仓库远程配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/git-sparsecheckout/ class=md-nav__link> <span class=md-ellipsis> 版本控制优化 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/github-dns/ class=md-nav__link> <span class=md-ellipsis> DNS优化配置 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/ubuntu2004-qa/ class=md-nav__link> <span class=md-ellipsis> Ubuntu2004常见问题 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/git-objects-clean/ class=md-nav__link> <span class=md-ellipsis> Git对象清理 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/xz/ class=md-nav__link> <span class=md-ellipsis> 归档压缩 </span> </a> </li> <li class=md-nav__item> <a href=../../../linux/frp/ class=md-nav__link> <span class=md-ellipsis> 便捷连接工具 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> 数据库思考 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> 数据库思考 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../maintenance/thinking_in_db_fd/ class=md-nav__link> <span class=md-ellipsis> 结构设计 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_performance/ class=md-nav__link> <span class=md-ellipsis> 性能优化 </span> </a> </li> <li class=md-nav__item> <a href=../../performance/thinking_in_db_tune/ class=md-nav__link> <span class=md-ellipsis> 模块调优 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#repmgrd class=md-nav__link> <span class=md-ellipsis> repmgrd介绍 </span> </a> </li> <li class=md-nav__item> <a href=#repmgrd_1 class=md-nav__link> <span class=md-ellipsis> repmgrd 故障转移 </span> </a> <nav class=md-nav aria-label="repmgrd 故障转移"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 见证节点介绍 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 添加见证节点 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 解决脑裂问题 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 主服务可见性共识 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 从节点断开连接 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 故障转移验证 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 级联复制 </span> </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 主节点检测从库连接 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 检测过程和标准 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 注意事项 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 配置参数 </span> </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 事件类型 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 查看事件 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#repmgrd_2 class=md-nav__link> <span class=md-ellipsis> repmgrd 配置 </span> </a> <nav class=md-nav aria-label="repmgrd 配置"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 必须设置的参数 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 可选参数 </span> </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 其他参数 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 日志自动切割 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#repmgrd_3 class=md-nav__link> <span class=md-ellipsis> repmgrd 操作 </span> </a> <nav class=md-nav aria-label="repmgrd 操作"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#repmgrd_4 class=md-nav__link> <span class=md-ellipsis> repmgrd 维护模式 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 降级模式 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 监控数据存储 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 选举流程简介 </span> </a> <nav class=md-nav aria-label=选举流程简介> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 总结 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 流程图 </span> </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 功能增强 </span> </a> <nav class=md-nav aria-label=功能增强> <ul class=md-nav__list> <li class=md-nav__item> <a href=#virtual-ip class=md-nav__link> <span class=md-ellipsis> Virtual IP </span> </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 主节点异常后恢复处理 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 从节点故障及恢复 </span> </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 对外服务管理 </span> </a> <nav class=md-nav aria-label=对外服务管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_27 class=md-nav__link> <span class=md-ellipsis> 主要功能 </span> </a> </li> <li class=md-nav__item> <a href=#_28 class=md-nav__link> <span class=md-ellipsis> 可解决的问题 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_29 class=md-nav__link> <span class=md-ellipsis> 故障切换时间预估 </span> </a> </li> <li class=md-nav__item> <a href=#_30 class=md-nav__link> <span class=md-ellipsis> 只有两个节点 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>RepmgrD</h1> <h2 id=repmgrd>repmgrd介绍</h2> <p>repmgrd 作为运行在集群中每个节点上的一个管理和监控的守护程序，可以自动进行故障转移和维护复制关系，并提供有关每个节点状态的监控信息。</p> <p>repmgrd 不依赖其他服务</p> <p>提供的功能包括:</p> <ul> <li>众多的配置项提供选择</li> <li>根据场景可自定义对应执行脚本</li> <li>一个命令进入维护模式</li> <li>多数据中心场景，通过location限制候选主节点</li> <li>多种验证Postgresql存活状态方法（PostgreSQL ping, query execution or new connection）</li> <li>保留监控数据（可选）</li> </ul> <h2 id=repmgrd_1>repmgrd 故障转移</h2> <h3 id=_1>见证节点介绍</h3> <p>是一个独立于当前主从复制数据库的Postgresql数据库。</p> <p>目的是当发生failover场景时，用来证明主服务自身不可用还是数据中心网络问题</p> <p>一个典型的场景</p> <p>位于两个数据中心的主从复制结构。和主服务同一个数据中心上创建一个见证服务。当主服务不可用时，从节点判断逻辑，如果主服务和见证节点都不可见则认为是网络问题。如果主服务不可见，见证节点可见则认为是主服务发生问题。</p> <p>注意事项:</p> <p>不要将见证节点与主从服务安装在同一个物理机上。</p> <p>多数据中心场景建议使用localiton来预防脑裂问题</p> <p>见证节点只在repmgrd启用时有效。</p> <h3 id=_2>添加见证节点</h3> <p>安装一个独立的Postgresql实例，配置参考普通的repmgr。</p> <p>注册见证节点 </p> <pre><code>repmgr -f /etc/repmgr.conf witness register -h node1
</code></pre> <p>思考: 见证节点是否需要运行repmgrd。 见证节点不同于其他从节点，元数据可以通过流复制直接获取到。需要repmgrd来维护。</p> <h3 id=_3>解决脑裂问题</h3> <p>多数据中心带来的脑裂问题，当不同数据中心的节点彼此不可见时，从库的服务发生failover 产生一个新的主节点。此时整个集群同时拥有两个主服务。</p> <p>虽然见证服务可以在仲裁。但是见证服务存在如下弊端。</p> <ul> <li>需要保证见证节点与主服务节点位于同一个数据中心。</li> <li>当集群中多数节点与主服务节点不在同一个数据中心时，增加额外的维护成本，且不便扩展，尤其是大规模应用时。</li> </ul> <p>repmgr4 提出location的概念，通过配置location来指定节点的物理位置。</p> <p>当发生failover时。repmgr首先检测是否存在与主服务位于同一个localtion的服务是可见的。如果不存（即整个与主服务位于同一个数据中心的节点都不可见）在则认为是网络问题。不提升新主库，并且进入降级模式。</p> <h3 id=_4>主服务可见性共识</h3> <p>更复杂的集群结构，当从节点服务连接不到主服务时，询问其他从服务最后一次看到主服务的时间。当存在节点可以连接到主服务则证明主服务还存活，并且可以正常提供写服务。此时不发生新的选举。</p> <p>配置参数</p> <pre><code> primary_visibility_consensus=true
</code></pre> <p>注意事项。必须每个服务都设置为true才生效</p> <h3 id=_5>从节点断开连接</h3> <p>当standby_disconnect_on_failover设置为true时，在发生故障转移时首先从节点断开本地的wal receiver,并且等待所有其他节点断开自己的wal receiver。</p> <p>这样做的目的是为确保在故障转移时，所有的节点lsn处于静止状态。</p> <p>重要提示:</p> <ul> <li> <p>Postgresql9.5 及以上，repmgr 的数据库用户具有超级用户权限</p> </li> <li> <p><code>standby_disconnect_on_failover</code> 必须要所有节点服务都设置才生效</p> </li> <li>注意设置此参数后将带来的延迟，包括确定自己wal receiver是否已经关闭。等他确认其他节点wal receiver 是否已经完全关闭</li> <li>开启此参数建议同时开启 <code>primary_visibility_consensus</code></li> </ul> <h3 id=_6>故障转移验证</h3> <p>在发生故障转移时，某个节点被选举为新的主节点时，可以通过配置自定义判断脚本，进一步决定当前是否可以被提升为主节点（用户可以自定义辅助逻辑）。 必须在所有节点进行配置。 </p> <p>配置如下：</p> <pre><code>failover_validation_command=/path/to/script.sh %n     
</code></pre> <p>可使用参数：</p> <ul> <li><code>%n</code>: node ID</li> <li><code>%a</code>: node name</li> <li><code>%v</code>: 可见节点数</li> <li><code>%u</code>: number of shared upstream nodes</li> <li><code>%t</code>: 总节点数</li> </ul> <p>根据脚本返回码（是否非0）决定是否可以将当前节点提升为主节点，如果不符合条件，中断本次故障转移流程，<code>election_rerun_interval</code> 秒后进入下一轮故障转移流程。</p> <h3 id=_7>级联复制</h3> <p>Postgresql 9.2 数据库具有了级联复制功能。repmgr 可以提供级联复制支持。</p> <p>当发生故障转移时，repmgr保持级联关系不变。</p> <p>在上游节点发生故障时下游节点自动重新尝试连接原上游节点的父节点。</p> <h3 id=_8>主节点检测从库连接</h3> <p>以上的考虑情形大多是通过从节点检测主节点的运行情况来决定是否发生故障转移。在repmgr中主节点也可以检测到从节点的连接情况。</p> <p>通过主机点不断的检测从节点的连接情况，当满足某些状况时可以执行自定义脚本。如发生故障转移后产生一个新的主服务时，其他的从节点也都跟着指向了新主节点，原主节点的从节点个数变为零。这时可以通过执行一个特殊的命令来阻止应用写入原主节点。</p> <h3 id=_9>检测过程和标准</h3> <ul> <li>间隔时间<code>child_nodes_check_interval</code> 默认5秒查询一次pg_stat_replication 视图，并与注册repmgr时指定upstream node为主及节点的列表进行对比</li> <li>如果检测到从节点不在pg_stat_replication 视图中。记录检测到的时间并触发 <code>child_node_disconnect</code> 事件</li> <li>如果从节点重新出现在pg_stat_repliation视图中，清除上面的检测时间记录，并触发 <code>child_node_reconnect</code>事件</li> <li>如果检测到一个新的从节点加入，将新节点加入到内部列表中并触发<code>child_node_new_connect</code> 事件</li> <li>如果在repmgr.conf中配置了参数<code>child_nodes_disconnect_command</code>，repmgrd会循环检测所有节点，如果检测到连接的从节点数小于<code>child_nodes_connected_min_count</code> （默认零）并且超过<code>child_nodes_disconnect_timeout</code>（默认30s）所指定的时间时，触发 <code>child_nodes_disconnect_command</code> 事件</li> <li>注意事项，在 repmgrd 启动时没有连接的子节点不会被认为是丢失的，因为 repmgrd 无法知道它们为什么没有被连接。</li> </ul> <h3 id=_10>注意事项</h3> <ul> <li> <p>子节点配置为归档复制时</p> </li> <li> <p>子节点的primary_conninfo信息中的application_name与节点的 repmgr.conf文件中定义的节点名称相同。此外，这个application_name在整个复制集群中必须是唯一的。如果使用自定义的application_name，或者application_name在整个复制集群中不是唯一的，repmgr将无法可靠地监控子节点的连接。</p> </li> </ul> <h3 id=_11>配置参数</h3> <ul> <li>child_nodes_check_interval 检测间隔时间 默认值5s</li> <li>child_nodes_disconnect_command 自定义脚本</li> <li>child_nodes_disconnect_timeout 超时时间 默认值30s</li> <li>child_nodes_connected_min_count 存活从库的最小值。当检测到存活的从节点数小于该值时，触发child_nodes_disconnect_command 事件。</li> <li>child_nodes_disconnect_min_count 丢失节点的最小值，当丢失的节点数大于该值时触发child_nodes_disconnect_command 事件。</li> </ul> <p>注意child_nodes_connected_min_count 值会覆盖child_nodes_disconnect_min_count。当这两个参数都未设置时。检测到从节点存在个数为零时触发child_nodes_disconnect_command 事件。</p> <h3 id=_12>事件类型</h3> <ul> <li>child_node_disconnect</li> <li>child_node_reconnect</li> <li>child_node_new_connect</li> <li>child_nodes_disconnect_command</li> </ul> <h3 id=_13>查看事件</h3> <pre><code>repmgr cluster event --event=xxxxx (事件类型)
</code></pre> <h2 id=repmgrd_2>repmgrd 配置</h2> <p>Postgresql 配置 postgressql.conf 需要重启服务</p> <pre><code>shared_preload_libraries = 'repmgr'
</code></pre> <ul> <li> <p>monitor_interval_secs 检测上游节点时间间隔 默认2秒</p> </li> <li> <p>connection_check_type 检测类型 PQping (default)、connection、query</p> </li> <li> <p>reconnect_attempts 重连尝试次数 默认6次</p> </li> <li> <p>reconnect_interval 重连尝试间隔时间</p> </li> <li> <p>degraded_monitoring_timeout 默认-1 禁止。默认情况下，repmgrd将无限期地继续处于降级监视模式。设置该参数超时（以秒为单位），之后repmgrd将终止。</p> </li> </ul> <h3 id=_14>必须设置的参数</h3> <ul> <li><code>failover</code> =automatic</li> <li><code>promote_command</code> =/'usr/bin/repmgr standby promote -f /etc/repmgr.conf --log-to-file'</li> <li><code>follow_command</code>= '/usr/bin/repmgr standby follow -f /etc/repmgr.conf --log-to-file --upstream-node-id=%n'</li> </ul> <h3 id=_15>可选参数</h3> <pre><code>priority
failover_validation_command
primary_visibility_consensus
always_promote
standby_disconnect_on_failover
election_rerun_interval
sibling_nodes_disconnect_timeout
</code></pre> <h3 id=_16>其他参数</h3> <p>除了以上配置，conninfo 也会影响 repmgr 如何与 PostgreSQL 进行网络连接，如参数connect_timeout。同时也受到系统网络设置 <code>tcp_syn_retries</code>将影响。</p> <h3 id=_17>日志自动切割</h3> <pre><code>  /var/log/repmgr/repmgrd.log {
        missingok
        compress
        rotate 52
        maxsize 100M
        weekly
        create 0600 postgres postgres
        postrotate
            /usr/bin/killall -HUP repmgrd
        endscript
    }
</code></pre> <h2 id=repmgrd_3>repmgrd 操作</h2> <h3 id=repmgrd_4>repmgrd 维护模式</h3> <p>进入维护模式后，将不会发生自动故障转移。</p> <pre><code># 维护模式
repmgr -f /etc/repmgr.conf service pause
# 解除维护模式
repmgr -f /etc/repmgr.conf service unpause
# 查看当前模式
repmgr -f /etc/repmgr.conf service status
</code></pre> <p>注意: 维护模式的状态不会因为重启repmgrd或Postgresql服务而改变。</p> <p>当进行Postgresql 版本升级时，要完全关闭repmgrd 服务。并且安装与数据库对应的新版本repmgr。</p> <p>手动故障转移<code>repmgr standby switchover</code> 会自动进行 pause/unpause 状态切换。</p> <p>当Postgresql数据库通过<code>pg_wal_replay_pause</code>处于暂停wal日志回放状态时，故障转移会自动恢复wal回放。</p> <p>注意执行repmgr_standby_promote 将被拒绝，直到管理员wal resumed恢复回放。</p> <h3 id=_18>降级模式</h3> <p>当遇到某些情况时将进入 "降级监控 "模式，即 repmgrd 仍处于活动状态，但在等待情况的解决。</p> <p>情况包括: 当发生故障时</p> <ul> <li>与主节点位于同一个数据中的的其他节点都不可见。根据location参数</li> <li>没有可以提升为主节点的候选节点</li> <li>候选节点不能被提升主节点</li> <li>节点不能作为新主节点的从节点</li> <li>节点没有设置自动故障转移</li> <li>主节点故障，但是没其他节点被提升为主节点</li> </ul> <p>默认情况，降级模式将一致持续下去。但如果设置了degraded_monitoring_timeout参数，超过指定值，repmgrd将停止运行。</p> <h3 id=_19>监控数据存储</h3> <p>当参数monitoring_history=true时，监控记录数据将会不断的写入到<code>repmgr.monitoring_history</code>表中。 可以使用命令<code>repmgr cluster cleanup -k/ --keep-history</code> (选择需要保留记录天数) 定期清理数据。</p> <p>这些数据也会复制到从节点中，可以通过设置<code>ALTER TABLE repmgr.monitoring_history SET UNLOGGED;</code> 使数据不复制到从节点。</p> <h2 id=_20>选举流程简介</h2> <p>源码位置 <code>repmgrd-physical.c</code></p> <p>当primary 节点被检测到发生故障，进入选举阶段时的大概流程。</p> <pre><code>/*
 * Failover decision for nodes attached to the current primary.
 *
 * NB: this function sets &quot;sibling_nodes&quot;; caller (do_primary_failover)
 * expects to be able to read this list
 */
# 选举流程 Postgresql 支持级联复制。新的主节点只能在一级子节点中产生。
#  sibling_nodes 兄弟节点
static ElectionResult
do_election(NodeInfoList *sibling_nodes, int *new_primary_id)
{
    int         electoral_term = -1;
    #
    NodeInfoListCell *cell = NULL;
# 
    t_node_info *candidate_node = NULL;
# 选举状态
    election_stats stats;

    ReplInfo    local_replication_info;

    /* To collate details of nodes with primary visible for logging purposes */
    PQExpBufferData nodes_with_primary_visible;

    /*
     * Check if at least one server in the primary's location is visible; if
     * not we'll assume a network split between this node and the primary
     * location, and not promote any standby.
     *
     * NOTE: this function is only ever called by standbys attached to the
     * current (unreachable) primary, so &quot;upstream_node_info&quot; will always
     * contain the primary node record.
     */
    # 根据是否存在与故障节点位置相同的可见节点。如果都为不可见状态，则认为是网络问题。PS: 每个节点可配置location 参数指定所在的物理位置。如多数据中心场景
    bool        primary_location_seen = false;

    int         nodes_with_primary_still_visible = 0;

    if (config_file_options.failover_delay &gt; 0)
    {
        log_debug(&quot;sleeping %i seconds (\&quot;failover_delay\&quot;) before initiating failover&quot;,
                  config_file_options.failover_delay);
        sleep(config_file_options.failover_delay);
    }

    /* we're visible */ 
    #可见节点数
    stats.visible_nodes = 1;
    #与当前node为相同上游的节点数 shared_upstream_nodes = sibling_nodes + 1(当前节点)
    stats.shared_upstream_nodes = 0;
    # 集群中所有节点数
    stats.all_nodes = 0;
    # SELECT term FROM repmgr.voting_term; 初始值为1 , 执行repmgr standby promote加一
    electoral_term = get_current_term(local_conn);

    if (electoral_term == -1)
    {
        log_error(_(&quot;unable to determine electoral term&quot;));

        return ELECTION_NOT_CANDIDATE;
    }

    log_debug(&quot;do_election(): electoral term is %i&quot;, electoral_term);
   # 如果repmgr.conf中failover参数设置为manual ,该节点不参与选举
    if (config_file_options.failover == FAILOVER_MANUAL)
    {
        log_notice(_(&quot;this node is not configured for automatic failover so will not be considered as promotion candidate, and will not follow the new primary&quot;));
        log_detail(_(&quot;\&quot;failover\&quot; is set to \&quot;manual\&quot; in repmgr.conf&quot;));
        log_hint(_(&quot;manually execute \&quot;repmgr standby follow\&quot; to have this node follow the new primary&quot;));

        return ELECTION_NOT_CANDIDATE;
    }
#如果设置priority为0 ，该节点不参与选举 。见证节点的priority=0。 及见证节点到这里已经出局
    /* node priority is set to zero - don't become a candidate, and lose by default */
    if (local_node_info.priority &lt;= 0)
    {
        log_notice(_(&quot;this node's priority is %i so will not be considered as an automatic promotion candidate&quot;),
                   local_node_info.priority);

        return ELECTION_LOST;
    }
    #该方法 SQL 查询 视图repmgr.nodes ,获取兄弟节点。何为兄弟，与当前节点上游节点相同的节点，不包括自身。
    # 注意一点。 见证节点的也算在兄弟节点中。因为在nodes表中他们的upstream_node_id 相同 
    # SELECT REPMGR_NODES_COLUMNS FROM repmgr.nodes n  WHERE n.upstream_node_id = %i  AND n.node_id != %i    AND n.active IS TRUE ORDER BY n.node_id  
    /* get all active nodes attached to upstream, excluding self */
    get_active_sibling_node_records(local_conn,
                                    local_node_info.node_id,
                                    upstream_node_info.node_id,
                                    sibling_nodes);

    log_info(_(&quot;%i active sibling nodes registered&quot;), sibling_nodes-&gt;node_count);

    stats.shared_upstream_nodes = sibling_nodes-&gt;node_count + 1;
    #获取集群中所有节点数量 SELECT count(*) FROM repmgr.nodes n 
    get_all_nodes_count(local_conn, &amp;stats.all_nodes);

    log_info(_(&quot;%i total nodes registered&quot;), stats.all_nodes);
    #判断记录当前节点位置是否与 上游节点（主节点）位置相同
    if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) != 0)
    {
        log_info(_(&quot;primary node \&quot;%s\&quot; (ID: %i) has location \&quot;%s\&quot;, this node's location is \&quot;%s\&quot;&quot;),
                 upstream_node_info.node_name,
                 upstream_node_info.node_id,
                 upstream_node_info.location,
                 local_node_info.location);
    }
    else 
    {
        log_info(_(&quot;primary node  \&quot;%s\&quot; (ID: %i) and this node have the same location (\&quot;%s\&quot;)&quot;),
                 upstream_node_info.node_name,
                 upstream_node_info.node_id,
                 local_node_info.location);
    }

    local_node_info.last_wal_receive_lsn = InvalidXLogRecPtr;
    # 没有兄弟节点，没有见证节点，独生子。如果与主节点位置相同直接继承王位，江湖中的打打杀杀在这里不存在。
    /* fast path if no other standbys (or witness) exists - normally win by default */
    if (sibling_nodes-&gt;node_count == 0)
    {   # 比较上游节点（原主节点）与当前节点的位置，如果相同
        if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) == 0)
        {# 升级为主服务前的配置的验证脚本，是否返回值为0
            if (config_file_options.failover_validation_command[0] != '\0')
            { 
                return execute_failover_validation_command(&amp;local_node_info, &amp;stats);
            }

            log_info(_(&quot;no other sibling nodes - we win by default&quot;));
          # 胜出，新王诞生。
            return ELECTION_WON;
        }
        else
        {
            /*
             * If primary and standby have different locations set, the assumption
             * is that no action should be taken as we can't tell whether there's
             * been a network interruption or not.
             *
             * Normally a situation with primary and standby in different physical
             * locations would be handled by leaving the location as &quot;default&quot; and
             * setting up a witness server in the primary's location.
             */
            log_debug(&quot;no other nodes, but primary and standby locations differ&quot;);
           # 虽然只有一个从节点，但是与主节点的位置不同，不能进行升级。集群进行降级处理。很遗憾。
           # 相当于 主节点相同位置的节点都不可见。被认为网络分区故障。
            monitoring_state = MS_DEGRADED;
            INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

            return ELECTION_NOT_CANDIDATE;
        }
    }
    # 当有多个兄弟的时候
    else 
    {
        /* standby nodes found - check if we're in the primary location before checking theirs */ # 当前节点是否与主节点位置相同
        if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) == 0)
        {   # 存在与主节点位置相同的直接从节点
            primary_location_seen = true;
        }
    }

    /* get our lsn */ # 
    if (get_replication_info(local_conn, STANDBY, &amp;local_replication_info) == false)
    {
        log_error(_(&quot;unable to retrieve replication information for local node&quot;));
        return ELECTION_LOST;
    }
     # wal 回放状态为 paused ，尝试恢复wal回放状态 , resume失败 当前节点不参与选举
    /* check if WAL replay on local node is paused */
    if (local_replication_info.wal_replay_paused == true)
    {
        log_debug(&quot;WAL replay is paused&quot;);
        if (local_replication_info.last_wal_receive_lsn &gt; local_replication_info.last_wal_replay_lsn)
        {
            log_warning(_(&quot;WAL replay on this node is paused and WAL is pending replay&quot;));
            log_detail(_(&quot;replay paused at %X/%X; last WAL received is %X/%X&quot;),
                       format_lsn(local_replication_info.last_wal_replay_lsn),
                       format_lsn(local_replication_info.last_wal_receive_lsn));
        }
        # 尝试恢复wal状态
        /* attempt to resume WAL replay - unlikely this will fail, but just in case */
        if (resume_wal_replay(local_conn) == false)
        {
            log_error(_(&quot;unable to resume WAL replay&quot;));
            log_detail(_(&quot;this node cannot be reliably promoted&quot;));
            # resume 失败，该节点不参与选举
            return ELECTION_LOST;
        }

        log_notice(_(&quot;WAL replay forcibly resumed&quot;));
    }

    local_node_info.last_wal_receive_lsn = local_replication_info.last_wal_receive_lsn;

    log_info(_(&quot;local node's last receive lsn: %X/%X&quot;), format_lsn(local_node_info.last_wal_receive_lsn));

    /* pointer to &quot;winning&quot; node, initially self */
    candidate_node = &amp;local_node_info;

    initPQExpBuffer(&amp;nodes_with_primary_visible);
   # 众候选节点进入选举会场，开始厮杀。
    for (cell = sibling_nodes-&gt;head; cell; cell = cell-&gt;next)
    {
        ReplInfo    sibling_replication_info;

        log_info(_(&quot;checking state of sibling node \&quot;%s\&quot; (ID: %i)&quot;),
                 cell-&gt;node_info-&gt;node_name,
                 cell-&gt;node_info-&gt;node_id);

        /* assume the worst case */
        cell-&gt;node_info-&gt;node_status = NODE_STATUS_UNKNOWN;

        cell-&gt;node_info-&gt;conn = establish_db_connection(cell-&gt;node_info-&gt;conninfo, false);

        if (PQstatus(cell-&gt;node_info-&gt;conn) != CONNECTION_OK)
        {
            close_connection(&amp;cell-&gt;node_info-&gt;conn);

            continue;
        }

        cell-&gt;node_info-&gt;node_status = NODE_STATUS_UP;

        stats.visible_nodes++;

        /*
         * see if the node is in the primary's location (but skip the check if
         * we've seen a node there already)
         */
        if (primary_location_seen == false)
        {
            if (strncmp(cell-&gt;node_info-&gt;location, upstream_node_info.location, MAXLEN) == 0)
            {
                log_debug(&quot;node %i in primary location \&quot;%s\&quot;&quot;,
                          cell-&gt;node_info-&gt;node_id,
                          cell-&gt;node_info-&gt;location);
                primary_location_seen = true;
            }
        }

        /*
         * check if repmgrd running - skip if not
         *
         * TODO: include pid query in replication info query?
         *
         * NOTE: from Pg12 we could execute &quot;pg_promote()&quot; from a running repmgrd;
         * here we'll need to find a way of ensuring only one repmgrd does this
         */
        if (repmgrd_get_pid(cell-&gt;node_info-&gt;conn) == UNKNOWN_PID)
        {
            log_warning(_(&quot;repmgrd not running on node \&quot;%s\&quot; (ID: %i), skipping&quot;),
                        cell-&gt;node_info-&gt;node_name,
                        cell-&gt;node_info-&gt;node_id);
            continue;
        }

        if (get_replication_info(cell-&gt;node_info-&gt;conn, cell-&gt;node_info-&gt;type, &amp;sibling_replication_info) == false)
        {
            log_warning(_(&quot;unable to retrieve replication information for node \&quot;%s\&quot; (ID: %i), skipping&quot;),
                        cell-&gt;node_info-&gt;node_name,
                        cell-&gt;node_info-&gt;node_id);
            continue;
        }

        /*
         * Check if node is not in recovery - it may have been promoted
         * outside of the failover mechanism, in which case we may be able
         * to follow it.
         */

        # 有兄弟节点被手动提升为主节点
        if (sibling_replication_info.in_recovery == false &amp;&amp; cell-&gt;node_info-&gt;type != WITNESS)
        {
            bool can_follow;

            log_warning(_(&quot;node \&quot;%s\&quot; (ID: %i) is not in recovery&quot;),
                        cell-&gt;node_info-&gt;node_name,
                        cell-&gt;node_info-&gt;node_id);

            /*
             * Node is not in recovery, but still reporting an upstream
             * node ID; possible it was promoted manually (e.g. with &quot;pg_ctl promote&quot;),
             * or (less likely) the node's repmgrd has just switched to primary
             * monitoring node but has not yet unset the upstream node ID in
             * shared memory. Either way, log this.
             */
            if (sibling_replication_info.upstream_node_id != UNKNOWN_NODE_ID)
            {
                log_warning(_(&quot;node \&quot;%s\&quot; (ID: %i) still reports its upstream is node %i, last seen %i second(s) ago&quot;),
                            cell-&gt;node_info-&gt;node_name,
                            cell-&gt;node_info-&gt;node_id,
                            sibling_replication_info.upstream_node_id,
                            sibling_replication_info.upstream_last_seen);
            }
            #检验当前节点是否能follow 被提升的兄弟节点
            can_follow = check_node_can_follow(local_conn,
                                               local_node_info.last_wal_receive_lsn,
                                               cell-&gt;node_info-&gt;conn,
                                               cell-&gt;node_info);
            # 在选举结果前有节点手动提升节点为主节点。并且当前节点可以follower。当前节点不在参与选举
            if (can_follow == true)
            {
                *new_primary_id = cell-&gt;node_info-&gt;node_id;
                termPQExpBuffer(&amp;nodes_with_primary_visible);
                return ELECTION_CANCELLED;
            }
            # 如果不能follower主节点。这种情况会很棘手。
            /*
             * Tricky situation here - we'll assume the node is a rogue primary
             */
            log_warning(_(&quot;not possible to attach to node \&quot;%s\&quot; (ID: %i), ignoring&quot;),
                        cell-&gt;node_info-&gt;node_name,
                        cell-&gt;node_info-&gt;node_id);
            continue;
        }
        else
        {
            log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) reports its upstream is node %i, last seen %i second(s) ago&quot;),
                     cell-&gt;node_info-&gt;node_name,
                     cell-&gt;node_info-&gt;node_id,
                     sibling_replication_info.upstream_node_id,
                     sibling_replication_info.upstream_last_seen);
        }

        /* check if WAL replay on node is paused */
        if (sibling_replication_info.wal_replay_paused == true)
        {
            /*
             * Theoretically the repmgrd on the node should have resumed WAL play
             * at this point.
             */
            if (sibling_replication_info.last_wal_receive_lsn &gt; sibling_replication_info.last_wal_replay_lsn)
            {
                log_warning(_(&quot;WAL replay on node \&quot;%s\&quot; (ID: %i) is paused and WAL is pending replay&quot;),
                            cell-&gt;node_info-&gt;node_name,
                            cell-&gt;node_info-&gt;node_id);
            }
        }

        /*
         * Check if node has seen primary &quot;recently&quot; - if so, we may have &quot;partial primary visibility&quot;.
         * For now we'll assume the primary is visible if it's been seen less than
         * monitor_interval_secs * 2 seconds ago. We may need to adjust this, and/or make the value
         * configurable.
         */

        if (sibling_replication_info.upstream_last_seen &gt;= 0 &amp;&amp; sibling_replication_info.upstream_last_seen &lt; (config_file_options.monitor_interval_secs * 2))
        {
            if (sibling_replication_info.upstream_node_id != upstream_node_info.node_id)
            {
                log_warning(_(&quot;assumed sibling node \&quot;%s\&quot; (ID: %i) monitoring different upstream node %i&quot;),
                            cell-&gt;node_info-&gt;node_name,
                            cell-&gt;node_info-&gt;node_id,
                            sibling_replication_info.upstream_node_id);

            }
            else
            {
                nodes_with_primary_still_visible++;
                log_notice(_(&quot;%s node \&quot;%s\&quot; (ID: %i) last saw primary node %i second(s) ago, considering primary still visible&quot;),
                           get_node_type_string(cell-&gt;node_info-&gt;type),
                           cell-&gt;node_info-&gt;node_name,
                           cell-&gt;node_info-&gt;node_id,
                           sibling_replication_info.upstream_last_seen);
                appendPQExpBuffer(&amp;nodes_with_primary_visible,
                                  &quot; - node \&quot;%s\&quot; (ID: %i): %i second(s) ago\n&quot;,
                                  cell-&gt;node_info-&gt;node_name,
                                  cell-&gt;node_info-&gt;node_id,
                                  sibling_replication_info.upstream_last_seen);
            }
        }
        else
        {
            log_info(_(&quot;%s node \&quot;%s\&quot; (ID: %i) last saw primary node %i second(s) ago&quot;),
                     get_node_type_string(cell-&gt;node_info-&gt;type),
                     cell-&gt;node_info-&gt;node_name,
                     cell-&gt;node_info-&gt;node_id,
                     sibling_replication_info.upstream_last_seen);
        }

        # 见证节点不参与选举
        /* don't interrogate a witness server */
        if (cell-&gt;node_info-&gt;type == WITNESS)
        {
            log_debug(&quot;node %i is witness, not querying state&quot;, cell-&gt;node_info-&gt;node_id);
            continue;
        }
        # priority=0 的节点不参与选举
        /* don't check 0-priority nodes */
        if (cell-&gt;node_info-&gt;priority &lt;= 0)
        {
            log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has priority of %i, skipping&quot;),
                       cell-&gt;node_info-&gt;node_name,
                       cell-&gt;node_info-&gt;node_id,
                       cell-&gt;node_info-&gt;priority);
            continue;
        }


        /* get node's last receive LSN - if &quot;higher&quot; than current winner, current node is candidate */
        cell-&gt;node_info-&gt;last_wal_receive_lsn = sibling_replication_info.last_wal_receive_lsn;

        log_info(_(&quot;last receive LSN for sibling node \&quot;%s\&quot; (ID: %i) is: %X/%X&quot;),
                 cell-&gt;node_info-&gt;node_name,
                 cell-&gt;node_info-&gt;node_id,
                 format_lsn(cell-&gt;node_info-&gt;last_wal_receive_lsn));

        /* compare LSN */ # 比较LSN
        if (cell-&gt;node_info-&gt;last_wal_receive_lsn &gt; candidate_node-&gt;last_wal_receive_lsn)
        {
            /* other node is ahead */
            log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) is ahead of current candidate \&quot;%s\&quot; (ID: %i)&quot;),
                     cell-&gt;node_info-&gt;node_name,
                     cell-&gt;node_info-&gt;node_id,
                     candidate_node-&gt;node_name,
                     candidate_node-&gt;node_id);

            candidate_node = cell-&gt;node_info;
        }
        # LSN 相同比较 priority,priority也相同然后比较 node_id
        /* LSN is same - tiebreak on priority, then node_id */
        #LSN 对比
        else if (cell-&gt;node_info-&gt;last_wal_receive_lsn == candidate_node-&gt;last_wal_receive_lsn)
        {
            log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has same LSN as current candidate \&quot;%s\&quot; (ID: %i)&quot;),
                     cell-&gt;node_info-&gt;node_name,
                     cell-&gt;node_info-&gt;node_id,
                     candidate_node-&gt;node_name,
                     candidate_node-&gt;node_id);
            #priority 对比
            if (cell-&gt;node_info-&gt;priority &gt; candidate_node-&gt;priority)
            {
                log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has higher priority (%i) than current candidate \&quot;%s\&quot; (ID: %i) (%i)&quot;),
                         cell-&gt;node_info-&gt;node_name,
                         cell-&gt;node_info-&gt;node_id,
                         cell-&gt;node_info-&gt;priority,
                         candidate_node-&gt;node_name,
                         candidate_node-&gt;node_id,
                         candidate_node-&gt;priority);

                candidate_node = cell-&gt;node_info;
            }
            else if (cell-&gt;node_info-&gt;priority == candidate_node-&gt;priority)
            {
                if (cell-&gt;node_info-&gt;node_id &lt; candidate_node-&gt;node_id)
                {
                    log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has same priority but lower node_id than current candidate \&quot;%s\&quot; (ID: %i)&quot;),
                             cell-&gt;node_info-&gt;node_name,
                             cell-&gt;node_info-&gt;node_id,
                             candidate_node-&gt;node_name,
                             candidate_node-&gt;node_id);

                    candidate_node = cell-&gt;node_info;
                }
            }
            else
            {
                log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has lower priority (%i) than current candidate \&quot;%s\&quot; (ID: %i) (%i)&quot;),
                         cell-&gt;node_info-&gt;node_name,
                         cell-&gt;node_info-&gt;node_id,
                         cell-&gt;node_info-&gt;priority,
                         candidate_node-&gt;node_name,
                         candidate_node-&gt;node_id,
                         candidate_node-&gt;priority);
            }
        }
    }
    # 网络分区，降级。
    if (primary_location_seen == false)
    {
        log_notice(_(&quot;no nodes from the primary location \&quot;%s\&quot; visible - assuming network split&quot;),
                   upstream_node_info.location);
        log_detail(_(&quot;node will enter degraded monitoring state waiting for reconnect&quot;));

        monitoring_state = MS_DEGRADED;
        INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

        reset_node_voting_status();

        termPQExpBuffer(&amp;nodes_with_primary_visible);

        return ELECTION_CANCELLED;
    }
    # 主节点仍可见
    if (nodes_with_primary_still_visible &gt; 0)
    {
        log_info(_(&quot;%i nodes can see the primary&quot;),
                   nodes_with_primary_still_visible);

        log_detail(_(&quot;following nodes can see the primary:\n%s&quot;),
                   nodes_with_primary_visible.data);
        #主节点可见性共识
        if (config_file_options.primary_visibility_consensus == true)
        {
            log_notice(_(&quot;cancelling failover as some nodes can still see the primary&quot;));
            monitoring_state = MS_DEGRADED;
            INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

            reset_node_voting_status();

            termPQExpBuffer(&amp;nodes_with_primary_visible);

            return ELECTION_CANCELLED;
        }
    }

    termPQExpBuffer(&amp;nodes_with_primary_visible);

    log_info(_(&quot;visible nodes: %i; total nodes: %i; no nodes have seen the primary within the last %i seconds&quot;),
             stats.visible_nodes,
             stats.shared_upstream_nodes,
             (config_file_options.monitor_interval_secs * 2));
    # 同级节点中大部分不可见，不参与选举
    if (stats.visible_nodes &lt;= (stats.shared_upstream_nodes / 2.0))
    {
        log_notice(_(&quot;unable to reach a qualified majority of nodes&quot;));
        log_detail(_(&quot;node will enter degraded monitoring state waiting for reconnect&quot;));

        monitoring_state = MS_DEGRADED;
        INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

        reset_node_voting_status();

        return ELECTION_CANCELLED;
    }

    log_notice(_(&quot;promotion candidate is \&quot;%s\&quot; (ID: %i)&quot;),
               candidate_node-&gt;node_name,
               candidate_node-&gt;node_id);
   # 新选出的节点为当前节点
    if (candidate_node-&gt;node_id == local_node_info.node_id)
    {
        /*
         * If &quot;failover_validation_command&quot; is set, execute that command
         * and decide the result based on the command's output
         */
      # 验证failover_validation_command 脚本的执行
        if (config_file_options.failover_validation_command[0] != '\0')
        {
            return execute_failover_validation_command(candidate_node, &amp;stats);
        }
        # 当前节点宣布胜出，为主节点
        return ELECTION_WON;
    }

    return ELECTION_LOST;
}if (primary_location_seen == false)
    {
        log_notice(_(&quot;no nodes from the primary location \&quot;%s\&quot; visible - assuming network split&quot;),
                   upstream_node_info.location);
        log_detail(_(&quot;node will enter degraded monitoring state waiting for reconnect&quot;));

        monitoring_state = MS_DEGRADED;
        INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

        reset_node_voting_status();

        termPQExpBuffer(&amp;nodes_with_primary_visible);

        return ELECTION_CANCELLED;
    }

    if (nodes_with_primary_still_visible &gt; 0)
    {
        log_info(_(&quot;%i nodes can see the primary&quot;),
                   nodes_with_primary_still_visible);

        log_detail(_(&quot;following nodes can see the primary:\n%s&quot;),
                   nodes_with_primary_visible.data);

        if (config_file_options.primary_visibility_consensus == true)
        {
            log_notice(_(&quot;cancelling failover as some nodes can still see the primary&quot;));
            monitoring_state = MS_DEGRADED;
            INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

            reset_node_voting_status();

            termPQExpBuffer(&amp;nodes_with_primary_visible);

            return ELECTION_CANCELLED;
        }
    }
</code></pre> <h3 id=_21>总结</h3> <p><code>选举结果状态</code></p> <pre><code>ELECTION_NOT_CANDIDAT
ELECTION_WON
ELECTION_LOST
ELECTION_CANCELLED
ELECTION_RERUN
</code></pre> <p>根据location 或 winess节点决定集群是否处于网络分区状态，进入选举或降级模式。</p> <p>当只有一个一级从节点</p> <ul> <li>从节点原主节点位置相同直接选举成功。</li> <li>从节点与原主节点位置不同且没有见证节点则降级。</li> </ul> <p>不参与选举的节点</p> <ul> <li>Priority=0</li> <li>repmgr.conf中failover参数设置为manual</li> <li>wal 处于 pause 状态将被resume。但resume失败</li> </ul> <p>Repmgr选举候选备节点会以以下顺序选举：LSN-&gt; Priority-&gt; Node_ID。</p> <h2 id=_22>流程图</h2> <p><img alt src=/images/repmgrd.png></p> <h2 id=_23>功能增强</h2> <p>如何将repmgrd真正投入到生产中，真正的落地。面对某些CASES时仍能满足HA要求</p> <h3 id=virtual-ip><strong>Virtual IP</strong></h3> <ul> <li>注册主节点时，绑定vip</li> <li>Failover &amp; Switchover时 利用failover_validation_command事件重新绑定vip </li> <li>整个集群重启时，识别出主节点绑定vip</li> </ul> <h3 id=_24>主节点异常后恢复处理</h3> <ul> <li>主节点网络问题，如网络防火墙等原因。Postgresql服务仍在运行，并可写。</li> </ul> <pre><code>设置参数 child_nodes_connected_min_count
触发事件 child_nodes_disconnect_command 中定义回调方法将主节点降级为只读，或关闭。
</code></pre> <ul> <li>异常恢复时，网络重新恢复连接。</li> </ul> <p>找出集群故障转移后新主节点， 方法 libpq 中可写多个hosts。</p> <p>pg_rewind 对齐时间线</p> <p>rejoin 新集群</p> <ul> <li> <p>断电 ，不能做任何处理</p> </li> <li> <p>电力恢复。服务重启，检测从库数量如果为0 暂时不提供服务。等待一段时间 stop service -&gt; rejoin集群</p> </li> </ul> <h3 id=_25>从节点故障及恢复</h3> <ul> <li>当从节点发生故障时不会引起故障转移。当需要注意当从节点故障恢复后wal日志会落后与主库。</li> </ul> <h3 id=_26>对外服务管理</h3> <p>应用在通常情况下不会直接连接数据库，比如通过dns，haproxy等中间管理服务进行负载均衡和解耦。</p> <p>在数据库发生故障转移时，对应用程序来说尽量做到不需变化，无感。</p> <p>新增一个独立与现有服务之外的服务。</p> <h4 id=_27>主要功能</h4> <p>提供一个七层http请求, 包括访问权限验证</p> <p><code>返回值</code>: 服务已经正常运行的时间 ps:上层负载均衡用户可参考该值进行权限分配。如节点刚接入集群缓存数据尚未准备充分，建议业务流量逐步接入。</p> <p><code>返回码</code>: 200 , 其他</p> <p><code>主库</code> 访问地址 ip:port/master ?xxx</p> <p>​ 如返回码为200，当前节点为主节点并且服务正常。</p> <p>​ 其他返回码,暂时不能提供写服务</p> <p>​ 主要判断逻辑: PG服务可连接性，下游节点个数</p> <p><code>从库</code> 访问地址 ip:port/replocation ?xxx</p> <p>​ 主要判断逻辑: PG服务可连接性，落后主节点的wal差值</p> <h4 id=_28>可解决的问题</h4> <ul> <li> <p>vip 不能跨网段管理</p> </li> <li> <p>在Postgresql对外提供服务时进行健康状态检测。如果不满足需求，停止对应用提供服务，待恢复后在提供服务</p> </li> </ul> <h2 id=_29>故障切换时间预估</h2> <p>switchover &amp; failover: 故障发生后检测切换的总时间预估</p> <p>主要参考因素:</p> <ul> <li> <p>monitor_interval_secs 检测上游节点时间间隔 默认2秒</p> </li> <li> <p>connection_check_type 检测类型 每次检测的timeout</p> </li> <li> <p>reconnect_attempts 重连尝试次数 默认6次</p> </li> <li> <p>reconnect_interval 重连尝试间隔时间</p> </li> </ul> <h2 id=_30>只有两个节点</h2> <p>主要面临问题: 两个节点主要是当发生网络故障时，而非postgres数据库应用问题时。从库无法判断是网络还是主库发生了故障。见证节点主要是为了解决这样的问题。</p> <p>解决思路: 模拟见证节点。在从库无法与主库通信时，ping 一个其他节点。或ping 网关或自己的ip。 当ping失败时认为发生了网络问题。</p> <p>具体实现: 配置 <code>failover_validation_command</code></p> <p>​ failover_validation_command.sh</p> <pre><code>#! bin/bash
ping -c 5 {{ inventory_hostname }}
if [ $? -eq 0 ]; then
    echo &quot;ping $ip  success!&quot;
    return 0
else
    echo &quot;ping  $ip fail!&quot;
    return 1
fi
</code></pre> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2026 | Eamon </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.d7c377c4.min.js></script> <script src=../../../custom-js/custom-js.js></script> <script src=../../../redirect-md.js></script> </body> </html>
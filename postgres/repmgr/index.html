
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Welcome to Shaun's rabbit hole. This site serves as a personal knowledge base for me to record my thoughts and ideas. It is also a place for me to share my knowledge and experience with the world. I hope you find something useful here. ">
      
      
        <meta name="author" content="Eamon">
      
      
        <link rel="canonical" href="https://bodani.github.io/docs/postgres/repmgr/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>PG高可用 repmgr 搭建 - Tea</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#repmgr" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Tea" class="md-header__button md-logo" aria-label="Tea" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tea
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PG高可用 repmgr 搭建
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8v2m9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.71-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mysql/install.md" class="md-tabs__link">
          
  
    
  
  MYSQL

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../install01/" class="md-tabs__link">
          
  
    
  
  POSTGRES

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../middleware/etcd/" class="md-tabs__link">
          
  
    
  
  中间件

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../yugabytedb/install.md" class="md-tabs__link">
          
  
    
  
  YugabyteDB

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../thinking_in_db_fd/" class="md-tabs__link">
          
  
    
  
  数据库思考

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Tea" class="md-nav__button md-logo" aria-label="Tea" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Tea
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    MYSQL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            MYSQL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/install.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/PrivilegeManagement/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    权限管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_4" >
        
          
          <label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    高可用
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_4">
            <span class="md-nav__icon md-icon"></span>
            高可用
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/MGR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    组复制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/myshellMGR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mysqlsh
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5" >
        
          
          <label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    压测
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5">
            <span class="md-nav__icon md-icon"></span>
            压测
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mysql/mysqlslap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mysqlslap
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    POSTGRES
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            POSTGRES
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    安装维护
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            安装维护
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../install01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../replication01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    流复制
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    高可用
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            高可用
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ha_fd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    设计分析
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    索引篇
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            索引篇
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../index01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    索引类型及使用场景
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../index-invalid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    索引失效
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hypopg-index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    假设索引
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    备份管理篇
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            备份管理篇
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logical-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    逻辑备份
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../physical-backup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    物理备份
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    数据管理
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            数据管理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../delete/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    删除
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    中间件
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            中间件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../middleware/etcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    etcd
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    YugabyteDB
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            YugabyteDB
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yugabytedb/install.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yugabytedb/deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    部署
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    数据库思考
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            数据库思考
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../thinking_in_db_fd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结构设计
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../thinking_in_db_performance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    性能优化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../thinking_in_db_tune/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    模块调优
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="repmgr">基于Repmgr实现数据库高可用</h1>
<h1 id="_1">安装环境</h1>
<h2 id="_2">软件环境</h2>
<ul>
<li>postgres 10</li>
<li>repmgr 5.3.2</li>
<li>centos7</li>
</ul>
<h2 id="_3">网络环境</h2>
<table>
<thead>
<tr>
<th>IP地址</th>
<th></th>
<th>运行软件</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.10.2.12/node1</td>
<td></td>
<td>repmgr,repmgrd,pg</td>
</tr>
<tr>
<td>10.10.2.13/node2</td>
<td></td>
<td>repmgr,repmgrd,pg</td>
</tr>
<tr>
<td>10.10.2.14/node3</td>
<td></td>
<td>repmgr,repmgrd,pg</td>
</tr>
</tbody>
</table>
<h2 id="_4">前期准备</h2>
<ul>
<li>hosts 文件配置</li>
</ul>
<p><code>vi /etc/hosts # 
  10.10.2.12 node1
  10.10.2.13 node2
  10.10.2.14 node3</code></p>
<ul>
<li>安装PG10</li>
</ul>
<pre><code> $ yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
  $ yum update -y 
  $ yum install -y postgresql10-server postgresql10  postgresql10-contrib
  # 只有主库需要初始化
  $ sudo su postgres -c  &quot;/usr/pgsql-10/bin/initdb  --data-checksums -D /var/lib/pgsql/10/data&quot; 
</code></pre>
<ul>
<li>安装repmgr</li>
</ul>
<p><code>$ yum install -y repmgr10.x86_64</code></p>
<ul>
<li>提升postgres 用户具有部分sudo 执行权限</li>
</ul>
<p>repmgr 需要非root用户管理</p>
<p><code>vi /etc/sudoers.d/postgres # chmod 400 /etc/sudoers.d/postgres
  Defaults:postgres !requiretty
  postgres ALL = NOPASSWD: /usr/bin/systemctl stop postgresql-10, \
  /usr/bin/systemctl start postgresql-10, \
  /usr/bin/systemctl restart postgresql-10, \
  /usr/bin/systemctl reload postgresql-10</code></p>
<ul>
<li>ssh 免密互通</li>
</ul>
<p>配置ssh免密互通非必须，在执行switchover操作时需要 </p>
<p><code>$ su - postgres
  $ ssh-keygen
  $ cat .ssh/id_rsa.pub &gt;  .ssh/authorized_keys # 本机免密登录 
  # 将 .ssh 目录下authorized_keys，id_rsa，id_rsa.pub 拷贝到其他节点对应位置上，并赋值对应权限
  $ chmod 600 .ssh/authorized_keys
  $ chmod 600 .ssh/id_rsa
  $ chmod 644 .ssh/id_rsa.pub 
  # 用命令拷贝到其他节点 # 首次连接需要设置密码
  $ ssh-copy-id ${远端服务器} 
  $ ssh $远端服务器}</code></p>
<h4 id="_5">配置</h4>
<ul>
<li>PG 配置</li>
</ul>
<p><code>vi postgres.conf
  # 必须项
  max_wal_senders = 10
  max_replication_slots = 10 # 复制槽
  wal_level = 'logical' # replica 或 logical ，便于后期应用逻辑复制建议使用logical
  hot_standby = on # 从库在recovery状态下可读
  wal_log_hints = on # pg_rewind 依赖配置
  # 可选，建议开启项目。后期修改可能需要重启数据库
  archive_mode = always # 从库也可做归档
  archive_command = '/bin/true'
  archive_timeout = 300 # 单位秒 ，五分钟
  wal_keep_segments = 1024 # 保留wal文件个数， 如果设置slot 可忽略
  # 访问相关
  listen_addresses = '*'                  # 监听网卡
  port = 5432                             # 端口
  max_connections = 1000                  # 最大连接数
  superuser_reserved_connections = 3     #  超级用户预留</code></p>
<p>```
  vi pg_hba.conf #  确保本机repmgr 用户可访问
  host    replication   repmgr      127.0.0.1/32            trust
  host    replication   repmgr      0.0.0.0/0               trust</p>
<p>local   repmgr        repmgr                              trust
  host    repmgr        repmgr      127.0.0.1/32            trust
  host    repmgr        repmgr      0.0.0.0/0               md5
  ```</p>
<p><code># 元数据信息存储设置
  postgres=# create user repmgr;
  CREATE ROLE
  postgres=# alter user repmgr with password 'xxxxx';
  ALTER ROLE
  postgres=# alter user repmgr replication ;
  ALTER ROLE
  postgres=# create database repmgr owner repmgr;
  CREATE DATABASE
  postgres=#\c repmgr
  repmgr=# create extension repmgr;
  CREATE EXTENSION
  repmgr=# GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA repmgr TO repmgr ;</code></p>
<ul>
<li>repmgr</li>
</ul>
<p><code>vi repmgr.conf # /etc/repmgr/10/repmgr.conf
  ## 必须项
  node_id=1
  node_name= node1
  conninfo ='host=node1 dbname=repmgr user=repmgr connect_timeout=2'
  data_directory = '/var/lib/pgsql/10/data'
  ## 可选项
  config_directory = # pg配置文件位置
  replication_user = repmgr # 默认为conninfo 中使用的user
  location = # 服务器所在物理位置，有助于判断当发生脑裂时网络互通逻辑
  use_replication_slots = true # 是否使用物理复制槽
  log_level = INFO # 日志等级
  log_file =  '/var/log/repmgr/repmgr.log' # 日志输出文件位置 ，结合lograte管理
  # 数据库yum 方式安装，使用systemd 管理时
  service_start_command   = 'sudo systemctl start postgresql-10'
  service_stop_command    = 'sudo systemctl stop postgresql-10'
  service_restart_command = 'sudo systemctl restart postgresql-10'
  service_reload_command  = 'sudo systemctl reload postgresql-10'</code></p>
<h2 id="_6">注册主库</h2>
<ul>
<li>启动数据库</li>
</ul>
<p><code># 启动数据库服务
  systemctl start postgresql-10
  # 设置开机自启
  systemctl enable postgresql-10</code></p>
<p><code># 连接测试 repmgr.conf 中的conninfo 连接串信息测试本地登录
  psql  'host=node1 dbname=repmgr user=repmgr connect_timeout=2'</code></p>
<ul>
<li>注册</li>
</ul>
<p>```
  $ su - postgres</p>
<p># 测试注册主节点
  $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf primary register --dry-run -L debug
  INFO: connecting to primary database...
  DEBUG: connecting to: "user=repmgr dbname=repmgr host=node1 port=5432 connect_timeout=2 fallback_application_name=repmgr options=-csearch_path="
  INFO: "repmgr" extension is already installed</p>
<p># 正式注册主节点
  $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf primary register 
  INFO: connecting to primary database...
  INFO: "repmgr" extension is already installed
  NOTICE: primary node record (ID: 2) registered</p>
<p># 查看节点信息
  $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
   ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                           <br />
  ----+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------
   2  | node1 | primary | * running |          | default  | 100      | 2        | host=node1 port=5432 user=repmgr dbname=repmgr</p>
<p>```</p>
<ul>
<li>在数据库中查看注册信息</li>
</ul>
<p>```
  $ repmgr=# set search_path = "$user", public,repmgr;
  SET</p>
<p>$ repmgr=# \d+ 
                              List of relations
   Schema |        Name        | Type  | Owner  |    Size    | Description 
  --------+--------------------+-------+--------+------------+-------------
   repmgr | events             | table | repmgr | 16 kB      | 
   repmgr | monitoring_history | table | repmgr | 0 bytes    | 
   repmgr | nodes              | table | repmgr | 16 kB      | 
   repmgr | replication_status | view  | repmgr | 0 bytes    | 
   repmgr | show_nodes         | view  | repmgr | 0 bytes    | 
   repmgr | voting_term        | table | repmgr | 8192 bytes | 
  (6 rows)</p>
<p>$ SELECT * FROM repmgr.nodes;
  -[ RECORD 1 ]----+-----------------------------------------------
  node_id          | 2
  upstream_node_id | 
  active           | t
  node_name        | node1
  type             | primary
  location         | default
  priority         | 100
  conninfo         | host=node1 port=5432 user=repmgr dbname=repmgr
  repluser         | repmgr
  slot_name        | repmgr_slot_2
  config_file      | /etc/repmgr/10/repmgr.conf</p>
<p>$ SELECT * FROM repmgr.show_nodes ;
  -[ RECORD 1 ]------+-----------------------------------------------
  node_id            | 2
  node_name          | node1
  active             | t
  upstream_node_id   | 
  upstream_node_name | 
  type               | primary
  priority           | 100
  conninfo           | host=node1 port=5432 user=repmgr dbname=repmgr
  ```</p>
<h2 id="_7">加入从库</h2>
<p>加入node2 ，node3 两个节点</p>
<ul>
<li>
<p>安装PG &amp; repmgr</p>
</li>
<li>
<p>配置repmgr</p>
</li>
<li>
<p>从主节点clone</p>
</li>
</ul>
<p>```
  # 试运行 连接信息 -U -h -d 为主库地址 , 是否使用复制槽 在 repmgr.conf 中指定
  $ /usr/pgsql-10/bin/repmgr -h node1 -U repmgr -d repmgr -f /etc/repmgr/10/repmgr.conf standby clone --dry-run</p>
<p># 正式运行
  $ /usr/pgsql-10/bin/repmgr -h node1 -U repmgr -d repmgr -f /etc/repmgr/10/repmgr.conf standby clone 
  # 可选参数
  -c, --fast-checkpoint 主库执行checkpoint
  --upstream-node-id  可用于级联复制
  ```</p>
<pre><code>```
</code></pre>
<p># 启动数据库
  $ sudo systemctl start postgresql-10
  # 注册从节点
  $ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby register 
    ```</p>
<p><code># 登录主库查看 主从复制信息
  select * from pg_stat_replication ;
  -[ RECORD 1 ]----+------------------------------
  pid              | 12204
  usesysid         | 16384
  usename          | repmgr
  application_name | node3
  client_addr      | 10.10.2.13
  client_hostname  | 
  client_port      | 37412
  backend_start    | 2022-08-11 06:15:08.568251+00
  backend_xmin     | 
  state            | streaming
  sent_lsn         | 0/5000648
  write_lsn        | 0/5000648
  flush_lsn        | 0/5000648
  replay_lsn       | 0/5000648
  write_lag        | 
  flush_lag        | 
  replay_lag       | 
  sync_priority    | 0
  sync_state       | async</code></p>
<p><code>select * from pg_replication_slots ;
  -[ RECORD 1 ]-------+--------------
  slot_name           | repmgr_slot_3
  plugin              | 
  slot_type           | physical
  datoid              | 
  database            | 
  temporary           | f
  active              | t
  active_pid          | 12386
  xmin                | 
  catalog_xmin        | 
  restart_lsn         | 0/7001158
  confirmed_flush_lsn |</code></p>
<p><code>/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
   ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                             
  ----+-------+---------+-----------+----------+----------+----------+----------+------------------------------------------------
   2  | node1 | primary | * running |          | default  | 100      | 2        | host=node1 port=5432 user=repmgr dbname=repmgr
   3  | node3 | standby |   running | node1    | default  | 100      | 2        | host=node2 user=repmgr dbname=repmgr</code></p>
<h2 id="switchover">主动switchover</h2>
<pre><code># 在计划提升为主库的节点上执行
/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby switchover --siblings-follow 

# 查看切换结果 
/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
 ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                     
----+-------+---------+-----------+----------+----------+----------+----------+--------------------------------------------------------
 1  | node1 | primary | * running |          | default  | 100      | 4        | host=node1 port=5432 user=repmgr dbname=repmgr        
 2  | node2 | standby |   running | node1    | default  | 100      | 3        | host=node2 user=repmgr dbname=repmgr                  
 3  | node3 | standby |   running | node1    | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2

</code></pre>
<p>注意事项，1 原主库上的slot 仍然存在（后期测试几次发现会自动删除） 2 级联复制的情况下避免最下游节点提升主</p>
<h2 id="_8">修改级联关系</h2>
<pre><code>/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby follow --upstream-node-id 1
</code></pre>
<h2 id="switchover_1">被动switchover</h2>
<p>模拟主节点故障</p>
<pre><code># node1 关闭
sudo systemctl stop postgresql-10

# node2 上查看集群状态
/usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
 ID | Name  | Role    | Status        | Upstream | Location | Priority | Timeline | Connection string                                     
----+-------+---------+---------------+----------+----------+----------+----------+--------------------------------------------------------
 1  | node1 | primary | ? unreachable | ?        | default  | 100      |          | host=node1 port=5432 user=repmgr dbname=repmgr        
 2  | node2 | standby |   running     | ? node1  | default  | 100      | 4        | host=node2 user=repmgr dbname=repmgr                  
 3  | node3 | standby |   running     | ? node1  | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2

WARNING: following issues were detected
  - unable to connect to node &quot;node1&quot; (ID: 1)
  - node &quot;node1&quot; (ID: 1) is registered as an active primary but is unreachable
  - unable to connect to node &quot;node2&quot; (ID: 2)'s upstream node &quot;node1&quot; (ID: 1)
  - unable to determine if node &quot;node2&quot; (ID: 2) is attached to its upstream node &quot;node1&quot; (ID: 1)
  - unable to connect to node &quot;node3&quot; (ID: 3)'s upstream node &quot;node1&quot; (ID: 1)
  - unable to determine if node &quot;node3&quot; (ID: 3) is attached to its upstream node &quot;node1&quot; (ID: 1)

HINT: execute with --verbose option to see connection error messages
</code></pre>
<p>提升node2 节点为主节点</p>
<pre><code># 在node2 上执行
$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby promote
WARNING: 1 sibling nodes found, but option &quot;--siblings-follow&quot; not specified
DETAIL: these nodes will remain attached to the current primary:
  node3 (node ID: 3)
NOTICE: promoting standby to primary
DETAIL: promoting server &quot;node2&quot; (ID: 2) using &quot;/usr/pgsql-10/bin/pg_ctl  -w -D '/var/lib/pgsql/10/data' promote&quot;
waiting for server to promote.... done
server promoted
NOTICE: waiting up to 60 seconds (parameter &quot;promote_check_timeout&quot;) for promotion to complete
NOTICE: STANDBY PROMOTE successful
DETAIL: server &quot;node2&quot; (ID: 2) was successfully promoted to primary

# 查看集群状态
$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
 ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                     
----+-------+---------+-----------+----------+----------+----------+----------+--------------------------------------------------------
 1  | node1 | primary | - failed  | ?        | default  | 100      |          | host=node1 port=5432 user=repmgr dbname=repmgr        
 2  | node2 | primary | * running |          | default  | 100      | 5        | host=node2 user=repmgr dbname=repmgr                  
 3  | node3 | standby |   running | ? node1  | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2

WARNING: following issues were detected
  - unable to connect to node &amp;quot;node1&amp;quot; (ID: 1)
  - unable to connect to node &amp;quot;node3&amp;quot; (ID: 3)&amp;apos;s upstream node &amp;quot;node1&amp;quot; (ID: 1)
  - unable to determine if node &amp;quot;node3&amp;quot; (ID: 3) is attached to its upstream node &amp;quot;node1&amp;quot; (ID: 1)

HINT: execute with --verbose option to see connection error messages

# 如果原来集群中有其他从节点，主节点也指向故障节点node1 ， 在提升node2节点时同时将其他节点指向自己
$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby promote --siblings-follow 
</code></pre>
<p>node3 重新指定主库为node2</p>
<pre><code># 在node3 上执行
$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby follow
# 查看状态
$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
 ID | Name  | Role    | Status    | Upstream | Location | Priority | Timeline | Connection string                                     
----+-------+---------+-----------+----------+----------+----------+----------+--------------------------------------------------------
 1  | node1 | primary | - failed  | ?        | default  | 100      |          | host=node1 port=5432 user=repmgr dbname=repmgr        
 2  | node2 | primary | * running |          | default  | 100      | 5        | host=node2 user=repmgr dbname=repmgr                  
 3  | node3 | standby |   running | node2    | default  | 100      | 4        | host=node3 dbname=repmgr user=repmgr connect_timeout=2

WARNING: following issues were detected
  - unable to connect to node &quot;node1&quot; (ID: 1)

HINT: execute with --verbose option to see connection error messages
</code></pre>
<p>node1 重新加入集群</p>
<pre><code># 登录到原主node1 节点 ， 确保数据是关闭状态 
$ /usr/pgsql-10/bin/repmgr node rejoin -f /etc/repmgr/10/repmgr.conf -d 'host=node3 dbname=repmgr user=repmgr'  --force-rewind --config-files=postgresql.conf --verbose --dry-run
NOTICE: using provided configuration file &quot;/etc/repmgr/10/repmgr.conf&quot;
NOTICE: rejoin target is node &quot;node3&quot; (ID: 3)
INFO: replication slots in use, 3 free slots on node 9
INFO: replication connection to the rejoin target node was successful
INFO: local and rejoin target system identifiers match
DETAIL: system identifier is 7129425727714895616
INFO: prerequisites for using pg_rewind are met
INFO: temporary archive directory &quot;/tmp/repmgr-config-archive-node1&quot; created
INFO: file &quot;postgresql.conf&quot; would be copied to &quot;/tmp/repmgr-config-archive-node1/postgresql.conf&quot;
INFO: 1 files would have been copied to &quot;/tmp/repmgr-config-archive-node1&quot;
INFO: temporary archive directory &quot;/tmp/repmgr-config-archive-node1&quot; deleted
INFO: pg_rewind would now be executed
DETAIL: pg_rewind command is:
  /usr/pgsql-10/bin/pg_rewind -D '/var/lib/pgsql/10/data' --source-server='host=node3 dbname=repmgr user=repmgr connect_timeout=2'
INFO: prerequisites for executing NODE REJOIN are met

# 正式执行
$ /usr/pgsql-10/bin/repmgr node rejoin -f /etc/repmgr/10/repmgr.conf -d 'host=node3 dbname=repmgr user=repmgr'  --force-rewind --config-files=postgresql.conf --verbose
# 启动数据库
$ sudo systemctl start postgresql-10
# 查看结果
$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf cluster show
</code></pre>
<p>node1 节点故障不可恢复情况</p>
<p>```</p>
<h1 id="node1">将node1 节点从集群中注销, 登录到其他任意节点</h1>
<p>$ /usr/pgsql-10/bin/repmgr -f /etc/repmgr/10/repmgr.conf standby unregister --node-id
 ```</p>
<pre><code> $ repmgr -f /etc/repmgr/10/repmgr.conf cluster event
</code></pre>
<h2 id="failover">自动failover</h2>
<p>修改配置</p>
<p>vi postgresql.conf</p>
<pre><code>shared_preload_libraries = 'repmgr'
</code></pre>
<p>vi /etc/repmgr/10/repmgr.conf</p>
<pre><code>failover=automatic
promote_command='/usr/pgsql-10/bin/repmgr standby promote -f /etc/repmgr/10/repmgr.conf --log-to-file'
follow_command='/usr/pgsql-10/bin/repmgr standby follow -f /etc/repmgr/10/repmgr.conf --log-to-file --upstream-node-id=%n'
log_file='/var/lib/pgsql/repmgrd.log'
monitoring_history=true #（启用监控参数）
monitor_interval_secs=5 #（定义监视数据间隔写入时间参数）
reconnect_attempts=10 #（故障转移之前，尝试重新连接主库次数（默认为6）参数）
reconnect_interval=5 #（每间隔5s尝试重新连接一次参数
</code></pre>
<p>重启 postgres</p>
<pre><code>repmgr node service --action=restart
</code></pre>
<p>启动 repmgrd</p>
<pre><code>systemctl start repmgr-10
systemctl enable repmgr-10
</code></pre>
<p>测试</p>
<p>略</p>
<p>主节点重新加入集群</p>
<pre><code># 全部原主节点保持关闭状态。 首先将执行pg_rewind -&gt;   自动启动服务 - &gt; 注册服务
 repmgr node rejoin -d 'host=node1 dbname=repmgr user=repmgr' --force-rewind --config-files=postgresql.conf,postgresql.auto.conf --verbose --dry-run
 repmgr node rejoin -d 'host=node1 dbname=repmgr user=repmgr' --force-rewind --config-files=postgresql.conf,postgresql.auto.conf --verbose
</code></pre>
<h4 id="failover_1">自动failover 几点说明</h4>
<p>为预防网络脑裂发生： repmgr 做了如下努力： 1 ，使用见证节点。主要应用于只有主从两个节点的场景， 将见证节点与主节点部署在同一个网络区间。 当主节点与见证节点同时不可见时，认为是网络错误，不发生切换。当见证节点可见，主节点不可见时，认为主节点失效，触发切换。</p>
<p>引入见证节点提高了维护成本。 </p>
<p>多IDC网络场景，方案2 ： 使用location 标记服务所在的位置。当与主节点location相同的节点都不可见时，认为是网络错误，不发生切换。如果集群中没有其他节点与主节点的location配置相同，则永远不发生切换。</p>
<p>举例： 三个IDC，三个pg服务。location分别设置为dc1（主节点），dc2（从节点），dc3（从节点）。 当dc1 节点发生故障时不会发生故障转移。 因为集群中location 为dc1的节点（只有一个）都不可见。</p>
<p>合理的设置应该为cd1(主节点) ,dc1(一个从)，dc2（另一个从）。 此时当dc1 发生以外时，可故障转移。</p>
<h4 id="repmgrpg">注意事项： 当主节点网络问题。如网卡，网线故障。服务正常的情况下。集群也会发生故障转移。当网络恢复的时候发生脑裂。 主要问题。当主节点脱离集群时没有彻底关闭服务。repmgr不能管理pg服务,将其关闭。</h4>
<p>可以如下设置，通过确定与从节点连接个数决定是否关闭当前服务。在command中关闭当前pg</p>
<pre><code>#child_nodes_check_interval=5           # Interval (in seconds) to check for attached child nodes (standbys)
#child_nodes_connected_min_count=-1     # Minimum number of child nodes which must remain connected, otherwise
                                        # disconnection command will be triggered
#child_nodes_disconnect_min_count=-1    # Minimum number of disconnected child nodes required to execute disconnection command
                                        # (ignored if &quot;child_nodes_connected_min_count&quot; set)
#child_nodes_disconnect_timeout=30      # Interval between child node disconnection and disconnection command execution
child_nodes_disconnect_command='' 
</code></pre>
<h4 id="location">location 修改</h4>
<p>localtion 参数在高可用架构中为防止网络分区问题发挥重要作用。 发生故障转移后location 通常也需要重新设计。</p>
<p>修改 /etc/repmgr/10/repmgr.conf</p>
<p>生效</p>
<pre><code>repmgr standby register --force
systemctl restart repmgr-10
</code></pre>
<p>查看</p>
<pre><code>repmgr cluster show
或
select * from repmgr.nodes;
</code></pre>
<p><a href="https://repmgr.org/docs/current/repmgrd-basic-configuration.html#REPMGRD-RELOADING-CONFIGURATION">修改location</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024  |   Eamon
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>